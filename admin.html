<!DOCTYPE html>
<html lang="en">
<head>
    <meta data-cfasync="false">
    <meta name="cf:disable-email-protection" content="true">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creators Corner - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #12141a;
            --bg-secondary: #1a1d24;
            --bg-card: #21252e;
            --bg-card-hover: #2a2f3a;
            --border: #2e3440;
            --border-light: #3b4252;
            --text-primary: #eceff4;
            --text-secondary: #9aa5b8;
            --text-muted: #6b7280;
            --accent: #f5c518;
            --accent-hover: #ffd43b;
            --accent-dim: rgba(245, 197, 24, 0.12);
            --success: #34d399;
            --success-dim: rgba(52, 211, 153, 0.12);
            --warning: #fbbf24;
            --warning-dim: rgba(251, 191, 36, 0.12);
            --danger: #f87171;
            --danger-dim: rgba(248, 113, 113, 0.12);
            --info: #60a5fa;
            --info-dim: rgba(96, 165, 250, 0.12);
            --purple: #a78bfa;
            --purple-dim: rgba(167, 139, 250, 0.12);
            --blue: #60a5fa;
            --blue-dim: rgba(96, 165, 250, 0.12);
            --cyan: #22d3ee;
            --cyan-dim: rgba(34, 211, 238, 0.12);
        }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f0f0f2;
            --border: #e0e0e0;
            --border-light: #d0d0d0;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #7a7a7a;
            --accent: #d4a017;
            --accent-hover: #b8860b;
            --accent-dim: rgba(212, 160, 23, 0.12);
            --success: #059669;
            --success-dim: rgba(5, 150, 105, 0.12);
            --warning: #d97706;
            --warning-dim: rgba(217, 119, 6, 0.12);
            --danger: #dc2626;
            --danger-dim: rgba(220, 38, 38, 0.12);
            --info: #2563eb;
            --info-dim: rgba(37, 99, 235, 0.12);
            --purple: #7c3aed;
            --purple-dim: rgba(124, 58, 237, 0.12);
            --blue: #2563eb;
            --blue-dim: rgba(37, 99, 235, 0.12);
            --cyan: #0891b2;
            --cyan-dim: rgba(8, 145, 178, 0.12);
        }
        
        [data-theme="light"] .sidebar {
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        [data-theme="light"] .card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        [data-theme="light"] .stat-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        [data-theme="light"] .modal-content {
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        /* Theme Toggle Switch */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            margin: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle:hover {
            background: var(--bg-card);
            border-color: var(--accent);
        }
        .theme-toggle-track {
            width: 40px;
            height: 22px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 11px;
            position: relative;
            transition: all 0.3s;
        }
        .theme-toggle-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        [data-theme="light"] .theme-toggle-thumb {
            left: 20px;
            background: #fbbf24;
        }
        [data-theme="light"] .theme-toggle-track {
            background: #fef3c7;
            border-color: #fbbf24;
        }
        .theme-toggle-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Custom Scrollbar - Webkit (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        ::-webkit-scrollbar-corner {
            background: var(--bg-primary);
        }

        /* Custom Scrollbar - Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-light) var(--bg-primary);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            overflow-y: auto;
        }

        .logo-section {
            text-align: center;
            padding: 16px 8px 24px;
            margin-bottom: 24px;
        }

        .logo-img { width: 200px; }

        .nav-section { flex: 1; }

        .nav-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 12px;
            padding-left: 14px;
            margin-top: 20px;
        }

        .nav-label:first-child { margin-top: 0; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 16px;
            border-radius: 10px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .nav-item:hover { 
            background: var(--bg-card); 
            color: var(--text-primary);
            transform: translateX(4px);
        }
        .nav-item.active { 
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.05));
            color: var(--accent); 
            border-color: rgba(245, 197, 24, 0.3);
            font-weight: 600;
        }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: var(--accent);
            border-radius: 0 3px 3px 0;
        }
        .nav-item .icon { font-size: 1.1rem; width: 24px; text-align: center; }
        .nav-item .badge-count {
            margin-left: auto;
            background: var(--danger);
            color: #fff;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* Sub-navigation items - slightly muted and indented */
        .nav-item.nav-item-sub {
            padding-left: 28px;
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-bottom: 2px;
            opacity: 0.85;
        }
        .nav-item.nav-item-sub:hover {
            opacity: 1;
            color: var(--text-primary);
        }
        .nav-item.nav-item-sub .icon {
            font-size: 0.95rem;
            width: 20px;
        }

        .nav-label-collapsible {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 14px;
            user-select: none;
        }
        .nav-label-collapsible:hover {
            color: var(--text-secondary);
        }
        .nav-group-collapsible {
            overflow: hidden;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        /* System Status Indicator */
        .system-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .system-status .status-dot {
            font-size: 0.6rem;
            animation: pulse 2s infinite;
        }
        .system-status .status-dot.connected { color: var(--success); }
        .system-status .status-dot.disconnected { color: var(--danger); }
        .system-status .status-dot.stale { color: var(--warning); }
        .system-status .status-text { font-weight: 500; }
        .system-status .status-divider { color: var(--border); }
        .system-status .status-label { color: var(--text-muted); }
        .system-status .status-value { font-weight: 600; color: var(--text-secondary); }
        .system-status .status-value.fresh { color: var(--success); }
        .system-status .status-value.stale { color: var(--warning); }
        .system-status .status-value.old { color: var(--danger); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .notification-bell {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .notification-bell:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .notification-bell .bell-icon {
            font-size: 1.1rem;
        }
        .notification-bell .bell-count {
            background: var(--danger);
            color: #fff;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }
        .notification-bell.has-alerts {
            border-color: var(--danger);
            animation: bellPulse 2s infinite;
        }
        @keyframes bellPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        }
        
        /* Notification Center Dropdown */
        .notification-center {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 380px;
            max-height: 500px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        .notification-center.show {
            display: block;
            animation: slideDown 0.2s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        .notification-header h3 {
            font-size: 0.95rem;
            font-weight: 700;
            margin: 0;
        }
        .notification-header button {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .notification-header button:hover {
            background: var(--accent-dim);
        }
        .notification-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        .notification-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .notification-tab:hover {
            color: var(--text-primary);
        }
        .notification-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .notification-tab .tab-count {
            display: inline-block;
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            margin-left: 4px;
        }
        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }
        .notification-item {
            display: flex;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background 0.15s;
        }
        .notification-item:hover {
            background: var(--bg-secondary);
        }
        .notification-item.unread {
            background: rgba(245, 197, 24, 0.05);
            border-left: 3px solid var(--accent);
        }
        .notification-item.unread:hover {
            background: rgba(245, 197, 24, 0.1);
        }
        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .notification-icon.win { background: rgba(34, 197, 94, 0.15); }
        .notification-icon.alert { background: rgba(239, 68, 68, 0.15); }
        .notification-icon.info { background: rgba(59, 130, 246, 0.15); }
        .notification-icon.payment { background: rgba(168, 85, 247, 0.15); }
        .notification-icon.application { background: rgba(245, 197, 24, 0.15); }
        .notification-icon.milestone { background: rgba(236, 72, 153, 0.15); }
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        .notification-content .title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .notification-content .message {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .notification-content .time {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }
        .notification-empty .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        .notification-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
            text-align: center;
        }
        .notification-footer a {
            color: var(--accent);
            font-size: 0.8rem;
            text-decoration: none;
            font-weight: 600;
        }
        .notification-footer a:hover {
            text-decoration: underline;
        }
        
        /* Leaderboard Styles */
        .view-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .view-toggle-btn:hover {
            color: var(--text-primary);
        }
        .view-toggle-btn.active {
            background: var(--accent);
            color: #000;
        }
        
        .leaderboard-container {
            display: none;
        }
        .leaderboard-container.active {
            display: block;
        }
        .leaderboard-podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            padding: 40px 20px;
            margin-bottom: 24px;
        }
        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .podium-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 4px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 12px;
            position: relative;
        }
        .podium-place.first .podium-avatar {
            width: 100px;
            height: 100px;
            border-color: #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
        }
        .podium-place.second .podium-avatar {
            border-color: #c0c0c0;
        }
        .podium-place.third .podium-avatar {
            border-color: #cd7f32;
        }
        .podium-rank {
            position: absolute;
            bottom: -8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 800;
            color: #000;
        }
        .podium-place.first .podium-rank { background: #ffd700; }
        .podium-place.second .podium-rank { background: #c0c0c0; }
        .podium-place.third .podium-rank { background: #cd7f32; }
        .podium-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .podium-gmv {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--success);
        }
        .podium-brand {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .podium-base {
            width: 100px;
            margin-top: 12px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .podium-place.first .podium-base {
            height: 80px;
            background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%);
        }
        .podium-place.second .podium-base {
            height: 60px;
            background: linear-gradient(180deg, #c0c0c0 0%, #808080 100%);
        }
        .podium-place.third .podium-base {
            height: 40px;
            background: linear-gradient(180deg, #cd7f32 0%, #8b4513 100%);
        }
        
        .leaderboard-list {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            transition: all 0.2s ease;
            position: relative;
        }
        .leaderboard-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .leaderboard-item:hover {
            background: var(--bg-secondary);
            padding-left: 24px;
        }
        .leaderboard-item:hover::before {
            opacity: 1;
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        /* Stagger animation for leaderboard items */
        .leaderboard-item:nth-child(1) { animation: slideInLeft 0.3s ease-out 0.05s both; }
        .leaderboard-item:nth-child(2) { animation: slideInLeft 0.3s ease-out 0.1s both; }
        .leaderboard-item:nth-child(3) { animation: slideInLeft 0.3s ease-out 0.15s both; }
        .leaderboard-item:nth-child(4) { animation: slideInLeft 0.3s ease-out 0.2s both; }
        .leaderboard-item:nth-child(5) { animation: slideInLeft 0.3s ease-out 0.25s both; }
        .leaderboard-item:nth-child(6) { animation: slideInLeft 0.3s ease-out 0.3s both; }
        .leaderboard-item:nth-child(7) { animation: slideInLeft 0.3s ease-out 0.35s both; }
        .leaderboard-item:nth-child(8) { animation: slideInLeft 0.3s ease-out 0.4s both; }
        .leaderboard-item:nth-child(9) { animation: slideInLeft 0.3s ease-out 0.45s both; }
        .leaderboard-item:nth-child(10) { animation: slideInLeft 0.3s ease-out 0.5s both; }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.1rem;
            background: var(--bg-secondary);
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .leaderboard-item:hover .leaderboard-rank {
            transform: scale(1.1);
        }
        .leaderboard-rank.top-3 {
            color: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .leaderboard-rank.rank-1 { 
            background: linear-gradient(135deg, #ffd700, #ffed4a); 
            animation: goldShine 2s ease-in-out infinite;
        }
        .leaderboard-rank.rank-2 { 
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8); 
        }
        .leaderboard-rank.rank-3 { 
            background: linear-gradient(135deg, #cd7f32, #daa06d); 
        }
        @keyframes goldShine {
            0%, 100% { box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(255, 215, 0, 0.5); }
        }
        .leaderboard-creator {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }
        .leaderboard-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .leaderboard-info {
            min-width: 0;
        }
        .leaderboard-name {
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leaderboard-brand {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .leaderboard-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        .leaderboard-stat {
            text-align: right;
        }
        .leaderboard-stat .value {
            font-weight: 700;
            font-size: 1rem;
        }
        .leaderboard-stat .label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .leaderboard-stat.gmv .value {
            color: var(--success);
        }
        .leaderboard-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .leaderboard-change.up { color: var(--success); }
        .leaderboard-change.down { color: var(--danger); }
        .leaderboard-change.same { color: var(--text-muted); }
        
        .leaderboard-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .leaderboard-period-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .leaderboard-period-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        .leaderboard-period-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }
        
        /* Bulk Actions Styles */
        .bulk-actions-bar {
            display: none;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-dim) 0%, rgba(245, 197, 24, 0.1) 100%);
            border: 1px solid var(--accent);
            border-radius: 10px;
            margin-bottom: 16px;
            animation: slideIn 0.2s ease;
        }
        .bulk-actions-bar.show {
            display: flex;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bulk-select-count {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.9rem;
        }
        .bulk-actions-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        .bulk-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .bulk-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }
        .bulk-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        .bulk-btn.success:hover {
            border-color: var(--success);
            color: var(--success);
        }
        .bulk-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }
        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }
        .row-selected {
            background: rgba(245, 197, 24, 0.08) !important;
        }

        /* View Toggle Buttons */
        .view-toggle-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .view-toggle-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        .view-toggle-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            font-weight: 600;
        }
        
        /* Brand Pills in Identity View */
        .brand-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .brand-pill {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .brand-pill.catakor { background: var(--blue-dim); color: var(--blue); }
        .brand-pill.jiyu { background: var(--purple-dim); color: var(--purple); }
        .brand-pill.physicians_choice { background: var(--green-dim); color: var(--success); }
        .brand-pill.peach_slices { background: var(--orange-dim); color: var(--warning); }
        .brand-pill.yerba_magic { background: var(--teal-dim); color: var(--teal); }
        
        /* Expandable Row */
        .roster-row-expandable {
            cursor: pointer;
        }
        .roster-row-expandable:hover {
            background: var(--bg-secondary);
        }
        .roster-expand-icon {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 8px;
            color: var(--text-muted);
        }
        .roster-expand-icon.expanded {
            transform: rotate(90deg);
        }
        .roster-detail-row {
            background: var(--bg-secondary);
        }
        .roster-detail-row td {
            padding: 0 !important;
        }
        .roster-brand-details {
            padding: 12px 16px 12px 60px;
            display: grid;
            gap: 8px;
        }
        .roster-brand-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        
        /* Stat subtext */
        .stat-subtext {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .nav-bottom { padding-top: 16px; border-top: 1px solid var(--border); }

        .main {
            margin-left: 260px;
            padding: 32px 36px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .header-title { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.5px; }
        .header-subtitle { color: var(--text-secondary); font-size: 0.875rem; margin-top: 4px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }

        /* View transitions */
        .view-section { 
            display: none; 
            position: relative; 
            min-height: 400px;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        .view-section.active { 
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
            transition: background 0.2s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Focus ring improvements */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        input:focus, select:focus, textarea:focus, button:focus-visible {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        /* Tooltip System */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        [data-tooltip]::before,
        [data-tooltip]::after {
            position: absolute;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1000;
        }
        [data-tooltip]::before {
            content: attr(data-tooltip);
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            padding: 8px 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            border-radius: 6px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        [data-tooltip]::after {
            content: '';
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            border: 6px solid transparent;
            border-top-color: var(--border);
        }
        [data-tooltip]:hover::before,
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        [data-tooltip-position="right"]::before {
            bottom: auto;
            left: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%) translateX(-4px);
        }
        [data-tooltip-position="right"]::after {
            bottom: auto;
            left: calc(100% + 2px);
            top: 50%;
            transform: translateY(-50%) translateX(-4px);
            border: 6px solid transparent;
            border-right-color: var(--border);
        }
        [data-tooltip-position="right"]:hover::before,
        [data-tooltip-position="right"]:hover::after {
            transform: translateY(-50%) translateX(0);
        }
        
        /* Help Icon for Tooltips */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            cursor: help;
            margin-left: 6px;
            vertical-align: middle;
            transition: all 0.15s ease;
        }
        .help-icon:hover {
            color: var(--accent);
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        /* Status Dot Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 0 0 var(--success);
            animation: statusPulse 2s infinite;
        }
        .status-dot.offline { background: var(--text-muted); }
        .status-dot.warning { 
            background: var(--warning);
            animation: statusPulse 1.5s infinite;
        }
        .status-dot.error { background: var(--danger); }
        @keyframes statusPulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Progress Bar Component */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--warning));
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: progressShimmer 2s infinite;
        }
        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .progress-bar-label {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Mini progress for table cells */
        .mini-progress {
            width: 60px;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        .mini-progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .mini-progress-fill.low { background: var(--danger); }
        .mini-progress-fill.medium { background: var(--warning); }
        .mini-progress-fill.high { background: var(--success); }
        
        /* Copy Button Feedback */
        .copy-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
        }
        .copy-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .copy-btn.copied {
            color: var(--success);
        }
        .copy-btn.copied::after {
            content: 'Copied!';
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            animation: copyFeedback 1.5s ease forwards;
        }
        @keyframes copyFeedback {
            0% { opacity: 0; transform: translateX(-50%) translateY(4px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-4px); }
        }
        
        /* Active Filter Pills */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        .filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--accent-dim);
            border: 1px solid rgba(245, 197, 24, 0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--accent);
            animation: scaleIn 0.2s ease-out;
        }
        .filter-pill-remove {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.15s;
        }
        .filter-pill-remove:hover { opacity: 1; }
        
        /* Enhanced Select Dropdown */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239ca3af' d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        select:hover {
            border-color: var(--border-light);
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }

        select, input[type="text"], input[type="number"], input[type="date"], .date-input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
            min-width: 140px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input[type="text"]:hover, input[type="number"]:hover, select:hover {
            border-color: var(--border-light);
        }

        select:focus, input:focus, .date-input:focus { outline: none; border-color: var(--accent); }

        /* Litepicker custom styling - light theme for visibility */
        .litepicker {
            --litepicker-container-months-color-bg: #fff;
            --litepicker-month-header-color: #1a1d24;
            --litepicker-button-prev-month-color: #6b7280;
            --litepicker-button-next-month-color: #6b7280;
            --litepicker-button-prev-month-color-hover: var(--accent);
            --litepicker-button-next-month-color-hover: var(--accent);
            --litepicker-month-weekday-color: #6b7280;
            --litepicker-day-color: #1a1d24;
            --litepicker-day-color-hover: #1a1d24;
            --litepicker-is-in-range-color: rgba(245, 197, 24, 0.3);
            --litepicker-is-start-color: #000;
            --litepicker-is-start-color-bg: var(--accent);
            --litepicker-is-end-color: #000;
            --litepicker-is-end-color-bg: var(--accent);
            --litepicker-button-apply-color: #000;
            --litepicker-button-apply-color-bg: var(--accent);
            --litepicker-button-cancel-color: #1a1d24;
            --litepicker-button-cancel-color-bg: #e5e7eb;
            --litepicker-highlighted-day-color: #1a1d24;
            --litepicker-highlighted-day-color-bg: rgba(245, 197, 24, 0.3);
            font-family: 'Inter', sans-serif !important;
            z-index: 9999 !important;
        }
        .litepicker .container__main {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: row;
        }
        .litepicker .container__months {
            background: #fff;
            border-radius: 0 12px 12px 0;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
        }
        .litepicker .container__months .month-item {
            background: #fff;
            padding: 8px;
            width: 280px;
        }
        .litepicker .container__months .month-item-header {
            padding: 12px 8px;
            color: #1a1d24;
            font-weight: 600;
        }
        .litepicker .container__months .month-item-header div > .month-item-name {
            color: #1a1d24 !important;
            font-weight: 600;
        }
        .litepicker .container__months .month-item-header div > .month-item-year {
            color: #6b7280 !important;
        }
        .litepicker .container__months .month-item-weekdays-row {
            color: #6b7280;
        }
        .litepicker .container__months .month-item-weekdays-row > div {
            padding: 8px 0;
            font-size: 0.75rem;
            color: #6b7280 !important;
        }
        .litepicker .container__days > div, .litepicker .container__days > a {
            padding: 8px 0;
            border-radius: 6px;
            color: #1a1d24;
        }
        .litepicker .container__days .day-item {
            color: #1a1d24 !important;
            cursor: pointer;
        }
        .litepicker .container__days .day-item:hover {
            background: rgba(245, 197, 24, 0.3) !important;
            color: #1a1d24 !important;
            box-shadow: none;
        }
        .litepicker .container__days .day-item.is-locked {
            color: #d1d5db !important;
            text-decoration: line-through;
            cursor: not-allowed;
            pointer-events: none;
        }
        .litepicker .container__days .day-item.is-today {
            color: var(--accent) !important;
            font-weight: 700;
            border: 2px solid var(--accent);
        }
        .litepicker .container__days .day-item.is-start-date,
        .litepicker .container__days .day-item.is-end-date {
            background: var(--accent) !important;
            color: #000 !important;
        }
        .litepicker .container__days .day-item.is-in-range {
            background: rgba(245, 197, 24, 0.2) !important;
        }
        /* Preset ranges sidebar */
        .litepicker .container__preset {
            background: #f3f4f6;
            border-right: 1px solid #e5e7eb;
            border-radius: 12px 0 0 12px;
            padding: 12px;
            min-width: 140px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }
        .litepicker .container__preset button {
            background: transparent;
            border: none;
            color: #4b5563;
            padding: 10px 14px;
            width: 100%;
            text-align: left;
            border-radius: 6px;
            cursor: pointer !important;
            pointer-events: all !important;
            font-size: 0.85rem;
            margin-bottom: 4px;
            transition: all 0.15s ease;
            position: relative;
            z-index: 11;
        }
        .litepicker .container__preset button:hover {
            background: #e5e7eb;
            color: #1a1d24;
        }
        .litepicker .container__preset button.active {
            background: rgba(245, 197, 24, 0.3);
            color: #92600a;
            font-weight: 500;
        }
        .litepicker .container__footer {
            background: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
            padding: 12px;
        }
        .litepicker .container__footer .button-apply {
            background: var(--accent) !important;
            color: #000 !important;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .litepicker .container__footer .button-apply:hover {
            background: #ffd54f !important;
        }
        .litepicker .container__footer .button-cancel {
            background: #e5e7eb;
            color: #1a1d24;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 8px;
        }
        .litepicker .container__footer .button-cancel:hover {
            background: #d1d5db;
        }
        /* Navigation arrows */
        .litepicker .container__months .button-previous-month,
        .litepicker .container__months .button-next-month {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .litepicker .container__months .button-previous-month:hover,
        .litepicker .container__months .button-next-month:hover {
            background: #e5e7eb;
        }
        .litepicker .container__months .button-previous-month svg,
        .litepicker .container__months .button-next-month svg {
            fill: #6b7280;
        }
        .litepicker .container__months .button-previous-month:hover svg,
        .litepicker .container__months .button-next-month:hover svg {
            fill: var(--accent);
        }
        }
        
        /* Date range input styling */
        .date-range-input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 240px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .date-range-input:hover {
            border-color: var(--border-light);
        }
        .date-range-input .icon {
            color: var(--text-muted);
        }

        /* Flatpickr custom styling (for comparison modal and calculator) */
        .flatpickr-calendar {
            background: var(--bg-card) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important;
        }
        .flatpickr-months { background: var(--bg-secondary) !important; }
        .flatpickr-month { color: var(--text-primary) !important; }
        .flatpickr-current-month { color: var(--text-primary) !important; }
        .flatpickr-monthDropdown-months { background: var(--bg-card) !important; color: var(--text-primary) !important; }
        .numInputWrapper span { border-color: var(--border) !important; }
        .numInputWrapper input { color: var(--text-primary) !important; }
        .flatpickr-weekday { color: var(--text-muted) !important; }
        .flatpickr-day { color: var(--text-primary) !important; border-radius: 6px !important; }
        .flatpickr-day:hover { background: var(--accent-dim) !important; border-color: var(--accent) !important; }
        .flatpickr-day.selected { background: var(--accent) !important; color: #000 !important; border-color: var(--accent) !important; }
        .flatpickr-day.inRange { background: var(--accent-dim) !important; border-color: transparent !important; }
        .flatpickr-day.startRange, .flatpickr-day.endRange { background: var(--accent) !important; color: #000 !important; }
        .flatpickr-day.flatpickr-disabled { color: var(--text-muted) !important; opacity: 0.3 !important; }
        .flatpickr-day.today { border-color: var(--accent) !important; }
        .flatpickr-prev-month, .flatpickr-next-month { fill: var(--text-primary) !important; }
        .flatpickr-prev-month:hover svg, .flatpickr-next-month:hover svg { fill: var(--accent) !important; }

        .period-toggle {
            display: flex;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .period-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .period-btn.active { background: var(--accent); color: #000; }
        .period-btn:hover:not(.active) { color: var(--text-primary); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.25s;
        }
        
        .stat-card:hover { 
            border-color: var(--border-light); 
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .stat-card:hover::before { opacity: 1; }
        
        .stat-card.highlight { 
            background: linear-gradient(135deg, rgba(245, 197, 24, 0.1), var(--bg-card));
            border-color: rgba(245, 197, 24, 0.3);
        }
        .stat-card.highlight::before {
            background: linear-gradient(90deg, var(--accent), var(--warning));
            opacity: 1;
        }
        
        .stat-card.clickable {
            cursor: pointer;
        }
        .stat-card.clickable:active {
            transform: translateY(-1px);
        }

        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }

        .stat-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .stat-icon.yellow { background: var(--accent-dim); }
        .stat-icon.green { background: var(--success-dim); }
        .stat-icon.purple { background: var(--purple-dim); }
        .stat-icon.blue { background: var(--blue-dim); }
        .stat-icon.red { background: var(--danger-dim); }
        .stat-icon.orange { background: var(--warning-dim); }
        .stat-icon.cyan { background: var(--cyan-dim); }

        .stat-value { font-size: 1.75rem; font-weight: 700; font-family: 'Space Mono', monospace; margin-bottom: 4px; }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; }
        .stat-change { font-size: 0.75rem; font-weight: 600; margin-top: 8px; }
        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }
        .stat-change.neutral { color: var(--text-muted); }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .btn:active::after {
            width: 200px;
            height: 200px;
        }

        .btn-primary { 
            background: var(--accent); 
            color: #000; 
            box-shadow: 0 2px 8px rgba(245, 197, 24, 0.3);
        }
        .btn-primary:hover { 
            background: var(--accent-hover);
            box-shadow: 0 4px 16px rgba(245, 197, 24, 0.4);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(245, 197, 24, 0.3);
        }
        
        .btn-secondary { 
            background: var(--bg-card); 
            color: var(--text-primary); 
            border: 1px solid var(--border); 
        }
        .btn-secondary:hover { 
            border-color: var(--accent);
            background: var(--bg-secondary);
        }
        
        .btn-success {
            background: var(--success);
            color: #000;
        }
        .btn-success:hover {
            filter: brightness(1.1);
        }
        
        .btn-danger {
            background: var(--danger);
            color: #fff;
        }
        .btn-danger:hover {
            filter: brightness(1.1);
        }
        
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-loading {
            pointer-events: none;
            position: relative;
        }
        .btn-loading::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 22px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .card-title { font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 22px; }
        .card-body.no-padding { padding: 0; }

        .table-container { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }
        
        /* Clickable links in tables and cards */
        table td a:hover, .card a:hover {
            text-decoration: underline !important;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            white-space: nowrap;
            cursor: pointer;
            transition: color 0.15s, background 0.15s;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:hover { color: var(--accent); background: var(--bg-tertiary); }
        th.sorted { color: var(--accent); }
        th.sorted::after { content: ' '; font-size: 0.6rem; }
        th.sorted.asc::after { content: ' '; }

        td {
            padding: 14px 16px;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            transition: background 0.15s, transform 0.15s;
        }

        /* Zebra striping */
        tbody tr:nth-child(even) td { background: rgba(255, 255, 255, 0.01); }
        
        /* Hover effect */
        tbody tr { transition: background 0.15s; }
        tbody tr:hover td { background: var(--bg-card-hover); }
        tbody tr:hover { transform: translateX(2px); }
        tr.clickable { cursor: pointer; }
        
        /* Row selection state */
        tbody tr.selected td { background: var(--accent-dim) !important; }
        tbody tr.highlighted td { 
            background: linear-gradient(90deg, var(--accent-dim), transparent) !important;
            animation: highlightFade 2s ease-out forwards;
        }
        @keyframes highlightFade {
            0% { background: var(--accent-dim); }
            100% { background: transparent; }
        }
        
        /* Row status states for validation */
        tbody tr.row-warning td { 
            background: rgba(239, 68, 68, 0.05) !important; 
        }
        tbody tr.row-warning:hover td { 
            background: rgba(239, 68, 68, 0.1) !important; 
        }
        tbody tr.row-muted td { 
            opacity: 0.6; 
        }
        tbody tr.row-success td {
            background: rgba(34, 197, 94, 0.05) !important;
        }

        .creator-cell { display: flex; align-items: center; gap: 12px; }

        .creator-avatar {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.05));
            border: 1px solid rgba(245, 197, 24, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--accent);
        }

        .creator-info { display: flex; flex-direction: column; }
        .creator-name { font-weight: 600; color: var(--text-primary); }
        .creator-handle { font-size: 0.75rem; color: var(--text-muted); }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-managed { background: var(--success-dim); color: var(--success); }
        .badge-unmanaged { background: var(--bg-secondary); color: var(--text-muted); border: 1px solid var(--border); }

        .badge-tier { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .tier-bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .tier-silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #000; }
        .tier-gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .tier-platinum { background: linear-gradient(135deg, #e5e4e2, #b8b8b8); color: #000; }
        .tier-diamond { background: linear-gradient(135deg, #b9f2ff, #00d4ff); color: #000; }
        .tier-ruby { background: linear-gradient(135deg, #e0115f, #c41048); color: #fff; }
        .tier-new { background: var(--bg-secondary); color: var(--text-muted); border: 1px dashed var(--border); }

        .badge-brand {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .gmv-value { font-family: 'Space Mono', monospace; font-weight: 600; }
        .gmv-high { color: var(--success); }
        .gmv-medium { color: var(--accent); }
        .gmv-low { color: var(--text-secondary); }

        .trend-indicator { display: inline-flex; align-items: center; gap: 4px; font-weight: 600; font-size: 0.8rem; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--text-muted); }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-right: 4px;
        }

        .action-btn.add { background: var(--success-dim); color: var(--success); }
        .action-btn.add:hover { background: var(--success); color: #fff; }
        .action-btn.remove { background: var(--danger-dim); color: var(--danger); }
        .action-btn.remove:hover { background: var(--danger); color: #fff; }
        .action-btn.view { background: var(--blue-dim); color: var(--blue); }
        .action-btn.view:hover { background: var(--blue); color: #fff; }

        .grid-2 { display: grid; grid-template-columns: 1fr 360px; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
        .grid-equal { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

        @media (max-width: 1400px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 1200px) {
            .grid-2, .grid-3, .grid-4, .grid-equal { grid-template-columns: 1fr; }
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s;
            cursor: pointer;
        }

        .leaderboard-item:last-child { border-bottom: none; }
        .leaderboard-item:hover { background: var(--bg-card-hover); }

        .leaderboard-rank {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .rank-other { background: var(--bg-secondary); color: var(--text-muted); }

        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: 600; font-size: 0.9rem; }
        .leaderboard-brand { font-size: 0.75rem; color: var(--text-muted); }
        .leaderboard-gmv { font-family: 'Space Mono', monospace; font-weight: 700; color: var(--accent); }

        .alert-item {
            display: flex;
            gap: 14px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .alert-item:hover { background: var(--bg-card-hover); }
        .alert-item:last-child { border-bottom: none; }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .alert-icon.warning { background: var(--warning-dim); }
        .alert-icon.danger { background: var(--danger-dim); }
        .alert-icon.success { background: var(--success-dim); }
        .alert-icon.info { background: var(--blue-dim); }

        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
        .alert-message { font-size: 0.8rem; color: var(--text-secondary); }
        .alert-time { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-fill.green { background: var(--success); }
        .progress-fill.yellow { background: var(--accent); }
        .progress-fill.red { background: var(--danger); }

        .brand-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .brand-card:hover { border-color: var(--accent); }

        .brand-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .brand-name { font-size: 1.1rem; font-weight: 700; }
        .brand-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .brand-stat { text-align: center; }
        .brand-stat-value { font-size: 1.25rem; font-weight: 700; font-family: 'Space Mono', monospace; }
        .brand-stat-label { font-size: 0.75rem; color: var(--text-muted); }

        /* Brand Comparison Grid - 5 columns for 5 brands */
        .brand-comparison-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
        }
        @media (max-width: 1400px) {
            .brand-comparison-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 900px) {
            .brand-comparison-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .brand-comparison-grid { grid-template-columns: 1fr; }
        }
        .brand-comparison-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }
        .brand-comparison-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .brand-comparison-card.top-performer {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(245, 197, 24, 0.1) 0%, var(--bg-card) 100%);
        }
        .brand-comparison-card .brand-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        .brand-comparison-card .brand-gmv {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .brand-comparison-card .brand-change {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 12px;
        }
        .brand-comparison-card .brand-mini-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .brand-comparison-card .brand-mini-stats span {
            background: var(--bg-secondary);
            padding: 6px 8px;
            border-radius: 6px;
        }

        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-muted); }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }
        
        .spinner-lg {
            width: 48px;
            height: 48px;
            border-width: 4px;
            margin: 0 auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Loading overlay for views - Enhanced */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.97);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 12px;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .loading-overlay .loading-spinner-container {
            position: relative;
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
        }
        
        .loading-overlay .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid var(--border);
            border-radius: 50%;
        }
        
        .loading-overlay .spinner-ring-active {
            border-color: transparent;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }
        
        .loading-overlay .spinner-ring-pulse {
            border-color: var(--accent);
            opacity: 0.2;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loading-overlay .loading-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .loading-overlay .loading-text {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .loading-overlay .loading-subtext {
            color: var(--text-muted);
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .loading-overlay .loading-dots {
            display: flex;
            gap: 6px;
            margin-top: 16px;
        }
        
        .loading-overlay .loading-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-overlay .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-overlay .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-overlay .loading-dot:nth-child(3) { animation-delay: 0s; }
        
        /* Card-level loading */
        .card-loading {
            position: relative;
            min-height: 200px;
        }
        
        .card-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-card);
            opacity: 0.8;
            z-index: 10;
        }
        
        /* Skeleton loading animation */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-card) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-stat {
            height: 32px;
            width: 120px;
        }
        
        /* Utility Animation Classes */
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out forwards;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .slide-in-up {
            animation: slideInUp 0.3s ease-out forwards;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .scale-in {
            animation: scaleIn 0.2s ease-out forwards;
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .data-refreshed {
            animation: dataRefresh 0.6s ease-out;
        }
        @keyframes dataRefresh {
            0% { background: var(--accent-dim); }
            100% { background: transparent; }
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .success-pulse {
            animation: successPulse 0.5s ease-out;
        }
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            100% { box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); }
        }
        
        /* Number counter animation */
        .count-up {
            transition: all 0.4s ease-out;
        }
        
        /* Staggered list animations */
        .stagger-item {
            opacity: 0;
            animation: staggerIn 0.3s ease-out forwards;
        }
        .stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { animation-delay: 0.1s; }
        .stagger-item:nth-child(3) { animation-delay: 0.15s; }
        .stagger-item:nth-child(4) { animation-delay: 0.2s; }
        .stagger-item:nth-child(5) { animation-delay: 0.25s; }
        @keyframes staggerIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Notification Badge with Pulse */
        .notification-badge {
            position: relative;
            display: inline-flex;
        }
        .notification-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -8px;
            right: -8px;
            min-width: 18px;
            height: 18px;
            background: var(--danger);
            color: #fff;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            animation: badgePop 0.3s ease-out;
        }
        .notification-badge[data-count="0"]::after {
            display: none;
        }
        .notification-badge.pulse::after {
            animation: badgePulse 2s infinite;
        }
        @keyframes badgePop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes badgePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        
        /* Data Refresh Indicator */
        .refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-secondary);
            border-radius: 20px;
            transition: all 0.2s;
        }
        .refresh-indicator.refreshing {
            color: var(--accent);
        }
        .refresh-indicator.refreshing .refresh-icon {
            animation: spin 1s linear infinite;
        }
        .refresh-indicator.success {
            color: var(--success);
            background: var(--success-dim);
        }
        .refresh-icon {
            transition: transform 0.2s;
        }
        .refresh-indicator:hover .refresh-icon {
            transform: rotate(180deg);
        }
        
        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        .breadcrumb-item {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.15s;
        }
        .breadcrumb-item:hover {
            color: var(--accent);
        }
        .breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: 500;
        }
        .breadcrumb-separator {
            color: var(--text-muted);
            opacity: 0.5;
        }
        
        /* Enhanced Tab Styling */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            padding-bottom: 0;
        }
        .tabs-container {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            padding-bottom: 0;
        }
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        .tab::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }
        .tab:hover {
            color: var(--text-primary);
        }
        .tab.active {
            color: var(--accent);
        }
        .tab.active::after {
            transform: scaleX(1);
        }
        .tab-count {
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
        }
        .tab.active .tab-count {
            background: var(--accent-dim);
            color: var(--accent);
        }
        
        /* Quick Stats Mini Cards */
        .quick-stat {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .quick-stat-icon {
            font-size: 1rem;
        }
        .quick-stat-value {
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }
        .quick-stat-label {
            color: var(--text-muted);
        }
        
        /* Collapsible Section */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            transition: all 0.2s;
        }
        .collapsible-header:hover {
            background: var(--bg-tertiary);
        }
        .collapsible-icon {
            transition: transform 0.3s ease;
        }
        .collapsible.open .collapsible-icon {
            transform: rotate(180deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .collapsible.open .collapsible-content {
            max-height: 1000px;
            padding-top: 12px;
        }
        
        /* Hover Card Preview */
        .hover-card-trigger {
            position: relative;
        }
        .hover-card {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
        }
        .hover-card-trigger:hover .hover-card {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Comparison Indicator */
        .comparison {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .comparison.better {
            background: var(--success-dim);
            color: var(--success);
        }
        .comparison.worse {
            background: var(--danger-dim);
            color: var(--danger);
        }
        .comparison.neutral {
            background: var(--bg-secondary);
            color: var(--text-muted);
        }
        
        /* Sparkline Placeholder */
        .sparkline {
            width: 80px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Text Truncate with Tooltip */
        .text-truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .text-truncate:hover {
            overflow: visible;
            white-space: normal;
            position: relative;
            z-index: 10;
            background: var(--bg-card);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            padding: 4px 8px;
            margin: -4px -8px;
            border-radius: 4px;
        }

        /* Enhanced Empty States */
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--text-muted);
            animation: fadeInUp 0.4s ease-out;
        }
        .empty-state .icon { 
            font-size: 4rem; 
            margin-bottom: 20px; 
            opacity: 0.6;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .empty-state h3 { 
            color: var(--text-secondary); 
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .empty-state p {
            color: var(--text-muted);
            font-size: 0.9rem;
            max-width: 300px;
            margin: 0 auto 20px;
        }
        .empty-state .btn {
            margin-top: 12px;
        }

        /* Enhanced Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            padding: 0;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            min-width: 320px;
            max-width: 420px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            overflow: hidden;
        }
        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
        }
        .toast-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }
        .toast-message {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
        }
        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        .toast-close:hover { opacity: 1; }
        .toast-progress {
            height: 3px;
            background: var(--accent);
            width: 100%;
            animation: toastProgress 4s linear forwards;
        }
        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-left-color: var(--success); }
        .toast.success .toast-progress { background: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.error .toast-progress { background: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.warning .toast-progress { background: var(--warning); }
        .toast.info { border-left-color: var(--blue); }
        .toast.info .toast-progress { background: var(--blue); }
        
        /* Filter Select Polish */
        .filter-select {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-select:hover {
            border-color: var(--accent);
        }
        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        /* Stat card hover for clickable ones */
        .stat-card[onclick]:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Scroll to Top Button */
        .scroll-to-top {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 998;
        }
        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .scroll-to-top:hover {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        
        @media (max-width: 768px) {
            .scroll-to-top {
                bottom: 80px; /* Above mobile nav */
            }
        }

        .search-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 40px 10px 40px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: inherit;
            width: 280px;
            transition: all 0.2s ease;
        }
        .search-input:hover {
            border-color: var(--border-light);
        }
        .search-input:focus {
            width: 320px;
            background: var(--bg-card);
        }
        .search-input::placeholder {
            color: var(--text-muted);
            transition: color 0.2s;
        }
        .search-input:focus::placeholder {
            color: transparent;
        }

        .search-wrapper { 
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .search-wrapper::before {
            content: "";
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.85rem;
            opacity: 0.6;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .search-wrapper:focus-within::before {
            opacity: 1;
        }
        .search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-muted);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
        }
        .search-wrapper:focus-within .search-clear,
        .search-input:not(:placeholder-shown) + .search-clear {
            opacity: 1;
        }
        .search-clear:hover {
            background: var(--danger);
            color: #fff;
        }
        
        /* Keyboard shortcut hint in search */
        .search-hint {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-family: monospace;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .search-input:focus ~ .search-hint,
        .search-input:not(:placeholder-shown) ~ .search-hint {
            opacity: 0;
        }
        
        /* Row Actions (appear on hover) */
        .row-actions {
            opacity: 0;
            transition: opacity 0.15s;
            display: flex;
            gap: 4px;
        }
        tr:hover .row-actions {
            opacity: 1;
        }
        .row-action-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.15s;
        }
        .row-action-btn:hover {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        .row-action-btn.danger:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: #fff;
        }
        
        /* Inline Edit Input */
        .inline-edit {
            background: transparent;
            border: 1px dashed transparent;
            padding: 4px 8px;
            margin: -4px -8px;
            border-radius: 4px;
            transition: all 0.15s;
            cursor: text;
        }
        .inline-edit:hover {
            border-color: var(--border);
            background: var(--bg-secondary);
        }
        .inline-edit:focus {
            border-style: solid;
            border-color: var(--accent);
            background: var(--bg-card);
            outline: none;
        }
        
        /* Number highlight animation */
        .number-highlight {
            display: inline-block;
            transition: all 0.3s ease;
        }
        .number-highlight.updated {
            animation: numberPop 0.4s ease-out;
        }
        @keyframes numberPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: var(--accent); }
            100% { transform: scale(1); }
        }
        
        /* Trend arrows with animation */
        .trend-arrow {
            display: inline-block;
            font-weight: 600;
        }
        .trend-arrow.up {
            color: var(--success);
            animation: trendUp 0.5s ease-out;
        }
        .trend-arrow.down {
            color: var(--danger);
            animation: trendDown 0.5s ease-out;
        }
        @keyframes trendUp {
            0% { transform: translateY(4px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes trendDown {
            0% { transform: translateY(-4px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(18, 20, 26, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay[style*="display: flex"] {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.show { opacity: 1; visibility: visible; }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .modal-content .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-content .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .modal-content .modal-body {
            padding: 20px 24px;
        }
        
        .tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            margin-left: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            background: var(--danger);
            border-radius: 10px;
        }
        
        .users-tab-content {
            animation: fadeIn 0.2s ease;
        }
        
        .modal-overlay.show .modal {
            animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.3rem; }
        .modal-close:hover { color: var(--text-primary); }
        
        .smart-match-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .smart-match-tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .smart-match-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .smart-match-tab .tab-count {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        .smart-match-tab.active .tab-count { background: var(--accent-dim); color: var(--accent); }
        
        .match-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        .match-card:hover { border-color: var(--accent); }
        .match-card.selected { border-color: var(--accent); background: var(--accent-dim); }
        .match-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .match-confidence {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .match-confidence.high { background: var(--success-dim); color: var(--success); }
        .match-confidence.medium { background: var(--warning-dim); color: var(--warning); }
        .match-confidence.low { background: var(--bg-tertiary); color: var(--text-muted); }
        .modal-body { padding: 24px; }

        .detail-header { display: flex; gap: 20px; align-items: flex-start; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }

        .detail-avatar {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.05));
            border: 2px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 2rem;
            color: var(--accent);
        }

        .detail-info { flex: 1; }
        .detail-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
        .detail-meta { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; }

        .detail-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }

        .detail-stat {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .detail-stat-value { font-size: 1.5rem; font-weight: 700; font-family: 'Space Mono', monospace; }
        .detail-stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab-btn.active { background: var(--accent); color: #000; }
        .tab-btn:hover:not(.active) { color: var(--text-primary); background: var(--bg-secondary); }

        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
        }
        .form-input:focus { outline: none; border-color: var(--accent); }

        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .pagination-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .pagination-btn:hover { border-color: var(--accent); }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination-info { color: var(--text-muted); font-size: 0.85rem; margin: 0 12px; }

        /* Daily Ops Styles */
        .win-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .win-card:hover {
            border-color: var(--accent);
            background: var(--bg-card);
        }
        .win-card.copied {
            border-color: var(--success);
            background: var(--success-dim);
        }
        .win-card .win-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .win-card .win-type {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .win-card .win-type.tier { background: var(--purple-dim); color: var(--purple); }
        .win-card .win-type.milestone { background: var(--accent-dim); color: var(--accent); }
        .win-card .win-type.first-sale { background: var(--success-dim); color: var(--success); }
        .win-card .win-type.personal-best { background: var(--blue-dim); color: var(--blue); }
        .win-card .win-type.streak { background: var(--cyan-dim); color: var(--cyan); }
        .win-card .win-brand {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .win-card .win-creator {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }
        .win-card .win-content {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .win-card .win-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: right;
        }

        .spotlight-card {
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.02));
            border: 1px solid rgba(245, 197, 24, 0.3);
            border-radius: 12px;
            padding: 24px;
        }
        .spotlight-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .spotlight-creator {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        .spotlight-brand {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .spotlight-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .spotlight-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .spotlight-stat .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .spotlight-stat .label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .spotlight-reason {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }
        .spotlight-copy {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        .spotlight-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn-tiny {
            padding: 4px 8px;
            font-size: 0.7rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-tiny:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        /* Action Items */
        .action-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
        }
        .action-item.win {
            border-left: 3px solid var(--success);
        }
        .action-item.attention {
            border-left: 3px solid var(--warning);
        }
        .action-item .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .action-item .action-header strong {
            color: var(--text-primary);
        }
        .action-item .gmv {
            color: var(--success);
            font-weight: 600;
        }
        .action-item .prior-gmv {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        .action-item .action-reasons,
        .action-item .action-issues {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .action-item .action-buttons {
            display: flex;
            gap: 8px;
        }

        .empty-message {
            color: var(--text-muted);
            font-size: 0.85rem;
            padding: 12px;
            text-align: center;
        }

        /* Brand Action Cards */
        .brand-action-grid, .weekly-brand-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .brand-action-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .brand-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .brand-action-card.completed {
            opacity: 0.6;
        }
        .brand-action-card.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        .brand-action-card.health-great {
            border-color: var(--success);
        }
        .brand-action-card.health-ok {
            border-color: var(--warning);
        }
        .brand-action-card.health-bad {
            border-color: var(--danger);
        }
        .brand-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .brand-card-header .brand-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        .brand-card-header .complete-badge {
            font-size: 1rem;
        }
        .brand-card-stats {
            margin-bottom: 10px;
        }
        .brand-card-stats .stat {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .brand-card-stats .stat-change {
            font-size: 0.8rem;
        }
        .brand-card-stats .stat-change.positive {
            color: var(--success);
        }
        .brand-card-stats .stat-change.negative {
            color: var(--danger);
        }
        .brand-card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .action-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .action-badge.wins {
            background: var(--success-dim);
            color: var(--success);
        }
        .action-badge.attention {
            background: var(--warning-dim);
            color: var(--warning);
        }
        .action-badge.neutral {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        /* Daily Ops Progress Hero */
        .daily-progress-hero {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .daily-progress-hero .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .daily-progress-hero .progress-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .daily-progress-hero .progress-count {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .daily-progress-hero .progress-bar-container {
            height: 10px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .daily-progress-hero .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .daily-progress-hero .progress-brands {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .daily-progress-hero .brand-check {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .daily-progress-hero .brand-check:hover {
            border-color: var(--accent);
        }
        .daily-progress-hero .brand-check.completed {
            background: var(--success-dim);
            border-color: var(--success);
            color: var(--success);
        }
        .daily-progress-hero .brand-check input {
            width: 18px;
            height: 18px;
            accent-color: var(--success);
        }

        /* Daily Snapshot Stats */
        .daily-snapshot {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
        }
        .snapshot-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .snapshot-card.primary {
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.05));
            border-color: rgba(245, 197, 24, 0.3);
        }
        .snapshot-card .snapshot-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .snapshot-card.primary .snapshot-value {
            color: var(--accent);
        }
        .snapshot-card .snapshot-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        .snapshot-card .snapshot-change {
            font-size: 0.8rem;
            margin-top: 6px;
            font-weight: 600;
        }
        .snapshot-card .snapshot-change.positive {
            color: var(--success);
        }
        .snapshot-card .snapshot-change.negative {
            color: var(--danger);
        }

        /* Daily Wins Hero */
        .daily-wins-hero {
            border: 2px solid var(--success);
            border-radius: 16px;
        }
        .daily-wins-hero .card-header {
            background: var(--success-dim);
            border-radius: 14px 14px 0 0;
        }
        .wins-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 16px;
        }
        .win-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .win-item:hover {
            border-color: var(--success);
            background: var(--bg-card);
        }
        .win-item.copied {
            border-color: var(--success);
            background: var(--success-dim);
        }
        .win-item .win-info {
            flex: 1;
        }
        .win-item .win-creator {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .win-item .win-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .win-item .win-gmv {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success);
            margin-right: 16px;
        }
        .win-item .win-actions {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 900px) {
            .daily-snapshot {
                grid-template-columns: repeat(3, 1fr);
            }
            .daily-progress-hero .progress-brands {
                flex-direction: column;
            }
        }
        @media (max-width: 600px) {
            .daily-snapshot {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Win Card in All Wins section */
        .win-card .win-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .win-card .badge-brand {
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .win-card .win-reasons {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Spotlight Card (simple version) */
        .spotlight-card {
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.02));
            border: 1px solid rgba(245, 197, 24, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Table badges */
        .badge-managed {
            background: var(--success-dim);
            color: var(--success);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .badge-unmanaged {
            background: var(--bg-card);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .gmv-value {
            font-weight: 600;
            color: var(--success);
        }
        td.positive {
            color: var(--success);
        }
        td.negative {
            color: var(--danger);
        }
        .brand-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .brand-kpi-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .brand-kpi-card:hover {
            border-color: var(--accent);
            background: var(--bg-card);
        }
        .brand-kpi-card.copied {
            border-color: var(--success);
            background: var(--success-dim);
        }
        .brand-kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .brand-kpi-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }
        .brand-kpi-change {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .brand-kpi-change.positive {
            background: var(--success-dim);
            color: var(--success);
        }
        .brand-kpi-change.negative {
            background: var(--danger-dim);
            color: var(--danger);
        }
        .brand-kpi-gmv {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 16px;
        }
        .brand-kpi-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .brand-kpi-stats > div {
            text-align: center;
        }
        .brand-kpi-stats .label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .brand-kpi-stats .value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .brand-kpi-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 12px;
        }

        /* Attention List Styles */
        .issue-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            margin: 2px;
        }
        .issue-badge.severe { background: var(--danger-dim); color: var(--danger); }
        .issue-badge.warning { background: var(--warning-dim); color: var(--warning); }
        .issue-badge.info { background: var(--blue-dim); color: var(--blue); }
        
        .winner-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            margin: 2px;
            background: var(--success-dim);
            color: var(--success);
        }
        .winner-badge.gold { background: var(--accent-dim); color: var(--accent); }
        .winner-badge.purple { background: var(--purple-dim); color: var(--purple); }
        .winner-badge.blue { background: var(--blue-dim); color: var(--blue); }
        .winner-badge.cyan { background: var(--cyan-dim); color: var(--cyan); }
        
        .status-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .status-badge.managed { background: var(--accent-dim); color: var(--accent); }
        .status-badge.unmanaged { background: var(--bg-card); color: var(--text-muted); }

        .change-indicator {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .change-indicator.positive { color: var(--success); }
        .change-indicator.negative { color: var(--danger); }
        .change-indicator.neutral { color: var(--text-muted); }

        /* Brand Detail Styles */
        .brand-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.02));
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .brand-detail-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
        }
        .brand-detail-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .brand-detail-gmv {
            text-align: right;
        }
        .brand-detail-gmv .value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        .brand-detail-gmv .change {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .brand-detail-gmv .change.positive { color: var(--success); }
        .brand-detail-gmv .change.negative { color: var(--danger); }

        .brand-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .brand-metric-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        .brand-metric-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .brand-metric-card .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }
        .brand-metric-card .change {
            font-size: 0.8rem;
            margin-top: 6px;
        }

        .filter-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Rate Badge for Creator Breakdown */
        .rate-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rate-badge.standard {
            background: var(--success-dim);
            color: var(--success);
        }
        .rate-badge.custom {
            background: var(--accent-dim);
            color: var(--accent);
        }
        .rate-badge:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        /* Task Checklist */
        .task-checklist {
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .checklist-title {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        .checklist-item:hover {
            color: var(--text-primary);
        }
        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--success);
            cursor: pointer;
        }
        .checklist-item input[type="checkbox"]:checked + span {
            color: var(--success);
            text-decoration: line-through;
        }
        .checklist-progress {
            flex: 1;
            min-width: 100px;
            max-width: 150px;
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
        }
        .checklist-progress-bar {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Data Health Alert */
        .data-health-alert {
            background: var(--warning-dim);
            border: 1px solid rgba(245, 197, 24, 0.3);
            border-radius: 10px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .data-health-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .data-health-header:hover {
            background: rgba(245, 197, 24, 0.1);
        }
        .data-health-icon {
            font-size: 1.2rem;
        }
        .data-health-title {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .data-health-toggle {
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .data-health-alert.expanded .data-health-toggle {
            transform: rotate(180deg);
        }
        .data-health-details {
            border-top: 1px solid rgba(245, 197, 24, 0.2);
            padding: 12px 16px;
            background: var(--bg-secondary);
        }
        .data-health-table-wrapper {
            overflow-x: auto;
        }
        .data-health-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
        }
        .data-health-table th,
        .data-health-table td {
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .data-health-table th {
            background: var(--bg-card);
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
        }
        .data-health-table td:first-child,
        .data-health-table td:nth-child(2) {
            text-align: left;
        }
        .data-health-table .status-ok {
            color: var(--success);
        }
        .data-health-table .status-missing {
            color: var(--danger);
            font-weight: 600;
        }

        /* No Data Warning */
        .no-data-warning {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--warning-dim);
            border: 1px solid rgba(245, 197, 24, 0.3);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .no-data-warning .warning-icon {
            font-size: 2rem;
        }
        .no-data-warning .warning-text {
            flex: 1;
        }
        .no-data-warning .warning-text strong {
            display: block;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .no-data-warning .warning-text p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Quick Copy Button on Brand Cards */
        .brand-kpi-card {
            position: relative;
        }
        .quick-copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            color: var(--text-secondary);
        }
        .brand-kpi-card:hover .quick-copy-btn {
            opacity: 1;
        }
        .quick-copy-btn:hover {
            background: var(--accent-dim);
            color: var(--accent);
            border-color: var(--accent);
        }
        .quick-copy-btn.copied {
            background: var(--success-dim);
            color: var(--success);
            border-color: var(--success);
        }

        /* Brand Action Board */
        .brand-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .brand-action-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .brand-action-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .brand-action-card.completed {
            border-color: var(--success);
            background: var(--success-dim);
        }
        .brand-action-card.completed::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.2rem;
            color: var(--success);
        }
        .brand-action-card .brand-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        .brand-action-card .action-counts {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .brand-action-card .action-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
        .brand-action-card .action-row .label {
            color: var(--text-muted);
        }
        .brand-action-card .action-row .value {
            font-weight: 600;
        }
        .brand-action-card .action-row .value.has-items {
            color: var(--accent);
        }
        .brand-action-card .action-row .value.warning {
            color: var(--warning);
        }
        .brand-action-card .action-row .value.success {
            color: var(--success);
        }
        .brand-action-card .dod-change {
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 4px;
        }
        .brand-action-card .dod-change.positive { color: var(--success); }
        .brand-action-card .dod-change.negative { color: var(--error); }
        .brand-action-card .urgency-indicator {
            position: absolute;
            top: -4px;
            left: -4px;
            background: var(--warning);
            color: var(--bg-primary);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* All Complete Celebration */
        .all-complete-msg {
            background: linear-gradient(135deg, var(--success-dim), var(--accent-dim));
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 16px;
            animation: celebrate 0.5s ease-out;
        }
        @keyframes celebrate {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Mini Stats */
        .mini-stat {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .mini-stat .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .mini-stat .label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Brand Section Headers */
        .brand-section h4 {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            transition: background 0.2s ease;
        }
        .collapsible-header:hover {
            background: var(--bg-secondary);
        }
        .collapsible-header::marker {
            color: var(--accent);
        }
        .collapsible-content {
            padding: 0 20px 20px;
        }

        /* Brand Checklist Items */
        #brandChecklistItems {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .brand-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .brand-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--success);
        }
        .brand-check.completed span {
            color: var(--success);
            text-decoration: line-through;
        }

        /* Weekly Brand Brief Cards */
        .weekly-brand-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .weekly-brand-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .weekly-brand-card:hover {
            border-color: var(--accent);
        }
        .weekly-brand-card.completed {
            border-color: var(--success);
            opacity: 0.7;
        }
        .weekly-brand-card .brand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .weekly-brand-card .brand-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
        }
        .weekly-brand-card .brand-gmv {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 16px;
        }
        .weekly-brand-card .brand-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .weekly-brand-card .action-item {
            background: var(--bg-card);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .weekly-brand-card .action-item .count {
            font-size: 1.25rem;
            font-weight: 700;
        }
        .weekly-brand-card .action-item .label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .weekly-brand-card .action-item.winners .count { color: var(--success); }
        .weekly-brand-card .action-item.attention .count { color: var(--warning); }

        @media (max-width: 900px) {
            .sidebar { 
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                display: flex;
                transform: translateX(0);
            }
            .main { margin-left: 0; padding-bottom: 80px; }
            .mobile-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px 16px;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                position: sticky;
                top: 0;
                z-index: 100;
            }
            .mobile-menu-btn {
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 8px 12px;
                color: var(--text-primary);
                font-size: 1.2rem;
                cursor: pointer;
            }
            .mobile-logo { height: 32px; }
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.6);
                z-index: 999;
            }
            .mobile-overlay.open { display: block; }
            .spotlight-stats { grid-template-columns: repeat(2, 1fr); }
            .brand-kpi-grid { grid-template-columns: 1fr; }
            .brand-metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .task-checklist { flex-direction: column; align-items: flex-start; gap: 12px; }
            .checklist-progress { width: 100%; max-width: 100%; }
            .header-actions { flex-wrap: wrap; gap: 8px; }
            .brand-action-grid { grid-template-columns: repeat(2, 1fr); }
            .weekly-brand-grid { grid-template-columns: 1fr; }
            .brand-detail-stats { grid-template-columns: repeat(2, 1fr) !important; }
            #brandChecklistItems, #weeklyBrandChecklistItems { flex-direction: column; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .filters { flex-wrap: wrap; }
            .filter-group { min-width: 45%; }
            
            /* Mobile bottom nav enhancements */
            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-secondary);
                border-top: 1px solid var(--border);
                display: flex;
                justify-content: space-around;
                padding: 8px 0;
                padding-bottom: max(8px, env(safe-area-inset-bottom));
                z-index: 100;
            }
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                padding: 8px 12px;
                background: none;
                border: none;
                color: var(--text-muted);
                font-size: 0.65rem;
                cursor: pointer;
                transition: color 0.2s;
                min-width: 60px;
            }
            .mobile-nav-item.active {
                color: var(--accent);
            }
            .mobile-nav-icon {
                font-size: 1.3rem;
            }
            
            /* Notification center mobile */
            .notification-center {
                width: calc(100vw - 24px);
                max-width: 400px;
                right: -50%;
                transform: translateX(50%);
            }
            
            /* Leaderboard podium mobile */
            .leaderboard-podium {
                padding: 24px 10px;
                gap: 10px;
            }
            .podium-avatar { width: 60px; height: 60px; font-size: 1.5rem; }
            .podium-place.first .podium-avatar { width: 70px; height: 70px; }
            .podium-name { font-size: 0.85rem; max-width: 80px; }
            .podium-gmv { font-size: 1rem; }
            .podium-base { width: 70px; }
            
            /* Bulk actions mobile */
            .bulk-actions-bar {
                flex-direction: column;
                gap: 12px;
                padding: 12px;
            }
            .bulk-actions-buttons {
                flex-wrap: wrap;
                margin-left: 0;
                justify-content: center;
            }
            .bulk-btn {
                flex: 1;
                min-width: 100px;
                justify-content: center;
            }
            
            /* View toggle mobile */
            .view-toggle {
                width: 100%;
                justify-content: center;
            }
        }

        /* Managed stats grid */
        .managed-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            text-align: center;
        }

        @media (max-width: 600px) {
            .mobile-header { padding: 10px 12px; }
            .header { padding: 16px; flex-direction: column; align-items: flex-start; gap: 12px; }
            .header-title { font-size: 1.3rem; }
            .header-subtitle { font-size: 0.8rem; }
            .view-section { padding: 12px; }
            .stats-grid { grid-template-columns: 1fr; gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 1.5rem; }
            .brand-action-grid { grid-template-columns: 1fr; }
            .brand-action-card { padding: 14px; }
            .filters { gap: 8px; flex-direction: column; }
            .filter-group { min-width: 100%; width: 100%; }
            .filter-label { font-size: 0.7rem; }
            .card { padding: 16px; margin-bottom: 16px; }
            .card-title { font-size: 1rem; }
            .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table { min-width: 600px; }
            .leaderboard-item { padding: 12px; gap: 10px; }
            .leaderboard-name { font-size: 0.85rem; }
            .btn { padding: 8px 14px; font-size: 0.8rem; }
            .btn-primary { padding: 10px 16px; }
            .modal-content { width: 95%; margin: 10px; padding: 16px; max-height: 90vh; }
            .brand-detail-stats { grid-template-columns: 1fr !important; }
            .spotlight-stats { grid-template-columns: 1fr; }
            .spotlight-card { padding: 14px; }
            .checklist-item { padding: 8px 12px; font-size: 0.8rem; }
            
            /* Mobile card layout for tables */
            .mobile-card-view .table-container table { display: none; }
            .mobile-card-view .mobile-cards { display: block; }
            .mobile-cards { display: none; }
            .mobile-data-card {
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 16px;
                margin-bottom: 12px;
            }
            .mobile-data-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
            }
            .mobile-data-card-title {
                font-weight: 600;
                font-size: 1rem;
            }
            .mobile-data-card-subtitle {
                font-size: 0.8rem;
                color: var(--text-muted);
            }
            .mobile-data-card-stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            .mobile-data-card-stat {
                text-align: center;
                padding: 8px;
                background: var(--bg-secondary);
                border-radius: 6px;
            }
            .mobile-data-card-stat-value {
                font-weight: 700;
                font-size: 1.1rem;
            }
            .mobile-data-card-stat-label {
                font-size: 0.7rem;
                color: var(--text-muted);
            }
            .mobile-data-card-actions {
                display: flex;
                gap: 8px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid var(--border);
            }
            .mobile-data-card-actions .btn {
                flex: 1;
            }
            
            /* Managed/Unmanaged cards - single column on mobile */
            .managed-stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .managed-stats-grid .stat-value {
                font-size: 1.3rem !important;
            }
            
            /* Header actions stack vertically */
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            .header-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* Mobile-friendly leaderboard stats */
            .leaderboard-stats {
                gap: 12px;
            }
            .leaderboard-stat {
                min-width: 50px;
            }
            .leaderboard-stat .value {
                font-size: 0.85rem;
            }
            
            /* Touch-friendly buttons */
            .action-btn {
                min-width: 36px;
                min-height: 36px;
            }
            
            /* Pull to refresh indicator */
            .pull-to-refresh {
                text-align: center;
                padding: 16px;
                color: var(--text-muted);
                font-size: 0.85rem;
                display: none;
            }
            .pull-to-refresh.active {
                display: block;
            }
        }

        @media (max-width: 400px) {
            .mobile-header { padding: 8px 10px; }
            .mobile-logo { height: 28px; }
            .header-title { font-size: 1.1rem; }
            .stat-value { font-size: 1.3rem; }
            .stat-label { font-size: 0.7rem; }
            .nav-item { padding: 10px 14px; font-size: 0.85rem; }
            .mobile-nav-item { min-width: 50px; padding: 6px 8px; }
            .mobile-nav-icon { font-size: 1.1rem; }
            .notification-center { width: calc(100vw - 16px); }
        }

        /* Hide mobile header on desktop */
        .mobile-header { display: none; }
        .mobile-overlay { display: none; }
        .mobile-bottom-nav { display: none; }

        /* Mobile bottom navigation */
        @media (max-width: 900px) {
            .mobile-bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-secondary);
                border-top: 1px solid var(--border);
                justify-content: space-around;
                padding: 8px 0;
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
                z-index: 1000;
            }
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
                padding: 8px 12px;
                color: var(--text-muted);
                text-decoration: none;
                font-size: 0.65rem;
                font-weight: 500;
                border: none;
                background: none;
                cursor: pointer;
                border-radius: 8px;
            }
            .mobile-nav-item.active {
                color: var(--accent);
                background: rgba(245, 197, 24, 0.1);
            }
            .mobile-nav-icon {
                font-size: 1.3rem;
            }
            .main {
                padding-bottom: 80px !important;
            }
        }

        /* Print Styles for PDF Export */
        @media print {
            body { background: white; color: black; }
            .sidebar, .mobile-header, .mobile-overlay, .nav-section, .filters, .header-actions, .btn, .period-toggle { display: none !important; }
            .main { margin-left: 0 !important; padding: 0 !important; }
            .view-section { display: none !important; padding: 0 !important; }
            .view-section.print-active { display: block !important; }
            .header { padding: 20px 0; border-bottom: 2px solid #333; }
            .header-title { color: black; }
            .header-subtitle { color: #666; }
            .stat-card { background: #f5f5f5; border: 1px solid #ddd; color: black; break-inside: avoid; }
            .stat-value { color: black !important; }
            .stat-label { color: #666; }
            .card { background: #f9f9f9; border: 1px solid #ddd; break-inside: avoid; }
            .card-title { color: black; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background: #f0f0f0; }
            .badge-brand, .badge-tier { border: 1px solid #999; background: #eee; color: black; }
            .gmv-value { color: black !important; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
            .print-header img { height: 50px; }
            .print-header h1 { margin: 10px 0 5px; }
            .print-header p { color: #666; }
            .no-print { display: none !important; }
        }
        .print-header { display: none; }

        /* Funnel Builder Styles - Revamped */
        .funnels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .funnel-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .funnel-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        /* Dropdown menu styles */
        .dropdown-item:hover {
            background: var(--bg-secondary);
        }
        
        .funnel-card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        .funnel-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .funnel-card-info { flex: 1; min-width: 0; }
        .funnel-card-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .funnel-card-brand {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .funnel-card-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .funnel-card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 16px 20px;
            gap: 12px;
            background: var(--bg-secondary);
        }
        .funnel-stat {
            text-align: center;
        }
        .funnel-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .funnel-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .funnel-card-actions {
            padding: 16px 20px;
            display: flex;
            gap: 8px;
        }
        .funnel-card-actions .btn { flex: 1; }
        
        /* New Builder Styles */
        .funnel-builder-modal { background: var(--bg-primary); }
        
        .form-group-sm { margin-bottom: 12px; }
        .form-group-sm label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .form-group-sm .form-input {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .settings-section {
            border-bottom: 1px solid var(--border);
        }
        .settings-section-header {
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.2s;
        }
        .settings-section-header:hover {
            background: var(--bg-card);
        }
        .settings-toggle {
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .settings-section-content {
            padding: 0 16px 16px;
            display: none;
        }
        .settings-section-content.show {
            display: block;
        }
        
        .field-blocks-palette {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .draggable-block {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: grab;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .draggable-block:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        .draggable-block:active {
            cursor: grabbing;
        }
        .draggable-block .block-icon {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .fields-drop-zone {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        .fields-drop-zone.drag-over {
            background: var(--accent-dim);
        }
        .fields-list-new {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 100px;
        }
        .drop-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0.7;
        }
        .fields-list-new:not(:empty) + .drop-hint { display: none; }
        
        .field-item-new {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: grab;
            transition: all 0.2s;
        }
        .field-item-new:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .field-item-new.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        .field-item-new .field-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        .field-item-new .field-info { flex: 1; min-width: 0; }
        .field-item-new .field-label-new {
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .field-item-new .field-label-new .required-badge {
            background: var(--danger);
            color: white;
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 4px;
        }
        .field-item-new .field-meta-new {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .field-item-new .field-actions-new {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .field-item-new:hover .field-actions-new {
            opacity: 1;
        }
        .field-item-new .field-actions-new button {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .field-item-new .field-actions-new button:hover {
            background: var(--accent-dim);
        }
        
        .step-tab {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .step-tab:hover { border-color: var(--accent); }
        .step-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .step-tab.active button {
            color: rgba(255,255,255,0.7) !important;
        }
        .step-tab.active button:hover {
            color: white !important;
        }
        
        /* Preview Styles */
        .preview-device-btn {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .preview-device-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .preview-device-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .preview-mobile {
            width: 320px;
            background: #0d0d0d;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 0 0 8px #333, 0 0 0 10px #1a1a1a;
            min-height: 500px;
        }
        .preview-desktop {
            width: 100%;
            max-width: 600px;
            background: #0d0d0d;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-height: 400px;
        }
        
        /* Legacy Funnel Builder Styles */
        .funnel-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .funnel-tab:hover { color: var(--text-primary); }
        .funnel-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .funnel-tab-content { display: none !important; }
        .funnel-tab-content.active { display: flex !important; flex-direction: column; }
        
        .field-type-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        .field-type-btn:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        .fields-list, .steps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .field-item, .step-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
        }
        .field-item:hover, .step-item:hover {
            border-color: var(--accent);
        }
        .field-item.dragging, .step-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .field-item .drag-handle, .step-item .drag-handle {
            color: var(--text-muted);
            cursor: grab;
        }
        .field-item .field-info {
            flex: 1;
        }
        .field-item .field-label {
            font-weight: 500;
            color: var(--text-primary);
        }
        .field-item .field-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .field-item .field-actions {
            display: flex;
            gap: 8px;
        }
        .field-item .field-actions button {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .field-item .field-actions button:hover {
            background: var(--accent-dim);
            color: var(--accent);
        }
        .field-item .field-actions button.delete:hover {
            background: var(--danger-dim);
            color: var(--danger);
        }
        
        /* Preview Styles */
        .preview-form {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
        }
        .preview-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .preview-header h2 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        .preview-header p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .preview-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .preview-step {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 0.75rem;
        }
        .preview-step.active {
            background: var(--accent);
            color: var(--bg-primary);
        }
        .preview-field {
            margin-bottom: 16px;
        }
        .preview-field label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: var(--text-secondary);
        }
        .preview-field input, .preview-field select, .preview-field textarea {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .preview-field.half {
            display: inline-block;
            width: calc(50% - 8px);
            margin-right: 16px;
        }
        .preview-field.half:nth-child(even) {
            margin-right: 0;
        }

    </style>
</head>
<body>
    <!-- Auth Check Overlay -->
    <div id="authCheck" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #12141a; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px;">
        <div style="width: 40px; height: 40px; border: 3px solid #2e3440; border-top-color: #f5c518; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        <div style="color: #9aa5b8; font-family: Inter, sans-serif;">Checking authorization...</div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    </div>

    <!-- Access Request Screen -->
    <div id="accessRequestScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #12141a; z-index: 9999; font-family: Inter, sans-serif;">
        <div style="max-width: 480px; margin: 80px auto; padding: 40px; background: #1a1d24; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                <h1 style="color: #fff; font-size: 1.5rem; margin-bottom: 8px;">Admin Access Required</h1>
                <p style="color: #9aa5b8; font-size: 0.95rem;" id="accessRequestMessage">You need team access to use this dashboard.</p>
            </div>
            
            <!-- Request Form -->
            <div id="accessRequestForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #9aa5b8; font-size: 0.85rem; margin-bottom: 8px;">Your Name</label>
                    <input type="text" id="requestName" placeholder="Enter your name" style="width: 100%; padding: 12px 16px; background: #12141a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #9aa5b8; font-size: 0.85rem; margin-bottom: 8px;">Requested Role</label>
                    <select id="requestRole" style="width: 100%; padding: 12px 16px; background: #12141a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 1rem;">
                        <option value="va">VA (Virtual Assistant)</option>
                        <option value="payments">Payments</option>
                        <option value="analyst">Analyst</option>
                        <option value="content_lead">Content Lead</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; color: #9aa5b8; font-size: 0.85rem; margin-bottom: 8px;">Why do you need access? (Optional)</label>
                    <textarea id="requestReason" placeholder="Briefly describe your role..." style="width: 100%; padding: 12px 16px; background: #12141a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 1rem; min-height: 80px; resize: vertical;"></textarea>
                </div>
                <button onclick="submitAccessRequest()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #f5c518 0%, #ff6b35 100%); border: none; border-radius: 8px; color: #000; font-weight: 600; font-size: 1rem; cursor: pointer;">
                    Request Access
                </button>
            </div>
            
            <!-- Pending State -->
            <div id="accessPendingState" style="display: none; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 16px;"></div>
                <p style="color: #f5c518; font-weight: 600; margin-bottom: 8px;">Request Pending</p>
                <p style="color: #9aa5b8; font-size: 0.9rem;">Your access request has been submitted. An admin will review it shortly.</p>
                <p style="color: #6b7280; font-size: 0.8rem; margin-top: 16px;" id="requestSubmittedAt"></p>
            </div>
            
            <!-- Denied State -->
            <div id="accessDeniedState" style="display: none; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 16px;"></div>
                <p style="color: #ef4444; font-weight: 600; margin-bottom: 8px;">Access Denied</p>
                <p style="color: #9aa5b8; font-size: 0.9rem;" id="deniedReason">Your request was not approved.</p>
                <button onclick="resetAccessRequest()" style="margin-top: 20px; padding: 10px 20px; background: #2e3440; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; cursor: pointer;">
                    Request Again
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button onclick="accessLogout()" style="padding: 10px 20px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #9aa5b8; cursor: pointer; font-size: 0.9rem;">
                    Sign Out
                </button>
            </div>
        </div>
    </div>

    <script>
        // Stub functions to prevent errors while main script loads
        window.switchView = function(view) { 
            console.log('switchView called before ready, queueing:', view);
            window._pendingView = view;
        };
        window.applyRoleBasedNav = function() {};
        
        let authSupabase = null;
        let currentSession = null;
        
        // Auth check - wait for DOM to ensure all functions are defined
        document.addEventListener('DOMContentLoaded', async function() {
            const SUPABASE_URL = 'https://elrsgxlyejlkzjcnhmak.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscnNneGx5ZWpsa3pqY25obWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQ5OTUsImV4cCI6MjA3OTU5MDk5NX0.8XScMdGkFRqRIDMPY3gWS5tk0Z8NbGzDXuH1dsnBdZ0';

            try {
                authSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                const { data: { session }, error: sessionError } = await authSupabase.auth.getSession();
                currentSession = session;
                
                console.log('Admin auth check - session:', session ? 'found' : 'not found');

                if (!session) {
                    window.location.href = 'index.html';
                    return;
                }

                // Check if user has team role in user_profiles
                const { data: profile, error: profileError } = await authSupabase
                    .from('user_profiles')
                    .select('role, status')
                    .eq('user_id', session.user.id)
                    .single();
                
                console.log('Profile check:', profile, profileError);

                // Define allowed team roles
                const teamRoles = ['admin', 'content_lead', 'analyst', 'payments', 'automations', 'va'];
                
                if (profile && teamRoles.includes(profile.role) && profile.status === 'approved') {
                    // User is authorized - show admin panel
                    window.currentUserRole = profile.role;
                    
                    if (typeof applyRoleBasedNav === 'function') {
                        applyRoleBasedNav(profile.role);
                    }

                    document.getElementById('authCheck').style.display = 'none';
                    
                    const name = session.user.user_metadata?.name || session.user.email?.split('@')[0] || 'Admin';
                    document.getElementById('adminAvatar').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('adminName').textContent = name;
                    
                    const roleLabels = {
                        'admin': 'Administrator',
                        'content_lead': 'Content Lead',
                        'analyst': 'Analyst',
                        'payments': 'Payments',
                        'automations': 'Automations',
                        'va': 'VA'
                    };
                    document.getElementById('adminRole').textContent = roleLabels[profile.role] || profile.role;
                    return;
                }

                // Not authorized - check for existing access request
                const { data: existingRequest } = await authSupabase
                    .from('admin_access_requests')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                // Pre-fill name from Discord
                const userName = session.user.user_metadata?.name || session.user.user_metadata?.full_name || '';
                document.getElementById('requestName').value = userName;

                if (existingRequest) {
                    if (existingRequest.status === 'pending') {
                        // Show pending state
                        showAccessPending(existingRequest);
                    } else if (existingRequest.status === 'denied') {
                        // Show denied state
                        showAccessDenied(existingRequest.denied_reason);
                    }
                    // If approved, they should have a user_profile, so show request form as fallback
                } else {
                    // No request yet - show request form
                    showAccessRequestForm();
                }

            } catch (err) {
                console.error('Auth check failed:', err);
                // Show request form on error (table might not exist yet)
                showAccessRequestForm();
            }
        });

        function showAccessRequestForm() {
            document.getElementById('authCheck').style.display = 'none';
            document.getElementById('accessRequestScreen').style.display = 'block';
            document.getElementById('accessRequestForm').style.display = 'block';
            document.getElementById('accessPendingState').style.display = 'none';
            document.getElementById('accessDeniedState').style.display = 'none';
        }

        function showAccessPending(request) {
            document.getElementById('authCheck').style.display = 'none';
            document.getElementById('accessRequestScreen').style.display = 'block';
            document.getElementById('accessRequestForm').style.display = 'none';
            document.getElementById('accessPendingState').style.display = 'block';
            document.getElementById('accessDeniedState').style.display = 'none';
            
            const submitted = new Date(request.created_at).toLocaleString();
            document.getElementById('requestSubmittedAt').textContent = `Submitted: ${submitted}`;
        }

        function showAccessDenied(reason) {
            document.getElementById('authCheck').style.display = 'none';
            document.getElementById('accessRequestScreen').style.display = 'block';
            document.getElementById('accessRequestForm').style.display = 'none';
            document.getElementById('accessPendingState').style.display = 'none';
            document.getElementById('accessDeniedState').style.display = 'block';
            
            if (reason) {
                document.getElementById('deniedReason').textContent = reason;
            }
        }

        async function submitAccessRequest() {
            const name = document.getElementById('requestName').value.trim();
            const role = document.getElementById('requestRole').value;
            const reason = document.getElementById('requestReason').value.trim();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            try {
                const { error } = await authSupabase.from('admin_access_requests').insert({
                    user_id: currentSession.user.id,
                    email: currentSession.user.email,
                    name: name,
                    requested_role: role,
                    reason: reason,
                    discord_id: currentSession.user.user_metadata?.provider_id || null,
                    discord_username: currentSession.user.user_metadata?.name || currentSession.user.user_metadata?.full_name || null,
                    discord_avatar: currentSession.user.user_metadata?.avatar_url || null,
                    status: 'pending'
                });

                if (error) throw error;

                showAccessPending({ created_at: new Date().toISOString() });
            } catch (err) {
                console.error('Failed to submit request:', err);
                alert('Failed to submit request. Please try again.');
            }
        }

        async function resetAccessRequest() {
            // Delete old denied request and show form again
            try {
                await authSupabase.from('admin_access_requests')
                    .delete()
                    .eq('user_id', currentSession.user.id)
                    .eq('status', 'denied');
            } catch (err) {
                console.error('Error resetting request:', err);
            }
            showAccessRequestForm();
        }

        async function accessLogout() {
            await authSupabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // Admin logout function
        async function adminLogout() {
            const SUPABASE_URL = 'https://elrsgxlyejlkzjcnhmak.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscnNneGx5ZWpsa3pqY25obWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQ5OTUsImV4cCI6MjA3OTU5MDk5NX0.8XScMdGkFRqRIDMPY3gWS5tk0Z8NbGzDXuH1dsnBdZ0';
            const supabaseAuth = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            await supabaseAuth.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"></button>
        <img src="logo.png" alt="Creators Corner" class="mobile-logo" onerror="this.outerHTML='<span style=\'font-weight:800;color:#f5c518;\'>CREATORS CORNER</span>'">
        <a href="upload.html" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;"> Upload</a>
    </div>
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <button class="mobile-nav-item active" onclick="switchView('overview')">
            <span class="mobile-nav-icon"></span>
            <span>Overview</span>
        </button>
        <button class="mobile-nav-item" onclick="switchView('creators')">
            <span class="mobile-nav-icon"></span>
            <span>Creators</span>
        </button>
        <button class="mobile-nav-item" onclick="switchView('brands')">
            <span class="mobile-nav-icon"></span>
            <span>Brands</span>
        </button>
        <button class="mobile-nav-item" onclick="switchView('videos')">
            <span class="mobile-nav-icon"></span>
            <span>Videos</span>
        </button>
        <button class="mobile-nav-item" onclick="toggleMobileMenu()">
            <span class="mobile-nav-icon"></span>
            <span>More</span>
        </button>
    </nav>

    <aside class="sidebar">
        <div class="logo-section">
            <img src="logo.png" alt="Creators Corner" class="logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display:none; font-size: 1.2rem; font-weight: 800; color: var(--accent); letter-spacing: 1px;">CREATORS CORNER</div>
        </div>
        
        <nav class="nav-section">
            <div class="nav-label">Operations</div>
            <a class="nav-item" data-view="opscenter" href="#" onclick="switchView('opscenter'); return false;">
                <span class="icon"></span> Ops Center
            </a>
            <a class="nav-item" data-view="brands" href="#" onclick="switchView('brands'); return false;">
                <span class="icon"></span> Brands
            </a>
            
            <div class="nav-label">Creators</div>
            <a class="nav-item" data-view="roster" href="#" onclick="switchView('roster'); return false;">
                <span class="icon"></span> Roster
            </a>
            <a class="nav-item" data-view="applications" href="#" onclick="switchView('applications'); return false;">
                <span class="icon"></span> Applications
                <span class="badge-count" id="pendingAppsBadge" style="display: none;">0</span>
            </a>
            
            <div class="nav-label">Data</div>
            <a class="nav-item" data-view="creators" href="#" onclick="switchView('creators'); return false;">
                <span class="icon"></span> Creators
            </a>
            <a class="nav-item" data-view="videos" href="#" onclick="switchView('videos'); return false;">
                <span class="icon"></span> Videos
            </a>
            <a class="nav-item" data-view="products" href="#" onclick="switchView('products'); return false;">
                <span class="icon"></span> Products
            </a>
            
            <div class="nav-label">Finance</div>
            <a class="nav-item" data-view="payments" href="#" onclick="switchView('payments'); return false;">
                <span class="icon"></span> Payments
            </a>
            <a class="nav-item" data-view="commissions" href="#" onclick="switchView('commissions'); return false;">
                <span class="icon"></span> Commissions
            </a>
            <a class="nav-item" data-view="calculator" href="#" onclick="switchView('calculator'); return false;">
                <span class="icon"></span> Earnings
            </a>
            
            <div class="nav-label">Admin</div>
            <a class="nav-item" data-view="users" href="#" onclick="switchView('users'); return false;">
                <span class="icon"></span> Users
                <span class="badge-count" id="pendingUsersBadge" style="display: none;">0</span>
            </a>
            <a class="nav-item" data-view="settings" href="#" onclick="switchView('settings'); return false;">
                <span class="icon"></span> Settings
            </a>
            <a class="nav-item" data-view="portalconfig" href="#" onclick="switchView('portalconfig'); return false;">
                <span class="icon"></span> Portal Config
            </a>
        </nav>
        
        <div class="nav-bottom">
            <a href="upload.html" class="nav-item">
                <span class="icon"></span> Upload Data
            </a>
            
            <!-- Theme Toggle -->
            <div class="theme-toggle" onclick="toggleTheme()">
                <div class="theme-toggle-track">
                    <div class="theme-toggle-thumb" id="themeThumb"></div>
                </div>
                <span class="theme-toggle-label" id="themeLabel">Dark Mode</span>
            </div>
            
            <div id="lastUpdated" style="padding: 8px 16px; font-size: 0.7rem; color: var(--text-muted); text-align: center;">
                Last updated: --
            </div>
            
            <!-- User Profile -->
            <div style="border-top: 1px solid var(--border); padding: 12px 16px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div id="adminAvatar" style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent-dim); border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--accent); font-size: 0.85rem;">A</div>
                    <div style="flex: 1; min-width: 0;">
                        <div id="adminName" style="font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Admin</div>
                        <div id="adminRole" style="font-size: 0.7rem; color: var(--text-muted);">Administrator</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <a href="index.html" style="flex: 1; padding: 8px; text-align: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); text-decoration: none; font-size: 0.75rem;">Portal</a>
                    <button onclick="adminLogout()" style="flex: 1; padding: 8px; background: transparent; border: 1px solid #f87171; border-radius: 6px; color: #f87171; cursor: pointer; font-size: 0.75rem;">Logout</button>
                </div>
                <div style="margin-top: 12px; text-align: center; font-size: 0.65rem; color: var(--text-muted);">v262</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <!-- ==================== OPS CENTER ==================== -->
        <div id="view-opscenter" class="view-section">
            <!-- Loading Overlay -->
            <div id="opscenter-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading ops data...</div>
                <div class="loading-subtext">Analyzing creator health</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            
            <div class="header" style="flex-wrap: wrap; gap: 16px;">
                <div style="flex: 1; min-width: 200px;">
                    <h1 class="header-title"> Ops Center</h1>
                    <p class="header-subtitle" id="opsCenterDateRange">Daily operations hub</p>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="ops-tabs" style="display: flex; gap: 2px; margin-bottom: 24px; background: var(--bg-secondary); padding: 4px; border-radius: 12px; width: fit-content; border: 1px solid var(--border);">
                <button class="ops-tab active" data-tab="overview" onclick="switchOpsTab('overview')" style="padding: 10px 24px; border: none; background: var(--bg-card); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-primary); transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                     Overview
                </button>
                <button class="ops-tab" data-tab="videos" onclick="switchOpsTab('videos')" style="padding: 10px 24px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s;">
                     Videos
                </button>
                <button class="ops-tab" data-tab="posting" onclick="switchOpsTab('posting')" style="padding: 10px 24px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s;">
                     Posting
                </button>
                <button class="ops-tab" data-tab="creators" onclick="switchOpsTab('creators')" style="padding: 10px 24px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s;">
                     Creators
                </button>
                <button class="ops-tab" data-tab="decisions" onclick="switchOpsTab('decisions')" style="padding: 10px 24px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s;">
                     Decisions
                </button>
            </div>
            
            <!-- Overview Tab Content (embedded from view-overview) -->
            <div id="ops-tab-overview" class="ops-tab-content" style="display: block;">
                <!-- Content loaded dynamically from view-overview -->
            </div>
            
            <!-- ========== VIDEOS TAB ========== -->
            <div id="ops-tab-videos" class="ops-tab-content" style="display: none;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 1.4rem; font-weight: 700; margin: 0;"> Video Performance</h2>
                        <p id="videosTabContext" style="color: var(--text-muted); font-size: 0.85rem; margin: 4px 0 0 0;">Loading video data...</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="videosBrandFilter" onchange="onVideosBrandFilterChange()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); min-width: 140px;">
                            <option value="all">All Brands</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                        <select id="videosProductFilter" onchange="loadVideosTab()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); min-width: 140px;">
                            <option value="all">All Products</option>
                        </select>
                        <select id="videosStatusFilter" onchange="filterVideosDisplay()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); min-width: 130px;" data-tooltip="Filter by creator management status">
                            <option value="all">All Videos</option>
                            <option value="managed">Managed Only</option>
                            <option value="unmanaged">Unmanaged</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadVideosTab()"> Refresh</button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 24px;">
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer;" onclick="scrollToVideoSection('hot')">
                        <div class="stat-value" id="videosStatHot" style="font-size: 1.8rem; color: #f97316;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Hot Now <span class="help-icon" data-tooltip="Videos posted in last 7 days with $100+ GMV">?</span></div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer;" onclick="scrollToVideoSection('rising')">
                        <div class="stat-value" id="videosStatRising" style="font-size: 1.8rem; color: #22c55e;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Rising <span class="help-icon" data-tooltip="Videos from 7-14 days ago still hitting $50+ GMV">?</span></div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer;" onclick="scrollToVideoSection('top')">
                        <div class="stat-value" id="videosStatTop" style="font-size: 1.8rem; color: #f5c518;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Top 10 <span class="help-icon" data-tooltip="Highest GMV videos in selected date range">?</span></div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center;">
                        <div class="stat-value" id="videosStatTotal" style="font-size: 1.8rem; color: var(--accent);">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;">Total Videos <span class="help-icon" data-tooltip="Unique videos with sales in selected period">?</span></div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center;">
                        <div class="stat-value" id="videosStatGmv" style="font-size: 1.8rem; color: var(--success);">$0</div>
                        <div class="stat-label" style="font-size: 0.75rem;">Total GMV <span class="help-icon" data-tooltip="Gross Merchandise Value - total sales from all videos">?</span></div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center;">
                        <div class="stat-value" id="videosStatAvg" style="font-size: 1.8rem; color: var(--blue);">$0</div>
                        <div class="stat-label" style="font-size: 0.75rem;">Avg/Video <span class="help-icon" data-tooltip="Average GMV per video (Total GMV  Total Videos)">?</span></div>
                    </div>
                </div>
                
                <!--  HOT NOW Section -->
                <div class="video-section" id="videoSectionHot" style="margin-bottom: 24px;">
                    <div class="video-section-header" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, rgba(249,115,22,0.15), rgba(249,115,22,0.05)); border: 1px solid rgba(249,115,22,0.3); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;" onclick="toggleVideoSection('hot')"></span>
                        <div style="flex: 1;" onclick="toggleVideoSection('hot')">
                            <div style="font-weight: 700; font-size: 1.1rem; color: #f97316;">HOT NOW <span class="help-icon" data-tooltip="New videos crushing it! Posted within 7 days and already hit $100+ in sales" style="background: rgba(249,115,22,0.2); border-color: rgba(249,115,22,0.4);">?</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">New videos (last 7 days) crushing it with $100+ GMV</div>
                        </div>
                        <button onclick="event.stopPropagation(); copyDiscordMessage('hot')" class="btn btn-small" style="padding: 6px 12px; font-size: 0.75rem; background: rgba(249,115,22,0.2); border-color: rgba(249,115,22,0.4); color: #f97316;" title="Copy for Discord"> Discord</button>
                        <span class="video-section-count" id="hotCount" style="background: rgba(249,115,22,0.2); color: #f97316; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="video-section-toggle" id="hotToggle" style="font-size: 1.2rem; color: var(--text-muted);" onclick="toggleVideoSection('hot')"></span>
                    </div>
                    <div class="video-section-content" id="hotContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: var(--bg-card); display: none;">
                        <div id="hotVideosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">Loading hot videos...</div>
                        </div>
                        <div id="hotShowMore" style="display: none; text-align: center; margin-top: 16px;">
                            <button onclick="showMoreVideos('hot')" class="btn" style="background: rgba(249,115,22,0.1); border-color: rgba(249,115,22,0.3); color: #f97316;">Show All (<span id="hotTotalCount">0</span>)</button>
                        </div>
                    </div>
                </div>
                
                <!--  RISING Section -->
                <div class="video-section" id="videoSectionRising" style="margin-bottom: 24px;">
                    <div class="video-section-header" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;" onclick="toggleVideoSection('rising')"></span>
                        <div style="flex: 1;" onclick="toggleVideoSection('rising')">
                            <div style="font-weight: 700; font-size: 1.1rem; color: #22c55e;">RISING <span class="help-icon" data-tooltip="These aren't brand new but they're still selling! Videos from 7-14 days ago with sustained momentum" style="background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.4);">?</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Videos gaining momentum - showing strong recent performance</div>
                        </div>
                        <button onclick="event.stopPropagation(); copyDiscordMessage('rising')" class="btn btn-small" style="padding: 6px 12px; font-size: 0.75rem; background: rgba(34,197,94,0.2); border-color: rgba(34,197,94,0.4); color: #22c55e;" title="Copy for Discord"> Discord</button>
                        <span class="video-section-count" id="risingCount" style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="video-section-toggle" id="risingToggle" style="font-size: 1.2rem; color: var(--text-muted);" onclick="toggleVideoSection('rising')"></span>
                    </div>
                    <div class="video-section-content" id="risingContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: var(--bg-card); display: none;">
                        <div id="risingVideosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">Loading rising videos...</div>
                        </div>
                        <div id="risingShowMore" style="display: none; text-align: center; margin-top: 16px;">
                            <button onclick="showMoreVideos('rising')" class="btn" style="background: rgba(34,197,94,0.1); border-color: rgba(34,197,94,0.3); color: #22c55e;">Show All (<span id="risingTotalCount">0</span>)</button>
                        </div>
                    </div>
                </div>
                
                <!--  TOP PERFORMERS Section -->
                <div class="video-section" id="videoSectionTop" style="margin-bottom: 24px;">
                    <div class="video-section-header" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, rgba(245,197,24,0.15), rgba(245,197,24,0.05)); border: 1px solid rgba(245,197,24,0.3); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;" onclick="toggleVideoSection('top')"></span>
                        <div style="flex: 1;" onclick="toggleVideoSection('top')">
                            <div style="font-weight: 700; font-size: 1.1rem; color: #f5c518;">TOP PERFORMERS <span class="help-icon" data-tooltip="The money makers! Highest total GMV videos in your selected date range" style="background: rgba(245,197,24,0.2); border-color: rgba(245,197,24,0.4);">?</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Highest GMV videos in selected period</div>
                        </div>
                        <button onclick="event.stopPropagation(); copyDiscordMessage('top')" class="btn btn-small" style="padding: 6px 12px; font-size: 0.75rem; background: rgba(245,197,24,0.2); border-color: rgba(245,197,24,0.4); color: #f5c518;" title="Copy for Discord"> Discord</button>
                        <span class="video-section-count" id="topCount" style="background: rgba(245,197,24,0.2); color: #f5c518; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="video-section-toggle" id="topToggle" style="font-size: 1.2rem; color: var(--text-muted);" onclick="toggleVideoSection('top')"></span>
                    </div>
                    <div class="video-section-content" id="topContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: var(--bg-card); display: none;">
                        <div id="topVideosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">Loading top videos...</div>
                        </div>
                        <div id="topShowMore" style="display: none; text-align: center; margin-top: 16px;">
                            <button onclick="showMoreVideos('top')" class="btn" style="background: rgba(245,197,24,0.1); border-color: rgba(245,197,24,0.3); color: #f5c518;">Show All (<span id="topTotalCount">0</span>)</button>
                        </div>
                    </div>
                </div>
                
                <!--  CREATOR EFFICIENCY Section -->
                <div class="video-section" id="videoSectionEfficiency" style="margin-bottom: 24px;">
                    <div class="video-section-header" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;" onclick="toggleVideoSection('efficiency')"></span>
                        <div style="flex: 1;" onclick="toggleVideoSection('efficiency')">
                            <div style="font-weight: 700; font-size: 1.1rem; color: #8b5cf6;">CREATOR EFFICIENCY <span class="help-icon" data-tooltip="Quality over quantity! Shows GMV per video - who's making each video count. =$100+/vid, =$30-99/vid, =under $30/vid" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.4);">?</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Who's making the most of every video</div>
                        </div>
                        <button onclick="event.stopPropagation(); copyDiscordMessage('efficiency')" class="btn btn-small" style="padding: 6px 12px; font-size: 0.75rem; background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.4); color: #8b5cf6;" title="Copy for Discord"> Discord</button>
                        <span class="video-section-count" id="efficiencyCount" style="background: rgba(139,92,246,0.2); color: #8b5cf6; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="video-section-toggle" id="efficiencyToggle" style="font-size: 1.2rem; color: var(--text-muted);" onclick="toggleVideoSection('efficiency')"></span>
                    </div>
                    <div class="video-section-content" id="efficiencyContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: var(--bg-card); display: none;">
                        <div id="efficiencyGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">Loading efficiency data...</div>
                        </div>
                        <div id="efficiencyShowMore" style="display: none; text-align: center; margin-top: 16px;">
                            <button onclick="showMoreVideos('efficiency')" class="btn" style="background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.3); color: #8b5cf6;">Show All (<span id="efficiencyTotalCount">0</span>)</button>
                        </div>
                    </div>
                </div>
                
                <!--  ALL VIDEOS Table Section -->
                <div class="video-section" id="videoSectionAll">
                    <div class="video-section-header" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;" onclick="toggleVideoSection('all')"></span>
                        <div style="flex: 1;" onclick="toggleVideoSection('all')">
                            <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">ALL VIDEOS <span class="help-icon" data-tooltip="Complete searchable list of all videos with sales in selected period">?</span></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Complete list with search and export</div>
                        </div>
                        <input type="text" id="opsVideosSearchInput" placeholder="Search videos..." onclick="event.stopPropagation()" oninput="filterOpsVideosTable()" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); width: 180px; font-size: 0.85rem;">
                        <button onclick="event.stopPropagation(); exportVideosCSV()" class="btn btn-small" style="padding: 6px 12px; font-size: 0.75rem;" title="Export to CSV"> Export</button>
                        <span class="video-section-count" id="allCount" style="background: var(--bg-card); color: var(--text-secondary); padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="video-section-toggle" id="allToggle" style="font-size: 1.2rem; color: var(--text-muted);" onclick="toggleVideoSection('all')"></span>
                    </div>
                    <div class="video-section-content" id="allContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; background: var(--bg-card); display: none;">
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table>
                                <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Video</th>
                                        <th>Creator</th>
                                        <th>Brand</th>
                                        <th style="text-align: center;">Posted</th>
                                        <th style="text-align: right;">GMV</th>
                                        <th style="text-align: right;">Orders</th>
                                        <th style="text-align: center;">Status</th>
                                        <th style="text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allVideosTableBody">
                                    <tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading videos...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== POSTING TAB ========== -->
            <div id="ops-tab-posting" class="ops-tab-content" style="display: none;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 1.4rem; font-weight: 700; margin: 0;"> Posting Accountability</h2>
                        <p id="postingWeekContext" style="color: var(--text-muted); font-size: 0.85rem; margin: 4px 0 0 0;">Rolling 7-day posting activity</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="postingBrandFilter" onchange="onPostingBrandChange()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); font-size: 0.85rem;">
                            <option value="all">All Brands</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                        <select id="postingProductFilter" onchange="loadPostingData()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); font-size: 0.85rem;">
                            <option value="all">All Products</option>
                        </select>
                        <select id="postingTypeFilter" onchange="filterPostingData()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); font-size: 0.85rem;">
                            <option value="all">All Types</option>
                            <option value="retainer">Retainer Only</option>
                            <option value="affiliate">Affiliates</option>
                        </select>
                        <input type="text" id="postingSearchFilter" placeholder=" Search..." oninput="filterPostingData()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); width: 150px; font-size: 0.85rem;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted);">
                            <input type="checkbox" id="postingHideContacted" onchange="filterPostingData()" style="width: 16px; height: 16px; cursor: pointer;">
                            Hide Contacted
                        </label>
                        <button class="btn btn-primary" onclick="loadPostingData()" style="padding: 8px 16px;"> Refresh</button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 24px;">
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #6b7280;" onclick="togglePostingSection('ghosts')">
                        <div class="stat-value" id="postingGhostsCount" style="font-size: 1.8rem; color: #6b7280;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Ghosts</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">0 posts</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #ef4444;" onclick="togglePostingSection('behind')">
                        <div class="stat-value" id="postingBehindCount" style="font-size: 1.8rem; color: #ef4444;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Behind</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">1-2 posts</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #f59e0b;" onclick="togglePostingSection('atrisk')">
                        <div class="stat-value" id="postingAtRiskCount" style="font-size: 1.8rem; color: #f59e0b;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> At Risk</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">3-4 posts</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #22c55e;" onclick="togglePostingSection('ontrack')">
                        <div class="stat-value" id="postingOnTrackCount" style="font-size: 1.8rem; color: #22c55e;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> On Track</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">5-9 posts</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #8b5cf6;" onclick="togglePostingSection('stars')">
                        <div class="stat-value" id="postingStarsCount" style="font-size: 1.8rem; color: #8b5cf6;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Stars</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">10+ posts</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid var(--accent); background: linear-gradient(135deg, var(--bg-card) 0%, rgba(245, 197, 24, 0.08) 100%);">
                        <div class="stat-value" id="postingRetainerAtRisk" style="font-size: 1.6rem; color: var(--accent);">$0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> $ At Risk</div>
                        <div id="postingAtRiskRetainerCount" style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">0 creators</div>
                    </div>
                </div>

                <!-- Collapsible Sections -->
                <div id="postingContent">
                    <!--  GHOSTS Section -->
                    <div class="posting-section" id="postingSectionGhosts" style="margin-bottom: 20px;">
                        <div class="posting-section-header" onclick="togglePostingSection('ghosts')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(107,114,128,0.15), rgba(107,114,128,0.05)); border: 1px solid rgba(107,114,128,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #6b7280;">GHOSTS</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Zero posts in last 7 days - immediate outreach needed</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyPostingDiscord('ghosts')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="posting-section-count" id="postingGhostsBadge" style="background: rgba(107,114,128,0.2); color: #6b7280; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="posting-section-toggle" id="postingGhostsToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="posting-section-content" id="postingGhostsContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="postingGhostsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!--  BEHIND Section -->
                    <div class="posting-section" id="postingSectionBehind" style="margin-bottom: 20px;">
                        <div class="posting-section-header" onclick="togglePostingSection('behind')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05)); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #ef4444;">BEHIND</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">1-2 posts in last 7 days - not meeting minimum</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyPostingDiscord('behind')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="posting-section-count" id="postingBehindBadge" style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="posting-section-toggle" id="postingBehindToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="posting-section-content" id="postingBehindContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="postingBehindGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!--  AT RISK Section -->
                    <div class="posting-section" id="postingSectionAtrisk" style="margin-bottom: 20px;">
                        <div class="posting-section-header" onclick="togglePostingSection('atrisk')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05)); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #f59e0b;">AT RISK</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">3-4 posts in last 7 days - close but not quite</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyPostingDiscord('atrisk')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="posting-section-count" id="postingAtriskBadge" style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="posting-section-toggle" id="postingAtriskToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="posting-section-content" id="postingAtriskContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="postingAtriskGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!--  ON TRACK Section -->
                    <div class="posting-section" id="postingSectionOntrack" style="margin-bottom: 20px;">
                        <div class="posting-section-header" onclick="togglePostingSection('ontrack')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #22c55e;">ON TRACK</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">5-9 posts in last 7 days - meeting target</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyPostingDiscord('ontrack')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="posting-section-count" id="postingOntrackBadge" style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="posting-section-toggle" id="postingOntrackToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="posting-section-content" id="postingOntrackContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="postingOntrackGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!--  STARS Section -->
                    <div class="posting-section" id="postingSectionStars" style="margin-bottom: 20px;">
                        <div class="posting-section-header" onclick="togglePostingSection('stars')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #8b5cf6;">STARS</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">10+ posts in last 7 days - crushing it!</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyPostingDiscord('stars')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="posting-section-count" id="postingStarsBadge" style="background: rgba(139,92,246,0.2); color: #8b5cf6; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="posting-section-toggle" id="postingStarsToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="posting-section-content" id="postingStarsContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="postingStarsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== CREATORS TAB ========== -->
            <div id="ops-tab-creators" class="ops-tab-content" style="display: none;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 1.4rem; font-weight: 700; margin: 0;"> Creator Management</h2>
                        <p id="creatorsTabContext" style="color: var(--text-muted); font-size: 0.85rem; margin: 4px 0 0 0;">Loading creator data...</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <select id="creatorsBrandFilter" onchange="onCreatorsBrandFilterChange()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); min-width: 140px;">
                            <option value="all">All Brands</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                        <select id="creatorsProductFilter" onchange="loadCreatorsTab()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); min-width: 140px;">
                            <option value="all">All Products</option>
                        </select>
                        <select id="creatorsStatusFilter" onchange="loadCreatorsTab()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); min-width: 130px;">
                            <option value="active">Active Only</option>
                            <option value="all">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Churned">Churned</option>
                        </select>
                        <button class="btn" onclick="exportCreatorsCSV()" title="Export to CSV"> Export</button>
                        <button class="btn btn-primary" onclick="loadCreatorsTab()"> Refresh</button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer;" onclick="toggleCreatorSection('creatorsAttention')">
                        <div class="stat-value" id="creatorsStatAttention" style="font-size: 1.8rem; color: #ef4444;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Needs Attention</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer;" onclick="toggleCreatorSection('creatorsTop')">
                        <div class="stat-value" id="creatorsStatTop" style="font-size: 1.8rem; color: #22c55e;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Top Performers</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center;">
                        <div class="stat-value" id="creatorsStatTotal" style="font-size: 1.8rem; color: var(--accent);">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Total</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center;">
                        <div class="stat-value" id="creatorsStatRetainer" style="font-size: 1.8rem; color: var(--blue);">$0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Retainer</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center;">
                        <div class="stat-value" id="creatorsStatGmv" style="font-size: 1.8rem; color: var(--success);">$0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> GMV</div>
                    </div>
                </div>
                
                <!--  NEEDS ATTENTION Section -->
                <div class="creator-section" id="creatorSectionAttention" style="margin-bottom: 24px;">
                    <div class="creator-section-header" onclick="toggleCreatorSection('creatorsAttention')" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05)); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1rem; color: #ef4444;">NEEDS ATTENTION</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Retainer creators with low or no ROI - time to follow up</div>
                        </div>
                        <span class="creator-section-count" id="creatorsAttentionCount" style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="creator-section-toggle" id="creatorsAttentionToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                    </div>
                    <div class="creator-section-content" id="creatorsAttentionContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: var(--bg-card); display: none;">
                        <div id="creatorsAttentionGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!--  TOP PERFORMERS Section -->
                <div class="creator-section" id="creatorSectionTop" style="margin-bottom: 24px;">
                    <div class="creator-section-header" onclick="toggleCreatorSection('creatorsTop')" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1rem; color: #22c55e;">TOP PERFORMERS</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Highest GMV generators in selected period</div>
                        </div>
                        <span class="creator-section-count" id="creatorsTopCount" style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="creator-section-toggle" id="creatorsTopToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                    </div>
                    <div class="creator-section-content" id="creatorsTopContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: var(--bg-card); display: none;">
                        <div id="creatorsTopGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">Loading top performers...</div>
                        </div>
                    </div>
                </div>
                
                <!--  ROI LEADERS Section -->
                <div class="creator-section" id="creatorSectionRoi" style="margin-bottom: 24px;">
                    <div class="creator-section-header" onclick="toggleCreatorSection('creatorsRoi')" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1rem; color: #8b5cf6;">ROI LEADERS</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Best return on retainer investment</div>
                        </div>
                        <span class="creator-section-count" id="creatorsRoiCount" style="background: rgba(139,92,246,0.2); color: #8b5cf6; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="creator-section-toggle" id="creatorsRoiToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                    </div>
                    <div class="creator-section-content" id="creatorsRoiContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; background: var(--bg-card); display: none;">
                        <div id="creatorsRoiGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">Loading ROI data...</div>
                        </div>
                    </div>
                </div>
                
                <!--  ALL CREATORS Table Section -->
                <div class="creator-section" id="creatorSectionAll">
                    <div class="creator-section-header" onclick="toggleCreatorSection('creatorsAll')" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; cursor: pointer;">
                        <span style="font-size: 1.5rem;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">ALL CREATORS</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Complete list with all details</div>
                        </div>
                        <input type="text" id="creatorsSearchFilter" placeholder="Search creators..." onclick="event.stopPropagation()" oninput="filterCreatorsTable()" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); width: 180px; font-size: 0.85rem;">
                        <span class="creator-section-count" id="creatorsAllCount" style="background: var(--bg-card); color: var(--text-secondary); padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;">0</span>
                        <span class="creator-section-toggle" id="creatorsAllToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                    </div>
                    <div class="creator-section-content" id="creatorsAllContent" style="border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; background: var(--bg-card); display: none;">
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table>
                                <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                    <tr>
                                        <th>Creator</th>
                                        <th style="text-align: center;">Status</th>
                                        <th style="text-align: center;">Type</th>
                                        <th>TikTok Accounts</th>
                                        <th>Brand</th>
                                        <th style="text-align: center;">Retainer</th>
                                        <th style="text-align: right;">GMV</th>
                                        <th style="text-align: center;">ROI</th>
                                        <th style="text-align: center;">Videos</th>
                                        <th style="text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="creatorsTableBody">
                                    <tr><td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== DECISIONS TAB ========== -->
            <div id="ops-tab-decisions" class="ops-tab-content" style="display: none;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 style="font-size: 1.4rem; font-weight: 700; margin: 0;"> Monthly Decisions</h2>
                        <p id="decisionsDateRange" style="color: var(--text-muted); font-size: 0.85rem; margin: 4px 0 0 0;">Rolling 30-day ROI analysis</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="decisionsBrandFilter" onchange="onDecisionsBrandFilterChange()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); font-size: 0.85rem;">
                            <option value="all">All Brands</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                        <select id="decisionsProductFilter" onchange="loadDecisions()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); font-size: 0.85rem;">
                            <option value="all">All Products</option>
                        </select>
                        <select id="decisionsTypeFilter" onchange="filterDecisions()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); font-size: 0.85rem;">
                            <option value="retainer">Retainer Only</option>
                            <option value="all">All Types</option>
                        </select>
                        <input type="text" id="decisionsSearchFilter" placeholder=" Search..." oninput="filterDecisions()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); width: 150px; font-size: 0.85rem;">
                        <button class="btn btn-primary" onclick="loadDecisions()" style="padding: 8px 16px;"> Refresh</button>
                    </div>
                </div>
                
                <!-- ROI Criteria Legend -->
                <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 20px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 1.1rem;"></span>
                        <span style="font-weight: 600; color: #8b5cf6;">STAR</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">10x ROI</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 1.1rem;"></span>
                        <span style="font-weight: 600; color: #22c55e;">KEEP</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">3x ROI</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 1.1rem;"></span>
                        <span style="font-weight: 600; color: #f59e0b;">WATCH</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">1-3x ROI</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 1.1rem;"></span>
                        <span style="font-weight: 600; color: #ef4444;">CUT</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">&lt;1x ROI</span>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #ef4444;" onclick="toggleDecisionSection('cut')">
                        <div class="stat-value" id="decisionsCutCount" style="font-size: 1.8rem; color: #ef4444;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Cut</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">&lt;1x ROI</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #f59e0b;" onclick="toggleDecisionSection('watch')">
                        <div class="stat-value" id="decisionsWatchCount" style="font-size: 1.8rem; color: #f59e0b;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Watch</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">1-3x ROI</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; cursor: pointer; border-left: 4px solid #22c55e;" onclick="toggleDecisionSection('keep')">
                        <div class="stat-value" id="decisionsKeepCount" style="font-size: 1.8rem; color: #22c55e;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Keep</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">3x ROI</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid #8b5cf6;">
                        <div class="stat-value" id="decisionsStarsCount" style="font-size: 1.8rem; color: #8b5cf6;">0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> Stars</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">10x ROI</div>
                    </div>
                    <div class="stat-card" style="padding: 16px; text-align: center; border-left: 4px solid var(--accent); background: linear-gradient(135deg, var(--bg-card) 0%, rgba(245, 197, 24, 0.08) 100%);">
                        <div class="stat-value" id="decisionsAtRisk" style="font-size: 1.6rem; color: var(--accent);">$0</div>
                        <div class="stat-label" style="font-size: 0.75rem;"> $ At Risk</div>
                        <div id="decisionsAtRiskCreators" style="font-size: 0.65rem; color: var(--text-muted); margin-top: 2px;">0 creators</div>
                    </div>
                </div>

                <!-- Collapsible Sections -->
                <div id="decisionsContent">
                    <!--  CUT Section -->
                    <div class="decision-section" id="decisionSectionCut" style="margin-bottom: 20px;">
                        <div class="decision-section-header" onclick="toggleDecisionSection('cut')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05)); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #ef4444;">CUT - Recommend Ending</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Below 1x ROI - losing money on these creators</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyDecisionDiscord('cut')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="decision-section-count" id="decisionsCutBadge" style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="decision-section-toggle" id="decisionsCutToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="decision-section-content" id="decisionsCutContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="decisionsCutGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!--  WATCH Section -->
                    <div class="decision-section" id="decisionSectionWatch" style="margin-bottom: 20px;">
                        <div class="decision-section-header" onclick="toggleDecisionSection('watch')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05)); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #f59e0b;">WATCH - Monitor Closely</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">1-3x ROI - breaking even, could go either way</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyDecisionDiscord('watch')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="decision-section-count" id="decisionsWatchBadge" style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="decision-section-toggle" id="decisionsWatchToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="decision-section-content" id="decisionsWatchContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="decisionsWatchGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!--  KEEP Section -->
                    <div class="decision-section" id="decisionSectionKeep" style="margin-bottom: 20px;">
                        <div class="decision-section-header" onclick="toggleDecisionSection('keep')" style="display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; cursor: pointer;">
                            <span style="font-size: 1.4rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: #22c55e;">KEEP - Solid Performers</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">3x+ ROI - good return on investment ( = 10x+ stars)</div>
                            </div>
                            <button onclick="event.stopPropagation(); copyDecisionDiscord('keep')" class="btn btn-small" style="padding: 5px 10px; font-size: 0.7rem;"> Discord</button>
                            <span class="decision-section-count" id="decisionsKeepBadge" style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">0</span>
                            <span class="decision-section-toggle" id="decisionsKeepToggle" style="font-size: 1.2rem; color: var(--text-muted);"></span>
                        </div>
                        <div class="decision-section-content" id="decisionsKeepContent" style="display: none; border: 1px solid var(--border); border-top: none; border-radius: 0 0 12px 12px; padding: 16px; background: var(--bg-card);">
                            <div id="decisionsKeepGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                                <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="view-overview" class="view-section active">
            <!-- Loading Overlay -->
            <div id="overview-loading" class="loading-overlay">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading dashboard...</div>
                <div class="loading-subtext">Fetching performance data</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            
            <!-- Quick Links Bar -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; justify-content: flex-end;">
                <a href="https://affiliate.tiktokglobalshop.com/" target="_blank" class="btn btn-sm" style="padding: 6px 10px; font-size: 0.75rem; text-decoration: none;"> TTS</a>
                <a href="https://www.fastmoss.com/dashboard" target="_blank" class="btn btn-sm" style="padding: 6px 10px; font-size: 0.75rem; text-decoration: none;"> FastMoss</a>
                <a href="https://www.thedailyvirals.com/" target="_blank" class="btn btn-sm" style="padding: 6px 10px; font-size: 0.75rem; text-decoration: none;"> Virals</a>
                <a href="https://ads.tiktok.com/business/creativecenter/pc/en" target="_blank" class="btn btn-sm" style="padding: 6px 10px; font-size: 0.75rem; text-decoration: none;"> Creative Center</a>
            </div>
            
            <!-- Filters Row -->
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px;">
                <p id="dateRange" style="color: var(--text-muted); font-size: 0.85rem; margin-right: auto;">Loading...</p>
                <!-- Brand Filter -->
                <select id="brandFilter" onchange="loadOverviewData()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); min-width: 140px;">
                    <option value="all">All Brands</option>
                    <option value="catakor">Cata-Kor</option>
                    <option value="jiyu">JiYu</option>
                    <option value="physicians_choice">Physicians Choice</option>
                    <option value="peach_slices">Peach Slices</option>
                    <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                </select>
                <!-- Date Picker -->
                <select id="datePresetSelect" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); min-width: 130px;">
                    <option value="yesterday">Yesterday</option>
                    <option value="last7" selected>Last 7 Days</option>
                    <option value="last14">Last 14 Days</option>
                    <option value="last30">Last 30 Days</option>
                    <option value="thisMonth">This Month</option>
                    <option value="lastMonth">Last Month</option>
                    <option value="custom">Custom Range</option>
                </select>
                <input type="text" class="date-range-input" id="overviewDateRange" placeholder="Select dates" readonly style="width: 200px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                <input type="hidden" id="dateFilterStart">
                <input type="hidden" id="dateFilterEnd">
                <input type="hidden" id="statusFilter" value="all">
            </div>
            
            <!-- ===== QUICK STATS ROW ===== -->
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;" id="overviewQuickStats">
                <div style="background: linear-gradient(135deg, var(--bg-card), rgba(245, 197, 24, 0.08)); border: 1px solid rgba(245, 197, 24, 0.3); border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Period GMV</div>
                    <div id="statGmv" style="font-size: 1.6rem; font-weight: 800; color: var(--accent);">$0</div>
                    <div id="statGmvChange" style="font-size: 0.75rem; color: var(--text-muted);">--</div>
                </div>
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Orders</div>
                    <div id="statOrders" style="font-size: 1.6rem; font-weight: 800; color: var(--text-primary);">0</div>
                    <div id="statOrdersChange" style="font-size: 0.75rem; color: var(--text-muted);">--</div>
                </div>
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Active Creators</div>
                    <div id="statCreators" style="font-size: 1.6rem; font-weight: 800; color: var(--text-primary);">0</div>
                    <div id="statCreatorsChange" style="font-size: 0.75rem; color: var(--text-muted);">--</div>
                </div>
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Videos</div>
                    <div id="statVideos" style="font-size: 1.6rem; font-weight: 800; color: var(--text-primary);">0</div>
                    <div id="statVideosChange" style="font-size: 0.75rem; color: var(--text-muted);">--</div>
                </div>
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">GMV/Video</div>
                    <div id="statGmvPerVideo" style="font-size: 1.6rem; font-weight: 800; color: var(--text-primary);">$0</div>
                    <div id="statGmvPerVideoChange" style="font-size: 0.75rem; color: var(--text-muted);">--</div>
                </div>
            </div>
            
            <!-- ===== MANAGED VS UNMANAGED ===== -->
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 1rem; font-weight: 700; margin: 0;"> Managed vs Unmanaged</h3>
                    <span id="managedPctLabel" style="font-size: 0.85rem; color: var(--success); font-weight: 600;">--% managed</span>
                </div>
                <!-- Progress Bar -->
                <div style="background: var(--bg-secondary); border-radius: 8px; height: 16px; overflow: hidden; display: flex; margin-bottom: 16px;">
                    <div id="managedGmvBar" style="background: linear-gradient(90deg, #22c55e, #34d399); height: 100%; transition: width 0.5s ease;" title="Managed GMV"></div>
                    <div id="unmanagedGmvBar" style="background: var(--border-light); height: 100%; transition: width 0.5s ease;" title="Unmanaged GMV"></div>
                </div>
                <!-- Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <!-- Managed -->
                    <div style="background: rgba(34, 197, 94, 0.08); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 10px; padding: 14px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 1rem;"></span>
                            <span style="font-weight: 600; color: #22c55e;">Managed</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div id="managedGmv" style="font-size: 1.2rem; font-weight: 700; color: #22c55e;">$0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">GMV</div>
                            </div>
                            <div>
                                <div id="managedCount" style="font-size: 1.2rem; font-weight: 700;">0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">Creators</div>
                            </div>
                            <div>
                                <div id="managedAvg" style="font-size: 1.2rem; font-weight: 700;">$0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">Avg/Creator</div>
                            </div>
                        </div>
                    </div>
                    <!-- Unmanaged -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 14px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 1rem;"></span>
                            <span style="font-weight: 600; color: var(--text-secondary);">Unmanaged</span>
                            <a href="#" onclick="switchView('creators'); return false;" style="margin-left: auto; font-size: 0.65rem; color: var(--accent);">View </a>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div id="unmanagedGmv" style="font-size: 1.2rem; font-weight: 700; color: var(--text-secondary);">$0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">GMV</div>
                            </div>
                            <div>
                                <div id="unmanagedCount" style="font-size: 1.2rem; font-weight: 700;">0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">Creators</div>
                            </div>
                            <div>
                                <div id="unmanagedAvg" style="font-size: 1.2rem; font-weight: 700;">$0</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">Avg/Creator</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ===== AGENCY HEALTH ===== -->
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 1rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 8px;">
                         Agency Health
                        <span style="font-size: 0.75rem; font-weight: 400; color: var(--text-muted);">(Rolling 30 Days)</span>
                    </h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Monthly Retainer Spend</div>
                        <div id="agencyRetainerSpend" style="font-size: 1.4rem; font-weight: 700; color: #f59e0b;">$0</div>
                        <div id="agencyRetainerCount" style="font-size: 0.75rem; color: var(--text-muted);">0 creators</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Managed GMV (30d)</div>
                        <div id="agencyManagedGmv" style="font-size: 1.4rem; font-weight: 700; color: #22c55e;">$0</div>
                        <div id="agencyManagedPct" style="font-size: 0.75rem; color: var(--text-muted);">0% of total</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Portfolio ROI</div>
                        <div id="agencyRoi" style="font-size: 1.4rem; font-weight: 700; color: var(--text-primary);">0x</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">GMV  Retainer</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Est. Commission (2.5%)</div>
                        <div id="agencyCommission" style="font-size: 1.4rem; font-weight: 700; color: #8b5cf6;">$0</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">from managed GMV</div>
                    </div>
                </div>
                <!-- ROI Health Bar -->
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Portfolio ROI Distribution</span>
                        <span id="agencyRoiSummary" style="font-size: 0.75rem; color: var(--text-muted);">-- creators</span>
                    </div>
                    <div style="display: flex; height: 24px; border-radius: 8px; overflow: hidden; background: var(--bg-secondary);">
                        <div id="roiBarCut" style="background: #ef4444; height: 100%; transition: width 0.3s;" title="Cut (<1x ROI)"></div>
                        <div id="roiBarWatch" style="background: #f59e0b; height: 100%; transition: width 0.3s;" title="Watch (1-3x ROI)"></div>
                        <div id="roiBarKeep" style="background: #22c55e; height: 100%; transition: width 0.3s;" title="Keep (3x+ ROI)"></div>
                        <div id="roiBarStar" style="background: #8b5cf6; height: 100%; transition: width 0.3s;" title="Stars (10x+ ROI)"></div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 0.7rem;">
                        <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #ef4444; border-radius: 2px;"></span> Cut <span id="roiCountCut" style="color: var(--text-muted);">(0)</span></span>
                        <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #f59e0b; border-radius: 2px;"></span> Watch <span id="roiCountWatch" style="color: var(--text-muted);">(0)</span></span>
                        <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #22c55e; border-radius: 2px;"></span> Keep <span id="roiCountKeep" style="color: var(--text-muted);">(0)</span></span>
                        <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #8b5cf6; border-radius: 2px;"></span> Stars <span id="roiCountStar" style="color: var(--text-muted);">(0)</span></span>
                    </div>
                </div>
            </div>
            
            <!-- ===== CHARTS ROW ===== -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;">
                <!-- GMV Trend Chart -->
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 1rem; font-weight: 700; margin: 0;"> GMV Trend</h3>
                    </div>
                    <div style="position: relative; height: 200px;">
                        <canvas id="gmvTrendChart"></canvas>
                    </div>
                </div>
                <!-- GMV by Brand Donut -->
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 1rem; font-weight: 700; margin: 0;"> GMV by Brand</h3>
                    </div>
                    <div style="position: relative; height: 200px;">
                        <canvas id="brandDonutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== BRANDS ==================== -->
        <div id="view-brands" class="view-section">
            <!-- Loading Overlay -->
            <div id="brands-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading brand data...</div>
                <div class="loading-subtext">Aggregating performance metrics</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header">
                <div>
                    <h1 class="header-title">Brand Performance</h1>
                    <p class="header-subtitle">Compare brands and deep dive into individual performance</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary no-print" onclick="exportToPDF('view-brands', 'Brand Performance Report')"> Export PDF</button>
                    <button class="btn btn-primary no-print" onclick="openClientReportModal()"> Generate Client Report</button>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Date Range</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="brandsDatePresetSelect" class="filter-select" style="min-width: 130px;">
                            <option value="yesterday">Yesterday</option>
                            <option value="last7" selected>Last 7 Days</option>
                            <option value="last14">Last 14 Days</option>
                            <option value="last30">Last 30 Days</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <input type="text" class="date-range-input" id="brandsDateRange" placeholder="Select dates" readonly style="width: 220px;">
                    </div>
                    <input type="hidden" id="brandsDateFilterStart">
                    <input type="hidden" id="brandsDateFilterEnd">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Status</span>
                    <select id="brandsStatusFilter" onchange="loadBrandsData()">
                        <option value="all">All Creators</option>
                        <option value="managed">Managed Only</option>
                        <option value="unmanaged">Unmanaged Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Product</span>
                    <select id="brandsProductFilter" onchange="loadBrandsData()">
                        <option value="all">All Products</option>
                    </select>
                </div>
            </div>

            <!-- Brand Comparison Cards -->
            <div class="section-title" style="margin-bottom: 16px;">
                <h2 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0;"> Brand Comparison</h2>
            </div>
            <div class="brand-comparison-grid" id="brandComparisonCards"></div>

            <!-- Performance Trend Chart -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="card-title"><span></span> Performance Trend</div>
                        <select id="trendKpiSelect" onchange="loadBrandTrendChart(currentTrendPeriod)" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;">
                            <option value="gmv"> GMV</option>
                            <option value="orders"> Orders</option>
                            <option value="videos"> Videos</option>
                            <option value="creators"> Active Creators</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm active" id="trendPeriod7d" onclick="loadBrandTrendChart('7d')">7 Days</button>
                        <button class="btn btn-sm" id="trendPeriod4w" onclick="loadBrandTrendChart('4w')">4 Weeks</button>
                        <button class="btn btn-sm" id="trendPeriod8w" onclick="loadBrandTrendChart('8w')">8 Weeks</button>
                        <button class="btn btn-sm" id="trendPeriod3m" onclick="loadBrandTrendChart('3m')">3 Months</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="brandTrendChart" style="width: 100%; height: 300px;"></canvas>
                </div>
                <div id="brandTrendLegend" style="display: flex; justify-content: center; gap: 24px; padding: 12px; flex-wrap: wrap;"></div>
            </div>

            <!-- Period Comparison Table -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title"><span></span> Period Comparison</div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Brand</th>
                                    <th style="text-align: right;">This Period</th>
                                    <th style="text-align: right;">Prior Period</th>
                                    <th style="text-align: right;">Change</th>
                                    <th style="text-align: right;">Orders</th>
                                    <th style="text-align: right;">Creators</th>
                                </tr>
                            </thead>
                            <tbody id="brandWowBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Brand Deep Dive -->
            <div class="section-title" style="margin: 32px 0 16px 0; display: flex; align-items: center; gap: 16px;">
                <h2 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0;"> Brand Deep Dive</h2>
                <select id="brandDeepDiveSelect" class="filter-select" style="min-width: 160px;" onchange="loadBrandDeepDive()">
                    <option value="catakor">Cata-Kor</option>
                    <option value="jiyu">JiYu</option>
                    <option value="physicians_choice">Physicians Choice</option>
                    <option value="peach_slices">Peach Slices</option>
                    <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                </select>
            </div>

            <!-- Deep Dive Stats -->
            <div class="stats-grid" id="brandDeepDiveStats">
                <div class="stat-card highlight">
                    <div class="stat-header"><div class="stat-icon yellow"></div></div>
                    <div class="stat-value" id="ddGmv">$0</div>
                    <div class="stat-label">Total GMV</div>
                    <div class="stat-change neutral" id="ddGmvChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon green"></div></div>
                    <div class="stat-value" id="ddOrders">0</div>
                    <div class="stat-label">Orders</div>
                    <div class="stat-change neutral" id="ddOrdersChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon purple"></div></div>
                    <div class="stat-value" id="ddCreators">0</div>
                    <div class="stat-label">Active Creators</div>
                    <div class="stat-change neutral" id="ddCreatorsChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon blue"></div></div>
                    <div class="stat-value" id="ddVideos">0</div>
                    <div class="stat-label">Videos</div>
                    <div class="stat-change neutral" id="ddVideosChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon teal"></div></div>
                    <div class="stat-value" id="ddAov">$0</div>
                    <div class="stat-label">Avg Order Value</div>
                    <div class="stat-change neutral" id="ddAovChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon orange"></div></div>
                    <div class="stat-value" id="ddCommission">$0</div>
                    <div class="stat-label">Est. Commission</div>
                    <div class="stat-change neutral" id="ddCommissionChange">--</div>
                </div>
            </div>

            <!-- Deep Dive Charts & Tables -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title"><span></span> Managed vs Unmanaged</div>
                </div>
                <div class="card-body">
                    <div id="brandManagedBreakdown" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div style="text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-size: 0.85rem; color: var(--success); margin-bottom: 8px;"> Managed</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent);" id="ddManagedGmv">$0</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);" id="ddManagedCount">0 creators</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;" id="ddManagedAvg">$0 avg</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;"> Unmanaged</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-secondary);" id="ddUnmanagedGmv">$0</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);" id="ddUnmanagedCount">0 creators</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;" id="ddUnmanagedAvg">$0 avg</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Breakdown -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title"><span></span> Product Breakdown</div>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">Click a product to see creator breakdown</span>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th style="text-align: right;">GMV</th>
                                    <th style="text-align: right;">% of Total</th>
                                    <th style="text-align: right;">Orders</th>
                                    <th style="text-align: right;">Videos</th>
                                    <th style="text-align: center;">Trend</th>
                                </tr>
                            </thead>
                            <tbody id="brandProductsBody">
                                <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading products...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Creator x Product Drill-down (hidden by default) -->
            <div class="card" style="margin-top: 24px; display: none;" id="productCreatorDrilldown">
                <div class="card-header">
                    <div class="card-title"><span></span> <span id="drilldownProductName">Product</span> - Creator Breakdown</div>
                    <button class="btn btn-sm" onclick="closeProductDrilldown()"> Close</button>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Creator</th>
                                    <th>Status</th>
                                    <th style="text-align: right;">GMV</th>
                                    <th style="text-align: right;">Orders</th>
                                    <th style="text-align: right;">Videos</th>
                                </tr>
                            </thead>
                            <tbody id="productCreatorsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Top Creators for Brand -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title"><span></span> Top 10 Creators</div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">Rank</th>
                                    <th>Creator</th>
                                    <th>Status</th>
                                    <th>GMV</th>
                                    <th>Orders</th>
                                    <th>Videos</th>
                                    <th>AOV</th>
                                    <th>Commission</th>
                                </tr>
                            </thead>
                            <tbody id="brandTopCreatorsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== CREATORS ==================== -->
        <div id="view-creators" class="view-section">
            <!-- Loading Overlay -->
            <div id="creators-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading creators...</div>
                <div class="loading-subtext">Building creator profiles</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header">
                <div>
                    <h1 class="header-title">Creators</h1>
                    <p class="header-subtitle">The lifeblood of your business - track, analyze, and grow your creator network</p>
                </div>
                <div class="header-actions">
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" onclick="toggleCreatorsView('table')"> Table</button>
                        <button class="view-toggle-btn" onclick="toggleCreatorsView('leaderboard')"> Leaderboard</button>
                    </div>
                    <button class="btn btn-secondary" onclick="exportCreators()"> Export CSV</button>
                </div>
            </div>

            <!-- Leaderboard View -->
            <div id="creatorsLeaderboard" class="leaderboard-container">
                <div class="leaderboard-filters">
                    <button class="leaderboard-period-btn active" onclick="loadLeaderboard('week')">This Week</button>
                    <button class="leaderboard-period-btn" onclick="loadLeaderboard('month')">This Month</button>
                    <button class="leaderboard-period-btn" onclick="loadLeaderboard('quarter')">This Quarter</button>
                    <button class="leaderboard-period-btn" onclick="loadLeaderboard('alltime')">All Time</button>
                    <select id="leaderboardBrandFilter" class="filter-select" onchange="loadLeaderboard()" style="margin-left: auto;">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <button class="btn" onclick="downloadPodiumImage()" style="margin-left: 8px;" title="Download as PNG">
                         PNG
                    </button>
                    <button class="btn btn-primary" onclick="downloadPodiumGif()" title="Download animated GIF for Discord">
                         Animated GIF
                    </button>
                </div>
                
                <!-- Podium Card for Download -->
                <div id="podiumDownloadCard" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);"> TOP CREATORS </div>
                        <div id="podiumPeriodLabel" style="font-size: 0.9rem; color: #8b9dc3; margin-top: 4px;">This Week</div>
                    </div>
                    
                    <!-- Podium for Top 3 -->
                    <div class="leaderboard-podium" id="leaderboardPodium">
                        <div class="podium-place second">
                            <div class="podium-avatar"><div class="podium-rank">2</div></div>
                            <div class="podium-name">Loading...</div>
                            <div class="podium-gmv">--</div>
                            <div class="podium-brand">--</div>
                            <div class="podium-base"></div>
                        </div>
                        <div class="podium-place first">
                            <div class="podium-avatar"><div class="podium-rank">1</div></div>
                            <div class="podium-name">Loading...</div>
                            <div class="podium-gmv">--</div>
                            <div class="podium-brand">--</div>
                            <div class="podium-base"></div>
                        </div>
                        <div class="podium-place third">
                            <div class="podium-avatar"><div class="podium-rank">3</div></div>
                            <div class="podium-name">Loading...</div>
                            <div class="podium-gmv">--</div>
                            <div class="podium-brand">--</div>
                            <div class="podium-base"></div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 0.75rem; color: #5c6f94;">Creators Corner  Keep crushing it! </div>
                    </div>
                </div>
                
                <!-- Rest of Leaderboard -->
                <div class="leaderboard-list" id="leaderboardList">
                    <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                        Loading leaderboard...
                    </div>
                </div>
            </div>

            <!-- Table View (existing) -->
            <div id="creatorsTable" class="table-container active">
            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Brand</span>
                    <select id="creatorsBrandFilter" onchange="pages.creators = 1; loadCreatorsData();">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Date Range</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="creatorsDatePresetSelect" class="filter-select" style="min-width: 130px;">
                            <option value="yesterday">Yesterday</option>
                            <option value="last7" selected>Last 7 Days</option>
                            <option value="last14">Last 14 Days</option>
                            <option value="last30">Last 30 Days</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <input type="text" class="date-range-input" id="creatorsDateRange" placeholder="Select dates" readonly style="width: 220px;">
                    </div>
                    <input type="hidden" id="creatorsDateFilterStart">
                    <input type="hidden" id="creatorsDateFilterEnd">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Status</span>
                    <select id="creatorsStatusFilter" onchange="pages.creators = 1; loadCreatorsData();">
                        <option value="all">All Creators</option>
                        <option value="managed">Managed Only</option>
                        <option value="unmanaged">Unmanaged Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Tier</span>
                    <select id="creatorsTierFilter" onchange="pages.creators = 1; loadCreatorsData();">
                        <option value="all">All Tiers</option>
                        <option value="ruby">Ruby ($200K+)</option>
                        <option value="diamond">Diamond ($100K+)</option>
                        <option value="platinum">Platinum ($50K+)</option>
                        <option value="gold">Gold ($20K+)</option>
                        <option value="silver">Silver ($5K+)</option>
                        <option value="bronze">Bronze ($2K+)</option>
                        <option value="new">New (< $2K)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Search</span>
                    <input type="text" class="search-input" placeholder="Search creators..." id="creatorsSearchInput" style="min-width: 150px;">
                </div>
            </div>

            <!-- Data Validation Status Banner -->
            <div id="creatorsValidationBanner" class="validation-banner" style="display: none; margin-bottom: 16px; padding: 12px 16px; border-radius: 8px; align-items: center; gap: 12px; font-size: 0.85rem;">
                <span id="creatorsValidationIcon"></span>
                <span id="creatorsValidationText">Data validated</span>
                <a href="#" onclick="switchView('datastatus'); switchDataStatusTab('validation'); return false;" style="margin-left: auto; font-size: 0.75rem; color: var(--accent);">View Details </a>
            </div>

            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-header"><div class="stat-icon yellow"></div></div>
                    <div class="stat-value" id="creatorsStatGmv">$0</div>
                    <div class="stat-label">Total GMV</div>
                    <div class="stat-change neutral" id="creatorsStatGmvChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon purple"></div></div>
                    <div class="stat-value" id="creatorsStatTotal">0</div>
                    <div class="stat-label">Active Creators</div>
                    <div class="stat-change neutral" id="creatorsStatTotalChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon green"></div></div>
                    <div class="stat-value" id="creatorsStatAvg">$0</div>
                    <div class="stat-label">Avg GMV/Creator</div>
                    <div class="stat-change neutral" id="creatorsStatAvgChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon orange"></div></div>
                    <div class="stat-value" id="creatorsStatCommission">$0</div>
                    <div class="stat-label">Est. Commission</div>
                    <div class="stat-change neutral" id="creatorsStatCommissionChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon teal"></div></div>
                    <div class="stat-value" id="creatorsStatRising" style="color: var(--success);">0</div>
                    <div class="stat-label">Rising (20%+)</div>
                    <div class="stat-meta" style="font-size: 0.7rem; color: var(--success); margin-top: 4px;">Hot momentum</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon red"></div></div>
                    <div class="stat-value" id="creatorsStatDeclining" style="color: var(--error);">0</div>
                    <div class="stat-label">Declining (20%+)</div>
                    <div class="stat-meta" style="font-size: 0.7rem; color: var(--error); margin-top: 4px;">Needs attention</div>
                </div>
            </div>

            <!-- Quick Insights -->
            <div class="grid-4" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Top Performers</div>
                    </div>
                    <div class="card-body no-padding" id="creatorsTopPerformers">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Rising Stars</div>
                    </div>
                    <div class="card-body no-padding" id="creatorsRisingStars">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Needs Attention</div>
                    </div>
                    <div class="card-body no-padding" id="creatorsNeedsAttention">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card" style="border: 1px solid var(--accent);">
                    <div class="card-header">
                        <div class="card-title"><span></span> Recruit Opportunities</div>
                    </div>
                    <div class="card-body no-padding" id="creatorsRecruitOpportunities">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" style="display: none; padding: 12px 16px; background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 10px; margin-bottom: 16px; align-items: center; gap: 12px;">
                <span id="selectedCount" style="font-weight: 600;">0 selected</span>
                <button class="btn btn-secondary" onclick="bulkAddToRoster()" style="padding: 8px 12px;"> Add to Roster</button>
                <button class="btn btn-secondary" onclick="clearSelection()" style="padding: 8px 12px;"> Clear</button>
            </div>

            <!-- Main Creator Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span></span> All Creators</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);" id="creatorsTableCount">0 creators</div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="selectAllCreators" onchange="toggleSelectAll(this)"></th>
                                    <th>Creator</th>
                                    <th>Brand</th>
                                    <th>Status</th>
                                    <th>GMV</th>
                                    <th>vs Prior</th>
                                    <th>Orders</th>
                                    <th>AOV</th>
                                    <th>Videos</th>
                                    <th>Commission</th>
                                    <th>Tier</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="creatorsFullBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="creatorsPagination"></div>
                </div>
            </div>
            </div> <!-- End creatorsTable -->
        </div>

        <!-- ==================== VIDEOS ==================== -->
        <div id="view-videos" class="view-section">
            <!-- Loading Overlay -->
            <div id="videos-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading videos...</div>
                <div class="loading-subtext">Scanning content library</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header">
                <div>
                    <h1 class="header-title">Videos</h1>
                    <p class="header-subtitle">Track video performance and identify your top content</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportVideos()"> Export CSV</button>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Brand</span>
                    <select id="videosBrandFilter" onchange="pages.videos = 1; loadVideosData();">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Date Range</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="videosDatePresetSelect" class="filter-select" style="min-width: 130px;">
                            <option value="yesterday">Yesterday</option>
                            <option value="last7" selected>Last 7 Days</option>
                            <option value="last14">Last 14 Days</option>
                            <option value="last30">Last 30 Days</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <input type="text" class="date-range-input" id="videosDateRange" placeholder="Select dates" readonly style="width: 220px;">
                    </div>
                    <input type="hidden" id="videosDateFilterStart">
                    <input type="hidden" id="videosDateFilterEnd">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Status</span>
                    <select id="videosStatusFilter" onchange="pages.videos = 1; loadVideosData();">
                        <option value="all">All Creators</option>
                        <option value="managed">Managed Only</option>
                        <option value="unmanaged">Unmanaged Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Search</span>
                    <input type="text" class="search-input" placeholder="Search videos or creators..." id="videosSearchInput" style="min-width: 180px;">
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-header"><div class="stat-icon yellow"></div></div>
                    <div class="stat-value" id="videosStatGmv">$0</div>
                    <div class="stat-label">Total GMV</div>
                    <div class="stat-change neutral" id="videosStatGmvChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon blue"></div></div>
                    <div class="stat-value" id="videosStatTotal">0</div>
                    <div class="stat-label">Unique Videos</div>
                    <div class="stat-change neutral" id="videosStatTotalChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon purple"></div></div>
                    <div class="stat-value" id="videosStatCreators">0</div>
                    <div class="stat-label">Creators</div>
                    <div class="stat-change neutral" id="videosStatCreatorsChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon green"></div></div>
                    <div class="stat-value" id="videosStatOrders">0</div>
                    <div class="stat-label">Orders</div>
                    <div class="stat-change neutral" id="videosStatOrdersChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon orange"></div></div>
                    <div class="stat-value" id="videosStatAvg">$0</div>
                    <div class="stat-label">Avg GMV/Video</div>
                    <div class="stat-change neutral" id="videosStatAvgChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon teal"></div></div>
                    <div class="stat-value" id="videosStatConversion">0%</div>
                    <div class="stat-label">Videos w/ Sales</div>
                    <div class="stat-change neutral" id="videosStatConversionChange">--</div>
                </div>
            </div>

            <!-- Quick Insights -->
            <div class="grid-3" style="margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Top Performing Videos</div>
                    </div>
                    <div class="card-body no-padding" id="videosTopPerforming">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Top Creators by Video GMV</div>
                    </div>
                    <div class="card-body no-padding" id="videosTopCreators">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Most Efficient (GMV/Video)</div>
                    </div>
                    <div class="card-body no-padding" id="videosMostEfficient">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Main Videos Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span></span> All Videos</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);" id="videosTableCount">0 videos</div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Video</th>
                                    <th>Creator</th>
                                    <th>Brand</th>
                                    <th>Product</th>
                                    <th>Status</th>
                                    <th>GMV</th>
                                    <th>Orders</th>
                                    <th>Items</th>
                                    <th>AOV</th>
                                </tr>
                            </thead>
                            <tbody id="videosBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="videosPagination"></div>
                </div>
            </div>
        </div>

        <!-- ==================== PRODUCTS ==================== -->
        <div id="view-products" class="view-section">
            <!-- Loading Overlay -->
            <div id="products-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading products...</div>
                <div class="loading-subtext">Analyzing product performance</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header">
                <div>
                    <h1 class="header-title">Products</h1>
                    <p class="header-subtitle">Track product performance across all sales channels</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportProducts()"> Export CSV</button>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Brand</span>
                    <select id="productsBrandFilter" onchange="pages.products = 1; loadProductsData();">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Date Range</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="productsDatePresetSelect" class="filter-select" style="min-width: 130px;">
                            <option value="yesterday">Yesterday</option>
                            <option value="last7" selected>Last 7 Days</option>
                            <option value="last14">Last 14 Days</option>
                            <option value="last30">Last 30 Days</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <input type="text" class="date-range-input" id="productsDateRange" placeholder="Select dates" readonly style="width: 220px;">
                    </div>
                    <input type="hidden" id="productsDateFilterStart">
                    <input type="hidden" id="productsDateFilterEnd">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Search</span>
                    <input type="text" class="search-input" placeholder="Search products..." id="productsSearchInput" style="min-width: 180px;">
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-header"><div class="stat-icon yellow"></div></div>
                    <div class="stat-value" id="productsStatGmv">$0</div>
                    <div class="stat-label">Total GMV</div>
                    <div class="stat-change neutral" id="productsStatGmvChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon purple"></div></div>
                    <div class="stat-value" id="productsStatTotal">0</div>
                    <div class="stat-label">Products</div>
                    <div class="stat-change neutral" id="productsStatTotalChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon green"></div></div>
                    <div class="stat-value" id="productsStatOrders">0</div>
                    <div class="stat-label">Orders</div>
                    <div class="stat-change neutral" id="productsStatOrdersChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon blue"></div></div>
                    <div class="stat-value" id="productsStatItems">0</div>
                    <div class="stat-label">Items Sold</div>
                    <div class="stat-change neutral" id="productsStatItemsChange">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon orange"></div></div>
                    <div class="stat-value" id="productsStatVideoGmv">$0</div>
                    <div class="stat-label">Video GMV</div>
                    <div class="stat-meta" id="productsStatVideoPct" style="font-size: 0.75rem; color: var(--accent); margin-top: 4px;">--% of total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon red"></div></div>
                    <div class="stat-value" id="productsStatLiveGmv">$0</div>
                    <div class="stat-label">LIVE GMV</div>
                    <div class="stat-meta" id="productsStatLivePct" style="font-size: 0.75rem; color: var(--info); margin-top: 4px;">--% of total</div>
                </div>
            </div>

            <!-- Insights Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Top Products</div>
                    </div>
                    <div class="card-body no-padding" id="productsTopList">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Sales by Channel</div>
                    </div>
                    <div class="card-body" style="height: 220px;">
                        <canvas id="productsChannelChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Main Products Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span></span> All Products</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);" id="productsTableCount">0 products</div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Brand</th>
                                    <th>Status</th>
                                    <th>GMV</th>
                                    <th>Orders</th>
                                    <th>Items</th>
                                    <th>Video GMV</th>
                                    <th>LIVE GMV</th>
                                    <th>Shop GMV</th>
                                </tr>
                            </thead>
                            <tbody id="productsBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="productsPagination"></div>
                </div>
            </div>
        </div>

        <!-- ==================== ROSTER ==================== -->
        <div id="view-roster" class="view-section">
            <!-- Loading Overlay -->
            <div id="roster-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading roster...</div>
                <div class="loading-subtext">Fetching creator roster</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header" style="flex-wrap: wrap; gap: 16px;">
                <div style="flex: 1; min-width: 200px;">
                    <h1 class="header-title"> Creator Roster</h1>
                    <p class="header-subtitle">Your managed creators</p>
                </div>
                <div class="header-actions" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <!-- View Toggle -->
                    <div class="view-toggle" style="display: flex; background: var(--bg-secondary); border-radius: 8px; padding: 3px; border: 1px solid var(--border);">
                        <button id="rosterViewIdentity" class="view-toggle-btn active" onclick="setRosterView('identity')" title="Group by creator" style="padding: 6px 12px; border: none; background: var(--bg-card); border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: var(--text-primary); transition: all 0.15s;">
                             Identity
                        </button>
                        <button id="rosterViewEntries" class="view-toggle-btn" onclick="setRosterView('entries')" title="Show all entries" style="padding: 6px 12px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; color: var(--text-muted); transition: all 0.15s;">
                             Entries
                        </button>
                    </div>
                    <button class="btn" onclick="exportRoster()" style="padding: 8px 12px;"> Export</button>
                    <button class="btn btn-primary" onclick="openAddCreatorModal()" style="padding: 8px 16px;"> Add Creator</button>
                </div>
            </div>

            <!-- Compact Filter Bar -->
            <div class="filters" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; padding: 12px 16px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 20px;">
                <select id="rosterBrandFilter" onchange="onRosterBrandFilterChange();" class="filter-select" style="min-width: 130px;">
                    <option value="all">All Brands</option>
                    <option value="catakor">Cata-Kor</option>
                    <option value="jiyu">JiYu</option>
                    <option value="physicians_choice">Physicians Choice</option>
                    <option value="peach_slices">Peach Slices</option>
                    <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                </select>
                <select id="rosterProductFilter" onchange="pages.roster = 1; loadRosterData();" class="filter-select" style="min-width: 140px;">
                    <option value="all">All Products</option>
                </select>
                <select id="rosterDatePresetSelect" class="filter-select" style="min-width: 130px;">
                    <option value="yesterday">Yesterday</option>
                    <option value="last7" selected>Last 7 Days</option>
                    <option value="last14">Last 14 Days</option>
                    <option value="last30">Last 30 Days</option>
                    <option value="thisMonth">This Month</option>
                    <option value="lastMonth">Last Month</option>
                    <option value="custom">Custom Range</option>
                </select>
                <input type="text" class="date-range-input" id="rosterDateRange" placeholder="Select dates" readonly style="width: 200px; display: none;">
                <input type="hidden" id="rosterDateFilterStart">
                <input type="hidden" id="rosterDateFilterEnd">
                <select id="rosterStatusFilter" onchange="pages.roster = 1; loadRosterData();" class="filter-select" style="min-width: 120px;">
                    <option value="all" selected>All Statuses</option>
                    <option value="Active">Active</option>
                    <option value="Applied">Applied</option>
                    <option value="Pending">Pending</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Churned">Churned</option>
                </select>
                <select id="rosterQuickFilter" onchange="pages.roster = 1; loadRosterData();" class="filter-select" style="min-width: 160px;">
                    <option value="all">All Creators</option>
                    <option value="top_performers"> Top Performers</option>
                    <option value="at_risk"> At Risk</option>
                    <option value="has_retainer"> Has Retainer</option>
                    <option value="has_product"> Has Product</option>
                    <option value="multi_brand"> Multi-Brand</option>
                    <option value="new_creators"> New (< 30 days)</option>
                    <option value="missing_data"> Missing Data</option>
                </select>
                <div style="flex: 1;"></div>
                <input type="text" class="search-input" placeholder=" Search creators..." id="rosterSearchInput" style="min-width: 180px; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
            </div>

            <!-- Summary Stats - More Compact -->
            <div class="stats-grid" style="grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 20px;">
                <div class="stat-card highlight" style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="stat-icon yellow" style="width: 36px; height: 36px; font-size: 1.1rem;"></div>
                        <div>
                            <div class="stat-value" id="rosterStatGmv" style="font-size: 1.4rem;">$0</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Roster GMV</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="stat-icon purple" style="width: 36px; height: 36px; font-size: 1.1rem;"></div>
                        <div>
                            <div class="stat-value" id="rosterStatUniqueCreators" style="font-size: 1.4rem;">0</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Creators</div>
                        </div>
                    </div>
                    <div class="stat-subtext" id="rosterStatEntriesCount" style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px;">0 entries</div>
                </div>
                <div class="stat-card" style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="stat-icon green" style="width: 36px; height: 36px; font-size: 1.1rem;"></div>
                        <div>
                            <div class="stat-value" id="rosterStatActive" style="font-size: 1.4rem; color: var(--success);">0</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Active</div>
                        </div>
                    </div>
                    <div class="stat-subtext" id="rosterStatChurned" style="font-size: 0.65rem; color: var(--error); margin-top: 4px;">0 churned</div>
                </div>
                <div class="stat-card" style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="stat-icon blue" style="width: 36px; height: 36px; font-size: 1.1rem;"></div>
                        <div>
                            <div class="stat-value" id="rosterStatAvgGmv" style="font-size: 1.4rem;">$0</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Avg/Creator</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="stat-icon orange" style="width: 36px; height: 36px; font-size: 1.1rem;"></div>
                        <div>
                            <div class="stat-value" id="rosterStatMultiBrand" style="font-size: 1.4rem;">0</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Multi-Brand</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="stat-icon teal" style="width: 36px; height: 36px; font-size: 1.1rem;"></div>
                        <div>
                            <div class="stat-value" id="rosterStatRetainer" style="font-size: 1.4rem;">$0</div>
                            <div class="stat-label" style="font-size: 0.75rem;">Retainers/mo</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Health Check (hidden when no issues) -->
            <div id="rosterHealthCheck" class="card" style="margin-bottom: 24px; display: none; border-left: 4px solid var(--warning);">
                <div class="card-header" style="padding: 12px 16px;">
                    <div class="card-title"><span></span> Roster Data Health</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="openSmartMatchModal()" style="font-size: 0.8rem; padding: 4px 12px;">
                             Smart Match
                        </button>
                        <button class="btn btn-secondary" onclick="toggleRosterHealthDetails()" style="font-size: 0.8rem; padding: 4px 12px;">
                            <span id="rosterHealthToggleText">Show Details</span>
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: 12px 16px;">
                    <!-- Health Summary -->
                    <div id="rosterHealthSummary" style="display: flex; gap: 24px; flex-wrap: wrap;">
                        <div id="healthMissingDiscord" style="display: none; padding: 8px 16px; background: var(--warning-dim); border-radius: 8px; cursor: pointer;" onclick="openSmartMatchModal(); switchSmartMatchTab('missingDiscord');">
                            <span style="font-size: 1.2rem;"></span>
                            <span id="healthMissingDiscordCount">0</span>&nbsp;creators missing Discord
                        </div>
                        <div id="healthMissingTikTok" style="display: none; padding: 8px 16px; background: var(--danger-dim); border-radius: 8px; cursor: pointer;" onclick="openSmartMatchModal(); switchSmartMatchTab('missingTikTok');">
                            <span style="font-size: 1.2rem;"></span>
                            <span id="healthMissingTikTokCount">0</span>&nbsp;creators missing TikTok
                        </div>
                        <div id="healthMissingName" style="display: none; padding: 8px 16px; background: var(--purple-dim); border-radius: 8px; cursor: pointer;" onclick="openSmartMatchModal(); switchSmartMatchTab('missingName');">
                            <span style="font-size: 1.2rem;"></span>
                            <span id="healthMissingNameCount">0</span>&nbsp;creators missing name
                        </div>
                        <div id="healthMissingDiscordId" style="display: none; padding: 8px 16px; background: var(--purple-dim); border-radius: 8px; cursor: pointer;" onclick="toggleHealthDetails()">
                            <span style="font-size: 1.2rem;"></span>
                            <span id="healthMissingDiscordIdCount">0</span>&nbsp;missing Discord ID
                        </div>
                        <div id="healthDuplicates" style="display: none; padding: 8px 16px; background: var(--info-dim); border-radius: 8px; cursor: pointer;" onclick="openSmartMatchModal(); switchSmartMatchTab('duplicates');">
                            <span style="font-size: 1.2rem;"></span>
                            <span id="healthDuplicatesCount">0</span>&nbsp;potential duplicates
                        </div>
                        <div id="healthSameBrandDupes" style="display: none; padding: 8px 16px; background: var(--purple-dim); border-radius: 8px; cursor: pointer;" onclick="openMergeEntriesModal()">
                            <span style="font-size: 1.2rem;"></span>
                            <span id="healthSameBrandDupesCount">0</span>&nbsp;need merging
                        </div>
                        <div id="healthOrphanedPerf" style="display: none; padding: 8px 16px; background: var(--accent-dim); border-radius: 8px; cursor: pointer;" onclick="showOrphanedDataModal()">
                            <span style="font-size: 1.2rem;"></span>
                            <span id="healthOrphanedPerfCount">0</span>&nbsp;unlinked performance
                        </div>
                    </div>
                    
                    <!-- Health Details (collapsed by default) -->
                    <div id="rosterHealthDetails" style="display: none; margin-top: 16px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                            <!-- Missing Discord List -->
                            <div id="healthMissingDiscordList" style="display: none;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--warning);"> Missing Discord Name</div>
                                <div id="healthMissingDiscordItems" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Missing Discord ID List -->
                            <div id="healthMissingDiscordIdList" style="display: none;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--purple);"> Missing Discord ID</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">These creators won't be matched when they log into the Creator Portal</div>
                                <div id="healthMissingDiscordIdItems" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Missing TikTok List -->
                            <div id="healthMissingTikTokList" style="display: none;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--danger);"> Missing TikTok</div>
                                <div id="healthMissingTikTokItems" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Missing Name List -->
                            <div id="healthMissingNameList" style="display: none;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--purple);"> Missing Name</div>
                                <div id="healthMissingNameItems" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Duplicates List -->
                            <div id="healthDuplicatesList" style="display: none;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--info);"> Potential Duplicates</div>
                                <div id="healthDuplicatesItems" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Integrity Stats -->
                    <div id="dataIntegrityStats" style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 10px;">
                        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span></span> Data Integrity
                            <button class="btn btn-small" onclick="runDataIntegrityCheck()" style="margin-left: auto; padding: 4px 12px; font-size: 0.75rem;"> Refresh</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div style="text-align: center; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="integrityLinkedPct">--%</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Performance Linked</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="integrityDiscordIdPct">--%</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Have Discord ID</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="integrityTikTokAccounts">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">TikTok Accounts</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700;" id="integrityOrphaned">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Orphaned Records</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Insights -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Top Performers</div>
                    </div>
                    <div class="card-body no-padding" id="rosterTopPerformers">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Needs Attention</div>
                    </div>
                    <div class="card-body no-padding" id="rosterNeedsAttention">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Follow-ups Due</div>
                    </div>
                    <div class="card-body no-padding" id="rosterFollowups">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Applications</div>
                    </div>
                    <div class="card-body" id="rosterApplications">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Main Roster Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span></span> 
                        <span id="rosterTableTitle">All Creators</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 0.85rem; color: var(--text-muted);" id="rosterTableCount">0 creators</div>
                    </div>
                </div>
                
                <!-- Bulk Actions Bar -->
                <div class="bulk-actions-bar" id="rosterBulkActions">
                    <span class="bulk-select-count"><span id="rosterSelectedCount">0</span> selected</span>
                    <div class="bulk-actions-buttons">
                        <button class="bulk-btn" onclick="bulkUpdateRosterStatus('Active')"> Set Active</button>
                        <button class="bulk-btn" onclick="bulkUpdateRosterStatus('On Hold')"> Set On Hold</button>
                        <button class="bulk-btn" onclick="bulkExportRoster()"> Export</button>
                        <button class="bulk-btn danger" onclick="bulkRemoveFromRoster()"> Remove</button>
                        <button class="bulk-btn" onclick="clearRosterSelection()"> Clear</button>
                    </div>
                </div>
                
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead id="rosterTableHead">
                                <!-- Dynamic headers based on view mode -->
                            </thead>
                            <tbody id="rosterBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="rosterPagination"></div>
                </div>
            </div>
        </div>

        <!-- ==================== GOALS ==================== -->
        <div id="view-goals" class="view-section">
            <div class="header">
                <div>
                    <h1 class="header-title">Goals</h1>
                    <p class="header-subtitle">Track GMV targets and progress</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openGoalModal()"> Set Goal</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-header"><div class="stat-icon yellow"></div></div>
                    <div class="stat-value" id="goalsTarget">$0</div>
                    <div class="stat-label">Monthly Target</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon green"></div></div>
                    <div class="stat-value" id="goalsCurrent">$0</div>
                    <div class="stat-label">Current GMV</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon blue"></div></div>
                    <div class="stat-value" id="goalsProgress">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon purple"></div></div>
                    <div class="stat-value" id="goalsDaysLeft">0</div>
                    <div class="stat-label">Days Left</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span></span> Active Goals</div>
                </div>
                <div class="card-body" id="goalsBody">
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>No goals set</h3>
                        <p>Click "Set Goal" to create your first target</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ALERTS ==================== -->
        <div id="view-alerts" class="view-section">
            <div class="header">
                <div>
                    <h1 class="header-title">Alerts</h1>
                    <p class="header-subtitle">Performance notifications and warnings</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="markAllAlertsRead()"> Mark All Read</button>
                </div>
            </div>

            <div class="card">
                <div class="card-body no-padding" id="alertsBody">
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>No alerts</h3>
                        <p>Alerts will appear when there are significant changes in creator performance</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== COMMISSION CALCULATOR ==================== -->
        <div id="view-calculator" class="view-section">
            <div class="header">
                <div>
                    <h1 class="header-title"> Earnings Calculator</h1>
                    <p class="header-subtitle">Tyler & Matt's monthly earnings (commission + retainers)</p>
                </div>
                <div class="header-actions">
                    <select id="revShareMonth" class="filter-select" onchange="calculateRevenueShare()">
                        <!-- Populated by JS -->
                    </select>
                    <button class="btn btn-primary" onclick="calculateRevenueShare()"> Calculate</button>
                    <button class="btn btn-secondary" onclick="exportEarningsSummary()"> Export CSV</button>
                    <button class="btn btn-secondary" onclick="openInvoiceModal()"> Generate Invoices</button>
                </div>
            </div>

            <!-- Goal Tracker -->
            <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(245, 197, 24, 0.1), var(--bg-card)); border: 1px solid rgba(245, 197, 24, 0.2);">
                <div class="card-body" style="padding: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 2rem;"></span>
                            <div>
                                <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">Monthly Earnings Goal</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Combined commission + retainers</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.75rem; font-weight: 700;">
                                <span id="goalCurrentAmount" style="color: var(--success);">$0</span>
                                <span style="color: var(--text-muted); font-size: 1rem;"> / $100,000</span>
                            </div>
                            <div id="goalPercentText" style="font-size: 0.85rem; color: var(--text-muted);">0% complete</div>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div style="background: var(--bg-secondary); border-radius: 12px; height: 24px; overflow: hidden; position: relative;">
                        <div id="goalProgressBar" style="background: linear-gradient(90deg, var(--success), #4ade80); height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 12px;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">
                            <span id="goalProgressText">$0 to go</span>
                        </div>
                    </div>
                    <!-- Milestones -->
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.7rem; color: var(--text-muted);">
                        <span>$0</span>
                        <span>$25K</span>
                        <span>$50K</span>
                        <span>$75K</span>
                        <span>$100K </span>
                    </div>
                </div>
            </div>

            <!-- Total Summary -->
            <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));">
                <div class="card-body" style="padding: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; text-align: center; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total GMV</div>
                            <div id="revTotalGmv" style="font-size: 2rem; font-weight: 700; color: var(--accent);">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Commission</div>
                            <div id="revTotalShare" style="font-size: 2rem; font-weight: 700; color: var(--success);">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Retainers</div>
                            <div id="revTotalRetainers" style="font-size: 2rem; font-weight: 700; color: var(--warning);">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Launch Fees</div>
                            <div id="revTotalLaunchFees" style="font-size: 2rem; font-weight: 700; color: var(--info);">$0</div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid var(--border); padding-top: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; text-align: center;">
                            <div style="background: var(--success-dim); padding: 16px; border-radius: 12px;">
                                <div style="font-size: 0.75rem; color: var(--success); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total Earnings</div>
                                <div id="revTotalEarnings" style="font-size: 2rem; font-weight: 700; color: var(--success);">$0</div>
                            </div>
                            <div style="background: var(--blue-dim); padding: 16px; border-radius: 12px;">
                                <div style="font-size: 0.75rem; color: var(--blue); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Tyler (50%)</div>
                                <div id="revTylerShare" style="font-size: 2rem; font-weight: 700; color: var(--blue);">$0</div>
                            </div>
                            <div style="background: var(--purple-dim); padding: 16px; border-radius: 12px;">
                                <div style="font-size: 0.75rem; color: var(--purple); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Matt (50%)</div>
                                <div id="revMattShare" style="font-size: 2rem; font-weight: 700; color: var(--purple);">$0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Brand Breakdown -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span></span> Brand Breakdown</div>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">Click values to edit</span>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Brand</th>
                                    <th style="text-align: right;">Affiliate GMV</th>
                                    <th style="text-align: right;">Marketing GMV</th>
                                    <th style="text-align: right;">Total GMV</th>
                                    <th style="text-align: center;">Commission %</th>
                                    <th style="text-align: right;">Commission</th>
                                    <th style="text-align: center;">Base Retainer</th>
                                    <th style="text-align: center;">Launch Fee</th>
                                    <th style="text-align: right;">Total</th>
                                    <th style="text-align: right; color: var(--blue);">Tyler</th>
                                    <th style="text-align: right; color: var(--purple);">Matt</th>
                                </tr>
                            </thead>
                            <tbody id="revShareBody">
                                <tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-muted);">Select a month and click Calculate</td></tr>
                            </tbody>
                            <tfoot id="revShareFooter" style="display: none;">
                                <tr style="background: var(--bg-secondary); font-weight: 600;">
                                    <td>TOTAL</td>
                                    <td id="footerAffiliateGmv" style="text-align: right;"></td>
                                    <td id="footerMarketingGmv" style="text-align: right; color: var(--purple);"></td>
                                    <td id="footerGmv" style="text-align: right;"></td>
                                    <td></td>
                                    <td id="footerCommission" style="text-align: right; color: var(--success);"></td>
                                    <td id="footerRetainer" style="text-align: right; color: var(--warning);"></td>
                                    <td id="footerLaunchFee" style="text-align: right; color: var(--info);"></td>
                                    <td id="footerTotal" style="text-align: right; font-weight: 700; color: var(--success);"></td>
                                    <td id="footerTyler" style="text-align: right; color: var(--blue);"></td>
                                    <td id="footerMatt" style="text-align: right; color: var(--purple);"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Creator Breakdown by Brand -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title"><span></span> Creator Breakdown</div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <select id="creatorBreakdownBrand" class="filter-select" onchange="renderCreatorBreakdown()">
                            <option value="all">All Brands</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportCreatorBreakdownCSV()"> Export CSV</button>
                    </div>
                </div>
                
                <!-- Custom Rate Notice -->
                <div id="customRateNotice" style="display: none; margin: 16px 16px 0; padding: 12px 16px; background: var(--accent-dim); border-radius: 8px; font-size: 0.85rem;">
                    <strong> Custom Rates:</strong> <span id="customRateCount">0</span> creator(s) have adjusted commission rates. 
                    <span style="color: var(--text-muted);">Click rate badge to modify.</span>
                </div>
                
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 16px;">
                    <div style="background: var(--bg-secondary); padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Creators</div>
                        <div id="cbCreatorCount" style="font-size: 1.25rem; font-weight: 700;">0</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Total GMV</div>
                        <div id="cbTotalGmv" style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">$0</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Avg Rate</div>
                        <div id="cbAvgRate" style="font-size: 1.25rem; font-weight: 700;">2.0%</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Total Commission</div>
                        <div id="cbTotalCommission" style="font-size: 1.25rem; font-weight: 700; color: var(--success);">$0</div>
                    </div>
                </div>
                
                <div class="card-body no-padding">
                    <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                        <table>
                            <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th>Creator</th>
                                    <th>Brand</th>
                                    <th style="text-align: right;">GMV</th>
                                    <th style="text-align: right;">Orders</th>
                                    <th style="text-align: center;">Rate</th>
                                    <th style="text-align: right;">Commission</th>
                                    <th style="text-align: right;">% of Total</th>
                                </tr>
                            </thead>
                            <tbody id="creatorBreakdownBody">
                                <tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Calculate earnings to see creator breakdown</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-light);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.5rem;"></span>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        <strong>Affiliate GMV</strong> = managed creators from TikTok affiliate data. 
                        <strong>Marketing GMV</strong> = manual entry for marketing accounts (saved per month). 
                        Commission rates and retainers are saved to the database and persist across sessions.
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== SETTINGS ==================== -->
        <div id="view-settings" class="view-section">
            <div class="header">
                <div>
                    <h1 class="header-title"> Settings</h1>
                    <p class="header-subtitle">Configure integrations, products, notifications, and more</p>
                </div>
            </div>

            <!-- Settings Navigation Tabs -->
            <div style="display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg-secondary); padding: 4px; border-radius: 12px; border: 1px solid var(--border); overflow-x: auto;">
                <button class="settings-tab active" data-tab="products" onclick="switchSettingsTab('products')" style="padding: 12px 20px; border: none; background: var(--bg-card); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-primary); white-space: nowrap; transition: all 0.2s;">
                     Products
                </button>
                <button class="settings-tab" data-tab="brands" onclick="switchSettingsTab('brands')" style="padding: 12px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); white-space: nowrap; transition: all 0.2s;">
                     Brands
                </button>
                <button class="settings-tab" data-tab="integrations" onclick="switchSettingsTab('integrations')" style="padding: 12px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); white-space: nowrap; transition: all 0.2s;">
                     Integrations
                </button>
                <button class="settings-tab" data-tab="notifications" onclick="switchSettingsTab('notifications')" style="padding: 12px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); white-space: nowrap; transition: all 0.2s;">
                     Notifications
                </button>
                <button class="settings-tab" data-tab="reports" onclick="switchSettingsTab('reports')" style="padding: 12px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); white-space: nowrap; transition: all 0.2s;">
                     Reports
                </button>
                <button class="settings-tab" data-tab="application" onclick="switchSettingsTab('application')" style="padding: 12px 20px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); white-space: nowrap; transition: all 0.2s;">
                     Application
                </button>
            </div>

            <!-- PRODUCTS TAB -->
            <div id="settings-tab-products" class="settings-tab-content" style="display: block;">
                <!-- Product Stats Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(139, 92, 246, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                            <div>
                                <div style="font-size: 1.75rem; font-weight: 800; color: #a78bfa;" id="settingsProductCount">-</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Products</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(34, 197, 94, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                            <div>
                                <div style="font-size: 1.75rem; font-weight: 800; color: #22c55e;" id="settingsProductGmv">$0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">GMV (30d)</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(59, 130, 246, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                            <div>
                                <div style="font-size: 1.75rem; font-weight: 800; color: #3b82f6;" id="settingsProductVideos">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Videos</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 44px; height: 44px; background: rgba(245, 158, 11, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                            <div>
                                <div style="font-size: 1rem; font-weight: 700; color: #f59e0b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;" id="settingsTopProduct" title="">-</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Top Product</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products from Data -->
                <div class="card" style="border-radius: 16px; overflow: hidden;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <div class="card-title" style="margin: 0; font-size: 1.1rem;"><span style="margin-right: 8px;"></span>Products from Your Data</div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin: 6px 0 0 0;">All products found in your video performance uploads  Last 30 days</p>
                        </div>
                        <button class="btn" onclick="loadSettingsProducts()" style="display: flex; align-items: center; gap: 6px; padding: 8px 16px;">
                            <span style="font-size: 1rem;"></span> Refresh
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px; padding: 14px 16px; background: var(--bg-secondary); border-radius: 10px;">
                        <select id="settingsProductBrandFilter" onchange="filterSettingsProducts()" style="padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); font-weight: 500; min-width: 160px;">
                            <option value="all"> All Brands</option>
                            <option value="physicians_choice"> Physicians Choice</option>
                            <option value="jiyu"> JiYu</option>
                            <option value="catakor"> Cata-Kor</option>
                            <option value="peach_slices"> Peach Slices</option>
                            <option value="yerba_magic"> Yerba Magic</option>
                            <option value="toplux"> Toplux Nutrition</option>
                        </select>
                        <div style="position: relative; flex: 1; max-width: 320px;">
                            <input type="text" id="settingsProductSearch" placeholder="Search products..." oninput="filterSettingsProducts()" style="padding: 10px 14px 10px 38px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); width: 100%;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5;"></span>
                        </div>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                            <span id="settingsProductFilterCount" style="color: var(--text-muted); font-size: 0.85rem; font-weight: 500;">0 products</span>
                        </div>
                    </div>
                    
                    <div class="table-container" style="max-height: 450px; overflow-y: auto; border-radius: 10px; border: 1px solid var(--border);">
                        <table>
                            <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 1;">
                                <tr>
                                    <th style="cursor: pointer; padding: 14px 16px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;" onclick="sortSettingsProducts('name')">Product Name </th>
                                    <th style="padding: 14px 12px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Brand</th>
                                    <th style="text-align: right; cursor: pointer; padding: 14px 16px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;" onclick="sortSettingsProducts('gmv')">GMV </th>
                                    <th style="text-align: center; cursor: pointer; padding: 14px 12px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;" onclick="sortSettingsProducts('videos')">Videos </th>
                                    <th style="text-align: center; cursor: pointer; padding: 14px 12px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;" onclick="sortSettingsProducts('orders')">Orders </th>
                                    <th style="text-align: right; padding: 14px 16px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">$/Video</th>
                                </tr>
                            </thead>
                            <tbody id="settingsProductsTableBody">
                                <tr><td colspan="6" style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
                                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                                    <div style="font-size: 0.9rem;">Loading products from data...</div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Product Groups -->
                <div class="card" style="margin-top: 24px; border-radius: 16px;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <div class="card-title" style="margin: 0; font-size: 1.1rem;"><span style="margin-right: 8px;"></span>Product Groups</div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin: 6px 0 0 0;">Combine multiple products into logical groups for easier filtering and reporting</p>
                        </div>
                        <button class="btn btn-success" onclick="openCreateGroupModal()" style="display: flex; align-items: center; gap: 6px; padding: 10px 18px; font-weight: 600;">
                            <span style="font-size: 1.1rem;"></span> Create Group
                        </button>
                    </div>
                    
                    <div id="productGroupsContainer">
                        <div id="productGroupsList" style="display: grid; gap: 12px;">
                            <!-- Groups will be rendered here -->
                        </div>
                        <div id="noGroupsMessage" style="text-align: center; padding: 50px 40px; background: var(--bg-secondary); border-radius: 12px; border: 2px dashed var(--border);">
                            <div style="font-size: 2.5rem; margin-bottom: 16px;"></div>
                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 8px; color: var(--text-primary);">No product groups created yet</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); max-width: 400px; margin: 0 auto;">Groups let you combine variants like "Probiotic 30ct" + "Probiotic 60ct" into one "Probiotics" group for cleaner reports</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BRANDS TAB -->
            <div id="settings-tab-brands" class="settings-tab-content" style="display: none;">
                <div style="display: grid; gap: 24px; max-width: 900px;">
                    
                    <!-- Quick Actions -->
                    <div class="card" style="padding: 24px; border-radius: 12px;">
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 16px;"> Quick Actions</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button class="btn" onclick="copyBrandApplyLink()" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; height: auto;">
                                <span style="font-size: 1.5rem;"></span>
                                <span style="font-weight: 600;">Copy Apply Link</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Get brand-specific URL</span>
                            </button>
                            <button class="btn" onclick="openBrandPortalLink()" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; height: auto;">
                                <span style="font-size: 1.5rem;"></span>
                                <span style="font-weight: 600;">Brand Portal</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">View as brand client</span>
                            </button>
                            <button class="btn" onclick="testApplyPage()" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; height: auto;">
                                <span style="font-size: 1.5rem;"></span>
                                <span style="font-weight: 600;">Preview Apply Page</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Test creator experience</span>
                            </button>
                        </div>
                    </div>

                    <!-- Brand Selector -->
                    <div class="card" style="padding: 24px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                            <div style="font-weight: 700; font-size: 1.1rem;"> Active Brands</div>
                            <select id="brandSettingsSelect" onchange="updateBrandSettings()" style="padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); font-weight: 500; min-width: 200px;">
                                <option value="catakor">Cata-Kor</option>
                                <option value="jiyu">JiYu</option>
                                <option value="physicians_choice">Physicians Choice</option>
                                <option value="peach_slices">Peach Slices</option>
                                <option value="yerba_magic">Yerba Magic</option>
                                <option value="toplux">Toplux Nutrition</option>
                            </select>
                        </div>
                        
                        <!-- Brand Info Cards -->
                        <div id="brandInfoCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px;">
                        </div>
                        
                        <!-- Brand Links -->
                        <div style="background: var(--bg-secondary); border-radius: 10px; padding: 16px;">
                            <div style="font-weight: 600; margin-bottom: 12px; font-size: 0.9rem;"> Brand Links</div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg-card); border-radius: 8px;">
                                    <span style="font-size: 0.85rem; color: var(--text-muted); min-width: 100px;">Apply URL:</span>
                                    <code id="brandApplyUrl" style="flex: 1; font-size: 0.85rem; color: var(--accent); word-break: break-all;"></code>
                                    <button class="btn" onclick="copyBrandApplyLink()" style="padding: 6px 12px; font-size: 0.8rem;"> Copy</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg-card); border-radius: 8px;">
                                    <span style="font-size: 0.85rem; color: var(--text-muted); min-width: 100px;">Portal URL:</span>
                                    <code id="brandPortalUrl" style="flex: 1; font-size: 0.85rem; color: var(--accent); word-break: break-all;"></code>
                                    <button class="btn" onclick="copyBrandPortalLink()" style="padding: 6px 12px; font-size: 0.8rem;"> Copy</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Brand Stats Summary -->
                    <div class="card" style="padding: 24px; border-radius: 12px;">
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 20px;"> Brand Overview</div>
                        <div id="brandStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                            <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 10px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="brandStatCreators">--</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Creators</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 10px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="brandStatGMV">--</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">GMV (30d)</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 10px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--blue);" id="brandStatProducts">--</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Products</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 10px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple);" id="brandStatApps">--</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Pending Apps</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Brand Onboarding Checklist -->
                    <div class="card" style="padding: 24px; border-radius: 12px;">
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 16px;"> New Client Onboarding Checklist</div>
                        <div style="display: flex; flex-direction: column; gap: 12px;" id="onboardingChecklist">
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="check-brand-added" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Brand added to system</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Added to dropdowns in admin, apply page, portals</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="check-discord-server" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Discord server created</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Server ID added for creator linking</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="check-products-added" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Products uploaded</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Initial product catalog imported</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="check-webhook-setup" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Discord webhook configured</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Notifications flowing to brand's Discord</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="check-apply-page" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Apply page tested</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Brand-specific apply link working</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="check-brand-portal" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Brand portal access</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Client can log in and view dashboard</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INTEGRATIONS TAB -->
            <div id="settings-tab-integrations" class="settings-tab-content" style="display: none;">
                <div style="display: grid; gap: 16px; max-width: 900px;">
                    
                    <!-- Discord Webhooks -->
                    <div class="card" id="discordCard" style="border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 40px; height: 40px; background: #5865F2; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1rem;">Discord Webhooks</div>
                                <div style="color: var(--text-muted); font-size: 0.8rem;">Add multiple webhooks for different channels</div>
                            </div>
                            <button class="btn btn-primary" onclick="openAddWebhookModal()" style="padding: 8px 14px; font-size: 0.85rem;">+ Add Webhook</button>
                        </div>
                        
                        <div id="discordWebhooksList">
                            <!-- Webhooks will be rendered here -->
                        </div>
                        <div id="noWebhooksMessage" style="text-align: center; padding: 30px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 8px;">
                            <div style="margin-bottom: 8px;">No webhooks configured</div>
                            <div style="font-size: 0.8rem;">Add webhooks for different Discord channels (e.g., #wins, #alerts, #reports)</div>
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="card" id="emailCard" style="border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 16px;">
                            <div style="width: 40px; height: 40px; background: #22c55e; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.1rem;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                    <span style="font-weight: 600; font-size: 1rem;">Email</span>
                                    <span style="font-size: 0.7rem; color: var(--text-muted);">via Resend</span>
                                    <span id="emailStatusBadge" style="font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: var(--bg-secondary); color: var(--text-muted);">Not connected</span>
                                </div>
                                <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">Send alerts and weekly reports via email</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <input type="password" class="form-input" id="resendApiKey" placeholder="API Key (re_...)" style="font-family: 'Space Mono', monospace; font-size: 0.75rem; padding: 10px 12px;">
                                    <input type="email" class="form-input" id="resendFromEmail" placeholder="From email address" style="font-size: 0.85rem; padding: 10px 12px;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="saveEmailSettings()" style="padding: 10px 16px;">Save</button>
                                    <button class="btn" onclick="testEmailAlert()" style="padding: 10px 16px;">Test</button>
                                </div>
                                <div id="emailStatus" style="margin-top: 8px; font-size: 0.8rem;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- SMS -->
                    <div class="card" id="smsCard" style="border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 16px;">
                            <div style="width: 40px; height: 40px; background: #f97316; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.1rem;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                    <span style="font-weight: 600; font-size: 1rem;">SMS</span>
                                    <span style="font-size: 0.7rem; color: var(--text-muted);">via Twilio</span>
                                    <span id="smsStatusBadge" style="font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: var(--bg-secondary); color: var(--text-muted);">Not connected</span>
                                </div>
                                <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">Critical alerts via text message</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" class="form-input" id="twilioSid" placeholder="Account SID" style="font-family: 'Space Mono', monospace; font-size: 0.75rem; padding: 10px 12px;">
                                    <input type="password" class="form-input" id="twilioToken" placeholder="Auth Token" style="font-family: 'Space Mono', monospace; font-size: 0.75rem; padding: 10px 12px;">
                                    <input type="tel" class="form-input" id="twilioPhone" placeholder="+1234567890" style="font-size: 0.85rem; padding: 10px 12px;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="saveSmsSettings()" style="padding: 10px 16px;">Save</button>
                                    <button class="btn" onclick="testSmsAlert()" style="padding: 10px 16px;">Test</button>
                                </div>
                                <div id="smsStatus" style="margin-top: 8px; font-size: 0.8rem;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Google Sheets -->
                    <div class="card" id="sheetsCard" style="border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 16px;">
                            <div style="width: 40px; height: 40px; background: #34a853; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.1rem;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                    <span style="font-weight: 600; font-size: 1rem;">Google Sheets</span>
                                    <span id="sheetsStatusBadge" style="font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: var(--bg-secondary); color: var(--text-muted);">Not connected</span>
                                </div>
                                <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">Auto-export reports to spreadsheets</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" class="form-input" id="googleSheetId" placeholder="Spreadsheet ID" style="font-family: 'Space Mono', monospace; font-size: 0.75rem; padding: 10px 12px;">
                                    <input type="email" class="form-input" id="googleServiceEmail" placeholder="Service account email" style="font-size: 0.8rem; padding: 10px 12px;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="saveSheetsSettings()" style="padding: 10px 16px;">Save</button>
                                    <button class="btn" onclick="testSheetsConnection()" style="padding: 10px 16px;">Test</button>
                                </div>
                                <div id="sheetsStatus" style="margin-top: 8px; font-size: 0.8rem;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Coming Soon -->
                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                        <div style="flex: 1; padding: 16px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 10px; text-align: center; opacity: 0.6;">
                            <div style="font-size: 1.2rem; margin-bottom: 4px;"></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Slack</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Coming soon</div>
                        </div>
                        <div style="flex: 1; padding: 16px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 10px; text-align: center; opacity: 0.6;">
                            <div style="font-size: 1.2rem; margin-bottom: 4px;"></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Zapier</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Coming soon</div>
                        </div>
                        <div style="flex: 1; padding: 16px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 10px; text-align: center; opacity: 0.6;">
                            <div style="font-size: 1.2rem; margin-bottom: 4px;"></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Make</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Coming soon</div>
                        </div>
                        <div style="flex: 1; padding: 16px; background: var(--bg-secondary); border: 1px dashed var(--border); border-radius: 10px; text-align: center; opacity: 0.6;">
                            <div style="font-size: 1.2rem; margin-bottom: 4px;"></div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">TikTok API</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Coming soon</div>
                        </div>
                    </div>
                </div>
            </div>
    
    <!-- Add Webhook Modal -->
    <div class="modal-overlay" id="webhookModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="webhookModalTitle">Add Discord Webhook</h3>
                <button class="modal-close" onclick="closeWebhookModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="webhookId">
                
                <div class="form-group">
                    <label class="form-label">Label *</label>
                    <input type="text" class="form-input" id="webhookLabel" placeholder="e.g., #wins, #alerts, #pc-updates">
                    <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; display: block;">A friendly name to identify this webhook</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Webhook URL *</label>
                    <input type="text" class="form-input" id="webhookUrl" placeholder="https://discord.com/api/webhooks/..." style="font-family: 'Space Mono', monospace; font-size: 0.8rem;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Use for</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="webhookForWins" style="width: 16px; height: 16px;">
                            <span style="font-size: 0.85rem;"> Wins & Milestones</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="webhookForAlerts" style="width: 16px; height: 16px;">
                            <span style="font-size: 0.85rem;"> Alerts & Issues</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="webhookForReports" style="width: 16px; height: 16px;">
                            <span style="font-size: 0.85rem;"> Weekly Reports</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="webhookForApplications" style="width: 16px; height: 16px;">
                            <span style="font-size: 0.85rem;"> New Applications</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Brand Filter (optional)</label>
                    <select class="form-input" id="webhookBrand">
                        <option value="all">All Brands</option>
                        <option value="physicians_choice">Physicians Choice only</option>
                        <option value="jiyu">JiYu only</option>
                        <option value="catakor">Cata-Kor only</option>
                        <option value="peach_slices">Peach Slices only</option>
                        <option value="yerba_magic">Yerba Magic only</option>
                    </select>
                    <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; display: block;">Only send notifications for this brand to this webhook</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeWebhookModal()">Cancel</button>
                <button class="btn" onclick="testWebhook()" style="margin-right: auto;"> Test</button>
                <button class="btn btn-primary" onclick="saveWebhook()">Save Webhook</button>
            </div>
        </div>
    </div>

            <!-- NOTIFICATIONS TAB -->
            <div id="settings-tab-notifications" class="settings-tab-content" style="display: none;">
                <div style="max-width: 900px;">
                    <!-- Event Types Explanation -->
                    <div class="card" style="border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 16px;"> Available Notification Events</div>
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 1.2rem;"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">Wins & Milestones</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Creator hits $1K+ GMV day, weekly top 3 performers, first sale for new creator</div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); align-self: center;">Triggers: Daily @ 9 PM</div>
                            </div>
                            <div style="display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 1.2rem;"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">Alerts & Issues</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Ghost creators (5+ days no post), retainer underperformers, declining trends</div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); align-self: center;">Triggers: Daily @ 10 AM</div>
                            </div>
                            <div style="display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 1.2rem;"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">Weekly Reports</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Full performance summary, GMV by brand, top/bottom creators, trends</div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); align-self: center;">Triggers: Monday @ 9 AM</div>
                            </div>
                            <div style="display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 1.2rem;"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">New Applications</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">When a creator submits an application to join</div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); align-self: center;">Triggers: Instant</div>
                            </div>
                        </div>
                    </div>

                    <!-- Discord Routing -->
                    <div class="card" style="border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="font-weight: 600; font-size: 1rem;"> Discord Routing</div>
                            <span style="font-size: 0.8rem; color: var(--text-muted);" id="discordRoutingStatus">No webhooks configured</span>
                        </div>
                        <div id="discordRoutingTable">
                            <div style="text-align: center; padding: 20px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 8px;">
                                Add webhooks in <a href="#" onclick="switchSettingsTab('integrations'); return false;" style="color: var(--accent);">Integrations</a> to configure Discord routing
                            </div>
                        </div>
                    </div>

                    <!-- Manual Triggers -->
                    <div class="card" style="border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 16px;"> Manual Triggers</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button class="btn" onclick="triggerWinsNotification()" style="padding: 14px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                <span style="font-size: 1.2rem;"></span>
                                <span>Send Today's Wins</span>
                            </button>
                            <button class="btn" onclick="triggerAlertsNotification()" style="padding: 14px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                <span style="font-size: 1.2rem;"></span>
                                <span>Send Current Alerts</span>
                            </button>
                            <button class="btn" onclick="triggerWeeklyReport()" style="padding: 14px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                <span style="font-size: 1.2rem;"></span>
                                <span>Send Weekly Report</span>
                            </button>
                        </div>
                    </div>

                    <!-- Notification Log -->
                    <div class="card" style="border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="font-weight: 600; font-size: 1rem;"> Recent Notifications</div>
                            <button class="btn btn-sm" onclick="clearNotificationLog()" style="font-size: 0.75rem; padding: 6px 12px;">Clear Log</button>
                        </div>
                        <div id="notificationLogContainer" style="max-height: 300px; overflow-y: auto;">
                            <div id="notificationLog" style="display: grid; gap: 8px;">
                                <div style="text-align: center; padding: 30px; color: var(--text-muted);">No notifications sent yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="settings-tab-reports" class="settings-tab-content" style="display: none;">
                <div style="max-width: 900px;">
                    <!-- Quick Report Generator -->
                    <div class="card" style="border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 16px;"> Quick Report Generator</div>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">Generate a shareable report page for any brand. Copy the link and send to clients.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 0.75rem;">Period</label>
                                <select id="quickReportPeriod" class="form-input" style="padding: 10px;">
                                    <option value="last7" selected>Last 7 Days</option>
                                    <option value="lastWeek">Last Week (Mon-Sun)</option>
                                    <option value="thisMonth">This Month</option>
                                    <option value="lastMonth">Last Month</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div id="customDateRange" style="display: none; grid-column: span 2;">
                                <div style="display: flex; gap: 12px;">
                                    <div class="form-group" style="margin: 0; flex: 1;">
                                        <label class="form-label" style="font-size: 0.75rem;">Start Date</label>
                                        <input type="date" id="quickReportStart" class="form-input" style="padding: 10px;">
                                    </div>
                                    <div class="form-group" style="margin: 0; flex: 1;">
                                        <label class="form-label" style="font-size: 0.75rem;">End Date</label>
                                        <input type="date" id="quickReportEnd" class="form-input" style="padding: 10px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-weight: 500; font-size: 0.85rem; margin-bottom: 12px; color: var(--text-secondary);">Select Brand to Generate Report</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;">
                            <button class="btn" onclick="openShareableReport('physicians_choice')" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: var(--bg-secondary);">
                                <img src="logos/physicians_choice.png" style="height: 32px; object-fit: contain;" onerror="this.style.display='none'">
                                <span style="font-size: 0.85rem;">Physicians Choice</span>
                            </button>
                            <button class="btn" onclick="openShareableReport('jiyu')" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: var(--bg-secondary);">
                                <img src="logos/jiyu.png" style="height: 32px; object-fit: contain;" onerror="this.style.display='none'">
                                <span style="font-size: 0.85rem;">JiYu</span>
                            </button>
                            <button class="btn" onclick="openShareableReport('peach_slices')" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: var(--bg-secondary);">
                                <img src="logos/peach_slices.png" style="height: 32px; object-fit: contain;" onerror="this.style.display='none'">
                                <span style="font-size: 0.85rem;">Peach Slices</span>
                            </button>
                            <button class="btn" onclick="openShareableReport('yerba_magic')" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: var(--bg-secondary);">
                                <img src="logos/yerba_magic.png" style="height: 32px; object-fit: contain;" onerror="this.style.display='none'">
                                <span style="font-size: 0.85rem;">Yerba Magic</span>
                            </button>
                            <button class="btn" onclick="openShareableReport('catakor')" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px; background: var(--bg-secondary);">
                                <span style="font-size: 1.5rem;"></span>
                                <span style="font-size: 0.85rem;">Cata-Kor</span>
                            </button>
                            <button class="btn btn-primary" onclick="openShareableReport('all')" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <span style="font-size: 1.5rem;"></span>
                                <span style="font-size: 0.85rem;">All Brands</span>
                            </button>
                        </div>
                    </div>

                    <!-- Recent Reports -->
                    <div class="card" style="border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="font-weight: 600; font-size: 1rem;"> Recent Reports</div>
                            <button class="btn btn-sm" onclick="clearReportHistory()" style="font-size: 0.75rem;">Clear History</button>
                        </div>
                        <div id="recentReportsList">
                            <div style="text-align: center; padding: 30px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 8px;">
                                No reports generated yet. Click a brand above to create one.
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Text Report (collapsed) -->
                    <details class="card" style="border-radius: 12px;">
                        <summary style="font-weight: 600; font-size: 1rem; cursor: pointer; padding: 4px 0;"> Text Report Generator (Legacy)</summary>
                        <div style="margin-top: 16px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">Generate a plain text report for Discord or copy/paste.</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Period</label>
                                    <select id="reportPeriod" class="form-input">
                                        <option value="last7">Last 7 Days</option>
                                        <option value="lastWeek" selected>Last Week (Mon-Sun)</option>
                                        <option value="thisMonth">This Month</option>
                                        <option value="lastMonth">Last Month</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select id="reportType" class="form-input">
                                        <option value="summary">Executive Summary</option>
                                        <option value="detailed">Detailed Report</option>
                                        <option value="brand">Brand-by-Brand</option>
                                        <option value="creator">Top Creators</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Brand</label>
                                    <select id="reportBrand" class="form-input">
                                        <option value="all">All Brands</option>
                                        <option value="catakor">Cata-Kor</option>
                                        <option value="jiyu">JiYu</option>
                                        <option value="physicians_choice">Physicians Choice</option>
                                        <option value="peach_slices">Peach Slices</option>
                                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 12px;">Include in Report</div>
                                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" id="reportIncludeGmv" checked> GMV & Revenue
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" id="reportIncludeCreators" checked> Top Creators
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" id="reportIncludeVideos" checked> Top Videos
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" id="reportIncludeProducts" checked> Top Products
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="generateWeeklyReport()"> Generate Text Report</button>
                            
                            <div id="reportPreview" style="display: none; margin-top: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h4 style="margin: 0;">Report Preview</h4>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-sm" onclick="copyReportToClipboard()"> Copy</button>
                                        <button class="btn btn-sm" onclick="sendReportToDiscord()"> Discord</button>
                                    </div>
                                </div>
                                <div id="reportContent" style="font-family: 'Space Mono', monospace; font-size: 0.85rem; white-space: pre-wrap; line-height: 1.6;"></div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- APPLICATION TAB -->
            <div id="settings-tab-application" class="settings-tab-content" style="display: none;">
                <!-- Brand Selector for Application Settings -->
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600;">Configure Application For:</div>
                    <select id="appSettingsBrandSelect" onchange="loadBrandAppSettings()" style="padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); font-weight: 500; min-width: 200px;">
                        <option value="default"> Default (All Brands)</option>
                        <option value="catakor"> Cata-Kor</option>
                        <option value="jiyu"> JiYu</option>
                        <option value="physicians_choice"> Physicians Choice</option>
                        <option value="peach_slices"> Peach Slices</option>
                        <option value="yerba_magic"> Yerba Magic</option>
                        <option value="toplux"> Toplux Nutrition</option>
                    </select>
                    <button class="btn" onclick="testApplyPageFromSettings()" style="margin-left: auto;"> Preview</button>
                </div>

                <div class="card">
                    <div class="card-title"><span></span> Branding & Appearance</div>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Customize the look and feel for this brand's application</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="appSettingsTitle" placeholder="Apply to Join [Brand Name]">
                            <small style="color: var(--text-muted); display: block; margin-top: 4px;">Header text shown on application page</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Subtitle / Tagline</label>
                            <input type="text" class="form-input" id="appSettingsSubtitle" placeholder="Partner with us and earn commissions on TikTok Shop">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Logo URL</label>
                            <input type="text" class="form-input" id="appSettingsLogo" placeholder="https://..." style="font-family: 'Space Mono', monospace; font-size: 0.85rem;">
                            <small style="color: var(--text-muted); display: block; margin-top: 4px;">Brand logo shown at top</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Primary Color</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="color" id="appSettingsColor" value="#f5c518" style="width: 50px; height: 38px; border: none; border-radius: 6px; cursor: pointer;">
                                <input type="text" class="form-input" id="appSettingsColorText" placeholder="#f5c518" style="font-family: 'Space Mono', monospace; font-size: 0.85rem; flex: 1;" oninput="document.getElementById('appSettingsColor').value = this.value">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title"><span></span> Videos</div>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Add welcome and thank-you videos to engage creators</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Welcome Video URL</label>
                            <input type="text" class="form-input" id="appSettingsWelcomeVideo" placeholder="https://www.youtube.com/embed/... or https://www.loom.com/share/..." style="font-family: 'Space Mono', monospace; font-size: 0.85rem;">
                            <small style="color: var(--text-muted); display: block; margin-top: 4px;">Shown at top of application form (YouTube, Loom, or direct MP4)</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Thank You Video URL</label>
                            <input type="text" class="form-input" id="appSettingsThankYouVideo" placeholder="https://www.youtube.com/embed/... or https://www.loom.com/share/..." style="font-family: 'Space Mono', monospace; font-size: 0.85rem;">
                            <small style="color: var(--text-muted); display: block; margin-top: 4px;">Shown after successful submission</small>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title"><span></span> Success Message</div>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Customize what creators see after applying</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Success Title</label>
                            <input type="text" class="form-input" id="appSettingsSuccessTitle" placeholder="Application Received! ">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Success Message</label>
                            <textarea class="form-input" id="appSettingsSuccessMsg" rows="3" placeholder="We'll review your application and get back to you within 24-48 hours..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-title"><span></span> Custom Form Fields</div>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Add brand-specific questions (in addition to standard fields)</p>
                    
                    <div id="customFieldsList" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                        <!-- Custom fields will be rendered here -->
                    </div>
                    
                    <button class="btn" onclick="addCustomField()">+ Add Custom Field</button>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-title"><span></span> Discord OAuth</div>
                    
                    <div class="form-group">
                        <label class="form-label">Discord Client ID</label>
                        <input type="text" class="form-input" id="appSettingsDiscordClientId" placeholder="123456789012345678" style="font-family: 'Space Mono', monospace; font-size: 0.85rem; max-width: 400px;">
                        <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                            From <a href="https://discord.com/developers/applications" target="_blank" style="color: var(--accent);">Discord Developer Portal</a>. Leave blank to use default.
                        </small>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                    <button class="btn btn-primary" onclick="saveBrandAppSettings()"> Save Settings</button>
                    <button class="btn" onclick="resetBrandAppSettings()"> Reset to Default</button>
                    <div id="appSettingsStatus" style="margin-left: 16px; display: flex; align-items: center;"></div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-title"><span></span> Quick Links</div>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Share these links with creators to direct them to brand-specific applications</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;" id="brandQuickLinks">
                        <!-- Generated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== PORTAL CONFIG ==================== -->
        <div id="view-portalconfig" class="view-section">
            <div class="header">
                <div>
                    <h1 class="header-title"> Portal Config</h1>
                    <p class="header-subtitle">Manage creator portal content</p>
                </div>
            </div>

            <!-- Sub-tabs -->
            <div class="period-selector" style="margin-bottom: 20px;">
                <button class="period-btn active" data-tab="campaigns" onclick="switchConfigTab('campaigns')"> Campaigns</button>
                <button class="period-btn" data-tab="faq" onclick="switchConfigTab('faq')"> FAQ</button>
                <button class="period-btn" data-tab="resources" onclick="switchConfigTab('resources')"> Resources</button>
            </div>

            <!-- CAMPAIGNS TAB -->
            <div id="configCampaignsTab" class="config-tab active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Brand Campaigns</div>
                        <button class="btn btn-primary" onclick="openAddCampaignModal()">+ Add Campaign</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Configure campaigns shown in "Join More Brands" on the creator portal.
                    </p>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Brand</th>
                                    <th>Name</th>
                                    <th>Commission</th>
                                    <th>Discord</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="campaignsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                        Loading campaigns...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FAQ TAB -->
            <div id="configFaqTab" class="config-tab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> FAQ Items</div>
                        <button class="btn btn-primary" onclick="openAddFaqModal()">+ Add FAQ</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Manage frequently asked questions shown on the Learn tab.
                    </p>
                    
                    <div id="faqItemsList">
                        <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                            Loading FAQ items...
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESOURCES TAB -->
            <div id="configResourcesTab" class="config-tab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Resources</div>
                        <button class="btn btn-primary" onclick="openAddResourceModal()">+ Add Resource</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Manage downloadable files like brand guidelines, product sheets, and sample scripts.
                    </p>
                    
                    <div id="resourcesList">
                        <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                            Loading resources...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Modal -->
        <div id="campaignModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="campaignModalTitle">Add Campaign</h3>
                    <button class="modal-close" onclick="closeCampaignModal()">&times;</button>
                </div>
                <form id="campaignForm" onsubmit="saveCampaign(event)">
                    <input type="hidden" id="campaignId">
                    <div class="form-group">
                        <label class="form-label">Brand Key *</label>
                        <input type="text" class="form-input" id="campaignBrand" placeholder="e.g., physicians_choice" required>
                        <small style="color: var(--text-muted);">Lowercase, use underscores. Must match brand key in system.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display Name *</label>
                        <input type="text" class="form-input" id="campaignName" placeholder="e.g., Physicians Choice" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="campaignDescription" placeholder="e.g., Probiotics & digestive health">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Commission Text *</label>
                        <input type="text" class="form-input" id="campaignCommission" placeholder="e.g., 10-15% commission" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label">Icon (emoji)</label>
                            <input type="text" class="form-input" id="campaignIcon" placeholder="e.g., " maxlength="4">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-input" id="campaignColor" value="#3b82f6" style="height: 42px; padding: 4px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Application URL</label>
                        <input type="text" class="form-input" id="campaignApplyUrl" placeholder="e.g., apply.html?brand=physicians_choice">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Discord Invite URL</label>
                        <input type="text" class="form-input" id="campaignDiscordUrl" placeholder="e.g., https://discord.gg/yourserver">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display Order</label>
                        <input type="number" class="form-input" id="campaignOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="campaignActive" checked> Active (visible to creators)
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="closeCampaignModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary"> Save Campaign</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- FAQ Modal -->
        <div id="faqModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="faqModalTitle">Add FAQ</h3>
                    <button class="modal-close" onclick="closeFaqModal()">&times;</button>
                </div>
                <form id="faqForm" onsubmit="saveFaq(event)">
                    <input type="hidden" id="faqId">
                    <div class="form-group">
                        <label class="form-label">Icon (emoji)</label>
                        <input type="text" class="form-input" id="faqIcon" placeholder="e.g., " maxlength="4">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Question *</label>
                        <input type="text" class="form-input" id="faqQuestion" placeholder="e.g., How do I get paid?" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Answer *</label>
                        <textarea class="form-input" id="faqAnswer" rows="4" placeholder="Enter the answer..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display Order</label>
                        <input type="number" class="form-input" id="faqOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="faqActive" checked> Active (visible to creators)
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="closeFaqModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary"> Save FAQ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resource Modal -->
        <div id="resourceModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="resourceModalTitle">Add Resource</h3>
                    <button class="modal-close" onclick="closeResourceModal()">&times;</button>
                </div>
                <form id="resourceForm" onsubmit="saveResource(event)">
                    <input type="hidden" id="resourceId">
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="resourceTitle" placeholder="e.g., Brand Guidelines PDF" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="resourceDescription" placeholder="e.g., Official brand colors, fonts, and usage rules">
                    </div>
                    <div class="form-group">
                        <label class="form-label">File URL *</label>
                        <input type="url" class="form-input" id="resourceFileUrl" placeholder="https://..." required>
                        <small style="color: var(--text-muted);">Upload to Google Drive/Dropbox and paste the public link</small>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label">Icon (emoji)</label>
                            <input type="text" class="form-input" id="resourceIcon" placeholder="e.g., " maxlength="4">
                        </div>
                        <div class="form-group">
                            <label class="form-label">File Type</label>
                            <select class="form-input" id="resourceFileType">
                                <option value="pdf">PDF</option>
                                <option value="doc">Document</option>
                                <option value="image">Image</option>
                                <option value="video">Video</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Brand (optional)</label>
                        <select class="form-input" id="resourceBrand">
                            <option value="">All Brands</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                        <small style="color: var(--text-muted);">Leave empty to show for all brands</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Display Order</label>
                        <input type="number" class="form-input" id="resourceOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="resourceActive" checked> Active (visible to creators)
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="closeResourceModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary"> Save Resource</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="view-payments" class="view-section">
            <!-- Loading Overlay -->
            <div id="payments-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading payments...</div>
                <div class="loading-subtext">Processing payment data</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header">
                <div>
                    <h1 class="header-title"> Payment Tracking</h1>
                    <p class="header-subtitle">Track creator retainers, top-ups, and bonuses</p>
                </div>
                <div class="header-actions">
                    <select id="paymentsPeriodFilter" onchange="loadPaymentsView()">
                        <!-- Populated by JS -->
                    </select>
                    <select id="paymentsBrandFilter" onchange="loadPaymentsView()">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <button class="btn btn-success" onclick="openAddPaymentModal()"> Add Payment</button>
                    <button class="btn btn-primary" onclick="openMonthlyReportModal()"> Monthly Report</button>
                    <button class="btn" onclick="openForecastModal()" style="background: var(--purple-dim); color: var(--purple); border: 1px solid var(--purple);"> Spend Forecast</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card highlight" onclick="filterPaymentsByStatus('pending')" style="cursor: pointer;">
                    <div class="stat-header"><div class="stat-icon yellow"></div></div>
                    <div class="stat-value" id="paymentsPendingTotal">$0</div>
                    <div class="stat-label">Pending Approval</div>
                </div>
                <div class="stat-card" onclick="filterPaymentsByStatus('approved')" style="cursor: pointer;">
                    <div class="stat-header"><div class="stat-icon blue"></div></div>
                    <div class="stat-value" id="paymentsApprovedTotal">$0</div>
                    <div class="stat-label">Ready to Pay</div>
                </div>
                <div class="stat-card" onclick="filterPaymentsByStatus('paid')" style="cursor: pointer;">
                    <div class="stat-header"><div class="stat-icon green"></div></div>
                    <div class="stat-value" id="paymentsPaidTotal">$0</div>
                    <div class="stat-label">Paid This Period</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><div class="stat-icon purple"></div></div>
                    <div class="stat-value" id="paymentsCount">0</div>
                    <div class="stat-label">Total Records</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                <button class="btn btn-sm ${''}" onclick="setPaymentsStatusFilter('all')" id="filterAll">All</button>
                <button class="btn btn-sm" onclick="setPaymentsStatusFilter('pending')" id="filterPending"> Pending</button>
                <button class="btn btn-sm" onclick="setPaymentsStatusFilter('approved')" id="filterApproved"> Approved</button>
                <button class="btn btn-sm" onclick="setPaymentsStatusFilter('paid')" id="filterPaid"> Paid</button>
                <button class="btn btn-sm" onclick="setPaymentsStatusFilter('rejected')" id="filterRejected"> Rejected</button>
                <div style="flex: 1;"></div>
                <button class="btn btn-sm btn-success" onclick="bulkApproveSelected()"> Approve Selected</button>
                <button class="btn btn-sm" style="background: var(--success); color: white;" onclick="bulkMarkPaidSelected()"> Mark Paid</button>
            </div>

            <!-- Payments Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span></span> Payment Records</div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="paymentsSearchInput" placeholder="Search creator..." 
                            style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 180px;"
                            onkeyup="filterPaymentsTable()">
                        <button class="btn btn-sm" onclick="exportPaymentsCSV()"> Export</button>
                    </div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                        <table>
                            <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="selectAllPayments" onchange="toggleAllPayments(this)"></th>
                                    <th>Creator</th>
                                    <th>Brand</th>
                                    <th>Type</th>
                                    <th style="text-align: right;">Amount</th>
                                    <th>Period</th>
                                    <th style="text-align: center;">ROI</th>
                                    <th>Status</th>
                                    <th>Dates</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr><td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Creators on Retainer (Quick Reference) -->
            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <div class="card-title"><span></span> Creators on Retainer (Quick Claim)</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="text" id="quickClaimSearch" placeholder="Search creator..." 
                            oninput="filterQuickClaimTable()"
                            style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; width: 200px;">
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Click to add retainer claim</span>
                    </div>
                </div>
                <div class="card-body" id="retainerCreatorsList" style="max-height: 400px; overflow-y: auto;">
                    <div style="color: var(--text-muted);">Loading...</div>
                </div>
            </div>
        </div>

        <!-- ==================== COMMISSIONS ==================== -->
        <div id="view-commissions" class="view-section">
            <!-- Loading Overlay -->
            <div id="commissions-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading commissions...</div>
                <div class="loading-subtext">Processing data</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            
            <div class="view-header">
                <div class="header-left">
                    <h1 class="header-title"> 1% Creator Commissions</h1>
                    <p class="header-subtitle">Calculate monthly commissions from affiliate orders</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="showBaselineRatesModal()"> Baseline Rates</button>
                    <button class="btn btn-primary" onclick="showUploadCommissionsModal()"> Upload Orders File</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                <button class="btn btn-sm active" id="commTabCalculator" onclick="switchCommissionsTab('calculator')"> Calculator</button>
                <button class="btn btn-sm" id="commTabHistory" onclick="switchCommissionsTab('history')"> History</button>
            </div>
            
            <!-- Calculator Tab -->
            <div id="commissions-calculator" class="commissions-tab-content">
                <!-- Upload Area -->
                <div id="commissionsUploadArea" style="background: var(--bg-card); border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 3rem; margin-bottom: 12px;"></div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Upload Affiliate Orders File</div>
                    <div style="color: var(--text-muted); margin-bottom: 16px;">CSV file from TikTok Shop (creator_order_all_*.csv)</div>
                    <button class="btn btn-primary" onclick="showUploadCommissionsModal()"> Select File</button>
                </div>
                
                <!-- Results Section (hidden initially) -->
                <div id="commissionsResults" style="display: none;">
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Period</div>
                            <div id="commPeriod" style="font-size: 1.1rem; font-weight: 700;">-</div>
                        </div>
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Creators (1%)</div>
                            <div id="commCreatorCount" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">0</div>
                        </div>
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Total GMV (1%)</div>
                            <div id="commTotalGmv" style="font-size: 1.5rem; font-weight: 700;">$0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--bg-card), rgba(34, 197, 94, 0.1)); border: 1px solid var(--success); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--success); text-transform: uppercase; margin-bottom: 4px;">Total Commission</div>
                            <div id="commTotalCommission" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">$0</div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="commSearchInput" placeholder="Search creators..." onkeyup="filterCommissionsTable()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); width: 250px;">
                            <select id="commBrandFilter" onchange="filterCommissionsTable()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="all">All Brands</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="exportCommissionsCSV()"> Export CSV</button>
                            <button class="btn btn-success btn-sm" onclick="saveCommissionsToDatabase()"> Save to Database</button>
                        </div>
                    </div>
                    
                    <!-- Results Table -->
                    <div style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="cursor: pointer;" onclick="sortCommissionsTable('creator')">Creator </th>
                                    <th>Brand</th>
                                    <th style="text-align: right; cursor: pointer;" onclick="sortCommissionsTable('orders')">Orders </th>
                                    <th style="text-align: right; cursor: pointer;" onclick="sortCommissionsTable('standardGmv')">Standard GMV </th>
                                    <th style="text-align: right; cursor: pointer;" onclick="sortCommissionsTable('shopAdsGmv')">Shop Ads GMV </th>
                                    <th style="text-align: right; cursor: pointer;" onclick="sortCommissionsTable('commission')">Commission </th>
                                </tr>
                            </thead>
                            <tbody id="commissionsTableBody">
                                <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">Upload a file to see results</td></tr>
                            </tbody>
                            <tfoot id="commissionsTableFoot" style="display: none;">
                                <tr style="background: var(--bg-secondary); font-weight: 700;">
                                    <td>TOTAL</td>
                                    <td></td>
                                    <td id="commFootOrders" style="text-align: right;">0</td>
                                    <td id="commFootStandardGmv" style="text-align: right;">$0</td>
                                    <td id="commFootShopAdsGmv" style="text-align: right;">$0</td>
                                    <td id="commFootCommission" style="text-align: right; color: var(--success);">$0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div id="commissions-history" class="commissions-tab-content" style="display: none;">
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <select id="historyBrandFilter" onchange="loadCommissionsHistory()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Brands</option>
                        <option value="jiyu">JiYu</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <select id="historyPeriodFilter" onchange="loadCommissionsHistory()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Periods</option>
                    </select>
                </div>
                
                <div style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden;">
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Brand</th>
                                <th>Creator</th>
                                <th style="text-align: right;">Orders</th>
                                <th style="text-align: right;">Total GMV</th>
                                <th style="text-align: right;">Commission</th>
                                <th style="text-align: right;">Calculated</th>
                            </tr>
                        </thead>
                        <tbody id="commissionsHistoryBody">
                            <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No commission history found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== ACTIVITY LOG ==================== -->
        <div id="view-activity" class="view-section">
            <!-- Loading Overlay -->
            <div id="activity-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading activity...</div>
                <div class="loading-subtext">Fetching activity log</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header">
                <div>
                    <h1 class="header-title"> Activity Log</h1>
                    <p class="header-subtitle">Track all system activities</p>
                </div>
                <div class="header-actions">
                    <select id="activityTypeFilter" onchange="loadActivityData()">
                        <option value="all">All Activities</option>
                        <option value="upload">Uploads</option>
                        <option value="payment">Payments</option>
                        <option value="edit">Edits</option>
                        <option value="note">Notes</option>
                        <option value="login">Logins</option>
                        <option value="export">Exports</option>
                    </select>
                    <select id="activityBrandFilter" onchange="loadActivityData()">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <button class="btn" onclick="loadActivityData()"> Refresh</button>
                </div>
            </div>

            <div class="card">
                <div class="card-body no-padding">
                    <div id="activityList" style="max-height: 70vh; overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading activity...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== APPLICATION FUNNELS ==================== -->
        <div id="view-funnels" class="view-section">
            <div class="header">
                <div>
                    <h1 class="header-title"> Application Funnels</h1>
                    <p class="header-subtitle">Build custom creator application forms</p>
                </div>
                <div class="header-actions">
                    <button class="btn" onclick="switchView('applications')"> Back to Applications</button>
                    <button class="btn btn-primary" onclick="openFunnelBuilder()">
                        <span></span> Create Funnel
                    </button>
                </div>
            </div>

            <!-- Funnels Grid -->
            <div id="funnelsGrid" class="funnels-grid">
                <div style="text-align: center; padding: 60px; color: var(--text-muted);">Loading funnels...</div>
            </div>
        </div>

        <!-- Funnel Builder Modal - Revamped -->
        <div id="funnelBuilderModal" class="modal-overlay">
            <div class="modal funnel-builder-modal" style="max-width: 1400px; height: 92vh; display: flex; flex-direction: column;">
                <div class="modal-header" style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="btn btn-sm" onclick="closeFunnelBuilder()"> Back</button>
                        <div>
                            <h2 id="funnelBuilderTitle" style="font-size: 1.1rem; margin: 0;">Create Application Funnel</h2>
                            <div id="funnelBuilderSubtitle" style="font-size: 0.85rem; color: var(--text-muted);">Design your creator application form</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <span id="funnelSaveStatus" style="font-size: 0.85rem; color: var(--text-muted);"></span>
                        <button class="btn" onclick="previewFunnelFullPage()"> Preview</button>
                        <button class="btn btn-primary" onclick="saveFunnel()"> Save</button>
                    </div>
                </div>
                
                <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0; display: flex;">
                    <!-- Left Sidebar - Block Palette -->
                    <div class="funnel-sidebar" style="width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column;">
                        <div style="padding: 16px; border-bottom: 1px solid var(--border);">
                            <div style="font-weight: 600; margin-bottom: 12px;"> Drag Blocks</div>
                            <div class="field-blocks-palette">
                                <div class="draggable-block" draggable="true" data-type="text" ondragstart="dragFieldStart(event, 'text')">
                                    <span class="block-icon">Aa</span>
                                    <span>Text Input</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="email" ondragstart="dragFieldStart(event, 'email')">
                                    <span class="block-icon"></span>
                                    <span>Email</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="tel" ondragstart="dragFieldStart(event, 'tel')">
                                    <span class="block-icon"></span>
                                    <span>Phone</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="tiktok" ondragstart="dragFieldStart(event, 'tiktok')">
                                    <span class="block-icon"></span>
                                    <span>TikTok Handle</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="select" ondragstart="dragFieldStart(event, 'select')">
                                    <span class="block-icon"></span>
                                    <span>Dropdown</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="textarea" ondragstart="dragFieldStart(event, 'textarea')">
                                    <span class="block-icon"></span>
                                    <span>Long Text</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="number" ondragstart="dragFieldStart(event, 'number')">
                                    <span class="block-icon">#</span>
                                    <span>Number</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="url" ondragstart="dragFieldStart(event, 'url')">
                                    <span class="block-icon"></span>
                                    <span>URL</span>
                                </div>
                                <div class="draggable-block" draggable="true" data-type="checkbox" ondragstart="dragFieldStart(event, 'checkbox')">
                                    <span class="block-icon"></span>
                                    <span>Checkbox</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Funnel Settings Accordion -->
                        <div style="flex: 1; overflow-y: auto;">
                            <div class="settings-section">
                                <div class="settings-section-header" onclick="toggleSettingsSection('basic')">
                                    <span> Basic Settings</span>
                                    <span class="settings-toggle"></span>
                                </div>
                                <div id="settingsSection-basic" class="settings-section-content show">
                                    <div class="form-group-sm">
                                        <label>Funnel Name</label>
                                        <input type="text" id="funnelName" class="form-input" placeholder="e.g., Toplux Creators" oninput="autoGenerateSlug()">
                                    </div>
                                    <div class="form-group-sm">
                                        <label>URL Slug</label>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span style="color: var(--text-muted); font-size: 0.85rem;">/apply?funnel=</span>
                                            <input type="text" id="funnelSlug" class="form-input" placeholder="toplux" style="flex: 1;">
                                        </div>
                                    </div>
                                    <div class="form-group-sm">
                                        <label>Brand</label>
                                        <select id="funnelBrand" class="form-input" onchange="updateFunnelPreview()">
                                            <option value="">All Brands (Generic)</option>
                                            <option value="catakor">Cata-Kor</option>
                                            <option value="jiyu">JiYu</option>
                                            <option value="physicians_choice">Physicians Choice</option>
                                            <option value="peach_slices">Peach Slices</option>
                                            <option value="yerba_magic">Yerba Magic</option>
                                            <option value="toplux">Toplux Nutrition</option>
                                        </select>
                                    </div>
                                    <div class="form-group-sm">
                                        <label>Status</label>
                                        <select id="funnelStatus" class="form-input">
                                            <option value="draft"> Draft</option>
                                            <option value="active"> Active</option>
                                            <option value="archived"> Archived</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-header" onclick="toggleSettingsSection('branding')">
                                    <span> Branding</span>
                                    <span class="settings-toggle"></span>
                                </div>
                                <div id="settingsSection-branding" class="settings-section-content">
                                    <div class="form-group-sm">
                                        <label>Primary Color</label>
                                        <div style="display: flex; gap: 8px;">
                                            <input type="color" id="funnelPrimaryColor" value="#f5c518" style="width: 44px; height: 36px; border: none; cursor: pointer; border-radius: 6px;" onchange="document.getElementById('funnelPrimaryColorText').value = this.value; updateFunnelPreview();">
                                            <input type="text" id="funnelPrimaryColorText" class="form-input" value="#f5c518" style="flex: 1; font-family: monospace;" oninput="document.getElementById('funnelPrimaryColor').value = this.value; updateFunnelPreview();">
                                        </div>
                                    </div>
                                    <div class="form-group-sm">
                                        <label>Header Title</label>
                                        <input type="text" id="funnelHeaderTitle" class="form-input" placeholder="Join Our Creator Team" oninput="updateFunnelPreview()">
                                    </div>
                                    <div class="form-group-sm">
                                        <label>Header Subtitle</label>
                                        <input type="text" id="funnelHeaderSubtitle" class="form-input" placeholder="Partner with us and earn" oninput="updateFunnelPreview()">
                                    </div>
                                    <div class="form-group-sm">
                                        <label>Logo URL</label>
                                        <input type="url" id="funnelLogoUrl" class="form-input" placeholder="https://..." oninput="updateFunnelPreview()">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-header" onclick="toggleSettingsSection('videos')">
                                    <span> Videos</span>
                                    <span class="settings-toggle"></span>
                                </div>
                                <div id="settingsSection-videos" class="settings-section-content">
                                    <div class="form-group-sm">
                                        <label>Welcome Video</label>
                                        <input type="url" id="funnelWelcomeVideo" class="form-input" placeholder="YouTube or direct URL">
                                    </div>
                                    <div class="form-group-sm">
                                        <label>Thank You Video</label>
                                        <input type="url" id="funnelThankYouVideo" class="form-input" placeholder="YouTube or direct URL">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-header" onclick="toggleSettingsSection('success')">
                                    <span> Success Page</span>
                                    <span class="settings-toggle"></span>
                                </div>
                                <div id="settingsSection-success" class="settings-section-content">
                                    <div class="form-group-sm">
                                        <label>Success Title</label>
                                        <input type="text" id="funnelSuccessTitle" class="form-input" placeholder="Application Received! ">
                                    </div>
                                    <div class="form-group-sm">
                                        <label>Success Message</label>
                                        <textarea id="funnelSuccessMessage" class="form-input" rows="2" placeholder="We'll review your application..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <div class="settings-section-header" onclick="toggleSettingsSection('discord')">
                                    <span> Discord OAuth</span>
                                    <span class="settings-toggle"></span>
                                </div>
                                <div id="settingsSection-discord" class="settings-section-content">
                                    <div class="form-group-sm">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="checkbox" id="funnelDiscordOAuth" style="width: 18px; height: 18px;" onchange="toggleDiscordSettings()">
                                            <span>Enable Discord Connect</span>
                                        </label>
                                    </div>
                                    <div id="discordOAuthSettings" style="display: none;">
                                        <div class="form-group-sm">
                                            <label>Discord Client ID</label>
                                            <input type="text" id="funnelDiscordClientId" class="form-input" placeholder="1234567890123456789">
                                        </div>
                                        <div class="form-group-sm">
                                            <label>Discord Server Link</label>
                                            <input type="url" id="funnelDiscordLink" class="form-input" placeholder="https://discord.gg/...">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Center - Form Builder Canvas -->
                    <div class="funnel-canvas" style="flex: 1; display: flex; flex-direction: column; background: var(--bg-primary);">
                        <div style="padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600;"> Form Fields</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm" onclick="addStep()">+ Add Step</button>
                            </div>
                        </div>
                        
                        <!-- Steps Tabs -->
                        <div id="stepsTabs" style="display: flex; gap: 4px; padding: 12px 20px; border-bottom: 1px solid var(--border); overflow-x: auto;">
                            <!-- Steps will be rendered here -->
                        </div>
                        
                        <!-- Fields Drop Zone -->
                        <div id="fieldsDropZone" class="fields-drop-zone" ondrop="dropField(event)" ondragover="dragOverField(event)" ondragleave="dragLeaveField(event)">
                            <div id="fieldsList" class="fields-list-new">
                                <!-- Fields will be rendered here -->
                            </div>
                            <div id="dropHint" class="drop-hint">
                                <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                                <div>Drag blocks here to add fields</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right - Live Preview -->
                    <div class="funnel-preview-panel" style="width: 380px; background: #1a1a2e; border-left: 1px solid var(--border); display: flex; flex-direction: column;">
                        <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: #fff;"> Live Preview</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="preview-device-btn active" onclick="setPreviewDevice('mobile')" title="Mobile"></button>
                                <button class="preview-device-btn" onclick="setPreviewDevice('desktop')" title="Desktop"></button>
                            </div>
                        </div>
                        <div id="funnelPreviewContainer" style="flex: 1; overflow-y: auto; display: flex; justify-content: center; padding: 20px;">
                            <div id="funnelPreview" class="preview-mobile">
                                <!-- Preview will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>

        <!-- Field Editor Modal -->
        <div id="fieldEditorModal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Edit Field</h2>
                    <button class="modal-close" onclick="closeFieldEditor()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editingFieldId">
                    <div class="form-group">
                        <label class="form-label">Label</label>
                        <input type="text" id="fieldLabel" class="form-input" placeholder="Field Label">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Field ID (for database)</label>
                        <input type="text" id="fieldId" class="form-input" placeholder="field_id">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select id="fieldType" class="form-input" onchange="toggleFieldOptions()">
                            <option value="text">Text</option>
                            <option value="email">Email</option>
                            <option value="tel">Phone</option>
                            <option value="url">URL</option>
                            <option value="number">Number</option>
                            <option value="select">Dropdown</option>
                            <option value="textarea">Text Area</option>
                            <option value="checkbox">Checkbox</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Placeholder</label>
                        <input type="text" id="fieldPlaceholder" class="form-input" placeholder="Placeholder text">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Step</label>
                        <select id="fieldStep" class="form-input">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Width</label>
                        <select id="fieldWidth" class="form-input">
                            <option value="full">Full Width</option>
                            <option value="half">Half Width</option>
                        </select>
                    </div>
                    <div class="form-group" id="fieldOptionsGroup" style="display: none;">
                        <label class="form-label">Options (one per line: value|label)</label>
                        <textarea id="fieldOptions" class="form-input" rows="5" placeholder="option1|Option 1&#10;option2|Option 2"></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="fieldRequired" style="width: 20px; height: 20px;">
                            <span>Required Field</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeFieldEditor()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveFieldEdit()">Save Field</button>
                </div>
            </div>
        </div>

        <!-- User Management View -->
        <div id="view-users" class="view-section">
            <!-- Loading Overlay -->
            <div id="users-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading users...</div>
                <div class="loading-subtext">Fetching user data</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            
            <div class="header">
                <div>
                    <h1 class="header-title"> User Management</h1>
                    <p class="header-subtitle">Manage internal team, creators, and brand clients</p>
                </div>
                <div class="header-actions">
                    <button class="btn" onclick="refreshUsersTab()"> Refresh</button>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                <div class="stat-card" onclick="switchUsersTab('internal')" style="cursor: pointer;">
                    <div class="stat-icon" style="background: var(--accent-dim); color: var(--accent);"></div>
                    <div>
                        <div class="stat-value" id="statInternalCount">0</div>
                        <div class="stat-label">Internal Team</div>
                    </div>
                </div>
                <div class="stat-card" onclick="switchUsersTab('creators')" style="cursor: pointer;">
                    <div class="stat-icon" style="background: var(--purple-dim); color: var(--purple);"></div>
                    <div>
                        <div class="stat-value" id="statCreatorsCount">0</div>
                        <div class="stat-label">Creators</div>
                    </div>
                </div>
                <div class="stat-card" onclick="switchUsersTab('brands')" style="cursor: pointer;">
                    <div class="stat-icon" style="background: var(--blue-dim); color: var(--blue);"></div>
                    <div>
                        <div class="stat-value" id="statBrandsCount">0</div>
                        <div class="stat-label">Brand Clients</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning-dim); color: var(--warning);"></div>
                    <div>
                        <div class="stat-value" id="statPendingTotal">0</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="ops-tabs" style="display: flex; gap: 2px; margin-bottom: 24px; background: var(--bg-secondary); padding: 4px; border-radius: 12px; width: fit-content; border: 1px solid var(--border);">
                <button class="ops-tab active" id="usersTab-internal-btn" onclick="switchUsersTab('internal')" style="padding: 10px 24px; border: none; background: var(--bg-card); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-primary); transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                     Internal Team
                    <span class="tab-badge" id="internalPendingBadge" style="display: none;">0</span>
                </button>
                <button class="ops-tab" id="usersTab-creators-btn" onclick="switchUsersTab('creators')" style="padding: 10px 24px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s;">
                     Creators
                    <span class="tab-badge" id="creatorsPendingBadge" style="display: none;">0</span>
                </button>
                <button class="ops-tab" id="usersTab-brands-btn" onclick="switchUsersTab('brands')" style="padding: 10px 24px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s;">
                     Brand Clients
                    <span class="tab-badge" id="brandsPendingBadge" style="display: none;">0</span>
                </button>
            </div>

            <!-- ==================== INTERNAL TEAM TAB ==================== -->
            <div id="usersTab-internal" class="users-tab-content">
                <div style="background: var(--purple-dim); color: var(--purple); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem;">
                     <strong>Internal Team</strong> - Your team members who access the admin dashboard. Invite via link, then approve and assign roles.
                </div>
                
                <!-- Pending Access Requests Section -->
                <div id="pendingAccessRequestsSection" style="display: none; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <h3 style="font-size: 1rem; font-weight: 600; margin: 0;"> Pending Access Requests</h3>
                        <span id="pendingRequestsCount" class="badge" style="background: var(--warning); color: #000;">0</span>
                    </div>
                    <div class="card" style="border: 1px solid var(--warning); background: rgba(245, 158, 11, 0.05);">
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Requested Role</th>
                                        <th>Reason</th>
                                        <th>Submitted</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingAccessRequestsBody">
                                    <tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <select id="internalStatusFilter" onchange="loadInternalTeam()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Status</option>
                        <option value="pending"> Pending</option>
                        <option value="approved"> Approved</option>
                        <option value="rejected"> Rejected</option>
                    </select>
                    <select id="internalRoleFilter" onchange="loadInternalTeam()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Roles</option>
                        <option value="admin"> Admin</option>
                        <option value="content_lead"> Content Lead</option>
                        <option value="analyst"> Analyst</option>
                        <option value="payments"> Payments</option>
                        <option value="automations"> Automations</option>
                        <option value="va"> VA</option>
                    </select>
                    <div style="flex: 1;"></div>
                    <button class="btn btn-primary" onclick="showInviteTeamModal()"> Invite Team Member</button>
                </div>
                
                <div class="card">
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="internalTeamBody">
                                <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ==================== CREATORS TAB ==================== -->
            <div id="usersTab-creators" class="users-tab-content" style="display: none;">
                <div style="background: var(--success-dim); color: var(--success); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem;">
                     <strong>Creators</strong> - Manage your creator roster. New creators apply  you approve  they get added to roster. Existing creators claim their accounts via Discord.
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <select id="rosterStatusFilter" onchange="loadCreatorsRoster()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Status</option>
                        <option value="Active"> Active</option>
                        <option value="Applied"> Applied</option>
                        <option value="Pending"> Pending</option>
                        <option value="Inactive"> Inactive</option>
                        <option value="Paused"> Paused</option>
                    </select>
                    <select id="rosterBrandFilter" onchange="loadCreatorsRoster()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <input type="text" id="rosterSearch" placeholder="Search by name or handle..." 
                        oninput="filterRosterTable()" 
                        style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); width: 200px;">
                    <div style="flex: 1;"></div>
                    <span style="color: var(--text-muted); font-size: 0.85rem;" id="rosterCountLabel">0 creators</span>
                </div>
                
                <!-- Sub-tabs for Creators -->
                <div style="display: flex; gap: 2px; margin-bottom: 16px; background: var(--bg-secondary); padding: 3px; border-radius: 10px; width: fit-content; border: 1px solid var(--border);">
                    <button id="creatorsSubTab-roster" onclick="switchCreatorsSubTab('roster')" style="padding: 8px 16px; border: none; background: var(--bg-card); border-radius: 7px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: var(--text-primary); transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                         Roster
                    </button>
                    <button id="creatorsSubTab-claims" onclick="switchCreatorsSubTab('claims')" style="padding: 8px 16px; border: none; background: transparent; border-radius: 7px; cursor: pointer; font-weight: 500; font-size: 0.85rem; color: var(--text-muted); transition: all 0.2s;">
                         Claim Requests
                        <span class="tab-badge" id="claimRequestsBadge" style="display: none;">0</span>
                    </button>
                    <button id="creatorsSubTab-requests" onclick="switchCreatorsSubTab('requests')" style="padding: 8px 16px; border: none; background: transparent; border-radius: 7px; cursor: pointer; font-weight: 500; font-size: 0.85rem; color: var(--text-muted); transition: all 0.2s;">
                         Account Requests
                        <span class="tab-badge" id="accountRequestsBadge" style="display: none;">0</span>
                    </button>
                    <button id="creatorsSubTab-applications" onclick="switchCreatorsSubTab('applications')" style="padding: 8px 16px; border: none; background: transparent; border-radius: 7px; cursor: pointer; font-weight: 500; font-size: 0.85rem; color: var(--text-muted); transition: all 0.2s;">
                         Applications
                        <span class="tab-badge" id="applicationsBadge" style="display: none;">0</span>
                    </button>
                </div>
                
                <!-- Roster Sub-tab -->
                <div id="creatorsSubContent-roster">
                    <div class="card">
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Creator</th>
                                        <th>TikTok Handle</th>
                                        <th>Brand</th>
                                        <th>Status</th>
                                        <th>Discord Linked</th>
                                        <th>Joined</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="creatorsRosterBody">
                                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Claim Requests Sub-tab -->
                <div id="creatorsSubContent-claims" style="display: none;">
                    <div style="background: var(--info-dim); color: var(--info); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem;">
                         Existing creators can claim their accounts by entering their TikTok handle. Approve requests to link their Discord to all their managed_creators records.
                    </div>
                    <div class="card">
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Discord User</th>
                                        <th>Claiming</th>
                                        <th>Total GMV</th>
                                        <th>Requested</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="claimRequestsBody">
                                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Account Requests Sub-tab -->
                <div id="creatorsSubContent-requests" style="display: none;">
                    <div style="background: var(--info-dim); color: var(--info); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem;">
                         When creators request to add a TikTok account that has existing sales data, it requires admin verification to prevent account hijacking.
                    </div>
                    <div class="card">
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Requester</th>
                                        <th>Requested Handle</th>
                                        <th>Has Data?</th>
                                        <th>Requested</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="creatorsRequestsBody">
                                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Applications Sub-tab -->
                <div id="creatorsSubContent-applications" style="display: none;">
                    <div style="background: var(--warning-dim); color: var(--warning); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem;">
                         <strong>New creator applications</strong> - When you approve, you'll assign them to a brand and they'll be added to the roster with their Discord already linked for instant portal access.
                    </div>
                    <div class="card">
                        <div class="card-body no-padding">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Applicant</th>
                                        <th>Email</th>
                                        <th>TikTok</th>
                                        <th>Followers</th>
                                        <th>Applied</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="creatorsApplicationsBody">
                                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== BRAND CLIENTS TAB ==================== -->
            <div id="usersTab-brands" class="users-tab-content" style="display: none;">
                <div style="background: var(--info-dim); color: var(--info); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem;">
                     <strong>Brand Clients</strong> - Your brand partners who view their own creator performance on the Brand Portal. Share the portal link, they sign in, you approve and assign their brand.
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <select id="brandsStatusFilter" onchange="loadBrandsTab()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Status</option>
                        <option value="pending"> Pending</option>
                        <option value="approved"> Approved</option>
                        <option value="denied"> Denied</option>
                    </select>
                    <select id="brandsBrandFilter" onchange="loadBrandsTab()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <div style="flex: 1;"></div>
                    <button class="btn" onclick="copyBrandPortalLink()"> Copy Portal Link</button>
                </div>
                
                <div class="card">
                    <div class="card-body no-padding">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Assigned Brand</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="brandsTableBody">
                                <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invite Team Modal -->
        <div id="inviteTeamModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h3> Invite Team Member</h3>
                    <button class="modal-close" onclick="hideInviteTeamModal()"></button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                        New team members must sign in with Discord first. Once they do, they'll appear in the pending list for you to approve and assign a role.
                    </p>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; text-align: center;">
                        <p style="margin-bottom: 12px; font-size: 0.9rem;">Share this link with your team member:</p>
                        <code style="background: var(--bg-primary); padding: 8px 12px; border-radius: 6px; display: block; word-break: break-all; font-size: 0.85rem;" id="adminPortalLink"></code>
                        <button class="btn btn-primary" style="margin-top: 12px;" onclick="copyAdminPortalLink()"> Copy Link</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Admin Modal -->
        <div id="addAdminModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: var(--bg-card); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; border: 1px solid var(--border);">
                <h3 style="margin-bottom: 16px;"> Add Portal Admin</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">Enter the Discord ID of the user you want to make an admin. They must have logged into the Brand Portal at least once.</p>
                <input type="text" id="newAdminDiscordId" placeholder="Discord ID (e.g. 131571520597262336)" 
                    style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9rem; margin-bottom: 16px;">
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn" onclick="hideAddAdminModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addPortalAdmin()">Add Admin</button>
                </div>
            </div>
        </div>

        <!-- Merge Creators Modal -->
        <div id="mergeCreatorsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: var(--bg-card); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 16px;"> Merge Creators</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">These creators will be linked with the same Discord ID. This is useful when the same person has different entries across brands.</p>
                
                <div id="mergePreview" style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 16px; max-height: 200px; overflow-y: auto;">
                    <!-- Selected creators will be listed here -->
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Discord ID to link all selected creators:</label>
                    <input type="text" id="mergeDiscordId" placeholder="Discord ID (e.g. 131571520597262336)" 
                        style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9rem;">
                </div>
                
                <div id="mergeStats" style="background: var(--accent-dim); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.85rem;">
                    <!-- Merge stats will be shown here -->
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn" onclick="hideMergeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="executeMerge()"> Merge Creators</button>
                </div>
            </div>
        </div>

        <!-- Applications View -->
        <div id="view-applications" class="view-section">
            <!-- Loading Overlay -->
            <div id="applications-loading" class="loading-overlay hidden">
                <div class="loading-spinner-container">
                    <div class="spinner-ring spinner-ring-pulse"></div>
                    <div class="spinner-ring spinner-ring-active"></div>
                    <div class="loading-icon"></div>
                </div>
                <div class="loading-text">Loading applications...</div>
                <div class="loading-subtext">Fetching applicant data</div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            <div class="header">
                <div>
                    <h1 class="header-title"> Creator Applications</h1>
                    <p class="header-subtitle">Review and approve new creator applications</p>
                </div>
                <div class="header-actions">
                    <select id="appStatusFilter" onchange="loadApplicationsData()">
                        <option value="all">All Status</option>
                        <option value="pending" selected>Pending</option>
                        <option value="reviewing">Reviewing</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                        <option value="waitlist">Waitlist</option>
                    </select>
                    <select id="appBrandFilter" onchange="loadApplicationsData()">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <button class="btn" onclick="loadApplicationsData()"> Refresh</button>
                    <button class="btn" onclick="switchView('funnels')"> Customize Forms</button>
                    <div class="dropdown" style="position: relative; display: inline-block;">
                        <button class="btn btn-primary" onclick="toggleApplyLinksDropdown()"> Copy Apply Link </button>
                        <div id="applyLinksDropdown" class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; min-width: 240px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100;">
                            <div style="padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 0.8rem; color: var(--text-muted);">Click to copy link</div>
                            <div class="dropdown-item" onclick="copyBrandLink('catakor')" style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                <span style="font-size: 1.1rem;"></span>
                                <span>Cata-Kor</span>
                            </div>
                            <div class="dropdown-item" onclick="copyBrandLink('jiyu')" style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                <span style="font-size: 1.1rem;"></span>
                                <span>JiYu</span>
                            </div>
                            <div class="dropdown-item" onclick="copyBrandLink('physicians_choice')" style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                <span style="font-size: 1.1rem;"></span>
                                <span>Physicians Choice</span>
                            </div>
                            <div class="dropdown-item" onclick="copyBrandLink('peach_slices')" style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                <span style="font-size: 1.1rem;"></span>
                                <span>Peach Slices</span>
                            </div>
                            <div class="dropdown-item" onclick="copyBrandLink('yerba_magic')" style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                <span style="font-size: 1.1rem;"></span>
                                <span>Yerba Magic</span>
                            </div>
                            <div class="dropdown-item" onclick="copyBrandLink('toplux')" style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                <span style="font-size: 1.1rem;"></span>
                                <span>Toplux Nutrition</span>
                            </div>
                            <div style="border-top: 1px solid var(--border);">
                                <div class="dropdown-item" onclick="copyBrandLink('')" style="padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-muted); transition: background 0.2s;">
                                    <span style="font-size: 1.1rem;"></span>
                                    <span>Generic (All Brands)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 24px;">
                <div class="stat-card" onclick="filterApplicationsByStatus('pending')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <div class="stat-icon" style="background: var(--warning-dim); color: var(--warning);"></div>
                    <div>
                        <div class="stat-value" id="statPendingApps">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                <div class="stat-card" onclick="filterApplicationsByStatus('reviewing')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <div class="stat-icon" style="background: var(--blue-dim); color: var(--blue);"></div>
                    <div>
                        <div class="stat-value" id="statReviewingApps">0</div>
                        <div class="stat-label">Reviewing</div>
                    </div>
                </div>
                <div class="stat-card" onclick="filterApplicationsByStatus('accepted')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <div class="stat-icon" style="background: var(--success-dim); color: var(--success);"></div>
                    <div>
                        <div class="stat-value" id="statAcceptedApps">0</div>
                        <div class="stat-label">Accepted</div>
                    </div>
                </div>
                <div class="stat-card" onclick="filterApplicationsByStatus('rejected')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <div class="stat-icon" style="background: var(--danger-dim); color: var(--danger);"></div>
                    <div>
                        <div class="stat-value" id="statRejectedApps">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
                <div class="stat-card" onclick="filterApplicationsByStatus('all')" style="cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <div class="stat-icon" style="background: var(--purple-dim); color: var(--purple);"></div>
                    <div>
                        <div class="stat-value" id="statTotalApps">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <!-- Bulk Actions Bar -->
                <div class="bulk-actions-bar" id="applicationsBulkActions">
                    <span class="bulk-select-count"><span id="applicationsSelectedCount">0</span> selected</span>
                    <div class="bulk-actions-buttons">
                        <button class="bulk-btn success" onclick="bulkApproveApplications()"> Approve All</button>
                        <button class="bulk-btn danger" onclick="bulkRejectApplications()"> Reject All</button>
                        <button class="bulk-btn" onclick="bulkExportApplications()"> Export</button>
                        <button class="bulk-btn" onclick="clearApplicationsSelection()"> Clear</button>
                    </div>
                </div>
                
                <div class="card-body no-padding">
                    <table class="data-table" id="applicationsTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" class="select-all-checkbox" onchange="toggleApplicationsSelectAll(this)"></th>
                                <th>Applicant</th>
                                <th>TikTok</th>
                                <th>Brand</th>
                                <th>Followers</th>
                                <th>Status</th>
                                <th>Applied</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading applications...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== DATA STATUS ==================== -->
        <div id="view-datastatus" class="view-section">
            <div class="header">
                <div>
                    <h1 class="header-title"> Data Status</h1>
                    <p class="header-subtitle">Check uploads and validate data accuracy</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="refreshDataStatusTab()"> Refresh</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs-container" style="margin-bottom: 24px;">
                <button class="tab active" onclick="switchDataStatusTab('uploads')" id="tab-uploads"> Upload Status</button>
                <button class="tab" onclick="switchDataStatusTab('validation')" id="tab-validation"> Data Validation</button>
            </div>

            <!-- Tab: Upload Status -->
            <div id="datastatus-uploads" class="datastatus-tab-content">
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <select id="dataStatusDays" class="filter-select" onchange="loadDataHealth()" style="min-width: 140px;">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                    <button class="btn" onclick="copyMissingDataList()"> Copy List</button>
                </div>

                <!-- Quick Status Banner -->
                <div id="dataStatusBanner" class="card" style="margin-bottom: 24px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div id="statusBannerIcon" style="font-size: 2.5rem;"></div>
                        <div>
                            <div id="statusBannerTitle" style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary);">All caught up!</div>
                            <div id="statusBannerSubtitle" style="color: var(--text-muted); margin-top: 4px;">No missing files to upload</div>
                        </div>
                    </div>
                </div>

                <!-- Action Required - Missing Files -->
                <div id="actionRequiredSection" class="card" style="margin-bottom: 24px; display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--warning-dim), var(--bg-card));">
                        <div class="card-title" style="color: var(--warning);">
                            <span></span> Action Required
                        </div>
                        <span class="badge" id="totalMissingBadge" style="background: var(--warning); color: var(--bg-primary);">0 files</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="actionRequiredList" style="max-height: 400px; overflow-y: auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Upload Checklist by Date -->
                <div id="uploadChecklistSection" class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title"><span></span> Upload Checklist</div>
                        <div style="display: flex; gap: 8px;">
                            <select id="checklistBrandFilter" class="filter-select" onchange="filterDataChecklist()" style="min-width: 120px;">
                                <option value="all">All Brands</option>
                                <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                    </div>
                </div>
                <div class="card-body" id="uploadChecklistBody" style="padding: 0;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success-dim); color: var(--success);"></div>
                    <div>
                        <div class="stat-value" id="dataCompleteCount">0</div>
                        <div class="stat-label">Complete Days</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning-dim); color: var(--warning);"></div>
                    <div>
                        <div class="stat-value" id="dataMissingCount">0</div>
                        <div class="stat-label">Missing Files</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--blue-dim); color: var(--blue);"></div>
                    <div>
                        <div class="stat-value" id="dataLatestDate">--</div>
                        <div class="stat-label">Latest Data</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--purple-dim); color: var(--purple);"></div>
                    <div>
                        <div class="stat-value" id="dataBrandsComplete">0/5</div>
                        <div class="stat-label">Brands Up-to-Date</div>
                    </div>
                </div>
            </div>

            <!-- Full Data Matrix (Collapsed by default) -->
            <details class="card">
                <summary class="card-header" style="cursor: pointer; list-style: none;">
                    <div class="card-title"><span></span> Full Data Matrix</div>
                    <span class="badge" id="dataMatrixCount" style="background: var(--bg-card);">0 rows</span>
                </summary>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Brand</th>
                                    <th style="text-align: center;">Creator</th>
                                    <th style="text-align: center;">Video</th>
                                    <th style="text-align: center;">Product</th>
                                    <th style="text-align: center;">Shop</th>
                                    <th style="text-align: center;">Affiliate</th>
                                    <th style="text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="dataStatusBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </details>
            </div> <!-- End uploads tab -->

            <!-- Tab: Data Validation -->
            <div id="datastatus-validation" class="datastatus-tab-content" style="display: none;">
                <!-- Loading Overlay -->
                <div id="validation-loading" class="loading-overlay hidden">
                    <div class="loading-spinner-container">
                        <div class="spinner-ring spinner-ring-pulse"></div>
                        <div class="spinner-ring spinner-ring-active"></div>
                        <div class="loading-icon"></div>
                    </div>
                    <div class="loading-text">Validating data...</div>
                    <div class="loading-subtext">Comparing affiliate totals vs creator data</div>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <select id="validationBrandFilter" class="filter-select" onchange="loadValidationData()">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <select id="validationDays" class="filter-select" onchange="loadValidationData()">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>

                <!-- Validation Status Banner -->
                <div id="validationBanner" class="card" style="margin-bottom: 24px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div id="validationBannerIcon" style="font-size: 2.5rem;"></div>
                        <div>
                            <div id="validationBannerTitle" style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary);">Click Refresh to load validation data</div>
                            <div id="validationBannerSubtitle" style="color: var(--text-muted); margin-top: 4px;">Comparing affiliate summary vs creator performance</div>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green"></div>
                        </div>
                        <div class="stat-value" id="validationMatchCount">0</div>
                        <div class="stat-label">Days Match</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon red"></div>
                        </div>
                        <div class="stat-value" id="validationMismatchCount">0</div>
                        <div class="stat-label">Days with Variance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon yellow"></div>
                        </div>
                        <div class="stat-value" id="validationTotalGmvVariance">$0</div>
                        <div class="stat-label">Total GMV Variance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue"></div>
                        </div>
                        <div class="stat-value" id="validationMissingAffiliate">0</div>
                        <div class="stat-label">Missing Affiliate Data</div>
                    </div>
                </div>

                <!-- Discrepancies Section -->
                <div id="validationDiscrepancies" class="card" style="margin-bottom: 24px; display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--danger-dim), var(--bg-card));">
                        <div class="card-title" style="color: var(--danger);">
                            <span></span> Discrepancies Found
                        </div>
                        <span class="badge" id="discrepancyCount" style="background: var(--danger); color: #fff;">0</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Brand</th>
                                        <th style="text-align: right;">GMV (Affiliate)</th>
                                        <th style="text-align: right;">GMV (Creator)</th>
                                        <th style="text-align: right;">Variance</th>
                                        <th style="text-align: right;">Variance %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="discrepancyBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Full Validation Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span></span> Validation Details</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-muted);">
                                <input type="checkbox" id="showOnlyDiscrepancies" onchange="filterValidationTable()">
                                Show only discrepancies
                            </label>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Brand</th>
                                        <th style="text-align: right;">Aff GMV</th>
                                        <th style="text-align: right;">CP GMV</th>
                                        <th style="text-align: right;">GMV </th>
                                        <th style="text-align: right;">Aff Items</th>
                                        <th style="text-align: right;">CP Items</th>
                                        <th style="text-align: right;">Aff Videos</th>
                                        <th style="text-align: right;">CP Videos</th>
                                        <th style="text-align: right;">Aff Comm</th>
                                        <th style="text-align: right;">CP Comm</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="validationTableBody">
                                    <tr>
                                        <td colspan="12" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                            Select filters and click Refresh to load validation data
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Brand Mismatch Scanner -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title"><span></span> Brand Mismatch Scanner</div>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="runBrandMismatchScan()">
                             Scan for Mismatches
                        </button>
                    </div>
                    <div class="card-body" id="brandMismatchResults">
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                            <p>Click "Scan for Mismatches" to find creators whose videos don't match their assigned brand.</p>
                            <p style="font-size: 0.8rem; margin-top: 8px;">This helps identify data that was uploaded under the wrong brand.</p>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title"><span></span> How Validation Works</div>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 8px;"> Affiliate Summary</h4>
                                <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.5;">
                                    Official daily totals from TikTok Shop's Affiliate Center. This is the <strong>source of truth</strong> for what actually happened on the platform.
                                </p>
                            </div>
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 8px;"> Creator Performance</h4>
                                <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.5;">
                                    Aggregated data from individual creator exports. Should <strong>sum up to match</strong> the affiliate totals if all data was captured correctly.
                                </p>
                            </div>
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 8px;"> Common Causes of Variance</h4>
                                <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.5;">
                                    Missing creator data, pagination limits, timing differences, or creators not tracked in your roster.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End validation tab -->
        </div>
    </main>

    <!-- Validation Drill-Down Modal -->
    <div class="modal-overlay" id="validationDrilldownModal">
        <div class="modal" style="max-width: 1100px; width: 95%;">
            <div class="modal-header">
                <h3 class="modal-title" id="drilldownTitle">Validation Drill-Down</h3>
                <button class="modal-close" onclick="closeValidationDrilldown()">&times;</button>
            </div>
            <div class="modal-body" id="drilldownBody" style="max-height: 80vh; overflow-y: auto;">
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    Loading creator data...
                </div>
            </div>
        </div>
    </div>

    <!-- Creator Detail Modal -->
    <div class="modal-overlay" id="creatorDetailModal">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header" style="display: flex; align-items: center; gap: 12px;">
                <h3 class="modal-title" id="creatorDetailTitle" style="flex: 1;">Creator Details</h3>
                <div id="creatorDetailActions" style="display: flex; gap: 8px;">
                    <!-- Populated dynamically -->
                </div>
                <button class="modal-close" onclick="closeCreatorDetail()">&times;</button>
            </div>
            <div class="modal-body" id="creatorDetailBody" style="max-height: 80vh; overflow-y: auto;">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Client Report Generator Modal -->
    <div class="modal-overlay" id="clientReportModal">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3 class="modal-title"> Generate Client Report</h3>
                <button class="modal-close" onclick="closeClientReportModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <p style="color: var(--text-muted); margin-bottom: 16px;">Generate a professional performance report to share with brand clients. Includes GMV summary, top creators, and top videos.</p>
                
                <!-- Brand & Date Selection -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label class="form-label">Brand</label>
                        <select id="clientReportBrand" class="form-input" onchange="updateReportBrandLogo()">
                            <option value="catakor"> Cata-Kor</option>
                            <option value="jiyu"> JiYu</option>
                            <option value="physicians_choice"> Physicians Choice</option>
                            <option value="peach_slices"> Peach Slices</option>
                            <option value="yerba_magic"> Yerba Magic</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Report Period</label>
                        <select id="clientReportPeriod" class="form-input" onchange="handleReportPeriodChange()">
                            <option value="last7">Last 7 Days</option>
                            <option value="last14">Last 14 Days</option>
                            <option value="last30" selected>Last 30 Days</option>
                            <option value="mtd">Month to Date</option>
                            <option value="lastmonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Date Range</label>
                        <input type="text" class="form-input date-range-input" id="clientReportDateRange" placeholder="Select dates" readonly style="cursor: pointer;">
                        <input type="hidden" id="clientReportStartDate">
                        <input type="hidden" id="clientReportEndDate">
                    </div>
                </div>
                
                <!-- White Label Options -->
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Branding:</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="reportIncludeBrandLogo" checked> Include Brand Logo
                            </label>
                            <div style="background: var(--bg-card); padding: 12px; border-radius: 8px; text-align: center; min-height: 70px; display: flex; align-items: center; justify-content: center;">
                                <img id="brandLogoImg" src="" alt="Brand Logo" style="max-height: 50px; max-width: 150px; display: none;">
                                <span id="brandLogoPlaceholder" style="color: var(--text-muted); font-size: 12px;">No logo uploaded</span>
                            </div>
                            <div style="margin-top: 8px;">
                                <label class="btn btn-secondary" style="display: inline-block; padding: 6px 12px; font-size: 12px; cursor: pointer;">
                                     Upload Logo
                                    <input type="file" id="brandLogoUpload" accept="image/*" style="display: none;" onchange="handleBrandLogoUpload(event)">
                                </label>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-left: 4px;" onclick="clearBrandLogo()"> Clear</button>
                            </div>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="reportIncludeAgencyLogo" checked> Include Agency Logo
                            </label>
                            <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; min-height: 70px; display: flex; align-items: center; justify-content: center;">
                                <img src="logo-dark.png" alt="Creators Corner" style="max-height: 50px; max-width: 150px;">
                            </div>
                            <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted);">Dark version for white backgrounds</div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Options -->
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Include in Report:</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeExecutiveSummary" checked>  Executive Summary
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeSummary" checked>  Summary Stats
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeWoW" checked>  Week-over-Week
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeHighlights" checked>  Top 3 Highlights
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeManaged" checked>  Managed vs Unmanaged
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeNewReturning" checked>  New vs Returning
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeDayOfWeek" checked>  Day of Week
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeDaily" checked>  Daily Breakdown
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeCreators" checked>  Top Creators (10)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeVideos" checked>  Top Videos (10)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reportIncludeProducts" checked>  Top Products (5)
                        </label>
                    </div>
                </div>
                
                <!-- Preview -->
                <div id="clientReportPreviewContainer" style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: none;">
                    <div style="background: var(--bg-secondary); padding: 12px 16px; font-weight: 600; border-bottom: 1px solid var(--border);">
                        Report Preview
                    </div>
                    <div id="clientReportPreview" style="padding: 24px; background: white; color: #1a1a1a; max-height: 400px; overflow-y: auto;">
                        <!-- Preview will be populated here -->
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="previewClientReport()"> Preview</button>
                    <button class="btn btn-primary" onclick="generateClientReport()"> Open Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Generator Modal -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3 class="modal-title"> Generate Brand Invoices</h3>
                <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <p style="color: var(--text-muted); margin-bottom: 16px;">Select brands to generate individual invoices for billing. Each invoice will include managed GMV, commission, retainer, and top performing creators.</p>
                
                <!-- Brand Selection -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" id="invoiceCatakor" checked>  Cata-Kor
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" id="invoiceJiyu" checked>  JiYu
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" id="invoicePC" checked>  Physicians Choice
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" id="invoicePeach" checked>  Peach Slices
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" id="invoiceYerba" checked>  Yerba Magic
                    </label>
                </div>
                
                <!-- Invoice Preview -->
                <div id="invoicePreviewContainer" style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                    <div style="background: var(--bg-secondary); padding: 12px 16px; font-weight: 600; border-bottom: 1px solid var(--border);">
                        Invoice Preview
                    </div>
                    <div id="invoicePreview" style="padding: 24px; background: white; color: #1a1a1a;">
                        <!-- Preview will be populated here -->
                        <p style="text-align: center; color: #666;">Click "Preview Invoice" to see a sample</p>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="previewInvoice()"> Preview Invoice</button>
                    <button class="btn btn-primary" onclick="generateAllInvoices()"> Generate All Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div class="modal-overlay" id="addPaymentModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"> Add Payment Record</h3>
                <button class="modal-close" onclick="closeAddPaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Creator</label>
                    <input type="text" id="addPaymentCreator" placeholder="@tiktokhandle" list="creatorSuggestions"
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                    <datalist id="creatorSuggestions"></datalist>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Brand</label>
                    <select id="addPaymentBrand" style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Payment Type</label>
                    <select id="addPaymentType" style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <option value="retainer">Retainer</option>
                        <option value="commission_topup">Commission Top-Up</option>
                        <option value="bonus">Bonus</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Amount ($)</label>
                    <input type="number" id="addPaymentAmount" placeholder="500" min="0" step="0.01"
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Period Month</label>
                    <input type="month" id="addPaymentPeriod" 
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Notes (optional)</label>
                    <textarea id="addPaymentNotes" placeholder="Any additional notes..." rows="2"
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddPaymentModal()">Cancel</button>
                <button class="btn btn-success" onclick="submitAddPayment()">Add Payment</button>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div id="videoPlayerModal" onclick="closeVideoPlayer()" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; padding: 20px; cursor: pointer;">
        <div onclick="event.stopPropagation()" style="position: relative; width: 100%; max-width: 400px; height: 90vh; max-height: 720px; cursor: default;">
            <button onclick="closeVideoPlayer()" style="position: absolute; top: -50px; right: 0; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 1.5rem; cursor: pointer; z-index: 10001; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">&times;</button>
            <div id="videoEmbedContainer" style="width: 100%; height: 100%; border-radius: 12px; overflow: hidden; background: #000;"></div>
            <div id="videoEmbedInfo" style="position: absolute; bottom: -40px; left: 0; right: 0; text-align: center; color: rgba(255,255,255,0.7); font-size: 0.85rem;"></div>
        </div>
    </div>

    <!-- Edit Payment Modal -->
    <div class="modal-overlay" id="editPaymentModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"> Edit Payment Record</h3>
                <button class="modal-close" onclick="closeEditPaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Creator</label>
                    <input type="text" id="editPaymentCreator" placeholder="Creator name"
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Brand</label>
                    <select id="editPaymentBrand" style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Payment Type</label>
                    <select id="editPaymentType" style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <option value="retainer">Retainer</option>
                        <option value="commission_topup">Commission Top-Up</option>
                        <option value="bonus">Bonus</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Amount ($)</label>
                    <input type="number" id="editPaymentAmount" placeholder="500" min="0" step="0.01"
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Period Month</label>
                    <input type="month" id="editPaymentPeriod" 
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Status</label>
                    <select id="editPaymentStatus" style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <option value="pending"> Pending</option>
                        <option value="approved"> Approved</option>
                        <option value="paid"> Paid</option>
                        <option value="rejected"> Rejected</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Notes (optional)</label>
                    <textarea id="editPaymentNotes" placeholder="Any additional notes..." rows="2"
                        style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditPaymentModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitEditPayment()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Spend Forecast Modal -->
    <div class="modal-overlay" id="forecastModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"> Monthly Spend Forecast</h3>
                <button class="modal-close" onclick="closeForecastModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center;">
                    <select id="forecastBrand" class="filter-select" onchange="generateForecast()" style="min-width: 180px;">
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <select id="forecastMonth" class="filter-select" onchange="generateForecast()" style="min-width: 180px;">
                    </select>
                </div>
                
                <div id="forecastContent" style="min-height: 300px;">
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        Select a brand and month to generate forecast...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeForecastModal()">Close</button>
                <button class="btn btn-primary" onclick="copyForecastToClipboard()"> Copy Summary</button>
            </div>
        </div>
    </div>

    <!-- Monthly Performance Report Modal -->
    <div class="modal-overlay" id="monthlyReportModal">
        <div class="modal" style="max-width: 1000px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title"> Monthly Performance & ROI Report</h3>
                <button class="modal-close" onclick="closeMonthlyReportModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
                <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                    <select id="reportBrand" class="filter-select" onchange="generateMonthlyReport()">
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <select id="reportMonth" class="filter-select" onchange="generateMonthlyReport()">
                        <!-- Populated by JS -->
                    </select>
                    <button class="btn btn-secondary" onclick="generateMonthlyReport()"> Generate</button>
                    <div style="flex: 1;"></div>
                    <button class="btn btn-secondary" onclick="downloadReportPDF()"> Download PDF</button>
                    <button class="btn btn-secondary" onclick="copyReportHTML()"> Copy HTML</button>
                </div>
                
                <!-- Report Preview -->
                <div id="monthlyReportPreview" style="background: white; border-radius: 8px; overflow: hidden; max-height: 60vh; overflow-y: auto;">
                    <div style="padding: 40px; text-align: center; color: #666;">
                        Select a brand and month, then click Generate
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add to Roster Modal -->
    <div class="modal-overlay" id="bulkAddModal">
        <div class="modal" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title"> Add Creators to Roster</h3>
                <button class="modal-close" onclick="closeBulkAddModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
                <!-- Batch Settings -->
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 12px;"> Batch Settings (apply to all)</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div>
                            <label class="form-label">Default Role</label>
                            <select id="bulkAddRole" class="form-input" onchange="applyBulkRole()">
                                <option value="Incubator">Incubator</option>
                                <option value="Closer">Closer</option>
                                <option value="Creatives">Creatives</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Default Status</label>
                            <select id="bulkAddStatus" class="form-input" onchange="applyBulkStatus()">
                                <option value="Active">Active</option>
                                
                                <option value="On Hold">On Hold</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Auto-Suggest Role</label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; cursor: pointer;">
                                <input type="checkbox" id="bulkAutoSuggestRole" checked onchange="recalculateSuggestedRoles()">
                                <span style="font-size: 0.85rem;">Based on GMV (>$500 = Closer)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Cross-brand hint -->
                <div id="crossBrandHint" style="display: none; background: var(--blue-dim); color: var(--blue); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem;">
                    <strong> Cross-Brand Match:</strong> <span id="crossBrandMessage"></span>
                </div>
                
                <!-- Creators Table -->
                <div style="border: 1px solid var(--border); border-radius: 10px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="text-align: left; padding: 12px; width: 30px;">
                                    <input type="checkbox" id="bulkSelectAll" checked onchange="toggleBulkSelectAll()">
                                </th>
                                <th style="text-align: left; padding: 12px;">TikTok</th>
                                <th style="text-align: left; padding: 12px;">Brand</th>
                                <th style="text-align: right; padding: 12px;">GMV</th>
                                <th style="text-align: left; padding: 12px;">Discord <span style="color: var(--danger);">*</span></th>
                                <th style="text-align: left; padding: 12px;">Role</th>
                                <th style="text-align: center; padding: 12px; width: 60px;">Match</th>
                            </tr>
                        </thead>
                        <tbody id="bulkAddTableBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary -->
                <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span id="bulkAddCount">0</span> creators selected
                        <span id="bulkAddWarning" style="color: var(--warning); margin-left: 12px; display: none;"> <span id="bulkAddWarningCount">0</span> missing Discord</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        Tip: Fill Discord names to properly track creators
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeBulkAddModal()">Cancel</button>
                <div style="display: flex; gap: 12px;">
                    <button class="btn" onclick="addBulkWithoutDiscord()" style="background: var(--warning); color: #1a1a1a;">
                         Quick Add (Skip Discord)
                    </button>
                    <button class="btn btn-primary" onclick="submitBulkAdd()">
                         Add to Roster
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div class="modal-overlay" id="csvImportModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"> Import Creators from CSV</h3>
                <button class="modal-close" onclick="closeCSVImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Instructions -->
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 8px;"> CSV Format</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                        Your CSV should have headers. Supported columns:
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem;">
                        <span style="background: var(--accent); color: #1a1a1a; padding: 4px 8px; border-radius: 4px;">tiktok *</span>
                        <span style="background: var(--bg-card); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border);">discord</span>
                        <span style="background: var(--bg-card); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border);">name</span>
                        <span style="background: var(--bg-card); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border);">email</span>
                        <span style="background: var(--bg-card); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border);">brand</span>
                        <span style="background: var(--bg-card); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border);">role</span>
                    </div>
                    <button class="btn btn-small" style="margin-top: 12px;" onclick="downloadCSVTemplate()"> Download Template</button>
                </div>
                
                <!-- File Upload -->
                <div style="border: 2px dashed var(--border); border-radius: 10px; padding: 32px; text-align: center; margin-bottom: 20px;" id="csvDropZone">
                    <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                    <div style="margin-bottom: 12px;">Drag & drop CSV file here or</div>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">Choose File</button>
                </div>
                
                <!-- Preview -->
                <div id="csvPreviewSection" style="display: none;">
                    <div style="font-weight: 600; margin-bottom: 12px;"> Preview (<span id="csvPreviewCount">0</span> rows)</div>
                    <div style="border: 1px solid var(--border); border-radius: 8px; max-height: 200px; overflow: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead id="csvPreviewHead"></thead>
                            <tbody id="csvPreviewBody"></tbody>
                        </table>
                    </div>
                    <div id="csvImportStats" style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 0.85rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCSVImportModal()">Cancel</button>
                <button class="btn btn-primary" id="csvImportBtn" onclick="executeCSVImport()" disabled> Import</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Creator Modal -->
    <div class="modal-overlay" id="creatorModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Creator</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="editCreatorId">
                
                <!-- Validation Error Banner -->
                <div id="creatorValidationError" style="display: none; background: var(--danger-dim); color: var(--danger); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem;">
                    <strong> Missing Required Fields:</strong>
                    <span id="creatorValidationMessage"></span>
                </div>
                
                <!-- Required Fields Notice -->
                <div style="background: var(--bg-secondary); padding: 10px 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem; color: var(--text-muted);">
                    <span style="color: var(--danger);">*</span> Required fields  Discord and TikTok are needed for roster tracking
                </div>
                
                <!-- Basic Info Section -->
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);"> Basic Info</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Real Name</label>
                            <input type="text" class="form-input" id="creatorRealName" placeholder="Enter real name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discord Name <span style="color: var(--danger);">*</span></label>
                            <input type="text" class="form-input" id="creatorDiscord" placeholder="Discord username" required onblur="checkExistingDiscord()">
                            <div id="existingCreatorHint" style="display: none; margin-top: 6px; padding: 8px 12px; background: var(--blue-dim); color: var(--blue); border-radius: 6px; font-size: 0.8rem;">
                                <strong> Existing Creator</strong>  <span id="existingCreatorBrands"></span>
                                <button type="button" onclick="autoFillFromDiscord()" style="margin-left: 8px; padding: 2px 8px; font-size: 0.75rem; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer;">Auto-Fill Info</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="creatorEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="creatorPhone" placeholder="(555) 123-4567">
                        </div>
                    </div>
                </div>

                <!-- Role & Status Section -->
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);"> Classification</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Brand <span style="color: var(--danger);">*</span></label>
                            <select class="form-input" id="creatorBrand" onchange="onCreatorBrandChange()">
                                <option value="catakor">Cata-Kor</option>
                                <option value="jiyu">JiYu</option>
                                <option value="physicians_choice">Physicians Choice</option>
                                <option value="peach_slices">Peach Slices</option>
                                <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select class="form-input" id="creatorRole">
                                <option value="Incubator">Incubator</option>
                                <option value="Closer">Closer</option>
                                <option value="Creatives">Creatives</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-input" id="creatorStatus">
                                <option value="Active">Active</option>
                                
                                <option value="On Hold">On Hold</option>
                                <option value="Churned">Churned</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Post Requirement</label>
                            <select class="form-input" id="creatorMonthlyPostReq" onchange="updateContractSummary()">
                                <option value="30">30 posts</option>
                                <option value="20">20 posts</option>
                                <option value="15">15 posts</option>
                                <option value="10">10 posts</option>
                                <option value="5">5 posts</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contract Length</label>
                            <select class="form-input" id="creatorContractLength" onchange="updateContractSummary()">
                                <option value="30">30 days (standard)</option>
                                <option value="45">45 days</option>
                                <option value="60">60 days</option>
                                <option value="90">90 days</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Contract Start Date</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" class="form-input" id="creatorRetainerStartDate" style="flex: 1;">
                                <button type="button" class="btn btn-sm" onclick="setContractStartToday()" title="Start new contract period today" style="padding: 8px; white-space: nowrap;"> Today</button>
                            </div>
                            <small style="color: var(--text-muted); display: block; margin-top: 4px;">When their current contract period began</small>
                        </div>
                        <div class="form-group">
                            <!-- Contract summary -->
                            <label class="form-label">Contract Summary</label>
                            <div id="contractSummary" style="padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.85rem; color: var(--text-muted);">
                                30 posts in 30 days
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics (shown when editing) -->
                    <div id="creatorPerformanceMetrics" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;">
                            <span> Performance Metrics (Last 90 Days)</span>
                            <button type="button" class="btn btn-sm" onclick="refreshCreatorMetrics()" style="padding: 4px 8px; font-size: 0.75rem;"></button>
                        </div>
                        <div id="creatorMetricsContent" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; font-size: 0.85rem;">
                            <div style="text-align: center;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">GMV</div>
                                <div id="metricGmv" style="font-weight: 700; color: var(--success);">$0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">Orders</div>
                                <div id="metricOrders" style="font-weight: 700;">0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">Last Active</div>
                                <div id="metricLastActive" style="font-weight: 700;"></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">Retainer ROI</div>
                                <div id="metricRetainerRoi" style="font-weight: 700;"></div>
                            </div>
                        </div>
                        <div id="creatorHealthIndicator" style="margin-top: 10px; padding: 8px; border-radius: 6px; font-size: 0.8rem; text-align: center;"></div>
                    </div>
                </div>
                
                <!-- Compensation Section -->
                <div id="compensationSection" style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 600; color: var(--text-secondary);"> Compensation</div>
                        <button type="button" class="btn btn-sm" onclick="showRetainerHistory()" title="View retainer history" style="padding: 4px 8px; font-size: 0.75rem;"> History</button>
                    </div>
                    
                    <!-- Base Brand Retainer -->
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 0.9rem;">Brand Base Retainer</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Monthly payment for overall brand work</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button type="button" id="baseAffiliateBtn" class="btn btn-sm" onclick="toggleBaseAffiliate()" style="padding: 4px 10px; font-size: 0.75rem;">
                                Affiliate
                            </button>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">$</span>
                                <input type="number" class="form-input" id="creatorRetainer" placeholder="0" value="0" style="width: 90px; padding: 6px 10px; text-align: right;" onchange="updateCompensationTotal()">
                                <span style="color: var(--text-muted); font-size: 0.75rem;">/mo</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Retainers (dynamically loaded) -->
                    <div id="productRetainersContainer" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Products will be loaded here -->
                    </div>
                    
                    <!-- Total -->
                    <div id="compensationTotalRow" style="display: none; margin-top: 12px; padding: 10px 12px; background: linear-gradient(135deg, var(--accent-dim), transparent); border-radius: 8px; border: 1px solid var(--accent);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Total Monthly</span>
                            <span id="compensationTotal" style="font-weight: 700; font-size: 1.1rem; color: var(--accent);">$0/mo</span>
                        </div>
                    </div>
                </div>

                <!-- CRM Section -->
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);"> Discord & Follow-up</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Discord Channel ID</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="form-input" id="creatorDiscordChannelId" placeholder="e.g. 1234567890123456789" style="flex: 1;">
                                <button type="button" class="btn btn-sm" onclick="testDiscordLink()" title="Test link" style="padding: 8px;"></button>
                            </div>
                            <small style="color: var(--text-muted); display: block; margin-top: 4px;">Right-click creator's coaching channel  Copy Link  paste channel ID</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discord User ID</label>
                            <input type="text" class="form-input" id="creatorDiscordUserId" placeholder="For @mentions (optional)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Last Contact Date</label>
                            <input type="date" class="form-input" id="creatorLastContact">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Next Follow-up Date</label>
                            <input type="date" class="form-input" id="creatorNextFollowup">
                        </div>
                    </div>
                </div>

                <!-- TikTok Accounts Section -->
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);"> TikTok Accounts</div>
                    <div class="form-group">
                        <label class="form-label">Primary Account <span style="color: var(--danger);">*</span></label>
                        <input type="text" class="form-input" id="creatorAccount1" placeholder="username (without @)" required onblur="checkCrossBrandTikTok()">
                        <div id="crossBrandTikTokHint" style="display: none; margin-top: 6px; padding: 8px 12px; background: var(--blue-dim); color: var(--blue); border-radius: 6px; font-size: 0.8rem;">
                            <strong> Found in other brand:</strong> <span id="crossBrandTikTokInfo"></span>
                            <button type="button" onclick="autoFillFromTikTok()" style="margin-left: 8px; padding: 2px 8px; font-size: 0.75rem; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer;">Copy Info</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Account 2</label>
                            <input type="text" class="form-input" id="creatorAccount2" placeholder="optional">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account 3</label>
                            <input type="text" class="form-input" id="creatorAccount3" placeholder="optional">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Account 4</label>
                            <input type="text" class="form-input" id="creatorAccount4" placeholder="optional">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account 5</label>
                            <input type="text" class="form-input" id="creatorAccount5" placeholder="optional">
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div>
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);"> Notes</div>
                    <div class="form-group">
                        <textarea class="form-input" id="creatorNotes" placeholder="Add notes about this creator..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCreator()">Save</button>
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Set Goal</h3>
                <button class="modal-close" onclick="closeGoalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Goal Type</label>
                    <select class="form-input" id="goalType">
                        <option value="overall">Overall (All Brands)</option>
                        <option value="brand">Specific Brand</option>
                    </select>
                </div>
                <div class="form-group" id="goalBrandGroup" style="display:none;">
                    <label class="form-label">Brand</label>
                    <select class="form-input" id="goalBrand">
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Period</label>
                    <select class="form-input" id="goalPeriod">
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target GMV ($)</label>
                    <input type="number" class="form-input" id="goalTargetGmv" placeholder="50000">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal-overlay" id="comparisonModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title"> Compare Periods</h3>
                <button class="modal-close" onclick="closeComparisonModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
                    <div>
                        <label class="form-label">Period A (Base)</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="compareStartA" placeholder="Start" readonly>
                            <input type="text" class="form-input" id="compareEndA" placeholder="End" readonly>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Period B (Compare)</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="compareStartB" placeholder="Start" readonly>
                            <input type="text" class="form-input" id="compareEndB" placeholder="End" readonly>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="runComparison()" style="margin-bottom: 20px;"> Compare</button>
                <div id="comparisonResults" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div class="card" style="margin: 0;">
                            <div class="card-title">Period A</div>
                            <div id="comparisonA"></div>
                        </div>
                        <div class="card" style="margin: 0;">
                            <div class="card-title">Period B</div>
                            <div id="comparisonB"></div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 16px;">
                        <div class="card-title"> Change Summary</div>
                        <div id="comparisonSummary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Subscriber Modal -->
    <div class="modal-overlay" id="subscriberModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="subscriberModalTitle">Add Subscriber</h3>
                <button class="modal-close" onclick="closeSubscriberModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editSubscriberId">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="subscriberName" placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="subscriberEmail" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone (with country code)</label>
                    <input type="tel" class="form-input" id="subscriberPhone" placeholder="+12125551234">
                </div>
                <div class="form-group">
                    <label class="form-label">Brand Filter</label>
                    <select class="form-input" id="subscriberBrand">
                        <option value="">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <small style="color: var(--text-muted); display: block; margin-top: 6px;">
                        Leave as "All Brands" to receive alerts for all brands
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">Notifications</label>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="subNotifyWins" checked> Daily Wins
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="subNotifyWeekly" checked> Weekly Summary
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="subNotifyAttention" checked> Attention Alerts
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="subNotifyGoals"> Goal Progress
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSubscriberModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSubscriber()">Save Subscriber</button>
            </div>
        </div>
    </div>

    <!-- Creator Notes Modal -->
    <div class="modal-overlay" id="notesModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title"> Creator Notes: <span id="notesCreatorName">-</span></h3>
                <button class="modal-close" onclick="closeNotesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="notesCreatorHandle">
                <input type="hidden" id="notesCreatorBrand">
                
                <!-- Add New Note -->
                <div class="form-group">
                    <label class="form-label">Add Note</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <select class="form-input" id="noteType" style="width: 140px;">
                            <option value="general"> General</option>
                            <option value="payment"> Payment</option>
                            <option value="performance"> Performance</option>
                            <option value="communication"> Communication</option>
                            <option value="urgent"> Urgent</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                            <input type="checkbox" id="notePinned"> Pin
                        </label>
                    </div>
                    <textarea class="form-input" id="noteText" rows="3" placeholder="Add a note about this creator..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveCreatorNote()" style="margin-bottom: 20px;"> Add Note</button>
                
                <!-- Existing Notes -->
                <div class="form-label">History</div>
                <div id="notesHistory" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-muted); padding: 20px;">No notes yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Match Modal -->
    <div class="modal-overlay" id="smartMatchModal">
        <div class="modal" style="max-width: 1000px; height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title"> Smart Match Tool</h3>
                <button class="modal-close" onclick="closeSmartMatchModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 0;">
                <!-- Tabs -->
                <div style="display: flex; border-bottom: 1px solid var(--border); background: var(--bg-secondary); flex-wrap: wrap;">
                    <button class="smart-match-tab active" onclick="switchSmartMatchTab('orphanPerformance')" id="tabOrphanPerformance">
                         Unlinked Performance
                        <span class="tab-count" id="orphanPerformanceCount">0</span>
                    </button>
                    <button class="smart-match-tab" onclick="switchSmartMatchTab('missingDiscord')" id="tabMissingDiscord">
                         Missing Discord
                        <span class="tab-count" id="missingDiscordTabCount">0</span>
                    </button>
                    <button class="smart-match-tab" onclick="switchSmartMatchTab('missingTikTok')" id="tabMissingTikTok">
                         Missing TikTok
                        <span class="tab-count" id="missingTikTokTabCount">0</span>
                    </button>
                    <button class="smart-match-tab" onclick="switchSmartMatchTab('missingName')" id="tabMissingName">
                         Missing Name
                        <span class="tab-count" id="missingNameTabCount">0</span>
                    </button>
                    <button class="smart-match-tab" onclick="switchSmartMatchTab('duplicates')" id="tabDuplicates">
                         Duplicates
                        <span class="tab-count" id="duplicatesTabCount">0</span>
                    </button>
                </div>
                
                <!-- Filter Bar -->
                <div style="padding: 12px 16px; background: var(--bg-primary); border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center;">
                    <select id="smartMatchBrandFilter" onchange="runSmartMatch()" style="padding: 6px 12px; border-radius: 6px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                    <input type="text" id="smartMatchSearch" placeholder="Search..." onkeyup="filterSmartMatchResults()" style="padding: 6px 12px; border-radius: 6px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); flex: 1; max-width: 250px;">
                    <div style="flex: 1;"></div>
                    <button class="btn btn-secondary" onclick="runSmartMatch()" style="padding: 6px 12px;"> Refresh</button>
                </div>
                
                <!-- Results Container -->
                <div id="smartMatchResults" style="flex: 1; overflow-y: auto; padding: 16px;">
                    <div class="loading"><div class="spinner"></div> Analyzing data...</div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                <div id="smartMatchSelectedCount" style="color: var(--text-muted);">0 selected</div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="closeSmartMatchModal()">Close</button>
                    <button class="btn btn-primary" onclick="applySmartMatches()" id="applyMatchesBtn" disabled>Apply Selected Matches</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Merge Entries Modal -->
    <div class="modal-overlay" id="mergeEntriesModal">
        <div class="modal" style="max-width: 900px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title"> Merge Duplicate Entries</h3>
                <button class="modal-close" onclick="closeMergeEntriesModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <p style="color: var(--text-muted); margin-bottom: 16px;">
                    These creators have multiple entries for the same brand. Select entries to merge into a single entry with multiple accounts.
                </p>
                <div id="mergeEntriesList">
                    <div class="loading"><div class="spinner"></div> Finding duplicates...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMergeEntriesModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Payment Status Modal -->
    <div class="modal-overlay" id="paymentStatusModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"> Update Payment: <span id="paymentCreatorName">-</span></h3>
                <button class="modal-close" onclick="closePaymentStatusModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="paymentRecordId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="paymentStatus">
                            <option value="pending"> Pending</option>
                            <option value="processing"> Processing</option>
                            <option value="paid"> Paid</option>
                            <option value="issue"> Issue</option>
                            <option value="hold"> On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-input" id="paymentMethod">
                            <option value="">Select...</option>
                            <option value="paypal">PayPal</option>
                            <option value="lumanu">Lumanu</option>
                            <option value="wire">Wire Transfer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Reference/Transaction ID</label>
                    <input type="text" class="form-input" id="paymentReference" placeholder="e.g., PayPal transaction ID">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="paymentNotes" rows="2" placeholder="Optional payment notes..."></textarea>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">GMV</div>
                            <div id="paymentGmv" style="font-weight: 700;">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Rate</div>
                            <div id="paymentRate" style="font-weight: 700;">0%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Amount</div>
                            <div id="paymentAmount" style="font-weight: 700; color: var(--accent);">$0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePaymentStatusModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePaymentStatus()"> Save</button>
            </div>
        </div>
    </div>

    <!-- Retainer History Modal -->
    <div class="modal-overlay" id="retainerHistoryModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title"> Retainer History</h3>
                <button class="modal-close" onclick="closeRetainerHistoryModal()">&times;</button>
            </div>
            <div class="modal-body" id="retainerHistoryContent" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRetainerHistoryModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Contact Log Modal -->
    <div class="modal-overlay" id="contactLogModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title"> Log Contact</h3>
                <button class="modal-close" onclick="closeContactLogModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="contactCreatorId">
                <input type="hidden" id="contactCreatorKey">
                <input type="hidden" id="contactCreatorBrandKey">
                <input type="hidden" id="contactCreatorChannelId">
                
                <!-- Creator Info with Discord Button -->
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;" id="contactCreatorName">Creator Name</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);" id="contactCreatorBrand">Brand</div>
                    </div>
                    <button class="btn btn-primary" onclick="openDiscordFromModal()" style="display: flex; align-items: center; gap: 6px;" id="contactDiscordBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
                        Open Discord
                    </button>
                </div>
                
                <!-- Message Templates -->
                <div style="margin-bottom: 16px;">
                    <label class="form-label" style="margin-bottom: 8px;">Quick Message Templates</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button type="button" class="btn btn-sm" onclick="useMessageTemplate('checkin')" style="font-size: 0.75rem;"> Check-in</button>
                        <button type="button" class="btn btn-sm" onclick="useMessageTemplate('warning')" style="font-size: 0.75rem; background: var(--warning-dim); color: var(--warning);"> Warning</button>
                        <button type="button" class="btn btn-sm" onclick="useMessageTemplate('final')" style="font-size: 0.75rem; background: var(--danger-dim); color: var(--danger);"> Final Notice</button>
                        <button type="button" class="btn btn-sm" onclick="useMessageTemplate('praise')" style="font-size: 0.75rem; background: var(--success-dim); color: var(--success);"> Great Job</button>
                    </div>
                    <div id="messagePreview" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">Message Preview:</span>
                            <button type="button" class="btn btn-sm" onclick="copyMessageToClipboard()" style="padding: 2px 8px; font-size: 0.7rem;"> Copy</button>
                        </div>
                        <div id="messageText" style="font-size: 0.9rem; white-space: pre-wrap;"></div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Method *</label>
                        <select class="form-input" id="contactMethod">
                            <option value="Discord">Discord</option>
                            <option value="Email">Email</option>
                            <option value="Phone">Phone Call</option>
                            <option value="Text">Text/SMS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-input" id="contactType">
                            <option value="Check-in">Check-in</option>
                            <option value="Warning"> Warning</option>
                            <option value="Final Notice"> Final Notice</option>
                            <option value="Positive Feedback"> Positive Feedback</option>
                            <option value="Contract Discussion"> Contract Discussion</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Outcome</label>
                    <select class="form-input" id="contactOutcome">
                        <option value="">-- Select Outcome --</option>
                        <option value="No Response">No Response (yet)</option>
                        <option value="Acknowledged">Acknowledged</option>
                        <option value="Committed to Improve">Committed to Improve</option>
                        <option value="Excuse Given">Excuse Given</option>
                        <option value="Dispute">Dispute / Pushback</option>
                        <option value="Positive">Positive Response</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="contactNotes" rows="3" placeholder="Brief summary of conversation..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Set Follow-up Date</label>
                    <input type="date" class="form-input" id="contactFollowup">
                </div>
                
                <!-- Contact History -->
                <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; font-size: 0.9rem;"> Contact History</h4>
                        <span style="font-size: 0.75rem; color: var(--text-muted);" id="contactHistoryCount">0 records</span>
                    </div>
                    <div id="contactHistoryList" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">No previous contacts</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeContactLogModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveContactLog()"> Save Contact</button>
            </div>
        </div>
    </div>
    
    <!-- Weekly Review Detail Modal -->
    <div class="modal-overlay" id="weeklyDetailModal">
        <div class="modal" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="weeklyDetailTitle"> Top Performers</h3>
                <button class="modal-close" onclick="closeWeeklyDetailModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Summary Stats -->
                <div id="weeklyDetailSummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border);">
                    <!-- Dynamically filled -->
                </div>
                
                <!-- Filter/Sort Bar -->
                <div id="weeklyDetailFilters" style="display: flex; gap: 12px; padding: 12px 16px; background: var(--bg-primary); border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 0.75rem; color: var(--text-muted);"></span>
                        <input type="text" id="weeklyDetailSearch" placeholder="Search creator..." 
                            style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem; width: 150px;"
                            oninput="applyWeeklyDetailFilters()">
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Brand:</span>
                        <select id="weeklyDetailBrand" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;" onchange="applyWeeklyDetailFilters()">
                            <option value="all">All Brands</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Retainer:</span>
                        <select id="weeklyDetailRetainer" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;" onchange="applyWeeklyDetailFilters()">
                            <option value="all">All</option>
                            <option value="has">With Retainer</option>
                            <option value="affiliate">Affiliate ($0)</option>
                            <option value="none">Not Set</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; margin-left: auto;">
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Sort:</span>
                        <select id="weeklyDetailSort" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;" onchange="applyWeeklyDetailFilters()">
                            <!-- Options populated dynamically based on type -->
                        </select>
                    </div>
                    <span id="weeklyDetailCount" style="font-size: 0.75rem; color: var(--text-muted);"></span>
                </div>
                
                <!-- Table -->
                <div class="table-container" style="max-height: 45vh; overflow-y: auto;">
                    <table>
                        <thead id="weeklyDetailHead">
                            <tr>
                                <th>Creator</th>
                                <th>Brand</th>
                                <th style="text-align: right;">GMV</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyDetailBody">
                            <tr><td colspan="5" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <button class="btn" onclick="exportWeeklyDetail()"> Export CSV</button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="copyWeeklyDetailForDiscord()"> Copy for Discord</button>
                    <button class="btn btn-secondary" onclick="closeWeeklyDetailModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Payment Modal -->
    <div class="modal-overlay" id="bulkPaymentModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"> Bulk Payment Update</h3>
                <button class="modal-close" onclick="closeBulkPaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Set Status For Selected</label>
                    <select class="form-input" id="bulkPaymentStatus">
                        <option value="processing"> Mark as Processing</option>
                        <option value="paid"> Mark as Paid</option>
                        <option value="hold"> Put on Hold</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select class="form-input" id="bulkPaymentMethod">
                        <option value="">Keep Existing</option>
                        <option value="paypal">PayPal</option>
                        <option value="lumanu">Lumanu</option>
                        <option value="wire">Wire Transfer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Reference (applied to all)</label>
                    <input type="text" class="form-input" id="bulkPaymentReference" placeholder="Batch payment reference">
                </div>
                
                <div style="background: var(--accent-dim); padding: 12px; border-radius: 8px; border: 1px solid rgba(245, 197, 24, 0.3);">
                    <div style="font-weight: 600; color: var(--accent);" id="bulkPaymentSummary">0 payments selected</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBulkPaymentModal()">Cancel</button>
                <button class="btn btn-primary" onclick="applyBulkPayment()"> Apply to Selected</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"> Edit User</h3>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                    <div id="editUserAvatar" style="width: 48px; height: 48px; border-radius: 50%; background: var(--accent-dim); border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--accent); font-size: 1.2rem;">?</div>
                    <div>
                        <div id="editUserName" style="font-weight: 600; font-size: 1.1rem;">User Name</div>
                        <div id="editUserEmail" style="font-size: 0.85rem; color: var(--text-muted);"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="editUserStatus">
                        <option value="pending"> Pending</option>
                        <option value="approved"> Approved</option>
                        <option value="rejected"> Rejected</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-input" id="editUserRole" onchange="toggleUserRoleFields()">
                        <option value="admin"> Admin</option>
                        <option value="content_lead"> Content Lead</option>
                        <option value="analyst"> Analyst</option>
                        <option value="payments"> Payments</option>
                        <option value="automations"> Automations</option>
                        <option value="va"> VA</option>
                        <option value="creator"> Creator</option>
                        <option value="brand"> Brand Client</option>
                    </select>
                </div>
                
                <div id="creatorFields">
                    <div class="form-group">
                        <label class="form-label">Creator Handle (TikTok @username)</label>
                        <input type="text" class="form-input" id="editCreatorHandle" placeholder="@username">
                    </div>
                </div>
                
                <div id="brandFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Assigned Brand</label>
                        <select class="form-input" id="editUserBrand">
                            <option value="">Select Brand...</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="jiyu">JiYu</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="rejectUser()" style="margin-right: auto;"> Reject</button>
                <button class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveUserChanges()"> Save</button>
            </div>
        </div>
    </div>

    <!-- Application Review Modal -->
    <!-- Generate Payments Modal -->
    <div class="modal-overlay" id="generatePaymentsModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--success-dim), var(--bg-card));">
                <h3 class="modal-title"> Generate Payments</h3>
                <button class="modal-close" onclick="closeGeneratePaymentsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Calculate commissions for managed creators based on their performance data and commission rates from the Roster.
                </p>
                
                <!-- Date Range -->
                <div class="form-group">
                    <label class="form-label">Pay Period</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="font-size: 0.75rem; color: var(--text-muted);">Start Date</label>
                            <input type="date" class="form-input" id="payPeriodStart">
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: var(--text-muted);">End Date</label>
                            <input type="date" class="form-input" id="payPeriodEnd">
                        </div>
                    </div>
                </div>
                
                <!-- Quick Select -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-sm" onclick="setPayPeriodLastWeek()">Last Week</button>
                    <button class="btn btn-sm" onclick="setPayPeriodLast2Weeks()">Last 2 Weeks</button>
                    <button class="btn btn-sm" onclick="setPayPeriodLastMonth()">Last Month</button>
                    <button class="btn btn-sm" onclick="setPayPeriodThisMonth()">This Month (so far)</button>
                </div>
                
                <!-- Brand Selection -->
                <div class="form-group">
                    <label class="form-label">Brands</label>
                    <select class="form-input" id="paymentsBrandSelect">
                        <option value="all">All Brands</option>
                        <option value="catakor">Cata-Kor</option>
                        <option value="jiyu">JiYu</option>
                        <option value="physicians_choice">Physicians Choice</option>
                        <option value="peach_slices">Peach Slices</option>
                        <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                    </select>
                </div>
                
                <!-- Preview -->
                <div id="paymentPreviewSection" style="display: none; margin-top: 20px;">
                    <div class="card" style="background: var(--bg-secondary);">
                        <div class="card-header" style="padding: 12px 16px;">
                            <div class="card-title" style="font-size: 0.9rem;"><span></span> Preview</div>
                        </div>
                        <div class="card-body" id="paymentPreviewBody" style="padding: 16px; max-height: 200px; overflow-y: auto;">
                            <!-- Preview populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="previewPayments()"> Preview</button>
                <button class="btn btn-secondary" onclick="closeGeneratePaymentsModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmGeneratePayments()"> Generate Payments</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="applicationModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));">
                <h3 class="modal-title"> Review Application</h3>
                <button class="modal-close" onclick="closeApplicationModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Content is dynamically generated by openApplicationModal() -->
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <div class="toast-content">
            <span class="toast-icon" id="toastIcon"></span>
            <span class="toast-message" id="toastMessage"></span>
            <button class="toast-close" onclick="hideToast()"></button>
        </div>
        <div class="toast-progress" id="toastProgress"></div>
    </div>
    
    <!-- Product Modal -->
    <!-- Create Product Group Modal -->
    <div class="modal-overlay" id="productGroupModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title" id="productGroupModalTitle"> Create Product Group</h3>
                <button class="modal-close" onclick="closeProductGroupModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <input type="hidden" id="productGroupId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Group Name *</label>
                        <input type="text" class="form-input" id="productGroupName" placeholder="e.g., Probiotics, Fiber Products">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Brand *</label>
                        <select class="form-input" id="productGroupBrand" onchange="loadProductsForGrouping()">
                            <option value="">Select Brand</option>
                            <option value="physicians_choice">Physicians Choice</option>
                            <option value="jiyu">JiYu</option>
                            <option value="catakor">Cata-Kor</option>
                            <option value="peach_slices">Peach Slices</option>
                            <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Products to Include</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <input type="text" id="groupProductSearch" class="form-input" placeholder=" Search products..." oninput="filterGroupProducts()" style="flex: 1;">
                        <button class="btn btn-sm" onclick="selectAllGroupProducts()" style="white-space: nowrap;">Select All</button>
                        <button class="btn btn-sm" onclick="deselectAllGroupProducts()" style="white-space: nowrap;">Clear</button>
                    </div>
                    <div id="groupProductsContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary);">
                        <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                            Select a brand to see available products
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <span id="groupSelectedCount" style="font-size: 0.85rem; color: var(--text-muted);">0 products selected</span>
                        <span id="groupSelectedGmv" style="font-size: 0.85rem; color: var(--success);">$0 combined GMV</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProductGroupModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProductGroup()"> Save Group</button>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()"></button>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://elrsgxlyejlkzjcnhmak.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscnNneGx5ZWpsa3pqY25obWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQ5OTUsImV4cCI6MjA3OTU5MDk5NX0.8XScMdGkFRqRIDMPY3gWS5tk0Z8NbGzDXuH1dsnBdZ0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==================== PAGINATION CONFIG ====================
        const QUERY_PAGE_SIZE = 30000; // Matches Supabase query limit setting
        const MAX_PAGES = 10; // 10 pages  30k = 300k rows max
        
        // Track if any query hit the pagination limit
        let dataLimitWarnings = new Set();
        
        // Helper function for paginated queries with limit detection
        async function fetchPaginated(tableName, selectFields, filters = {}, context = '') {
            let allData = [];
            let page = 0;
            let hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from(tableName)
                    .select(selectFields)
                    .range(page * QUERY_PAGE_SIZE, (page + 1) * QUERY_PAGE_SIZE - 1);
                
                // Apply filters
                if (filters.gte) {
                    for (const [field, value] of Object.entries(filters.gte)) {
                        query = query.gte(field, value);
                    }
                }
                if (filters.lte) {
                    for (const [field, value] of Object.entries(filters.lte)) {
                        query = query.lte(field, value);
                    }
                }
                if (filters.eq) {
                    for (const [field, value] of Object.entries(filters.eq)) {
                        query = query.eq(field, value);
                    }
                }
                
                const { data, error } = await query;
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    allData = allData.concat(data);
                    hasMore = data.length === QUERY_PAGE_SIZE;
                    page++;
                }
                
                if (page >= MAX_PAGES) {
                    // Hit the limit - show warning
                    const warningKey = `${context || tableName}`;
                    if (!dataLimitWarnings.has(warningKey)) {
                        dataLimitWarnings.add(warningKey);
                        console.warn(` Data limit reached for ${warningKey}: ${allData.length.toLocaleString()} rows fetched. Some data may be missing.`);
                        showDataLimitWarning(warningKey, allData.length);
                    }
                    break;
                }
            }
            
            return allData;
        }
        
        // Show warning toast when data limit is hit
        function showDataLimitWarning(context, rowCount) {
            showToast(` Data limit reached for ${context}: ${rowCount.toLocaleString()} rows. Some data may be incomplete.`, 'warning', 8000);
        }
        
        // Reset warnings (call when date range changes)
        function resetDataLimitWarnings() {
            dataLimitWarnings.clear();
        }

        // Constants
        const BRAND_DISPLAY = {
            'catakor': 'Cata-Kor',
            'jiyu': 'JiYu',
            'physicians_choice': 'Physicians Choice',
            'peach_slices': 'Peach Slices',
            'yerba_magic': 'Yerba Magic',
            'toplux': 'Toplux Nutrition'
        };

        // Brand colors for styling
        const BRAND_COLORS = {
            'catakor': '#e74c3c',
            'jiyu': '#9b59b6',
            'physicians_choice': '#3498db',
            'peach_slices': '#ff6b9d',
            'yerba_magic': '#2ecc71',
            'toplux': '#00b894'
        };

        // Centralized brand options - single source of truth
        const BRAND_OPTIONS = [
            { value: 'catakor', label: 'Cata-Kor' },
            { value: 'jiyu', label: 'JiYu' },
            { value: 'physicians_choice', label: 'Physicians Choice' },
            { value: 'peach_slices', label: 'Peach Slices' },
            { value: 'yerba_magic', label: 'Yerba Magic' },
            { value: 'toplux', label: 'Toplux Nutrition' }
        ];

        // Discord server IDs per brand
        const DISCORD_SERVERS = {
            'catakor': '1166776019655602236',
            'jiyu': '1339335585776533708',
            'physicians_choice': '1181985490363240499',
            'pc_fiber': '1440008662591733800',
            'peach_slices': '1431714262254092379',
            'yerba_magic': '1191766972208259173'
        };

        // Test Discord link from creator modal
        function testDiscordLink() {
            const channelId = document.getElementById('creatorDiscordChannelId').value.trim();
            const brand = document.getElementById('creatorBrand').value;
            
            if (!channelId) {
                showToast('Enter a Discord channel ID first', 'warning');
                return;
            }
            
            const serverId = DISCORD_SERVERS[brand];
            if (!serverId) {
                showToast('No Discord server configured for this brand', 'warning');
                return;
            }
            
            const url = `https://discord.com/channels/${serverId}/${channelId}`;
            window.open(url, '_blank');
        }

        // Open Discord chat in desktop app
        function openDiscordChat(brand, channelId) {
            if (!channelId) {
                showToast('No Discord channel linked for this creator', 'warning');
                return;
            }
            const serverId = DISCORD_SERVERS[brand];
            if (!serverId) {
                showToast('Discord server not configured for this brand', 'warning');
                return;
            }
            // Opens Discord desktop app directly
            window.location.href = `discord://discord.com/channels/${serverId}/${channelId}`;
        }

        // Look up channel ID from managed creators and open chat
        function openDiscordChatForCreator(creatorName, brand) {
            closeQuickActionMenu();
            const info = getManagedInfo(creatorName);
            if (!info) {
                showToast('Creator not found in roster', 'warning');
                return;
            }
            openDiscordChat(brand, info.discord_channel_id);
        }

        // Date presets for quick selection
        const DATE_PRESETS = [
            { label: 'Yesterday', getDates: () => { const d = new Date(); d.setDate(d.getDate()-1); const t = localDateStr(d); return { start: t, end: t }; }},
            { label: 'Last 7 Days', getDates: () => { const e = new Date(); e.setDate(e.getDate()-1); const s = new Date(); s.setDate(s.getDate()-7); return { start: localDateStr(s), end: localDateStr(e) }; }},
            { label: 'Last 14 Days', getDates: () => { const e = new Date(); e.setDate(e.getDate()-1); const s = new Date(); s.setDate(s.getDate()-14); return { start: localDateStr(s), end: localDateStr(e) }; }},
            { label: 'Last 30 Days', getDates: () => { const e = new Date(); e.setDate(e.getDate()-1); const s = new Date(); s.setDate(s.getDate()-30); return { start: localDateStr(s), end: localDateStr(e) }; }},
            { label: 'This Month', getDates: () => { const e = new Date(); e.setDate(e.getDate()-1); const s = new Date(e.getFullYear(), e.getMonth(), 1); return { start: localDateStr(s), end: localDateStr(e) }; }},
            { label: 'Last Month', getDates: () => { const n = new Date(); const e = new Date(n.getFullYear(), n.getMonth(), 0); const s = new Date(n.getFullYear(), n.getMonth()-1, 1); return { start: localDateStr(s), end: localDateStr(e) }; }}
        ];

        const TIERS = [
            { name: 'Ruby', min: 200000, class: 'tier-ruby' },
            { name: 'Diamond', min: 100000, class: 'tier-diamond' },
            { name: 'Platinum', min: 50000, class: 'tier-platinum' },
            { name: 'Gold', min: 20000, class: 'tier-gold' },
            { name: 'Silver', min: 5000, class: 'tier-silver' },
            { name: 'Bronze', min: 2000, class: 'tier-bronze' },
            { name: 'New', min: 0, class: 'tier-new' }
        ];

        function getTier(gmv) {
            for (const tier of TIERS) {
                if (gmv >= tier.min) return tier;
            }
            return TIERS[TIERS.length - 1];
        }

        // State
        let managedCreators = [];
        let availableDates = { daily: [] };
        let currentView = 'overview';

        const PAGE_SIZE = 50;
        let pages = { creators: 1, videos: 1, roster: 1, products: 1 };

        // ==================== LOADING INDICATORS ====================
        
        const loadingTimers = new Map();
        
        function showLoading(viewId, message = 'Loading...', delay = 300) {
            // For initial overview load, show immediately (no delay)
            const isInitialOverview = viewId === 'overview' && !window.overviewLoadedOnce;
            const actualDelay = isInitialOverview ? 0 : delay;
            
            // Only show loading indicator if it takes longer than delay ms
            const timer = setTimeout(() => {
                const overlay = document.getElementById(`${viewId}-loading`);
                if (overlay) {
                    const textEl = overlay.querySelector('.loading-text');
                    if (textEl) textEl.textContent = message;
                    overlay.classList.remove('hidden');
                }
            }, actualDelay);
            loadingTimers.set(viewId, timer);
        }
        
        function hideLoading(viewId) {
            // Clear the timer if loading finished quickly
            const timer = loadingTimers.get(viewId);
            if (timer) {
                clearTimeout(timer);
                loadingTimers.delete(viewId);
            }
            
            const overlay = document.getElementById(`${viewId}-loading`);
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
        
        function updateLoadingMessage(viewId, message, subtext = null) {
            const overlay = document.getElementById(`${viewId}-loading`);
            if (overlay) {
                const textEl = overlay.querySelector('.loading-text');
                const subtextEl = overlay.querySelector('.loading-subtext');
                if (textEl) textEl.textContent = message;
                if (subtextEl && subtext) subtextEl.textContent = subtext;
            }
        }

        // ==================== PERFORMANCE: CACHING & LAZY LOADING ====================
        
        // Enhanced cache for API responses with configurable TTL
        const cache = {
            data: new Map(),
            defaultTtl: 60000, // 1 minute default
            ttlConfig: {
                // Longer TTL for slow-changing data
                'managed_creators': 300000,  // 5 minutes
                'available_dates': 300000,   // 5 minutes
                'roster': 120000,            // 2 minutes
                'applications': 60000,       // 1 minute
                // Shorter TTL for fast-changing data
                'overview': 30000,           // 30 seconds
                'dailyops': 30000,           // 30 seconds
                'brands': 60000,             // 1 minute
            },
            set(key, value, customTtl) {
                const ttl = customTtl || this.ttlConfig[key] || this.defaultTtl;
                this.data.set(key, { value, timestamp: Date.now(), ttl });
                console.log(`Cache SET: ${key} (TTL: ${ttl/1000}s)`);
            },
            get(key) {
                const item = this.data.get(key);
                if (!item) return null;
                if (Date.now() - item.timestamp > item.ttl) {
                    this.data.delete(key);
                    console.log(`Cache EXPIRED: ${key}`);
                    return null;
                }
                console.log(`Cache HIT: ${key}`);
                return item.value;
            },
            invalidate(key) {
                if (key) {
                    this.data.delete(key);
                    console.log(`Cache INVALIDATED: ${key}`);
                } else {
                    this.data.clear();
                    console.log('Cache CLEARED');
                }
            },
            // Invalidate related caches when data changes
            invalidateGroup(group) {
                const groups = {
                    'creators': ['creators', 'overview', 'leaderboard', 'roster'],
                    'applications': ['applications', 'overview'],
                    'performance': ['overview', 'brands', 'dailyops', 'weeklyops', 'creators']
                };
                (groups[group] || []).forEach(k => this.data.delete(k));
            }
        };
        
        // Request deduplication - prevent duplicate simultaneous requests
        const pendingRequests = new Map();
        
        async function dedupedFetch(key, fetchFn) {
            // Check cache first
            const cached = cache.get(key);
            if (cached) return cached;
            
            // Check if request is already in flight
            if (pendingRequests.has(key)) {
                console.log(`Request DEDUPED: ${key}`);
                return pendingRequests.get(key);
            }
            
            // Make the request
            const promise = fetchFn().then(result => {
                cache.set(key, result);
                pendingRequests.delete(key);
                return result;
            }).catch(err => {
                pendingRequests.delete(key);
                throw err;
            });
            
            pendingRequests.set(key, promise);
            return promise;
        }
        
        // Debounce helper for filter inputs
        function debounce(fn, delay = 300) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }
        
        // Track which views have been loaded (for lazy loading)
        const viewsLoaded = new Set();
        
        // Lazy load helper - only loads if not already loaded or force refresh
        async function lazyLoadView(view, loadFn, forceRefresh = false) {
            if (!forceRefresh && viewsLoaded.has(view)) {
                console.log(`View already loaded: ${view}`);
                return;
            }
            await loadFn();
            viewsLoaded.add(view);
        }

        // Format helpers
        const fmt = (n) => n?.toLocaleString() || '0';
        const fmtMoney = (n) => '$' + (n || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        
        // Format retainer display - shows "Affiliate" badge for $0 retainers
        const fmtRetainer = (amount, showMonthly = false) => {
            if (amount === 0) return '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.7rem;">Affiliate</span>';
            if (!amount || amount === null) return '-';
            return `${fmtMoney(amount)}${showMonthly ? '/mo' : ''}`;
        };
        const fmtPct = (n) => (n >= 0 ? '+' : '') + n?.toFixed(1) + '%';
        
        // Format currency with 2 decimal places
        function formatCurrency(n) {
            if (n === null || n === undefined) return '--';
            return '$' + Math.abs(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Sanitize string to prevent XSS
        function sanitize(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Format brand key to display name
        function formatBrandName(brand) {
            return BRAND_DISPLAY[brand] || brand || 'Unknown';
        }
        
        // Trend indicator helper - updates element with trend arrow and percentage
        function updateTrendIndicator(elementId, current, prior) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            if (prior === 0 || prior === null || prior === undefined) {
                if (current > 0) {
                    el.textContent = ' New';
                    el.className = 'stat-change positive';
                } else {
                    el.textContent = '--';
                    el.className = 'stat-change neutral';
                }
                return;
            }
            
            const change = ((current - prior) / prior) * 100;
            const arrow = change > 0 ? '' : change < 0 ? '' : '';
            const sign = change > 0 ? '+' : '';
            
            el.textContent = `${arrow} ${sign}${change.toFixed(1)}%`;
            
            if (change > 5) {
                el.className = 'stat-change positive';
            } else if (change < -5) {
                el.className = 'stat-change negative';
            } else {
                el.className = 'stat-change neutral';
            }
        }
        
        // Parse helpers (Supabase returns strings for numeric columns)
        const pFloat = (v) => parseFloat(v) || 0;
        const pInt = (v) => parseInt(v) || 0;
        
        // Normalize TikTok handles - strip @, lowercase, trim
        function normalizeTikTok(handle) {
            if (!handle) return null;
            return handle.toLowerCase().replace(/^@/, '').trim() || null;
        }
        
        // Normalize Discord handles - lowercase, trim
        function normalizeDiscord(handle) {
            if (!handle) return null;
            return handle.toLowerCase().trim() || null;
        }

        // Convert Date to local YYYY-MM-DD string (timezone-safe)
        function localDateStr(date) {
            const d = date instanceof Date ? date : new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'undefined' || dateStr === 'null') {
                return 'No date selected';
            }
            try {
                const d = new Date(dateStr + 'T00:00:00');
                if (isNaN(d.getTime())) {
                    return 'Invalid date';
                }
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return 'Invalid date';
            }
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            document.getElementById('lastUpdated').textContent = `Last updated: ${timeStr}`;
        }

        // Show loading state in a container (different from overlay loading)
        function showContainerLoading(containerId) {
            const el = document.getElementById(containerId);
            if (el) {
                el.innerHTML = '<div class="loading"><div class="spinner"></div> Loading...</div>';
            }
        }

        // Show error state in a container
        function showError(containerId, message = 'Failed to load data') {
            const el = document.getElementById(containerId);
            if (el) {
                el.innerHTML = `<div class="empty-state"><div class="icon"></div><h3>Error</h3><p>${message}</p><button class="btn btn-secondary" onclick="location.reload()">Retry</button></div>`;
            }
        }

        // Populate brand dropdowns dynamically
        function populateBrandDropdowns() {
            const brandSelects = document.querySelectorAll('select[id$="BrandFilter"], select[id="creatorBrand"]');
            brandSelects.forEach(select => {
                // Keep existing options if it's a filter (has "All" option)
                const isFilter = select.querySelector('option[value="all"]');
                select.innerHTML = '';
                if (isFilter) {
                    select.innerHTML = '<option value="all">All Brands</option>';
                }
                BRAND_OPTIONS.forEach(brand => {
                    const opt = document.createElement('option');
                    opt.value = brand.value;
                    opt.textContent = brand.label;
                    select.appendChild(opt);
                });
            });
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        // Close mobile menu when nav item clicked
        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Close mobile menu on window resize to desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth > 900) {
                closeMobileMenu();
            }
        });

        // ==================== ROLE-BASED ACCESS CONTROL ====================
        const ROLE_ACCESS = {
            'admin': ['opscenter', 'dailyops', 'weeklyops', 'overview', 'brands', 'creators', 'videos', 'products', 'roster', 'applications', 'payments', 'commissions', 'calculator', 'funnels', 'users', 'brandportal', 'creatorportal', 'settings', 'goals', 'activity', 'datastatus'],
            'content_lead': ['opscenter', 'dailyops', 'weeklyops', 'overview', 'brands', 'creators', 'videos', 'products', 'roster', 'applications'],
            'analyst': ['overview', 'brands', 'creators', 'videos', 'products', 'roster'],
            'payments': ['roster', 'payments', 'commissions'],
            'automations': ['roster', 'settings'],
            'va': ['datastatus']
        };
        
        function canAccessView(viewName) {
            const role = window.currentUserRole || 'admin';
            const allowedViews = ROLE_ACCESS[role] || ROLE_ACCESS['admin'];
            return allowedViews.includes(viewName);
        }
        
        function applyRoleBasedNav(role) {
            const allowedViews = ROLE_ACCESS[role] || [];
            
            // Hide nav items user can't access
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                const view = item.getAttribute('data-view');
                if (!allowedViews.includes(view)) {
                    item.style.display = 'none';
                }
            });
            
            // Hide entire nav groups if all items are hidden
            document.querySelectorAll('.nav-group').forEach(group => {
                const visibleItems = group.querySelectorAll('.nav-item[data-view]:not([style*="display: none"])');
                if (visibleItems.length === 0) {
                    group.style.display = 'none';
                }
            });
            
            // Set default view based on role
            const defaultViews = {
                'admin': 'opscenter',
                'content_lead': 'opscenter',
                'analyst': 'overview',
                'payments': 'payments',
                'automations': 'roster',
                'va': 'datastatus'
            };
            
            const defaultView = defaultViews[role] || allowedViews[0] || 'overview';
            setTimeout(() => {
                const navItem = document.querySelector(`.nav-item[data-view="${defaultView}"]`);
                if (navItem) navItem.click();
            }, 100);
        }

        // ==================== DATA HEALTH CHECK ====================
        // Store data globally for filtering
        window.dataHealthRows = [];
        
        // File type display names and expected filenames
        const FILE_TYPES = {
            creator: { name: 'Creator Data', icon: '', table: 'creator_performance' },
            video: { name: 'Video Data', icon: '', table: 'video_performance' },
            product: { name: 'Product Data', icon: '', table: 'product_performance' },
            shop: { name: 'Shop Analytics', icon: '', table: 'shop_analytics' },
            affiliate: { name: 'Affiliate Data', icon: '', table: 'affiliate_summary' }
        };
        
        async function loadDataHealth() {
            try {
                const daysBack = parseInt(document.getElementById('dataStatusDays')?.value) || 7;
                
                // Calculate date range
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - 1); // Yesterday
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - daysBack);
                
                const startStr = localDateStr(startDate);
                const endStr = localDateStr(endDate);
                
                const brands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
                
                // Try RPC first, fallback to direct queries
                let allRows = [];
                
                const { data: rpcData, error: rpcError } = await supabaseClient.rpc('get_data_health_v2', { 
                    p_start_date: startStr, 
                    p_end_date: endStr 
                });
                
                if (!rpcError && rpcData && rpcData.length > 0) {
                    allRows = rpcData;
                } else {
                    // Fallback: Query each table directly
                    console.log('Using fallback data health queries');
                    
                    // Helper to normalize date from Supabase (might be ISO string or date)
                    const normalizeDate = (d) => {
                        if (!d) return '';
                        const str = String(d);
                        return str.includes('T') ? str.split('T')[0] : str.substring(0, 10);
                    };
                    
                    // Note: We need high limits because tables have many rows per date+brand
                    // We only care about distinct date+brand combos, so we'll dedupe into Sets
                    
                    // Get creator data dates
                    const { data: dateData } = await supabaseClient
                        .from('creator_performance')
                        .select('report_date, brand')
                        .gte('report_date', startStr)
                        .lte('report_date', endStr)
                        .eq('period_type', 'daily')
                        .limit(50000);
                    
                    // Build set of date+brand combos with creator data
                    const creatorSet = new Set();
                    (dateData || []).forEach(d => creatorSet.add(`${normalizeDate(d.report_date)}|${d.brand}`));
                    
                    // Get video data dates
                    const { data: videoData } = await supabaseClient
                        .from('video_performance')
                        .select('report_date, brand')
                        .gte('report_date', startStr)
                        .lte('report_date', endStr)
                        .eq('period_type', 'daily')
                        .limit(50000);
                    const videoSet = new Set();
                    (videoData || []).forEach(d => videoSet.add(`${normalizeDate(d.report_date)}|${d.brand}`));
                    
                    // Get product data dates
                    const { data: productData } = await supabaseClient
                        .from('product_performance')
                        .select('report_date, brand')
                        .gte('report_date', startStr)
                        .lte('report_date', endStr)
                        .eq('period_type', 'daily')
                        .limit(50000);
                    const productSet = new Set();
                    (productData || []).forEach(d => productSet.add(`${normalizeDate(d.report_date)}|${d.brand}`));
                    
                    // Get shop analytics dates
                    const { data: shopData } = await supabaseClient
                        .from('shop_analytics')
                        .select('report_date, brand')
                        .gte('report_date', startStr)
                        .lte('report_date', endStr)
                        .eq('period_type', 'daily')
                        .limit(50000);
                    const shopSet = new Set();
                    (shopData || []).forEach(d => shopSet.add(`${normalizeDate(d.report_date)}|${d.brand}`));
                    
                    // Get affiliate data dates (no period_type filter)
                    const { data: affiliateData } = await supabaseClient
                        .from('affiliate_summary')
                        .select('report_date, brand')
                        .gte('report_date', startStr)
                        .lte('report_date', endStr)
                        .limit(50000);
                    const affiliateSet = new Set();
                    (affiliateData || []).forEach(d => affiliateSet.add(`${normalizeDate(d.report_date)}|${d.brand}`));
                    
                    // Generate all expected date+brand combos
                    const allDates = [];
                    let currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        allDates.push(localDateStr(currentDate));
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    // Build the status matrix
                    allDates.forEach(date => {
                        brands.forEach(brand => {
                            const key = `${date}|${brand}`;
                            allRows.push({
                                report_date: date,
                                brand: brand,
                                has_creator: creatorSet.has(key),
                                has_video: videoSet.has(key),
                                has_product: productSet.has(key),
                                has_shop: shopSet.has(key),
                                has_affiliate: affiliateSet.has(key)
                            });
                        });
                    });
                }
                
                window.dataHealthRows = allRows;
                
                // Find rows with any missing data
                const missing = allRows.filter(row => 
                    !row.has_creator || !row.has_video || !row.has_product || !row.has_shop || !row.has_affiliate
                );
                
                // Build list of missing files with details
                const missingFiles = [];
                missing.forEach(row => {
                    const dateFormatted = formatDate(row.report_date);
                    if (!row.has_creator) missingFiles.push({ date: row.report_date, dateFormatted, brand: row.brand, type: 'creator' });
                    if (!row.has_video) missingFiles.push({ date: row.report_date, dateFormatted, brand: row.brand, type: 'video' });
                    if (!row.has_product) missingFiles.push({ date: row.report_date, dateFormatted, brand: row.brand, type: 'product' });
                    if (!row.has_shop) missingFiles.push({ date: row.report_date, dateFormatted, brand: row.brand, type: 'shop' });
                    if (!row.has_affiliate) missingFiles.push({ date: row.report_date, dateFormatted, brand: row.brand, type: 'affiliate' });
                });
                
                // Store for copy function
                window.missingFilesList = missingFiles;
                
                // Count complete days (all 5 brands complete for that day)
                const dateCompleteness = {};
                allRows.forEach(row => {
                    if (!dateCompleteness[row.report_date]) {
                        dateCompleteness[row.report_date] = { total: 0, complete: 0 };
                    }
                    dateCompleteness[row.report_date].total++;
                    if (row.has_creator && row.has_video && row.has_product && row.has_shop && row.has_affiliate) {
                        dateCompleteness[row.report_date].complete++;
                    }
                });
                
                const completeDays = Object.values(dateCompleteness).filter(d => d.complete === d.total).length;
                
                // Get latest date with creator data
                const latestDate = allRows.filter(r => r.has_creator).sort((a, b) => b.report_date.localeCompare(a.report_date))[0]?.report_date;
                
                // Count brands up-to-date (has data for yesterday)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = localDateStr(yesterday);
                const brandsUpToDate = brands.filter(brand => 
                    allRows.some(r => r.brand === brand && r.report_date === yesterdayStr && r.has_creator)
                ).length;
                
                // Update stats
                document.getElementById('dataCompleteCount').textContent = completeDays;
                document.getElementById('dataMissingCount').textContent = missingFiles.length;
                document.getElementById('dataLatestDate').textContent = latestDate ? formatDate(latestDate).split(',')[0] : '--';
                document.getElementById('dataBrandsComplete').textContent = `${brandsUpToDate}/5`;
                
                const matrixCountEl = document.getElementById('dataMatrixCount');
                if (matrixCountEl) matrixCountEl.textContent = `${allRows.length} cells`;
                
                // Update status banner
                const bannerIcon = document.getElementById('statusBannerIcon');
                const bannerTitle = document.getElementById('statusBannerTitle');
                const bannerSubtitle = document.getElementById('statusBannerSubtitle');
                const banner = document.getElementById('dataStatusBanner');
                
                if (missingFiles.length === 0) {
                    banner.style.background = 'linear-gradient(135deg, var(--success-dim), var(--bg-card))';
                    bannerIcon.textContent = '';
                    bannerTitle.textContent = 'All caught up!';
                    bannerTitle.style.color = 'var(--success)';
                    bannerSubtitle.textContent = `All ${daysBack} days have complete data for all brands`;
                } else {
                    // Check how urgent
                    const recentMissing = missingFiles.filter(f => {
                        const daysAgo = Math.floor((new Date() - new Date(f.date)) / (1000 * 60 * 60 * 24));
                        return daysAgo <= 2;
                    });
                    
                    if (recentMissing.length > 0) {
                        banner.style.background = 'linear-gradient(135deg, var(--danger-dim), var(--bg-card))';
                        bannerIcon.textContent = '';
                        bannerTitle.textContent = `${recentMissing.length} urgent file${recentMissing.length > 1 ? 's' : ''} needed!`;
                        bannerTitle.style.color = 'var(--danger)';
                        bannerSubtitle.textContent = `Recent data is missing - upload these first`;
                    } else {
                        banner.style.background = 'linear-gradient(135deg, var(--warning-dim), var(--bg-card))';
                        bannerIcon.textContent = '';
                        bannerTitle.textContent = `${missingFiles.length} file${missingFiles.length > 1 ? 's' : ''} to upload`;
                        bannerTitle.style.color = 'var(--warning)';
                        bannerSubtitle.textContent = `Some older data is incomplete`;
                    }
                }
                
                // Update action required section
                const actionSection = document.getElementById('actionRequiredSection');
                const actionList = document.getElementById('actionRequiredList');
                
                if (missingFiles.length > 0) {
                    actionSection.style.display = 'block';
                    document.getElementById('totalMissingBadge').textContent = `${missingFiles.length} files`;
                    
                    // Group by date, sorted newest first
                    const byDate = {};
                    missingFiles.forEach(f => {
                        if (!byDate[f.date]) byDate[f.date] = [];
                        byDate[f.date].push(f);
                    });
                    
                    actionList.innerHTML = Object.entries(byDate)
                        .sort((a, b) => b[0].localeCompare(a[0]))
                        .map(([date, files]) => {
                            const daysAgo = Math.floor((new Date() - new Date(date)) / (1000 * 60 * 60 * 24));
                            const urgencyLabel = daysAgo === 0 ? ' TODAY' : daysAgo === 1 ? ' Yesterday' : daysAgo <= 3 ? ' Recent' : '';
                            
                            return `
                                <div class="action-date-group" style="border-bottom: 1px solid var(--border-light); padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-weight: 600; color: var(--text-primary);">${formatDate(date)}</div>
                                        ${urgencyLabel ? `<span class="badge" style="background: ${daysAgo <= 1 ? 'var(--danger)' : daysAgo <= 3 ? 'var(--warning)' : 'var(--text-muted)'}; font-size: 0.7rem;">${urgencyLabel}</span>` : ''}
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${files.map(f => `
                                            <div class="missing-file-chip" style="
                                                display: inline-flex;
                                                align-items: center;
                                                gap: 6px;
                                                padding: 8px 12px;
                                                background: var(--bg-secondary);
                                                border-radius: 8px;
                                                font-size: 0.85rem;
                                                border: 1px solid var(--border-light);
                                            ">
                                                <span>${FILE_TYPES[f.type].icon}</span>
                                                <span style="font-weight: 500;">${BRAND_DISPLAY[f.brand]}</span>
                                                <span style="color: var(--text-muted);">-</span>
                                                <span style="color: var(--text-secondary);">${FILE_TYPES[f.type].name}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('');
                } else {
                    actionSection.style.display = 'none';
                }
                
                // Update upload checklist
                renderUploadChecklist(allRows);
                
                // Build full table (collapsed by default)
                const bodyEl = document.getElementById('dataStatusBody');
                if (bodyEl) {
                    bodyEl.innerHTML = allRows.map(row => {
                        const isComplete = row.has_creator && row.has_video && row.has_product && row.has_shop && row.has_affiliate;
                        return `
                            <tr>
                                <td>${formatDate(row.report_date)}</td>
                                <td>${BRAND_DISPLAY[row.brand] || row.brand}</td>
                                <td style="text-align: center;" class="${row.has_creator ? 'status-ok' : 'status-missing'}">${row.has_creator ? '' : ''}</td>
                                <td style="text-align: center;" class="${row.has_video ? 'status-ok' : 'status-missing'}">${row.has_video ? '' : ''}</td>
                                <td style="text-align: center;" class="${row.has_product ? 'status-ok' : 'status-missing'}">${row.has_product ? '' : ''}</td>
                                <td style="text-align: center;" class="${row.has_shop ? 'status-ok' : 'status-missing'}">${row.has_shop ? '' : ''}</td>
                                <td style="text-align: center;" class="${row.has_affiliate ? 'status-ok' : 'status-missing'}">${row.has_affiliate ? '' : ''}</td>
                                <td style="text-align: center;">${isComplete ? '<span style="color: var(--success);"> Complete</span>' : '<span style="color: var(--warning);"> Incomplete</span>'}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error in loadDataHealth:', err);
            }
        }
        
        function renderUploadChecklist(allRows) {
            const brandFilter = document.getElementById('checklistBrandFilter')?.value || 'all';
            const bodyEl = document.getElementById('uploadChecklistBody');
            if (!bodyEl) return;
            
            // Filter rows
            let rows = brandFilter === 'all' ? allRows : allRows.filter(r => r.brand === brandFilter);
            
            // Group by date
            const byDate = {};
            rows.forEach(row => {
                if (!byDate[row.report_date]) byDate[row.report_date] = {};
                byDate[row.report_date][row.brand] = row;
            });
            
            const dates = Object.keys(byDate).sort((a, b) => b.localeCompare(a));
            
            if (dates.length === 0) {
                bodyEl.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No data found</div>';
                return;
            }
            
            bodyEl.innerHTML = dates.map(date => {
                const brands = byDate[date];
                const allComplete = Object.values(brands).every(b => 
                    b.has_creator && b.has_video && b.has_product && b.has_shop && b.has_affiliate
                );
                
                return `
                    <details class="checklist-date-group" ${dates.indexOf(date) < 3 ? 'open' : ''}>
                        <summary style="
                            padding: 12px 16px;
                            cursor: pointer;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: var(--bg-secondary);
                            border-bottom: 1px solid var(--border-light);
                        ">
                            <span style="font-weight: 500;">${formatDate(date)}</span>
                            <span style="color: ${allComplete ? 'var(--success)' : 'var(--warning)'};">
                                ${allComplete ? ' Complete' : ' Incomplete'}
                            </span>
                        </summary>
                        <div style="padding: 12px 16px;">
                            ${Object.entries(brands).map(([brand, data]) => {
                                const types = [
                                    { key: 'has_creator', type: 'creator' },
                                    { key: 'has_video', type: 'video' },
                                    { key: 'has_product', type: 'product' },
                                    { key: 'has_shop', type: 'shop' },
                                    { key: 'has_affiliate', type: 'affiliate' }
                                ];
                                return `
                                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-light);">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">${BRAND_DISPLAY[brand]}</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                            ${types.map(t => {
                                                const hasData = data[t.key];
                                                return `
                                                    <div style="
                                                        display: inline-flex;
                                                        align-items: center;
                                                        gap: 4px;
                                                        padding: 4px 10px;
                                                        border-radius: 6px;
                                                        font-size: 0.8rem;
                                                        background: ${hasData ? 'var(--success-dim)' : 'var(--danger-dim)'};
                                                        color: ${hasData ? 'var(--success)' : 'var(--danger)'};
                                                    ">
                                                        ${hasData ? '' : ''} ${FILE_TYPES[t.type].icon} ${FILE_TYPES[t.type].name}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </details>
                `;
            }).join('');
        }
        
        function filterDataChecklist() {
            renderUploadChecklist(window.dataHealthRows || []);
        }
        
        function copyMissingDataList() {
            const missing = window.missingFilesList || [];
            if (missing.length === 0) {
                showToast('No missing files to copy!', 'success');
                return;
            }
            
            // Group by date
            const byDate = {};
            missing.forEach(f => {
                if (!byDate[f.date]) byDate[f.date] = [];
                byDate[f.date].push(f);
            });
            
            let text = ` MISSING DATA FILES (${missing.length} total)\n`;
            text += `Generated: ${new Date().toLocaleString()}\n`;
            text += `${''.repeat(40)}\n\n`;
            
            Object.entries(byDate)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .forEach(([date, files]) => {
                    text += ` ${formatDate(date)}\n`;
                    files.forEach(f => {
                        text += `    ${BRAND_DISPLAY[f.brand]} - ${FILE_TYPES[f.type].name}\n`;
                    });
                    text += '\n';
                });
            
            navigator.clipboard.writeText(text);
            showToast(`Copied ${missing.length} missing files to clipboard!`, 'success');
        }

        // ==================== DATA VALIDATION ====================
        let validationData = [];
        
        async function loadValidationData() {
            showLoading('validation', 'Loading validation data...');
            
            try {
                const brand = document.getElementById('validationBrandFilter').value;
                const days = parseInt(document.getElementById('validationDays').value) || 7;
                
                // Calculate date range
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - 1); // Yesterday
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);
                
                const startStr = localDateStr(startDate);
                const endStr = localDateStr(endDate);
                
                updateLoadingMessage('validation', 'Fetching affiliate summary data...');
                
                // Fetch affiliate summary data
                let affQuery = supabaseClient
                    .from('affiliate_summary')
                    .select('*')
                    .gte('report_date', startStr)
                    .lte('report_date', endStr);
                if (brand !== 'all') affQuery = affQuery.eq('brand', brand);
                
                const { data: affiliateData, error: affError } = await affQuery;
                
                if (affError) {
                    console.error('Affiliate query error:', affError);
                    // Table might not exist yet - show helpful message
                    if (affError.code === '42P01') {
                        document.getElementById('validationBannerIcon').textContent = '';
                        document.getElementById('validationBannerTitle').textContent = 'Affiliate Summary Table Not Found';
                        document.getElementById('validationBannerSubtitle').textContent = 'Run the SQL script to create the affiliate_summary table, then upload affiliate data files.';
                        hideLoading('validation');
                        return;
                    }
                }
                
                updateLoadingMessage('validation', 'Aggregating creator performance data...');
                
                // Fetch and aggregate creator performance data with proper pagination
                let allCreatorData = [];
                let page = 0;
                let hasMore = true;
                
                while (hasMore && page < MAX_PAGES) {
                    // Create fresh query for each page
                    let query = supabaseClient
                        .from('creator_performance')
                        .select('report_date, brand, gmv, items_sold, refunds, videos, live_streams, est_commission')
                        .gte('report_date', startStr)
                        .lte('report_date', endStr)
                        .eq('period_type', 'daily')
                        .range(page * QUERY_PAGE_SIZE, (page + 1) * QUERY_PAGE_SIZE - 1);
                    
                    if (brand !== 'all') query = query.eq('brand', brand);
                    
                    const { data: pageData, error: cpError } = await query;
                    
                    if (cpError || !pageData || pageData.length === 0) {
                        hasMore = false;
                    } else {
                        allCreatorData = allCreatorData.concat(pageData);
                        hasMore = pageData.length === QUERY_PAGE_SIZE;
                        page++;
                    }
                }
                
                updateLoadingMessage('validation', 'Computing variances...');
                
                // Aggregate creator data by date + brand
                const creatorAgg = new Map();
                allCreatorData.forEach(row => {
                    const key = `${row.report_date}|${row.brand}`;
                    if (!creatorAgg.has(key)) {
                        creatorAgg.set(key, {
                            report_date: row.report_date,
                            brand: row.brand,
                            gmv: 0,
                            items_sold: 0,
                            refunds: 0,
                            videos: 0,
                            live_streams: 0,
                            est_commission: 0
                        });
                    }
                    const agg = creatorAgg.get(key);
                    agg.gmv += pFloat(row.gmv);
                    agg.items_sold += pInt(row.items_sold);
                    agg.refunds += pFloat(row.refunds);
                    agg.videos += pInt(row.videos);
                    agg.live_streams += pInt(row.live_streams);
                    agg.est_commission += pFloat(row.est_commission);
                });
                
                // Build affiliate lookup
                const affiliateLookup = new Map();
                (affiliateData || []).forEach(row => {
                    const key = `${row.report_date}|${row.brand}`;
                    affiliateLookup.set(key, row);
                });
                
                // Get all unique date+brand combos
                const allKeys = new Set([...creatorAgg.keys(), ...affiliateLookup.keys()]);
                
                // Build validation results
                validationData = [];
                allKeys.forEach(key => {
                    const aff = affiliateLookup.get(key);
                    const cp = creatorAgg.get(key);
                    const [dateStr, brandStr] = key.split('|');
                    
                    const affGmv = aff ? pFloat(aff.gmv) : null;
                    const cpGmv = cp ? cp.gmv : null;
                    const gmvVariance = (cpGmv !== null && affGmv !== null) ? cpGmv - affGmv : null;
                    const gmvVariancePct = (affGmv && affGmv > 0) ? (gmvVariance / affGmv) * 100 : null;
                    
                    // Determine status
                    let status = 'ok';
                    if (!aff) {
                        status = 'missing_affiliate';
                    } else if (!cp) {
                        status = 'missing_creator';
                    } else if (Math.abs(gmvVariancePct) > 5) {
                        status = 'variance';
                    } else if (Math.abs(gmvVariancePct) > 1) {
                        status = 'minor_variance';
                    }
                    
                    validationData.push({
                        report_date: dateStr,
                        brand: brandStr,
                        aff_gmv: affGmv,
                        aff_items: aff ? pInt(aff.items_sold) : null,
                        aff_videos: aff ? pInt(aff.videos) : null,
                        aff_live: aff ? pInt(aff.live_streams) : null,
                        aff_commission: aff ? pFloat(aff.est_commission) : null,
                        cp_gmv: cpGmv,
                        cp_items: cp ? cp.items_sold : null,
                        cp_videos: cp ? cp.videos : null,
                        cp_live: cp ? cp.live_streams : null,
                        cp_commission: cp ? cp.est_commission : null,
                        gmv_variance: gmvVariance,
                        gmv_variance_pct: gmvVariancePct,
                        status: status
                    });
                });
                
                // Sort by date descending
                validationData.sort((a, b) => b.report_date.localeCompare(a.report_date));
                
                // Render results
                renderValidationResults();
                
            } catch (err) {
                console.error('Validation error:', err);
                showToast('Error loading validation data: ' + err.message, 'error');
            } finally {
                hideLoading('validation');
            }
        }
        
        function renderValidationResults() {
            // Calculate summary stats
            const matches = validationData.filter(r => r.status === 'ok').length;
            const mismatches = validationData.filter(r => r.status === 'variance' || r.status === 'minor_variance').length;
            const missingAffiliate = validationData.filter(r => r.status === 'missing_affiliate').length;
            const totalGmvVariance = validationData.reduce((sum, r) => sum + (r.gmv_variance || 0), 0);
            
            // Update stat cards
            document.getElementById('validationMatchCount').textContent = matches;
            document.getElementById('validationMismatchCount').textContent = mismatches;
            document.getElementById('validationTotalGmvVariance').textContent = formatCurrency(Math.abs(totalGmvVariance));
            document.getElementById('validationMissingAffiliate').textContent = missingAffiliate;
            
            // Update banner
            const bannerIcon = document.getElementById('validationBannerIcon');
            const bannerTitle = document.getElementById('validationBannerTitle');
            const bannerSubtitle = document.getElementById('validationBannerSubtitle');
            
            if (validationData.length === 0) {
                bannerIcon.textContent = '';
                bannerTitle.textContent = 'No Data Found';
                bannerSubtitle.textContent = 'Upload affiliate data files to enable validation';
            } else if (mismatches === 0 && missingAffiliate === 0) {
                bannerIcon.textContent = '';
                bannerTitle.textContent = 'All Data Validated!';
                bannerSubtitle.textContent = `${matches} days of data match between affiliate and creator sources`;
                bannerIcon.parentElement.parentElement.style.background = 'linear-gradient(135deg, var(--success-dim), var(--bg-card))';
            } else if (mismatches > 0) {
                bannerIcon.textContent = '';
                bannerTitle.textContent = `${mismatches} Discrepancies Found`;
                bannerSubtitle.textContent = `Total GMV variance: ${formatCurrency(totalGmvVariance)} (${totalGmvVariance > 0 ? 'over' : 'under'}-reported)`;
                bannerIcon.parentElement.parentElement.style.background = 'linear-gradient(135deg, var(--warning-dim), var(--bg-card))';
            } else {
                bannerIcon.textContent = '';
                bannerTitle.textContent = `${missingAffiliate} Days Missing Affiliate Data`;
                bannerSubtitle.textContent = 'Upload affiliate summary files for complete validation';
                bannerIcon.parentElement.parentElement.style.background = '';
            }
            
            // Render discrepancies section
            const discrepancies = validationData.filter(r => r.status === 'variance' || r.status === 'minor_variance');
            const discrepancySection = document.getElementById('validationDiscrepancies');
            const discrepancyBody = document.getElementById('discrepancyBody');
            
            if (discrepancies.length > 0) {
                discrepancySection.style.display = 'block';
                document.getElementById('discrepancyCount').textContent = discrepancies.length;
                
                discrepancyBody.innerHTML = discrepancies.map(row => `
                    <tr>
                        <td>${row.report_date}</td>
                        <td><span class="brand-pill ${row.brand}">${BRAND_DISPLAY[row.brand] || row.brand}</span></td>
                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${formatCurrency(row.aff_gmv)}</td>
                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${formatCurrency(row.cp_gmv)}</td>
                        <td style="text-align: right; font-family: 'Space Mono', monospace; color: ${row.gmv_variance > 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${row.gmv_variance > 0 ? '+' : ''}${formatCurrency(row.gmv_variance)}
                        </td>
                        <td style="text-align: right; font-family: 'Space Mono', monospace; color: ${row.gmv_variance > 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${row.gmv_variance_pct ? (row.gmv_variance_pct > 0 ? '+' : '') + row.gmv_variance_pct.toFixed(1) + '%' : '--'}
                        </td>
                        <td>${getValidationStatusBadge(row.status)}</td>
                    </tr>
                `).join('');
            } else {
                discrepancySection.style.display = 'none';
            }
            
            // Render full table
            filterValidationTable();
        }
        
        function filterValidationTable() {
            const showOnlyDiscrepancies = document.getElementById('showOnlyDiscrepancies').checked;
            const tbody = document.getElementById('validationTableBody');
            
            let filtered = validationData;
            if (showOnlyDiscrepancies) {
                filtered = validationData.filter(r => r.status !== 'ok');
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            ${showOnlyDiscrepancies ? 'No discrepancies found! ' : 'No validation data available'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filtered.map(row => `
                <tr class="clickable ${row.status === 'variance' ? 'row-warning' : row.status === 'missing_affiliate' ? 'row-muted' : ''}" onclick="openValidationDrilldown('${row.report_date}', '${row.brand}')">
                    <td>${row.report_date}</td>
                    <td><span class="brand-pill ${row.brand}">${BRAND_DISPLAY[row.brand] || row.brand}</span></td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.aff_gmv !== null ? formatCurrency(row.aff_gmv) : '<span style="color: var(--text-muted);">--</span>'}</td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.cp_gmv !== null ? formatCurrency(row.cp_gmv) : '<span style="color: var(--text-muted);">--</span>'}</td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace; color: ${getVarianceColor(row.gmv_variance_pct)};">
                        ${row.gmv_variance !== null ? (row.gmv_variance > 0 ? '+' : '') + formatCurrency(row.gmv_variance) : '--'}
                    </td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.aff_items !== null ? row.aff_items.toLocaleString() : '--'}</td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.cp_items !== null ? row.cp_items.toLocaleString() : '--'}</td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.aff_videos !== null ? row.aff_videos.toLocaleString() : '--'}</td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.cp_videos !== null ? row.cp_videos.toLocaleString() : '--'}</td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.aff_commission !== null ? formatCurrency(row.aff_commission) : '--'}</td>
                    <td style="text-align: right; font-family: 'Space Mono', monospace;">${row.cp_commission !== null ? formatCurrency(row.cp_commission) : '--'}</td>
                    <td>${getValidationStatusBadge(row.status)}</td>
                </tr>
            `).join('');
        }
        
        function getValidationStatusBadge(status) {
            const badges = {
                'ok': '<span class="badge" style="background: var(--success-dim); color: var(--success);"> Match</span>',
                'minor_variance': '<span class="badge" style="background: var(--warning-dim); color: var(--warning);">~ Minor</span>',
                'variance': '<span class="badge" style="background: var(--danger-dim); color: var(--danger);"> Variance</span>',
                'missing_affiliate': '<span class="badge" style="background: var(--bg-secondary); color: var(--text-muted);">No Affiliate</span>',
                'missing_creator': '<span class="badge" style="background: var(--blue-dim); color: var(--blue);">No Creator</span>'
            };
            return badges[status] || status;
        }
        
        function getVarianceColor(pct) {
            if (pct === null) return 'var(--text-muted)';
            if (Math.abs(pct) <= 1) return 'var(--success)';
            if (Math.abs(pct) <= 5) return 'var(--warning)';
            return 'var(--danger)';
        }
        
        // ==================== BRAND MISMATCH SCANNER ====================
        async function runBrandMismatchScan() {
            const resultsDiv = document.getElementById('brandMismatchResults');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div class="spinner-ring spinner-ring-active" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
                    Scanning for brand mismatches...<br>
                    <span style="font-size: 0.8rem;">Checking videos against creator brands</span>
                </div>
            `;
            
            // Brand keyword patterns for mismatch detection
            const brandKeywords = {
                'physicians_choice': ['physicians choice', "physician's choice", 'pc probiotic', 'digestive enzyme', 'probiotic', '60 billion'],
                'catakor': ['cata-kor', 'catakor', 'cata kor'],
                'yerba_magic': ['yerba magic', 'yerba', 'mate energy'],
                'jiyu': ['jiyu', 'ji-yu', 'ji yu', 'collagen'],
                'peach_slices': ['peach slices', 'peach slice', 'acne spot', 'acne patches']
            };
            
            try {
                // Get all recent videos with creator info
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = localDateStr(thirtyDaysAgo);
                
                let allVideos = [];
                let page = 0;
                let hasMore = true;
                
                while (hasMore && page < 10) {
                    const { data, error } = await supabaseClient
                        .from('video_performance')
                        .select('creator_name, brand, video_title, product_name, video_id, gmv')
                        .gte('report_date', startDate)
                        .range(page * 2000, (page + 1) * 2000 - 1);
                    
                    if (error || !data || data.length === 0) {
                        hasMore = false;
                    } else {
                        allVideos = allVideos.concat(data);
                        hasMore = data.length === 2000;
                        page++;
                    }
                }
                
                // Dedupe videos by video_id + creator
                const videoMap = new Map();
                allVideos.forEach(v => {
                    const key = `${v.video_id}-${v.creator_name}-${v.brand}`;
                    if (!videoMap.has(key)) {
                        videoMap.set(key, { ...v, totalGmv: pFloat(v.gmv) });
                    } else {
                        videoMap.get(key).totalGmv += pFloat(v.gmv);
                    }
                });
                
                // Find mismatches
                const mismatches = [];
                
                function detectLikelyBrand(videoTitle, productName) {
                    const searchText = ((videoTitle || '') + ' ' + (productName || '')).toLowerCase();
                    for (const [brandKey, keywords] of Object.entries(brandKeywords)) {
                        for (const kw of keywords) {
                            if (searchText.includes(kw)) {
                                return brandKey;
                            }
                        }
                    }
                    return null;
                }
                
                videoMap.forEach(v => {
                    const likelyBrand = detectLikelyBrand(v.video_title, v.product_name);
                    if (likelyBrand && likelyBrand !== v.brand) {
                        mismatches.push({
                            creator_name: v.creator_name,
                            tagged_brand: v.brand,
                            likely_brand: likelyBrand,
                            video_title: v.video_title,
                            video_id: v.video_id,
                            gmv: v.totalGmv
                        });
                    }
                });
                
                // Group by creator + brand combo
                const creatorMismatches = new Map();
                mismatches.forEach(m => {
                    const key = `${m.creator_name}-${m.tagged_brand}`;
                    if (!creatorMismatches.has(key)) {
                        creatorMismatches.set(key, {
                            creator_name: m.creator_name,
                            tagged_brand: m.tagged_brand,
                            likely_brand: m.likely_brand,
                            video_count: 0,
                            total_gmv: 0,
                            sample_title: m.video_title
                        });
                    }
                    const c = creatorMismatches.get(key);
                    c.video_count++;
                    c.total_gmv += m.gmv;
                });
                
                const creatorList = [...creatorMismatches.values()].sort((a, b) => b.total_gmv - a.total_gmv);
                
                // Render results
                if (creatorList.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--success);">
                            <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                            <p style="font-weight: 600;">No Brand Mismatches Found!</p>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">
                                All videos appear to match their creators' assigned brands.
                            </p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="margin-bottom: 16px; padding: 12px; background: var(--warning-dim); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <strong style="color: var(--warning);">Found ${creatorList.length} potential mismatches</strong>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    These creators have videos that appear to belong to a different brand than they're tagged under.
                                </div>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Creator</th>
                                        <th>Tagged As</th>
                                        <th>Likely Brand</th>
                                        <th style="text-align: right;">Videos</th>
                                        <th style="text-align: right;">GMV</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${creatorList.map(c => `
                                        <tr>
                                            <td>
                                                <strong style="cursor: pointer;" onclick="openCreatorDetail('${c.creator_name.replace(/'/g, "\\'")}', '${c.tagged_brand}')">${c.creator_name}</strong>
                                                <div style="font-size: 0.75rem; color: var(--text-muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c.sample_title || ''}</div>
                                            </td>
                                            <td><span class="brand-pill ${c.tagged_brand}">${BRAND_DISPLAY[c.tagged_brand] || c.tagged_brand}</span></td>
                                            <td><span class="brand-pill ${c.likely_brand}">${BRAND_DISPLAY[c.likely_brand] || c.likely_brand}</span></td>
                                            <td style="text-align: right;">${c.video_count}</td>
                                            <td style="text-align: right; font-family: 'Space Mono', monospace;">${formatCurrency(c.total_gmv)}</td>
                                            <td>
                                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.75rem;" onclick="quickFixBrand('${c.creator_name.replace(/'/g, "\\'")}', '${c.tagged_brand}', '${c.likely_brand}')">
                                                     Fix
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
            } catch (err) {
                console.error('Brand mismatch scan error:', err);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                        <p>Error scanning for mismatches: ${err.message}</p>
                    </div>
                `;
            }
        }
        
        async function quickFixBrand(creatorName, oldBrand, newBrand) {
            if (!confirm(`Change ${creatorName} from ${BRAND_DISPLAY[oldBrand]} to ${BRAND_DISPLAY[newBrand]}?`)) {
                return;
            }
            
            showToast('Updating brand...', 'info');
            
            try {
                // Update creator_performance records
                const { error: cpError } = await supabaseClient
                    .from('creator_performance')
                    .update({ brand: newBrand })
                    .eq('creator_name', creatorName)
                    .eq('brand', oldBrand);
                
                if (cpError) throw cpError;
                
                // Update video_performance records
                const { error: vpError } = await supabaseClient
                    .from('video_performance')
                    .update({ brand: newBrand })
                    .ilike('creator_name', creatorName)
                    .eq('brand', oldBrand);
                
                if (vpError) throw vpError;
                
                showToast(` Changed ${creatorName} to ${BRAND_DISPLAY[newBrand]}`, 'success');
                
                // Re-run scan to update list
                runBrandMismatchScan();
                
            } catch (err) {
                console.error('Quick fix brand error:', err);
                showToast(`Error: ${err.message}`, 'error');
            }
        }
        
        // ==================== VALIDATION DRILL-DOWN ====================
        async function openValidationDrilldown(reportDate, brand) {
            const modal = document.getElementById('validationDrilldownModal');
            const title = document.getElementById('drilldownTitle');
            const body = document.getElementById('drilldownBody');
            
            title.textContent = `${BRAND_DISPLAY[brand] || brand} - ${reportDate}`;
            body.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div class="spinner-ring spinner-ring-active" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
                    Loading creator data...
                </div>
            `;
            modal.classList.add('show');
            
            try {
                // Get affiliate summary for this date/brand
                const { data: affData } = await supabaseClient
                    .from('affiliate_summary')
                    .select('*')
                    .eq('report_date', reportDate)
                    .eq('brand', brand)
                    .single();
                
                console.log('Drilldown query params:', { reportDate, brand });
                
                // Get all creators for this date/brand with pagination
                let allCreators = [];
                let page = 0;
                let hasMore = true;
                
                while (hasMore && page < 20) {
                    const { data: pageData, error } = await supabaseClient
                        .from('creator_performance')
                        .select('creator_name, gmv, items_sold, videos, live_streams, est_commission')
                        .eq('report_date', reportDate)
                        .eq('brand', brand)
                        .eq('period_type', 'daily')
                        .order('gmv', { ascending: false })
                        .range(page * 1000, (page + 1) * 1000 - 1);
                    
                    if (error) {
                        console.error('Drilldown query error:', error);
                    }
                    console.log('Drilldown page', page, 'results:', pageData?.length || 0);
                    
                    if (error || !pageData || pageData.length === 0) {
                        hasMore = false;
                    } else {
                        allCreators = allCreators.concat(pageData);
                        hasMore = pageData.length === 1000;
                        page++;
                    }
                }
                
                console.log('Total creators found:', allCreators.length);
                
                // Debug: If no creators found, check what brands exist for this date
                if (allCreators.length === 0) {
                    const { data: debugData } = await supabaseClient
                        .from('creator_performance')
                        .select('brand, report_date')
                        .eq('report_date', reportDate)
                        .eq('period_type', 'daily')
                        .limit(10);
                    console.log('Debug - brands found for date', reportDate, ':', debugData?.map(d => d.brand));
                }
                
                // Calculate totals from creator data
                const cpTotals = {
                    gmv: allCreators.reduce((sum, c) => sum + pFloat(c.gmv), 0),
                    items_sold: allCreators.reduce((sum, c) => sum + pInt(c.items_sold), 0),
                    videos: allCreators.reduce((sum, c) => sum + pInt(c.videos), 0),
                    live_streams: allCreators.reduce((sum, c) => sum + pInt(c.live_streams), 0),
                    est_commission: allCreators.reduce((sum, c) => sum + pFloat(c.est_commission), 0),
                    creator_count: allCreators.length
                };
                
                // Calculate variances
                const gmvVariance = affData ? cpTotals.gmv - pFloat(affData.gmv) : null;
                const itemsVariance = affData ? cpTotals.items_sold - pInt(affData.items_sold) : null;
                const videosVariance = affData ? cpTotals.videos - pInt(affData.videos) : null;
                const commVariance = affData ? cpTotals.est_commission - pFloat(affData.est_commission) : null;
                
                // Build the drilldown HTML
                body.innerHTML = `
                    <!-- Summary Comparison -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <div class="card-title"><span></span> Summary Comparison</div>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th style="text-align: right;">Affiliate (Source)</th>
                                        <th style="text-align: right;">Creator Data</th>
                                        <th style="text-align: right;">Variance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>GMV</strong></td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${affData ? formatCurrency(affData.gmv) : '--'}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${formatCurrency(cpTotals.gmv)}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace; color: ${gmvVariance && Math.abs(gmvVariance) > 1 ? (gmvVariance > 0 ? 'var(--success)' : 'var(--danger)') : 'var(--text-muted)'};">
                                            ${gmvVariance !== null ? (gmvVariance >= 0 ? '+' : '') + formatCurrency(gmvVariance) : '--'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Items Sold</strong></td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${affData ? pInt(affData.items_sold).toLocaleString() : '--'}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${cpTotals.items_sold.toLocaleString()}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace; color: ${itemsVariance && Math.abs(itemsVariance) > 0 ? (itemsVariance > 0 ? 'var(--success)' : 'var(--danger)') : 'var(--text-muted)'};">
                                            ${itemsVariance !== null ? (itemsVariance >= 0 ? '+' : '') + itemsVariance.toLocaleString() : '--'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Videos</strong></td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${affData ? pInt(affData.videos).toLocaleString() : '--'}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${cpTotals.videos.toLocaleString()}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace; color: ${videosVariance && Math.abs(videosVariance) > 0 ? (videosVariance > 0 ? 'var(--success)' : 'var(--danger)') : 'var(--text-muted)'};">
                                            ${videosVariance !== null ? (videosVariance >= 0 ? '+' : '') + videosVariance.toLocaleString() : '--'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Commission</strong></td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${affData ? formatCurrency(affData.est_commission) : '--'}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${formatCurrency(cpTotals.est_commission)}</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace; color: ${commVariance && Math.abs(commVariance) > 1 ? (commVariance > 0 ? 'var(--success)' : 'var(--danger)') : 'var(--text-muted)'};">
                                            ${commVariance !== null ? (commVariance >= 0 ? '+' : '') + formatCurrency(commVariance) : '--'}
                                        </td>
                                    </tr>
                                    <tr style="background: var(--bg-secondary);">
                                        <td><strong>Creators in Data</strong></td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace; color: var(--text-muted);">--</td>
                                        <td style="text-align: right; font-family: 'Space Mono', monospace;">${cpTotals.creator_count.toLocaleString()}</td>
                                        <td style="text-align: right; color: var(--text-muted);">--</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    ${gmvVariance && gmvVariance < 0 ? `
                    <div class="card" style="margin-bottom: 24px; border-left: 4px solid var(--warning);">
                        <div class="card-body">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600; color: var(--warning);">Creator data is ${formatCurrency(Math.abs(gmvVariance))} under affiliate total</div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">
                                        This usually means some creators are missing from the uploaded data. Check TikTok Shop for creators not in the list below.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Creator Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span></span> Creator Breakdown (${allCreators.length} creators)</div>
                            <input type="text" id="drilldownSearch" placeholder="Search creators..." 
                                   style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); width: 200px;"
                                   oninput="filterDrilldownTable(this.value)">
                        </div>
                        <div class="card-body" style="padding: 0; max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead style="position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th>#</th>
                                        <th>Creator</th>
                                        <th style="text-align: right;">GMV</th>
                                        <th style="text-align: right;">Items</th>
                                        <th style="text-align: right;">Videos</th>
                                        <th style="text-align: right;">Commission</th>
                                        <th style="text-align: right;">% of Total</th>
                                    </tr>
                                </thead>
                                <tbody id="drilldownCreatorTable">
                                    ${allCreators.length === 0 ? `
                                        <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No creator data found</td></tr>
                                    ` : allCreators.map((c, i) => `
                                        <tr class="drilldown-row" data-name="${(c.creator_name || '').toLowerCase()}">
                                            <td style="color: var(--text-muted);">${i + 1}</td>
                                            <td><strong>${c.creator_name || 'Unknown'}</strong></td>
                                            <td style="text-align: right; font-family: 'Space Mono', monospace;">${formatCurrency(c.gmv)}</td>
                                            <td style="text-align: right; font-family: 'Space Mono', monospace;">${pInt(c.items_sold).toLocaleString()}</td>
                                            <td style="text-align: right; font-family: 'Space Mono', monospace;">${pInt(c.videos).toLocaleString()}</td>
                                            <td style="text-align: right; font-family: 'Space Mono', monospace;">${formatCurrency(c.est_commission)}</td>
                                            <td style="text-align: right; font-family: 'Space Mono', monospace; color: var(--text-muted);">
                                                ${cpTotals.gmv > 0 ? ((pFloat(c.gmv) / cpTotals.gmv) * 100).toFixed(1) + '%' : '--'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
            } catch (err) {
                console.error('Drilldown error:', err);
                body.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        Error loading data: ${err.message}
                    </div>
                `;
            }
        }
        
        function filterDrilldownTable(searchTerm) {
            const rows = document.querySelectorAll('.drilldown-row');
            const term = searchTerm.toLowerCase();
            rows.forEach(row => {
                const name = row.dataset.name || '';
                row.style.display = name.includes(term) ? '' : 'none';
            });
        }
        
        function closeValidationDrilldown() {
            document.getElementById('validationDrilldownModal').classList.remove('show');
        }

        // ==================== SYSTEM STATUS ====================
        let connectionHealthy = false;
        let lastDataDate = null;
        
        async function checkConnectionHealth() {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            if (!dot || !text) return;
            
            try {
                const start = Date.now();
                const { data, error } = await supabaseClient.from('video_performance').select('report_date').limit(1);
                const latency = Date.now() - start;
                
                if (error) throw error;
                
                connectionHealthy = true;
                dot.className = 'status-dot connected';
                text.textContent = latency < 500 ? 'Connected' : `Connected (${latency}ms)`;
                
            } catch (err) {
                connectionHealthy = false;
                dot.className = 'status-dot disconnected';
                text.textContent = 'Disconnected';
                console.error('Connection check failed:', err);
            }
        }
        
        async function updateDataFreshness() {
            const freshnessEl = document.getElementById('dataFreshness');
            if (!freshnessEl) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('video_performance')
                    .select('report_date')
                    .order('report_date', { ascending: false })
                    .limit(1);
                
                if (error || !data || data.length === 0) {
                    freshnessEl.textContent = 'No data';
                    freshnessEl.className = 'status-value old';
                    return;
                }
                
                lastDataDate = new Date(data[0].report_date + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffDays = Math.floor((today - lastDataDate) / (1000 * 60 * 60 * 24));
                
                const dateStr = lastDataDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                if (diffDays <= 1) {
                    freshnessEl.textContent = dateStr + ' ';
                    freshnessEl.className = 'status-value fresh';
                } else if (diffDays <= 3) {
                    freshnessEl.textContent = dateStr + ` (${diffDays}d ago)`;
                    freshnessEl.className = 'status-value stale';
                } else {
                    freshnessEl.textContent = dateStr + ` (${diffDays}d ago!)`;
                    freshnessEl.className = 'status-value old';
                }
                
            } catch (err) {
                freshnessEl.textContent = 'Error';
                freshnessEl.className = 'status-value old';
                console.error('Data freshness check failed:', err);
            }
        }
        
        async function initSystemStatus() {
            await checkConnectionHealth();
            await updateDataFreshness();
            
            // Check connection health every 30 seconds
            setInterval(checkConnectionHealth, 30000);
            // Update data freshness every 5 minutes
            setInterval(updateDataFreshness, 300000);
        }

        // Initialize
        async function init() {
            console.log('=== INIT STARTING ===');
            try {
                populateBrandDropdowns();
                console.log('Brand dropdowns populated');
                
                setupNavigation(); // Setup nav FIRST so it always works
                console.log('Navigation setup complete');
                
                // Move Overview content into Ops Center Overview tab
                const viewOverview = document.getElementById('view-overview');
                const opsOverview = document.getElementById('ops-tab-overview');
                if (viewOverview && opsOverview) {
                    // Move all children instead of copying innerHTML to preserve canvas references
                    while (viewOverview.firstChild) {
                        opsOverview.appendChild(viewOverview.firstChild);
                    }
                    viewOverview.style.display = 'none';
                }
                
                // Initialize system status (connection + data freshness)
                initSystemStatus();
                
                await loadManagedCreators().catch(e => console.warn('Could not load managed creators:', e));
                await loadAvailableDates().catch(e => console.warn('Could not load dates:', e));
                await loadDataHealth().catch(e => console.warn('Could not load data health:', e));
                
                // Default to Ops Center with Overview tab
                switchView('opscenter');
                
                loadOverviewData();
                opsData.overviewLoaded = true;
                
                loadAlertsData(); // Load alerts for bell notification
                loadApplicationSettings(); // Load application page settings
                updatePendingUsersBadge(); // Update pending users badge
                updateLastUpdated();
                generateAutoAlerts();
                console.log('=== INIT COMPLETE ===');
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        function setupNavigation() {
            // Navigation handled by inline onclick handlers
            console.log('Navigation ready');
        }

        // Make switchView global for inline onclick handlers
        window.switchView = function(view) {
            // Check role-based access
            if (window.currentUserRole && typeof canAccessView === 'function' && !canAccessView(view)) {
                showToast('Access denied for this section', 'error');
                return;
            }
            
            console.log('Switching to view:', view);
            currentView = view;
            
            // Auto-expand settings nav if needed
            const settingsViews = ['settings', 'goals', 'activity', 'datastatus'];
            if (settingsViews.includes(view)) {
                const group = document.getElementById('settingsNavGroup');
                const arrow = document.getElementById('settingsNavArrow');
                if (group && !group.classList.contains('expanded')) {
                    group.classList.add('expanded');
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                }
            }
            
            // Update active nav item (sidebar)
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[data-view="${view}"]`);
            if (activeNav) activeNav.classList.add('active');
            
            // Update mobile bottom nav
            document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
            const mobileViews = ['overview', 'creators', 'brands', 'videos'];
            if (mobileViews.includes(view)) {
                const mobileNav = document.querySelector(`.mobile-nav-item[onclick*="${view}"]`);
                if (mobileNav) mobileNav.classList.add('active');
            }
            
            // Update active view section
            document.querySelectorAll('.view-section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            const viewEl = document.getElementById(`view-${view}`);
            if (viewEl) {
                viewEl.classList.add('active');
                viewEl.style.display = 'block';
                console.log('View switched successfully');
            } else {
                console.error('View not found:', `view-${view}`);
            }
            
            loadViewData();
            closeMobileMenu();
        }
        
        // Process any view that was clicked before script loaded
        if (window._pendingView) {
            console.log('Processing pending view:', window._pendingView);
            window.switchView(window._pendingView);
            delete window._pendingView;
        }

        function loadViewData(forceRefresh = false) {
            // If force refresh, clear cache for this view
            if (forceRefresh) {
                cache.invalidate(currentView);
                viewsLoaded.delete(currentView);
            }
            
            switch(currentView) {
                case 'opscenter': lazyLoadView('opscenter', loadVideosTab, forceRefresh); break;
                case 'dailyops': lazyLoadView('dailyops', loadDailyOps, forceRefresh); break;
                case 'weeklyops': lazyLoadView('weeklyops', loadWeeklyOps, forceRefresh); break;
                case 'overview': loadOverviewData(); break; // Always refresh overview
                case 'brands': 
                    loadAllProductsForFilter('brandsProductFilter');
                    lazyLoadView('brands', loadBrandsData, forceRefresh); 
                    break;
                case 'creators': lazyLoadView('creators', loadCreatorsData, forceRefresh); break;
                case 'videos': lazyLoadView('videos', loadVideosData, forceRefresh); break;
                case 'products': lazyLoadView('products', loadProductsData, forceRefresh); break;
                case 'roster': lazyLoadView('roster', loadRosterData, forceRefresh); break;
                case 'goals': lazyLoadView('goals', loadGoalsData, forceRefresh); break;
                case 'alerts': loadAlertsData(); break;
                case 'calculator': initCalculator().then(() => calculateRevenueShare()); break;
                case 'funnels': loadFunnelsData(); break;
                case 'settings': loadDiscordSettings(); loadEmailSmsSettings(); loadApplicationSettings(); settingsProductsLoaded = true; loadSettingsProducts(); loadProductGroups(); break;
                case 'datastatus': loadDataHealth(); break;
                case 'applications': lazyLoadView('applications', loadApplicationsData, forceRefresh); break;
                case 'users': lazyLoadView('users', loadUsersData, forceRefresh); break;
                case 'payments': lazyLoadView('payments', loadPaymentsData, forceRefresh); break;
                case 'commissions': lazyLoadView('commissions', loadCommissionsData, forceRefresh); break;
                case 'activity': lazyLoadView('activity', loadActivityLog, forceRefresh); break;
                case 'portalconfig': loadCampaigns(); break;
            }
            updateLastUpdated();
        }
        
        // Data Status tab switching
        let currentDataStatusTab = 'uploads';
        
        function switchDataStatusTab(tab) {
            currentDataStatusTab = tab;
            
            // Update tab buttons
            document.getElementById('tab-uploads').classList.toggle('active', tab === 'uploads');
            document.getElementById('tab-validation').classList.toggle('active', tab === 'validation');
            
            // Update tab content
            document.getElementById('datastatus-uploads').style.display = tab === 'uploads' ? 'block' : 'none';
            document.getElementById('datastatus-validation').style.display = tab === 'validation' ? 'block' : 'none';
            
            // Load data for the active tab
            if (tab === 'uploads') {
                loadDataHealth();
            } else if (tab === 'validation') {
                loadValidationData();
            }
        }
        
        function refreshDataStatusTab() {
            if (currentDataStatusTab === 'uploads') {
                loadDataHealth();
            } else {
                loadValidationData();
            }
            showToast('Data refreshed!', 'success');
        }
        
        // Force refresh current view (called by Refresh buttons)
        function refreshCurrentView() {
            loadViewData(true);
            showToast('Data refreshed!', 'success');
        }
        
        // Scroll to Top
        function scrollToTop() {
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // Show/hide scroll to top button based on scroll position
        function initScrollToTop() {
            const mainContent = document.querySelector('.main-content');
            const scrollBtn = document.getElementById('scrollToTop');
            
            if (mainContent && scrollBtn) {
                mainContent.addEventListener('scroll', () => {
                    if (mainContent.scrollTop > 300) {
                        scrollBtn.classList.add('visible');
                    } else {
                        scrollBtn.classList.remove('visible');
                    }
                });
            }
        }
        
        // Initialize scroll listener after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initScrollToTop, 100);
        });

        async function loadManagedCreators() {
            return dedupedFetch('managed_creators', async () => {
                const { data } = await supabaseClient.from('managed_creators')
                    .select('*')
                    .order('id', { ascending: true });
                managedCreators = data || [];
                return managedCreators;
            });
        }

        async function loadAvailableDates() {
            return dedupedFetch('available_dates', async () => {
                // Try RPC function first, fall back to direct query
                let dateData = null;
                
                const { data: rpcData, error: rpcError } = await supabaseClient.rpc('get_available_dates');
                
                if (rpcError) {
                    console.warn('RPC function not available, using fallback query');
                    // Fallback: direct query for dates
                    const { data: fallbackData } = await supabaseClient
                        .from('creator_performance')
                        .select('report_date, period_type')
                        .eq('period_type', 'daily')
                        .order('report_date', { ascending: false })
                        .limit(365);
                    dateData = fallbackData;
                } else {
                    dateData = rpcData;
                }

                // Only use daily dates
                const dailySet = new Set();
                
                (dateData || []).forEach(d => {
                    if (d.period_type === 'daily') {
                        dailySet.add(d.report_date);
                    }
                });

                availableDates = { 
                    daily: [...dailySet].sort().reverse()
                };
                
                console.log('Available dates:', availableDates.daily?.length || 0, 'days loaded');
                populateDateFilters();
                return availableDates;
            });
        }

        // Store Litepicker instances
        const datePickers = {};
        
        function populateDateFilters() {
            const dates = availableDates.daily || [];
            if (!dates || dates.length === 0) return;
            
            // Get min and max dates for the calendar range
            const sortedDates = [...dates].sort();
            const minDate = sortedDates[0];
            const maxDate = sortedDates[sortedDates.length - 1];
            
            // Create a Set of available dates for quick lookup
            const availableDateSet = new Set(dates);
            
            // Most recent date with data as default (smart default)
            const latestDateStr = maxDate; // Most recent date with data
            const latestDate = new Date(latestDateStr + 'T12:00:00');
            
            // Also calculate yesterday for comparison
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);
            const yesterdayStr = localDateStr(yesterday);
            
            // Helper to create date at midnight
            const makeDate = (daysAgo) => {
                const d = new Date();
                d.setDate(d.getDate() - daysAgo);
                d.setHours(0, 0, 0, 0);
                return d;
            };
            
            // Create preset ranges (all ending at latest available data) - must be Date objects
            const last7Start = new Date(latestDate);
            last7Start.setDate(last7Start.getDate() - 6);
            const last14Start = new Date(latestDate);
            last14Start.setDate(last14Start.getDate() - 13);
            const last30Start = new Date(latestDate);
            last30Start.setDate(last30Start.getDate() - 29);
            const thisMonthStart = new Date(latestDate.getFullYear(), latestDate.getMonth(), 1);
            const lastMonthStart = new Date(latestDate.getFullYear(), latestDate.getMonth() - 1, 1);
            const lastMonthEnd = new Date(latestDate.getFullYear(), latestDate.getMonth(), 0);
            
            const presetRanges = {
                'Latest Day': [new Date(latestDate), new Date(latestDate)],
                'Last 7 Days': [last7Start, new Date(latestDate)],
                'Last 14 Days': [last14Start, new Date(latestDate)],
                'Last 30 Days': [last30Start, new Date(latestDate)],
                'This Month': [thisMonthStart, new Date(latestDate)],
                'Last Month': [lastMonthStart, lastMonthEnd]
            };
            
            // Flag to prevent dropdown from switching to "custom" when preset is being applied
            let applyingPreset = false;
            
            // Initialize Overview date picker
            const overviewEl = document.getElementById('overviewDateRange');
            const startHidden = document.getElementById('dateFilterStart');
            const endHidden = document.getElementById('dateFilterEnd');
            const presetSelect = document.getElementById('datePresetSelect');
            
            // Helper to convert Litepicker DateTime to YYYY-MM-DD string
            const toDateStr = (lpDate) => lpDate.format('YYYY-MM-DD');
            
            if (overviewEl && startHidden && endHidden) {
                // Set initial values to Last 7 Days of available data
                startHidden.value = localDateStr(last7Start);
                endHidden.value = latestDateStr;
                
                const overviewPicker = new Litepicker({
                    element: overviewEl,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0, // Sunday
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: last7Start,
                    endDate: latestDate,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                startHidden.value = toDateStr(date1);
                                endHidden.value = toDateStr(date2);
                                // Set dropdown to custom when manually selecting (not from preset)
                                if (!applyingPreset && presetSelect) presetSelect.value = 'custom';
                                loadOverviewData();
                            }
                        });
                    }
                });
                
                datePickers['overview'] = overviewPicker;
                
                // Handle preset dropdown change
                if (presetSelect) {
                    presetSelect.addEventListener('change', function() {
                        const val = this.value;
                        let range = null;
                        
                        switch(val) {
                            case 'yesterday':
                                range = presetRanges['Yesterday'];
                                break;
                            case 'last7':
                                range = presetRanges['Last 7 Days'];
                                break;
                            case 'last14':
                                range = presetRanges['Last 14 Days'];
                                break;
                            case 'last30':
                                range = presetRanges['Last 30 Days'];
                                break;
                            case 'thisMonth':
                                range = presetRanges['This Month'];
                                break;
                            case 'lastMonth':
                                range = presetRanges['Last Month'];
                                break;
                            case 'custom':
                                // Just open the picker
                                overviewPicker.show();
                                return;
                        }
                        
                        if (range && range[0] && range[1]) {
                            applyingPreset = true;
                            overviewPicker.setDateRange(range[0], range[1]);
                            applyingPreset = false;
                            startHidden.value = localDateStr(range[0]);
                            endHidden.value = localDateStr(range[1]);
                            
                            // Update input field display
                            const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            overviewEl.value = `${formatDisplayDate(range[0])}  ${formatDisplayDate(range[1])}`;
                            
                            loadOverviewData();
                        }
                    });
                }
            }
            
            // Trigger initial data load
            setTimeout(() => loadOverviewData(), 100);
            
            // Initialize Daily Ops date picker (single date)
            const dailyDateEl = document.getElementById('dailyDatePicker');
            if (dailyDateEl) {
                datePickers['dailyDatePicker'] = new Litepicker({
                    element: dailyDateEl,
                    singleMode: true,
                    autoApply: true,
                    firstDay: 0, // Sunday
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: latestDateStr,
                    format: 'MMM D, YYYY',
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', () => loadDailyOps());
                    }
                });
                dailyDateEl.value = formatDate(latestDateStr);
            }
            
            // Initialize Weekly Ops date pickers
            const weeklyStartEl = document.getElementById('weeklyStartDate');
            const weeklyEndEl = document.getElementById('weeklyEndDate');
            if (weeklyStartEl && weeklyEndEl) {
                // Use latest date with data as week end
                const weekEnd = new Date(latestDate);
                const weekStart = new Date(weekEnd);
                weekStart.setDate(weekStart.getDate() - 6);
                
                datePickers['weeklyStartDate'] = new Litepicker({
                    element: weeklyStartEl,
                    singleMode: true,
                    autoApply: true,
                    firstDay: 0, // Sunday
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: localDateStr(weekStart),
                    format: 'MMM D',
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', () => {
                            document.getElementById('weekSelector').value = 'custom';
                            loadWeeklyOps();
                        });
                    }
                });
                weeklyStartEl.value = localDateStr(weekStart);
                
                datePickers['weeklyEndDate'] = new Litepicker({
                    element: weeklyEndEl,
                    singleMode: true,
                    autoApply: true,
                    firstDay: 0, // Sunday
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: localDateStr(weekEnd),
                    format: 'MMM D',
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', () => {
                            document.getElementById('weekSelector').value = 'custom';
                            loadWeeklyOps();
                        });
                    }
                });
                weeklyEndEl.value = localDateStr(weekEnd);
            }
            
            // Initialize Brands date picker (matching Overview style)
            const brandsDateEl = document.getElementById('brandsDateRange');
            const brandsStartHidden = document.getElementById('brandsDateFilterStart');
            const brandsEndHidden = document.getElementById('brandsDateFilterEnd');
            const brandsPresetSelect = document.getElementById('brandsDatePresetSelect');
            
            if (brandsDateEl && brandsStartHidden && brandsEndHidden) {
                // Default to Last 7 Days ending at latest date with data
                const brands7Start = new Date(latestDate);
                brands7Start.setDate(brands7Start.getDate() - 6);
                brandsStartHidden.value = localDateStr(brands7Start);
                brandsEndHidden.value = latestDateStr;
                
                const brandsPicker = new Litepicker({
                    element: brandsDateEl,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0,
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: last7Start,
                    endDate: yesterday,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                brandsStartHidden.value = toDateStr(date1);
                                brandsEndHidden.value = toDateStr(date2);
                                if (!applyingPreset && brandsPresetSelect) brandsPresetSelect.value = 'custom';
                                loadBrandsData();
                            }
                        });
                    }
                });
                
                datePickers['brands'] = brandsPicker;
                
                // Handle preset dropdown change
                if (brandsPresetSelect) {
                    brandsPresetSelect.addEventListener('change', function() {
                        const val = this.value;
                        let range = null;
                        
                        switch(val) {
                            case 'yesterday': range = presetRanges['Yesterday']; break;
                            case 'last7': range = presetRanges['Last 7 Days']; break;
                            case 'last14': range = presetRanges['Last 14 Days']; break;
                            case 'last30': range = presetRanges['Last 30 Days']; break;
                            case 'thisMonth': range = presetRanges['This Month']; break;
                            case 'lastMonth': range = presetRanges['Last Month']; break;
                            case 'custom':
                                brandsPicker.show();
                                return;
                        }
                        
                        if (range && range[0] && range[1]) {
                            applyingPreset = true;
                            brandsPicker.setDateRange(range[0], range[1]);
                            applyingPreset = false;
                            brandsStartHidden.value = localDateStr(range[0]);
                            brandsEndHidden.value = localDateStr(range[1]);
                            const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            brandsDateEl.value = `${formatDisplayDate(range[0])}  ${formatDisplayDate(range[1])}`;
                            loadBrandsData();
                        }
                    });
                }
            }
            
            // Initialize Creators date picker (matching Overview/Brands style)
            const creatorsDateEl = document.getElementById('creatorsDateRange');
            const creatorsStartHidden = document.getElementById('creatorsDateFilterStart');
            const creatorsEndHidden = document.getElementById('creatorsDateFilterEnd');
            const creatorsPresetSelect = document.getElementById('creatorsDatePresetSelect');
            
            if (creatorsDateEl && creatorsStartHidden && creatorsEndHidden) {
                // Default to Last 7 Days ending at latest date with data
                const creators7Start = new Date(latestDate);
                creators7Start.setDate(creators7Start.getDate() - 6);
                creatorsStartHidden.value = localDateStr(creators7Start);
                creatorsEndHidden.value = latestDateStr;
                
                const creatorsPicker = new Litepicker({
                    element: creatorsDateEl,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0,
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: creators7Start,
                    endDate: latestDate,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                creatorsStartHidden.value = toDateStr(date1);
                                creatorsEndHidden.value = toDateStr(date2);
                                if (!applyingPreset && creatorsPresetSelect) creatorsPresetSelect.value = 'custom';
                                pages.creators = 1;
                                loadCreatorsData();
                            }
                        });
                    }
                });
                
                datePickers['creators'] = creatorsPicker;
                
                // Handle preset dropdown change
                if (creatorsPresetSelect) {
                    creatorsPresetSelect.addEventListener('change', function() {
                        const val = this.value;
                        let range = null;
                        
                        switch(val) {
                            case 'yesterday': range = presetRanges['Yesterday']; break;
                            case 'last7': range = presetRanges['Last 7 Days']; break;
                            case 'last14': range = presetRanges['Last 14 Days']; break;
                            case 'last30': range = presetRanges['Last 30 Days']; break;
                            case 'thisMonth': range = presetRanges['This Month']; break;
                            case 'lastMonth': range = presetRanges['Last Month']; break;
                            case 'custom':
                                creatorsPicker.show();
                                return;
                        }
                        
                        if (range && range[0] && range[1]) {
                            applyingPreset = true;
                            creatorsPicker.setDateRange(range[0], range[1]);
                            applyingPreset = false;
                            creatorsStartHidden.value = localDateStr(range[0]);
                            creatorsEndHidden.value = localDateStr(range[1]);
                            const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            creatorsDateEl.value = `${formatDisplayDate(range[0])}  ${formatDisplayDate(range[1])}`;
                            pages.creators = 1;
                            loadCreatorsData();
                        }
                    });
                }
            }
            
            // Initialize Ops Center date picker
            const opsDateEl = document.getElementById('opsDateRange');
            const opsStartHidden = document.getElementById('opsDateFilterStart');
            const opsEndHidden = document.getElementById('opsDateFilterEnd');
            const opsPresetSelect = document.getElementById('opsDatePresetSelect');
            
            if (opsDateEl && opsStartHidden && opsEndHidden) {
                // Default to Last 7 Days ending at latest date with data
                const ops7Start = new Date(latestDate);
                ops7Start.setDate(ops7Start.getDate() - 6);
                opsStartHidden.value = localDateStr(ops7Start);
                opsEndHidden.value = latestDateStr;
                
                // Show initial date range
                const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                opsDateEl.value = `${formatDisplayDate(ops7Start)}  ${formatDisplayDate(latestDate)}`;
                
                const opsPicker = new Litepicker({
                    element: opsDateEl,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0,
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: ops7Start,
                    endDate: latestDate,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                opsStartHidden.value = toDateStr(date1);
                                opsEndHidden.value = toDateStr(date2);
                                if (!applyingPreset && opsPresetSelect) opsPresetSelect.value = 'custom';
                                reloadCurrentOpsTab();
                            }
                        });
                    }
                });
                
                datePickers['ops'] = opsPicker;
                
                // Handle preset dropdown change
                if (opsPresetSelect) {
                    opsPresetSelect.addEventListener('change', function() {
                        const val = this.value;
                        let range = null;
                        
                        switch(val) {
                            case 'yesterday': range = presetRanges['Yesterday']; break;
                            case 'last7': range = presetRanges['Last 7 Days']; break;
                            case 'last14': range = presetRanges['Last 14 Days']; break;
                            case 'last30': range = presetRanges['Last 30 Days']; break;
                            case 'thisMonth': range = presetRanges['This Month']; break;
                            case 'lastMonth': range = presetRanges['Last Month']; break;
                            case 'custom':
                                opsPicker.show();
                                return;
                        }
                        
                        if (range && range[0] && range[1]) {
                            applyingPreset = true;
                            opsPicker.setDateRange(range[0], range[1]);
                            applyingPreset = false;
                            opsStartHidden.value = localDateStr(range[0]);
                            opsEndHidden.value = localDateStr(range[1]);
                            const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            opsDateEl.value = `${formatDisplayDate(range[0])}  ${formatDisplayDate(range[1])}`;
                            reloadCurrentOpsTab();
                        }
                    });
                }
            }
            
            // Initialize Videos date picker (matching Overview/Creators style)
            const videosDateEl = document.getElementById('videosDateRange');
            const videosStartHidden = document.getElementById('videosDateFilterStart');
            const videosEndHidden = document.getElementById('videosDateFilterEnd');
            const videosPresetSelect = document.getElementById('videosDatePresetSelect');
            
            if (videosDateEl && videosStartHidden && videosEndHidden) {
                // Default to Last 7 Days ending at latest date with data
                const videos7Start = new Date(latestDate);
                videos7Start.setDate(videos7Start.getDate() - 6);
                videosStartHidden.value = localDateStr(videos7Start);
                videosEndHidden.value = latestDateStr;
                
                const videosPicker = new Litepicker({
                    element: videosDateEl,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0,
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: videos7Start,
                    endDate: latestDate,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                videosStartHidden.value = toDateStr(date1);
                                videosEndHidden.value = toDateStr(date2);
                                if (!applyingPreset && videosPresetSelect) videosPresetSelect.value = 'custom';
                                pages.videos = 1;
                                loadVideosData();
                            }
                        });
                    }
                });
                
                datePickers['videos'] = videosPicker;
                
                // Handle preset dropdown change
                if (videosPresetSelect) {
                    videosPresetSelect.addEventListener('change', function() {
                        const val = this.value;
                        let range = null;
                        
                        switch(val) {
                            case 'yesterday': range = presetRanges['Yesterday']; break;
                            case 'last7': range = presetRanges['Last 7 Days']; break;
                            case 'last14': range = presetRanges['Last 14 Days']; break;
                            case 'last30': range = presetRanges['Last 30 Days']; break;
                            case 'thisMonth': range = presetRanges['This Month']; break;
                            case 'lastMonth': range = presetRanges['Last Month']; break;
                            case 'custom':
                                videosPicker.show();
                                return;
                        }
                        
                        if (range && range[0] && range[1]) {
                            applyingPreset = true;
                            videosPicker.setDateRange(range[0], range[1]);
                            applyingPreset = false;
                            videosStartHidden.value = localDateStr(range[0]);
                            videosEndHidden.value = localDateStr(range[1]);
                            const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            videosDateEl.value = `${formatDisplayDate(range[0])}  ${formatDisplayDate(range[1])}`;
                            pages.videos = 1;
                            loadVideosData();
                        }
                    });
                }
            }
            
            // Initialize Products date picker (matching Overview/Creators/Videos style)
            const productsDateEl = document.getElementById('productsDateRange');
            const productsStartHidden = document.getElementById('productsDateFilterStart');
            const productsEndHidden = document.getElementById('productsDateFilterEnd');
            const productsPresetSelect = document.getElementById('productsDatePresetSelect');
            
            if (productsDateEl && productsStartHidden && productsEndHidden) {
                // Default to Last 7 Days ending at latest date with data
                const products7Start = new Date(latestDate);
                products7Start.setDate(products7Start.getDate() - 6);
                productsStartHidden.value = localDateStr(products7Start);
                productsEndHidden.value = latestDateStr;
                
                const productsPicker = new Litepicker({
                    element: productsDateEl,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0,
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: products7Start,
                    endDate: latestDate,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                productsStartHidden.value = toDateStr(date1);
                                productsEndHidden.value = toDateStr(date2);
                                if (!applyingPreset && productsPresetSelect) productsPresetSelect.value = 'custom';
                                pages.products = 1;
                                loadProductsData();
                            }
                        });
                    }
                });
                
                datePickers['products'] = productsPicker;
                
                // Handle preset dropdown change
                if (productsPresetSelect) {
                    productsPresetSelect.addEventListener('change', function() {
                        const val = this.value;
                        let range = null;
                        
                        switch(val) {
                            case 'yesterday': range = presetRanges['Yesterday']; break;
                            case 'last7': range = presetRanges['Last 7 Days']; break;
                            case 'last14': range = presetRanges['Last 14 Days']; break;
                            case 'last30': range = presetRanges['Last 30 Days']; break;
                            case 'thisMonth': range = presetRanges['This Month']; break;
                            case 'lastMonth': range = presetRanges['Last Month']; break;
                            case 'custom':
                                productsPicker.show();
                                return;
                        }
                        
                        if (range && range[0] && range[1]) {
                            applyingPreset = true;
                            productsPicker.setDateRange(range[0], range[1]);
                            applyingPreset = false;
                            productsStartHidden.value = localDateStr(range[0]);
                            productsEndHidden.value = localDateStr(range[1]);
                            const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            productsDateEl.value = `${formatDisplayDate(range[0])}  ${formatDisplayDate(range[1])}`;
                            pages.products = 1;
                            loadProductsData();
                        }
                    });
                }
            }
            
            // Initialize Roster date picker
            const rosterDateEl = document.getElementById('rosterDateRange');
            const rosterStartHidden = document.getElementById('rosterDateFilterStart');
            const rosterEndHidden = document.getElementById('rosterDateFilterEnd');
            const rosterPresetSelect = document.getElementById('rosterDatePresetSelect');
            
            if (rosterDateEl && rosterStartHidden && rosterEndHidden) {
                // Default to Last 7 Days ending at latest date with data
                const roster7Start = new Date(latestDate);
                roster7Start.setDate(roster7Start.getDate() - 6);
                rosterStartHidden.value = localDateStr(roster7Start);
                rosterEndHidden.value = latestDateStr;
                
                const rosterPicker = new Litepicker({
                    element: rosterDateEl,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0,
                    minDate: minDate,
                    maxDate: maxDate,
                    startDate: roster7Start,
                    endDate: latestDate,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    lockDaysFilter: (date) => !availableDateSet.has(toDateStr(date)),
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                rosterStartHidden.value = toDateStr(date1);
                                rosterEndHidden.value = toDateStr(date2);
                                if (!applyingPreset && rosterPresetSelect) rosterPresetSelect.value = 'custom';
                                pages.roster = 1;
                                loadRosterData();
                            }
                        });
                    }
                });
                
                datePickers['roster'] = rosterPicker;
                
                // Handle preset dropdown change
                if (rosterPresetSelect) {
                    rosterPresetSelect.addEventListener('change', function() {
                        const val = this.value;
                        let range = null;
                        
                        switch(val) {
                            case 'yesterday': range = presetRanges['Yesterday']; break;
                            case 'last7': range = presetRanges['Last 7 Days']; break;
                            case 'last14': range = presetRanges['Last 14 Days']; break;
                            case 'last30': range = presetRanges['Last 30 Days']; break;
                            case 'thisMonth': range = presetRanges['This Month']; break;
                            case 'lastMonth': range = presetRanges['Last Month']; break;
                            case 'custom':
                                rosterPicker.show();
                                return;
                        }
                        
                        if (range && range[0] && range[1]) {
                            applyingPreset = true;
                            rosterPicker.setDateRange(range[0], range[1]);
                            applyingPreset = false;
                            rosterStartHidden.value = localDateStr(range[0]);
                            rosterEndHidden.value = localDateStr(range[1]);
                            const formatDisplayDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            rosterDateEl.value = `${formatDisplayDate(range[0])}  ${formatDisplayDate(range[1])}`;
                            pages.roster = 1;
                            loadRosterData();
                        }
                    });
                }
            }
        }

        function isManaged(creatorName) {
            const normalized = normalizeTikTok(creatorName);
            if (!normalized) return false;
            return managedCreators.some(mc => 
                normalizeTikTok(mc.account_1) === normalized ||
                normalizeTikTok(mc.account_2) === normalized ||
                normalizeTikTok(mc.account_3) === normalized ||
                normalizeTikTok(mc.account_4) === normalized ||
                normalizeTikTok(mc.account_5) === normalized
            );
        }

        // Check if creator is managed for a specific brand
        function isManagedForBrand(creatorName, brand) {
            const normalized = normalizeTikTok(creatorName);
            if (!normalized) return false;
            return managedCreators.some(mc => 
                mc.brand === brand && (
                    normalizeTikTok(mc.account_1) === normalized ||
                    normalizeTikTok(mc.account_2) === normalized ||
                    normalizeTikTok(mc.account_3) === normalized ||
                    normalizeTikTok(mc.account_4) === normalized ||
                    normalizeTikTok(mc.account_5) === normalized
                )
            );
        }

        function getManagedInfo(creatorName) {
            const lower = (creatorName || '').toLowerCase();
            return managedCreators.find(mc => 
                mc.account_1?.toLowerCase() === lower ||
                mc.account_2?.toLowerCase() === lower ||
                mc.account_3?.toLowerCase() === lower ||
                mc.account_4?.toLowerCase() === lower ||
                mc.account_5?.toLowerCase() === lower
            );
        }

        // Get all brand entries for a Discord name (cross-brand identity)
        function getCreatorByDiscord(discordName) {
            if (!discordName || !discordName.trim()) return [];
            const normalized = discordName.toLowerCase().trim();
            return managedCreators.filter(mc => 
                mc.discord_name?.toLowerCase().trim() === normalized
            );
        }

        // Get all brands a creator is managed for (by Discord)
        function getCreatorBrands(discordName) {
            return getCreatorByDiscord(discordName).map(mc => mc.brand);
        }

        // Check if Discord exists in any brand roster
        function isExistingCreator(discordName) {
            return getCreatorByDiscord(discordName).length > 0;
        }

        // Get canonical creator info (first entry found by Discord)
        function getCanonicalCreatorInfo(discordName) {
            const entries = getCreatorByDiscord(discordName);
            if (entries.length === 0) return null;
            // Return the entry with most complete info
            return entries.reduce((best, current) => {
                let bestScore = (best.real_name ? 1 : 0) + (best.email ? 1 : 0) + (best.account_1 ? 1 : 0);
                let currentScore = (current.real_name ? 1 : 0) + (current.email ? 1 : 0) + (current.account_1 ? 1 : 0);
                return currentScore > bestScore ? current : best;
            });
        }

        // ==================== OPS CENTER ====================
        let opsData = {
            creators: [],
            videos: [],
            currentQuadrant: 'all',
            currentTab: 'overview',
            overviewLoaded: false,
            videosLoaded: false,
            postingLoaded: false,
            creatorsLoaded: false,
            decisionsLoaded: false
        };
        
        // Thresholds for quadrant classification
        const OPS_THRESHOLDS = {
            highVideos: 5,  // 5+ videos in period = high output
            highGmv: 500    // $500+ GMV in period = high GMV
        };
        
        // Legacy function - kept for compatibility
        async function onOpsBrandFilterChange() {
            // No longer used - filters are now tab-specific
            reloadCurrentOpsTab();
        }
        
        function switchOpsTab(tab) {
            opsData.currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.ops-tab').forEach(t => {
                t.classList.remove('active');
                t.style.background = 'transparent';
                t.style.color = 'var(--text-muted)';
                t.style.boxShadow = 'none';
            });
            const activeTab = document.querySelector(`.ops-tab[data-tab="${tab}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.background = 'var(--bg-card)';
                activeTab.style.color = 'var(--text-primary)';
                activeTab.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
            }
            
            // Show/hide tab content
            document.querySelectorAll('.ops-tab-content').forEach(c => c.style.display = 'none');
            
            // Special handling for overview tab - show embedded overview content
            if (tab === 'overview') {
                const opsOverview = document.getElementById('ops-tab-overview');
                if (opsOverview) {
                    opsOverview.style.display = 'block';
                    // Load overview data if not loaded
                    if (!opsData.overviewLoaded) {
                        opsData.overviewLoaded = true;
                        loadOverviewData();
                    }
                }
            } else {
                const content = document.getElementById(`ops-tab-${tab}`);
                if (content) content.style.display = 'block';
            }
            
            // Load data for the tab if not loaded yet
            if (tab === 'videos' && !opsData.videosLoaded) {
                opsData.videosLoaded = true;
                const brand = document.getElementById('videosBrandFilter')?.value || 'all';
                loadVideoProductsFromData(brand);
                loadVideosTab();
            }
            if (tab === 'posting' && !opsData.postingLoaded) {
                opsData.postingLoaded = true;
                loadPostingData();
            }
            if (tab === 'creators' && !opsData.creatorsLoaded) {
                opsData.creatorsLoaded = true;
                loadCreatorsTab();
            }
            if (tab === 'decisions' && !opsData.decisionsLoaded) {
                opsData.decisionsLoaded = true;
                loadDecisions();
            }
        }
        
        // Reload data based on which tab is currently active
        function reloadCurrentOpsTab() {
            if (opsData.currentTab === 'overview') {
                loadOverviewData();
            } else if (opsData.currentTab === 'videos') {
                loadVideosTab();
            } else if (opsData.currentTab === 'posting') {
                loadPostingData();
            } else if (opsData.currentTab === 'creators') {
                loadCreatorsTab();
            } else if (opsData.currentTab === 'decisions') {
                loadDecisions();
            }
        }
        
        // ==================== VIDEOS TAB ====================
        // Cache for videos data
        let videosTabCache = { all: [], hot: [], rising: [], top: [], efficiency: [] };
        
        // Toggle video section visibility
        function toggleVideoSection(section) {
            const content = document.getElementById(section + 'Content');
            const toggle = document.getElementById(section + 'Toggle');
            if (!content || !toggle) return;
            
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            toggle.textContent = isHidden ? '' : '';
        }
        
        // Scroll to video section
        function scrollToVideoSection(section) {
            const el = document.getElementById('videoSection' + section.charAt(0).toUpperCase() + section.slice(1));
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Expand section if collapsed
                const content = document.getElementById(section + 'Content');
                if (content && content.style.display === 'none') {
                    toggleVideoSection(section);
                }
            }
        }
        
        // Render a video card
        function renderVideoCard(v, badge = null) {
            const postedDate = v.post_date ? new Date(v.post_date + 'T00:00:00') : null;
            const daysAgo = postedDate ? Math.floor((new Date() - postedDate) / (1000 * 60 * 60 * 24)) : null;
            const dateDisplay = daysAgo !== null ? (daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo}d ago`) : '';
            const creatorHandle = (v.creator_name || '').replace('@', '');
            const profileUrl = creatorHandle ? `https://www.tiktok.com/@${creatorHandle}` : '#';
            const videoUrl = v.video_id && creatorHandle ? `https://www.tiktok.com/@${creatorHandle}/video/${v.video_id}` : '#';
            const isManaged = isManagedForBrand(v.creator_name, v.brand);
            const brandColor = BRAND_COLORS[v.brand] || '#666';
            const thumbId = `thumb-${v.video_id || Math.random().toString(36).slice(2)}`;
            
            return `
                <div class="video-card" style="background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); position: relative; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <!-- Badge -->
                    ${badge ? `<div style="position: absolute; top: 8px; right: 8px; background: ${badge.bg}; color: ${badge.color}; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; z-index: 2;">${badge.text}</div>` : ''}
                    
                    <!-- Video Thumbnail with Play Button -->
                    <div class="video-thumb-container" id="${thumbId}" data-video-id="${v.video_id || ''}" data-creator="${creatorHandle}" 
                         style="position: relative; width: 100%; aspect-ratio: 9/16; max-height: 280px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); cursor: pointer; overflow: hidden;"
                         onclick="playVideoEmbed('${v.video_id}', '${creatorHandle}')">
                        <img class="video-thumb-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23374151' width='100' height='100'/%3E%3C/svg%3E" 
                             style="width: 100%; height: 100%; object-fit: cover; opacity: 0.3; transition: opacity 0.3s;"
                             onerror="this.style.display='none'">
                        <div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <span style="font-size: 1.5rem; margin-left: 4px;"></span>
                            </div>
                            <span style="color: white; font-size: 0.7rem; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">Click to play</span>
                        </div>
                        <!-- GMV Overlay -->
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 12px;">
                            <div style="color: #22c55e; font-size: 1.4rem; font-weight: 800;">$${(v.gmv || 0).toLocaleString()}</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.7rem;">${(v.orders || 0)} orders</div>
                        </div>
                    </div>
                    
                    <!-- Info -->
                    <div style="padding: 12px;">
                        <!-- Creator + Brand -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <a href="${profileUrl}" target="_blank" style="font-weight: 600; font-size: 0.85rem; color: var(--text-primary); text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                ${isManaged ? '<span style="color: #22c55e;"></span>' : ''}
                                @${sanitize(creatorHandle || 'Unknown')}
                            </a>
                            <span style="color: ${brandColor}; font-size: 0.7rem; font-weight: 500;">${formatBrandName(v.brand)}</span>
                        </div>
                        
                        <!-- Product Tags -->
                        ${v.product_names && v.product_names.length > 0 ? `
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px;">
                                ${v.product_names.slice(0, 2).map(pn => `<span style="background: rgba(139, 92, 246, 0.15); color: #a78bfa; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 500;"> ${sanitize(pn)}</span>`).join('')}
                                ${v.product_names.length > 2 ? `<span style="color: var(--text-muted); font-size: 0.65rem;">+${v.product_names.length - 2}</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Video Title -->
                        <div style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 8px; min-height: 2.1em;">
                            ${sanitize(v.video_title || 'Untitled video')}
                        </div>
                        
                        <!-- Footer -->
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: var(--text-muted);">
                            <span>${dateDisplay || '-'}</span>
                            <div style="display: flex; gap: 6px;">
                                <a href="${videoUrl}" target="_blank" style="color: var(--accent); text-decoration: none;">TikTok </a>
                                <button onclick="event.stopPropagation(); copyVideoLink('${videoUrl}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0; font-size: 0.7rem;"></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Play video in modal embed
        function playVideoEmbed(videoId, creatorHandle) {
            if (!videoId) {
                showToast('No video ID available', 'warning');
                return;
            }
            
            const modal = document.getElementById('videoPlayerModal');
            const embedContainer = document.getElementById('videoEmbedContainer');
            const infoContainer = document.getElementById('videoEmbedInfo');
            
            // Show modal with loading state
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            embedContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                    <div class="spinner"></div>
                </div>
            `;
            
            // Load TikTok embed
            setTimeout(() => {
                embedContainer.innerHTML = `
                    <iframe 
                        src="https://www.tiktok.com/embed/v2/${videoId}"
                        style="width: 100%; height: 100%; border: none; border-radius: 12px;"
                        allow="encrypted-media; fullscreen"
                        allowfullscreen
                    ></iframe>
                `;
            }, 100);
            
            // Update info
            if (infoContainer) {
                infoContainer.innerHTML = `
                    <a href="https://www.tiktok.com/@${creatorHandle}" target="_blank" style="color: var(--accent); text-decoration: none; font-weight: 600;">@${creatorHandle}</a>
                    <span style="margin: 0 8px; color: var(--text-muted);"></span>
                    <a href="https://www.tiktok.com/@${creatorHandle}/video/${videoId}" target="_blank" style="color: var(--text-muted); text-decoration: none;">Open in TikTok </a>
                `;
            }
        }
        
        // Close video player modal
        function closeVideoPlayer() {
            const modal = document.getElementById('videoPlayerModal');
            const embedContainer = document.getElementById('videoEmbedContainer');
            modal.style.display = 'none';
            embedContainer.innerHTML = '';
            document.body.style.overflow = '';
        }
        
        // Load video thumbnails for visible cards
        async function loadVideoThumbnails() {
            const containers = document.querySelectorAll('.video-thumb-container[data-video-id]');
            
            for (const container of containers) {
                const videoId = container.dataset.videoId;
                const creator = container.dataset.creator;
                
                if (!videoId || videoId.length < 5) continue;
                
                const img = container.querySelector('.video-thumb-img');
                if (!img) continue;
                
                // Check if already loaded
                if (img.dataset.loaded === 'true') continue;
                
                try {
                    const videoUrl = `https://www.tiktok.com/@${creator}/video/${videoId}`;
                    const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(videoUrl)}`;
                    
                    const response = await fetch(oembedUrl);
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    if (data.thumbnail_url) {
                        img.src = data.thumbnail_url;
                        img.style.opacity = '1';
                        img.dataset.loaded = 'true';
                    }
                } catch (err) {
                    // Silently fail - thumbnail just won't load
                }
            }
        }
        
        // Render efficiency card for a creator
        function renderEfficiencyCard(c) {
            const efficiency = c.gmvPerVideo >= 100 ? 'high' : c.gmvPerVideo >= 30 ? 'medium' : 'low';
            const effConfig = {
                high: { emoji: '', color: 'var(--success)', label: 'Crushing it', tip: 'Averaging $100+ per video - top performer!' },
                medium: { emoji: '', color: 'var(--warning)', label: 'Solid', tip: 'Averaging $30-99 per video - consistent performer' },
                low: { emoji: '', color: 'var(--text-muted)', label: 'Room to grow', tip: 'Under $30 per video - may need coaching or better content strategy' }
            };
            const eff = effConfig[efficiency];
            const creatorHandle = (c.name || '').replace('@', '');
            const profileUrl = creatorHandle ? `https://www.tiktok.com/@${creatorHandle}` : '#';
            const isManaged = isManagedForBrand(c.name, c.brand);
            
            return `
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--border); border-left: 4px solid ${eff.color};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <a href="${profileUrl}" target="_blank" style="font-weight: 700; color: var(--text-primary); text-decoration: none;" title="${isManaged ? 'Managed creator - in our roster' : 'Unmanaged creator'}">
                            ${isManaged ? '<span title="Creator is in our managed roster"></span> ' : ''}${sanitize(c.name)}
                        </a>
                        <span style="font-size: 1.5rem;" title="${eff.tip}">${eff.emoji}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                        <div title="Total videos posted by this creator in selected period">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent);">${c.videos}</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Videos</div>
                        </div>
                        <div title="Total sales generated across all videos">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--success);">$${c.gmv.toLocaleString()}</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Total GMV</div>
                        </div>
                        <div title="Average GMV per video (Total GMV  Videos) - ${eff.tip}">
                            <div style="font-size: 1.1rem; font-weight: 700; color: ${eff.color};">$${c.gmvPerVideo.toFixed(0)}</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Per Video</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center;">
                        <span class="badge" style="font-size: 0.65rem;">${formatBrandName(c.brand)}</span>
                        <span style="color: ${eff.color};" title="${eff.tip}">${eff.label}</span>
                    </div>
                </div>
            `;
        }
        
        // Copy video link
        function copyVideoLink(url) {
            navigator.clipboard.writeText(url);
            showToast('Video link copied!', 'success');
        }
        
        // Copy Discord message for a specific section
        function copyDiscordMessage(section) {
            const brand = document.getElementById('videosBrandFilter')?.value || 'all';
            const brandName = brand === 'all' ? 'All Brands' : BRAND_DISPLAY[brand];
            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            let text = '';
            let items = [];
            
            switch(section) {
                case 'hot':
                    items = videosTabCache.hot.slice(0, 10);
                    if (items.length === 0) {
                        showToast('No hot videos to copy', 'warning');
                        return;
                    }
                    text = ` **HOT VIDEOS - ${brandName}** \n`;
                    text += `_New videos crushing it this week (${today})_\n\n`;
                    items.forEach((v, i) => {
                        const creatorHandle = (v.creator_name || '').replace('@', '');
                        const isManaged = isManagedForBrand(v.creator_name, v.brand) ? '' : '';
                        text += `**${i + 1}. ${isManaged}@${creatorHandle}** - \`$${(v.gmv || 0).toLocaleString()}\`\n`;
                        if (v.video_id && creatorHandle) {
                            text += `   <https://www.tiktok.com/@${creatorHandle}/video/${v.video_id}>\n`;
                        }
                    });
                    break;
                    
                case 'rising':
                    items = videosTabCache.rising.slice(0, 10);
                    if (items.length === 0) {
                        showToast('No rising videos to copy', 'warning');
                        return;
                    }
                    text = ` **RISING VIDEOS - ${brandName}** \n`;
                    text += `_Still performing strong after 7+ days (${today})_\n\n`;
                    items.forEach((v, i) => {
                        const creatorHandle = (v.creator_name || '').replace('@', '');
                        const isManaged = isManagedForBrand(v.creator_name, v.brand) ? '' : '';
                        text += `**${i + 1}. ${isManaged}@${creatorHandle}** - \`$${(v.gmv || 0).toLocaleString()}\`\n`;
                        if (v.video_id && creatorHandle) {
                            text += `   <https://www.tiktok.com/@${creatorHandle}/video/${v.video_id}>\n`;
                        }
                    });
                    break;
                    
                case 'top':
                    items = videosTabCache.top.slice(0, 10);
                    if (items.length === 0) {
                        showToast('No top videos to copy', 'warning');
                        return;
                    }
                    text = ` **TOP PERFORMERS - ${brandName}** \n`;
                    text += `_Highest GMV videos this period (${today})_\n\n`;
                    items.forEach((v, i) => {
                        const creatorHandle = (v.creator_name || '').replace('@', '');
                        const isManaged = isManagedForBrand(v.creator_name, v.brand) ? '' : '';
                        const medal = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : `${i + 1}.`;
                        text += `**${medal} ${isManaged}@${creatorHandle}** - \`$${(v.gmv || 0).toLocaleString()}\`\n`;
                        if (v.video_id && creatorHandle) {
                            text += `   <https://www.tiktok.com/@${creatorHandle}/video/${v.video_id}>\n`;
                        }
                    });
                    break;
                    
                case 'efficiency':
                    items = videosTabCache.efficiency.slice(0, 10);
                    if (items.length === 0) {
                        showToast('No efficiency data to copy', 'warning');
                        return;
                    }
                    text = ` **CREATOR EFFICIENCY - ${brandName}** \n`;
                    text += `_Who's making every video count (${today})_\n\n`;
                    items.forEach((c, i) => {
                        const creatorHandle = (c.name || '').replace('@', '');
                        const isManaged = isManagedForBrand(c.name, c.brand) ? '' : '';
                        const eff = c.gmvPerVideo >= 100 ? '' : c.gmvPerVideo >= 30 ? '' : '';
                        text += `**${i + 1}. ${isManaged}@${creatorHandle}** ${eff}\n`;
                        text += `   ${c.videos} videos  \`$${c.gmv.toLocaleString()}\` total  \`$${c.gmvPerVideo.toFixed(0)}/video\`\n`;
                    });
                    text += `\n_Legend:  = $100+/vid,  = $30-99/vid,  = <$30/vid_`;
                    break;
            }
            
            navigator.clipboard.writeText(text);
            showToast(`${section.charAt(0).toUpperCase() + section.slice(1)} copied for Discord!`, 'success');
        }
        
        // Track expanded state for Show More
        let videosShowAllState = { hot: false, rising: false, top: false, efficiency: false };
        
        // Show more videos in a section
        function showMoreVideos(section) {
            videosShowAllState[section] = true;
            
            // Re-render the section with all items
            const gridId = section === 'efficiency' ? 'efficiencyGrid' : `${section}VideosGrid`;
            const grid = document.getElementById(gridId);
            const items = videosTabCache[section];
            
            if (section === 'efficiency') {
                grid.innerHTML = items.map(c => renderEfficiencyCard(c)).join('');
            } else {
                const badgeConfig = {
                    hot: { text: ' HOT', bg: 'linear-gradient(135deg, #f97316, #ea580c)', color: 'white' },
                    rising: { text: ' RISING', bg: 'linear-gradient(135deg, #22c55e, #16a34a)', color: 'white' },
                    top: null
                };
                grid.innerHTML = items.map((v, i) => {
                    let badge = badgeConfig[section];
                    if (section === 'top' && i < 3) {
                        badge = { text: `#${i+1}`, bg: 'linear-gradient(135deg, #f5c518, #ca8a04)', color: 'black' };
                    }
                    return renderVideoCard(v, badge);
                }).join('');
            }
            
            // Hide the Show More button
            document.getElementById(`${section}ShowMore`).style.display = 'none';
        }
        
        // Filter ops videos table by search
        function filterOpsVideosTable() {
            const search = document.getElementById('opsVideosSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#allVideosTableBody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const match = text.includes(search);
                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });
            
            // Update count
            document.getElementById('allCount').textContent = visibleCount;
        }
        
        // Export videos to CSV
        function exportVideosCSV() {
            const videos = videosTabCache.all;
            if (videos.length === 0) {
                showToast('No videos to export', 'warning');
                return;
            }
            
            const headers = ['Rank', 'Video Title', 'Creator', 'Brand', 'Posted', 'GMV', 'Orders', 'Managed', 'Video URL'];
            const rows = videos.map((v, i) => {
                const creatorHandle = (v.creator_name || '').replace('@', '');
                const videoUrl = v.video_id && creatorHandle ? `https://www.tiktok.com/@${creatorHandle}/video/${v.video_id}` : '';
                const postedDate = v.post_date || '';
                const isManaged = isManagedForBrand(v.creator_name, v.brand) ? 'Yes' : 'No';
                
                return [
                    i + 1,
                    `"${(v.video_title || 'Untitled').replace(/"/g, '""')}"`,
                    creatorHandle,
                    formatBrandName(v.brand),
                    postedDate,
                    (v.gmv || 0).toFixed(2),
                    v.orders || 0,
                    isManaged,
                    videoUrl
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `videos-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Videos exported!', 'success');
        }
        
        // Filter videos display based on managed status
        function filterVideosDisplay() {
            loadVideosTab();
        }
        
        async function loadVideosTab() {
            const brand = document.getElementById('videosBrandFilter')?.value || 'all';
            const product = document.getElementById('videosProductFilter')?.value || 'all';
            const statusFilter = document.getElementById('videosStatusFilter')?.value || 'all';
            
            // Get date range from Ops Center date picker
            const startStr = document.getElementById('opsDateFilterStart')?.value;
            const endStr = document.getElementById('opsDateFilterEnd')?.value;
            
            let startDate, endDate;
            if (startStr && endStr) {
                startDate = startStr;
                endDate = endStr;
            } else {
                const end = new Date();
                end.setDate(end.getDate() - 1);
                const start = new Date(end);
                start.setDate(start.getDate() - 6);
                startDate = localDateStr(start);
                endDate = localDateStr(end);
            }
            
            // Update context
            const startDisplay = new Date(startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endDisplay = new Date(endDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('videosTabContext').textContent = `${startDisplay} - ${endDisplay}  ${brand === 'all' ? 'All Brands' : BRAND_DISPLAY[brand]}`;
            
            try {
                
                // Fetch video_performance data - need ordering for consistent results
                let perfQuery = supabaseClient.from('video_performance')
                    .select('*')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate);
                
                if (brand !== 'all') {
                    perfQuery = perfQuery.eq('brand', brand);
                }
                
                // Apply ordering and limit after filters
                perfQuery = perfQuery
                    .order('video_id', { ascending: true })
                    .order('report_date', { ascending: true })
                    .limit(30000);  // Match Supabase global limit
                
                const perfResult = await perfQuery;
                
                if (perfResult.error) throw perfResult.error;
                
                const videos = perfResult.data || [];
                
                // Get unique video_ids from performance data
                const uniqueVideoIds = [...new Set(videos.map(v => v.video_id))];
                
                // Fetch post_dates only for videos we actually have performance data for
                // Batch into chunks of 500 to avoid query size limits
                const postDateMap = new Map();
                const chunkSize = 500;
                
                for (let i = 0; i < uniqueVideoIds.length; i += chunkSize) {
                    const chunk = uniqueVideoIds.slice(i, i + chunkSize);
                    let videosQuery = supabaseClient.from('videos')
                        .select('video_id, post_date')
                        .in('video_id', chunk);
                    
                    if (brand !== 'all') {
                        videosQuery = videosQuery.eq('brand', brand);
                    }
                    
                    const { data: videosData, error: videosError } = await videosQuery;
                    if (!videosError && videosData) {
                        videosData.forEach(v => {
                            if (v.post_date) {
                                postDateMap.set(v.video_id, v.post_date);
                            }
                        });
                    }
                }
                
                // Post date lookup complete
                
                // Filter by product name if selected
                // Filter by product selection (can be group or individual product)
                const productFilterValue = product;
                const productNamesToFilter = getProductNamesForFilter(productFilterValue);
                
                let filteredVideos = videos;
                if (productNamesToFilter && productNamesToFilter.length > 0) {
                    const productSet = new Set(productNamesToFilter);
                    filteredVideos = filteredVideos.filter(v => productSet.has(v.product_name));
                }
                
                // Aggregate by video_id - SUM GMV across all days in range
                const videoMap = new Map();
                filteredVideos.forEach(v => {
                    const existing = videoMap.get(v.video_id);
                    const productName = v.product_name || null;
                    if (!existing) {
                        videoMap.set(v.video_id, {
                            ...v,
                            gmv: v.gmv || 0,
                            orders: v.orders || 0,
                            post_date: postDateMap.get(v.video_id) || null,
                            product_name: productName,
                            product_names: productName ? new Set([productName]) : new Set()
                        });
                    } else {
                        existing.gmv = (existing.gmv || 0) + (v.gmv || 0);
                        existing.orders = (existing.orders || 0) + (v.orders || 0);
                        if (productName) existing.product_names.add(productName);
                        if (v.report_date > existing.report_date) {
                            existing.report_date = v.report_date;
                        }
                    }
                });
                
                let uniqueVideos = Array.from(videoMap.values()).map(v => ({
                    ...v,
                    product_names: v.product_names ? Array.from(v.product_names) : []
                }));
                
                // Apply managed filter
                if (statusFilter === 'managed') {
                    uniqueVideos = uniqueVideos.filter(v => isManagedForBrand(v.creator_name, v.brand));
                } else if (statusFilter === 'unmanaged') {
                    uniqueVideos = uniqueVideos.filter(v => !isManagedForBrand(v.creator_name, v.brand));
                }
                
                const totalVideos = uniqueVideos.length;
                const totalGmv = uniqueVideos.reduce((sum, v) => sum + (v.gmv || 0), 0);
                const avgGmv = totalVideos > 0 ? totalGmv / totalVideos : 0;
                
                // Categorize videos - define date cutoffs
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const sevenDaysAgoStr = localDateStr(sevenDaysAgo);
                
                const fourteenDaysAgo = new Date();
                fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
                const fourteenDaysAgoStr = localDateStr(fourteenDaysAgo);
                
                // HOT NOW: New videos (last 7 days) with $100+ GMV
                const hotVideos = uniqueVideos
                    .filter(v => v.post_date && v.post_date >= sevenDaysAgoStr && (v.gmv || 0) >= 100)
                    .sort((a, b) => (b.gmv || 0) - (a.gmv || 0));
                
                // RISING: Videos posted 7-14 days ago that are still performing well
                const risingVideos = uniqueVideos
                    .filter(v => v.post_date && v.post_date < sevenDaysAgoStr && v.post_date >= fourteenDaysAgoStr && (v.gmv || 0) >= 50)
                    .sort((a, b) => (b.gmv || 0) - (a.gmv || 0));
                
                // TOP PERFORMERS: Highest GMV overall (that aren't already in Hot)
                const hotIds = new Set(hotVideos.map(v => v.video_id));
                const topVideos = uniqueVideos
                    .filter(v => !hotIds.has(v.video_id))
                    .sort((a, b) => (b.gmv || 0) - (a.gmv || 0))
                    .slice(0, 20);
                
                // Creator Efficiency
                const creatorStats = {};
                uniqueVideos.forEach(v => {
                    const key = `${v.creator_name}-${v.brand}`;
                    if (!creatorStats[key]) {
                        creatorStats[key] = { name: v.creator_name, brand: v.brand, videos: 0, gmv: 0 };
                    }
                    creatorStats[key].videos++;
                    creatorStats[key].gmv += (v.gmv || 0);
                });
                
                const efficiencyData = Object.values(creatorStats)
                    .filter(c => c.videos >= 2) // At least 2 videos
                    .map(c => ({ ...c, gmvPerVideo: c.videos > 0 ? c.gmv / c.videos : 0 }))
                    .sort((a, b) => b.gmvPerVideo - a.gmvPerVideo)
                    .slice(0, 20);
                
                // Cache data
                videosTabCache = {
                    all: uniqueVideos,
                    hot: hotVideos,
                    rising: risingVideos,
                    top: topVideos,
                    efficiency: efficiencyData
                };
                
                // Update stats
                document.getElementById('videosStatHot').textContent = hotVideos.length;
                document.getElementById('videosStatRising').textContent = risingVideos.length;
                document.getElementById('videosStatTop').textContent = Math.min(topVideos.length, 10);
                document.getElementById('videosStatTotal').textContent = totalVideos.toLocaleString();
                document.getElementById('videosStatGmv').textContent = '$' + totalGmv.toLocaleString(undefined, {maximumFractionDigits: 0});
                document.getElementById('videosStatAvg').textContent = '$' + avgGmv.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                // Update counts
                document.getElementById('hotCount').textContent = hotVideos.length;
                document.getElementById('risingCount').textContent = risingVideos.length;
                document.getElementById('topCount').textContent = topVideos.length;
                document.getElementById('efficiencyCount').textContent = efficiencyData.length;
                document.getElementById('allCount').textContent = totalVideos;
                
                // Reset show all state on reload
                videosShowAllState = { hot: false, rising: false, top: false, efficiency: false };
                
                const INITIAL_DISPLAY = 12;
                
                // Render HOT NOW section
                const hotGrid = document.getElementById('hotVideosGrid');
                if (hotVideos.length === 0) {
                    hotGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);"> No hot videos yet this week. Keep posting!</div>';
                    document.getElementById('hotShowMore').style.display = 'none';
                } else {
                    hotGrid.innerHTML = hotVideos.slice(0, INITIAL_DISPLAY).map(v => 
                        renderVideoCard(v, { text: ' HOT', bg: 'linear-gradient(135deg, #f97316, #ea580c)', color: 'white' })
                    ).join('');
                    // Show More button if needed
                    document.getElementById('hotShowMore').style.display = hotVideos.length > INITIAL_DISPLAY ? 'block' : 'none';
                    document.getElementById('hotTotalCount').textContent = hotVideos.length;
                }
                
                // Render RISING section
                const risingGrid = document.getElementById('risingVideosGrid');
                if (risingVideos.length === 0) {
                    risingGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);"> No rising videos in the 7-14 day window</div>';
                    document.getElementById('risingShowMore').style.display = 'none';
                } else {
                    risingGrid.innerHTML = risingVideos.slice(0, INITIAL_DISPLAY).map(v => 
                        renderVideoCard(v, { text: ' RISING', bg: 'linear-gradient(135deg, #22c55e, #16a34a)', color: 'white' })
                    ).join('');
                    document.getElementById('risingShowMore').style.display = risingVideos.length > INITIAL_DISPLAY ? 'block' : 'none';
                    document.getElementById('risingTotalCount').textContent = risingVideos.length;
                }
                
                // Render TOP PERFORMERS section
                const topGrid = document.getElementById('topVideosGrid');
                if (topVideos.length === 0) {
                    topGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);"> No videos found in this period</div>';
                    document.getElementById('topShowMore').style.display = 'none';
                } else {
                    topGrid.innerHTML = topVideos.slice(0, INITIAL_DISPLAY).map((v, i) => 
                        renderVideoCard(v, i < 3 ? { text: `#${i+1}`, bg: 'linear-gradient(135deg, #f5c518, #ca8a04)', color: 'black' } : null)
                    ).join('');
                    document.getElementById('topShowMore').style.display = topVideos.length > INITIAL_DISPLAY ? 'block' : 'none';
                    document.getElementById('topTotalCount').textContent = topVideos.length;
                }
                
                // Render EFFICIENCY section
                const effGrid = document.getElementById('efficiencyGrid');
                if (efficiencyData.length === 0) {
                    effGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);"> Need more video data to calculate efficiency</div>';
                    document.getElementById('efficiencyShowMore').style.display = 'none';
                } else {
                    effGrid.innerHTML = efficiencyData.slice(0, INITIAL_DISPLAY).map(c => renderEfficiencyCard(c)).join('');
                    document.getElementById('efficiencyShowMore').style.display = efficiencyData.length > INITIAL_DISPLAY ? 'block' : 'none';
                    document.getElementById('efficiencyTotalCount').textContent = efficiencyData.length;
                }
                
                // Render ALL VIDEOS table
                const sortedAll = [...uniqueVideos].sort((a, b) => (b.gmv || 0) - (a.gmv || 0));
                document.getElementById('allVideosTableBody').innerHTML = sortedAll.slice(0, 100).map((v, i) => {
                    const postedDate = v.post_date ? new Date(v.post_date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '-';
                    const creatorHandle = (v.creator_name || '').replace('@', '');
                    const profileUrl = creatorHandle ? `https://www.tiktok.com/@${creatorHandle}` : '#';
                    const videoUrl = v.video_id && creatorHandle ? `https://www.tiktok.com/@${creatorHandle}/video/${v.video_id}` : '#';
                    const isManaged = isManagedForBrand(v.creator_name, v.brand);
                    const isHot = hotIds.has(v.video_id);
                    
                    return `
                        <tr>
                            <td>${i + 1}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${v.video_id ? `<a href="${videoUrl}" target="_blank" style="color: var(--text-primary); text-decoration: none;" title="${sanitize(v.video_title || 'Untitled')}">${sanitize(v.video_title || 'Untitled')}</a>` : sanitize(v.video_title || 'Untitled')}
                            </td>
                            <td>
                                ${isManaged ? ' ' : ''}<a href="${profileUrl}" target="_blank" style="color: var(--accent); text-decoration: none;">${sanitize(v.creator_name || 'Unknown')}</a>
                            </td>
                            <td><span class="badge">${formatBrandName(v.brand)}</span></td>
                            <td style="text-align: center; font-size: 0.85rem; color: var(--text-muted);">${postedDate}</td>
                            <td style="text-align: right; font-weight: 600; color: var(--success);">$${(v.gmv || 0).toLocaleString()}</td>
                            <td style="text-align: right;">${(v.orders || 0).toLocaleString()}</td>
                            <td style="text-align: center;">
                                ${isHot ? '<span style="color: #f97316;"></span>' : isManaged ? '<span style="color: var(--success);"></span>' : '<span style="color: var(--text-muted);">-</span>'}
                            </td>
                            <td style="text-align: center;">
                                ${v.video_id ? `<a href="${videoUrl}" target="_blank" class="btn btn-small" style="padding: 4px 8px; font-size: 0.75rem;">View</a>` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-muted);">No videos found</td></tr>';
                
                // Load thumbnails for visible video cards
                setTimeout(() => loadVideoThumbnails(), 100);
                
            } catch (err) {
                console.error('Error loading videos tab:', err);
                showToast('Error loading videos', 'error');
            }
        }
        
        function onVideosBrandFilterChange() {
            const brand = document.getElementById('videosBrandFilter').value;
            loadVideoProductsFromData(brand);
            loadVideosTab();
        }
        
        // Load product names directly from video_performance data
        async function loadVideoProductsFromData(brand) {
            const select = document.getElementById('videosProductFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="all">All Products</option>';
            
            try {
                // First, load product groups for this brand
                let groupsData = [];
                try {
                    let groupQuery = supabaseClient.from('product_groups')
                        .select('*')
                        .eq('status', 'active');
                    
                    if (brand !== 'all') {
                        groupQuery = groupQuery.eq('brand', brand);
                    }
                    
                    const { data: groups, error: groupError } = await groupQuery;
                    if (!groupError && groups && groups.length > 0) {
                        groupsData = groups;
                    }
                } catch (e) {
                    // Table might not exist yet
                    console.log('Product groups not available');
                }
                
                // Add groups section if we have any
                if (groupsData.length > 0) {
                    const groupOptgroup = document.createElement('optgroup');
                    groupOptgroup.label = ' GROUPS';
                    
                    groupsData.forEach(g => {
                        const option = document.createElement('option');
                        option.value = 'group:' + g.id;
                        option.textContent = `${g.display_name} (${(g.product_names || []).length})`;
                        option.dataset.productNames = JSON.stringify(g.product_names || []);
                        groupOptgroup.appendChild(option);
                    });
                    
                    select.appendChild(groupOptgroup);
                }
                
                // Query distinct product names from video_performance
                let query = supabaseClient.from('video_performance')
                    .select('product_name')
                    .not('product_name', 'is', null);
                
                if (brand !== 'all') {
                    query = query.eq('brand', brand);
                }
                
                const { data, error } = await query;
                if (error) throw error;
                
                // Get unique product names
                const productNames = [...new Set((data || []).map(r => r.product_name).filter(n => n && n.trim()))];
                productNames.sort();
                
                // Add products section
                if (productNames.length > 0) {
                    const productOptgroup = document.createElement('optgroup');
                    productOptgroup.label = ' PRODUCTS';
                    
                    productNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = 'product:' + name;
                        option.textContent = name.length > 50 ? name.substring(0, 50) + '...' : name;
                        option.title = name;
                        productOptgroup.appendChild(option);
                    });
                    
                    select.appendChild(productOptgroup);
                }
                
                // Store groups for filter reference
                window.videoProductGroups = groupsData;
                
            } catch (err) {
                console.error('Error loading video products:', err);
            }
        }
        
        // Helper to get product names for filtering based on selection
        function getProductNamesForFilter(filterValue) {
            if (!filterValue || filterValue === 'all') {
                return null; // No filter
            }
            
            if (filterValue.startsWith('group:')) {
                const groupId = filterValue.replace('group:', '');
                const group = (window.videoProductGroups || []).find(g => g.id === groupId);
                return group ? group.product_names : [];
            }
            
            if (filterValue.startsWith('product:')) {
                return [filterValue.replace('product:', '')];
            }
            
            // Legacy: just a product name
            return [filterValue];
        }
        
        // ==================== CREATORS TAB ====================
        let creatorsTabData = [];
        let creatorsTabCategories = { attention: [], top: [], roi: [], all: [] };
        
        // Toggle creator section visibility
        function toggleCreatorSection(section) {
            const content = document.getElementById(section + 'Content');
            const toggle = document.getElementById(section + 'Toggle');
            if (!content || !toggle) return;
            
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            toggle.textContent = isHidden ? '' : '';
            
            // Update header border radius
            const header = content.previousElementSibling;
            if (header) {
                header.style.borderRadius = isHidden ? '12px 12px 0 0' : '12px';
            }
        }
        
        // Scroll to creator section
        function scrollToCreatorSection(section) {
            const el = document.getElementById('creatorSection' + section.charAt(0).toUpperCase() + section.slice(1));
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                const content = document.getElementById(section + 'Content');
                if (content && content.style.display === 'none') {
                    toggleCreatorSection(section);
                }
            }
        }
        
        // Helper: Check if creator has any retainer (overall OR product-specific)
        function hasAnyRetainer(creator) {
            if ((creator.retainer || 0) > 0) return true;
            const productRetainers = creator.product_retainers || {};
            return Object.values(productRetainers).some(r => (r || 0) > 0);
        }
        
        // Helper: Check if creator is assigned to any products (includes affiliates)
        function hasAnyProductAssignment(creator) {
            const productRetainers = creator.product_retainers || {};
            return Object.keys(productRetainers).length > 0;
        }
        
        // Helper: Get product assignment pills HTML
        function getProductAssignmentPills(creator, maxShow = 2) {
            const productRetainers = creator.product_retainers || {};
            const keys = Object.keys(productRetainers);
            if (keys.length === 0) return '';
            
            const pills = keys.slice(0, maxShow).map(key => {
                const value = productRetainers[key];
                let style = '';
                let text = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()).substring(0, 12);
                
                if (value === 0) {
                    // Affiliate
                    style = 'background: var(--blue-dim); color: var(--blue);';
                    text += ' (A)';
                } else if (value === null || value === undefined) {
                    // Not set - warning
                    style = 'background: var(--danger-dim); color: var(--danger);';
                    text = ' ' + text;
                } else {
                    // Has retainer
                    style = 'background: var(--success-dim); color: var(--success);';
                }
                
                return `<span style="font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; ${style}">${text}</span>`;
            }).join(' ');
            
            const more = keys.length > maxShow ? `<span style="font-size: 0.65rem; color: var(--text-muted);">+${keys.length - maxShow}</span>` : '';
            
            return pills + more;
        }
        
        // Helper: Get total retainer (brand + all products)
        function getTotalRetainer(creator) {
            let total = creator.retainer || 0;
            const productRetainers = creator.product_retainers || {};
            Object.values(productRetainers).forEach(r => total += (r || 0));
            return total;
        }
        
        // Helper: Get retainer breakdown display HTML
        function getRetainerBreakdownHtml(creator) {
            const baseRetainer = creator.retainer || 0;
            const productRetainers = creator.product_retainers || {};
            const productRetainerEntries = Object.entries(productRetainers).filter(([k, v]) => v && v > 0);
            const totalRetainer = getTotalRetainer(creator);
            
            if (baseRetainer > 0 || productRetainerEntries.length > 0) {
                const parts = [];
                if (baseRetainer > 0) {
                    parts.push(`<span style="color: var(--success);"> ${fmtMoney(baseRetainer)} base</span>`);
                }
                productRetainerEntries.forEach(([key, value]) => {
                    const displayName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    parts.push(`<span style="color: #8b5cf6;"> ${fmtMoney(value)} ${displayName}</span>`);
                });
                let html = parts.join(' + ');
                if (parts.length > 1) {
                    html += ` <span style="color: var(--text-muted); font-size: 0.75rem;">= ${fmtMoney(totalRetainer)}/mo</span>`;
                } else {
                    html += '<span style="color: var(--text-muted); font-size: 0.75rem;">/mo</span>';
                }
                return html;
            } else if (baseRetainer === 0 || Object.values(productRetainers).some(v => v === 0)) {
                return '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.7rem;">Affiliate</span>';
            }
            return '';
        }
        
        // Render a creator management card
        function renderCreatorMgmtCard(c, badge = null) {
            if (!c) return '';  // Safety check
            const accounts = Array.isArray(c.accounts) ? c.accounts : [];
            const accountLinks = accounts.slice(0, 3).map(a => 
                `<a href="https://tiktok.com/@${a}" target="_blank" style="color: var(--accent); text-decoration: none; font-size: 0.8rem;">@${sanitize(a)}</a>`
            ).join(', ');
            const moreAccounts = accounts.length > 3 ? ` +${accounts.length - 3}` : '';
            
            const totalRetainer = getTotalRetainer(c);
            const roi = totalRetainer > 0 ? (c.gmv / totalRetainer) : null;
            const roiDisplay = roi !== null ? roi.toFixed(1) + 'x' : '-';
            const roiColor = roi === null ? 'var(--text-muted)' : roi >= 3 ? 'var(--success)' : roi >= 1 ? 'var(--warning)' : 'var(--error)';
            
            const statusColors = {
                'Active': 'var(--success)',
                'On Hold': 'var(--warning)',
                'Churned': 'var(--danger)'
            };
            const status = c.status || 'Active';
            const brandColor = BRAND_COLORS[c.brand] || '#666';
            
            return `
                <div class="creator-card" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--border); position: relative; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                    <!-- Badge -->
                    ${badge ? `<div style="position: absolute; top: -8px; right: 12px; background: ${badge.bg}; color: ${badge.color}; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700;">${badge.text}</div>` : ''}
                    
                    <!-- Header: Name + Status -->
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 700; font-size: 1rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${sanitize(c.displayName || c.account_1 || 'Unknown')}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">
                                ${accountLinks}${moreAccounts ? `<span style="color: var(--text-muted);"> ${moreAccounts}</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px; flex-shrink: 0;">
                            <span style="background: ${statusColors[status]}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">${status}</span>
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--success);">$${(c.gmv || 0).toLocaleString()}</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">GMV</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--blue);">${totalRetainer ? '$' + totalRetainer.toLocaleString() : '-'}</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Retainer</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 8px;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: ${roiColor};">${roiDisplay}</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">ROI</div>
                        </div>
                    </div>
                    
                    <!-- Footer: Brand + Videos + Actions -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: ${brandColor}20; color: ${brandColor}; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;">${formatBrandName(c.brand)}</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted);"> ${c.videos || 0} videos</span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="editCreator(${c.id})" class="btn btn-small" style="padding: 4px 8px; font-size: 0.7rem;">Edit</button>
                            ${accounts[0] ? `<a href="https://tiktok.com/@${accounts[0]}" target="_blank" class="btn btn-small" style="padding: 4px 8px; font-size: 0.7rem;">TikTok</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadCreatorsTab() {
            const brand = document.getElementById('creatorsBrandFilter')?.value || 'all';
            const product = document.getElementById('creatorsProductFilter')?.value || 'all';
            const statusFilter = document.getElementById('creatorsStatusFilter')?.value || 'active';
            
            // Get date range from Ops Center date picker
            const startStr = document.getElementById('opsDateFilterStart')?.value;
            const endStr = document.getElementById('opsDateFilterEnd')?.value;
            
            let startDate, endDate;
            if (startStr && endStr) {
                startDate = startStr;
                endDate = endStr;
            } else {
                const end = new Date();
                end.setDate(end.getDate() - 1);
                const start = new Date(end);
                start.setDate(start.getDate() - 29);
                startDate = localDateStr(start);
                endDate = localDateStr(end);
            }
            
            // Update context
            const startDisplay = new Date(startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endDisplay = new Date(endDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('creatorsTabContext').textContent = `${startDisplay} - ${endDisplay}  ${brand === 'all' ? 'All Brands' : BRAND_DISPLAY[brand]}`;
            
            try {
                // Get managed creators
                let query = supabaseClient.from('managed_creators')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (brand !== 'all') {
                    query = query.eq('brand', brand);
                }
                
                const { data: creators, error } = await query;
                if (error) throw error;
                
                // Filter by status
                let filteredCreators = creators || [];
                if (statusFilter === 'active') {
                    filteredCreators = filteredCreators.filter(c => 
                        c.status !== 'Churned' && c.status !== 'On Hold'
                    );
                } else if (statusFilter !== 'all') {
                    filteredCreators = filteredCreators.filter(c => c.status === statusFilter);
                }
                
                // Filter by product if selected
                if (product !== 'all') {
                    filteredCreators = filteredCreators.filter(c => {
                        const assignments = c.product_assignments || [];
                        return assignments.includes(product);
                    });
                }
                
                // Get performance data for period
                const { data: perfData } = await supabaseClient.from('creator_performance')
                    .select('creator_name, brand, gmv, videos')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate);
                
                // Aggregate performance by creator handle
                const perfMap = {};
                (perfData || []).forEach(p => {
                    const key = `${(p.creator_name || '').toLowerCase()}|${p.brand}`;
                    if (!perfMap[key]) perfMap[key] = { gmv: 0, videos: 0 };
                    perfMap[key].gmv += (p.gmv || 0);
                    perfMap[key].videos += (p.videos || 0);
                });
                
                // Process creators with performance data
                let totalRetainer = 0;
                let totalGmv = 0;
                
                creatorsTabData = filteredCreators.map(c => {
                    if (!c) return null;  // Safety check
                    const accounts = [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].filter(Boolean);
                    const creatorRetainer = getTotalRetainer(c);
                    totalRetainer += creatorRetainer;
                    
                    // Sum performance across all accounts
                    let gmv = 0;
                    let videos = 0;
                    accounts.forEach(acc => {
                        const key = `${acc.toLowerCase()}|${c.brand}`;
                        const perf = perfMap[key];
                        if (perf) {
                            gmv += perf.gmv;
                            videos += perf.videos;
                        }
                    });
                    totalGmv += gmv;
                    
                    const roi = creatorRetainer > 0 ? gmv / creatorRetainer : null;
                    
                    return {
                        id: c.id,
                        brand: c.brand,
                        status: c.status,
                        real_name: c.real_name,
                        discord_name: c.discord_name,
                        account_1: c.account_1,
                        retainer: c.retainer,
                        product_retainers: c.product_retainers,
                        product_assignments: c.product_assignments,
                        gmv,
                        videos,
                        accounts,
                        displayName: c.real_name || c.discord_name || c.account_1,
                        totalRetainer: creatorRetainer,
                        roi
                    };
                }).filter(Boolean);
                
                // Categorize creators
                
                // Needs Attention: On retainer but ROI < 1x (or no GMV)
                const attentionCreators = creatorsTabData
                    .filter(c => hasAnyRetainer(c) && (c.roi === null || c.roi < 1) && c.status !== 'Churned' && c.status !== 'On Hold')
                    .sort((a, b) => (b.totalRetainer || 0) - (a.totalRetainer || 0));
                
                // Top Performers: Highest GMV
                const topPerformers = creatorsTabData
                    .filter(c => (c.gmv || 0) > 0)
                    .sort((a, b) => (b.gmv || 0) - (a.gmv || 0))
                    .slice(0, 15);
                
                // ROI Leaders: Best ROI among retainer creators
                const roiLeaders = creatorsTabData
                    .filter(c => hasAnyRetainer(c) && c.roi !== null && c.roi >= 1)
                    .sort((a, b) => (b.roi || 0) - (a.roi || 0))
                    .slice(0, 15);
                
                creatorsTabCategories = {
                    attention: attentionCreators,
                    top: topPerformers,
                    roi: roiLeaders,
                    all: creatorsTabData
                };
                
                // Update stats
                document.getElementById('creatorsStatAttention').textContent = attentionCreators.length;
                document.getElementById('creatorsStatTop').textContent = Math.min(topPerformers.length, 10);
                document.getElementById('creatorsStatTotal').textContent = creatorsTabData.length.toLocaleString();
                document.getElementById('creatorsStatRetainer').textContent = '$' + totalRetainer.toLocaleString();
                document.getElementById('creatorsStatGmv').textContent = '$' + totalGmv.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                // Update counts
                document.getElementById('creatorsAttentionCount').textContent = attentionCreators.length;
                document.getElementById('creatorsTopCount').textContent = topPerformers.length;
                document.getElementById('creatorsRoiCount').textContent = roiLeaders.length;
                document.getElementById('creatorsAllCount').textContent = creatorsTabData.length;
                
                // Render Attention section
                const attentionGrid = document.getElementById('creatorsAttentionGrid');
                if (attentionCreators.length === 0) {
                    attentionGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);"> All retainer creators are delivering ROI!</div>';
                } else {
                    attentionGrid.innerHTML = attentionCreators.slice(0, 12).map(c => 
                        renderCreatorMgmtCard(c, { text: ' LOW ROI', bg: 'linear-gradient(135deg, #ef4444, #dc2626)', color: 'white' })
                    ).join('');
                }
                
                // Render Top Performers section
                const topGrid = document.getElementById('creatorsTopGrid');
                if (topPerformers.length === 0) {
                    topGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);"> No performance data for this period</div>';
                } else {
                    topGrid.innerHTML = topPerformers.slice(0, 12).map((c, i) => 
                        renderCreatorMgmtCard(c, i < 3 ? { text: `#${i+1}`, bg: 'linear-gradient(135deg, #22c55e, #16a34a)', color: 'white' } : null)
                    ).join('');
                }
                
                // Render ROI Leaders section
                const roiGrid = document.getElementById('creatorsRoiGrid');
                if (roiLeaders.length === 0) {
                    roiGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);"> No retainer creators with positive ROI yet</div>';
                } else {
                    roiGrid.innerHTML = roiLeaders.slice(0, 12).map((c, i) => 
                        renderCreatorMgmtCard(c, { text: `${c.roi.toFixed(1)}x ROI`, bg: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', color: 'white' })
                    ).join('');
                }
                
                // Render table
                filterCreatorsTable();
                
            } catch (err) {
                console.error('Error loading creators tab:', err);
                showToast('Error loading creators', 'error');
            }
        }
        
        function filterCreatorsTable() {
            const search = document.getElementById('creatorsSearchFilter')?.value?.toLowerCase() || '';
            
            let filtered = creatorsTabData;
            if (search) {
                filtered = filtered.filter(c => 
                    (c.displayName || '').toLowerCase().includes(search) ||
                    (c.real_name || '').toLowerCase().includes(search) ||
                    (c.discord_name || '').toLowerCase().includes(search) ||
                    (c.accounts || []).some(a => a.toLowerCase().includes(search))
                );
            }
            
            // Sort by GMV descending
            filtered = filtered.sort((a, b) => (b.gmv || 0) - (a.gmv || 0));
            
            document.getElementById('creatorsTableBody').innerHTML = filtered.map(c => {
                const accounts = c.accounts || [];
                const accountLinks = accounts.length > 0 
                    ? accounts.slice(0, 2).map(a => `<a href="https://tiktok.com/@${a}" target="_blank" style="color: var(--accent); text-decoration: none; font-size: 0.85rem;">@${sanitize(a)}</a>`).join(', ') + (accounts.length > 2 ? ` <span style="color: var(--text-muted);">+${accounts.length - 2}</span>` : '')
                    : `<span style="color: var(--text-muted);">-</span>`;
                
                const isRetainer = hasAnyRetainer(c);
                const typeBadge = isRetainer 
                    ? `<span class="badge" style="background: var(--success); color: white; font-size: 0.65rem;"> Retainer</span>`
                    : `<span class="badge" style="background: var(--blue); color: white; font-size: 0.65rem;"> Affiliate</span>`;
                
                const status = c.status || 'Active';
                const statusColors = {
                    'Active': 'var(--success)',
                    'On Hold': 'var(--warning)',
                    'Churned': 'var(--danger)'
                };
                const statusBadge = `<span class="badge" style="background: ${statusColors[status] || 'var(--text-muted)'}; color: white; font-size: 0.6rem;">${status}</span>`;
                
                const totalRetainer = getTotalRetainer(c);
                const roi = totalRetainer > 0 ? (c.gmv / totalRetainer) : null;
                const roiDisplay = roi !== null ? roi.toFixed(1) + 'x' : '-';
                const roiColor = roi === null ? 'var(--text-muted)' : roi >= 3 ? 'var(--success)' : roi >= 1 ? 'var(--warning)' : 'var(--error)';
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${sanitize(c.displayName || c.account_1 || 'Unknown')}</div>
                            ${c.real_name && c.discord_name ? `<div style="font-size: 0.7rem; color: var(--text-muted);">${sanitize(c.discord_name)}</div>` : ''}
                        </td>
                        <td style="text-align: center;">${statusBadge}</td>
                        <td style="text-align: center;">${typeBadge}</td>
                        <td style="font-size: 0.85rem;">${accountLinks}</td>
                        <td><span class="badge" style="font-size: 0.65rem;">${formatBrandName(c.brand)}</span></td>
                        <td style="text-align: center;">${totalRetainer ? '$' + totalRetainer.toLocaleString() : '<span style="color: var(--text-muted);">-</span>'}</td>
                        <td style="text-align: right; font-weight: 600; color: var(--success);">$${(c.gmv || 0).toLocaleString()}</td>
                        <td style="text-align: center; font-weight: 600; color: ${roiColor};">${roiDisplay}</td>
                        <td style="text-align: center;">${c.videos || 0}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-small" onclick="editCreator(${c.id})" style="padding: 4px 8px; font-size: 0.7rem;">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">No creators found</td></tr>';
        }
        
        function exportCreatorsCSV() {
            const data = creatorsTabData;
            if (data.length === 0) {
                showToast('No creators to export', 'warning');
                return;
            }
            
            const headers = ['Name', 'Real Name', 'Discord', 'Status', 'Type', 'Brand', 'Accounts', 'Retainer', 'GMV', 'ROI', 'Videos'];
            const rows = data.map(c => [
                c.displayName || '',
                c.real_name || '',
                c.discord_name || '',
                c.status || 'Active',
                hasAnyRetainer(c) ? 'Retainer' : 'Affiliate',
                formatBrandName(c.brand),
                (c.accounts || []).join('; '),
                getTotalRetainer(c),
                c.gmv || 0,
                c.roi ? c.roi.toFixed(2) : '',
                c.videos || 0
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `creators_export_${localDateStr(new Date())}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported!', 'success');
        }
        
        function onCreatorsBrandFilterChange() {
            loadProductsForFilter('creatorsProductFilter', document.getElementById('creatorsBrandFilter').value);
            loadCreatorsTab();
        }
        
        // ==================== POSTING TAB BRAND FILTER ====================
        function onPostingBrandFilterChange() {
            // Reload data with new brand filter
            loadPostingData();
        }
        
        // ==================== DECISIONS TAB BRAND FILTER ====================
        function onDecisionsBrandFilterChange() {
            loadProductsForFilter('decisionsProductFilter', document.getElementById('decisionsBrandFilter').value);
            loadDecisions();
        }
        
        // ==================== LOAD PRODUCTS FOR FILTER ====================
        async function loadProductsForFilter(selectId, brand) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="all">All Products</option>';
            
            if (brand === 'all') return;
            
            try {
                const { data: products } = await supabaseClient.from('products')
                    .select('product_key, display_name')
                    .eq('brand', brand);
                
                (products || []).forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.product_key;
                    option.textContent = p.display_name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading products:', err);
            }
        }
        
        // Load ALL active products into a filter dropdown (for cross-brand views)
        async function loadAllProductsForFilter(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="all">All Products</option>';
            
            try {
                const { data: products } = await supabaseClient.from('products')
                    .select('product_key, display_name, brand')
                    .eq('status', 'active')
                    .order('brand')
                    .order('display_name');
                
                (products || []).forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.product_key;
                    option.textContent = `${p.display_name} (${BRAND_DISPLAY[p.brand] || p.brand})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading all products:', err);
            }
        }
        
        function filterByQuadrant(quadrant) {
            opsData.currentQuadrant = quadrant;
            
            // Update quadrant styling
            document.querySelectorAll('.health-quadrant').forEach(q => {
                q.style.opacity = (quadrant === 'all' || q.dataset.quadrant === quadrant) ? '1' : '0.4';
                q.style.transform = q.dataset.quadrant === quadrant ? 'scale(1.02)' : 'scale(1)';
            });
            
            // Filter creators
            let filtered = opsData.creators;
            if (quadrant !== 'all') {
                filtered = opsData.creators.filter(c => c.quadrant === quadrant);
            }
            
            // Sort by GMV descending
            filtered.sort((a, b) => b.gmv - a.gmv);
            
            // Update title
            const titles = {
                all: { icon: '', text: 'All Creators' },
                stars: { icon: '', text: 'Stars  Posting + Converting' },
                grinding: { icon: '', text: 'Grinding  High Output, Low GMV' },
                coasting: { icon: '', text: 'Coasting  High GMV, Low Output' },
                dormant: { icon: '', text: 'Dormant  Need Outreach' }
            };
            
            const titleInfo = titles[quadrant] || titles.all;
            document.getElementById('filteredListIcon').textContent = titleInfo.icon;
            document.getElementById('filteredListTitle').textContent = titleInfo.text;
            document.getElementById('filteredListCount').textContent = filtered.length;
            
            // Render table
            const tbody = document.getElementById('filteredCreatorList');
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No creators in this category</td></tr>`;
                return;
            }
            
            tbody.innerHTML = filtered.map(c => {
                const statusColor = {
                    stars: 'var(--success)',
                    grinding: 'var(--blue)',
                    coasting: 'var(--warning)',
                    dormant: 'var(--error)'
                }[c.quadrant];
                
                const statusIcon = {
                    stars: '',
                    grinding: '',
                    coasting: '',
                    dormant: ''
                }[c.quadrant];
                
                // Trend arrow
                let trendHtml = '<span style="color: var(--text-muted);"></span>';
                if (c.gmvChange > 10) {
                    trendHtml = `<span style="color: var(--success);"> ${c.gmvChange.toFixed(0)}%</span>`;
                } else if (c.gmvChange < -10) {
                    trendHtml = `<span style="color: var(--error);"> ${Math.abs(c.gmvChange).toFixed(0)}%</span>`;
                } else if (c.gmvChange !== 0) {
                    trendHtml = `<span style="color: var(--text-muted);"> ${c.gmvChange > 0 ? '+' : ''}${c.gmvChange.toFixed(0)}%</span>`;
                }
                
                // Last contact
                let lastContactHtml = '<span style="color: var(--text-muted);">Never</span>';
                if (c.lastContact) {
                    const contactDate = new Date(c.lastContact);
                    const daysSince = Math.floor((new Date() - contactDate) / (1000 * 60 * 60 * 24));
                    if (daysSince === 0) {
                        lastContactHtml = '<span style="color: var(--success);">Today</span>';
                    } else if (daysSince === 1) {
                        lastContactHtml = '<span style="color: var(--success);">Yesterday</span>';
                    } else if (daysSince <= 7) {
                        lastContactHtml = `<span style="color: var(--text-secondary);">${daysSince}d ago</span>`;
                    } else if (daysSince <= 14) {
                        lastContactHtml = `<span style="color: var(--warning);">${daysSince}d ago</span>`;
                    } else {
                        lastContactHtml = `<span style="color: var(--error);">${daysSince}d ago</span>`;
                    }
                }
                
                return `
                    <tr style="cursor: pointer;" onclick="openCreatorDetail('${c.creator_name}', '${c.brand}')">
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accent-dim); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--accent);">
                                    ${(c.creator_name || '?')[0].toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">@${c.creator_name}</div>
                                    ${c.managed ? '<span style="font-size: 0.7rem; color: var(--success);"> Managed</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span style="padding: 4px 8px; background: var(--accent-dim); border-radius: 4px; font-size: 0.8rem;">
                                ${BRAND_ICONS[c.brand] || ''} ${BRAND_DISPLAY[c.brand] || c.brand}
                            </span>
                        </td>
                        <td style="text-align: center; font-weight: 600;">${c.videos}</td>
                        <td style="text-align: right; font-weight: 600; color: var(--success);">${fmtMoney(c.gmv)}</td>
                        <td style="text-align: center; font-size: 0.85rem;">${trendHtml}</td>
                        <td style="text-align: center; font-size: 0.85rem;">${lastContactHtml}</td>
                        <td style="text-align: center;">
                            <span style="padding: 4px 10px; background: ${statusColor}22; color: ${statusColor}; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
                                ${statusIcon} ${c.quadrant.charAt(0).toUpperCase() + c.quadrant.slice(1)}
                            </span>
                        </td>
                        <td style="text-align: center; position: relative;" onclick="event.stopPropagation();">
                            <div class="quick-action-wrapper" style="position: relative; display: inline-block;">
                                <button class="btn btn-small" onclick="toggleQuickActionMenu(this, '${c.creator_name}', '${c.brand}')" title="Quick actions"></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Quick Action Menu
        let activeQuickActionMenu = null;
        
        function toggleQuickActionMenu(btn, creatorName, brand) {
            // Close any existing menu
            closeQuickActionMenu();
            
            const wrapper = btn.parentElement;
            const menu = document.createElement('div');
            menu.className = 'quick-action-menu';
            menu.style.cssText = `
                position: absolute;
                top: 100%;
                right: 0;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                min-width: 180px;
                padding: 4px 0;
            `;
            
            menu.innerHTML = `
                <div class="quick-action-item" onclick="copyDmTemplate('${creatorName}', '${brand}')" style="padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
                    <span></span> Copy DM Template
                </div>
                <div class="quick-action-item" onclick="openDiscordChatForCreator('${creatorName}', '${brand}')" style="padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
                    <span style="color: #5865F2;"></span> Open Discord Chat
                </div>
                <div class="quick-action-item" onclick="markContactedToday('${creatorName}', '${brand}')" style="padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
                    <span></span> Mark Contacted Today
                </div>
                <div class="quick-action-item" onclick="scheduleFollowup('${creatorName}', '${brand}')" style="padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
                    <span></span> Schedule Follow-up
                </div>
                <div class="quick-action-item" onclick="addQuickNote('${creatorName}', '${brand}')" style="padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
                    <span></span> Add Note
                </div>
                <div style="border-top: 1px solid var(--border); margin: 4px 0;"></div>
                <div class="quick-action-item" onclick="openCreatorDetail('${creatorName}', '${brand}')" style="padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
                    <span></span> View Full Profile
                </div>
            `;
            
            // Add hover styles
            menu.querySelectorAll('.quick-action-item').forEach(item => {
                item.addEventListener('mouseenter', () => item.style.background = 'var(--bg-secondary)');
                item.addEventListener('mouseleave', () => item.style.background = 'transparent');
            });
            
            wrapper.appendChild(menu);
            activeQuickActionMenu = menu;
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', closeQuickActionMenu, { once: true });
            }, 10);
        }
        
        function closeQuickActionMenu() {
            if (activeQuickActionMenu) {
                activeQuickActionMenu.remove();
                activeQuickActionMenu = null;
            }
        }
        
        function copyDmTemplate(creatorName, brand) {
            closeQuickActionMenu();
            const creator = opsData.creators.find(c => c.creator_name === creatorName && c.brand === brand);
            
            let template = '';
            if (creator?.quadrant === 'stars') {
                template = `Hey @${creatorName}!  You've been crushing it lately! Wanted to reach out and say thanks for all the amazing content. Your videos are really resonating. Keep it up! `;
            } else if (creator?.quadrant === 'grinding') {
                template = `Hey @${creatorName}!  Love seeing you stay consistent with the content! I've got a few tips that might help boost conversions. Got a min to chat?`;
            } else if (creator?.quadrant === 'coasting') {
                template = `Hey @${creatorName}!  Your content always performs well. Any chance you could drop a few more videos this week? Your audience is loving what you put out!`;
            } else {
                template = `Hey @${creatorName}!  Haven't seen you around lately  everything okay? We'd love to have you back creating. Let me know if you need anything!`;
            }
            
            navigator.clipboard.writeText(template).then(() => {
                showToast('DM template copied!', 'success');
            });
        }
        
        async function markContactedToday(creatorName, brand) {
            closeQuickActionMenu();
            
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Find the managed creator entry
                const mc = managedCreators.find(m => {
                    const accounts = [m.account_1, m.account_2, m.account_3, m.account_4, m.account_5].filter(Boolean).map(a => a.toLowerCase());
                    return accounts.includes(creatorName.toLowerCase()) && m.brand === brand;
                });
                
                if (mc) {
                    await supabaseClient
                        .from('managed_creators')
                        .update({ last_contact_date: today })
                        .eq('id', mc.id);
                    
                    showToast(`Marked @${creatorName} as contacted today!`, 'success');
                    
                    // Refresh data
                    await loadManagedCreators();
                    reloadCurrentOpsTab();
                } else {
                    showToast('Creator not found in roster', 'error');
                }
            } catch (err) {
                console.error('Failed to mark contacted:', err);
                showToast('Failed to update: ' + err.message, 'error');
            }
        }
        
        function scheduleFollowup(creatorName, brand) {
            closeQuickActionMenu();
            // For now, prompt for date
            const date = prompt(`Schedule follow-up for @${creatorName}:\nEnter date (YYYY-MM-DD):`);
            if (!date) return;
            
            // Validate date format
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                showToast('Invalid date format. Use YYYY-MM-DD', 'error');
                return;
            }
            
            // Find and update
            const mc = managedCreators.find(m => {
                const accounts = [m.account_1, m.account_2, m.account_3, m.account_4, m.account_5].filter(Boolean).map(a => a.toLowerCase());
                return accounts.includes(creatorName.toLowerCase()) && m.brand === brand;
            });
            
            if (mc) {
                supabaseClient
                    .from('managed_creators')
                    .update({ next_followup_date: date })
                    .eq('id', mc.id)
                    .then(() => {
                        showToast(`Follow-up scheduled for ${date}`, 'success');
                        loadManagedCreators();
                    });
            } else {
                showToast('Creator not found in roster', 'error');
            }
        }
        
        function addQuickNote(creatorName, brand) {
            closeQuickActionMenu();
            const note = prompt(`Add note for @${creatorName}:`);
            if (!note) return;
            
            // Find and update
            const mc = managedCreators.find(m => {
                const accounts = [m.account_1, m.account_2, m.account_3, m.account_4, m.account_5].filter(Boolean).map(a => a.toLowerCase());
                return accounts.includes(creatorName.toLowerCase()) && m.brand === brand;
            });
            
            if (mc) {
                const timestamp = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const newNote = `[${timestamp}] ${note}`;
                const existingNotes = mc.notes || '';
                const updatedNotes = existingNotes ? `${newNote}\n${existingNotes}` : newNote;
                
                supabaseClient
                    .from('managed_creators')
                    .update({ notes: updatedNotes })
                    .eq('id', mc.id)
                    .then(() => {
                        showToast('Note added!', 'success');
                        loadManagedCreators();
                    });
            } else {
                showToast('Creator not found in roster', 'error');
            }
        }
        
        function openQuickAction(creatorName, brand) {
            // Legacy function - now uses dropdown
            openCreatorDetail(creatorName, brand);
        }
        
        async function loadVideoIntel(startStr, endStr, brand, managedOnly) {
            // Fetch video performance data
            let videoQuery = supabaseClient
                .from('video_performance')
                .select('video_id, video_title, creator_name, brand, gmv, orders, product_name')
                .gte('report_date', startStr)
                .lte('report_date', endStr);
            
            if (brand !== 'all') videoQuery = videoQuery.eq('brand', brand);
            
            const { data: videoPerf } = await videoQuery;
            
            // Aggregate video data
            const videoMap = new Map();
            (videoPerf || []).forEach(row => {
                if (!row.video_id) return;
                
                const managed = isManagedForBrand(row.creator_name, row.brand);
                if (managedOnly && !managed) return;
                
                if (!videoMap.has(row.video_id)) {
                    videoMap.set(row.video_id, {
                        video_id: row.video_id,
                        video_title: row.video_title,
                        creator_name: row.creator_name,
                        brand: row.brand,
                        gmv: 0,
                        orders: 0,
                        managed
                    });
                }
                const v = videoMap.get(row.video_id);
                v.gmv += pFloat(row.gmv);
                v.orders += pInt(row.orders);
            });
            
            const videos = [...videoMap.values()];
            opsData.videos = videos;
            
            // Calculate stats
            const totalVideos = videos.length;
            const totalVideoGmv = videos.reduce((s, v) => s + v.gmv, 0);
            const avgGmvPerVideo = totalVideos > 0 ? totalVideoGmv / totalVideos : 0;
            const hotVideos = videos.filter(v => v.gmv >= 100).length;
            
            document.getElementById('opsTotalVideos').textContent = totalVideos.toLocaleString();
            document.getElementById('opsTotalVideoGmv').textContent = fmtMoney(totalVideoGmv);
            document.getElementById('opsAvgGmvPerVideo').textContent = fmtMoney(avgGmvPerVideo);
            document.getElementById('opsHotVideoCount').textContent = hotVideos;
            
            // Hot Videos (top 10 by GMV)
            const hotVideosList = [...videos].sort((a, b) => b.gmv - a.gmv).slice(0, 10);
            document.getElementById('hotVideosList').innerHTML = hotVideosList.length === 0 
                ? '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No videos found</td></tr>'
                : hotVideosList.map((v, i) => `
                    <tr>
                        <td style="text-align: center; color: ${i < 3 ? 'var(--warning)' : 'var(--text-muted)'}; font-weight: 600;">${i + 1}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="cursor: pointer; color: var(--accent);" onclick="openVideoEmbed('${v.video_id}', '${(v.video_title || '').replace(/'/g, "\\'")}', ${v.gmv}, ${v.orders}, '${v.creator_name}')"></span>
                                <span style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${v.video_title || 'Untitled'}">${v.video_title || 'Untitled'}</span>
                            </div>
                        </td>
                        <td>@${v.creator_name}</td>
                        <td><span style="padding: 2px 6px; background: var(--accent-dim); border-radius: 4px; font-size: 0.75rem;">${BRAND_ICONS[v.brand] || ''} ${BRAND_DISPLAY[v.brand] || v.brand}</span></td>
                        <td style="text-align: right; font-weight: 600; color: var(--success);">${fmtMoney(v.gmv)}</td>
                        <td style="text-align: right;">${v.orders}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-small" onclick="copyVideoUrl('${v.video_id}', '${v.creator_name}')" title="Copy URL"></button>
                        </td>
                    </tr>
                `).join('');
            
            // Video Velocity (GMV per video by creator)
            const creatorVelocity = new Map();
            videos.forEach(v => {
                const key = `${v.creator_name}|||${v.brand}`;
                if (!creatorVelocity.has(key)) {
                    creatorVelocity.set(key, { creator_name: v.creator_name, brand: v.brand, videos: 0, gmv: 0 });
                }
                const c = creatorVelocity.get(key);
                c.videos++;
                c.gmv += v.gmv;
            });
            
            const velocityList = [...creatorVelocity.values()]
                .map(c => ({ ...c, gmvPerVideo: c.videos > 0 ? c.gmv / c.videos : 0 }))
                .filter(c => c.videos >= 2) // At least 2 videos
                .sort((a, b) => b.gmvPerVideo - a.gmvPerVideo)
                .slice(0, 10);
            
            const maxVelocity = velocityList.length > 0 ? velocityList[0].gmvPerVideo : 1;
            
            document.getElementById('videoVelocityList').innerHTML = velocityList.length === 0
                ? '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Not enough data (need 2+ videos per creator)</td></tr>'
                : velocityList.map((c, i) => {
                    const efficiency = (c.gmvPerVideo / maxVelocity) * 100;
                    return `
                        <tr style="cursor: pointer;" onclick="openCreatorDetail('${c.creator_name}', '${c.brand}')">
                            <td style="text-align: center; color: ${i < 3 ? 'var(--warning)' : 'var(--text-muted)'}; font-weight: 600;">${i + 1}</td>
                            <td style="font-weight: 600;">@${c.creator_name}</td>
                            <td><span style="padding: 2px 6px; background: var(--accent-dim); border-radius: 4px; font-size: 0.75rem;">${BRAND_ICONS[c.brand] || ''}</span></td>
                            <td style="text-align: center;">${c.videos}</td>
                            <td style="text-align: right; color: var(--success);">${fmtMoney(c.gmv)}</td>
                            <td style="text-align: right; font-weight: 600; color: var(--blue);">${fmtMoney(c.gmvPerVideo)}</td>
                            <td style="text-align: center;">
                                <div style="width: 80px; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${efficiency}%; height: 100%; background: var(--success); border-radius: 4px;"></div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            
            // Duds (videos with 0 or very low GMV)
            const dudsList = [...videos]
                .filter(v => v.gmv < 10)
                .sort((a, b) => a.gmv - b.gmv)
                .slice(0, 10);
            
            document.getElementById('dudVideosList').innerHTML = dudsList.length === 0
                ? '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No underperforming videos  great job! </td></tr>'
                : dudsList.map(v => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="cursor: pointer; color: var(--accent);" onclick="openVideoEmbed('${v.video_id}', '${(v.video_title || '').replace(/'/g, "\\'")}', ${v.gmv}, ${v.orders}, '${v.creator_name}')"></span>
                                <span style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${v.video_title || 'Untitled'}">${v.video_title || 'Untitled'}</span>
                            </div>
                        </td>
                        <td>@${v.creator_name}</td>
                        <td><span style="padding: 2px 6px; background: var(--accent-dim); border-radius: 4px; font-size: 0.75rem;">${BRAND_ICONS[v.brand] || ''}</span></td>
                        <td style="text-align: right; color: var(--error);">${fmtMoney(v.gmv)}</td>
                        <td style="text-align: right;">${v.orders}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-small" onclick="openCreatorDetail('${v.creator_name}', '${v.brand}')" title="View creator"></button>
                        </td>
                    </tr>
                `).join('');
        }
        
        function copyVideoUrl(videoId, creatorName) {
            const url = `https://www.tiktok.com/@${creatorName}/video/${videoId}`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Video URL copied!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        function openQuickAction(creatorName, brand) {
            // Quick action modal - for now just open creator detail
            openCreatorDetail(creatorName, brand);
        }
        
        function exportFilteredCreators() {
            let filtered = opsData.creators;
            if (opsData.currentQuadrant !== 'all') {
                filtered = opsData.creators.filter(c => c.quadrant === opsData.currentQuadrant);
            }
            
            if (filtered.length === 0) {
                showToast('No creators to export', 'error');
                return;
            }
            
            const headers = ['Creator', 'Brand', 'Videos', 'GMV', 'Prior GMV', 'WoW Change %', 'Last Contact', 'Status', 'Managed'];
            const rows = filtered.map(c => [
                c.creator_name,
                BRAND_DISPLAY[c.brand] || c.brand,
                c.videos,
                c.gmv.toFixed(2),
                (c.priorGmv || 0).toFixed(2),
                (c.gmvChange || 0).toFixed(1) + '%',
                c.lastContact || 'Never',
                c.quadrant,
                c.managed ? 'Yes' : 'No'
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadCSV(csv, `ops-${opsData.currentQuadrant}-creators-${new Date().toISOString().split('T')[0]}.csv`);
            showToast(`Exported ${filtered.length} creators!`, 'success');
        }

        // ==================== WEEKLY REVIEW ====================
        let weeklyReviewData = {
            topPerformers: [],
            needsAttention: [],
            mostActive: [],
            belowTarget: [],
            totalGmv: 0,
            totalVideos: 0
        };
        
        async function loadWeeklyReview() {
            opsData.weeklyReviewLoaded = true;
            
            const brand = document.getElementById('opsBrandFilter')?.value || 'all';
            const managedOnly = document.getElementById('opsManagedOnly')?.checked ?? true;
            
            // Get date range from filters (or default to last 7 days)
            let startStr = document.getElementById('opsDateFilterStart')?.value;
            let endStr = document.getElementById('opsDateFilterEnd')?.value;
            
            // Fallback to last 7 days if not set
            if (!startStr || !endStr) {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);
                startStr = startDate.toISOString().split('T')[0];
                endStr = endDate.toISOString().split('T')[0];
            }
            
            // Calculate prior period (same length as current period)
            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            const priorEndDate = new Date(startDate);
            priorEndDate.setDate(priorEndDate.getDate() - 1);
            const priorStartDate = new Date(priorEndDate);
            priorStartDate.setDate(priorStartDate.getDate() - daysDiff);
            const priorStartStr = priorStartDate.toISOString().split('T')[0];
            const priorEndStr = priorEndDate.toISOString().split('T')[0];
            
            // Update header subtitle with date range
            const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const subtitleEl = document.querySelector('#ops-tab-weeklyreview p');
            if (subtitleEl) {
                subtitleEl.textContent = `${formatDate(startStr)} - ${formatDate(endStr)}  ${managedOnly ? 'Managed only' : 'All creators'}`;
            }
            
            try {
                // Load managed creators
                await loadManagedCreators();
                
                // Get current period performance data (videos column = posts that day)
                let perfQuery = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, orders, videos, report_date')
                    .gte('report_date', startStr)
                    .lte('report_date', endStr);
                
                if (brand !== 'all') perfQuery = perfQuery.eq('brand', brand);
                
                const { data: perfData, error: perfError } = await perfQuery;
                if (perfError) throw perfError;
                
                // Get prior period for comparison
                let priorQuery = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv')
                    .gte('report_date', priorStartStr)
                    .lte('report_date', priorEndStr);
                
                if (brand !== 'all') priorQuery = priorQuery.eq('brand', brand);
                
                const { data: priorData } = await priorQuery;
                
                // Aggregate by creator
                const creatorGmv = {};
                const creatorVideos = {};
                const priorGmv = {};
                
                // Current period GMV and videos (sum daily video counts)
                (perfData || []).forEach(row => {
                    const key = `${row.creator_name.toLowerCase()}|${row.brand}`;
                    if (!creatorGmv[key]) {
                        creatorGmv[key] = { name: row.creator_name, brand: row.brand, gmv: 0, orders: 0 };
                    }
                    creatorGmv[key].gmv += parseFloat(row.gmv) || 0;
                    creatorGmv[key].orders += parseInt(row.orders) || 0;
                    
                    // Sum up daily video counts
                    if (!creatorVideos[key]) {
                        creatorVideos[key] = { name: row.creator_name, brand: row.brand, count: 0 };
                    }
                    creatorVideos[key].count += parseInt(row.videos) || 0;
                });
                
                // Prior period GMV
                (priorData || []).forEach(row => {
                    const key = `${row.creator_name.toLowerCase()}|${row.brand}`;
                    if (!priorGmv[key]) priorGmv[key] = 0;
                    priorGmv[key] += parseFloat(row.gmv) || 0;
                });
                
                // Build managed set for filtering
                const managedSet = new Set();
                const managedRetainers = {};
                const managedInfo = {}; // To get real names
                managedCreators.forEach(mc => {
                    [mc.account_1, mc.account_2, mc.account_3, mc.account_4, mc.account_5].forEach(acc => {
                        if (acc) {
                            const key = `${normalizeTikTok(acc)}|${mc.brand}`;
                            managedSet.add(key);
                            // Store retainer value (including 0 for affiliates, null for not set)
                            const retainerVal = mc.retainer !== null && mc.retainer !== undefined && mc.retainer !== '' 
                                ? parseFloat(mc.retainer) 
                                : null;
                            managedRetainers[key] = retainerVal;
                            managedInfo[key] = {
                                realName: mc.real_name || mc.discord_name || mc.account_1,
                                handle: mc.account_1
                            };
                        }
                    });
                });
                
                // Build GMV list (filter by managedOnly setting)
                const gmvList = Object.entries(creatorGmv)
                    .filter(([key]) => {
                        if (!managedOnly) return true; // Include all if not filtering
                        const [name, b] = key.split('|');
                        const normKey = `${normalizeTikTok(name)}|${b}`;
                        return managedSet.has(normKey);
                    })
                    .map(([key, data]) => {
                        const [name, b] = key.split('|');
                        const normKey = `${normalizeTikTok(name)}|${b}`;
                        const prior = priorGmv[key] || 0;
                        const change = prior > 0 ? ((data.gmv - prior) / prior) * 100 : 0;
                        return {
                            ...data,
                            priorGmv: prior,
                            change,
                            retainer: managedRetainers[normKey], // Can be null, 0, or positive
                            isManaged: managedSet.has(normKey)
                        };
                    });
                
                // Build video list
                let videoList = [];
                if (managedOnly) {
                    // For managed only, use managed creators list
                    managedCreators.forEach(mc => {
                        if (brand !== 'all' && mc.brand !== brand) return;
                        
                        const accounts = [mc.account_1, mc.account_2, mc.account_3, mc.account_4, mc.account_5].filter(Boolean);
                        let totalVideos = 0;
                        accounts.forEach(acc => {
                            const vData = Object.entries(creatorVideos).find(([k]) => {
                                const [n, b] = k.split('|');
                                return normalizeTikTok(n) === normalizeTikTok(acc) && b === mc.brand;
                            });
                            if (vData) totalVideos += vData[1].count;
                        });
                        
                        // Handle retainer: null/undefined/'' = not set, 0 = affiliate, >0 = has retainer
                        const retainerVal = mc.retainer !== null && mc.retainer !== undefined && mc.retainer !== '' 
                            ? parseFloat(mc.retainer) 
                            : null;
                        
                        videoList.push({
                            name: mc.real_name || mc.discord_name || mc.account_1,
                            handle: mc.account_1,
                            brand: mc.brand,
                            count: totalVideos,
                            retainer: retainerVal
                        });
                    });
                } else {
                    // For all creators, use video data
                    Object.entries(creatorVideos).forEach(([key, data]) => {
                        const [name, b] = key.split('|');
                        const normKey = `${normalizeTikTok(name)}|${b}`;
                        const info = managedInfo[normKey] || {};
                        videoList.push({
                            name: info.realName || data.name,
                            handle: data.name,
                            brand: data.brand,
                            count: data.count,
                            retainer: managedRetainers[normKey] // Can be null, 0, or positive
                        });
                    });
                }
                
                // Sort and categorize
                const sortedByGmv = [...gmvList].sort((a, b) => b.gmv - a.gmv);
                const sortedByVideos = [...videoList].sort((a, b) => b.count - a.count);
                
                // Top Performers: Top 20 by GMV OR GMV > $500 (full list for detail view)
                weeklyReviewData.topPerformers = sortedByGmv
                    .filter((c, i) => i < 20 || c.gmv >= 500);
                
                // Needs Attention: Has retainer but GMV < $100 OR GMV dropped 50%+ (full list)
                weeklyReviewData.needsAttention = gmvList
                    .filter(c => (c.retainer > 0 && c.gmv < 100) || (c.priorGmv > 100 && c.change < -50))
                    .sort((a, b) => a.gmv - b.gmv);
                
                // Most Active: 5+ videos (full list for detail view)
                weeklyReviewData.mostActive = sortedByVideos
                    .filter(c => c.count >= 5);
                
                // Below Target: < 5 videos (full list)
                weeklyReviewData.belowTarget = videoList
                    .filter(c => c.count < 5)
                    .sort((a, b) => a.count - b.count);
                
                // Totals
                weeklyReviewData.totalGmv = gmvList.reduce((s, c) => s + c.gmv, 0);
                weeklyReviewData.totalVideos = videoList.reduce((s, c) => s + c.count, 0);
                
                // Update UI
                renderWeeklyReview();
                
            } catch (err) {
                console.error('Failed to load weekly review:', err);
                showToast('Failed to load weekly review', 'error');
            }
        }
        
        function renderWeeklyReview() {
            const d = weeklyReviewData;
            const PREVIEW_LIMIT = 10;
            
            // Update stats
            document.getElementById('weeklyTotalGmv').textContent = fmtMoney(d.totalGmv);
            document.getElementById('weeklyTotalVideos').textContent = d.totalVideos.toLocaleString();
            document.getElementById('weeklyLowPosters').textContent = d.belowTarget.length;
            document.getElementById('weeklyNeedsAttention').textContent = d.needsAttention.length;
            
            // Update badge counts
            document.getElementById('weeklyTopPerformerCount').textContent = d.topPerformers.length;
            document.getElementById('weeklyNeedsAttentionCount').textContent = d.needsAttention.length;
            document.getElementById('weeklyMostActiveCount').textContent = d.mostActive.length;
            document.getElementById('weeklyBelowTargetCount').textContent = d.belowTarget.length;
            
            // Top Performers table (preview)
            const topPreview = d.topPerformers.slice(0, PREVIEW_LIMIT);
            let topHtml = topPreview.length === 0 
                ? '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--text-muted);">No data</td></tr>'
                : topPreview.map((c, i) => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px 16px;">
                            <div style="font-weight: 600;">${i + 1}. @${c.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                        </td>
                        <td style="padding: 10px 16px; text-align: right;">
                            <div style="font-weight: 700; color: var(--success);">${fmtMoney(c.gmv)}</div>
                            ${c.change !== 0 ? `<div style="font-size: 0.75rem; color: ${c.change > 0 ? 'var(--success)' : 'var(--error)'};">${c.change > 0 ? '' : ''}${Math.abs(c.change).toFixed(0)}%</div>` : ''}
                        </td>
                    </tr>
                `).join('');
            if (d.topPerformers.length > PREVIEW_LIMIT) {
                topHtml += `<tr><td colspan="2" style="padding: 12px 16px; text-align: center; color: var(--accent); font-size: 0.85rem;">+${d.topPerformers.length - PREVIEW_LIMIT} more  Click for full list</td></tr>`;
            }
            document.getElementById('weeklyTopPerformers').innerHTML = topHtml;
            
            // Needs Attention table (preview)
            const attentionPreview = d.needsAttention.slice(0, PREVIEW_LIMIT);
            let attentionHtml = attentionPreview.length === 0 
                ? '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--success);"> No concerns!</td></tr>'
                : attentionPreview.map(c => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px 16px;">
                            <div style="font-weight: 600;">@${c.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                        </td>
                        <td style="padding: 10px 16px; text-align: right;">
                            <div style="font-weight: 700; color: var(--error);">${fmtMoney(c.gmv)}</div>
                            ${c.retainer > 0 ? `<div style="font-size: 0.7rem; color: var(--warning);"> ${fmtMoney(c.retainer)} retainer</div>` : (c.retainer === 0 ? '<div style="font-size: 0.7rem;"><span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.65rem;">Affiliate</span></div>' : '')}
                            ${c.change < -50 ? `<div style="font-size: 0.7rem; color: var(--error);">${Math.abs(c.change).toFixed(0)}% from last week</div>` : ''}
                        </td>
                    </tr>
                `).join('');
            if (d.needsAttention.length > PREVIEW_LIMIT) {
                attentionHtml += `<tr><td colspan="2" style="padding: 12px 16px; text-align: center; color: var(--accent); font-size: 0.85rem;">+${d.needsAttention.length - PREVIEW_LIMIT} more  Click for full list</td></tr>`;
            }
            document.getElementById('weeklyNeedsAttentionList').innerHTML = attentionHtml;
            
            // Most Active table (preview)
            const activePreview = d.mostActive.slice(0, PREVIEW_LIMIT);
            let activeHtml = activePreview.length === 0 
                ? '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--text-muted);">No data</td></tr>'
                : activePreview.map((c, i) => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px 16px;">
                            <div style="font-weight: 600;">${i + 1}. ${c.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                        </td>
                        <td style="padding: 10px 16px; text-align: right;">
                            <div style="font-weight: 700; color: var(--blue);">${c.count} videos</div>
                        </td>
                    </tr>
                `).join('');
            if (d.mostActive.length > PREVIEW_LIMIT) {
                activeHtml += `<tr><td colspan="2" style="padding: 12px 16px; text-align: center; color: var(--accent); font-size: 0.85rem;">+${d.mostActive.length - PREVIEW_LIMIT} more  Click for full list</td></tr>`;
            }
            document.getElementById('weeklyMostActive').innerHTML = activeHtml;
            
            // Below Target table (preview)
            const belowPreview = d.belowTarget.slice(0, PREVIEW_LIMIT);
            let belowHtml = belowPreview.length === 0 
                ? '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--success);"> Everyone hitting target!</td></tr>'
                : belowPreview.map(c => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px 16px;">
                            <div style="font-weight: 600;">${c.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                        </td>
                        <td style="padding: 10px 16px; text-align: right;">
                            <div style="font-weight: 700; color: ${c.count === 0 ? 'var(--error)' : 'var(--warning)'};">${c.count} videos</div>
                            ${c.retainer > 0 ? `<div style="font-size: 0.7rem; color: var(--warning);"> ${fmtMoney(c.retainer)}/mo</div>` : (c.retainer === 0 ? '<div style="font-size: 0.7rem;"><span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.65rem;">Affiliate</span></div>' : '')}
                        </td>
                    </tr>
                `).join('');
            if (d.belowTarget.length > PREVIEW_LIMIT) {
                belowHtml += `<tr><td colspan="2" style="padding: 12px 16px; text-align: center; color: var(--accent); font-size: 0.85rem;">+${d.belowTarget.length - PREVIEW_LIMIT} more  Click for full list</td></tr>`;
            }
            document.getElementById('weeklyBelowTarget').innerHTML = belowHtml;
        }
        
        function copyWeeklyReviewForDiscord() {
            const d = weeklyReviewData;
            const brand = document.getElementById('opsBrandFilter')?.value || 'all';
            const brandName = brand === 'all' ? 'All Brands' : (BRAND_DISPLAY[brand] || brand);
            
            let text = ` **Weekly Creator Review - ${brandName}**\n`;
            text += `Last 7 Days | Total GMV: ${fmtMoney(d.totalGmv)} | Videos: ${d.totalVideos}\n\n`;
            
            // Top Performers
            text += ` **TOP PERFORMERS**\n`;
            if (d.topPerformers.length === 0) {
                text += `No standout performers this week\n`;
            } else {
                d.topPerformers.slice(0, 5).forEach((c, i) => {
                    text += `${i + 1}. @${c.name} - ${fmtMoney(c.gmv)}`;
                    if (c.change > 20) text += ` `;
                    text += `\n`;
                });
                if (d.topPerformers.length > 5) text += `   +${d.topPerformers.length - 5} more\n`;
            }
            
            // Needs Attention
            text += `\n **NEEDS ATTENTION** (${d.needsAttention.length})\n`;
            if (d.needsAttention.length === 0) {
                text += `All good! No concerns.\n`;
            } else {
                d.needsAttention.slice(0, 5).forEach(c => {
                    text += ` @${c.name} - ${fmtMoney(c.gmv)}`;
                    if (c.retainer > 0) text += ` (${fmtMoney(c.retainer)} retainer)`;
                    if (c.change < -50) text += ` ${Math.abs(c.change).toFixed(0)}%`;
                    text += `\n`;
                });
                if (d.needsAttention.length > 5) text += `   +${d.needsAttention.length - 5} more\n`;
            }
            
            // Below 5 Posts
            text += `\n **BELOW 5 POSTS** (${d.belowTarget.length})\n`;
            if (d.belowTarget.length === 0) {
                text += `Everyone hitting posting target! \n`;
            } else {
                const zeroPosts = d.belowTarget.filter(c => c.count === 0);
                const lowPosts = d.belowTarget.filter(c => c.count > 0 && c.count < 5);
                
                if (zeroPosts.length > 0) {
                    text += `**0 posts:** ${zeroPosts.slice(0, 8).map(c => c.name).join(', ')}`;
                    if (zeroPosts.length > 8) text += ` +${zeroPosts.length - 8} more`;
                    text += `\n`;
                }
                if (lowPosts.length > 0) {
                    text += `**1-4 posts:** ${lowPosts.slice(0, 8).map(c => `${c.name} (${c.count})`).join(', ')}`;
                    if (lowPosts.length > 8) text += ` +${lowPosts.length - 8} more`;
                    text += `\n`;
                }
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        // ==================== ROI REPORT ====================
        let roiReportData = [];
        let roiReportFiltered = [];
        
        async function loadRoiReport() {
            opsData.roiReportLoaded = true;
            const tbody = document.getElementById('roiReportBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';
            
            try {
                // Check for product and brand filters from Ops Center header
                const selectedProduct = document.getElementById('opsProductFilter')?.value || 'all';
                const selectedBrand = document.getElementById('opsBrandFilter')?.value || 'all';
                
                // Load managed creators with retainers
                await loadManagedCreators();
                
                // Filter creators based on retainer
                // If product selected, include creators with either base retainer OR product-specific retainer
                let retainerCreators;
                if (selectedProduct !== 'all') {
                    retainerCreators = managedCreators.filter(c => {
                        const baseRetainer = c.retainer || 0;
                        const productRetainer = (c.product_retainers || {})[selectedProduct] || 0;
                        return baseRetainer > 0 || productRetainer > 0;
                    });
                    retainerCreators = filterCreatorsByProduct(retainerCreators, selectedProduct);
                } else {
                    // Include creators with any retainer (overall OR product-specific)
                    retainerCreators = managedCreators.filter(c => hasAnyRetainer(c));
                }
                
                // Filter by brand if selected
                if (selectedBrand !== 'all') {
                    retainerCreators = retainerCreators.filter(c => c.brand === selectedBrand);
                }
                
                if (retainerCreators.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 60px; color: var(--text-muted);"><div style="font-size: 2rem; margin-bottom: 8px;"></div>No creators on retainer' + (selectedProduct !== 'all' ? ' for this product' : '') + '</td></tr>';
                    // Reset stats
                    document.getElementById('roiTotalRetainers').textContent = '0';
                    document.getElementById('roiTotalSpend').textContent = '$0';
                    document.getElementById('roiTotalGmv').textContent = '$0';
                    document.getElementById('roiAverageRoi').textContent = '0x';
                    document.getElementById('roiUnderperforming').textContent = '0';
                    return;
                }
                
                // Get performance data for last 30 days
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                const priorEndDate = new Date(startDate);
                priorEndDate.setDate(priorEndDate.getDate() - 1);
                const priorStartDate = new Date(priorEndDate);
                priorStartDate.setDate(priorStartDate.getDate() - 30);
                
                const startStr = startDate.toISOString().split('T')[0];
                const endStr = endDate.toISOString().split('T')[0];
                const priorStartStr = priorStartDate.toISOString().split('T')[0];
                const priorEndStr = priorEndDate.toISOString().split('T')[0];
                
                // Fetch GMV data - either from video_performance (product) or creator_performance (brand)
                let gmvMap = {};
                let priorGmvMap = {};
                
                if (selectedProduct !== 'all') {
                    // Use product-level GMV from video_performance
                    gmvMap = await getProductGmv(selectedProduct, startStr, endStr, selectedBrand);
                    priorGmvMap = await getProductGmv(selectedProduct, priorStartStr, priorEndStr, selectedBrand);
                } else {
                    // Use brand-level GMV from creator_performance
                    const { data: perfData } = await supabaseClient
                        .from('creator_performance')
                        .select('creator_name, brand, gmv')
                        .gte('report_date', startStr)
                        .lte('report_date', endStr);
                    
                    const { data: priorPerfData } = await supabaseClient
                        .from('creator_performance')
                        .select('creator_name, brand, gmv')
                        .gte('report_date', priorStartStr)
                        .lte('report_date', priorEndStr);
                    
                    (perfData || []).forEach(row => {
                        const key = `${row.creator_name.toLowerCase()}|${row.brand}`;
                        gmvMap[key] = (gmvMap[key] || 0) + (parseFloat(row.gmv) || 0);
                    });
                    
                    (priorPerfData || []).forEach(row => {
                        const key = `${row.creator_name.toLowerCase()}|${row.brand}`;
                        priorGmvMap[key] = (priorGmvMap[key] || 0) + (parseFloat(row.gmv) || 0);
                    });
                }
                
                // Build ROI data
                roiReportData = retainerCreators.map(c => {
                    const accounts = [c.account_1, c.account_2, c.account_3].filter(Boolean);
                    let totalGmv = 0;
                    let priorGmv = 0;
                    
                    accounts.forEach(acc => {
                        const key = `${acc.toLowerCase()}|${c.brand}`;
                        totalGmv += gmvMap[key] || 0;
                        priorGmv += priorGmvMap[key] || 0;
                    });
                    
                    // Determine which retainer to use
                    // If product selected, use product-specific retainer; otherwise use base retainer
                    let effectiveRetainer = c.retainer;
                    if (selectedProduct !== 'all') {
                        const productRetainers = c.product_retainers || {};
                        effectiveRetainer = productRetainers[selectedProduct] || 0;
                    }
                    
                    const commission = totalGmv * 0.02;
                    const roi = effectiveRetainer > 0 ? (totalGmv / effectiveRetainer) : 0;
                    const priorRoi = effectiveRetainer > 0 ? (priorGmv / effectiveRetainer) : 0;
                    const roiChange = priorRoi > 0 ? ((roi - priorRoi) / priorRoi * 100) : 0;
                    
                    return {
                        name: c.real_name || c.discord_name || c.account_1,
                        handle: c.account_1,
                        brand: c.brand,
                        retainer: effectiveRetainer,
                        baseRetainer: c.retainer,
                        gmv: totalGmv,
                        commission: commission,
                        roi: roi,
                        roiChange: roiChange,
                        status: c.status
                    };
                });
                
                // Update summary stats
                const totalCreators = roiReportData.length;
                const totalSpend = roiReportData.reduce((s, c) => s + c.retainer, 0);
                const totalGmv = roiReportData.reduce((s, c) => s + c.gmv, 0);
                const avgRoi = totalCreators > 0 ? roiReportData.reduce((s, c) => s + c.roi, 0) / totalCreators : 0;
                const underperforming = roiReportData.filter(c => c.roi < 1).length;
                
                document.getElementById('roiTotalRetainers').textContent = totalCreators;
                document.getElementById('roiTotalSpend').textContent = fmtMoney(totalSpend);
                document.getElementById('roiTotalGmv').textContent = fmtMoney(totalGmv);
                document.getElementById('roiAverageRoi').textContent = avgRoi.toFixed(1) + 'x';
                document.getElementById('roiAverageRoi').style.color = avgRoi >= 1 ? 'var(--success)' : 'var(--error)';
                document.getElementById('roiUnderperforming').textContent = underperforming;
                
                // Render table
                filterRoiReport();
                
            } catch (err) {
                console.error('Error loading ROI report:', err);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--error);">Error loading data</td></tr>';
            }
        }
        
        function filterRoiReport() {
            const brand = document.getElementById('roiBrandFilter')?.value || 'all';
            const status = document.getElementById('roiStatusFilter')?.value || 'all';
            const sort = document.getElementById('roiSortBy')?.value || 'roi-desc';
            const search = (document.getElementById('roiSearchFilter')?.value || '').toLowerCase();
            
            // Filter
            roiReportFiltered = roiReportData.filter(c => {
                if (brand !== 'all' && c.brand !== brand) return false;
                if (status === 'profitable' && c.roi < 1) return false;
                if (status === 'underperforming' && c.roi >= 1) return false;
                if (status === 'critical' && c.roi >= 0.5) return false;
                if (search && !c.name.toLowerCase().includes(search) && !c.handle.toLowerCase().includes(search)) return false;
                return true;
            });
            
            // Sort
            const [field, dir] = sort.split('-');
            const mult = dir === 'desc' ? -1 : 1;
            roiReportFiltered.sort((a, b) => {
                let aVal, bVal;
                switch (field) {
                    case 'roi': aVal = a.roi; bVal = b.roi; break;
                    case 'retainer': aVal = a.retainer; bVal = b.retainer; break;
                    case 'gmv': aVal = a.gmv; bVal = b.gmv; break;
                    case 'name': return mult * a.name.localeCompare(b.name);
                    default: return 0;
                }
                return mult * (bVal - aVal);
            });
            
            // Update summary cards based on filtered data
            const totalCreators = roiReportFiltered.length;
            const totalSpend = roiReportFiltered.reduce((s, c) => s + c.retainer, 0);
            const totalGmv = roiReportFiltered.reduce((s, c) => s + c.gmv, 0);
            const avgRoi = totalCreators > 0 ? roiReportFiltered.reduce((s, c) => s + c.roi, 0) / totalCreators : 0;
            const underperforming = roiReportFiltered.filter(c => c.roi < 1).length;
            
            document.getElementById('roiTotalRetainers').textContent = totalCreators;
            document.getElementById('roiTotalSpend').textContent = fmtMoney(totalSpend);
            document.getElementById('roiTotalGmv').textContent = fmtMoney(totalGmv);
            document.getElementById('roiAverageRoi').textContent = avgRoi.toFixed(1) + 'x';
            document.getElementById('roiAverageRoi').style.color = avgRoi >= 1 ? 'var(--success)' : 'var(--error)';
            document.getElementById('roiUnderperforming').textContent = underperforming;
            
            // Update count
            document.getElementById('roiTableCount').textContent = `Showing ${roiReportFiltered.length} of ${roiReportData.length}`;
            
            // Render
            renderRoiTable();
        }
        
        function renderRoiTable() {
            const tbody = document.getElementById('roiReportBody');
            
            if (roiReportFiltered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No matching creators</td></tr>';
                return;
            }
            
            tbody.innerHTML = roiReportFiltered.map(c => {
                const roiColor = c.roi >= 1 ? 'var(--success)' : (c.roi >= 0.5 ? 'var(--warning)' : 'var(--error)');
                const statusBadge = c.roi >= 1 
                    ? '<span class="badge" style="background: var(--success-dim); color: var(--success);"> Profitable</span>'
                    : (c.roi >= 0.5 
                        ? '<span class="badge" style="background: var(--warning-dim); color: var(--warning);"> Low</span>'
                        : '<span class="badge" style="background: var(--error-dim); color: var(--error);"> Critical</span>');
                
                const trendIcon = c.roiChange >= 10 ? '' : (c.roiChange <= -10 ? '' : '');
                const trendColor = c.roiChange >= 0 ? 'var(--success)' : 'var(--error)';
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${c.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">@${c.handle}</div>
                        </td>
                        <td><span class="badge-brand">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                        <td style="text-align: right; font-weight: 600;">${fmtMoney(c.retainer)}</td>
                        <td style="text-align: right; font-weight: 600; color: var(--success);">${fmtMoney(c.gmv)}</td>
                        <td style="text-align: right; color: var(--text-muted);">${fmtMoney(c.commission)}</td>
                        <td style="text-align: center;"><span style="font-weight: 700; font-size: 1.1rem; color: ${roiColor};">${c.roi.toFixed(1)}x</span></td>
                        <td style="text-align: center;">${statusBadge}</td>
                        <td style="text-align: center;">
                            <span style="color: ${trendColor};">${trendIcon}</span>
                            <span style="font-size: 0.75rem; color: ${trendColor};">${c.roiChange >= 0 ? '+' : ''}${c.roiChange.toFixed(0)}%</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function exportRoiReport() {
            if (roiReportFiltered.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const headers = ['Creator', 'Handle', 'Brand', 'Retainer', 'GMV (30d)', 'Commission', 'ROI', 'Status'];
            const rows = roiReportFiltered.map(c => [
                c.name,
                `@${c.handle}`,
                c.brand,
                c.retainer.toFixed(2),
                c.gmv.toFixed(2),
                c.commission.toFixed(2),
                c.roi.toFixed(2) + 'x',
                c.roi >= 1 ? 'Profitable' : (c.roi >= 0.5 ? 'Low' : 'Critical')
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadCSV(csv, `roi-report-${new Date().toISOString().split('T')[0]}.csv`);
            showToast(`Exported ${roiReportFiltered.length} rows!`, 'success');
        }
        
        // ==================== END ROI REPORT ====================
        
        // ==================== DECISIONS DASHBOARD ====================
        let decisionsData = [];
        let decisionsCategories = { cut: [], watch: [], keep: [] };
        
        // Toggle decision section visibility
        function toggleDecisionSection(section) {
            const content = document.getElementById(`decisions${section.charAt(0).toUpperCase() + section.slice(1)}Content`);
            const toggle = document.getElementById(`decisions${section.charAt(0).toUpperCase() + section.slice(1)}Toggle`);
            if (!content || !toggle) return;
            
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'grid' : 'none';
            toggle.textContent = isHidden ? '' : '';
            
            // Update border radius
            const header = content.previousElementSibling;
            if (header) {
                header.style.borderRadius = isHidden ? '12px 12px 0 0' : '12px';
            }
        }
        
        // Copy decision section to Discord
        function copyDecisionDiscord(section) {
            const brand = document.getElementById('decisionsBrandFilter')?.value || 'all';
            const brandName = brand === 'all' ? 'All Brands' : BRAND_DISPLAY[brand];
            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            let creators = decisionsCategories[section] || [];
            if (creators.length === 0) {
                showToast(`No ${section} creators to copy`, 'warning');
                return;
            }
            
            creators = creators.slice(0, 20);
            let text = '';
            
            switch(section) {
                case 'cut':
                    text = ` **RECOMMEND CUT - ${brandName}** \n`;
                    text += `_Below 1x ROI - losing money (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        text += `**${i + 1}. @${c.handle}** - ${c.roi.toFixed(1)}x ROI - ${fmtMoney(c.retainer)}/mo\n`;
                        text += `    GMV: ${fmtMoney(c.gmv)} | Posts: ${c.postsPeriod}/${c.postReq}\n`;
                    });
                    const totalAtRisk = creators.reduce((sum, c) => sum + c.retainer, 0);
                    text += `\n** Total at risk: ${fmtMoney(totalAtRisk)}/mo**`;
                    break;
                    
                case 'watch':
                    text = ` **WATCH LIST - ${brandName}** \n`;
                    text += `_1-3x ROI - monitor closely (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        text += `**${i + 1}. @${c.handle}** - ${c.roi.toFixed(1)}x ROI - ${fmtMoney(c.retainer)}/mo\n`;
                    });
                    break;
                    
                case 'keep':
                    text = ` **KEEP - ${brandName}** \n`;
                    text += `_3x+ ROI - solid performers (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        const starBadge = c.roi >= 10 ? ' ' : '';
                        text += `${starBadge}**@${c.handle}** - ${c.roi.toFixed(1)}x ROI\n`;
                    });
                    break;
            }
            
            navigator.clipboard.writeText(text);
            showToast(`${section.charAt(0).toUpperCase() + section.slice(1)} list copied!`, 'success');
        }
        
        async function loadDecisions() {
            // Show loading state
            const sections = ['Cut', 'Watch', 'Keep'];
            sections.forEach(section => {
                const el = document.getElementById(`decisions${section}Grid`);
                if (el) el.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);"><div class="spinner" style="margin: 0 auto 12px;"></div>Loading...</div>';
            });
            
            try {
                const selectedBrand = document.getElementById('decisionsBrandFilter')?.value || 'all';
                const selectedProduct = document.getElementById('decisionsProductFilter')?.value || 'all';
                
                // Load managed creators
                await loadManagedCreators();
                
                // Filter to retainer creators only (default view)
                let retainerCreators = managedCreators.filter(c => hasAnyRetainer(c) && c.status === 'Active');
                
                if (selectedBrand !== 'all') {
                    retainerCreators = retainerCreators.filter(c => c.brand === selectedBrand);
                }
                
                // Filter by product assignment if selected
                if (selectedProduct !== 'all') {
                    retainerCreators = retainerCreators.filter(c => {
                        const productRetainers = c.product_retainers || {};
                        // Creator is assigned if they have ANY entry for this product (including 0 or null)
                        return selectedProduct in productRetainers;
                    });
                }
                
                if (retainerCreators.length === 0) {
                    sections.forEach(section => {
                        const el = document.getElementById(`decisions${section}Grid`);
                        if (el) el.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">No retainer creators found' + (selectedProduct !== 'all' ? ' for this product' : '') + '</div>';
                    });
                    updateDecisionStats();
                    return;
                }
                
                // Helper to calculate contract period for a creator
                // Contract stays open from start date until manually reset
                // Returns { start: Date, end: Date, dayNumber: number, totalDays: number, isOverdue: boolean }
                function getContractPeriod(retainerStartDate, contractLengthDays = 30) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const lengthDays = contractLengthDays || 30;
                    
                    if (!retainerStartDate) {
                        // No start date set - use rolling period as fallback
                        const start = new Date(today);
                        start.setDate(today.getDate() - (lengthDays - 1));
                        return {
                            start: start,
                            end: today,
                            dayNumber: lengthDays,
                            totalDays: lengthDays,
                            isDefault: true,
                            isOverdue: false
                        };
                    }
                    
                    const startDate = new Date(retainerStartDate);
                    startDate.setHours(0, 0, 0, 0);
                    
                    // Days since contract started (1-indexed)
                    const dayNumber = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Expected end date
                    const expectedEnd = new Date(startDate);
                    expectedEnd.setDate(expectedEnd.getDate() + lengthDays - 1);
                    
                    // Is the contract overdue?
                    const isOverdue = dayNumber > lengthDays;
                    
                    return {
                        start: startDate,
                        end: expectedEnd,
                        dayNumber: dayNumber,
                        totalDays: lengthDays,
                        isDefault: false,
                        isOverdue: isOverdue,
                        daysOverdue: isOverdue ? dayNumber - lengthDays : 0
                    };
                }
                
                // Get date range for ALL creators (need 60 days back for trends)
                const today = new Date();
                const localDateStrFn = (d) => d.toISOString().split('T')[0];
                const todayStr = localDateStrFn(today);
                
                const sixtyDaysAgo = new Date(today);
                sixtyDaysAgo.setDate(today.getDate() - 60);
                const sixtyDaysAgoStr = localDateStrFn(sixtyDaysAgo);
                
                // Update date range display
                document.getElementById('decisionsDateRange').innerHTML = `Contract period ROI  Based on each creator's start date`;
                
                // Fetch creator_performance data for last 60 days
                let perfQuery = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, videos, report_date')
                    .gte('report_date', sixtyDaysAgoStr)
                    .lte('report_date', todayStr)
                    .order('creator_name', { ascending: true })
                    .limit(30000);
                
                if (selectedBrand !== 'all') {
                    perfQuery = perfQuery.eq('brand', selectedBrand);
                }
                
                const { data: perfData, error: perfError } = await perfQuery;
                if (perfError) throw perfError;
                
                // Build a map of all performance data by creator|brand|date
                const perfByCreatorDate = {};
                (perfData || []).forEach(row => {
                    const key = `${row.creator_name.toLowerCase()}|${row.brand}|${row.report_date}`;
                    if (!perfByCreatorDate[key]) {
                        perfByCreatorDate[key] = { gmv: 0, videos: 0 };
                    }
                    perfByCreatorDate[key].gmv += pFloat(row.gmv);
                    perfByCreatorDate[key].videos += pInt(row.videos);
                });
                
                // Build decisions data with contract-specific periods
                decisionsData = retainerCreators.map(c => {
                    const accounts = [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].filter(a => a && a.trim());
                    const contractLength = c.contract_length_days || 30;
                    
                    // Get this creator's contract period
                    const period = getContractPeriod(c.retainer_start_date, contractLength);
                    const periodStartStr = localDateStrFn(period.start);
                    const periodEndStr = localDateStrFn(period.end);
                    
                    // Previous period for trend (same length as current period)
                    const prevPeriodEnd = new Date(period.start);
                    prevPeriodEnd.setDate(prevPeriodEnd.getDate() - 1);
                    const prevPeriodStart = new Date(prevPeriodEnd);
                    prevPeriodStart.setDate(prevPeriodStart.getDate() - (contractLength - 1));
                    const prevPeriodStartStr = localDateStrFn(prevPeriodStart);
                    const prevPeriodEndStr = localDateStrFn(prevPeriodEnd);
                    
                    // Sum GMV and posts for current and previous periods
                    let gmvPeriod = 0;
                    let gmvPrevPeriod = 0;
                    let postsPeriod = 0;
                    
                    accounts.forEach(acc => {
                        // Iterate through dates in current period
                        let d = new Date(period.start);
                        const endD = new Date(today); // Only count up to today
                        while (d <= endD) {
                            const dateStr = localDateStrFn(d);
                            const key = `${acc.toLowerCase()}|${c.brand}|${dateStr}`;
                            if (perfByCreatorDate[key]) {
                                gmvPeriod += perfByCreatorDate[key].gmv;
                                postsPeriod += perfByCreatorDate[key].videos;
                            }
                            d.setDate(d.getDate() + 1);
                        }
                        
                        // Iterate through dates in previous period
                        d = new Date(prevPeriodStart);
                        while (d <= prevPeriodEnd) {
                            const dateStr = localDateStrFn(d);
                            const key = `${acc.toLowerCase()}|${c.brand}|${dateStr}`;
                            if (perfByCreatorDate[key]) {
                                gmvPrevPeriod += perfByCreatorDate[key].gmv;
                            }
                            d.setDate(d.getDate() + 1);
                        }
                    });
                    
                    // Calculate retainer - use product-specific if product selected
                    let effectiveRetainer = getTotalRetainer(c);
                    if (selectedProduct !== 'all') {
                        const productRetainer = (c.product_retainers || {})[selectedProduct] || 0;
                        if (productRetainer > 0) {
                            effectiveRetainer = productRetainer;
                        }
                    }
                    
                    const roi = effectiveRetainer > 0 ? (gmvPeriod / effectiveRetainer) : 0;
                    const roiPrev = effectiveRetainer > 0 ? (gmvPrevPeriod / effectiveRetainer) : 0;
                    
                    // ROI trend
                    let roiTrend = 'stable';
                    if (roiPrev > 0) {
                        const roiChange = ((roi - roiPrev) / roiPrev) * 100;
                        if (roiChange > 10) roiTrend = 'up';
                        else if (roiChange < -10) roiTrend = 'down';
                    }
                    
                    // Determine category: Cut (<1x), Watch (1-3x), Keep (3x+), Stars (10x+)
                    let category = 'keep';
                    let isStar = false;
                    if (roi < 1) {
                        category = 'cut';
                    } else if (roi < 3) {
                        category = 'watch';
                    } else {
                        category = 'keep';
                        if (roi >= 10) isStar = true;
                    }
                    
                    // Posting compliance - based on contract period
                    const postReq = c.monthly_post_requirement || 30;
                    const postCompliance = postReq > 0 ? Math.round((postsPeriod / postReq) * 100) : 100;
                    const isBelowPostReq = postsPeriod < postReq;
                    
                    // Check if PC Fiber
                    const isPCFiber = c.brand === 'physicians_choice' && c.product_retainers && c.product_retainers['pc_fiber'] > 0;
                    
                    return {
                        id: c.id,
                        name: c.real_name || c.discord_name || c.account_1,
                        handle: c.account_1,
                        brand: c.brand,
                        retainer: effectiveRetainer,
                        gmv: gmvPeriod,
                        gmvPrev: gmvPrevPeriod,
                        roi: roi,
                        roiPrev: roiPrev,
                        roiTrend: roiTrend,
                        postsPeriod: postsPeriod,
                        postReq: postReq,
                        postCompliance: postCompliance,
                        isBelowPostReq: isBelowPostReq,
                        category: category,
                        isStar: isStar,
                        isPCFiber: isPCFiber,
                        productRetainers: c.product_retainers || {},
                        discordChannelId: c.discord_channel_id,
                        // Contract period info
                        periodStart: period.start,
                        periodEnd: period.end,
                        dayNumber: period.dayNumber,
                        totalDays: period.totalDays,
                        hasStartDate: !period.isDefault,
                        isOverdue: period.isOverdue,
                        daysOverdue: period.daysOverdue || 0
                    };
                });
                
                // Sort by ROI (worst first for cut, best first for keep)
                decisionsData.sort((a, b) => a.roi - b.roi);
                
                filterDecisions();
                
            } catch (err) {
                console.error('Error loading decisions:', err);
                const sections = ['Cut', 'Watch', 'Keep'];
                sections.forEach(section => {
                    const el = document.getElementById(`decisions${section}Grid`);
                    if (el) el.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--danger);">Error: ${err.message}</div>`;
                });
            }
        }
        
        function filterDecisions() {
            const creatorType = document.getElementById('decisionsTypeFilter')?.value || 'retainer';
            const search = document.getElementById('decisionsSearchFilter')?.value?.toLowerCase() || '';
            
            let filtered = decisionsData.filter(c => {
                if (creatorType === 'retainer' && c.retainer <= 0) return false;
                if (creatorType === 'pcfiber' && !c.isPCFiber) return false;
                if (search && !c.name.toLowerCase().includes(search) && !c.handle?.toLowerCase().includes(search)) return false;
                return true;
            });
            
            // Categorize
            decisionsCategories = {
                cut: filtered.filter(c => c.category === 'cut').sort((a, b) => a.roi - b.roi),
                watch: filtered.filter(c => c.category === 'watch').sort((a, b) => a.roi - b.roi),
                keep: filtered.filter(c => c.category === 'keep').sort((a, b) => b.roi - a.roi)
            };
            
            updateDecisionStats();
            renderDecisionSections();
        }
        
        function updateDecisionStats() {
            const cut = decisionsCategories.cut.length;
            const watch = decisionsCategories.watch.length;
            const keep = decisionsCategories.keep.length;
            const stars = decisionsCategories.keep.filter(c => c.isStar).length;
            
            // $ at risk = retainer for Cut + Watch
            const atRiskCreators = [...decisionsCategories.cut, ...decisionsCategories.watch];
            const atRisk = atRiskCreators.reduce((sum, c) => sum + c.retainer, 0);
            
            document.getElementById('decisionsCutCount').textContent = cut;
            document.getElementById('decisionsWatchCount').textContent = watch;
            document.getElementById('decisionsKeepCount').textContent = keep;
            document.getElementById('decisionsStarsCount').textContent = stars;
            document.getElementById('decisionsAtRisk').textContent = fmtMoney(atRisk);
            document.getElementById('decisionsAtRiskCreators').textContent = `${atRiskCreators.length} creator${atRiskCreators.length !== 1 ? 's' : ''}`;
            
            // Update badges
            document.getElementById('decisionsCutBadge').textContent = cut;
            document.getElementById('decisionsWatchBadge').textContent = watch;
            document.getElementById('decisionsKeepBadge').textContent = keep;
        }
        
        function renderDecisionSections() {
            renderDecisionSection('Cut', decisionsCategories.cut, '#ef4444');
            renderDecisionSection('Watch', decisionsCategories.watch, '#f59e0b');
            renderDecisionSection('Keep', decisionsCategories.keep, '#22c55e');
        }
        
        function renderDecisionSection(sectionName, creators, accentColor) {
            const container = document.getElementById(`decisions${sectionName}Grid`);
            if (!container) return;
            
            if (creators.length === 0) {
                const emptyMessages = {
                    'Cut': ' No creators to cut - everyone is performing!',
                    'Watch': ' No one on watch list!',
                    'Keep': 'No keepers found'
                };
                container.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">${emptyMessages[sectionName] || 'No creators'}</div>`;
                return;
            }
            
            container.innerHTML = creators.map(c => renderDecisionCard(c, accentColor)).join('');
        }
        
        function renderDecisionCard(c, accentColor) {
            // ROI color
            const roiColor = c.roi >= 10 ? '#8b5cf6' : c.roi >= 3 ? '#22c55e' : c.roi >= 1 ? '#f59e0b' : '#ef4444';
            
            // ROI trend indicator
            const trendIcon = c.roiTrend === 'up' ? '' : c.roiTrend === 'down' ? '' : '';
            const trendColor = c.roiTrend === 'up' ? '#22c55e' : c.roiTrend === 'down' ? '#ef4444' : 'var(--text-muted)';
            
            // Star badge
            const starBadge = c.isStar ? '<span style="background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;"> STAR</span>' : '';
            
            // PC Fiber badge
            const fiberBadge = c.isPCFiber ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;">FIBER</span>' : '';
            
            // Posting compliance
            const postColor = c.postCompliance >= 100 ? '#22c55e' : c.postCompliance >= 80 ? '#f59e0b' : '#ef4444';
            const postFlag = c.isBelowPostReq ? `<span style="color: ${postColor}; font-size: 0.7rem;" title="Below ${c.postReq} post requirement"></span>` : '';
            
            // Discord button
            const discordBtn = c.discordChannelId 
                ? `<button onclick="openDiscordChannel('${c.brand}', '${c.discordChannelId}')" class="btn btn-sm" style="background: #5865F2; color: white; padding: 5px 10px; font-size: 0.7rem;"></button>`
                : '';
            
            // Contract period display
            const periodStart = c.periodStart ? c.periodStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
            const periodEnd = c.periodEnd ? c.periodEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
            
            // Build period label with overdue warning
            let periodLabel, periodColor;
            if (!c.hasStartDate) {
                periodLabel = `Rolling ${c.totalDays}d (no start date set)`;
                periodColor = '#f59e0b';
            } else if (c.isOverdue) {
                periodLabel = ` Day ${c.dayNumber}/${c.totalDays} (+${c.daysOverdue} overdue)`;
                periodColor = '#ef4444';
            } else {
                periodLabel = `${periodStart} - ${periodEnd} (Day ${c.dayNumber}/${c.totalDays})`;
                periodColor = 'var(--text-muted)';
            }
            
            return `
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; border: 1px solid var(--border); border-left: 4px solid ${accentColor}; transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                    <!-- Left: Creator Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap;">
                            <span style="font-weight: 700; font-size: 0.95rem;">${sanitize(c.name)}</span>
                            ${starBadge}
                            ${fiberBadge}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">
                            <a href="https://www.tiktok.com/@${c.handle}" target="_blank" style="color: var(--blue); text-decoration: none;">@${c.handle}</a>
                            <span></span>
                            <span class="badge-brand" style="font-size: 0.65rem;">${BRAND_DISPLAY[c.brand] || c.brand}</span>
                            <span></span>
                            <span style="color: var(--accent);">${fmtMoney(c.retainer)}/mo</span>
                        </div>
                        
                        <!-- Contract Period -->
                        <div style="font-size: 0.65rem; color: ${periodColor}; margin-bottom: 10px; font-weight: ${c.isOverdue ? '600' : 'normal'};">
                             ${periodLabel}
                        </div>
                        
                        <!-- Metrics Grid -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 0.75rem;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.65rem;">Period GMV</div>
                                <div style="font-weight: 600; color: var(--success);">${fmtMoney(c.gmv)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.65rem;">Posts ${postFlag}</div>
                                <div style="font-weight: 600; color: ${postColor};">${c.postsPeriod}/${c.postReq}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.65rem;">Prev Period</div>
                                <div style="font-weight: 600; color: ${trendColor};">${trendIcon} ${c.roiPrev > 0 ? c.roiPrev.toFixed(1) + 'x' : '--'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: ROI + Actions -->
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: ${roiColor}; line-height: 1;">${c.roi.toFixed(1)}x</div>
                            <div style="font-size: 0.6rem; color: var(--text-muted);">ROI</div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            ${discordBtn}
                            <button onclick="editCreator(${c.id})" class="btn btn-sm" style="padding: 5px 10px; font-size: 0.7rem;"></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        // ==================== END DECISIONS DASHBOARD ====================
        
        // ==================== POSTING ACCOUNTABILITY ====================
        let postingData = [];
        let postingFiltered = [];
        let postingCategories = { ghosts: [], behind: [], atrisk: [], ontrack: [], stars: [], trending: [] };
        let postingContactLog = {};
        
        // Load contact log from localStorage on init
        try {
            const saved = localStorage.getItem('creatorContactLog');
            if (saved) postingContactLog = JSON.parse(saved);
        } catch (e) {
            console.warn('Could not load contact log from localStorage');
        }
        
        // Toggle section visibility
        function togglePostingSection(section) {
            const content = document.getElementById(`posting${section.charAt(0).toUpperCase() + section.slice(1)}Content`);
            const toggle = document.getElementById(`posting${section.charAt(0).toUpperCase() + section.slice(1)}Toggle`);
            if (!content || !toggle) return;
            
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'grid' : 'none';
            toggle.textContent = isHidden ? '' : '';
            
            // Update border radius
            const header = content.previousElementSibling;
            if (header) {
                header.style.borderRadius = isHidden ? '12px 12px 0 0' : '12px';
            }
        }
        
        // Handle brand change in Posting tab - load products for that brand
        async function onPostingBrandChange() {
            const brand = document.getElementById('postingBrandFilter')?.value || 'all';
            const productSelect = document.getElementById('postingProductFilter');
            
            // Reset product filter
            productSelect.innerHTML = '<option value="all">All Products</option>';
            
            try {
                // Load products from products table (for creator assignments)
                let productsQuery = supabaseClient.from('products')
                    .select('product_key, display_name, brand')
                    .eq('status', 'active')
                    .order('display_name');
                
                if (brand !== 'all') {
                    productsQuery = productsQuery.eq('brand', brand);
                }
                
                const { data: products, error: productsError } = await productsQuery;
                
                if (!productsError && products && products.length > 0) {
                    // Group by brand if showing all brands
                    if (brand === 'all') {
                        const byBrand = {};
                        products.forEach(p => {
                            if (!byBrand[p.brand]) byBrand[p.brand] = [];
                            byBrand[p.brand].push(p);
                        });
                        
                        Object.entries(byBrand).forEach(([b, prods]) => {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = BRAND_DISPLAY[b] || b;
                            prods.forEach(p => {
                                const option = document.createElement('option');
                                option.value = p.product_key;
                                option.textContent = p.display_name;
                                optgroup.appendChild(option);
                            });
                            productSelect.appendChild(optgroup);
                        });
                    } else {
                        products.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.product_key;
                            option.textContent = p.display_name;
                            productSelect.appendChild(option);
                        });
                    }
                }
                
                // Store products for filter reference
                window.postingProducts = products || [];
                
            } catch (err) {
                console.error('Error loading products for filter:', err);
            }
            
            // Load posting data with new filters
            loadPostingData();
        }
        
        // Helper to get product names for Posting GMV filter (from video_performance)
        function getPostingProductNamesForFilter(filterValue) {
            if (!filterValue || filterValue === 'all') {
                return null;
            }
            
            // Look up the product in our cached products to get its associated product_names
            const product = (window.postingProducts || []).find(p => p.product_key === filterValue);
            if (product && product.product_names && product.product_names.length > 0) {
                return product.product_names;
            }
            
            // Fallback: try to find by display_name match
            return [filterValue];
        }
        
        // Copy posting section to Discord
        function copyPostingDiscord(section) {
            if (!postingFiltered || postingFiltered.length === 0) {
                showToast('No posting data loaded', 'warning');
                return;
            }
            
            const brand = document.getElementById('postingBrandFilter')?.value || 'all';
            const brandName = brand === 'all' ? 'All Brands' : BRAND_DISPLAY[brand];
            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            let creators = [];
            let text = '';
            
            switch(section) {
                case 'ghosts':
                    creators = postingCategories.ghosts.slice(0, 15);
                    if (creators.length === 0) { showToast('No ghost creators', 'warning'); return; }
                    text = ` **GHOST CREATORS - ${brandName}** \n`;
                    text += `_Zero posts in last 7 days (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        text += `**${i + 1}. @${c.handle}** - Last post: ${c.daysSincePost !== null ? c.daysSincePost + 'd ago' : 'Never'}\n`;
                        if (c.retainer > 0) text += `    $${c.retainer} retainer\n`;
                    });
                    break;
                    
                case 'behind':
                    creators = postingCategories.behind.slice(0, 15);
                    if (creators.length === 0) { showToast('No behind creators', 'warning'); return; }
                    text = ` **BEHIND ON POSTING - ${brandName}** \n`;
                    text += `_1-3 posts in last 7 days (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        text += `**${i + 1}. @${c.handle}** - ${c.posts7d} posts (need 7+)\n`;
                        if (c.retainer > 0) text += `    $${c.retainer} retainer at risk\n`;
                    });
                    break;
                    
                case 'atrisk':
                    creators = postingCategories.atrisk.slice(0, 15);
                    if (creators.length === 0) { showToast('No at-risk creators', 'warning'); return; }
                    text = ` **AT RISK - ${brandName}** \n`;
                    text += `_4-5 posts in last 7 days (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        text += `**${i + 1}. @${c.handle}** - ${c.posts7d} posts (need 7+)\n`;
                    });
                    break;
                    
                case 'ontrack':
                    creators = postingCategories.ontrack.slice(0, 15);
                    if (creators.length === 0) { showToast('No on-track creators', 'warning'); return; }
                    text = ` **ON TRACK - ${brandName}** \n`;
                    text += `_6-9 posts in last 7 days (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        text += ` **@${c.handle}** - ${c.posts7d} posts\n`;
                    });
                    break;
                    
                case 'stars':
                    creators = postingCategories.stars.slice(0, 15);
                    if (creators.length === 0) { showToast('No star creators', 'warning'); return; }
                    text = ` **POSTING STARS - ${brandName}** \n`;
                    text += `_10+ posts in last 7 days - crushing it! (${today})_\n\n`;
                    creators.forEach((c, i) => {
                        text += ` **@${c.handle}** - ${c.posts7d} posts!\n`;
                    });
                    break;
            }
            
            navigator.clipboard.writeText(text);
            showToast(`${section.charAt(0).toUpperCase() + section.slice(1)} list copied!`, 'success');
        }
        
        async function loadPostingData() {
            // Show loading state
            const sections = ['Ghosts', 'Behind', 'Atrisk', 'Ontrack', 'Stars'];
            sections.forEach(section => {
                const el = document.getElementById(`posting${section}Grid`);
                if (el) el.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);"><div class="spinner" style="margin: 0 auto 12px;"></div>Loading...</div>';
            });
            
            try {
                const selectedBrand = document.getElementById('postingBrandFilter')?.value || 'all';
                const selectedProduct = document.getElementById('postingProductFilter')?.value || 'all';
                
                // Get ALL managed creators (Active only) - ordered for consistent results
                let query = supabaseClient.from('managed_creators').select('*')
                    .eq('status', 'Active')
                    .order('id', { ascending: true });
                if (selectedBrand !== 'all') {
                    query = query.eq('brand', selectedBrand);
                }
                
                const { data: managedCreatorsData, error: mcError } = await query;
                if (mcError) throw mcError;
                
                let allCreators = managedCreatorsData || [];
                
                // Only update global managedCreators when showing all brands
                // This prevents brand-filtered views from breaking other tabs
                if (selectedBrand === 'all') {
                    managedCreators = allCreators;
                }
                
                // Filter by product assignment if selected
                if (selectedProduct !== 'all') {
                    allCreators = allCreators.filter(c => {
                        const productRetainers = c.product_retainers || {};
                        // Creator is assigned if they have ANY entry for this product (including 0 or null)
                        return selectedProduct in productRetainers;
                    });
                }
                
                if (allCreators.length === 0) {
                    if (selectedProduct !== 'all') {
                        const productSelect = document.getElementById('postingProductFilter');
                        const productName = productSelect.options[productSelect.selectedIndex]?.textContent || selectedProduct;
                        const sections = ['Ghosts', 'Behind', 'Atrisk', 'Ontrack', 'Stars'];
                        sections.forEach(section => {
                            const el = document.getElementById(`posting${section}Grid`);
                            if (el) el.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">No creators assigned to <strong>${productName}</strong></div>`;
                        });
                        updatePostingStats();
                        return;
                    }
                    renderPostingEmpty();
                    return;
                }
                
                // Calculate rolling 7-day and previous 7-day boundaries
                // Exclude today since we never have same-day data
                const today = new Date();
                const localDateStrFn = (d) => d.toISOString().split('T')[0];
                
                // Last 7 days: yesterday back to 7 days ago
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                const yesterdayStr = localDateStrFn(yesterday);
                
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                const sevenDaysAgoStr = localDateStrFn(sevenDaysAgo);
                
                // Previous 7 days: 8-14 days ago
                const eightDaysAgo = new Date(today);
                eightDaysAgo.setDate(today.getDate() - 8);
                const eightDaysAgoStr = localDateStrFn(eightDaysAgo);
                
                const fourteenDaysAgo = new Date(today);
                fourteenDaysAgo.setDate(today.getDate() - 14);
                const fourteenDaysAgoStr = localDateStrFn(fourteenDaysAgo);
                
                // Update context display
                const rangeStart = sevenDaysAgo.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const rangeEnd = yesterday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                // Show product in context if selected
                let contextText = `Rolling 7 days: ${rangeStart} - ${rangeEnd}`;
                if (selectedProduct !== 'all') {
                    const productSelect = document.getElementById('postingProductFilter');
                    const productName = productSelect.options[productSelect.selectedIndex]?.textContent || selectedProduct;
                    contextText += `  <span style="color: var(--accent);">Assigned to ${productName}</span>`;
                }
                document.getElementById('postingWeekContext').innerHTML = contextText;
                
                // Fetch creator_performance data for last 14 days
                // This includes GMV and the 'videos' column which is our source of truth for post counts
                let perfQuery = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, videos, report_date')
                    .gte('report_date', fourteenDaysAgoStr)
                    .lte('report_date', yesterdayStr)
                    .limit(50000);
                
                if (selectedBrand !== 'all') {
                    perfQuery = perfQuery.eq('brand', selectedBrand);
                }
                
                // Fetch contact log for last contact dates
                let contactQuery = supabaseClient
                    .from('contact_log')
                    .select('creator_id, creator_name, brand, contact_date')
                    .order('contact_date', { ascending: false });
                
                const [perfResult, contactResult] = await Promise.all([perfQuery, contactQuery]);
                
                if (perfResult.error) throw perfResult.error;
                
                const perfData = perfResult.data || [];
                const contactData = contactResult.data || [];
                
                // If product filter is active, fetch product-specific GMV from video_performance
                let productGmvMap = {};
                let productVideoCountMap = {};
                if (selectedProduct !== 'all') {
                    // Get product_ids for this product_key
                    const products = await loadProductsCache();
                    const product = products.find(p => p.product_key === selectedProduct);
                    const productIds = product?.product_ids || [];
                    
                    if (productIds.length > 0) {
                        // Convert to strings for comparison
                        const productIdStrings = productIds.map(id => String(id));
                        
                        let videoQuery = supabaseClient
                            .from('video_performance')
                            .select('creator_name, brand, gmv, product_id, video_id, report_date')
                            .gte('report_date', sevenDaysAgoStr)
                            .lte('report_date', yesterdayStr)
                            .in('product_id', productIdStrings)
                            .limit(50000);
                        
                        if (selectedBrand !== 'all') {
                            videoQuery = videoQuery.eq('brand', selectedBrand);
                        }
                        
                        const { data: videoData, error: videoError } = await videoQuery;
                        
                        if (!videoError && videoData) {
                            // Group by creator to get product-specific GMV
                            const videosByCreator = {};
                            videoData.forEach(v => {
                                const key = `${v.creator_name.toLowerCase()}|${v.brand}`;
                                if (!videosByCreator[key]) videosByCreator[key] = new Set();
                                videosByCreator[key].add(v.report_date + '|' + (v.video_id || Math.random()));
                                
                                if (!productGmvMap[key]) productGmvMap[key] = 0;
                                productGmvMap[key] += pFloat(v.gmv);
                            });
                            // Count unique videos per creator
                            Object.entries(videosByCreator).forEach(([key, videos]) => {
                                productVideoCountMap[key] = videos.size;
                            });
                        }
                    }
                }
                
                // Build contact date map (latest contact per creator)
                const contactMap = {};
                contactData.forEach(c => {
                    const key = c.creator_id || `${(c.creator_name || '').toLowerCase()}|${c.brand}`;
                    if (!contactMap[key]) contactMap[key] = c.contact_date;
                });
                
                // Build maps from creator_performance data
                // GMV, videos (posts), and last post date
                const gmvMap = {};         // Total GMV in last 7 days
                const posts7dMap = {};     // Sum of videos column in last 7 days
                const postsPrev7dMap = {}; // Sum of videos column in previous 7 days
                const lastPostMap = {};    // Most recent date where videos > 0
                const dailyPostsMap = {};  // Daily breakdown: { "creator|brand": { "2025-12-15": 5, ... } }
                
                perfData.forEach(row => {
                    const key = `${row.creator_name.toLowerCase()}|${row.brand}`;
                    const date = row.report_date;
                    const videos = parseInt(row.videos) || 0;
                    const gmv = pFloat(row.gmv);
                    
                    // Sum GMV for last 7 days only (yesterday back to 7 days ago)
                    if (date >= sevenDaysAgoStr && date <= yesterdayStr) {
                        if (!gmvMap[key]) gmvMap[key] = 0;
                        gmvMap[key] += gmv;
                        
                        // Sum videos for last 7 days
                        if (!posts7dMap[key]) posts7dMap[key] = 0;
                        posts7dMap[key] += videos;
                        
                        // Track daily breakdown
                        if (!dailyPostsMap[key]) dailyPostsMap[key] = {};
                        dailyPostsMap[key][date] = (dailyPostsMap[key][date] || 0) + videos;
                    }
                    
                    // Sum videos for previous 7 days (8-14 days ago)
                    if (date >= fourteenDaysAgoStr && date <= eightDaysAgoStr) {
                        if (!postsPrev7dMap[key]) postsPrev7dMap[key] = 0;
                        postsPrev7dMap[key] += videos;
                    }
                    
                    // Track most recent date where videos > 0
                    if (videos > 0 && (!lastPostMap[key] || date > lastPostMap[key])) {
                        lastPostMap[key] = date;
                    }
                });
                
                // Build posting data for all creators
                postingData = allCreators.map(c => {
                    const accounts = [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5,
                                      c.account_6, c.account_7, c.account_8, c.account_9, c.account_10].filter(a => a && a.trim());
                    let totalGmv = 0;
                    let posts7d = 0;
                    let postsPrev7d = 0;
                    let lastPostDate = null;
                    let dailyPosts = {}; // Merged daily breakdown across all accounts
                    let productGmv = 0;  // Product-specific GMV if product filter active
                    let productVideos = 0; // Product-specific video count
                    
                    accounts.forEach(acc => {
                        const key = `${acc.toLowerCase()}|${c.brand}`;
                        totalGmv += gmvMap[key] || 0;
                        posts7d += posts7dMap[key] || 0;
                        postsPrev7d += postsPrev7dMap[key] || 0;
                        
                        // Add product-specific stats
                        productGmv += productGmvMap[key] || 0;
                        productVideos += productVideoCountMap[key] || 0;
                        
                        if (lastPostMap[key] && (!lastPostDate || lastPostMap[key] > lastPostDate)) {
                            lastPostDate = lastPostMap[key];
                        }
                        
                        // Merge daily posts from this account
                        if (dailyPostsMap[key]) {
                            Object.entries(dailyPostsMap[key]).forEach(([date, count]) => {
                                dailyPosts[date] = (dailyPosts[date] || 0) + count;
                            });
                        }
                    });
                    
                    // Detect burst posting (5+ videos in a single day)
                    let maxDailyPosts = 0;
                    let burstDate = null;
                    let daysWithPosts = 0;
                    Object.entries(dailyPosts).forEach(([date, count]) => {
                        if (count > 0) daysWithPosts++;
                        if (count > maxDailyPosts) {
                            maxDailyPosts = count;
                            burstDate = date;
                        }
                    });
                    
                    // Flag suspicious patterns
                    const isBurstPosting = maxDailyPosts >= 5;
                    const isUnevenPosting = posts7d >= 7 && daysWithPosts <= 2; // Many posts but only 1-2 days
                    
                    // Check if on retainer
                    const isRetainer = hasAnyRetainer(c);
                    const totalRetainer = getTotalRetainer(c);
                    
                    // Determine status based on video count in last 7 days
                    // 0 = ghost, 1-3 = behind, 4-5 = atrisk, 6-9 = ontrack, 10+ = stars
                    let status = 'ontrack';
                    if (posts7d === 0) status = 'ghost';
                    else if (posts7d <= 3) status = 'behind';
                    else if (posts7d <= 5) status = 'atrisk';
                    else if (posts7d >= 10) status = 'stars';
                    
                    // Check if trending down (fewer posts than previous 7 days)
                    const isTrendingDown = postsPrev7d > 0 && posts7d < postsPrev7d;
                    
                    // Get last contact from database
                    const contactKey = c.id || `${(c.account_1 || '').toLowerCase()}|${c.brand}`;
                    const lastContact = contactMap[c.id] || contactMap[contactKey] || c.last_contact_date || null;
                    
                    // Days since last post
                    let daysSincePost = null;
                    if (lastPostDate) {
                        const lpd = new Date(lastPostDate + 'T00:00:00');
                        daysSincePost = Math.floor((today - lpd) / (1000 * 60 * 60 * 24));
                    }
                    
                    // Calculate ROI
                    // When product filter is active, use product-specific GMV and retainer
                    let roi = null;
                    let effectiveRetainer = totalRetainer;
                    let effectiveGmv = totalGmv;
                    
                    if (selectedProduct !== 'all') {
                        // Use product-specific retainer if exists
                        const productRetainerAmount = (c.product_retainers || {})[selectedProduct] || 0;
                        if (productRetainerAmount > 0) {
                            effectiveRetainer = productRetainerAmount;
                        }
                        effectiveGmv = productGmv;
                    }
                    
                    if (effectiveRetainer > 0) {
                        roi = effectiveGmv / effectiveRetainer;
                    }
                    
                    // Check if this creator has a product-specific retainer
                    const hasProductRetainer = selectedProduct !== 'all' && (c.product_retainers || {})[selectedProduct] > 0;
                    
                    // Calculate priority score (higher = more urgent)
                    let priority = 0;
                    if (isRetainer || hasProductRetainer) priority += 100;
                    if (status === 'ghost') priority += 60;
                    else if (status === 'behind') priority += 40;
                    else if (status === 'atrisk') priority += 20;
                    if (isTrendingDown) priority += 15;
                    if (isBurstPosting || isUnevenPosting) priority += 25; // Flag suspicious patterns
                    priority += effectiveRetainer / 50;
                    
                    return {
                        id: c.id,
                        name: c.real_name || c.discord_name || c.account_1,
                        handle: c.account_1,
                        accounts: accounts,
                        brand: c.brand,
                        isRetainer: isRetainer || hasProductRetainer,
                        retainer: totalRetainer,
                        effectiveRetainer: effectiveRetainer,
                        gmv: totalGmv,
                        effectiveGmv: effectiveGmv,
                        productGmv: productGmv,
                        productVideos: productVideos,
                        hasProductActivity: selectedProduct !== 'all' && (productGmv > 0 || productVideos > 0),
                        hasProductRetainer: hasProductRetainer,
                        roi: roi,
                        posts7d: posts7d,
                        postsPrev7d: postsPrev7d,
                        dailyPosts: dailyPosts,
                        maxDailyPosts: maxDailyPosts,
                        burstDate: burstDate,
                        daysWithPosts: daysWithPosts,
                        isBurstPosting: isBurstPosting,
                        isUnevenPosting: isUnevenPosting,
                        status: status,
                        isTrendingDown: isTrendingDown,
                        lastContact: lastContact,
                        lastPostDate: lastPostDate,
                        daysSincePost: daysSincePost,
                        discordChannelId: c.discord_channel_id,
                        productRetainers: c.product_retainers || {},
                        priority: priority
                    };
                });
                
                // Store filter state for card rendering
                window.postingProductFilter = selectedProduct !== 'all';
                window.postingSelectedProduct = selectedProduct;
                
                // Sort by priority (highest first)
                postingData.sort((a, b) => b.priority - a.priority);
                
                filterPostingData();
                window.postingDataLoaded = true;
                
            } catch (err) {
                console.error('Error loading posting data:', err);
                const sections = ['Ghosts', 'Behind', 'Atrisk', 'Ontrack', 'Stars'];
                sections.forEach(section => {
                    const el = document.getElementById(`posting${section}Grid`);
                    if (el) el.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--danger);">Error: ${err.message}</div>`;
                });
            }
        }
        
        function renderPostingEmpty() {
            const sections = ['Ghosts', 'Behind', 'Atrisk', 'Ontrack', 'Stars'];
            sections.forEach(section => {
                const el = document.getElementById(`posting${section}Grid`);
                if (el) el.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">No creators found</div>';
            });
            updatePostingStats();
        }
        
        function filterPostingData() {
            const creatorType = document.getElementById('postingTypeFilter')?.value || 'all';
            const search = document.getElementById('postingSearchFilter')?.value?.toLowerCase() || '';
            const hideContacted = document.getElementById('postingHideContacted')?.checked || false;
            
            postingFiltered = postingData.filter(c => {
                if (creatorType === 'retainer' && !c.isRetainer) return false;
                if (creatorType === 'affiliate' && c.isRetainer) return false;
                if (creatorType === 'pcfiber') {
                    // PC Fiber = Physicians Choice with pc_fiber product retainer
                    const isPCFiber = c.brand === 'physicians_choice' && c.productRetainers && c.productRetainers['pc_fiber'] > 0;
                    if (!isPCFiber) return false;
                }
                if (search && !c.name.toLowerCase().includes(search) && !c.handle?.toLowerCase().includes(search)) return false;
                
                // Hide recently contacted (within last 2 days)
                if (hideContacted && c.lastContact) {
                    const contactDate = new Date(c.lastContact);
                    const daysSinceContact = Math.floor((new Date() - contactDate) / (1000 * 60 * 60 * 24));
                    if (daysSinceContact <= 1) return false;
                }
                
                return true;
            });
            
            // Categorize into sections
            postingCategories = {
                ghosts: postingFiltered.filter(c => c.status === 'ghost').sort((a, b) => b.priority - a.priority),
                behind: postingFiltered.filter(c => c.status === 'behind').sort((a, b) => b.priority - a.priority),
                atrisk: postingFiltered.filter(c => c.status === 'atrisk').sort((a, b) => b.priority - a.priority),
                ontrack: postingFiltered.filter(c => c.status === 'ontrack').sort((a, b) => b.posts7d - a.posts7d),
                stars: postingFiltered.filter(c => c.status === 'stars').sort((a, b) => b.posts7d - a.posts7d)
            };
            
            updatePostingStats();
            renderPostingCards();
        }
        
        function updatePostingStats() {
            const ghosts = postingCategories.ghosts?.length || 0;
            const behind = postingCategories.behind?.length || 0;
            const atrisk = postingCategories.atrisk?.length || 0;
            const ontrack = postingCategories.ontrack?.length || 0;
            const stars = postingCategories.stars?.length || 0;
            
            // Calculate retainer at risk (retainer $ for underperforming creators)
            const underperformers = [...(postingCategories.ghosts || []), ...(postingCategories.behind || []), ...(postingCategories.atrisk || [])];
            const atRiskCreators = underperformers.filter(c => c.isRetainer);
            const retainerAtRisk = atRiskCreators.reduce((sum, c) => sum + c.retainer, 0);
            
            // Update stat cards
            document.getElementById('postingGhostsCount').textContent = ghosts;
            document.getElementById('postingBehindCount').textContent = behind;
            document.getElementById('postingAtRiskCount').textContent = atrisk;
            document.getElementById('postingOnTrackCount').textContent = ontrack;
            document.getElementById('postingStarsCount').textContent = stars;
            document.getElementById('postingRetainerAtRisk').textContent = fmtMoney(retainerAtRisk);
            document.getElementById('postingAtRiskRetainerCount').textContent = `${atRiskCreators.length} creator${atRiskCreators.length !== 1 ? 's' : ''}`;
            
            // Update section badges
            document.getElementById('postingGhostsBadge').textContent = ghosts;
            document.getElementById('postingBehindBadge').textContent = behind;
            document.getElementById('postingAtriskBadge').textContent = atrisk;
            document.getElementById('postingOntrackBadge').textContent = ontrack;
            document.getElementById('postingStarsBadge').textContent = stars;
            
            // Update morning briefing if visible
            const briefingGhosts = document.getElementById('briefingGhosts');
            const briefingBehind = document.getElementById('briefingBehind');
            if (briefingGhosts) briefingGhosts.textContent = ghosts;
            if (briefingBehind) briefingBehind.textContent = behind;
        }
        
        function renderPostingCards() {
            // Render each section with appropriate styling
            renderPostingSection('Ghosts', postingCategories.ghosts || [], '#6b7280', '');
            renderPostingSection('Behind', postingCategories.behind || [], '#ef4444', '');
            renderPostingSection('Atrisk', postingCategories.atrisk || [], '#f59e0b', '');
            renderPostingSection('Ontrack', postingCategories.ontrack || [], '#22c55e', '');
            renderPostingSection('Stars', postingCategories.stars || [], '#8b5cf6', '');
        }
        
        function renderPostingSection(sectionName, creators, accentColor, emoji) {
            const container = document.getElementById(`posting${sectionName}Grid`);
            if (!container) return;
            
            if (creators.length === 0) {
                const emptyMessages = {
                    'Ghosts': ' No ghost creators - everyone is posting!',
                    'Behind': ' No one behind on posting!',
                    'Atrisk': ' No at-risk creators!',
                    'Ontrack': 'No on-track creators found',
                    'Stars': 'No star performers yet'
                };
                container.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 30px; color: var(--text-muted);">${emptyMessages[sectionName] || 'No creators'}</div>`;
                return;
            }
            
            container.innerHTML = creators.map(c => renderPostingCard(c, accentColor, sectionName)).join('');
        }
        
        function renderPostingCard(c, accentColor, sectionName) {
            // Check if PC Fiber creator (has product retainer for pc_fiber)
            const isPCFiber = c.brand === 'physicians_choice' && c.productRetainers && c.productRetainers['pc_fiber'] > 0;
            const fiberBadge = isPCFiber ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;">FIBER</span>' : '';
            
            // Product assignment pills (show what products they're assigned to)
            const productPills = getProductAssignmentPills(c.productRetainers ? { product_retainers: c.productRetainers } : c, 2);
            
            // Last post display
            let lastPostDisplay = '<span style="color: var(--danger);">Never</span>';
            if (c.daysSincePost !== null) {
                if (c.daysSincePost === 0) lastPostDisplay = '<span style="color: var(--success);">Today</span>';
                else if (c.daysSincePost === 1) lastPostDisplay = '<span style="color: var(--success);">Yesterday</span>';
                else if (c.daysSincePost <= 3) lastPostDisplay = `<span style="color: var(--success);">${c.daysSincePost}d ago</span>`;
                else if (c.daysSincePost <= 7) lastPostDisplay = `<span style="color: var(--warning);">${c.daysSincePost}d ago</span>`;
                else lastPostDisplay = `<span style="color: var(--danger);">${c.daysSincePost}d ago</span>`;
            }
            
            // Last contact display
            let lastContactDisplay = '<span style="color: var(--text-muted);">Never</span>';
            if (c.lastContact) {
                const contactDate = new Date(c.lastContact);
                const daysSince = Math.floor((new Date() - contactDate) / (1000 * 60 * 60 * 24));
                if (daysSince === 0) lastContactDisplay = '<span style="color: var(--success);">Today</span>';
                else if (daysSince === 1) lastContactDisplay = '<span style="color: var(--success);">Yesterday</span>';
                else if (daysSince < 7) lastContactDisplay = `<span style="color: var(--success);">${daysSince}d ago</span>`;
                else lastContactDisplay = `<span style="color: var(--warning);">${daysSince}d ago</span>`;
            }
            
            // ROI display
            let roiDisplay = '--';
            let roiColor = 'var(--text-muted)';
            if (c.isRetainer && c.roi !== null) {
                roiDisplay = c.roi.toFixed(1) + 'x';
                roiColor = c.roi >= 2 ? 'var(--success)' : c.roi >= 1 ? 'var(--warning)' : 'var(--danger)';
            }
            
            // Discord button
            const discordBtn = c.discordChannelId 
                ? `<button onclick="openDiscordChannel('${c.brand}', '${c.discordChannelId}')" class="btn btn-sm" style="background: #5865F2; color: white; padding: 5px 10px; font-size: 0.7rem;"></button>`
                : '';
            
            // Posts display color (based on count: 0=gray, 1-3=red, 4-5=orange, 6-9=green, 10+=purple)
            const posts = c.posts7d || 0;
            const postsColor = posts >= 10 ? '#8b5cf6' : posts >= 6 ? '#22c55e' : posts >= 4 ? '#f59e0b' : posts > 0 ? '#ef4444' : '#6b7280';
            
            // Recently contacted indicator (green checkmark if contacted in last 2 days)
            let recentlyContacted = false;
            let contactedBadge = '';
            if (c.lastContact) {
                const contactDate = new Date(c.lastContact);
                const daysSinceContact = Math.floor((new Date() - contactDate) / (1000 * 60 * 60 * 24));
                if (daysSinceContact <= 1) {
                    recentlyContacted = true;
                    contactedBadge = '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;"> Contacted</span>';
                }
            }
            
            // Burst/uneven posting warning badge
            let warningBadge = '';
            if (c.isBurstPosting) {
                warningBadge = `<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;" title="${c.maxDailyPosts} videos on ${c.burstDate}"> BURST</span>`;
            } else if (c.isUnevenPosting) {
                warningBadge = `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;" title="${posts} videos in only ${c.daysWithPosts} days"> UNEVEN</span>`;
            }
            
            // Trending down badge
            let trendingBadge = '';
            if (c.isTrendingDown) {
                trendingBadge = `<span style="background: #ec4899; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;" title="${c.postsPrev7d}${c.posts7d} posts vs last week"> ${c.postsPrev7d}${c.posts7d}</span>`;
            }
            
            // Product activity badge (when product filter is active)
            let productBadge = '';
            if (window.postingProductFilter) {
                if (c.hasProductActivity) {
                    productBadge = `<span style="background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;" title="${c.productVideos} videos, ${fmtMoney(c.productGmv)} GMV"> ${c.productVideos} vid${c.productVideos !== 1 ? 's' : ''}</span>`;
                } else {
                    productBadge = `<span style="background: #6b7280; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;">No product sales</span>`;
                }
            }
            
            // Build daily breakdown display (mini bar chart)
            const dailyBreakdownId = `daily-${c.id}`;
            let dailyBars = '';
            if (c.dailyPosts && Object.keys(c.dailyPosts).length > 0) {
                // Get last 7 days in order
                const dates = [];
                for (let i = 7; i >= 1; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    dates.push(d.toISOString().split('T')[0]);
                }
                
                const maxVal = Math.max(...Object.values(c.dailyPosts), 1);
                dailyBars = dates.map(date => {
                    const count = c.dailyPosts[date] || 0;
                    const height = count > 0 ? Math.max(4, (count / maxVal) * 24) : 2;
                    const dayName = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short' }).charAt(0);
                    const barColor = count >= 5 ? '#ef4444' : count > 0 ? '#22c55e' : '#374151';
                    return `<div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <div style="width: 12px; height: ${height}px; background: ${barColor}; border-radius: 2px;" title="${date}: ${count} videos"></div>
                        <span style="font-size: 0.5rem; color: var(--text-muted);">${dayName}</span>
                    </div>`;
                }).join('');
            }
            
            return `
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; border: 1px solid var(--border); border-left: 4px solid ${accentColor}; ${recentlyContacted ? 'opacity: 0.6;' : ''} transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.opacity='1';" onmouseout="this.style.transform=''; this.style.boxShadow=''; ${recentlyContacted ? "this.style.opacity='0.6';" : ''}">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                    <!-- Left: Creator Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap;">
                            <span style="font-weight: 700; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${sanitize(c.name)}</span>
                            ${c.isRetainer ? `<span style="background: ${c.hasProductRetainer ? '#8b5cf6' : 'var(--accent)'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 600;" title="${c.hasProductRetainer ? 'Product retainer' : 'Base retainer'}">${fmtMoney(c.effectiveRetainer || c.retainer)}${c.hasProductRetainer ? ' ' : ''}</span>` : ''}
                            ${fiberBadge}
                            ${productPills ? `<span style="display: inline-flex; gap: 4px; align-items: center;">${productPills}</span>` : ''}
                            ${productBadge}
                            ${warningBadge}
                            ${trendingBadge}
                            ${contactedBadge}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">
                            <a href="https://www.tiktok.com/@${c.handle}" target="_blank" style="color: var(--blue); text-decoration: none;">@${c.handle}</a>
                            <span></span>
                            <span class="badge-brand" style="font-size: 0.65rem;">${BRAND_DISPLAY[c.brand] || c.brand}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; font-size: 0.7rem; margin-top: 6px;">
                            <div><span style="color: var(--text-muted);">Last Post:</span> ${lastPostDisplay}</div>
                            <div><span style="color: var(--text-muted);">Contact:</span> ${lastContactDisplay}</div>
                            <div><span style="color: var(--text-muted);">${window.postingProductFilter ? 'Product GMV:' : 'GMV:'}</span> <span style="color: var(--success);">${fmtMoney(window.postingProductFilter ? c.productGmv : c.gmv)}</span>${window.postingProductFilter && c.gmv > 0 ? ` <span style="color: var(--text-muted); font-size: 0.6rem;">(${fmtMoney(c.gmv)} total)</span>` : ''}</div>
                            <div><span style="color: var(--text-muted);">ROI:</span> <span style="color: ${roiColor};">${roiDisplay}</span></div>
                        </div>
                    </div>
                    
                    <!-- Right: Posts + Daily Breakdown + Actions -->
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 6px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.6rem; font-weight: 800; color: ${postsColor}; line-height: 1;">${posts}</div>
                            <div style="font-size: 0.55rem; color: var(--text-muted);">posts (${c.daysWithPosts || 0} days)</div>
                        </div>
                        ${dailyBars ? `<div style="display: flex; gap: 3px; align-items: flex-end; height: 32px;">${dailyBars}</div>` : ''}
                        <div style="display: flex; gap: 4px;">
                            ${discordBtn}
                            <button onclick="markContacted('${c.handle?.toLowerCase()}|${c.brand}')" class="btn btn-sm" style="padding: 5px 10px; font-size: 0.7rem;" title="Log Contact"></button>
                            <button onclick="editCreator(${c.id})" class="btn btn-sm" style="padding: 5px 10px; font-size: 0.7rem;" title="Edit"></button>
                            <button onclick="removeFromRoster(${c.id}, '${sanitize(c.name)}')" class="btn btn-sm" style="padding: 5px 10px; font-size: 0.7rem; background: var(--danger); color: white;" title="Remove from Roster"></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        // Open Discord channel directly
        function openDiscordChannel(brand, channelId) {
            const serverId = DISCORD_SERVERS[brand];
            if (!serverId) {
                showToast('Discord server not configured for this brand', 'warning');
                return;
            }
            window.open(`https://discord.com/channels/${serverId}/${channelId}`, '_blank');
        }
        
        // Remove creator from managed roster
        async function removeFromRoster(creatorId, creatorName) {
            if (!confirm(`Remove "${creatorName}" from the managed roster?\n\nThis will set their status to Inactive. They can be re-added later if needed.`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('managed_creators')
                    .update({ status: 'Inactive' })
                    .eq('id', creatorId);
                
                if (error) throw error;
                
                showToast(`${creatorName} removed from roster`, 'success');
                
                // Remove from local data and re-render
                postingData = postingData.filter(c => c.id !== creatorId);
                filterPostingData();
                
                // Invalidate cache so Users tab refreshes
                cache.invalidate('managed_creators');
                
            } catch (err) {
                console.error('Error removing creator:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        function markContacted(creatorKey) {
            // Open the contact log modal instead of just marking contacted
            openContactLogModal(creatorKey);
        }
        
        function openContactLogModal(creatorKey) {
            // Parse the key
            const parts = creatorKey.split('|');
            const searchHandle = parts[0]?.toLowerCase();
            const searchBrand = parts[1];
            
            // Find creator data - more robust matching
            const creator = postingData.find(c => {
                const handleMatch = (c.handle || '').toLowerCase() === searchHandle;
                const brandMatch = c.brand === searchBrand;
                return handleMatch && brandMatch;
            });
            
            if (!creator) {
                console.error('Creator not found. Key:', creatorKey, 'postingData length:', postingData.length);
                // Try to find by ID from managedCreators as fallback
                const managed = managedCreators.find(m => 
                    (m.account_1 || '').toLowerCase() === searchHandle && m.brand === searchBrand
                );
                if (managed) {
                    // Build a minimal creator object from managed data
                    openContactLogModalDirect(managed, creatorKey);
                    return;
                }
                showToast('Creator not found. Try refreshing the page.', 'error');
                return;
            }
            
            openContactLogModalWithCreator(creator, creatorKey);
        }
        
        function openContactLogModalDirect(managed, creatorKey) {
            // Build creator object from managed_creators data
            const creator = {
                id: managed.id,
                name: managed.real_name || managed.discord_name || managed.account_1,
                handle: managed.account_1,
                brand: managed.brand,
                discordChannelId: managed.discord_channel_id
            };
            openContactLogModalWithCreator(creator, creatorKey);
        }
        
        function openContactLogModalWithCreator(creator, creatorKey) {
            
            // Get managed creator info for Discord channel
            const managedInfo = getManagedInfo(creator.handle);
            const channelId = creator.discordChannelId || managedInfo?.discord_channel_id || '';
            
            // Populate modal
            document.getElementById('contactCreatorId').value = creator.id || '';
            document.getElementById('contactCreatorKey').value = creatorKey;
            document.getElementById('contactCreatorBrandKey').value = creator.brand;
            document.getElementById('contactCreatorChannelId').value = channelId;
            document.getElementById('contactCreatorName').textContent = creator.name + ' (@' + (creator.handle || 'unknown') + ')';
            document.getElementById('contactCreatorBrand').textContent = BRAND_DISPLAY[creator.brand] || creator.brand;
            
            // Show/hide Discord button based on channel availability
            const discordBtn = document.getElementById('contactDiscordBtn');
            if (channelId) {
                discordBtn.style.display = 'flex';
                discordBtn.title = 'Open Discord channel';
            } else {
                discordBtn.style.display = 'none';
            }
            
            // Reset form
            document.getElementById('contactMethod').value = 'Discord';
            document.getElementById('contactType').value = 'Check-in';
            document.getElementById('contactOutcome').value = '';
            document.getElementById('contactNotes').value = '';
            document.getElementById('contactFollowup').value = '';
            document.getElementById('messagePreview').style.display = 'none';
            
            // Load contact history
            loadContactHistory(creator.id, creator.brand, creator.handle);
            
            document.getElementById('contactLogModal').classList.add('show');
        }
        
        // Open Discord from contact modal
        function openDiscordFromModal() {
            const brand = document.getElementById('contactCreatorBrandKey').value;
            const channelId = document.getElementById('contactCreatorChannelId').value;
            
            if (!channelId) {
                showToast('No Discord channel linked. Edit creator profile to add it.', 'warning');
                return;
            }
            
            const serverId = DISCORD_SERVERS[brand];
            if (!serverId) {
                showToast('Discord server not configured for this brand', 'warning');
                return;
            }
            
            // Open Discord - will work on desktop, mobile, and browser
            const url = `https://discord.com/channels/${serverId}/${channelId}`;
            window.open(url, '_blank');
        }
        
        // Message templates
        const MESSAGE_TEMPLATES = {
            checkin: `Hey!  Just checking in - how's everything going? Let me know if you need any support or have questions about content!`,
            warning: `Hey! I noticed your posting has dropped off recently. Everything okay? Just wanted to check in and see if there's anything we can help with. 

We really want to see you succeed, but we do need to see more consistent content to keep the partnership going. Let me know what's going on! `,
            final: `Hey, I need to have a serious conversation with you.

We haven't seen posts from you in a while, and unfortunately we're at the point where we need to see immediate improvement or we'll have to end the partnership.

Can you post TODAY and commit to getting back on track? Please reply ASAP. `,
            praise: `Hey!  Just wanted to say you've been CRUSHING it lately! Your content is doing great and we really appreciate your consistency.

Keep up the amazing work! Let me know if there's anything you need from us. `
        };
        
        function useMessageTemplate(type) {
            const creatorName = document.getElementById('contactCreatorName').textContent.split(' (@')[0];
            let message = MESSAGE_TEMPLATES[type] || '';
            
            // Show preview
            document.getElementById('messageText').textContent = message;
            document.getElementById('messagePreview').style.display = 'block';
            
            // Auto-select contact type
            const typeMap = {
                checkin: 'Check-in',
                warning: 'Warning',
                final: 'Final Notice',
                praise: 'Positive Feedback'
            };
            document.getElementById('contactType').value = typeMap[type] || 'Check-in';
        }
        
        function copyMessageToClipboard() {
            const message = document.getElementById('messageText').textContent;
            navigator.clipboard.writeText(message).then(() => {
                showToast('Message copied! Paste in Discord.', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        function closeContactLogModal() {
            document.getElementById('contactLogModal').classList.remove('show');
        }
        
        async function loadContactHistory(creatorId, brand, handle) {
            const listEl = document.getElementById('contactHistoryList');
            const countEl = document.getElementById('contactHistoryCount');
            
            listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';
            
            try {
                // Query by creator_id if available, otherwise by name/brand
                let query = supabaseClient.from('contact_log').select('*').order('contact_date', { ascending: false }).limit(10);
                
                if (creatorId) {
                    query = query.eq('creator_id', creatorId);
                } else {
                    query = query.eq('creator_name', handle).eq('brand', brand);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    // Table might not exist yet
                    console.log('Contact log table may not exist:', error.message);
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">No contact history (run migration to enable)</div>';
                    countEl.textContent = '0 records';
                    return;
                }
                
                if (!data || data.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">No previous contacts logged</div>';
                    countEl.textContent = '0 records';
                    return;
                }
                
                countEl.textContent = data.length + ' record' + (data.length !== 1 ? 's' : '');
                
                listEl.innerHTML = data.map(log => {
                    const date = new Date(log.contact_date);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    
                    const typeColors = {
                        'Check-in': 'var(--text-muted)',
                        'Warning': 'var(--warning)',
                        'Final Notice': 'var(--error)',
                        'Positive Feedback': 'var(--success)',
                        'Contract Discussion': 'var(--accent)'
                    };
                    const typeColor = typeColors[log.contact_type] || 'var(--text-muted)';
                    
                    const outcomeIcons = {
                        'No Response': '',
                        'Acknowledged': '',
                        'Committed to Improve': '',
                        'Excuse Given': '',
                        'Dispute': '',
                        'Positive': ''
                    };
                    const outcomeIcon = outcomeIcons[log.outcome] || '';
                    
                    return `
                        <div style="padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; font-size: 0.85rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-weight: 600; color: ${typeColor};">${log.contact_type}</span>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">${dateStr} ${timeStr}</span>
                            </div>
                            <div style="display: flex; gap: 12px; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">
                                <span> ${log.contact_method}</span>
                                ${log.outcome ? `<span>${outcomeIcon} ${log.outcome}</span>` : ''}
                            </div>
                            ${log.notes ? `<div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border);">${log.notes}</div>` : ''}
                            ${log.followup_date && !log.followup_completed ? `<div style="color: var(--warning); font-size: 0.75rem; margin-top: 6px;"> Follow-up: ${new Date(log.followup_date).toLocaleDateString()}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('Error loading contact history:', err);
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">Error loading history</div>';
            }
        }
        
        async function saveContactLog() {
            const creatorId = document.getElementById('contactCreatorId').value;
            const creatorKey = document.getElementById('contactCreatorKey').value;
            const method = document.getElementById('contactMethod').value;
            const type = document.getElementById('contactType').value;
            const outcome = document.getElementById('contactOutcome').value;
            const notes = document.getElementById('contactNotes').value.trim();
            const followup = document.getElementById('contactFollowup').value;
            
            // Parse the key and find creator
            const parts = creatorKey.split('|');
            const searchHandle = parts[0]?.toLowerCase();
            const searchBrand = parts[1];
            
            // Find creator for name/brand - match on handle and brand
            let creator = postingData.find(c => 
                (c.handle || '').toLowerCase() === searchHandle && c.brand === searchBrand
            );
            
            // Fallback to managedCreators if not found in postingData
            if (!creator) {
                const managed = managedCreators.find(m => 
                    (m.account_1 || '').toLowerCase() === searchHandle && m.brand === searchBrand
                );
                if (managed) {
                    creator = {
                        id: managed.id,
                        handle: managed.account_1,
                        name: managed.real_name || managed.discord_name || managed.account_1,
                        brand: managed.brand
                    };
                }
            }
            
            if (!creator) {
                showToast('Creator not found. Try refreshing the page.', 'error');
                return;
            }
            
            try {
                // Save to database
                const { error } = await supabaseClient.from('contact_log').insert({
                    creator_id: creatorId ? parseInt(creatorId) : null,
                    creator_name: creator.handle || creator.name,
                    brand: creator.brand,
                    contact_method: method,
                    contact_type: type,
                    outcome: outcome || null,
                    notes: notes || null,
                    followup_date: followup || null,
                    logged_by: adminName || 'Admin'
                });
                
                if (error) {
                    // If table doesn't exist, fall back to localStorage
                    console.log('Falling back to localStorage:', error.message);
                    const today = new Date().toISOString();
                    postingContactLog[creatorKey] = today;
                    saveContactLog_localStorage();
                    showToast('Contact logged (local only - run migration for full features)', 'warning');
                } else {
                    showToast('Contact logged successfully! ', 'success');
                }
                
                // Also update localStorage for quick "last contact" display
                postingContactLog[creatorKey] = new Date().toISOString().split('T')[0];
                saveContactLog_localStorage();
                
                // Update the posting data
                postingData = postingData.map(c => {
                    const cKey = `${(c.handle || '').toLowerCase()}|${c.brand}`;
                    if (cKey === creatorKey) {
                        c.lastContact = new Date().toISOString().split('T')[0];
                        c.needsContact = false;
                    }
                    return c;
                });
                
                closeContactLogModal();
                filterPostingData();
                
            } catch (err) {
                console.error('Error saving contact:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        // Rename localStorage functions to avoid conflict
        function saveContactLog_localStorage() {
            try {
                localStorage.setItem('creatorContactLog', JSON.stringify(postingContactLog));
            } catch (e) {
                console.error('Error saving contact log:', e);
            }
        }
        
        // ==================== END POSTING ACCOUNTABILITY ====================
        
        // ==================== PRODUCTS MANAGER ====================
        let productsData = [];
        
        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);"><div class="spinner" style="margin: 0 auto 12px;"></div>Loading products...</td></tr>';
            
            try {
                const brandFilter = document.getElementById('productsFilterBrand')?.value || '';
                
                let query = supabaseClient.from('products').select('*').order('brand').order('display_name');
                
                if (brandFilter) {
                    query = query.eq('brand', brandFilter);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                productsData = data || [];
                
                if (productsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No products defined yet. Click "Add Product Group" to create one.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = productsData.map(p => {
                    const productIdCount = (p.product_ids || []).length;
                    const statusBadge = p.status === 'active' 
                        ? '<span style="background: var(--success-dim); color: var(--success); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">Active</span>'
                        : '<span style="background: var(--error-dim); color: var(--error); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">Inactive</span>';
                    
                    return `
                        <tr>
                            <td><code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${p.product_key}</code></td>
                            <td style="font-weight: 600;">${p.display_name}</td>
                            <td><span class="badge-brand">${BRAND_DISPLAY[p.brand] || p.brand}</span></td>
                            <td style="text-align: center;">${productIdCount} ID${productIdCount !== 1 ? 's' : ''}</td>
                            <td style="text-align: center;">${statusBadge}</td>
                            <td style="text-align: center;">
                                <button class="btn btn-sm" onclick="editProduct('${p.id}')" style="padding: 4px 8px; font-size: 0.7rem;"></button>
                                <button class="btn btn-sm" onclick="deleteProduct('${p.id}')" style="padding: 4px 8px; font-size: 0.7rem; color: var(--error);"></button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('Error loading products:', err);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--error);">Error: ${err.message}</td></tr>`;
            }
        }
        
        // ==================== SETTINGS PRODUCTS FROM DATA ====================
        let settingsProductsData = [];
        let settingsProductsSortField = 'gmv';
        let settingsProductsSortAsc = false;
        
        async function loadSettingsProducts() {
            const tbody = document.getElementById('settingsProductsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);"><div class="spinner" style="margin: 0 auto 12px;"></div>Loading products from data...</td></tr>';
            
            try {
                // Get last 30 days
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                const startDate = localDateStr(thirtyDaysAgo);
                const endDate = localDateStr(today);
                
                // Query video_performance for product stats
                const { data, error } = await supabaseClient
                    .from('video_performance')
                    .select('product_name, brand, gmv, orders, video_id')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .not('product_name', 'is', null);
                
                if (error) throw error;
                
                // Aggregate by product_name + brand
                const productMap = {};
                (data || []).forEach(row => {
                    if (!row.product_name || !row.product_name.trim()) return;
                    const key = `${row.product_name}|${row.brand}`;
                    if (!productMap[key]) {
                        productMap[key] = {
                            name: row.product_name,
                            brand: row.brand,
                            gmv: 0,
                            orders: 0,
                            videoIds: new Set()
                        };
                    }
                    productMap[key].gmv += row.gmv || 0;
                    productMap[key].orders += row.orders || 0;
                    if (row.video_id) productMap[key].videoIds.add(row.video_id);
                });
                
                // Convert to array
                settingsProductsData = Object.values(productMap).map(p => ({
                    ...p,
                    videos: p.videoIds.size,
                    avgPerVideo: p.videoIds.size > 0 ? p.gmv / p.videoIds.size : 0
                }));
                
                // Update stats
                const totalProducts = settingsProductsData.length;
                const totalGmv = settingsProductsData.reduce((sum, p) => sum + p.gmv, 0);
                const totalVideos = settingsProductsData.reduce((sum, p) => sum + p.videos, 0);
                const topProduct = settingsProductsData.sort((a, b) => b.gmv - a.gmv)[0];
                
                document.getElementById('settingsProductCount').textContent = totalProducts;
                document.getElementById('settingsProductGmv').textContent = '$' + totalGmv.toLocaleString(undefined, {maximumFractionDigits: 0});
                document.getElementById('settingsProductVideos').textContent = totalVideos.toLocaleString();
                
                const topProductEl = document.getElementById('settingsTopProduct');
                if (topProduct) {
                    const shortName = topProduct.name.length > 18 ? topProduct.name.substring(0, 18) + '...' : topProduct.name;
                    topProductEl.textContent = shortName;
                    topProductEl.title = topProduct.name;
                } else {
                    topProductEl.textContent = '-';
                    topProductEl.title = '';
                }
                
                // Default sort by GMV
                sortSettingsProducts('gmv');
                
            } catch (err) {
                console.error('Error loading settings products:', err);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--error);">Error: ${err.message}</td></tr>`;
            }
        }
        
        function sortSettingsProducts(field) {
            if (settingsProductsSortField === field) {
                settingsProductsSortAsc = !settingsProductsSortAsc;
            } else {
                settingsProductsSortField = field;
                settingsProductsSortAsc = field === 'name'; // Name ascending by default, others descending
            }
            filterSettingsProducts();
        }
        
        function filterSettingsProducts() {
            const brandFilter = document.getElementById('settingsProductBrandFilter')?.value || 'all';
            const searchFilter = (document.getElementById('settingsProductSearch')?.value || '').toLowerCase();
            
            let filtered = settingsProductsData;
            
            if (brandFilter !== 'all') {
                filtered = filtered.filter(p => p.brand === brandFilter);
            }
            
            if (searchFilter) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(searchFilter));
            }
            
            // Sort
            const sortMult = settingsProductsSortAsc ? 1 : -1;
            filtered.sort((a, b) => {
                if (settingsProductsSortField === 'name') {
                    return sortMult * a.name.localeCompare(b.name);
                } else if (settingsProductsSortField === 'gmv') {
                    return sortMult * (a.gmv - b.gmv);
                } else if (settingsProductsSortField === 'videos') {
                    return sortMult * (a.videos - b.videos);
                } else if (settingsProductsSortField === 'orders') {
                    return sortMult * (a.orders - b.orders);
                }
                return 0;
            });
            
            document.getElementById('settingsProductFilterCount').textContent = `${filtered.length} product${filtered.length !== 1 ? 's' : ''}`;
            
            renderSettingsProductsTable(filtered);
        }
        
        function renderSettingsProductsTable(products) {
            const tbody = document.getElementById('settingsProductsTableBody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 60px 40px; color: var(--text-muted);"><div style="font-size: 1.5rem; margin-bottom: 8px;"></div>No products found matching filters</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map((p, index) => {
                const brandColor = {
                    'physicians_choice': '#22c55e',
                    'jiyu': '#8b5cf6', 
                    'catakor': '#f59e0b',
                    'peach_slices': '#ec4899',
                    'yerba_magic': '#14b8a6'
                }[p.brand] || 'var(--text-muted)';
                
                const brandDisplay = BRAND_DISPLAY[p.brand] || p.brand;
                const isTopPerformer = index < 3 && settingsProductsSortField === 'gmv' && !settingsProductsSortAsc;
                
                return `
                    <tr style="transition: background 0.15s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 14px 16px; max-width: 280px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${isTopPerformer ? `<span style="font-size: 0.9rem;">${index === 0 ? '' : index === 1 ? '' : ''}</span>` : `<span style="width: 20px; height: 20px; background: ${brandColor}20; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;"></span>`}
                                <span style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${sanitize(p.name)}">${sanitize(p.name)}</span>
                            </div>
                        </td>
                        <td style="padding: 14px 12px;">
                            <span style="background: ${brandColor}15; color: ${brandColor}; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">
                                ${brandDisplay}
                            </span>
                        </td>
                        <td style="text-align: right; padding: 14px 16px; font-weight: 700; color: #22c55e; font-size: 0.95rem;">$${p.gmv.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td style="text-align: center; padding: 14px 12px; color: var(--text-secondary);">${p.videos.toLocaleString()}</td>
                        <td style="text-align: center; padding: 14px 12px; color: var(--text-secondary);">${p.orders.toLocaleString()}</td>
                        <td style="text-align: right; padding: 14px 16px; color: var(--text-muted); font-size: 0.85rem;">$${p.avgPerVideo.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function toggleProductGroupsSection() {
            // Legacy function - no longer used
        }
        
        // ==================== PRODUCT GROUPS ====================
        let groupProductsData = []; // Products available for grouping
        let selectedGroupProducts = new Set(); // Currently selected product names
        
        function openCreateGroupModal() {
            document.getElementById('productGroupModalTitle').textContent = ' Create Product Group';
            document.getElementById('productGroupId').value = '';
            document.getElementById('productGroupName').value = '';
            document.getElementById('productGroupBrand').value = '';
            document.getElementById('groupProductSearch').value = '';
            document.getElementById('groupProductsContainer').innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">Select a brand to see available products</div>';
            selectedGroupProducts.clear();
            updateGroupSelectedCount();
            document.getElementById('productGroupModal').classList.add('show');
        }
        
        function closeProductGroupModal() {
            document.getElementById('productGroupModal').classList.remove('show');
        }
        
        async function loadProductsForGrouping() {
            const brand = document.getElementById('productGroupBrand').value;
            const container = document.getElementById('groupProductsContainer');
            
            if (!brand) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">Select a brand to see available products</div>';
                return;
            }
            
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);"><div class="spinner" style="margin: 0 auto 12px;"></div>Loading products...</div>';
            
            try {
                // Get products from settingsProductsData (already loaded)
                groupProductsData = settingsProductsData.filter(p => p.brand === brand);
                
                if (groupProductsData.length === 0) {
                    // If not loaded yet, fetch from DB
                    const today = new Date();
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    
                    const { data, error } = await supabaseClient
                        .from('video_performance')
                        .select('product_name, gmv, orders, video_id')
                        .eq('brand', brand)
                        .gte('report_date', localDateStr(thirtyDaysAgo))
                        .not('product_name', 'is', null);
                    
                    if (error) throw error;
                    
                    // Aggregate
                    const productMap = {};
                    (data || []).forEach(row => {
                        if (!row.product_name) return;
                        if (!productMap[row.product_name]) {
                            productMap[row.product_name] = { name: row.product_name, brand, gmv: 0, orders: 0, videoIds: new Set() };
                        }
                        productMap[row.product_name].gmv += row.gmv || 0;
                        productMap[row.product_name].orders += row.orders || 0;
                        if (row.video_id) productMap[row.product_name].videoIds.add(row.video_id);
                    });
                    
                    groupProductsData = Object.values(productMap).map(p => ({
                        ...p,
                        videos: p.videoIds.size
                    })).sort((a, b) => b.gmv - a.gmv);
                }
                
                renderGroupProductsList();
                
            } catch (err) {
                console.error('Error loading products for grouping:', err);
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--error);">Error loading products</div>';
            }
        }
        
        function renderGroupProductsList() {
            const container = document.getElementById('groupProductsContainer');
            const searchTerm = (document.getElementById('groupProductSearch')?.value || '').toLowerCase();
            
            let filtered = groupProductsData;
            if (searchTerm) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No products found</div>';
                return;
            }
            
            container.innerHTML = filtered.map(p => {
                const isSelected = selectedGroupProducts.has(p.name);
                const escapedName = p.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                return `
                    <div onclick="toggleGroupProduct('${escapedName}')" 
                         style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; ${isSelected ? 'background: rgba(139, 92, 246, 0.15);' : ''}"
                         onmouseover="if(!${isSelected})this.style.background='var(--bg-card)'"
                         onmouseout="this.style.background='${isSelected ? 'rgba(139, 92, 246, 0.15)' : 'transparent'}'">
                        <div style="width: 24px; height: 24px; border: 2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'}; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: ${isSelected ? 'var(--accent)' : 'transparent'}; flex-shrink: 0;">
                            ${isSelected ? '<span style="color: white; font-size: 0.8rem;"></span>' : ''}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${sanitize(p.name)}">${sanitize(p.name)}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${p.videos || 0} videos  ${p.orders || 0} orders</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <div style="font-weight: 600; color: #22c55e;">$${(p.gmv || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleGroupProduct(productName) {
            if (selectedGroupProducts.has(productName)) {
                selectedGroupProducts.delete(productName);
            } else {
                selectedGroupProducts.add(productName);
            }
            renderGroupProductsList();
            updateGroupSelectedCount();
        }
        
        function selectAllGroupProducts() {
            const searchTerm = (document.getElementById('groupProductSearch')?.value || '').toLowerCase();
            let filtered = groupProductsData;
            if (searchTerm) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
            }
            filtered.forEach(p => selectedGroupProducts.add(p.name));
            renderGroupProductsList();
            updateGroupSelectedCount();
        }
        
        function deselectAllGroupProducts() {
            selectedGroupProducts.clear();
            renderGroupProductsList();
            updateGroupSelectedCount();
        }
        
        function filterGroupProducts() {
            renderGroupProductsList();
        }
        
        function updateGroupSelectedCount() {
            const count = selectedGroupProducts.size;
            const totalGmv = groupProductsData
                .filter(p => selectedGroupProducts.has(p.name))
                .reduce((sum, p) => sum + (p.gmv || 0), 0);
            
            document.getElementById('groupSelectedCount').textContent = `${count} product${count !== 1 ? 's' : ''} selected`;
            document.getElementById('groupSelectedGmv').textContent = `$${totalGmv.toLocaleString(undefined, {maximumFractionDigits: 0})} combined GMV`;
        }
        
        async function saveProductGroup() {
            const id = document.getElementById('productGroupId').value;
            const name = document.getElementById('productGroupName').value.trim();
            const brand = document.getElementById('productGroupBrand').value;
            
            if (!name || !brand) {
                showToast('Please enter a group name and select a brand', 'error');
                return;
            }
            
            if (selectedGroupProducts.size === 0) {
                showToast('Please select at least one product', 'error');
                return;
            }
            
            const productKey = name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
            const productNames = Array.from(selectedGroupProducts);
            
            try {
                const groupData = {
                    product_key: productKey,
                    display_name: name,
                    brand: brand,
                    product_names: productNames,
                    status: 'active'
                };
                
                let result;
                if (id) {
                    result = await supabaseClient.from('product_groups').update(groupData).eq('id', id);
                } else {
                    result = await supabaseClient.from('product_groups').insert(groupData);
                }
                
                if (result.error) throw result.error;
                
                showToast(`Product group "${name}" saved!`, 'success');
                closeProductGroupModal();
                loadProductGroups();
                
            } catch (err) {
                console.error('Error saving product group:', err);
                if (err.message && err.message.includes('product_groups')) {
                    showToast('Product groups table not set up yet. Creating now...', 'warning');
                } else {
                    showToast('Error: ' + err.message, 'error');
                }
            }
        }
        
        async function loadProductGroups() {
            const container = document.getElementById('productGroupsList');
            const noGroupsMsg = document.getElementById('noGroupsMessage');
            
            if (!container || !noGroupsMsg) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('product_groups')
                    .select('*')
                    .order('display_name');
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '';
                    noGroupsMsg.style.display = 'block';
                    return;
                }
                
                noGroupsMsg.style.display = 'none';
                
                container.innerHTML = data.map(g => {
                    const productCount = (g.product_names || []).length;
                    const brandColor = {
                        'physicians_choice': '#22c55e',
                        'jiyu': '#8b5cf6', 
                        'catakor': '#f59e0b',
                        'peach_slices': '#ec4899',
                        'yerba_magic': '#14b8a6'
                    }[g.brand] || 'var(--text-muted)';
                    
                    return `
                        <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                            <div style="width: 48px; height: 48px; background: ${brandColor}20; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 1rem;">${sanitize(g.display_name)}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${productCount} product${productCount !== 1 ? 's' : ''}  <span style="color: ${brandColor};">${BRAND_DISPLAY[g.brand] || g.brand}</span></div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm" onclick="editProductGroup('${g.id}')" style="padding: 6px 12px;"> Edit</button>
                                <button class="btn btn-sm" onclick="deleteProductGroup('${g.id}', '${sanitize(g.display_name).replace(/'/g, "\\'")}')" style="padding: 6px 12px; color: var(--error);"></button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (err) {
                console.log('Product groups not available:', err.message);
                container.innerHTML = '';
                noGroupsMsg.style.display = 'block';
            }
        }
        
        async function editProductGroup(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('product_groups')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('productGroupModalTitle').textContent = ' Edit Product Group';
                document.getElementById('productGroupId').value = data.id;
                document.getElementById('productGroupName').value = data.display_name;
                document.getElementById('productGroupBrand').value = data.brand;
                
                selectedGroupProducts = new Set(data.product_names || []);
                
                await loadProductsForGrouping();
                updateGroupSelectedCount();
                
                document.getElementById('productGroupModal').classList.add('show');
                
            } catch (err) {
                console.error('Error loading product group:', err);
                showToast('Error loading group', 'error');
            }
        }
        
        async function deleteProductGroup(id, name) {
            if (!confirm(`Delete product group "${name}"?`)) return;
            
            try {
                const { error } = await supabaseClient.from('product_groups').delete().eq('id', id);
                if (error) throw error;
                
                showToast('Product group deleted', 'success');
                loadProductGroups();
                
            } catch (err) {
                console.error('Error deleting product group:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        // ==================== END PRODUCTS MANAGER ====================
        
        // ==================== COMPENSATION SYSTEM ====================
        let brandProductsCache = {}; // Cache products by brand
        
        async function loadCompensation(brand, baseRetainer = 0, currentProductRetainers = {}) {
            const container = document.getElementById('productRetainersContainer');
            const totalRow = document.getElementById('compensationTotalRow');
            const baseInput = document.getElementById('creatorRetainer');
            const baseAffiliateBtn = document.getElementById('baseAffiliateBtn');
            
            if (!container) return;
            
            // Set base retainer
            if (baseInput) {
                baseInput.value = baseRetainer || '';
                if (baseRetainer === 0) {
                    baseAffiliateBtn.style.background = 'var(--blue)';
                    baseAffiliateBtn.style.color = 'white';
                    baseAffiliateBtn.style.borderColor = 'var(--blue)';
                    baseAffiliateBtn.textContent = ' Affiliate';
                    baseAffiliateBtn.dataset.active = 'true';
                    baseInput.disabled = true;
                    baseInput.style.opacity = '0.5';
                } else {
                    baseAffiliateBtn.style.background = '';
                    baseAffiliateBtn.style.color = '';
                    baseAffiliateBtn.style.borderColor = '';
                    baseAffiliateBtn.textContent = 'Affiliate';
                    baseAffiliateBtn.dataset.active = '';
                    baseInput.disabled = false;
                    baseInput.style.opacity = '1';
                }
            }
            
            // Load products for this brand
            try {
                if (!brandProductsCache[brand]) {
                    const { data, error } = await supabaseClient
                        .from('products')
                        .select('product_key, display_name')
                        .eq('brand', brand)
                        .eq('status', 'active')
                        .order('display_name');
                    
                    if (error) throw error;
                    brandProductsCache[brand] = data || [];
                }
                
                const products = brandProductsCache[brand];
                
                if (products.length === 0) {
                    container.innerHTML = '<div style="padding: 8px 12px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">No product campaigns defined for this brand</div>';
                } else {
                    container.innerHTML = products.map(p => {
                        const retainerValue = currentProductRetainers[p.product_key];
                        const isAssigned = retainerValue !== undefined && retainerValue !== null;
                        const isAffiliate = retainerValue === 0;
                        const hasRetainer = retainerValue > 0;
                        
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: ${isAssigned ? 'var(--bg-card)' : 'var(--bg-secondary)'}; border-radius: 8px; border: 1px solid ${isAssigned ? 'var(--accent)' : 'var(--border)'}; transition: all 0.2s;" data-product-row="${p.product_key}">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1;">
                                    <input type="checkbox" class="product-assignment-checkbox" value="${p.product_key}" ${isAssigned ? 'checked' : ''} onchange="toggleProductRow(this, '${p.product_key}')" style="width: 16px; height: 16px;">
                                    <div>
                                        <div style="font-size: 0.85rem; font-weight: 500;">${p.display_name}</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Product campaign</div>
                                    </div>
                                </label>
                                <div class="product-controls" style="display: ${isAssigned ? 'flex' : 'none'}; align-items: center; gap: 8px;">
                                    <button type="button" class="btn btn-sm product-affiliate-btn" data-product="${p.product_key}" onclick="toggleProductAffiliate('${p.product_key}')" style="padding: 4px 10px; font-size: 0.75rem; ${isAffiliate ? 'background: var(--blue); color: white; border-color: var(--blue);' : ''}">
                                        ${isAffiliate ? ' Affiliate' : 'Affiliate'}
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <span style="color: var(--text-muted); font-size: 0.85rem;">$</span>
                                        <input type="number" class="product-retainer-input" data-product="${p.product_key}" value="${hasRetainer ? retainerValue : ''}" placeholder="0" style="width: 80px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-card); color: var(--text-primary); font-size: 0.85rem; text-align: right; ${isAffiliate ? 'opacity: 0.5;' : ''}" ${isAffiliate ? 'disabled' : ''} onchange="updateCompensationTotal()">
                                        <span style="color: var(--text-muted); font-size: 0.75rem;">/mo</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                updateCompensationTotal();
                
            } catch (err) {
                console.error('Error loading compensation:', err);
                container.innerHTML = '<div style="padding: 8px 12px; color: var(--danger); font-size: 0.85rem;">Error loading products</div>';
            }
        }
        
        function toggleBaseAffiliate() {
            const btn = document.getElementById('baseAffiliateBtn');
            const input = document.getElementById('creatorRetainer');
            const isActive = btn.dataset.active === 'true';
            
            if (isActive) {
                btn.dataset.active = '';
                btn.style.background = '';
                btn.style.color = '';
                btn.style.borderColor = '';
                btn.textContent = 'Affiliate';
                input.disabled = false;
                input.style.opacity = '1';
            } else {
                btn.dataset.active = 'true';
                btn.style.background = 'var(--blue)';
                btn.style.color = 'white';
                btn.style.borderColor = 'var(--blue)';
                btn.textContent = ' Affiliate';
                input.disabled = true;
                input.style.opacity = '0.5';
                input.value = '0';
            }
            updateCompensationTotal();
        }
        
        function toggleProductRow(checkbox, productKey) {
            const row = document.querySelector(`[data-product-row="${productKey}"]`);
            const controls = row.querySelector('.product-controls');
            const input = row.querySelector('.product-retainer-input');
            const affiliateBtn = row.querySelector('.product-affiliate-btn');
            
            if (checkbox.checked) {
                row.style.background = 'var(--bg-card)';
                row.style.borderColor = 'var(--accent)';
                controls.style.display = 'flex';
            } else {
                row.style.background = 'var(--bg-secondary)';
                row.style.borderColor = 'var(--border)';
                controls.style.display = 'none';
                input.value = '';
                affiliateBtn.dataset.active = '';
                affiliateBtn.style.background = '';
                affiliateBtn.style.color = '';
                affiliateBtn.style.borderColor = '';
                affiliateBtn.textContent = 'Affiliate';
                input.disabled = false;
                input.style.opacity = '1';
            }
            updateCompensationTotal();
        }
        
        function toggleProductAffiliate(productKey) {
            const row = document.querySelector(`[data-product-row="${productKey}"]`);
            const btn = row.querySelector('.product-affiliate-btn');
            const input = row.querySelector('.product-retainer-input');
            const isActive = btn.dataset.active === 'true';
            
            if (isActive) {
                btn.dataset.active = '';
                btn.style.background = '';
                btn.style.color = '';
                btn.style.borderColor = '';
                btn.textContent = 'Affiliate';
                input.disabled = false;
                input.style.opacity = '1';
            } else {
                btn.dataset.active = 'true';
                btn.style.background = 'var(--blue)';
                btn.style.color = 'white';
                btn.style.borderColor = 'var(--blue)';
                btn.textContent = ' Affiliate';
                input.disabled = true;
                input.style.opacity = '0.5';
                input.value = '';
            }
            updateCompensationTotal();
        }
        
        function updateCompensationTotal() {
            const baseInput = document.getElementById('creatorRetainer');
            const totalRow = document.getElementById('compensationTotalRow');
            const totalEl = document.getElementById('compensationTotal');
            
            let total = parseFloat(baseInput?.value) || 0;
            let hasProducts = false;
            
            document.querySelectorAll('.product-assignment-checkbox:checked').forEach(cb => {
                hasProducts = true;
                const row = document.querySelector(`[data-product-row="${cb.value}"]`);
                const input = row?.querySelector('.product-retainer-input');
                const value = parseFloat(input?.value) || 0;
                total += value;
            });
            
            // Show total row only if there's more than one retainer source
            const baseVal = parseFloat(baseInput?.value) || 0;
            const showTotal = (baseVal > 0 && hasProducts) || document.querySelectorAll('.product-retainer-input').length > 1;
            
            if (totalRow) {
                totalRow.style.display = (total > 0 && hasProducts) ? 'block' : 'none';
            }
            if (totalEl) {
                totalEl.textContent = fmtMoney(total) + '/mo';
            }
        }
        
        function getSelectedProductAssignments() {
            const checkboxes = document.querySelectorAll('.product-assignment-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function getProductRetainers() {
            const retainers = {};
            document.querySelectorAll('.product-assignment-checkbox:checked').forEach(cb => {
                const productKey = cb.value;
                const row = document.querySelector(`[data-product-row="${productKey}"]`);
                const affiliateBtn = row?.querySelector('.product-affiliate-btn');
                const input = row?.querySelector('.product-retainer-input');
                const isAffiliate = affiliateBtn?.dataset.active === 'true';
                const value = parseFloat(input?.value);
                
                if (isAffiliate) {
                    retainers[productKey] = 0;
                } else if (value > 0) {
                    retainers[productKey] = value;
                } else {
                    retainers[productKey] = null; // Assigned but not set
                }
            });
            return retainers;
        }
        
        // Update when brand changes in modal
        function onCreatorBrandChange() {
            const brand = document.getElementById('creatorBrand').value;
            const baseRetainer = parseFloat(document.getElementById('creatorRetainer')?.value) || 0;
            // When brand changes, reset product retainers but keep base retainer
            loadCompensation(brand, baseRetainer, {});
        }
        
        // ==================== END COMPENSATION SYSTEM ====================
        
        // ==================== PRODUCT-LEVEL GMV ====================
        // Cache for product definitions
        let productsDataCache = null;
        
        async function loadProductsCache() {
            if (productsDataCache) return productsDataCache;
            
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .eq('status', 'active');
            
            if (error) {
                console.error('Error loading products:', error);
                return [];
            }
            
            productsDataCache = data || [];
            return productsDataCache;
        }
        
        // Get product GMV for creators from video_performance table
        // Returns: { 'creator_name|brand': gmv }
        async function getProductGmv(productKey, startDate, endDate, brand) {
            const products = await loadProductsCache();
            const product = products.find(p => p.product_key === productKey);
            
            if (!product || !product.product_ids || product.product_ids.length === 0) {
                console.warn('Product not found or has no product IDs:', productKey);
                return {};
            }
            
            // Convert product_ids to strings for comparison (they might be stored as strings or numbers)
            const productIds = product.product_ids.map(id => String(id));
            
            // Fetch video_performance data for the date range and brand
            let query = supabaseClient
                .from('video_performance')
                .select('creator_name, brand, product_id, gmv')
                .gte('date', startDate)
                .lte('date', endDate);
            
            if (brand && brand !== 'all') {
                query = query.eq('brand', brand);
            }
            
            const { data, error } = await query;
            
            if (error) {
                console.error('Error fetching video_performance:', error);
                return {};
            }
            
            // Filter by product_ids and aggregate GMV by creator|brand
            const gmvMap = {};
            (data || []).forEach(row => {
                const rowProductId = String(row.product_id);
                if (productIds.includes(rowProductId)) {
                    const key = `${row.creator_name.toLowerCase()}|${row.brand}`;
                    if (!gmvMap[key]) gmvMap[key] = 0;
                    gmvMap[key] += pFloat(row.gmv);
                }
            });
            
            return gmvMap;
        }
        
        // Get creators filtered by product assignments
        function filterCreatorsByProduct(creators, productKey) {
            return creators.filter(c => {
                const productRetainers = c.product_retainers || {};
                // Creator is assigned if they have ANY entry for this product (including 0 or null)
                return productKey in productRetainers;
            });
        }
        
        // ==================== END PRODUCT-LEVEL GMV ====================
        
        // Weekly Detail Modal State
        let currentWeeklyDetailType = null;
        let weeklyDetailRawData = [];
        let weeklyDetailFilteredData = []; // Track current filtered data for export
        let weeklyDetailColumns = [];
        
        // Sort options per type
        const weeklyDetailSortOptions = {
            topPerformers: [
                { value: 'gmv-desc', label: 'GMV (High  Low)' },
                { value: 'gmv-asc', label: 'GMV (Low  High)' },
                { value: 'change-desc', label: 'Change % (Best)' },
                { value: 'change-asc', label: 'Change % (Worst)' },
                { value: 'retainer-desc', label: 'Retainer (High  Low)' },
                { value: 'name-asc', label: 'Name (A  Z)' }
            ],
            needsAttention: [
                { value: 'gmv-asc', label: 'GMV (Low  High)' },
                { value: 'gmv-desc', label: 'GMV (High  Low)' },
                { value: 'change-asc', label: 'Drop % (Worst)' },
                { value: 'retainer-desc', label: 'Retainer (High  Low)' },
                { value: 'name-asc', label: 'Name (A  Z)' }
            ],
            mostActive: [
                { value: 'count-desc', label: 'Videos (High  Low)' },
                { value: 'count-asc', label: 'Videos (Low  High)' },
                { value: 'gmv-desc', label: 'GMV (High  Low)' },
                { value: 'retainer-desc', label: 'Retainer (High  Low)' },
                { value: 'name-asc', label: 'Name (A  Z)' }
            ],
            belowTarget: [
                { value: 'count-asc', label: 'Videos (Low  High)' },
                { value: 'count-desc', label: 'Videos (High  Low)' },
                { value: 'priority-desc', label: 'Priority (Critical First)' },
                { value: 'retainer-desc', label: 'Retainer (High  Low)' },
                { value: 'name-asc', label: 'Name (A  Z)' }
            ]
        };
        
        function showWeeklyDetail(type) {
            console.log('showWeeklyDetail called with type:', type);
            currentWeeklyDetailType = type;
            const modal = document.getElementById('weeklyDetailModal');
            if (!modal) {
                console.error('Weekly detail modal not found');
                return;
            }
            
            const title = document.getElementById('weeklyDetailTitle');
            const summary = document.getElementById('weeklyDetailSummary');
            
            const d = weeklyReviewData;
            let titleText = '';
            let titleColor = '';
            let summaryHtml = '';
            
            try {
                // Get raw data and set up columns based on type
                switch (type) {
                    case 'topPerformers':
                        titleText = ' Top Performers - Detailed View';
                        titleColor = 'var(--success)';
                        weeklyDetailRawData = (d.topPerformers || []).map(c => ({...c}));
                        weeklyDetailColumns = ['Creator', 'Brand', 'GMV', 'vs Prior', 'Orders', 'Retainer', 'ROI'];
                        const topTotalGmv = weeklyDetailRawData.reduce((s, c) => s + (c.gmv || 0), 0);
                        const topAvgGmv = weeklyDetailRawData.length > 0 ? topTotalGmv / weeklyDetailRawData.length : 0;
                        const topWithRetainer = weeklyDetailRawData.filter(c => c.retainer > 0).length;
                        summaryHtml = `
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem; color: var(--success);">${weeklyDetailRawData.length}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Top Creators</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${fmtMoney(topTotalGmv)}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Combined GMV</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${fmtMoney(topAvgGmv)}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Avg GMV</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${topWithRetainer}</div><div style="font-size: 0.75rem; color: var(--text-muted);">With Retainer</div></div>
                        `;
                        break;
                        
                    case 'needsAttention':
                        titleText = ' Needs Attention - Detailed View';
                        titleColor = 'var(--error)';
                        weeklyDetailRawData = (d.needsAttention || []).map(c => ({...c}));
                        weeklyDetailColumns = ['Creator', 'Brand', 'GMV', 'vs Prior', 'Retainer', 'Issue'];
                        const totalRetainerAtRisk = weeklyDetailRawData.reduce((s, c) => s + (c.retainer || 0), 0);
                        const withRetainerCount = weeklyDetailRawData.filter(c => c.retainer > 0).length;
                        const droppedCount = weeklyDetailRawData.filter(c => (c.change || 0) < -50).length;
                        summaryHtml = `
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem; color: var(--error);">${weeklyDetailRawData.length}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Flagged Creators</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${fmtMoney(totalRetainerAtRisk)}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Retainer at Risk</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${withRetainerCount}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Low GMV + Retainer</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${droppedCount}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Dropped 50%+</div></div>
                        `;
                        break;
                        
                    case 'mostActive':
                        titleText = ' Most Active - Detailed View';
                        titleColor = 'var(--blue)';
                        weeklyDetailRawData = (d.mostActive || []).map(c => ({...c}));
                        weeklyDetailColumns = ['Creator', 'Brand', 'Videos', 'GMV', 'Avg/Video', 'Retainer'];
                        const totalVideos = weeklyDetailRawData.reduce((s, c) => s + (c.count || 0), 0);
                        const avgVideos = weeklyDetailRawData.length > 0 ? totalVideos / weeklyDetailRawData.length : 0;
                        summaryHtml = `
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem; color: var(--blue);">${weeklyDetailRawData.length}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Active Creators</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${totalVideos}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Total Videos</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${avgVideos.toFixed(1)}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Avg Videos/Creator</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">5+</div><div style="font-size: 0.75rem; color: var(--text-muted);">Min Threshold</div></div>
                        `;
                        break;
                        
                    case 'belowTarget':
                        titleText = ' Below 5 Posts - Detailed View';
                        titleColor = 'var(--warning)';
                        weeklyDetailRawData = (d.belowTarget || []).map(c => ({...c}));
                        weeklyDetailColumns = ['Creator', 'Brand', 'Videos', 'Retainer', 'Gap', 'Priority'];
                        const zeroPosts = weeklyDetailRawData.filter(c => c.count === 0).length;
                        const oneToFour = weeklyDetailRawData.filter(c => c.count > 0 && c.count < 5).length;
                        const withRetainerBelowTarget = weeklyDetailRawData.filter(c => c.retainer > 0).length;
                        summaryHtml = `
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem; color: var(--warning);">${weeklyDetailRawData.length}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Below Target</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem; color: var(--error);">${zeroPosts}</div><div style="font-size: 0.75rem; color: var(--text-muted);">Zero Posts</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${oneToFour}</div><div style="font-size: 0.75rem; color: var(--text-muted);">1-4 Posts</div></div>
                            <div style="text-align: center;"><div style="font-weight: 700; font-size: 1.2rem;">${withRetainerBelowTarget}</div><div style="font-size: 0.75rem; color: var(--text-muted);">With Retainer</div></div>
                        `;
                        break;
                }
                
                // Update modal header and summary
                title.innerHTML = `<span style="color: ${titleColor};">${titleText}</span>`;
                summary.innerHTML = summaryHtml;
                
                // Populate sort dropdown
                const sortSelect = document.getElementById('weeklyDetailSort');
                const sortOptions = weeklyDetailSortOptions[type] || [];
                sortSelect.innerHTML = sortOptions.map(opt => 
                    `<option value="${opt.value}">${opt.label}</option>`
                ).join('');
                
                // Reset filters
                document.getElementById('weeklyDetailSearch').value = '';
                document.getElementById('weeklyDetailBrand').value = 'all';
                document.getElementById('weeklyDetailRetainer').value = 'all';
                
                // Render table with current filters
                applyWeeklyDetailFilters();
                
                modal.classList.add('show');
            } catch (err) {
                console.error('Error in showWeeklyDetail:', err);
                modal.classList.add('show');
            }
        }
        
        function applyWeeklyDetailFilters() {
            const search = (document.getElementById('weeklyDetailSearch')?.value || '').toLowerCase();
            const brand = document.getElementById('weeklyDetailBrand')?.value || 'all';
            const retainer = document.getElementById('weeklyDetailRetainer')?.value || 'all';
            const sort = document.getElementById('weeklyDetailSort')?.value || '';
            
            // Filter data
            let filtered = weeklyDetailRawData.filter(c => {
                // Search filter
                const name = (c.name || c.handle || '').toLowerCase();
                const handle = (c.handle || c.name || '').toLowerCase();
                if (search && !name.includes(search) && !handle.includes(search)) return false;
                
                // Brand filter
                if (brand !== 'all' && c.brand !== brand) return false;
                
                // Retainer filter
                if (retainer === 'has' && !(c.retainer > 0)) return false;
                if (retainer === 'affiliate' && c.retainer !== 0) return false;
                if (retainer === 'none' && c.retainer !== null && c.retainer !== undefined) return false;
                
                return true;
            });
            
            // Sort data
            if (sort) {
                const [field, dir] = sort.split('-');
                const mult = dir === 'desc' ? -1 : 1;
                
                filtered.sort((a, b) => {
                    let aVal, bVal;
                    switch (field) {
                        case 'gmv': aVal = a.gmv || 0; bVal = b.gmv || 0; break;
                        case 'change': aVal = a.change || 0; bVal = b.change || 0; break;
                        case 'retainer': aVal = a.retainer || 0; bVal = b.retainer || 0; break;
                        case 'count': aVal = a.count || 0; bVal = b.count || 0; break;
                        case 'name': aVal = (a.name || '').toLowerCase(); bVal = (b.name || '').toLowerCase(); 
                            return mult * aVal.localeCompare(bVal);
                        case 'priority':
                            // Critical (0 posts) > High (retainer) > Affiliate ($0) > Medium
                            const getPriority = c => c.count === 0 ? 4 : (c.retainer > 0 ? 3 : (c.retainer === 0 ? 2 : 1));
                            aVal = getPriority(a); bVal = getPriority(b);
                            break;
                        default: return 0;
                    }
                    return mult * (bVal - aVal);
                });
            }
            
            // Update count display
            const countEl = document.getElementById('weeklyDetailCount');
            if (countEl) {
                countEl.textContent = `Showing ${filtered.length} of ${weeklyDetailRawData.length}`;
            }
            
            // Store filtered data for export
            weeklyDetailFilteredData = filtered;
            
            // Render table
            renderWeeklyDetailTable(filtered);
        }
        
        function renderWeeklyDetailTable(data) {
            const thead = document.getElementById('weeklyDetailHead');
            const tbody = document.getElementById('weeklyDetailBody');
            const type = currentWeeklyDetailType;
            const d = weeklyReviewData;
            
            // Build table header
            thead.innerHTML = `<tr>${weeklyDetailColumns.map((col, i) => 
                `<th style="${i > 1 ? 'text-align: right;' : ''}">${col}</th>`
            ).join('')}</tr>`;
            
            // Build table body
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${weeklyDetailColumns.length}" style="padding: 40px; text-align: center; color: var(--text-muted);">No matching creators</td></tr>`;
                return;
            }
            
            tbody.innerHTML = data.map((c, i) => {
                const change = c.change || 0;
                switch (type) {
                    case 'topPerformers':
                        const roi = c.retainer > 0 ? (c.gmv / c.retainer).toFixed(1) : '-';
                        return `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 12px 16px;"><div style="font-weight: 600;">${i + 1}. @${c.name}</div></td>
                            <td style="padding: 12px 8px;"><span class="badge" style="font-size: 0.7rem;">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                            <td style="padding: 12px 8px; text-align: right; font-weight: 700; color: var(--success);">${fmtMoney(c.gmv)}</td>
                            <td style="padding: 12px 8px; text-align: right; color: ${change >= 0 ? 'var(--success)' : 'var(--error)'};">${change >= 0 ? '+' : ''}${change.toFixed(0)}%</td>
                            <td style="padding: 12px 8px; text-align: right;">${c.orders || '-'}</td>
                            <td style="padding: 12px 8px; text-align: right;">${c.retainer > 0 ? fmtMoney(c.retainer) : (c.retainer === 0 ? '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.65rem;">Affiliate</span>' : '-')}</td>
                            <td style="padding: 12px 8px; text-align: right; color: ${roi !== '-' && parseFloat(roi) >= 1 ? 'var(--success)' : 'var(--warning)'};">${roi !== '-' ? roi + 'x' : '-'}</td>
                        </tr>`;
                        
                    case 'needsAttention':
                        let issues = [];
                        if (c.retainer > 0 && c.gmv < 100) issues.push('Low GMV with retainer');
                        if (change < -50) issues.push(`Dropped ${Math.abs(change).toFixed(0)}%`);
                        return `<tr style="border-bottom: 1px solid var(--border); background: rgba(239, 68, 68, 0.05);">
                            <td style="padding: 12px 16px;"><div style="font-weight: 600;">@${c.name}</div></td>
                            <td style="padding: 12px 8px;"><span class="badge" style="font-size: 0.7rem;">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                            <td style="padding: 12px 8px; text-align: right; font-weight: 700; color: var(--error);">${fmtMoney(c.gmv)}</td>
                            <td style="padding: 12px 8px; text-align: right; color: var(--error);">${change < 0 ? change.toFixed(0) + '%' : '-'}</td>
                            <td style="padding: 12px 8px; text-align: right;">${c.retainer > 0 ? fmtMoney(c.retainer) : (c.retainer === 0 ? '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.65rem;">Affiliate</span>' : '-')}</td>
                            <td style="padding: 12px 8px; text-align: right;"><span style="font-size: 0.75rem; color: var(--error);">${issues.join(', ')}</span></td>
                        </tr>`;
                        
                    case 'mostActive':
                        const creatorGmv = (d.topPerformers || []).find(p => p.name.toLowerCase() === (c.handle || c.name).toLowerCase())?.gmv || 0;
                        const avgPerVideo = c.count > 0 ? creatorGmv / c.count : 0;
                        return `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 12px 16px;"><div style="font-weight: 600;">${i + 1}. ${c.name}</div><div style="font-size: 0.75rem; color: var(--text-muted);">@${c.handle || c.name}</div></td>
                            <td style="padding: 12px 8px;"><span class="badge" style="font-size: 0.7rem;">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                            <td style="padding: 12px 8px; text-align: right; font-weight: 700; color: var(--blue);">${c.count} videos</td>
                            <td style="padding: 12px 8px; text-align: right;">${creatorGmv > 0 ? fmtMoney(creatorGmv) : '-'}</td>
                            <td style="padding: 12px 8px; text-align: right;">${avgPerVideo > 0 ? fmtMoney(avgPerVideo) : '-'}</td>
                            <td style="padding: 12px 8px; text-align: right;">${c.retainer > 0 ? fmtMoney(c.retainer) : (c.retainer === 0 ? '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.65rem;">Affiliate</span>' : '-')}</td>
                        </tr>`;
                        
                    case 'belowTarget':
                        const gap = 5 - c.count;
                        const priority = c.count === 0 ? ' Critical' : (c.retainer > 0 ? ' High' : (c.retainer === 0 ? ' Affiliate' : ' Medium'));
                        return `<tr style="border-bottom: 1px solid var(--border); background: ${c.count === 0 ? 'rgba(239, 68, 68, 0.05)' : 'transparent'};">
                            <td style="padding: 12px 16px;"><div style="font-weight: 600;">${c.name}</div><div style="font-size: 0.75rem; color: var(--text-muted);">@${c.handle || c.name}</div></td>
                            <td style="padding: 12px 8px;"><span class="badge" style="font-size: 0.7rem;">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                            <td style="padding: 12px 8px; text-align: right; font-weight: 700; color: ${c.count === 0 ? 'var(--error)' : 'var(--warning)'};">${c.count} videos</td>
                            <td style="padding: 12px 8px; text-align: right;">${c.retainer > 0 ? fmtMoney(c.retainer) : (c.retainer === 0 ? '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.65rem;">Affiliate</span>' : '-')}</td>
                            <td style="padding: 12px 8px; text-align: right;">-${gap} videos</td>
                            <td style="padding: 12px 8px; text-align: right;">${priority}</td>
                        </tr>`;
                }
            }).join('');
        }
        
        function closeWeeklyDetailModal() {
            document.getElementById('weeklyDetailModal').classList.remove('show');
            currentWeeklyDetailType = null;
        }
        
        function exportWeeklyDetail() {
            const type = currentWeeklyDetailType;
            const sourceData = weeklyDetailFilteredData;
            let data = [];
            let headers = [];
            let filename = '';
            
            switch (type) {
                case 'topPerformers':
                    headers = ['Rank', 'Creator', 'Brand', 'GMV', 'Change %', 'Orders', 'Retainer'];
                    data = sourceData.map((c, i) => [
                        i + 1, `@${c.name}`, c.brand, (c.gmv || 0).toFixed(2), (c.change || 0).toFixed(1), c.orders || 0, c.retainer || 0
                    ]);
                    filename = 'top-performers';
                    break;
                case 'needsAttention':
                    headers = ['Creator', 'Brand', 'GMV', 'Change %', 'Retainer', 'Issue'];
                    data = sourceData.map(c => {
                        let issues = [];
                        if (c.retainer > 0 && c.gmv < 100) issues.push('Low GMV');
                        if ((c.change || 0) < -50) issues.push('Big drop');
                        return [`@${c.name}`, c.brand, (c.gmv || 0).toFixed(2), (c.change || 0).toFixed(1), c.retainer || 0, issues.join('; ')];
                    });
                    filename = 'needs-attention';
                    break;
                case 'mostActive':
                    headers = ['Rank', 'Creator', 'Handle', 'Brand', 'Videos', 'Retainer'];
                    data = sourceData.map((c, i) => [
                        i + 1, c.name, `@${c.handle || c.name}`, c.brand, c.count, c.retainer || 0
                    ]);
                    filename = 'most-active';
                    break;
                case 'belowTarget':
                    headers = ['Creator', 'Handle', 'Brand', 'Videos', 'Gap', 'Retainer', 'Priority'];
                    data = sourceData.map(c => {
                        const gap = 5 - c.count;
                        const priority = c.count === 0 ? 'Critical' : (c.retainer > 0 ? 'High' : (c.retainer === 0 ? 'Affiliate' : 'Medium'));
                        return [c.name, `@${c.handle || c.name}`, c.brand, c.count, gap, c.retainer || 0, priority];
                    });
                    filename = 'below-target';
                    break;
            }
            
            const csv = [headers, ...data].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadCSV(csv, `weekly-review-${filename}-${new Date().toISOString().split('T')[0]}.csv`);
            showToast(`Exported ${data.length} rows!`, 'success');
        }
        
        function copyWeeklyDetailForDiscord() {
            const sourceData = weeklyDetailFilteredData;
            const type = currentWeeklyDetailType;
            const filterBrand = document.getElementById('weeklyDetailBrand')?.value || 'all';
            const brandName = filterBrand === 'all' ? 'All Brands' : (BRAND_DISPLAY[filterBrand] || filterBrand);
            
            let text = '';
            
            switch (type) {
                case 'topPerformers':
                    text = ` **TOP PERFORMERS - ${brandName}** (${sourceData.length})\n\n`;
                    sourceData.forEach((c, i) => {
                        text += `${i + 1}. @${c.name} - ${fmtMoney(c.gmv)}`;
                        if ((c.change || 0) > 0) text += ` (+${c.change.toFixed(0)}%)`;
                        if (c.retainer > 0) text += ` `;
                        else if (c.retainer === 0) text += ` `;
                        text += `\n`;
                    });
                    break;
                    
                case 'needsAttention':
                    text = ` **NEEDS ATTENTION - ${brandName}** (${sourceData.length})\n\n`;
                    sourceData.forEach(c => {
                        text += ` @${c.name} - ${fmtMoney(c.gmv)}`;
                        if (c.retainer > 0) text += ` (${fmtMoney(c.retainer)} retainer)`;
                        else if (c.retainer === 0) text += ` (Affiliate)`;
                        if ((c.change || 0) < -50) text += ` ${Math.abs(c.change).toFixed(0)}%`;
                        text += `\n`;
                    });
                    break;
                    
                case 'mostActive':
                    text = ` **MOST ACTIVE - ${brandName}** (${sourceData.length})\n\n`;
                    sourceData.forEach((c, i) => {
                        text += `${i + 1}. ${c.name} - ${c.count} videos`;
                        if (c.retainer > 0) text += ` `;
                        else if (c.retainer === 0) text += ` `;
                        text += `\n`;
                    });
                    break;
                    
                case 'belowTarget':
                    text = ` **BELOW 5 POSTS - ${brandName}** (${sourceData.length})\n\n`;
                    const zero = sourceData.filter(c => c.count === 0);
                    const low = sourceData.filter(c => c.count > 0 && c.count < 5);
                    
                    if (zero.length > 0) {
                        text += `** Zero posts:**\n`;
                        zero.forEach(c => {
                            text += ` ${c.name}`;
                            if (c.retainer > 0) text += ` (${fmtMoney(c.retainer)} retainer!)`;
                            else if (c.retainer === 0) text += ` (Affiliate)`;
                            text += `\n`;
                        });
                        text += `\n`;
                    }
                    if (low.length > 0) {
                        text += `** 1-4 posts:**\n`;
                        low.forEach(c => {
                            text += ` ${c.name} (${c.count} posts)`;
                            if (c.retainer > 0) text += ` `;
                            else if (c.retainer === 0) text += ` `;
                            text += `\n`;
                        });
                    }
                    break;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        // ==================== MORNING BRIEFING ====================
        function copyGhostList() {
            // Get ghosts from posting tab data
            const ghostGrid = document.getElementById('postingGhostsGrid');
            if (!ghostGrid) {
                showToast('Load Posting tab first', 'warning');
                return;
            }
            
            const ghostCards = ghostGrid.querySelectorAll('[data-creator-name]');
            if (ghostCards.length === 0) {
                showToast('No ghosts found', 'info');
                return;
            }
            
            let text = ' GHOST CREATORS - Need Outreach\n';
            text += '\n';
            
            ghostCards.forEach(card => {
                const name = card.getAttribute('data-creator-name') || 'Unknown';
                const brand = card.getAttribute('data-brand') || '';
                const brandDisplay = BRAND_DISPLAY[brand] || brand;
                text += ` ${name} (${brandDisplay})\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Ghost list copied!', 'success');
            });
        }

        // ==================== OVERVIEW ====================
        async function loadOverviewData() {
            showLoading('overview', 'Loading dashboard data...');
            try {
            const brand = document.getElementById('brandFilter').value;
            const startDate = document.getElementById('dateFilterStart').value;
            const endDate = document.getElementById('dateFilterEnd').value;
            const status = document.getElementById('statusFilter')?.value || 'all';
            const search = document.getElementById('searchInput')?.value?.toLowerCase() || '';

            if (!startDate || !endDate) { hideLoading('overview'); return; }

            let creators = [];
            
            // Try RPC first, fall back to direct query
            updateLoadingMessage('overview', 'Fetching creator data...');
            const { data: rpcData, error: rpcError } = await supabaseClient.rpc('get_creator_summary', {
                p_brand: brand === 'all' ? null : brand,
                p_start_date: startDate,
                p_end_date: endDate
            });
            
            // Check if RPC returned valid data with brand field
            if (!rpcError && rpcData && rpcData.length > 0 && rpcData[0].brand !== undefined) {
                creators = rpcData.map(row => ({
                    creator_name: row.creator_name,
                    brand: row.brand,
                    gmv: pFloat(row.total_gmv),
                    refunds: pFloat(row.total_refunds),
                    orders: pInt(row.total_orders),
                    items_sold: pInt(row.total_items_sold),
                    videos: pInt(row.total_videos),
                    live_streams: pInt(row.total_live_streams),
                    est_commission: pFloat(row.total_commission),
                    aov: pInt(row.total_orders) > 0 ? pFloat(row.total_gmv) / pInt(row.total_orders) : 0
                }));
            } else {
                // Fallback: direct query with pagination
                console.log('Using fallback query for overview (RPC missing brand field)');
                let allData = [];
                let page = 0;
                let hasMore = true;
                let hitLimit = false;
                
                while (hasMore && page < MAX_PAGES) {
                    let query = supabaseClient
                        .from('creator_performance')
                        .select('creator_name, brand, gmv, refunds, orders, items_sold, videos, live_streams, est_commission')
                        .eq('period_type', 'daily')
                        .gte('report_date', startDate)
                        .lte('report_date', endDate)
                        .range(page * QUERY_PAGE_SIZE, (page + 1) * QUERY_PAGE_SIZE - 1);
                    
                    if (brand !== 'all') query = query.eq('brand', brand);
                    
                    const { data, error } = await query;
                    if (error || !data || data.length === 0) {
                        hasMore = false;
                    } else {
                        allData = allData.concat(data);
                        hasMore = data.length === QUERY_PAGE_SIZE;
                        page++;
                    }
                }
                if (page >= MAX_PAGES) { hitLimit = true; showDataLimitWarning('Overview', allData.length); }
                
                // Aggregate by creator + brand
                const aggregated = {};
                allData.forEach(row => {
                    const key = `${row.creator_name}|${row.brand}`;
                    if (!aggregated[key]) {
                        aggregated[key] = {
                            creator_name: row.creator_name,
                            brand: row.brand,
                            gmv: 0, refunds: 0, orders: 0, items_sold: 0, videos: 0, live_streams: 0, est_commission: 0
                        };
                    }
                    aggregated[key].gmv += pFloat(row.gmv);
                    aggregated[key].refunds += pFloat(row.refunds);
                    aggregated[key].orders += pInt(row.orders);
                    aggregated[key].items_sold += pInt(row.items_sold);
                    aggregated[key].videos += pInt(row.videos);
                    aggregated[key].live_streams += pInt(row.live_streams);
                    aggregated[key].est_commission += pFloat(row.est_commission);
                });
                
                creators = Object.values(aggregated).map(c => ({
                    ...c,
                    aov: c.orders > 0 ? c.gmv / c.orders : 0
                }));
            }

            if (status === 'managed') creators = creators.filter(c => isManagedForBrand(c.creator_name, c.brand));
            if (status === 'unmanaged') creators = creators.filter(c => !isManagedForBrand(c.creator_name, c.brand));
            if (search) creators = creators.filter(c => c.creator_name.toLowerCase().includes(search));

            creators.sort((a, b) => (b.gmv || 0) - (a.gmv || 0));

            // Calculate stats
            const totalGmv = creators.reduce((s, c) => s + (c.gmv || 0), 0);
            const totalOrders = creators.reduce((s, c) => s + (c.orders || 0), 0);
            const totalVideos = creators.reduce((s, c) => s + (c.videos || 0), 0);
            const activeCreators = creators.filter(c => c.gmv > 0).length;
            const gmvPerVideo = totalVideos > 0 ? totalGmv / totalVideos : 0;
            const aov = totalOrders > 0 ? totalGmv / totalOrders : 0;

            // Managed vs Unmanaged
            const managed = creators.filter(c => isManagedForBrand(c.creator_name, c.brand));
            const unmanaged = creators.filter(c => !isManagedForBrand(c.creator_name, c.brand));
            const managedGmv = managed.reduce((s, c) => s + (c.gmv || 0), 0);
            const unmanagedGmv = unmanaged.reduce((s, c) => s + (c.gmv || 0), 0);

            // Update stats (values)
            const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            setEl('statGmv', fmtMoney(totalGmv));
            setEl('statOrders', fmt(totalOrders));
            setEl('statCreators', fmt(activeCreators));
            setEl('statVideos', fmt(totalVideos));
            setEl('statGmvPerVideo', fmtMoney(gmvPerVideo));
            setEl('statAov', fmtMoney(aov));
            
            // Calculate prior period for trend comparison
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);
            const priorStartStr = priorStart.toISOString().split('T')[0];
            const priorEndStr = priorEnd.toISOString().split('T')[0];
            
            // Fetch prior period data for comparison
            updateLoadingMessage('overview', 'Calculating trends...');
            try {
                const { data: priorRpcData } = await supabaseClient.rpc('get_creator_summary', {
                    p_brand: brand === 'all' ? null : brand,
                    p_start_date: priorStartStr,
                    p_end_date: priorEndStr
                });
                
                let priorCreators = [];
                if (priorRpcData && priorRpcData.length > 0) {
                    priorCreators = priorRpcData.map(row => ({
                        creator_name: row.creator_name,
                        brand: row.brand,
                        gmv: pFloat(row.total_gmv),
                        orders: pInt(row.total_orders),
                        videos: pInt(row.total_videos)
                    }));
                    
                    // Apply same filters
                    if (status === 'managed') priorCreators = priorCreators.filter(c => isManagedForBrand(c.creator_name, c.brand));
                    if (status === 'unmanaged') priorCreators = priorCreators.filter(c => !isManagedForBrand(c.creator_name, c.brand));
                }
                
                // Calculate prior period totals
                const priorGmv = priorCreators.reduce((s, c) => s + (c.gmv || 0), 0);
                const priorOrders = priorCreators.reduce((s, c) => s + (c.orders || 0), 0);
                const priorVideos = priorCreators.reduce((s, c) => s + (c.videos || 0), 0);
                const priorActiveCreators = priorCreators.filter(c => c.gmv > 0).length;
                const priorGmvPerVideo = priorVideos > 0 ? priorGmv / priorVideos : 0;
                const priorAov = priorOrders > 0 ? priorGmv / priorOrders : 0;
                
                // Update trend indicators
                updateTrendIndicator('statGmvChange', totalGmv, priorGmv);
                updateTrendIndicator('statOrdersChange', totalOrders, priorOrders);
                updateTrendIndicator('statCreatorsChange', activeCreators, priorActiveCreators);
                updateTrendIndicator('statVideosChange', totalVideos, priorVideos);
                updateTrendIndicator('statGmvPerVideoChange', gmvPerVideo, priorGmvPerVideo);
                updateTrendIndicator('statAovChange', aov, priorAov);
                
            } catch (trendErr) {
                console.warn('Could not calculate trends:', trendErr);
                // Set all trends to neutral
                ['statGmvChange', 'statOrdersChange', 'statCreatorsChange', 'statVideosChange', 'statGmvPerVideoChange', 'statAovChange'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) { el.textContent = '--'; el.className = 'stat-change neutral'; }
                });
            }
            
            // Date range display
            const dateRangeText = startDate === endDate ? formatDate(startDate) : `${formatDate(startDate)}  ${formatDate(endDate)}`;
            setEl('dateRange', `${dateRangeText}  ${brand === 'all' ? 'All Brands' : BRAND_DISPLAY[brand]}`);

            // Managed vs Unmanaged comparison
            const managedActiveCount = managed.filter(c => c.gmv > 0).length;
            const unmanagedActiveCount = unmanaged.filter(c => c.gmv > 0).length;
            const managedAvgGmv = managedActiveCount > 0 ? managedGmv / managedActiveCount : 0;
            const unmanagedAvgGmv = unmanagedActiveCount > 0 ? unmanagedGmv / unmanagedActiveCount : 0;
            
            setEl('managedGmv', fmtMoney(managedGmv));
            setEl('managedCount', managedActiveCount);
            setEl('managedAvg', fmtMoney(managedAvgGmv));
            setEl('unmanagedGmv', fmtMoney(unmanagedGmv));
            setEl('unmanagedCount', unmanagedActiveCount);
            setEl('unmanagedAvg', fmtMoney(unmanagedAvgGmv));
            
            // Update progress bar and displays
            const combinedGmv = managedGmv + unmanagedGmv;
            const managedPct = combinedGmv > 0 ? (managedGmv / combinedGmv * 100) : 0;
            const unmanagedPct = combinedGmv > 0 ? (unmanagedGmv / combinedGmv * 100) : 0;
            
            const managedGmvDisplay = document.getElementById('managedGmvDisplay');
            const unmanagedGmvDisplay = document.getElementById('unmanagedGmvDisplay');
            const managedGmvBar = document.getElementById('managedGmvBar');
            const unmanagedGmvBar = document.getElementById('unmanagedGmvBar');
            const managedPctLabel = document.getElementById('managedPctLabel');
            
            if (managedGmvDisplay) managedGmvDisplay.textContent = fmtMoney(managedGmv);
            if (unmanagedGmvDisplay) unmanagedGmvDisplay.textContent = fmtMoney(unmanagedGmv);
            if (managedGmvBar) managedGmvBar.style.width = managedPct + '%';
            if (unmanagedGmvBar) unmanagedGmvBar.style.width = unmanagedPct + '%';
            if (managedPctLabel) managedPctLabel.textContent = managedPct.toFixed(1) + '%';

            // Store creators for pagination and render (removed table but keep for data)
            window.overviewCreators = creators;

            // Render Brand Donut Chart
            renderBrandDonutChart(creators);
            
            // Load and render GMV Trend Chart
            loadGmvTrendData(brand, startDate, endDate, status);
            
            // Load new Overview sections (pass brand filter)
            loadOverviewActionItems(brand);
            loadOverviewWins(brand);
            loadAgencyHealth(brand);
            } finally {
                hideLoading('overview');
                window.overviewLoadedOnce = true;
            }
        }
        
        // ==================== OVERVIEW HELPER FUNCTIONS ====================
        
        function toggleOverviewSection(section) {
            const content = document.getElementById(`overview${section.charAt(0).toUpperCase() + section.slice(1)}Content`);
            const toggle = document.getElementById(`overview${section.charAt(0).toUpperCase() + section.slice(1)}Toggle`);
            if (!content || !toggle) return;
            
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            toggle.textContent = isHidden ? '' : '';
        }
        
        async function loadOverviewActionItems(brand = 'all') {
            const listEl = document.getElementById('overviewActionsList');
            const countEl = document.getElementById('overviewActionsCount');
            if (!listEl) return;
            
            try {
                await loadManagedCreators();
                /**
                 * ACTION ITEMS CRITERIA:
                 * 1. Overdue Contracts (Priority 1): Contract start date + length < today
                 * 2. Low ROI Creators (Priority 2): ROI < 1x over rolling 30 days  
                 * 3. Ghost Creators (Priority 3): No posts in 7+ days (retainer creators only)
                 */
                
                const actions = [];
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 29);
                const startStr = thirtyDaysAgo.toISOString().split('T')[0];
                const endStr = today.toISOString().split('T')[0];
                
                // Build handles map for retainer creators (filtered by brand)
                let retainerCreators = managedCreators.filter(c => c.status === 'Active' && hasAnyRetainer(c));
                if (brand !== 'all') {
                    retainerCreators = retainerCreators.filter(c => c.brand === brand);
                }
                const handleToCreator = {};
                retainerCreators.forEach(c => {
                    [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(a => {
                        if (a && a.trim()) handleToCreator[a.toLowerCase()] = c;
                    });
                });
                
                // Fetch 30-day performance for ROI and posting analysis (filtered by brand)
                let perfQuery = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, gmv, videos, report_date, brand')
                    .gte('report_date', startStr)
                    .lte('report_date', endStr);
                if (brand !== 'all') {
                    perfQuery = perfQuery.eq('brand', brand);
                }
                const { data: perfData } = await perfQuery.limit(30000);
                
                // Aggregate by creator
                const creatorStats = {};
                (perfData || []).forEach(r => {
                    const handle = r.creator_name.toLowerCase();
                    if (!creatorStats[handle]) {
                        creatorStats[handle] = { gmv: 0, videos: 0, lastPostDate: null };
                    }
                    creatorStats[handle].gmv += pFloat(r.gmv);
                    creatorStats[handle].videos += pInt(r.videos);
                    if (pInt(r.videos) > 0 && (!creatorStats[handle].lastPostDate || r.report_date > creatorStats[handle].lastPostDate)) {
                        creatorStats[handle].lastPostDate = r.report_date;
                    }
                });
                
                // 1. Check for overdue contracts
                retainerCreators.forEach(c => {
                    if (c.retainer_start_date) {
                        const startDate = new Date(c.retainer_start_date);
                        const contractLength = c.contract_length_days || 30;
                        const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysSinceStart > contractLength) {
                            const daysOver = daysSinceStart - contractLength;
                            actions.push({
                                type: 'overdue',
                                priority: 1,
                                icon: '',
                                text: `${c.real_name || c.account_1} contract ${daysOver}d overdue`,
                                subtext: `${BRAND_DISPLAY[c.brand] || c.brand}  Reset or review`,
                                id: c.id
                            });
                        }
                    }
                });
                
                // 2. Check for low ROI creators (< 1x)
                retainerCreators.forEach(c => {
                    const retainer = getTotalRetainer(c);
                    if (retainer <= 0) return;
                    
                    let creatorGmv = 0;
                    [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(a => {
                        if (a && a.trim() && creatorStats[a.toLowerCase()]) {
                            creatorGmv += creatorStats[a.toLowerCase()].gmv;
                        }
                    });
                    
                    const roi = creatorGmv / retainer;
                    if (roi < 1) {
                        const loss = Math.round(retainer - creatorGmv);
                        actions.push({
                            type: 'roi',
                            priority: 2,
                            icon: '',
                            text: `${c.real_name || c.account_1} has ${roi.toFixed(1)}x ROI`,
                            subtext: `${BRAND_DISPLAY[c.brand] || c.brand}  Losing ~$${loss}/mo`,
                            id: c.id,
                            roi: roi // for sorting
                        });
                    }
                });
                
                // 3. Check for ghost creators (no posts in 7+ days)
                retainerCreators.forEach(c => {
                    let lastPost = null;
                    [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(a => {
                        if (a && a.trim() && creatorStats[a.toLowerCase()]?.lastPostDate) {
                            const postDate = creatorStats[a.toLowerCase()].lastPostDate;
                            if (!lastPost || postDate > lastPost) lastPost = postDate;
                        }
                    });
                    
                    if (lastPost) {
                        const daysSincePost = Math.floor((today - new Date(lastPost)) / (1000 * 60 * 60 * 24));
                        if (daysSincePost >= 7) {
                            actions.push({
                                type: 'ghost',
                                priority: 3,
                                icon: '',
                                text: `${c.real_name || c.account_1} hasn't posted in ${daysSincePost}d`,
                                subtext: `${BRAND_DISPLAY[c.brand] || c.brand}`,
                                id: c.id
                            });
                        }
                    }
                });
                
                // Sort by priority, then by severity within priority
                actions.sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    if (a.type === 'roi' && b.type === 'roi') return a.roi - b.roi; // Worst ROI first
                    return 0;
                });
                
                countEl.textContent = actions.length;
                
                if (actions.length === 0) {
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div>No urgent action items!</div>
                        </div>`;
                } else {
                    listEl.innerHTML = actions.slice(0, 8).map(a => `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;" onclick="editCreator(${a.id})">
                            <span style="font-size: 1.1rem;">${a.icon}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${a.text}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${a.subtext}</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading action items:', err);
                listEl.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 20px;">Could not load action items</div>`;
            }
        }
        
        async function loadOverviewWins(brand = 'all') {
            /**
             * TODAY'S WINS CRITERIA:
             * - Yesterday's data only (most recent complete day)
             * - Managed creators only (matched by handle)
             * - GMV >= $100 threshold
             * - Sorted by GMV descending, top 10 shown
             */
            const listEl = document.getElementById('overviewWinsList');
            const countEl = document.getElementById('overviewWinsCount');
            if (!listEl) return;
            
            try {
                // Get yesterday's date for wins
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                await loadManagedCreators();
                
                // Build managed handles (filtered by brand if specified)
                const managedHandles = new Set();
                let filteredCreators = managedCreators;
                if (brand !== 'all') {
                    filteredCreators = managedCreators.filter(c => c.brand === brand);
                }
                filteredCreators.forEach(c => {
                    [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(a => {
                        if (a && a.trim()) managedHandles.add(a.toLowerCase());
                    });
                });
                
                // Fetch yesterday's top performers (filtered by brand)
                let query = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, orders, videos')
                    .eq('report_date', yesterdayStr);
                if (brand !== 'all') {
                    query = query.eq('brand', brand);
                }
                const { data, error } = await query
                    .order('gmv', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                const wins = (data || [])
                    .filter(r => managedHandles.has(r.creator_name.toLowerCase()) && pFloat(r.gmv) >= 100)
                    .slice(0, 10)
                    .map(r => ({
                        name: r.creator_name,
                        brand: r.brand,
                        gmv: pFloat(r.gmv),
                        orders: pInt(r.orders)
                    }));
                
                window.overviewWinsData = wins;
                countEl.textContent = wins.length;
                
                if (wins.length === 0) {
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                            <div>No big wins yesterday</div>
                        </div>`;
                } else {
                    listEl.innerHTML = wins.map((w, i) => `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <span style="font-size: 1rem; width: 24px; text-align: center;">${i < 3 ? ['', '', ''][i] : ''}</span>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; font-size: 0.85rem;">@${w.name}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${BRAND_DISPLAY[w.brand] || w.brand}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: var(--success); font-size: 0.9rem;">${fmtMoney(w.gmv)}</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">${w.orders} orders</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading wins:', err);
                listEl.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 20px;">Could not load wins</div>`;
            }
        }
        
        function copyOverviewWins() {
            const wins = window.overviewWinsData || [];
            if (wins.length === 0) {
                showToast('No wins to copy', 'error');
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            
            let text = ` **Yesterday's Wins** (${dateStr})\n\n`;
            wins.forEach((w, i) => {
                const medal = i < 3 ? ['', '', ''][i] : '';
                text += `${medal} **@${w.name}** - ${fmtMoney(w.gmv)} (${w.orders} orders)\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Wins copied to clipboard!', 'success');
            });
        }
        
        async function loadAgencyHealth(brand = 'all') {
            try {
                await loadManagedCreators();
                
                // Calculate retainer spend (filtered by brand)
                let totalRetainer = 0;
                let retainerCount = 0;
                let retainerCreators = managedCreators.filter(c => c.status === 'Active' && hasAnyRetainer(c));
                if (brand !== 'all') {
                    retainerCreators = retainerCreators.filter(c => c.brand === brand);
                }
                
                retainerCreators.forEach(c => {
                    totalRetainer += getTotalRetainer(c);
                    retainerCount++;
                });
                
                // Get 30-day GMV for managed creators
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 29);
                const startStr = thirtyDaysAgo.toISOString().split('T')[0];
                const endStr = today.toISOString().split('T')[0];
                
                // Build managed handles set (filtered by brand)
                const managedHandles = new Set();
                let filteredManagedCreators = managedCreators;
                if (brand !== 'all') {
                    filteredManagedCreators = managedCreators.filter(c => c.brand === brand);
                }
                filteredManagedCreators.forEach(c => {
                    [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(a => {
                        if (a && a.trim()) managedHandles.add(a.toLowerCase());
                    });
                });
                
                // Fetch 30-day performance (filtered by brand)
                let perfQuery = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, gmv')
                    .gte('report_date', startStr)
                    .lte('report_date', endStr);
                if (brand !== 'all') {
                    perfQuery = perfQuery.eq('brand', brand);
                }
                const { data: perfData } = await perfQuery.limit(30000);
                
                let managedGmv = 0;
                let totalGmv = 0;
                (perfData || []).forEach(r => {
                    const gmv = pFloat(r.gmv);
                    totalGmv += gmv;
                    if (managedHandles.has(r.creator_name.toLowerCase())) {
                        managedGmv += gmv;
                    }
                });
                
                const portfolioRoi = totalRetainer > 0 ? managedGmv / totalRetainer : 0;
                const managedPct = totalGmv > 0 ? (managedGmv / totalGmv) * 100 : 0;
                const estCommission = managedGmv * 0.025;
                
                // Update UI
                document.getElementById('agencyRetainerSpend').textContent = fmtMoney(totalRetainer);
                document.getElementById('agencyRetainerCount').textContent = `${retainerCount} creators`;
                document.getElementById('agencyManagedGmv').textContent = fmtMoney(managedGmv);
                document.getElementById('agencyManagedPct').textContent = `${managedPct.toFixed(1)}% of total`;
                document.getElementById('agencyRoi').textContent = `${portfolioRoi.toFixed(1)}x`;
                document.getElementById('agencyRoi').style.color = portfolioRoi >= 3 ? '#22c55e' : portfolioRoi >= 1 ? '#f59e0b' : '#ef4444';
                document.getElementById('agencyCommission').textContent = fmtMoney(estCommission);
                
                // Calculate ROI distribution by computing each creator's ROI
                let cutCount = 0, watchCount = 0, keepCount = 0, starCount = 0;
                
                // Aggregate GMV by creator handle from performance data
                const creatorGmvMap = {};
                (perfData || []).forEach(r => {
                    const handle = r.creator_name.toLowerCase();
                    if (managedHandles.has(handle)) {
                        creatorGmvMap[handle] = (creatorGmvMap[handle] || 0) + pFloat(r.gmv);
                    }
                });
                
                // For each retainer creator, calculate ROI and categorize
                retainerCreators.forEach(c => {
                    const retainer = getTotalRetainer(c);
                    if (retainer <= 0) return;
                    
                    // Sum GMV across all accounts for this creator
                    let creatorGmv = 0;
                    [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(a => {
                        if (a && a.trim()) {
                            creatorGmv += creatorGmvMap[a.toLowerCase()] || 0;
                        }
                    });
                    
                    const roi = creatorGmv / retainer;
                    
                    // Categorize: Cut (<1x), Watch (1-3x), Keep (3-10x), Stars (10x+)
                    if (roi >= 10) starCount++;
                    else if (roi >= 3) keepCount++;
                    else if (roi >= 1) watchCount++;
                    else cutCount++;
                });
                
                const totalRoi = cutCount + watchCount + keepCount + starCount;
                if (totalRoi > 0) {
                    document.getElementById('roiBarCut').style.width = `${(cutCount / totalRoi) * 100}%`;
                    document.getElementById('roiBarWatch').style.width = `${(watchCount / totalRoi) * 100}%`;
                    document.getElementById('roiBarKeep').style.width = `${(keepCount / totalRoi) * 100}%`;
                    document.getElementById('roiBarStar').style.width = `${(starCount / totalRoi) * 100}%`;
                    
                    document.getElementById('roiCountCut').textContent = `(${cutCount})`;
                    document.getElementById('roiCountWatch').textContent = `(${watchCount})`;
                    document.getElementById('roiCountKeep').textContent = `(${keepCount})`;
                    document.getElementById('roiCountStar').textContent = `(${starCount})`;
                    document.getElementById('agencyRoiSummary').textContent = `${totalRoi} retainer creators`;
                }
                
            } catch (err) {
                console.error('Error loading agency health:', err);
            }
        }
        
        // Legacy Morning Brief - kept for compatibility
        let morningBriefData = { wins: [], urgent: [] };
        
        async function loadMorningBrief() {
            const dateEl = document.getElementById('morningBriefDate');
            const winsListEl = document.getElementById('morningWinsList');
            const urgentListEl = document.getElementById('morningUrgentList');
            const winsCountEl = document.getElementById('morningWinsCount');
            const urgentCountEl = document.getElementById('morningUrgentCount');
            
            // Get yesterday's date
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            dateEl.textContent = yesterday.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            
            try {
                await loadManagedCreators();
                
                // Fetch yesterday's performance for managed creators
                const { data: perfData } = await supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, orders, videos')
                    .eq('report_date', yesterdayStr);
                
                // Aggregate by creator
                const creatorMap = new Map();
                (perfData || []).forEach(row => {
                    const key = `${row.creator_name?.toLowerCase()}|||${row.brand}`;
                    const managed = isManagedForBrand(row.creator_name, row.brand);
                    if (!managed) return;
                    
                    if (!creatorMap.has(key)) {
                        creatorMap.set(key, {
                            creator_name: row.creator_name,
                            brand: row.brand,
                            gmv: 0,
                            orders: 0,
                            videos: 0
                        });
                    }
                    const c = creatorMap.get(key);
                    c.gmv += pFloat(row.gmv);
                    c.orders += pInt(row.orders);
                    c.videos += pInt(row.videos);
                });
                
                const creators = [...creatorMap.values()];
                
                // Wins: Creators with $100+ GMV yesterday
                const wins = creators.filter(c => c.gmv >= 100).sort((a, b) => b.gmv - a.gmv).slice(0, 5);
                
                // Urgent: Get creators who haven't posted in 5+ days
                const fiveDaysAgo = new Date();
                fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
                const fiveDaysStr = fiveDaysAgo.toISOString().split('T')[0];
                
                const { data: recentActivity } = await supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, videos')
                    .gte('report_date', fiveDaysStr)
                    .gt('videos', 0);
                
                // Get unique active creators
                const activeCreators = new Set();
                (recentActivity || []).forEach(row => {
                    activeCreators.add(`${row.creator_name?.toLowerCase()}|||${row.brand}`);
                });
                
                // Find managed creators who aren't in active set
                const urgent = managedCreators
                    .filter(mc => !activeCreators.has(`${mc.account_1?.toLowerCase()}|||${mc.brand}`))
                    .slice(0, 5)
                    .map(mc => ({
                        creator_name: mc.account_1 || mc.discord_name,
                        brand: mc.brand,
                        reason: 'No posts in 5+ days'
                    }));
                
                morningBriefData = { wins, urgent };
                
                // Render wins
                winsCountEl.textContent = wins.length;
                if (wins.length === 0) {
                    winsListEl.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; padding: 8px 0;">No big wins yesterday  keep pushing! </div>';
                } else {
                    winsListEl.innerHTML = wins.map(w => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1rem;">${BRAND_ICONS[w.brand] || ''}</span>
                                <span style="font-weight: 500; cursor: pointer;" onclick="openCreatorDetail('${w.creator_name}', '${w.brand}')">@${w.creator_name}</span>
                            </div>
                            <span style="font-weight: 600; color: var(--success);">${fmtMoney(w.gmv)}</span>
                        </div>
                    `).join('');
                }
                
                // Render urgent
                urgentCountEl.textContent = urgent.length;
                if (urgent.length === 0) {
                    urgentListEl.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; padding: 8px 0;">All creators active  great! </div>';
                } else {
                    urgentListEl.innerHTML = urgent.map(u => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1rem;">${BRAND_ICONS[u.brand] || ''}</span>
                                <span style="font-weight: 500; cursor: pointer;" onclick="openCreatorDetail('${u.creator_name}', '${u.brand}')">@${u.creator_name}</span>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--error);">${u.reason}</span>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load morning brief:', err);
                winsListEl.innerHTML = '<div style="color: var(--error); font-size: 0.85rem;">Failed to load</div>';
                urgentListEl.innerHTML = '<div style="color: var(--error); font-size: 0.85rem;">Failed to load</div>';
            }
        }
        
        function copyMorningWins() {
            const wins = morningBriefData.wins || [];
            if (wins.length === 0) {
                showToast('No wins to copy', 'info');
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            
            let text = ` **Wins for ${dateStr}**\n\n`;
            wins.forEach(w => {
                text += `${BRAND_ICONS[w.brand] || ''} **@${w.creator_name}** hit **${fmtMoney(w.gmv)}** GMV!\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Wins copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        function renderOverviewTable() {
            const creators = window.overviewCreators || [];
            const page = window.overviewPage || 1;
            const pageSize = window.overviewPageSize || 50;
            const totalPages = Math.ceil(creators.length / pageSize) || 1;
            
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, creators.length);
            const pageCreators = creators.slice(start, end);
            
            // Render table
            document.getElementById('creatorsBody').innerHTML = pageCreators.map((c, i) => {
                const rank = start + i + 1;
                const tier = getTier(c.gmv || 0);
                const managed = isManagedForBrand(c.creator_name, c.brand);
                const info = getManagedInfo(c.creator_name);
                const gmvPerVid = c.videos > 0 ? (c.gmv || 0) / c.videos : 0;
                return `<tr class="clickable" onclick="openCreatorDetail('${c.creator_name}', '${c.brand}')">
                    <td style="text-align: center; font-weight: 600; color: ${rank <= 3 ? 'var(--accent)' : 'var(--text-muted)'};">${rank}</td>
                    <td><div class="creator-cell">
                        <div class="creator-avatar">${c.creator_name.charAt(0).toUpperCase()}</div>
                        <div class="creator-info">
                            <span class="creator-name">${c.creator_name}</span>
                            ${info ? `<span class="creator-handle">${info.real_name || ''}</span>` : ''}
                        </div>
                    </div></td>
                    <td><span class="badge-brand">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                    <td><span class="gmv-value ${c.gmv >= 5000 ? 'gmv-high' : c.gmv >= 1000 ? 'gmv-medium' : 'gmv-low'}">${fmtMoney(c.gmv)}</span></td>
                    <td>${fmt(c.orders)}</td>
                    <td>${c.videos || 0}</td>
                    <td>${fmtMoney(gmvPerVid)}</td>
                    <td><span class="badge-tier ${tier.class}">${tier.name}</span></td>
                    <td><span class="badge ${managed ? 'badge-managed' : 'badge-unmanaged'}">${managed ? '' : ''}</span></td>
                </tr>`;
            }).join('') || '<tr><td colspan="9"><div class="empty-state"><h3>No data</h3></div></td></tr>';

            // Update creator count
            const countEl = document.getElementById('creatorCount');
            if (countEl) countEl.textContent = `${creators.length} creators`;
            
            // Update pagination UI
            document.getElementById('overviewShowingStart').textContent = creators.length ? start + 1 : 0;
            document.getElementById('overviewShowingEnd').textContent = end;
            document.getElementById('overviewTotalCreators').textContent = creators.length;
            document.getElementById('overviewCurrentPage').textContent = page;
            document.getElementById('overviewTotalPages').textContent = totalPages;
            document.getElementById('overviewPrevBtn').disabled = page <= 1;
            document.getElementById('overviewNextBtn').disabled = page >= totalPages;
        }
        
        function overviewChangePage(delta) {
            const creators = window.overviewCreators || [];
            const pageSize = window.overviewPageSize || 50;
            const totalPages = Math.ceil(creators.length / pageSize) || 1;
            
            window.overviewPage = Math.max(1, Math.min(totalPages, (window.overviewPage || 1) + delta));
            renderOverviewTable();
            
            // Scroll to top of table
            document.querySelector('#view-overview .card:last-child')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Filter overview table by search input (client-side for currently loaded data)
        function filterOverviewTable() {
            const search = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const allCreators = window.overviewCreatorsUnfiltered || window.overviewCreators || [];
            
            // Store unfiltered on first filter
            if (!window.overviewCreatorsUnfiltered && window.overviewCreators) {
                window.overviewCreatorsUnfiltered = [...window.overviewCreators];
            }
            
            if (!search) {
                window.overviewCreators = window.overviewCreatorsUnfiltered || [];
            } else {
                window.overviewCreators = allCreators.filter(c => 
                    c.creator_name?.toLowerCase().includes(search) ||
                    (getManagedInfo(c.creator_name)?.real_name || '').toLowerCase().includes(search)
                );
            }
            
            window.overviewPage = 1;
            renderOverviewTable();
        }
        
        // Export overview table to CSV
        function exportOverviewToCSV() {
            const creators = window.overviewCreators || [];
            if (creators.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const headers = ['Rank', 'Creator', 'Real Name', 'Brand', 'GMV', 'Orders', 'Videos', 'GMV/Video', 'Tier', 'Managed'];
            const rows = creators.map((c, i) => {
                const tier = getTier(c.gmv || 0);
                const managed = isManagedForBrand(c.creator_name, c.brand);
                const info = getManagedInfo(c.creator_name);
                const gmvPerVid = c.videos > 0 ? (c.gmv || 0) / c.videos : 0;
                return [
                    i + 1,
                    c.creator_name,
                    info?.real_name || '',
                    BRAND_DISPLAY[c.brand] || c.brand,
                    (c.gmv || 0).toFixed(2),
                    c.orders || 0,
                    c.videos || 0,
                    gmvPerVid.toFixed(2),
                    tier.name,
                    managed ? 'Yes' : 'No'
                ];
            });
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `creator-performance-${dateStr}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${creators.length} creators to CSV`, 'success');
        }

        // Chart instances
        let brandDonutChartInstance = null;
        let gmvTrendChartInstance = null;

        function renderBrandDonutChart(creators) {
            // Aggregate GMV by brand
            const brandGmv = {};
            creators.forEach(c => {
                const brandName = BRAND_DISPLAY[c.brand] || c.brand;
                brandGmv[brandName] = (brandGmv[brandName] || 0) + (c.gmv || 0);
            });
            
            const labels = Object.keys(brandGmv);
            const data = Object.values(brandGmv);
            const colors = ['#f5c518', '#3b82f6', '#10b981', '#8b5cf6', '#f97316'];
            
            const ctx = document.getElementById('brandDonutChart');
            if (!ctx) return;
            
            if (brandDonutChartInstance) {
                brandDonutChartInstance.destroy();
            }
            
            brandDonutChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#9aa5b8',
                                padding: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${fmtMoney(value)} (${pct}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = ((value / total) * 100);
                                // Only show label if segment is large enough
                                return pct >= 5 ? pct.toFixed(0) + '%' : '';
                            },
                            anchor: 'center',
                            align: 'center'
                        }
                    },
                    cutout: '55%'
                },
                plugins: [ChartDataLabels]
            });
        }

        async function loadGmvTrendData(brand, startDate, endDate, status) {
            console.log('loadGmvTrendData called:', { brand, startDate, endDate, status });
            
            // If filtering by managed status, use fallback (client-side filtering)
            // since RPC doesn't support managed/unmanaged filtering
            if (status === 'managed' || status === 'unmanaged') {
                console.log('Using fallback for status filter:', status);
                await loadGmvTrendDataFallback(brand, startDate, endDate, status);
                return;
            }
            
            // Fetch daily GMV data for the trend chart - use aggregated query
            try {
                // Use RPC to get aggregated daily totals to avoid row limits
                const { data, error } = await supabaseClient.rpc('get_daily_gmv_trend', {
                    p_brand: brand === 'all' ? null : brand,
                    p_start_date: startDate,
                    p_end_date: endDate
                });
                
                if (error) {
                    console.error('Error loading trend data:', error);
                    // Fallback to direct query with limit
                    await loadGmvTrendDataFallback(brand, startDate, endDate, status);
                    return;
                }
                
                // Data already aggregated by date from RPC - field is trend_date
                const sortedData = (data || []).sort((a, b) => {
                    const dateA = a.trend_date || a.report_date || '';
                    const dateB = b.trend_date || b.report_date || '';
                    return dateA.localeCompare(dateB);
                });
                const labels = sortedData.map(d => {
                    const dateStr = d.trend_date || d.report_date;
                    const date = new Date(dateStr + 'T00:00:00');
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                const values = sortedData.map(d => parseFloat(d.total_gmv) || 0);
                
                console.log('RPC returned', sortedData.length, 'days of data');
                renderGmvTrendChart(labels, values);
            } catch (err) {
                console.error('Trend data error:', err);
                await loadGmvTrendDataFallback(brand, startDate, endDate, status);
            }
        }
        
        async function loadGmvTrendDataFallback(brand, startDate, endDate, status) {
            console.log('loadGmvTrendDataFallback called:', { brand, startDate, endDate, status });
            try {
                // Fetch ALL data using pagination (Supabase default limit is 1000)
                let allData = [];
                let page = 0;
                const pageSize = QUERY_PAGE_SIZE;
                let hasMore = true;
                
                while (hasMore) {
                    let query = supabaseClient
                        .from('creator_performance')
                        .select('report_date, gmv, creator_name, brand')
                        .eq('period_type', 'daily')
                        .gte('report_date', startDate)
                        .lte('report_date', endDate)
                        .range(page * pageSize, (page + 1) * pageSize - 1);
                    
                    if (brand !== 'all') {
                        query = query.eq('brand', brand);
                    }
                    
                    const { data, error } = await query;
                    
                    if (error) {
                        console.error('Error loading trend data page:', error);
                        break;
                    }
                    
                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        console.log(`Fetched page ${page + 1}: ${data.length} rows (total: ${allData.length})`);
                        hasMore = data.length === pageSize;
                        page++;
                    } else {
                        hasMore = false;
                    }
                    
                    // Safety limit
                    if (page >= MAX_PAGES) {
                        console.log('Hit pagination safety limit');
                        showDataLimitWarning('GMV Trend', allData.length);
                        break;
                    }
                }
                
                console.log('Total rows fetched:', allData.length);
                
                // Filter by managed status if needed
                let filteredData = allData;
                console.log('Before filtering:', filteredData.length, 'rows');
                
                if (status === 'managed') {
                    filteredData = filteredData.filter(d => isManagedForBrand(d.creator_name, d.brand));
                } else if (status === 'unmanaged') {
                    filteredData = filteredData.filter(d => !isManagedForBrand(d.creator_name, d.brand));
                }
                
                console.log('After filtering:', filteredData.length, 'rows');
                
                // Aggregate by date
                const dailyGmv = {};
                filteredData.forEach(row => {
                    const date = row.report_date;
                    dailyGmv[date] = (dailyGmv[date] || 0) + pFloat(row.gmv);
                });
                
                // Sort by date and prepare chart data
                const sortedDates = Object.keys(dailyGmv).sort();
                const labels = sortedDates.map(d => {
                    const date = new Date(d + 'T00:00:00');
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                const values = sortedDates.map(d => dailyGmv[d]);
                
                console.log('Rendering chart with', labels.length, 'data points');
                renderGmvTrendChart(labels, values);
            } catch (err) {
                console.error('GMV trend fallback error:', err);
                renderGmvTrendChart([], []);
            }
        }

        function renderGmvTrendChart(labels, data) {
            const ctx = document.getElementById('gmvTrendChart');
            if (!ctx) return;
            
            if (gmvTrendChartInstance) {
                gmvTrendChartInstance.destroy();
                gmvTrendChartInstance = null;
            }
            
            // Handle empty data
            if (!labels || !data || labels.length === 0) {
                // Show empty state
                gmvTrendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            label: 'GMV',
                            data: [0],
                            borderColor: '#f5c518',
                            backgroundColor: 'rgba(245, 197, 24, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
                return;
            }
            
            gmvTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'GMV',
                        data: data,
                        borderColor: '#f5c518',
                        backgroundColor: 'rgba(245, 197, 24, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: '#f5c518'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return fmtMoney(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#9aa5b8',
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grace: '15%',
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#9aa5b8',
                                callback: function(value) {
                                    return '$' + (value >= 1000 ? (value/1000).toFixed(0) + 'K' : value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Apply date preset selection (for overview - now handled by Litepicker ranges)
        function applyDatePreset(presetIndex) {
            if (presetIndex === '' || presetIndex === null) return;
            
            const preset = DATE_PRESETS[parseInt(presetIndex)];
            if (!preset) return;
            
            const dates = preset.getDates();
            
            // Update Litepicker instance
            if (datePickers['overview']) {
                datePickers['overview'].setDateRange(dates.start, dates.end);
            }
            
            // Update hidden input values
            document.getElementById('dateFilterStart').value = dates.start;
            document.getElementById('dateFilterEnd').value = dates.end;
            
            // Reload data
            loadOverviewData();
            updateLastUpdated();
        }

        // Apply date preset to specific section (Products, Videos, Creators, Brands)
        function applyDatePresetToSection(section, presetIndex) {
            if (presetIndex === '' || presetIndex === null) return;
            
            const preset = DATE_PRESETS[parseInt(presetIndex)];
            if (!preset) return;
            
            const dates = preset.getDates();
            
            // Map section to element IDs
            const sectionMap = {
                'products': { start: 'productsDateFilterStart', end: 'productsDateFilterEnd', load: loadProductsData },
                'videos': { start: 'videosDateFilterStart', end: 'videosDateFilterEnd', load: () => { pages.videos = 1; loadVideosData(); } },
                'creators': { start: 'creatorsDateFilterStart', end: 'creatorsDateFilterEnd', load: () => { pages.creators = 1; loadCreatorsData(); } },
                'brands': { start: 'brandsDateFilterStart', end: 'brandsDateFilterEnd', load: loadBrandsData }
            };
            
            const config = sectionMap[section];
            if (!config) return;
            
            // Update Litepicker instances
            const startEl = document.getElementById(config.start);
            const endEl = document.getElementById(config.end);
            
            if (datePickers[config.start]) {
                datePickers[config.start].setDate(dates.start);
            }
            if (datePickers[config.end]) {
                datePickers[config.end].setDate(dates.end);
            }
            
            // Update input values
            startEl.value = dates.start;
            endEl.value = dates.end;
            
            // Reload data for the section
            config.load();
            updateLastUpdated();
        }

        // Event listeners for overview - search only (brand and status have onchange in HTML)
        const searchInputEl = document.getElementById('searchInput');
        if (searchInputEl) searchInputEl.addEventListener('input', loadOverviewData);

        // ==================== BRANDS ====================
        let brandTrendChartInstance = null;
        
        async function loadBrandsData() {
            showLoading('brands', 'Loading brand data...');
            try {
            const startDate = document.getElementById('brandsDateFilterStart').value;
            const endDate = document.getElementById('brandsDateFilterEnd').value;
            const status = document.getElementById('brandsStatusFilter').value;
            if (!startDate || !endDate) { hideLoading('brands'); return; }

            // Calculate prior period for WoW comparison
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);

            // Fetch current period data with pagination
            let allData = [];
            let page = 0;
            const pageSize = QUERY_PAGE_SIZE;
            let hasMore = true;
            
            while (hasMore) {
                const { data, error } = await supabaseClient.from('creator_performance')
                    .select('*')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    allData = allData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Fetch prior period data
            let priorData = [];
            page = 0;
            hasMore = true;
            
            while (hasMore) {
                const { data, error } = await supabaseClient.from('creator_performance')
                    .select('*')
                    .gte('report_date', localDateStr(priorStart))
                    .lte('report_date', localDateStr(priorEnd))
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    priorData = priorData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Filter by managed status
            let filteredData = allData;
            let filteredPrior = priorData;
            if (status === 'managed') {
                filteredData = filteredData.filter(d => isManagedForBrand(d.creator_name, d.brand));
                filteredPrior = filteredPrior.filter(d => isManagedForBrand(d.creator_name, d.brand));
            } else if (status === 'unmanaged') {
                filteredData = filteredData.filter(d => !isManagedForBrand(d.creator_name, d.brand));
                filteredPrior = filteredPrior.filter(d => !isManagedForBrand(d.creator_name, d.brand));
            }

            // Group by brand and aggregate - current period
            const brands = {};
            const brandOrder = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic', 'toplux'];
            brandOrder.forEach(b => {
                brands[b] = { gmv: 0, orders: 0, videos: 0, commission: 0, creators: new Set() };
            });
            
            filteredData.forEach(c => {
                if (!brands[c.brand]) brands[c.brand] = { gmv: 0, orders: 0, videos: 0, commission: 0, creators: new Set() };
                const b = brands[c.brand];
                b.gmv += pFloat(c.gmv);
                b.orders += pInt(c.orders);
                b.videos += pInt(c.videos);
                b.commission += pFloat(c.est_commission);
                if (pFloat(c.gmv) > 0) b.creators.add(c.creator_name);
            });

            // Group by brand - prior period
            const priorBrands = {};
            filteredPrior.forEach(c => {
                if (!priorBrands[c.brand]) priorBrands[c.brand] = { gmv: 0 };
                priorBrands[c.brand].gmv += pFloat(c.gmv);
            });

            // Find top performer
            const sortedByGmv = Object.entries(brands).sort((a, b) => b[1].gmv - a[1].gmv);
            const topBrand = sortedByGmv[0]?.[0];

            // Render comparison cards
            document.getElementById('brandComparisonCards').innerHTML = brandOrder.map(brand => {
                const stats = brands[brand] || { gmv: 0, orders: 0, videos: 0, creators: new Set() };
                const priorGmv = priorBrands[brand]?.gmv || 0;
                const change = priorGmv > 0 ? ((stats.gmv - priorGmv) / priorGmv * 100) : (stats.gmv > 0 ? 100 : 0);
                const isTop = brand === topBrand;
                const active = stats.creators.size;
                
                return `<div class="brand-comparison-card ${isTop ? 'top-performer' : ''}">
                    <div class="brand-title">${isTop ? ' ' : ''}${BRAND_DISPLAY[brand] || brand}</div>
                    <div class="brand-gmv">${fmtMoney(stats.gmv)}</div>
                    <div class="brand-change ${change >= 0 ? 'trend-up' : 'trend-down'}">
                        ${change >= 0 ? '' : ''} ${Math.abs(change).toFixed(1)}% vs prior
                    </div>
                    <div class="brand-mini-stats">
                        <span>${fmt(stats.orders)} orders</span>
                        <span>${active} creators</span>
                    </div>
                </div>`;
            }).join('');

            // Render WoW table with all stats
            document.getElementById('brandWowBody').innerHTML = sortedByGmv.map(([brand, stats]) => {
                const priorGmv = priorBrands[brand]?.gmv || 0;
                const change = priorGmv > 0 ? ((stats.gmv - priorGmv) / priorGmv * 100) : (stats.gmv > 0 ? 100 : 0);
                const creatorCount = stats.creators?.size || 0;
                return `<tr>
                    <td><strong>${BRAND_DISPLAY[brand] || brand}</strong></td>
                    <td style="text-align: right;"><span class="gmv-value">${fmtMoney(stats.gmv)}</span></td>
                    <td style="text-align: right; color: var(--text-muted);">${fmtMoney(priorGmv)}</td>
                    <td style="text-align: right;"><span class="trend-indicator ${change >= 0 ? 'trend-up' : 'trend-down'}">
                        ${change >= 0 ? '' : ''} ${Math.abs(change).toFixed(1)}%
                    </span></td>
                    <td style="text-align: right;">${fmt(stats.orders)}</td>
                    <td style="text-align: right;">${creatorCount}</td>
                </tr>`;
            }).join('');

            // Load deep dive for selected brand
            loadBrandDeepDive();
            loadBrandTrendChart(currentTrendPeriod);
            } finally {
                hideLoading('brands');
            }
        }

        // Brand GMV Trend Chart - multi-week analysis
        let currentTrendPeriod = '7d';
        
        async function loadBrandTrendChart(period = '7d') {
            currentTrendPeriod = period;
            
            // Update button states
            ['7d', '4w', '8w', '3m'].forEach(p => {
                const btn = document.getElementById(`trendPeriod${p}`);
                if (btn) btn.classList.toggle('active', p === period);
            });
            
            const ctx = document.getElementById('brandTrendChart');
            if (!ctx) return;
            
            // Get selected KPI
            const kpi = document.getElementById('trendKpiSelect')?.value || 'gmv';
            
            // Calculate date range based on period
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1); // Yesterday
            const startDate = new Date(endDate);
            
            let groupBy = 'day'; // day or week
            
            switch (period) {
                case '7d':
                    startDate.setDate(startDate.getDate() - 6);
                    groupBy = 'day';
                    break;
                case '4w':
                    startDate.setDate(startDate.getDate() - 27);
                    groupBy = 'week';
                    break;
                case '8w':
                    startDate.setDate(startDate.getDate() - 55);
                    groupBy = 'week';
                    break;
                case '3m':
                    startDate.setDate(startDate.getDate() - 89);
                    groupBy = 'week';
                    break;
            }
            
            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];
            
            try {
                // Fetch data per brand to avoid timeout on large queries
                const brandOrder = ['physicians_choice', 'jiyu', 'catakor', 'peach_slices', 'yerba_magic', 'toplux'];
                const brandData = {};
                const periodDates = {};
                const allPeriods = new Set();
                
                for (const brand of brandOrder) {
                    let brandRows = [];
                    let page = 0;
                    const pageSize = 10000; // Smaller page size for stability
                    let hasMore = true;
                    
                    while (hasMore && page < 5) { // Max 5 pages per brand
                        try {
                            const { data, error } = await supabaseClient.from('creator_performance')
                                .select('report_date, gmv, orders, videos, creator_name')
                                .eq('brand', brand)
                                .gte('report_date', startStr)
                                .lte('report_date', endStr)
                                .eq('period_type', 'daily')
                                .range(page * pageSize, (page + 1) * pageSize - 1);
                            
                            if (error) {
                                console.warn(`Error fetching ${brand} trend data:`, error);
                                hasMore = false;
                            } else if (!data || data.length === 0) {
                                hasMore = false;
                            } else {
                                brandRows = brandRows.concat(data);
                                hasMore = data.length === pageSize;
                                page++;
                            }
                        } catch (fetchErr) {
                            console.warn(`Fetch error for ${brand}:`, fetchErr);
                            hasMore = false;
                        }
                    }
                    
                    // Process this brand's data
                    brandRows.forEach(row => {
                        let periodKey;
                        let periodEndDate;
                        
                        if (groupBy === 'day') {
                            periodKey = row.report_date;
                            periodEndDate = row.report_date;
                        } else {
                            const d = new Date(row.report_date + 'T00:00:00');
                            const dayOfWeek = d.getDay();
                            const weekStart = new Date(d);
                            weekStart.setDate(d.getDate() - dayOfWeek);
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            periodKey = weekStart.toISOString().split('T')[0];
                            periodEndDate = weekEnd.toISOString().split('T')[0];
                        }
                        
                        allPeriods.add(periodKey);
                        periodDates[periodKey] = periodEndDate;
                        
                        if (!brandData[brand]) brandData[brand] = {};
                        if (!brandData[brand][periodKey]) {
                            brandData[brand][periodKey] = { gmv: 0, orders: 0, videos: 0, creators: new Set() };
                        }
                        
                        brandData[brand][periodKey].gmv += parseFloat(row.gmv) || 0;
                        brandData[brand][periodKey].orders += parseInt(row.orders) || 0;
                        brandData[brand][periodKey].videos += parseInt(row.videos) || 0;
                        if (row.creator_name) brandData[brand][periodKey].creators.add(row.creator_name);
                    });
                }
                
                if (allPeriods.size === 0) {
                    console.warn('No trend data found for period:', period);
                    return;
                }
                
                // Sort periods chronologically
                const sortedPeriods = [...allPeriods].sort();
                
                // Format labels - show date ranges for weeks
                const labels = sortedPeriods.map(p => {
                    const startD = new Date(p + 'T00:00:00');
                    if (groupBy === 'day') {
                        return startD.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    } else {
                        const endD = new Date(periodDates[p] + 'T00:00:00');
                        const startMonth = startD.toLocaleDateString('en-US', { month: 'short' });
                        const endMonth = endD.toLocaleDateString('en-US', { month: 'short' });
                        if (startMonth === endMonth) {
                            return `${startMonth} ${startD.getDate()}-${endD.getDate()}`;
                        } else {
                            return `${startMonth} ${startD.getDate()} - ${endMonth} ${endD.getDate()}`;
                        }
                    }
                });
                
                // Build datasets based on selected KPI
                const brandColors = {
                    'catakor': { line: '#e74c3c', bg: 'rgba(231, 76, 60, 0.1)' },
                    'jiyu': { line: '#9b59b6', bg: 'rgba(155, 89, 182, 0.1)' },
                    'physicians_choice': { line: '#3498db', bg: 'rgba(52, 152, 219, 0.1)' },
                    'peach_slices': { line: '#ff6b9d', bg: 'rgba(255, 107, 157, 0.1)' },
                    'yerba_magic': { line: '#2ecc71', bg: 'rgba(46, 204, 113, 0.1)' },
                    'toplux': { line: '#00b894', bg: 'rgba(0, 184, 148, 0.1)' }
                };
                
                const datasets = brandOrder
                    .filter(brand => brandData[brand])
                    .map(brand => {
                        const colors = brandColors[brand] || { line: '#888', bg: 'rgba(136,136,136,0.1)' };
                        
                        // Get data based on KPI
                        const getData = (periodData) => {
                            if (!periodData) return 0;
                            switch (kpi) {
                                case 'gmv': return periodData.gmv || 0;
                                case 'orders': return periodData.orders || 0;
                                case 'videos': return periodData.videos || 0;
                                case 'creators': return periodData.creators?.size || 0;
                                default: return periodData.gmv || 0;
                            }
                        };
                        
                        return {
                            label: BRAND_DISPLAY[brand] || brand,
                            data: sortedPeriods.map(p => getData(brandData[brand][p])),
                            borderColor: colors.line,
                            backgroundColor: colors.bg,
                            fill: true,
                            tension: 0.3,
                            pointRadius: groupBy === 'day' ? 4 : 5,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        };
                    });
                
                // Destroy existing chart
                if (brandTrendChartInstance) {
                    brandTrendChartInstance.destroy();
                }
                
                // Tooltip and Y-axis formatting based on KPI
                const kpiConfig = {
                    gmv: { 
                        format: (v) => fmtMoney(v),
                        yAxisFormat: (v) => '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'K' : v)
                    },
                    orders: { 
                        format: (v) => v.toLocaleString() + ' orders',
                        yAxisFormat: (v) => v >= 1000 ? (v/1000).toFixed(0) + 'K' : v
                    },
                    videos: { 
                        format: (v) => v.toLocaleString() + ' videos',
                        yAxisFormat: (v) => v >= 1000 ? (v/1000).toFixed(0) + 'K' : v
                    },
                    creators: { 
                        format: (v) => v.toLocaleString() + ' creators',
                        yAxisFormat: (v) => v
                    }
                };
                
                const config = kpiConfig[kpi] || kpiConfig.gmv;
                
                // Create chart
                brandTrendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: ${config.format(ctx.raw)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { 
                                    color: '#9aa5b8',
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: {
                                    color: '#9aa5b8',
                                    callback: config.yAxisFormat
                                }
                            }
                        }
                    }
                });
                
                // Render custom legend
                const legendEl = document.getElementById('brandTrendLegend');
                if (legendEl) {
                    legendEl.innerHTML = datasets.map(ds => `
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${ds.borderColor};"></div>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">${ds.label}</span>
                        </div>
                    `).join('');
                }
                
            } catch (err) {
                console.error('Error loading brand trend chart:', err);
            }
        }
        
        function getWeekNumber(d) {
            const onejan = new Date(d.getFullYear(), 0, 1);
            const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            return week;
        }

        async function loadBrandDeepDive() {
            const brand = document.getElementById('brandDeepDiveSelect').value;
            const startDate = document.getElementById('brandsDateFilterStart').value;
            const endDate = document.getElementById('brandsDateFilterEnd').value;
            const status = document.getElementById('brandsStatusFilter').value;
            
            if (!startDate || !endDate || !brand) return;

            // Calculate prior period
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);

            // Fetch current period data for this brand with pagination
            let allData = [];
            let page = 0;
            const pageSize = QUERY_PAGE_SIZE;
            let hasMore = true;
            
            while (hasMore) {
                const { data, error } = await supabaseClient.from('creator_performance')
                    .select('*')
                    .eq('brand', brand)
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    allData = allData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Fetch prior period
            let priorData = [];
            page = 0;
            hasMore = true;
            
            while (hasMore) {
                const { data, error } = await supabaseClient.from('creator_performance')
                    .select('*')
                    .eq('brand', brand)
                    .gte('report_date', localDateStr(priorStart))
                    .lte('report_date', localDateStr(priorEnd))
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    priorData = priorData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Filter by status if needed (but calculate managed breakdown from all data first)
            const managedData = allData.filter(d => isManagedForBrand(d.creator_name, d.brand));
            const unmanagedData = allData.filter(d => !isManagedForBrand(d.creator_name, d.brand));
            
            let filteredData = allData;
            let filteredPrior = priorData;
            if (status === 'managed') {
                filteredData = managedData;
                filteredPrior = priorData.filter(d => isManagedForBrand(d.creator_name, d.brand));
            } else if (status === 'unmanaged') {
                filteredData = unmanagedData;
                filteredPrior = priorData.filter(d => !isManagedForBrand(d.creator_name, d.brand));
            }

            // Calculate totals
            const totals = {
                gmv: filteredData.reduce((s, d) => s + pFloat(d.gmv), 0),
                orders: filteredData.reduce((s, d) => s + pInt(d.orders), 0),
                videos: filteredData.reduce((s, d) => s + pInt(d.videos), 0),
                commission: filteredData.reduce((s, d) => s + pFloat(d.est_commission), 0),
                creators: new Set(filteredData.filter(d => pFloat(d.gmv) > 0).map(d => d.creator_name)).size
            };
            
            // Calculate prior period totals
            const priorTotals = {
                gmv: filteredPrior.reduce((s, d) => s + pFloat(d.gmv), 0),
                orders: filteredPrior.reduce((s, d) => s + pInt(d.orders), 0),
                videos: filteredPrior.reduce((s, d) => s + pInt(d.videos), 0),
                commission: filteredPrior.reduce((s, d) => s + pFloat(d.est_commission), 0),
                creators: new Set(filteredPrior.filter(d => pFloat(d.gmv) > 0).map(d => d.creator_name)).size
            };
            
            const aov = totals.orders > 0 ? totals.gmv / totals.orders : 0;
            const priorAov = priorTotals.orders > 0 ? priorTotals.gmv / priorTotals.orders : 0;

            // Update stats with trends
            document.getElementById('ddGmv').textContent = fmtMoney(totals.gmv);
            updateTrendIndicator('ddGmvChange', totals.gmv, priorTotals.gmv);
            
            document.getElementById('ddOrders').textContent = fmt(totals.orders);
            updateTrendIndicator('ddOrdersChange', totals.orders, priorTotals.orders);
            
            document.getElementById('ddCreators').textContent = totals.creators;
            updateTrendIndicator('ddCreatorsChange', totals.creators, priorTotals.creators);
            
            document.getElementById('ddVideos').textContent = fmt(totals.videos);
            updateTrendIndicator('ddVideosChange', totals.videos, priorTotals.videos);
            
            document.getElementById('ddAov').textContent = fmtMoney(aov);
            updateTrendIndicator('ddAovChange', aov, priorAov);
            
            document.getElementById('ddCommission').textContent = fmtMoney(totals.commission);
            updateTrendIndicator('ddCommissionChange', totals.commission, priorTotals.commission);

            // Managed vs Unmanaged breakdown (always show full breakdown)
            const managedGmv = managedData.reduce((s, d) => s + pFloat(d.gmv), 0);
            const unmanagedGmv = unmanagedData.reduce((s, d) => s + pFloat(d.gmv), 0);
            const managedCreators = new Set(managedData.filter(d => pFloat(d.gmv) > 0).map(d => d.creator_name)).size;
            const unmanagedCreators = new Set(unmanagedData.filter(d => pFloat(d.gmv) > 0).map(d => d.creator_name)).size;
            
            document.getElementById('ddManagedGmv').textContent = fmtMoney(managedGmv);
            document.getElementById('ddManagedCount').textContent = `${managedCreators} creators`;
            document.getElementById('ddManagedAvg').textContent = `${fmtMoney(managedCreators > 0 ? managedGmv / managedCreators : 0)} avg`;
            document.getElementById('ddUnmanagedGmv').textContent = fmtMoney(unmanagedGmv);
            document.getElementById('ddUnmanagedCount').textContent = `${unmanagedCreators} creators`;
            document.getElementById('ddUnmanagedAvg').textContent = `${fmtMoney(unmanagedCreators > 0 ? unmanagedGmv / unmanagedCreators : 0)} avg`;

            // Aggregate by creator and get top 10
            const creatorMap = new Map();
            filteredData.forEach(row => {
                if (!creatorMap.has(row.creator_name)) {
                    creatorMap.set(row.creator_name, {
                        creator_name: row.creator_name,
                        gmv: 0, orders: 0, videos: 0, commission: 0
                    });
                }
                const c = creatorMap.get(row.creator_name);
                c.gmv += pFloat(row.gmv);
                c.orders += pInt(row.orders);
                c.videos += pInt(row.videos);
                c.commission += pFloat(row.est_commission);
            });
            
            const topCreators = [...creatorMap.values()]
                .sort((a, b) => b.gmv - a.gmv)
                .slice(0, 10);

            document.getElementById('brandTopCreatorsBody').innerHTML = topCreators.map((c, i) => {
                const managed = isManagedForBrand(c.creator_name, brand);
                const aov = c.orders > 0 ? c.gmv / c.orders : 0;
                return `<tr>
                    <td style="text-align: center; font-weight: 600; color: ${i < 3 ? 'var(--accent)' : 'var(--text-muted)'};">${i + 1}</td>
                    <td><div class="creator-cell">
                        <div class="creator-avatar">${c.creator_name.charAt(0).toUpperCase()}</div>
                        <span class="creator-name">${c.creator_name}</span>
                    </div></td>
                    <td><span class="badge ${managed ? 'badge-managed' : 'badge-unmanaged'}">${managed ? ' Managed' : 'Unmanaged'}</span></td>
                    <td><span class="gmv-value gmv-high">${fmtMoney(c.gmv)}</span></td>
                    <td>${fmt(c.orders)}</td>
                    <td>${c.videos}</td>
                    <td>${fmtMoney(aov)}</td>
                    <td>${fmtMoney(c.commission)}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="8"><div class="empty-state">No creators found</div></td></tr>';
            
            // Load product breakdown
            loadProductBreakdown(brand, startDate, endDate, totals.gmv);
        }
        
        // Product breakdown cache for drilldown
        let productBreakdownCache = {};
        
        async function loadProductBreakdown(brand, startDate, endDate, totalBrandGmv) {
            const tbody = document.getElementById('brandProductsBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><div class="spinner"></div> Loading products...</td></tr>';
            
            try {
                // Try product_performance first, then fall back to video_performance
                let allProductData = [];
                let page = 0;
                const pageSize = QUERY_PAGE_SIZE;
                let hasMore = true;
                let useVideoPerformance = false;
                
                // Try product_performance table first
                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('product_performance')
                        .select('product_name, product_id, gmv, orders, creator_name, report_date')
                        .eq('brand', brand)
                        .gte('report_date', startDate)
                        .lte('report_date', endDate)
                        .range(page * pageSize, (page + 1) * pageSize - 1);
                    
                    if (error) {
                        console.log('product_performance not available, trying video_performance');
                        useVideoPerformance = true;
                        hasMore = false;
                    } else if (!data || data.length === 0) {
                        hasMore = false;
                    } else {
                        allProductData = allProductData.concat(data);
                        hasMore = data.length === pageSize;
                        page++;
                    }
                    if (page >= MAX_PAGES) break;
                }
                
                // Fallback to video_performance if product_performance is empty
                if (allProductData.length === 0 || useVideoPerformance) {
                    console.log('Using video_performance for product breakdown');
                    allProductData = [];
                    page = 0;
                    hasMore = true;
                    
                    while (hasMore) {
                        const { data, error } = await supabaseClient
                            .from('video_performance')
                            .select('product_name, gmv, orders, creator_name, report_date')
                            .eq('brand', brand)
                            .gte('report_date', startDate)
                            .lte('report_date', endDate)
                            .not('product_name', 'is', null)
                            .range(page * pageSize, (page + 1) * pageSize - 1);
                        
                        if (error) {
                            console.error('Video performance fetch error:', error);
                            hasMore = false;
                        } else if (!data || data.length === 0) {
                            hasMore = false;
                        } else {
                            allProductData = allProductData.concat(data);
                            hasMore = data.length === pageSize;
                            page++;
                        }
                        if (page >= MAX_PAGES) break;
                    }
                }
                
                if (allProductData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No product data available. Upload product performance data to see breakdown.</td></tr>';
                    return;
                }
                
                // Aggregate by product
                const productMap = new Map();
                const productCreatorMap = new Map(); // For drilldown
                
                allProductData.forEach(row => {
                    const productKey = row.product_name || row.product_id || 'Unknown';
                    
                    if (!productMap.has(productKey)) {
                        productMap.set(productKey, {
                            product_name: productKey,
                            product_id: row.product_id,
                            gmv: 0,
                            orders: 0,
                            videos: 0,
                            creators: new Set(),
                            dailyGmv: {}
                        });
                    }
                    
                    const p = productMap.get(productKey);
                    p.gmv += pFloat(row.gmv);
                    p.orders += pInt(row.orders);
                    if (row.creator_name) p.creators.add(row.creator_name);
                    
                    // Track daily GMV for trend
                    const date = row.report_date;
                    p.dailyGmv[date] = (p.dailyGmv[date] || 0) + pFloat(row.gmv);
                    
                    // Track creator breakdown for drilldown
                    if (!productCreatorMap.has(productKey)) {
                        productCreatorMap.set(productKey, new Map());
                    }
                    const creatorMap = productCreatorMap.get(productKey);
                    if (row.creator_name) {
                        if (!creatorMap.has(row.creator_name)) {
                            creatorMap.set(row.creator_name, { gmv: 0, orders: 0, videos: 0 });
                        }
                        const c = creatorMap.get(row.creator_name);
                        c.gmv += pFloat(row.gmv);
                        c.orders += pInt(row.orders);
                    }
                });
                
                // Store for drilldown
                productBreakdownCache = {
                    brand,
                    startDate,
                    endDate,
                    products: productMap,
                    creatorsByProduct: productCreatorMap
                };
                
                // Sort by GMV descending
                const products = [...productMap.values()].sort((a, b) => b.gmv - a.gmv);
                
                // Calculate trend indicator (compare first half to second half of period)
                const getTrend = (dailyGmv) => {
                    const dates = Object.keys(dailyGmv).sort();
                    if (dates.length < 4) return 'neutral';
                    const mid = Math.floor(dates.length / 2);
                    const firstHalf = dates.slice(0, mid).reduce((s, d) => s + dailyGmv[d], 0);
                    const secondHalf = dates.slice(mid).reduce((s, d) => s + dailyGmv[d], 0);
                    if (secondHalf > firstHalf * 1.1) return 'up';
                    if (secondHalf < firstHalf * 0.9) return 'down';
                    return 'neutral';
                };
                
                tbody.innerHTML = products.slice(0, 20).map((p, i) => {
                    const pctOfTotal = totalBrandGmv > 0 ? (p.gmv / totalBrandGmv * 100) : 0;
                    const trend = getTrend(p.dailyGmv);
                    const trendIcon = trend === 'up' ? '' : trend === 'down' ? '' : '';
                    const trendColor = trend === 'up' ? 'var(--success)' : trend === 'down' ? 'var(--danger)' : 'var(--text-muted)';
                    
                    // Truncate long product names
                    const displayName = p.product_name.length > 50 
                        ? p.product_name.substring(0, 47) + '...' 
                        : p.product_name;
                    
                    return `<tr style="cursor: pointer;" onclick="showProductCreatorDrilldown('${encodeURIComponent(p.product_name)}')">
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 0.85rem; color: var(--text-muted);">${i + 1}.</span>
                                <span style="font-weight: 500;" title="${p.product_name}">${displayName}</span>
                            </div>
                        </td>
                        <td style="text-align: right; font-weight: 600; color: var(--accent);">${fmtMoney(p.gmv)}</td>
                        <td style="text-align: right;">
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                <div style="width: 60px; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${Math.min(pctOfTotal, 100)}%; height: 100%; background: var(--accent); border-radius: 3px;"></div>
                                </div>
                                <span style="min-width: 45px;">${pctOfTotal.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td style="text-align: right;">${fmt(p.orders)}</td>
                        <td style="text-align: right;">${p.creators.size}</td>
                        <td style="text-align: center; color: ${trendColor};">${trendIcon}</td>
                    </tr>`;
                }).join('') || '<tr><td colspan="6"><div class="empty-state">No products found</div></td></tr>';
                
                // Show count if more than 20
                if (products.length > 20) {
                    tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 0.85rem;">
                        Showing top 20 of ${products.length} products
                    </td></tr>`;
                }
                
            } catch (err) {
                console.error('Failed to load product breakdown:', err);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--danger);">Error loading products: ${err.message}</td></tr>`;
            }
        }
        
        function showProductCreatorDrilldown(encodedProductName) {
            const productName = decodeURIComponent(encodedProductName);
            const drilldown = document.getElementById('productCreatorDrilldown');
            const tbody = document.getElementById('productCreatorsBody');
            const brand = productBreakdownCache.brand;
            
            document.getElementById('drilldownProductName').textContent = productName.length > 40 
                ? productName.substring(0, 37) + '...' 
                : productName;
            
            const creatorMap = productBreakdownCache.creatorsByProduct?.get(productName);
            
            if (!creatorMap || creatorMap.size === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No creator data for this product</td></tr>';
            } else {
                const creators = [...creatorMap.entries()]
                    .map(([name, data]) => ({ creator_name: name, ...data }))
                    .sort((a, b) => b.gmv - a.gmv);
                
                tbody.innerHTML = creators.slice(0, 25).map((c, i) => {
                    const managed = isManagedForBrand(c.creator_name, brand);
                    return `<tr>
                        <td style="text-align: center; font-weight: 600; color: ${i < 3 ? 'var(--accent)' : 'var(--text-muted)'};">${i + 1}</td>
                        <td>
                            <div class="creator-cell">
                                <div class="creator-avatar">${c.creator_name.charAt(0).toUpperCase()}</div>
                                <span class="creator-name">${c.creator_name}</span>
                            </div>
                        </td>
                        <td><span class="badge ${managed ? 'badge-managed' : 'badge-unmanaged'}">${managed ? ' Managed' : 'Unmanaged'}</span></td>
                        <td style="text-align: right; font-weight: 600; color: var(--accent);">${fmtMoney(c.gmv)}</td>
                        <td style="text-align: right;">${fmt(c.orders)}</td>
                        <td style="text-align: right;">${c.videos || '-'}</td>
                    </tr>`;
                }).join('');
                
                if (creators.length > 25) {
                    tbody.innerHTML += `<tr><td colspan="6" style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 0.85rem;">
                        Showing top 25 of ${creators.length} creators
                    </td></tr>`;
                }
            }
            
            drilldown.style.display = 'block';
            drilldown.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function closeProductDrilldown() {
            document.getElementById('productCreatorDrilldown').style.display = 'none';
        }

        // ==================== CREATORS ====================
        let creatorsCache = { current: [], prior: [], filtered: [] };
        
        async function loadCreatorsData() {
            showLoading('creators', 'Loading creator data...');
            window.creatorsDataLoaded = true; // Mark that Creators view has been loaded
            try {
            const brand = document.getElementById('creatorsBrandFilter').value;
            const startDate = document.getElementById('creatorsDateFilterStart').value;
            const endDate = document.getElementById('creatorsDateFilterEnd').value;
            const status = document.getElementById('creatorsStatusFilter').value;
            const tier = document.getElementById('creatorsTierFilter').value;
            const search = document.getElementById('creatorsSearchInput').value.toLowerCase();

            if (!startDate || !endDate) { hideLoading('creators'); return; }

            // Calculate prior period
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);

            // Fetch current period data with pagination
            let allData = [];
            let page = 0;
            const pageSize = QUERY_PAGE_SIZE;
            let hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('creator_performance')
                    .select('*')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    allData = allData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Fetch prior period data
            let priorData = [];
            page = 0;
            hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('creator_performance')
                    .select('*')
                    .gte('report_date', localDateStr(priorStart))
                    .lte('report_date', localDateStr(priorEnd))
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    priorData = priorData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Aggregate current period by creator
            const creatorMap = new Map();
            allData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!creatorMap.has(key)) {
                    creatorMap.set(key, {
                        creator_name: row.creator_name,
                        brand: row.brand,
                        gmv: 0, orders: 0, videos: 0, est_commission: 0
                    });
                }
                const c = creatorMap.get(key);
                c.gmv += pFloat(row.gmv);
                c.orders += pInt(row.orders);
                c.videos += pInt(row.videos);
                c.est_commission += pFloat(row.est_commission);
            });

            // Aggregate prior period by creator
            const priorMap = new Map();
            priorData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!priorMap.has(key)) {
                    priorMap.set(key, { gmv: 0 });
                }
                priorMap.get(key).gmv += pFloat(row.gmv);
            });

            // Build creators array with WoW change
            let creators = [...creatorMap.values()].map(c => {
                const priorGmv = priorMap.get(`${c.creator_name}|||${c.brand}`)?.gmv || 0;
                const change = priorGmv > 0 ? ((c.gmv - priorGmv) / priorGmv * 100) : (c.gmv > 0 ? 100 : 0);
                const isNew = priorGmv === 0 && c.gmv > 0;
                return {
                    ...c,
                    aov: c.orders > 0 ? c.gmv / c.orders : 0,
                    priorGmv,
                    change,
                    isNew,
                    managed: isManagedForBrand(c.creator_name, c.brand)
                };
            });

            // Apply status filter
            if (status === 'managed') {
                creators = creators.filter(c => c.managed);
            } else if (status === 'unmanaged') {
                creators = creators.filter(c => !c.managed);
            }

            // Apply tier filter
            if (tier !== 'all') {
                const tierObj = TIERS.find(t => t.name.toLowerCase() === tier);
                const tierIdx = TIERS.indexOf(tierObj);
                const maxGmv = tierIdx > 0 ? TIERS[tierIdx - 1].min : Infinity;
                creators = creators.filter(c => c.gmv >= tierObj.min && c.gmv < maxGmv);
            }

            // Apply search filter
            if (search) {
                creators = creators.filter(c => c.creator_name.toLowerCase().includes(search));
            }

            // Sort by GMV descending
            creators.sort((a, b) => b.gmv - a.gmv);
            
            // Cache for export and other uses
            creatorsCache.filtered = creators;

            // Calculate current stats
            const totalGmv = creators.reduce((s, c) => s + c.gmv, 0);
            const priorTotalGmv = creators.reduce((s, c) => s + c.priorGmv, 0);
            const totalCommission = creators.reduce((s, c) => s + c.est_commission, 0);
            const managedCount = creators.filter(c => c.managed).length;
            const unmanagedCount = creators.filter(c => !c.managed).length;
            const risingCount = creators.filter(c => !c.isNew && c.change >= 20).length;
            const decliningCount = creators.filter(c => c.change <= -20).length;
            const avgGmv = creators.length ? totalGmv / creators.length : 0;
            
            // Calculate prior period stats for trend comparison
            const priorCreatorMap = new Map();
            let filteredPriorData = priorData;
            if (status === 'managed') {
                filteredPriorData = priorData.filter(d => isManagedForBrand(d.creator_name, d.brand));
            } else if (status === 'unmanaged') {
                filteredPriorData = priorData.filter(d => !isManagedForBrand(d.creator_name, d.brand));
            }
            filteredPriorData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!priorCreatorMap.has(key)) {
                    priorCreatorMap.set(key, { gmv: 0, commission: 0 });
                }
                const c = priorCreatorMap.get(key);
                c.gmv += pFloat(row.gmv);
                c.commission += pFloat(row.est_commission);
            });
            const priorCreatorCount = priorCreatorMap.size;
            const priorCommission = [...priorCreatorMap.values()].reduce((s, c) => s + c.commission, 0);
            const priorAvgGmv = priorCreatorCount > 0 ? priorTotalGmv / priorCreatorCount : 0;

            // Update stats display with trend indicators
            document.getElementById('creatorsStatGmv').textContent = fmtMoney(totalGmv);
            updateTrendIndicator('creatorsStatGmvChange', totalGmv, priorTotalGmv);
            
            document.getElementById('creatorsStatTotal').textContent = creators.length;
            updateTrendIndicator('creatorsStatTotalChange', creators.length, priorCreatorCount);
            
            document.getElementById('creatorsStatAvg').textContent = fmtMoney(avgGmv);
            updateTrendIndicator('creatorsStatAvgChange', avgGmv, priorAvgGmv);
            
            document.getElementById('creatorsStatCommission').textContent = fmtMoney(totalCommission);
            updateTrendIndicator('creatorsStatCommissionChange', totalCommission, priorCommission);
            
            document.getElementById('creatorsStatRising').textContent = risingCount;
            document.getElementById('creatorsStatDeclining').textContent = decliningCount;

            // Render insight cards
            renderCreatorInsights(creators);

            // Update table count
            document.getElementById('creatorsTableCount').textContent = `${creators.length} creators`;

            // Paginate and render table
            const startIdx = (pages.creators - 1) * PAGE_SIZE;
            const pageData = creators.slice(startIdx, startIdx + PAGE_SIZE);

            document.getElementById('creatorsFullBody').innerHTML = pageData.map(c => {
                const tierInfo = getTier(c.gmv);
                const changeClass = c.isNew ? 'trend-neutral' : c.change >= 0 ? 'trend-up' : 'trend-down';
                const changeText = c.isNew ? ' New' : `${c.change >= 0 ? '' : ''} ${Math.abs(c.change).toFixed(0)}%`;
                
                return `<tr class="clickable" onclick="openCreatorDetail('${c.creator_name.replace(/'/g, "\\'")}', '${c.brand}')">
                    <td onclick="event.stopPropagation()"><input type="checkbox" class="creator-checkbox" data-creator="${c.creator_name}" data-brand="${c.brand}" onchange="updateBulkSelection()"></td>
                    <td><div class="creator-cell">
                        <div class="creator-avatar">${c.creator_name.charAt(0).toUpperCase()}</div>
                        <span class="creator-name">${c.creator_name}</span>
                    </div></td>
                    <td><span class="badge-brand">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                    <td><span class="badge ${c.managed ? 'badge-managed' : 'badge-unmanaged'}">${c.managed ? ' Managed' : 'Unmanaged'}</span></td>
                    <td><span class="gmv-value gmv-high">${fmtMoney(c.gmv)}</span></td>
                    <td><span class="trend-indicator ${changeClass}">${changeText}</span></td>
                    <td>${fmt(c.orders)}</td>
                    <td>${fmtMoney(c.aov)}</td>
                    <td>${c.videos}</td>
                    <td>${fmtMoney(c.est_commission)}</td>
                    <td><span class="badge-tier ${tierInfo.class}">${tierInfo.name}</span></td>
                    <td onclick="event.stopPropagation()">
                        ${c.managed 
                            ? '<span style="color: var(--text-muted); font-size: 0.8rem;">In Roster</span>'
                            : `<button class="btn btn-primary" style="padding: 4px 10px; font-size: 0.75rem;" onclick="quickAddToRoster('${c.creator_name.replace(/'/g, "\\'")}', '${c.brand}')"> Add</button>`
                        }
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="12"><div class="empty-state"><h3>No creators found</h3><p>Try adjusting your filters</p></div></td></tr>';

            // Clear selection when data reloads
            document.getElementById('selectAllCreators').checked = false;
            updateBulkSelection();
            
            // Check data validation status for current filters
            updateCreatorsValidationBanner(brand, startDate, endDate);
            
            renderPagination('creatorsPagination', creators.length, pages.creators, (p) => { pages.creators = p; loadCreatorsData(); });
            } finally {
                hideLoading('creators');
            }
        }

        async function updateCreatorsValidationBanner(brand, startDate, endDate) {
            const banner = document.getElementById('creatorsValidationBanner');
            const icon = document.getElementById('creatorsValidationIcon');
            const text = document.getElementById('creatorsValidationText');
            
            if (!banner) return;
            
            try {
                // Get affiliate data for the date range
                let affQuery = supabaseClient
                    .from('affiliate_summary')
                    .select('gmv, report_date, brand')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate);
                if (brand !== 'all') affQuery = affQuery.eq('brand', brand);
                
                const { data: affData, error: affError } = await affQuery;
                
                if (affError || !affData || affData.length === 0) {
                    // No affiliate data - hide banner
                    banner.style.display = 'none';
                    return;
                }
                
                // Sum affiliate totals
                const affTotal = affData.reduce((sum, r) => sum + pFloat(r.gmv), 0);
                const daysWithAffData = affData.length;
                
                // Get creator performance totals for the same range with proper pagination
                let allCpData = [];
                let page = 0;
                let hasMore = true;
                
                while (hasMore && page < MAX_PAGES) {
                    // Create fresh query for each page
                    let query = supabaseClient
                        .from('creator_performance')
                        .select('gmv')
                        .gte('report_date', startDate)
                        .lte('report_date', endDate)
                        .eq('period_type', 'daily')
                        .range(page * QUERY_PAGE_SIZE, (page + 1) * QUERY_PAGE_SIZE - 1);
                    
                    if (brand !== 'all') query = query.eq('brand', brand);
                    
                    const { data: pageData, error } = await query;
                    
                    if (error || !pageData || pageData.length === 0) {
                        hasMore = false;
                    } else {
                        allCpData = allCpData.concat(pageData);
                        hasMore = pageData.length === QUERY_PAGE_SIZE;
                        page++;
                    }
                }
                
                const cpTotal = allCpData.reduce((sum, r) => sum + pFloat(r.gmv), 0);
                
                // Calculate variance
                const variance = cpTotal - affTotal;
                const variancePct = affTotal > 0 ? (variance / affTotal) * 100 : 0;
                
                // Update banner
                banner.style.display = 'flex';
                
                if (Math.abs(variancePct) <= 1) {
                    // Match
                    banner.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.1), transparent)';
                    banner.style.border = '1px solid rgba(34, 197, 94, 0.3)';
                    icon.textContent = '';
                    text.innerHTML = `<strong>Data Validated</strong> &nbsp;|&nbsp; ${daysWithAffData} day${daysWithAffData > 1 ? 's' : ''}: ${formatCurrency(affTotal)} affiliate  ${formatCurrency(cpTotal)} creator`;
                } else if (Math.abs(variancePct) <= 5) {
                    // Minor variance
                    banner.style.background = 'linear-gradient(135deg, rgba(245, 197, 24, 0.1), transparent)';
                    banner.style.border = '1px solid rgba(245, 197, 24, 0.3)';
                    icon.textContent = '';
                    text.innerHTML = `<strong>Minor Variance</strong> &nbsp;|&nbsp; ${formatCurrency(Math.abs(variance))} (${variancePct.toFixed(1)}%) ${variance > 0 ? 'over' : 'under'} affiliate total`;
                } else {
                    // Significant variance
                    banner.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.1), transparent)';
                    banner.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                    icon.textContent = '';
                    text.innerHTML = `<strong>Data Variance</strong> &nbsp;|&nbsp; ${formatCurrency(Math.abs(variance))} (${variancePct.toFixed(1)}%) ${variance > 0 ? 'over' : 'under'} affiliate total`;
                }
                
            } catch (err) {
                console.warn('Validation banner error:', err);
                banner.style.display = 'none';
            }
        }

        function renderCreatorInsights(creators) {
            // Top Performers - top 5 by GMV
            const topPerformers = creators.slice(0, 5);
            document.getElementById('creatorsTopPerformers').innerHTML = topPerformers.length ? topPerformers.map((c, i) => `
                <div class="leaderboard-item" onclick="openCreatorDetail('${c.creator_name.replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                    <div class="leaderboard-rank">${i + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.creator_name}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                    </div>
                    <div class="leaderboard-value">${fmtMoney(c.gmv)}</div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>No data</p></div>';

            // Rising Stars - top 5 by % increase (exclude new creators, require min $500 GMV)
            const risingStars = creators
                .filter(c => !c.isNew && c.change > 0 && c.gmv >= 500)
                .sort((a, b) => b.change - a.change)
                .slice(0, 5);
            document.getElementById('creatorsRisingStars').innerHTML = risingStars.length ? risingStars.map(c => `
                <div class="leaderboard-item" onclick="openCreatorDetail('${c.creator_name.replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.creator_name}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                    </div>
                    <div class="trend-indicator trend-up"> ${c.change.toFixed(0)}%</div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>No rising stars this period</p></div>';

            // Needs Attention - biggest decliners (exclude those who were already at $0)
            const needsAttention = creators
                .filter(c => c.change < 0 && c.priorGmv >= 500)
                .sort((a, b) => a.change - b.change)
                .slice(0, 5);
            document.getElementById('creatorsNeedsAttention').innerHTML = needsAttention.length ? needsAttention.map(c => `
                <div class="leaderboard-item" onclick="openCreatorDetail('${c.creator_name.replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.creator_name}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                    </div>
                    <div class="trend-indicator trend-down"> ${Math.abs(c.change).toFixed(0)}%</div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>No declining creators </p></div>';

            // Recruit Opportunities - top unmanaged by GMV (min $1000)
            const recruitOpportunities = creators
                .filter(c => !c.managed && c.gmv >= 1000)
                .sort((a, b) => b.gmv - a.gmv)
                .slice(0, 5);
            document.getElementById('creatorsRecruitOpportunities').innerHTML = recruitOpportunities.length ? recruitOpportunities.map(c => `
                <div class="leaderboard-item" style="cursor: pointer;">
                    <div class="leaderboard-info" onclick="openCreatorDetail('${c.creator_name.replace(/'/g, "\\'")}', '${c.brand}')">
                        <div class="leaderboard-name">${c.creator_name}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="gmv-value" style="font-size: 0.85rem;">${fmtMoney(c.gmv)}</span>
                        <button class="btn btn-sm" onclick="event.stopPropagation(); quickAddToRoster('${c.creator_name.replace(/'/g, "\\'")}', '${c.brand}')" style="padding: 4px 8px; font-size: 0.75rem; background: var(--accent); border: none; border-radius: 4px;">+</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>No unmanaged high-performers</p></div>';
        }

        // Bulk selection functions
        let selectedCreators = [];

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.creator-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkSelection();
        }

        function updateBulkSelection() {
            const checkboxes = document.querySelectorAll('.creator-checkbox:checked');
            selectedCreators = Array.from(checkboxes).map(cb => ({
                creator_name: cb.dataset.creator,
                brand: cb.dataset.brand
            }));
            
            const bar = document.getElementById('bulkActionsBar');
            const count = document.getElementById('selectedCount');
            
            if (selectedCreators.length > 0) {
                bar.style.display = 'flex';
                count.textContent = `${selectedCreators.length} selected`;
            } else {
                bar.style.display = 'none';
            }
        }

        function clearSelection() {
            document.querySelectorAll('.creator-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllCreators').checked = false;
            updateBulkSelection();
        }

        // Store bulk add data
        let bulkAddCreators = [];
        
        async function bulkAddToRoster() {
            if (selectedCreators.length === 0) return;
            
            const unmanaged = selectedCreators.filter(c => !isManagedForBrand(c.creator_name, c.brand));
            if (unmanaged.length === 0) {
                showToast('All selected creators are already in roster for their brands', 'info');
                return;
            }
            
            // Open enhanced modal instead of direct insert
            openBulkAddModal(unmanaged);
        }
        
        function openBulkAddModal(creators) {
            bulkAddCreators = creators.map(c => ({
                ...c,
                selected: true,
                discord: '',
                role: 'Incubator',
                status: 'Active',
                suggestedRole: suggestRoleByGmv(c.gmv),
                crossBrandMatch: findCrossBrandMatch(c.creator_name)
            }));
            
            // Check for cross-brand matches
            const crossBrandMatches = bulkAddCreators.filter(c => c.crossBrandMatch);
            if (crossBrandMatches.length > 0) {
                document.getElementById('crossBrandHint').style.display = 'block';
                document.getElementById('crossBrandMessage').textContent = 
                    `${crossBrandMatches.length} creator(s) found in other brands. Click "Match" to auto-fill info.`;
            } else {
                document.getElementById('crossBrandHint').style.display = 'none';
            }
            
            // Apply auto-suggest if enabled
            if (document.getElementById('bulkAutoSuggestRole').checked) {
                bulkAddCreators.forEach(c => c.role = c.suggestedRole);
            }
            
            renderBulkAddTable();
            updateBulkAddCount();
            document.getElementById('bulkAddModal').classList.add('show');
        }
        
        function closeBulkAddModal() {
            document.getElementById('bulkAddModal').classList.remove('show');
            bulkAddCreators = [];
        }
        
        function suggestRoleByGmv(gmv) {
            const amount = parseFloat(gmv) || 0;
            if (amount >= 1000) return 'Closer';
            if (amount >= 500) return 'Closer';
            return 'Incubator';
        }
        
        function findCrossBrandMatch(creatorName) {
            const normalized = normalizeTikTok(creatorName);
            if (!normalized) return null;
            
            return managedCreators.find(mc => 
                normalizeTikTok(mc.account_1) === normalized ||
                normalizeTikTok(mc.account_2) === normalized ||
                normalizeTikTok(mc.account_3) === normalized ||
                normalizeTikTok(mc.account_4) === normalized ||
                normalizeTikTok(mc.account_5) === normalized
            );
        }
        
        function renderBulkAddTable() {
            const tbody = document.getElementById('bulkAddTableBody');
            tbody.innerHTML = bulkAddCreators.map((c, i) => `
                <tr style="border-bottom: 1px solid var(--border); ${c.crossBrandMatch ? 'background: var(--blue-dim);' : ''}">
                    <td style="padding: 10px;">
                        <input type="checkbox" ${c.selected ? 'checked' : ''} onchange="toggleBulkCreator(${i})">
                    </td>
                    <td style="padding: 10px;">
                        <a href="https://tiktok.com/@${c.creator_name}" target="_blank" style="color: var(--accent);">@${c.creator_name}</a>
                    </td>
                    <td style="padding: 10px;">
                        <span class="badge" style="background: var(--bg-secondary);">${BRAND_DISPLAY[c.brand] || c.brand}</span>
                    </td>
                    <td style="padding: 10px; text-align: right; font-weight: 600; color: var(--success);">
                        $${parseFloat(c.gmv || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                    </td>
                    <td style="padding: 10px;">
                        <input type="text" class="form-input" style="padding: 6px 10px; font-size: 0.85rem;" 
                            placeholder="Discord username" 
                            value="${c.discord || ''}"
                            onchange="updateBulkCreator(${i}, 'discord', this.value)"
                            list="discordSuggestions">
                    </td>
                    <td style="padding: 10px;">
                        <select class="form-input" style="padding: 6px 10px; font-size: 0.85rem;" onchange="updateBulkCreator(${i}, 'role', this.value)">
                            <option value="Incubator" ${c.role === 'Incubator' ? 'selected' : ''}>Incubator</option>
                            <option value="Closer" ${c.role === 'Closer' ? 'selected' : ''}>Closer</option>
                            <option value="Creatives" ${c.role === 'Creatives' ? 'selected' : ''}>Creatives</option>
                        </select>
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        ${c.crossBrandMatch ? `
                            <button class="btn btn-small" style="padding: 4px 8px; font-size: 0.75rem; background: var(--blue); color: white;" 
                                onclick="applyBulkMatch(${i})" title="Copy from ${BRAND_DISPLAY[c.crossBrandMatch.brand]}">
                                
                            </button>
                        ` : '<span style="color: var(--text-muted);"></span>'}
                    </td>
                </tr>
            `).join('');
            
            // Add datalist for Discord suggestions
            const existingDiscords = [...new Set(managedCreators.map(mc => mc.discord_name).filter(Boolean))];
            const datalist = document.createElement('datalist');
            datalist.id = 'discordSuggestions';
            datalist.innerHTML = existingDiscords.slice(0, 100).map(d => `<option value="${d}">`).join('');
            const existing = document.getElementById('discordSuggestions');
            if (existing) existing.remove();
            document.body.appendChild(datalist);
        }
        
        function toggleBulkCreator(index) {
            bulkAddCreators[index].selected = !bulkAddCreators[index].selected;
            updateBulkAddCount();
        }
        
        function toggleBulkSelectAll() {
            const checked = document.getElementById('bulkSelectAll').checked;
            bulkAddCreators.forEach(c => c.selected = checked);
            renderBulkAddTable();
            updateBulkAddCount();
        }
        
        function updateBulkCreator(index, field, value) {
            bulkAddCreators[index][field] = value;
            updateBulkAddCount();
        }
        
        function applyBulkMatch(index) {
            const match = bulkAddCreators[index].crossBrandMatch;
            if (!match) return;
            
            bulkAddCreators[index].discord = match.discord_name || '';
            bulkAddCreators[index].email = match.email || '';
            bulkAddCreators[index].realName = match.real_name || '';
            
            renderBulkAddTable();
            showToast(`Copied info from ${BRAND_DISPLAY[match.brand]} entry`, 'success');
        }
        
        function applyBulkRole() {
            const role = document.getElementById('bulkAddRole').value;
            bulkAddCreators.forEach(c => c.role = role);
            renderBulkAddTable();
        }
        
        function applyBulkStatus() {
            const status = document.getElementById('bulkAddStatus').value;
            bulkAddCreators.forEach(c => c.status = status);
        }
        
        function recalculateSuggestedRoles() {
            const autoSuggest = document.getElementById('bulkAutoSuggestRole').checked;
            if (autoSuggest) {
                bulkAddCreators.forEach(c => c.role = suggestRoleByGmv(c.gmv));
            } else {
                const defaultRole = document.getElementById('bulkAddRole').value;
                bulkAddCreators.forEach(c => c.role = defaultRole);
            }
            renderBulkAddTable();
        }
        
        function updateBulkAddCount() {
            const selected = bulkAddCreators.filter(c => c.selected);
            const missingDiscord = selected.filter(c => !c.discord || !c.discord.trim());
            
            document.getElementById('bulkAddCount').textContent = selected.length;
            
            if (missingDiscord.length > 0 && missingDiscord.length < selected.length) {
                document.getElementById('bulkAddWarning').style.display = 'inline';
                document.getElementById('bulkAddWarningCount').textContent = missingDiscord.length;
            } else {
                document.getElementById('bulkAddWarning').style.display = 'none';
            }
        }
        
        async function submitBulkAdd() {
            const selected = bulkAddCreators.filter(c => c.selected);
            if (selected.length === 0) {
                showToast('No creators selected', 'error');
                return;
            }
            
            // Check for missing Discord
            const missingDiscord = selected.filter(c => !c.discord || !c.discord.trim());
            if (missingDiscord.length > 0) {
                if (!confirm(`${missingDiscord.length} creator(s) are missing Discord names. They'll be harder to track. Continue anyway?`)) {
                    return;
                }
            }
            
            try {
                const records = selected.map(c => ({
                    brand: c.brand,
                    role: c.role,
                    status: c.status || 'Active',
                    account_1: normalizeTikTok(c.creator_name),
                    discord_name: c.discord?.trim() || null,
                    real_name: c.realName || null,
                    email: c.email || null,
                    notes: `Added from performance data on ${new Date().toLocaleDateString()}`
                }));
                
                const { error } = await supabaseClient.from('managed_creators').insert(records);
                
                if (error) throw error;
                
                showToast(`Added ${selected.length} creators to roster!`, 'success');
                logActivity('add', `Bulk added ${selected.length} creators to roster`);
                closeBulkAddModal();
                clearSelection();
                await loadManagedCreators();
                loadCreatorsData();
            } catch (err) {
                console.error('Error bulk adding:', err);
                showToast('Error adding creators: ' + err.message, 'error');
            }
        }
        
        async function addBulkWithoutDiscord() {
            const selected = bulkAddCreators.filter(c => c.selected);
            if (selected.length === 0) {
                showToast('No creators selected', 'error');
                return;
            }
            
            if (!confirm(`Quick add ${selected.length} creators without Discord info?`)) return;
            
            try {
                const records = selected.map(c => ({
                    brand: c.brand,
                    role: c.role,
                    status: c.status || 'Active',
                    account_1: normalizeTikTok(c.creator_name),
                    notes: `Quick added from performance data on ${new Date().toLocaleDateString()}`
                }));
                
                const { error } = await supabaseClient.from('managed_creators').insert(records);
                
                if (error) throw error;
                
                showToast(`Quick added ${selected.length} creators!`, 'success');
                closeBulkAddModal();
                clearSelection();
                await loadManagedCreators();
                loadCreatorsData();
            } catch (err) {
                console.error('Error quick adding:', err);
                showToast('Error adding creators: ' + err.message, 'error');
            }
        }
        
        // ==================== CSV IMPORT ====================
        let csvImportData = [];
        
        function openCSVImportModal() {
            document.getElementById('csvImportModal').classList.add('show');
            document.getElementById('csvPreviewSection').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            csvImportData = [];
        }
        
        function closeCSVImportModal() {
            document.getElementById('csvImportModal').classList.remove('show');
            csvImportData = [];
        }
        
        function downloadCSVTemplate() {
            const template = 'tiktok,discord,name,email,brand,role\nexample_user,ExampleDiscord#1234,John Doe,john@email.com,catakor,Incubator\n';
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'roster-import-template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    parseCSV(csv);
                } catch (err) {
                    showToast('Error reading CSV: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length < 2) {
                showToast('CSV must have at least a header row and one data row', 'error');
                return;
            }
            
            // Parse header
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const tiktokCol = headers.findIndex(h => ['tiktok', 'tiktok_handle', 'handle', 'account', 'username'].includes(h));
            const discordCol = headers.findIndex(h => ['discord', 'discord_name', 'discord_username'].includes(h));
            const nameCol = headers.findIndex(h => ['name', 'real_name', 'full_name'].includes(h));
            const emailCol = headers.findIndex(h => ['email', 'email_address'].includes(h));
            const brandCol = headers.findIndex(h => ['brand'].includes(h));
            const roleCol = headers.findIndex(h => ['role'].includes(h));
            
            if (tiktokCol === -1) {
                showToast('CSV must have a "tiktok" column', 'error');
                return;
            }
            
            // Parse rows
            csvImportData = [];
            const defaultBrand = document.getElementById('rosterBrandFilter')?.value || 'catakor';
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (!values[tiktokCol]) continue;
                
                csvImportData.push({
                    tiktok: normalizeTikTok(values[tiktokCol]) || values[tiktokCol],
                    discord: discordCol >= 0 ? values[discordCol] : '',
                    name: nameCol >= 0 ? values[nameCol] : '',
                    email: emailCol >= 0 ? values[emailCol] : '',
                    brand: brandCol >= 0 && values[brandCol] ? values[brandCol].toLowerCase().replace(/[^a-z_]/g, '_') : defaultBrand,
                    role: roleCol >= 0 && values[roleCol] ? values[roleCol] : 'Incubator'
                });
            }
            
            // Show preview
            document.getElementById('csvPreviewSection').style.display = 'block';
            document.getElementById('csvPreviewCount').textContent = csvImportData.length;
            
            // Render preview table (first 5 rows)
            const previewHead = document.getElementById('csvPreviewHead');
            const previewBody = document.getElementById('csvPreviewBody');
            
            previewHead.innerHTML = `<tr style="background: var(--bg-secondary);">
                <th style="padding: 8px; text-align: left;">TikTok</th>
                <th style="padding: 8px; text-align: left;">Discord</th>
                <th style="padding: 8px; text-align: left;">Name</th>
                <th style="padding: 8px; text-align: left;">Brand</th>
                <th style="padding: 8px; text-align: left;">Role</th>
            </tr>`;
            
            previewBody.innerHTML = csvImportData.slice(0, 5).map(row => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 8px;">@${row.tiktok}</td>
                    <td style="padding: 8px;">${row.discord || '<span style="color: var(--text-muted);"></span>'}</td>
                    <td style="padding: 8px;">${row.name || '<span style="color: var(--text-muted);"></span>'}</td>
                    <td style="padding: 8px;">${BRAND_DISPLAY[row.brand] || row.brand}</td>
                    <td style="padding: 8px;">${row.role}</td>
                </tr>
            `).join('');
            
            if (csvImportData.length > 5) {
                previewBody.innerHTML += `<tr><td colspan="5" style="padding: 8px; text-align: center; color: var(--text-muted);">... and ${csvImportData.length - 5} more</td></tr>`;
            }
            
            // Check for existing/duplicates
            const existing = csvImportData.filter(row => {
                return managedCreators.some(mc => 
                    mc.brand === row.brand && (
                        normalizeTikTok(mc.account_1) === row.tiktok ||
                        normalizeTikTok(mc.account_2) === row.tiktok ||
                        normalizeTikTok(mc.account_3) === row.tiktok
                    )
                );
            });
            
            const newRows = csvImportData.length - existing.length;
            
            document.getElementById('csvImportStats').innerHTML = `
                <div style="display: flex; gap: 24px;">
                    <div><strong style="color: var(--success);">${newRows}</strong> new creators</div>
                    <div><strong style="color: var(--warning);">${existing.length}</strong> already in roster (will skip)</div>
                </div>
            `;
            
            document.getElementById('csvImportBtn').disabled = newRows === 0;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        async function executeCSVImport() {
            if (csvImportData.length === 0) {
                showToast('No data to import', 'error');
                return;
            }
            
            // Filter out existing
            const toImport = csvImportData.filter(row => {
                return !managedCreators.some(mc => 
                    mc.brand === row.brand && (
                        normalizeTikTok(mc.account_1) === row.tiktok ||
                        normalizeTikTok(mc.account_2) === row.tiktok ||
                        normalizeTikTok(mc.account_3) === row.tiktok
                    )
                );
            });
            
            if (toImport.length === 0) {
                showToast('All creators already in roster', 'info');
                return;
            }
            
            if (!confirm(`Import ${toImport.length} new creators?`)) return;
            
            try {
                const records = toImport.map(row => ({
                    brand: row.brand,
                    role: row.role,
                    status: 'Active',
                    account_1: row.tiktok,
                    discord_name: row.discord || null,
                    real_name: row.name || null,
                    email: row.email || null,
                    notes: `Imported via CSV on ${new Date().toLocaleDateString()}`
                }));
                
                const { error } = await supabaseClient.from('managed_creators').insert(records);
                
                if (error) throw error;
                
                showToast(`Imported ${toImport.length} creators!`, 'success');
                logActivity('add', `CSV imported ${toImport.length} creators`);
                closeCSVImportModal();
                await loadManagedCreators();
                loadRosterData();
            } catch (err) {
                console.error('Error importing CSV:', err);
                showToast('Import failed: ' + err.message, 'error');
            }
        }
        
        // Drag and drop for CSV
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('csvDropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--accent)';
                    dropZone.style.background = 'var(--accent-dim)';
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = 'var(--border)';
                    dropZone.style.background = 'transparent';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--border)';
                    dropZone.style.background = 'transparent';
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        document.getElementById('csvFileInput').files = e.dataTransfer.files;
                        handleCSVUpload({ target: { files: [file] } });
                    } else {
                        showToast('Please drop a CSV file', 'error');
                    }
                });
            }
        });

        // Search input debounce
        let creatorsSearchTimeout;
        document.getElementById('creatorsSearchInput').addEventListener('input', () => {
            clearTimeout(creatorsSearchTimeout);
            creatorsSearchTimeout = setTimeout(() => {
                pages.creators = 1;
                loadCreatorsData();
            }, 300);
        });

        // ==================== CREATOR LEADERBOARD ====================
        let leaderboardPeriod = 'week';
        let leaderboardData = [];
        
        function toggleCreatorsView(view) {
            const tableContainer = document.getElementById('creatorsTable');
            const leaderboardContainer = document.getElementById('creatorsLeaderboard');
            const toggleBtns = document.querySelectorAll('#view-creators .view-toggle-btn');
            
            toggleBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'leaderboard') {
                tableContainer.classList.remove('active');
                tableContainer.style.display = 'none';
                leaderboardContainer.classList.add('active');
                leaderboardContainer.style.display = 'block';
                loadLeaderboard(leaderboardPeriod);
            } else {
                leaderboardContainer.classList.remove('active');
                leaderboardContainer.style.display = 'none';
                tableContainer.classList.add('active');
                tableContainer.style.display = 'block';
            }
        }
        
        async function loadLeaderboard(period) {
            if (period) {
                leaderboardPeriod = period;
                // Update active button
                document.querySelectorAll('.leaderboard-period-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent.toLowerCase().includes(period === 'alltime' ? 'all time' : period));
                });
            }
            
            // Update period label for download card
            const periodLabels = {
                'week': 'This Week',
                'month': 'This Month',
                'quarter': 'This Quarter',
                'alltime': 'All Time'
            };
            const periodLabel = document.getElementById('podiumPeriodLabel');
            if (periodLabel) {
                const brandFilter = document.getElementById('leaderboardBrandFilter')?.value || 'all';
                const brandText = brandFilter !== 'all' ? `  ${BRAND_DISPLAY[brandFilter] || brandFilter}` : '';
                periodLabel.textContent = (periodLabels[leaderboardPeriod] || 'This Week') + brandText;
            }
            
            const brand = document.getElementById('leaderboardBrandFilter')?.value || 'all';
            
            // Calculate date range
            const now = new Date();
            let startDate, endDate;
            endDate = now.toISOString().split('T')[0];
            
            switch(leaderboardPeriod) {
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    startDate = weekStart.toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    startDate = quarterStart.toISOString().split('T')[0];
                    break;
                case 'alltime':
                    startDate = '2020-01-01';
                    break;
            }
            
            try {
                // Fetch aggregated creator data with pagination
                let allData = [];
                let page = 0;
                let hasMore = true;
                
                while (hasMore) {
                    let query = supabaseClient
                        .from('creator_performance')
                        .select('creator_name, brand, gmv, orders')
                        .gte('report_date', startDate)
                        .lte('report_date', endDate)
                        .range(page * 1000, (page + 1) * 1000 - 1);
                    
                    if (brand !== 'all') {
                        query = query.eq('brand', brand);
                    }
                    
                    const { data, error } = await query;
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        hasMore = data.length === 1000;
                        page++;
                    } else {
                        hasMore = false;
                    }
                }
                
                // Aggregate by creator
                const creatorMap = {};
                allData.forEach(row => {
                    const key = row.creator_name;
                    if (!creatorMap[key]) {
                        creatorMap[key] = {
                            name: row.creator_name,
                            brand: row.brand,
                            gmv: 0,
                            orders: 0
                        };
                    }
                    creatorMap[key].gmv += parseFloat(row.gmv) || 0;
                    creatorMap[key].orders += parseInt(row.orders) || 0;
                });
                
                // Convert to array and sort by GMV
                leaderboardData = Object.values(creatorMap)
                    .sort((a, b) => b.gmv - a.gmv)
                    .slice(0, 50); // Top 50
                
                renderLeaderboard();
                
            } catch (err) {
                console.error('Error loading leaderboard:', err);
                showToast('Error loading leaderboard', 'error');
            }
        }
        
        function renderLeaderboard() {
            // Render podium (top 3)
            const podium = document.getElementById('leaderboardPodium');
            if (podium && leaderboardData.length >= 3) {
                const places = ['second', 'first', 'third'];
                const indices = [1, 0, 2];
                const icons = ['', '', ''];
                const baseIcons = ['', '', ''];
                
                podium.innerHTML = indices.map((idx, i) => {
                    const creator = leaderboardData[idx];
                    if (!creator) return '';
                    return `
                        <div class="podium-place ${places[i]}">
                            <div class="podium-avatar">${icons[i]}<div class="podium-rank">${idx + 1}</div></div>
                            <div class="podium-name" title="${creator.name}">${creator.name}</div>
                            <div class="podium-gmv">${fmtMoney(creator.gmv)}</div>
                            <div class="podium-brand">${BRAND_DISPLAY[creator.brand] || creator.brand}</div>
                            <div class="podium-base">${baseIcons[i]}</div>
                        </div>
                    `;
                }).join('');
            } else if (podium) {
                podium.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">Not enough data for podium</div>';
            }
            
            // Render list (4th place and beyond)
            const list = document.getElementById('leaderboardList');
            if (!list) return;
            
            const restOfList = leaderboardData.slice(3);
            
            if (restOfList.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No additional creators to display</div>';
                return;
            }
            
            list.innerHTML = restOfList.map((creator, idx) => {
                const rank = idx + 4;
                return `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">${rank}</div>
                        <div class="leaderboard-creator">
                            <div class="leaderboard-avatar">${getCreatorEmoji(creator.name)}</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${creator.name}</div>
                                <div class="leaderboard-brand">${BRAND_DISPLAY[creator.brand] || creator.brand}</div>
                            </div>
                        </div>
                        <div class="leaderboard-stats">
                            <div class="leaderboard-stat gmv">
                                <div class="value">${fmtMoney(creator.gmv)}</div>
                                <div class="label">GMV</div>
                            </div>
                            <div class="leaderboard-stat">
                                <div class="value">${(creator.orders || 0).toLocaleString()}</div>
                                <div class="label">Orders</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getCreatorEmoji(name) {
            // Generate consistent emoji based on name
            const emojis = ['', '', '', '', '', '', '', '', '', ''];
            const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return emojis[hash % emojis.length];
        }
        
        async function downloadPodiumImage() {
            if (leaderboardData.length < 3) {
                showToast('Need at least 3 creators for podium image', 'warning');
                return;
            }
            
            showToast('Creating high-quality image...', 'info');
            
            try {
                const width = 800;
                const height = 500;
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                const creators = [
                    { ...leaderboardData[0], place: 1 },
                    { ...leaderboardData[1], place: 2 },
                    { ...leaderboardData[2], place: 3 }
                ];
                
                const periodLabels = { week: 'This Week', month: 'This Month', quarter: 'This Quarter', alltime: 'All Time' };
                const periodText = periodLabels[leaderboardPeriod] || 'This Week';
                const brandFilter = document.getElementById('leaderboardBrandFilter')?.value || 'all';
                const brandText = brandFilter !== 'all' ? BRAND_DISPLAY[brandFilter] || brandFilter : 'All Brands';
                
                // === BACKGROUND ===
                const bgGrad = ctx.createLinearGradient(0, 0, 0, height);
                bgGrad.addColorStop(0, '#1a1a2e');
                bgGrad.addColorStop(1, '#16213e');
                ctx.fillStyle = bgGrad;
                ctx.fillRect(0, 0, width, height);
                
                // Subtle glow at top
                const glow = ctx.createRadialGradient(width/2, 0, 0, width/2, 0, 300);
                glow.addColorStop(0, 'rgba(255, 215, 0, 0.1)');
                glow.addColorStop(1, 'rgba(255, 215, 0, 0)');
                ctx.fillStyle = glow;
                ctx.fillRect(0, 0, width, height);
                
                // === HEADER ===
                ctx.textAlign = 'center';
                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 32px Arial';
                ctx.fillText(' TOP CREATORS ', width/2, 45);
                
                ctx.fillStyle = '#8899aa';
                ctx.font = '14px Arial';
                ctx.fillText(periodText + '  ' + brandText, width/2, 70);
                
                // === PODIUM CONFIG ===
                const podiumBase = 400; // Y position of podium bottom
                const podiums = [
                    { x: width/2, h: 140, w: 140, color: '#ffd700', darkColor: '#b8860b', idx: 0 },      // 1st - center
                    { x: width/2 - 170, h: 100, w: 120, color: '#c0c0c0', darkColor: '#808080', idx: 1 }, // 2nd - left
                    { x: width/2 + 170, h: 70, w: 120, color: '#cd7f32', darkColor: '#8b4513', idx: 2 }   // 3rd - right
                ];
                
                // Draw podiums back to front (3rd, 2nd, 1st)
                [2, 1, 0].forEach(i => {
                    const pod = podiums[i];
                    const creator = creators[pod.idx];
                    const podTop = podiumBase - pod.h;
                    
                    // Shadow
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                    ctx.beginPath();
                    ctx.ellipse(pod.x, podiumBase + 10, pod.w/2 + 5, 8, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Podium body with 3D gradient
                    const podGrad = ctx.createLinearGradient(pod.x - pod.w/2, 0, pod.x + pod.w/2, 0);
                    podGrad.addColorStop(0, pod.darkColor);
                    podGrad.addColorStop(0.2, pod.color);
                    podGrad.addColorStop(0.8, pod.color);
                    podGrad.addColorStop(1, pod.darkColor);
                    ctx.fillStyle = podGrad;
                    
                    // Rounded top podium
                    ctx.beginPath();
                    const r = 10;
                    ctx.moveTo(pod.x - pod.w/2 + r, podTop);
                    ctx.lineTo(pod.x + pod.w/2 - r, podTop);
                    ctx.quadraticCurveTo(pod.x + pod.w/2, podTop, pod.x + pod.w/2, podTop + r);
                    ctx.lineTo(pod.x + pod.w/2, podiumBase);
                    ctx.lineTo(pod.x - pod.w/2, podiumBase);
                    ctx.lineTo(pod.x - pod.w/2, podTop + r);
                    ctx.quadraticCurveTo(pod.x - pod.w/2, podTop, pod.x - pod.w/2 + r, podTop);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Top highlight
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(pod.x - pod.w/2 + 5, podTop + 3, pod.w - 10, 6);
                    
                    // Place number
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    ctx.font = 'bold 50px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(creator.place, pod.x, podiumBase - 25);
                    
                    // === CREATOR INFO (above podium) ===
                    const infoY = podTop - 20; // Base Y for info, above podium
                    
                    // Avatar circle
                    const avatarSize = i === 0 ? 40 : 32;
                    const avatarY = infoY - 50;
                    
                    ctx.beginPath();
                    ctx.arc(pod.x, avatarY, avatarSize, 0, Math.PI * 2);
                    ctx.fillStyle = '#2a2f4a';
                    ctx.fill();
                    ctx.strokeStyle = pod.color;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // Medal emoji in avatar
                    const medals = ['', '', ''];
                    ctx.font = i === 0 ? '35px Arial' : '28px Arial';
                    ctx.fillText(medals[pod.idx], pod.x, avatarY + (i === 0 ? 12 : 10));
                    
                    // Creator name
                    ctx.fillStyle = '#ffffff';
                    ctx.font = i === 0 ? 'bold 16px Arial' : '14px Arial';
                    const displayName = creator.name.length > 15 ? creator.name.substring(0, 13) + '..' : creator.name;
                    ctx.fillText(displayName, pod.x, avatarY - avatarSize - 12);
                    
                    // GMV
                    ctx.fillStyle = '#4ade80';
                    ctx.font = i === 0 ? 'bold 20px Arial' : 'bold 16px Arial';
                    ctx.fillText(fmtMoney(creator.gmv), pod.x, avatarY + avatarSize + 22);
                    
                    // Orders
                    ctx.fillStyle = '#8899aa';
                    ctx.font = '11px Arial';
                    ctx.fillText((creator.orders || 0).toLocaleString() + ' orders', pod.x, avatarY + avatarSize + 38);
                });
                
                // === SPARKLES ===
                const sparklePositions = [
                    {x: 80, y: 150}, {x: 720, y: 180}, {x: 60, y: 320}, {x: 740, y: 350}
                ];
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                sparklePositions.forEach(sp => {
                    ctx.beginPath();
                    ctx.moveTo(sp.x, sp.y - 6);
                    ctx.lineTo(sp.x + 2, sp.y - 2);
                    ctx.lineTo(sp.x + 6, sp.y);
                    ctx.lineTo(sp.x + 2, sp.y + 2);
                    ctx.lineTo(sp.x, sp.y + 6);
                    ctx.lineTo(sp.x - 2, sp.y + 2);
                    ctx.lineTo(sp.x - 6, sp.y);
                    ctx.lineTo(sp.x - 2, sp.y - 2);
                    ctx.closePath();
                    ctx.fill();
                });
                
                // === FOOTER ===
                ctx.fillStyle = '#556677';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Creators Corner  Keep crushing it! ', width/2, height - 25);
                
                ctx.fillStyle = '#334455';
                ctx.font = '10px Arial';
                ctx.fillText(new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }), width/2, height - 10);
                
                // === DOWNLOAD ===
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'leaderboard-' + (leaderboardPeriod || 'week') + '-' + new Date().toISOString().split('T')[0] + '.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Image downloaded! ', 'success');
                }, 'image/png');
                
            } catch (err) {
                console.error('Error generating image:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        // Animated GIF - Clean version with proper positioning
        async function downloadPodiumGif() {
            if (leaderboardData.length < 3) {
                showToast('Need at least 3 creators for animated GIF', 'warning');
                return;
            }
            showToast('Creating animated GIF... ~10 seconds ', 'info');
            
            try {
                const width = 600, height = 400, totalFrames = 25;
                const creators = [
                    { ...leaderboardData[0], place: 1 },
                    { ...leaderboardData[1], place: 2 },
                    { ...leaderboardData[2], place: 3 }
                ];
                const periodText = { week: 'This Week', month: 'This Month', quarter: 'This Quarter', alltime: 'All Time' }[leaderboardPeriod] || 'This Week';
                const brandFilter = document.getElementById('leaderboardBrandFilter')?.value || 'all';
                const brandText = brandFilter !== 'all' ? BRAND_DISPLAY[brandFilter] || brandFilter : 'All Brands';
                
                const canvas = document.createElement('canvas');
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                function easeOutBounce(t) { 
                    if (t < 1/2.75) return 7.5625*t*t; 
                    if (t < 2/2.75) return 7.5625*(t-=1.5/2.75)*t+.75; 
                    if (t < 2.5/2.75) return 7.5625*(t-=2.25/2.75)*t+.9375; 
                    return 7.5625*(t-=2.625/2.75)*t+.984375; 
                }
                
                const confetti = Array.from({length: 30}, () => ({ 
                    x: Math.random() * width, 
                    y: -20 - Math.random() * 80, 
                    vy: 3 + Math.random() * 3,
                    size: 5 + Math.random() * 6, 
                    color: ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96e6a1'][Math.floor(Math.random() * 5)] 
                }));
                
                const podiumBase = 320;
                const podiums = [
                    { x: width/2, h: 100, w: 110, delay: 0, color: '#ffd700', darkColor: '#b8860b' },
                    { x: width/2 - 130, h: 70, w: 95, delay: 3, color: '#c0c0c0', darkColor: '#808080' },
                    { x: width/2 + 130, h: 50, w: 95, delay: 6, color: '#cd7f32', darkColor: '#8b4513' }
                ];
                
                const frames = [];
                
                for (let f = 0; f < totalFrames; f++) {
                    // Background
                    const bgGrad = ctx.createLinearGradient(0, 0, 0, height);
                    bgGrad.addColorStop(0, '#1a1a2e');
                    bgGrad.addColorStop(1, '#16213e');
                    ctx.fillStyle = bgGrad;
                    ctx.fillRect(0, 0, width, height);
                    
                    // Confetti after frame 8
                    if (f > 8) {
                        confetti.forEach(c => {
                            c.y += c.vy;
                            if (c.y < height + 10) {
                                ctx.fillStyle = c.color;
                                ctx.globalAlpha = 0.85;
                                ctx.fillRect(c.x, c.y, c.size, c.size * 0.6);
                                ctx.globalAlpha = 1;
                            }
                        });
                    }
                    
                    // Header
                    const headerAlpha = Math.min(1, f / 6);
                    ctx.globalAlpha = headerAlpha;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#ffd700';
                    ctx.font = 'bold 24px Arial';
                    ctx.fillText('TOP CREATORS', width/2, 35);
                    ctx.fillStyle = '#8899aa';
                    ctx.font = '12px Arial';
                    ctx.fillText(periodText + ' - ' + brandText, width/2, 55);
                    ctx.globalAlpha = 1;
                    
                    // Draw podiums
                    [2, 1, 0].forEach(i => {
                        const pod = podiums[i];
                        const creator = creators[i];
                        const prog = Math.min(1, Math.max(0, (f - pod.delay) / 10));
                        const bounce = easeOutBounce(prog);
                        const h = pod.h * bounce;
                        const top = podiumBase - h;
                        
                        // Shadow
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                        ctx.beginPath();
                        ctx.ellipse(pod.x, podiumBase + 8, pod.w/2 + 3, 6, 0, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Podium with gradient
                        const podGrad = ctx.createLinearGradient(pod.x - pod.w/2, 0, pod.x + pod.w/2, 0);
                        podGrad.addColorStop(0, pod.darkColor);
                        podGrad.addColorStop(0.3, pod.color);
                        podGrad.addColorStop(0.7, pod.color);
                        podGrad.addColorStop(1, pod.darkColor);
                        ctx.fillStyle = podGrad;
                        ctx.globalAlpha = 0.5 + 0.5 * prog;
                        
                        // Rounded podium
                        ctx.beginPath();
                        const r = 6;
                        ctx.moveTo(pod.x - pod.w/2 + r, top);
                        ctx.lineTo(pod.x + pod.w/2 - r, top);
                        ctx.quadraticCurveTo(pod.x + pod.w/2, top, pod.x + pod.w/2, top + r);
                        ctx.lineTo(pod.x + pod.w/2, podiumBase);
                        ctx.lineTo(pod.x - pod.w/2, podiumBase);
                        ctx.lineTo(pod.x - pod.w/2, top + r);
                        ctx.quadraticCurveTo(pod.x - pod.w/2, top, pod.x - pod.w/2 + r, top);
                        ctx.closePath();
                        ctx.fill();
                        
                        // Highlight
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.25)';
                        ctx.fillRect(pod.x - pod.w/2 + 4, top + 2, pod.w - 8, 4);
                        
                        // Place number
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                        ctx.font = 'bold 36px Arial';
                        ctx.globalAlpha = prog;
                        ctx.fillText(creator.place, pod.x, podiumBase - 15);
                        
                        // Creator info (above podium)
                        if (prog > 0.5) {
                            const infoAlpha = (prog - 0.5) * 2;
                            ctx.globalAlpha = infoAlpha;
                            
                            const avatarY = top - 35;
                            const avatarSize = i === 0 ? 28 : 24;
                            
                            // Avatar circle
                            ctx.beginPath();
                            ctx.arc(pod.x, avatarY, avatarSize, 0, Math.PI * 2);
                            ctx.fillStyle = '#2a2f4a';
                            ctx.fill();
                            ctx.strokeStyle = pod.color;
                            ctx.lineWidth = 2;
                            ctx.stroke();
                            
                            // Medal
                            const medals = ['', '', ''];
                            ctx.font = i === 0 ? '24px Arial' : '20px Arial';
                            ctx.fillText(medals[i], pod.x, avatarY + (i === 0 ? 8 : 7));
                            
                            // Name above avatar
                            ctx.fillStyle = '#ffffff';
                            ctx.font = i === 0 ? 'bold 13px Arial' : '11px Arial';
                            const name = creator.name.length > 12 ? creator.name.slice(0, 10) + '..' : creator.name;
                            ctx.fillText(name, pod.x, avatarY - avatarSize - 8);
                            
                            // GMV below avatar
                            ctx.fillStyle = '#4ade80';
                            ctx.font = i === 0 ? 'bold 15px Arial' : 'bold 12px Arial';
                            ctx.fillText(fmtMoney(creator.gmv), pod.x, avatarY + avatarSize + 16);
                        }
                        ctx.globalAlpha = 1;
                    });
                    
                    // Footer
                    ctx.globalAlpha = Math.min(1, f / 10);
                    ctx.fillStyle = '#556677';
                    ctx.font = '10px Arial';
                    ctx.fillText('Creators Corner', width/2, height - 15);
                    ctx.globalAlpha = 1;
                    
                    frames.push(ctx.getImageData(0, 0, width, height));
                }
                
                // Minified GIF encoder
                const workerCode = 'self.onmessage=function(e){const{frames:t,width:n,height:r,delay:i}=e.data,o=[];o.push(71,73,70,56,57,97),o.push(255&n,n>>8&255),o.push(255&r,r>>8&255),o.push(247,0,0);for(let e=0;e<256;e++)o.push(e,e,e);o.push(33,255,11,78,69,84,83,67,65,80,69,50,46,48,3,1,0,0,0),t.forEach((e,s)=>{const a=new Uint8Array(e),l=new Map,c=[],u=new Uint8Array(n*r);for(let e=0;e<a.length;e+=4){const t=a[e],n=a[e+1],r=a[e+2],i=8*Math.floor(t/8),o=8*Math.floor(n/8),s=8*Math.floor(r/8),f=i<<16|o<<8|s;l.has(f)||c.length>=256||(l.set(f,c.length),c.push([i,o,s])),u[e/4]=l.get(f)||0}for(;c.length<256;)c.push([0,0,0]);const f=s<t.length-3?i:4*i;o.push(33,249,4,4,255&f,f>>8&255,0,0),o.push(44,0,0,0,0),o.push(255&n,n>>8&255,255&r,r>>8&255),o.push(135),c.forEach(e=>o.push(e[0],e[1],e[2])),o.push(8);const h=d(u,8);let p=0;for(;p<h.length;){const e=Math.min(255,h.length-p);o.push(e);for(let t=0;t<e;t++)o.push(h[p++])}o.push(0)}),o.push(59),self.postMessage(new Uint8Array(o))};function d(e,t){const n=1<<t,r=n+1,i=[];let o=t+1,s=r+1;const a=new Map;let l=0,c=0;function u(e,t){for(l|=e<<c,c+=t;c>=8;)i.push(255&l),l>>=8,c-=8}for(let e=0;e<n;e++)a.set(String(e),e);u(n,o);let f=String(e[0]);for(let t=1;t<e.length;t++){const n=String(e[t]),r=f+","+n;a.has(r)?f=r:(u(a.get(f),o),s<4096&&(a.set(r,s++),s>1<<o&&o<12&&o++),f=n)}return u(a.get(f),o),u(r,o),c>0&&i.push(255&l),i}';
                
                const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
                const worker = new Worker(URL.createObjectURL(workerBlob));
                
                worker.onmessage = function(e) {
                    const blob = new Blob([e.data], { type: 'image/gif' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'leaderboard-' + (leaderboardPeriod||'week') + '-' + new Date().toISOString().split('T')[0] + '.gif';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    worker.terminate();
                    showToast('GIF downloaded! ', 'success');
                };
                
                worker.onerror = function(err) {
                    console.error('Worker error:', err);
                    worker.terminate();
                    showToast('Error creating GIF', 'error');
                };
                
                const frameData = frames.map(f => Array.from(f.data));
                worker.postMessage({ frames: frameData, width, height, delay: 10 });
                
            } catch (err) { 
                console.error('GIF error:', err); 
                showToast('Error: ' + err.message, 'error'); 
            }
        }
        // ==================== VIDEOS ====================
        let videosCache = { filtered: [] };
        
        async function loadVideosData() {
            showLoading('videos', 'Loading video data...');
            try {
            const brand = document.getElementById('videosBrandFilter').value;
            const startDate = document.getElementById('videosDateFilterStart').value;
            const endDate = document.getElementById('videosDateFilterEnd').value;
            const status = document.getElementById('videosStatusFilter').value;
            const search = document.getElementById('videosSearchInput').value.toLowerCase();

            if (!startDate || !endDate) { hideLoading('videos'); return; }

            // Calculate prior period dates
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);

            // Fetch current period data with pagination
            let allData = [];
            let page = 0;
            const pageSize = QUERY_PAGE_SIZE;
            let hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('video_performance')
                    .select('*')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    allData = allData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Fetch prior period data for trend calculation
            let priorData = [];
            page = 0;
            hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('video_performance')
                    .select('*')
                    .gte('report_date', localDateStr(priorStart))
                    .lte('report_date', localDateStr(priorEnd))
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    priorData = priorData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Aggregate by video_id only (sum across dates and products)
            const videoMap = new Map();
            allData.forEach(row => {
                const key = row.video_id;
                if (!videoMap.has(key)) {
                    // Build proper TikTok URL from video_id and creator_name
                    const tiktokUrl = row.video_id ? `https://www.tiktok.com/@${row.creator_name}/video/${row.video_id}` : null;
                    videoMap.set(key, {
                        video_id: row.video_id,
                        video_title: row.video_title,
                        video_link: tiktokUrl,
                        creator_name: row.creator_name,
                        brand: row.brand,
                        gmv: 0, 
                        orders: 0, 
                        items_sold: 0,
                        products: new Set()
                    });
                }
                const v = videoMap.get(key);
                v.gmv += pFloat(row.gmv);
                v.orders += pInt(row.orders);
                v.items_sold += pInt(row.items_sold);
                if (row.product_name) v.products.add(row.product_name);
            });

            // Build videos array
            let videos = [...videoMap.values()].map(v => ({
                ...v,
                aov: v.orders > 0 ? v.gmv / v.orders : 0,
                managed: isManagedForBrand(v.creator_name, v.brand),
                productCount: v.products.size
            }));

            // Apply status filter
            if (status === 'managed') {
                videos = videos.filter(v => v.managed);
            } else if (status === 'unmanaged') {
                videos = videos.filter(v => !v.managed);
            }

            // Apply search filter
            if (search) {
                videos = videos.filter(v => 
                    v.video_title?.toLowerCase().includes(search) || 
                    v.creator_name?.toLowerCase().includes(search)
                );
            }

            // Sort by GMV
            videos.sort((a, b) => b.gmv - a.gmv);
            
            // Cache for export
            videosCache.filtered = videos;

            // Aggregate prior period by video for comparison
            const priorVideoMap = new Map();
            let filteredPriorData = priorData;
            if (status === 'managed') {
                filteredPriorData = priorData.filter(d => isManagedForBrand(d.creator_name, d.brand));
            } else if (status === 'unmanaged') {
                filteredPriorData = priorData.filter(d => !isManagedForBrand(d.creator_name, d.brand));
            }
            filteredPriorData.forEach(row => {
                const key = row.video_id;
                if (!priorVideoMap.has(key)) {
                    priorVideoMap.set(key, { gmv: 0, orders: 0, creator_name: row.creator_name });
                }
                const v = priorVideoMap.get(key);
                v.gmv += pFloat(row.gmv);
                v.orders += pInt(row.orders);
            });
            const priorVideos = [...priorVideoMap.values()];

            // Calculate current stats
            const totalGmv = videos.reduce((s, v) => s + v.gmv, 0);
            const totalOrders = videos.reduce((s, v) => s + v.orders, 0);
            const uniqueCreators = new Set(videos.map(v => v.creator_name)).size;
            const videosWithSales = videos.filter(v => v.gmv > 0).length;
            const conversionRate = videos.length > 0 ? (videosWithSales / videos.length * 100) : 0;
            const avgGmvPerVideo = videos.length ? totalGmv / videos.length : 0;

            // Calculate prior stats
            const priorGmv = priorVideos.reduce((s, v) => s + v.gmv, 0);
            const priorOrders = priorVideos.reduce((s, v) => s + v.orders, 0);
            const priorCreators = new Set(priorVideos.map(v => v.creator_name)).size;
            const priorVideosWithSales = priorVideos.filter(v => v.gmv > 0).length;
            const priorConversion = priorVideos.length > 0 ? (priorVideosWithSales / priorVideos.length * 100) : 0;
            const priorAvgGmv = priorVideos.length ? priorGmv / priorVideos.length : 0;

            // Update stats with trends
            document.getElementById('videosStatGmv').textContent = fmtMoney(totalGmv);
            updateTrendIndicator('videosStatGmvChange', totalGmv, priorGmv);
            
            document.getElementById('videosStatTotal').textContent = videos.length;
            updateTrendIndicator('videosStatTotalChange', videos.length, priorVideos.length);
            
            document.getElementById('videosStatCreators').textContent = uniqueCreators;
            updateTrendIndicator('videosStatCreatorsChange', uniqueCreators, priorCreators);
            
            document.getElementById('videosStatOrders').textContent = fmt(totalOrders);
            updateTrendIndicator('videosStatOrdersChange', totalOrders, priorOrders);
            
            document.getElementById('videosStatAvg').textContent = fmtMoney(avgGmvPerVideo);
            updateTrendIndicator('videosStatAvgChange', avgGmvPerVideo, priorAvgGmv);
            
            document.getElementById('videosStatConversion').textContent = conversionRate.toFixed(0) + '%';
            updateTrendIndicator('videosStatConversionChange', conversionRate, priorConversion);

            // Render insight cards
            renderVideoInsights(videos);

            // Update table count
            document.getElementById('videosTableCount').textContent = `${videos.length} videos`;

            // Paginate and render table
            const startIdx = (pages.videos - 1) * PAGE_SIZE;
            const pageData = videos.slice(startIdx, startIdx + PAGE_SIZE);

            document.getElementById('videosBody').innerHTML = pageData.map(v => {
                const hasVideo = v.video_id && v.video_id.toString().trim() !== '';
                const titleContent = hasVideo
                    ? `<span style="cursor: pointer; color: var(--text-primary); transition: color 0.2s;" onclick="openVideoEmbed('${v.video_id}', '${(v.video_title || 'Untitled').replace(/'/g, "\\'")}', ${v.gmv || 0}, ${v.orders || 0}, '${v.creator_name.replace(/'/g, "\\'")}')" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-primary)'">${v.video_title || 'Untitled'} <span style="color: var(--accent); font-size: 0.8rem;"></span></span>`
                    : (v.video_title || 'Untitled');
                
                // Format product display - show first product with count if multiple
                const productsArray = [...(v.products || [])];
                let productDisplay = '';
                if (productsArray.length === 0) {
                    productDisplay = '<span style="color: var(--text-muted); font-size: 0.85rem;"></span>';
                } else if (productsArray.length === 1) {
                    const shortName = productsArray[0].length > 25 ? productsArray[0].substring(0, 22) + '...' : productsArray[0];
                    productDisplay = `<span class="badge-product" title="${productsArray[0]}" style="font-size: 0.75rem; padding: 2px 8px; background: var(--purple-dim); color: var(--purple); border-radius: 4px;">${shortName}</span>`;
                } else {
                    const shortName = productsArray[0].length > 20 ? productsArray[0].substring(0, 17) + '...' : productsArray[0];
                    productDisplay = `<span class="badge-product" title="${productsArray.join(', ')}" style="font-size: 0.75rem; padding: 2px 8px; background: var(--purple-dim); color: var(--purple); border-radius: 4px;">${shortName} +${productsArray.length - 1}</span>`;
                }
                
                return `<tr>
                    <td><div style="max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${titleContent}</div></td>
                    <td>
                        <span class="clickable-creator" onclick="openCreatorDetail('${v.creator_name.replace(/'/g, "\\'")}', '${v.brand}')" style="cursor:pointer; color:var(--text-primary); transition: color 0.2s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-primary)'">${v.creator_name}</span>
                    </td>
                    <td><span class="badge-brand">${BRAND_DISPLAY[v.brand] || v.brand}</span></td>
                    <td>${productDisplay}</td>
                    <td><span class="badge ${v.managed ? 'badge-managed' : 'badge-unmanaged'}">${v.managed ? '' : ''}</span></td>
                    <td><span class="gmv-value gmv-high">${fmtMoney(v.gmv)}</span></td>
                    <td>${fmt(v.orders)}</td>
                    <td>${fmt(v.items_sold)}</td>
                    <td>${fmtMoney(v.aov)}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="9"><div class="empty-state"><h3>No videos found</h3><p>Try adjusting your filters</p></div></td></tr>';

            renderPagination('videosPagination', videos.length, pages.videos, (p) => { pages.videos = p; loadVideosData(); });
            } finally {
                hideLoading('videos');
            }
        }

        function renderVideoInsights(videos) {
            // Top Performing Videos - top 5 by GMV
            const topPerforming = videos.slice(0, 5);
            document.getElementById('videosTopPerforming').innerHTML = topPerforming.length ? topPerforming.map((v, i) => {
                const hasVideo = v.video_id && v.video_id.toString().trim() !== '';
                return `
                <div class="leaderboard-item" style="cursor: ${hasVideo ? 'pointer' : 'default'};" ${hasVideo ? `onclick="openVideoEmbed('${v.video_id}', '${(v.video_title || 'Untitled').replace(/'/g, "\\'")}', ${v.gmv || 0}, ${v.orders || 0}, '${v.creator_name.replace(/'/g, "\\'")}')"` : ''}>
                    <div class="leaderboard-rank">${i + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name" style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${v.video_title || 'Untitled'}</div>
                        <div class="leaderboard-brand">${v.creator_name}</div>
                    </div>
                    <div class="leaderboard-value">${fmtMoney(v.gmv)}</div>
                </div>
            `;}).join('') : '<div class="empty-state" style="padding: 20px;"><p>No videos</p></div>';

            // Top Creators by Video GMV - aggregate by creator
            const creatorGmv = new Map();
            videos.forEach(v => {
                if (!creatorGmv.has(v.creator_name)) {
                    creatorGmv.set(v.creator_name, { name: v.creator_name, brand: v.brand, gmv: 0, videoCount: 0 });
                }
                const c = creatorGmv.get(v.creator_name);
                c.gmv += v.gmv;
                c.videoCount++;
            });
            const topCreators = [...creatorGmv.values()].sort((a, b) => b.gmv - a.gmv).slice(0, 5);
            
            document.getElementById('videosTopCreators').innerHTML = topCreators.length ? topCreators.map((c, i) => `
                <div class="leaderboard-item" onclick="openCreatorDetail('${c.name.replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                    <div class="leaderboard-rank">${i + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.name}</div>
                        <div class="leaderboard-brand">${c.videoCount} videos</div>
                    </div>
                    <div class="leaderboard-value">${fmtMoney(c.gmv)}</div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>No creators</p></div>';

            // Most Efficient - creators with best GMV per video (min 3 videos)
            const efficientCreators = [...creatorGmv.values()]
                .filter(c => c.videoCount >= 3)
                .map(c => ({ ...c, gmvPerVideo: c.gmv / c.videoCount }))
                .sort((a, b) => b.gmvPerVideo - a.gmvPerVideo)
                .slice(0, 5);
            
            document.getElementById('videosMostEfficient').innerHTML = efficientCreators.length ? efficientCreators.map(c => `
                <div class="leaderboard-item" onclick="openCreatorDetail('${c.name.replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.name}</div>
                        <div class="leaderboard-brand">${c.videoCount} videos</div>
                    </div>
                    <div class="leaderboard-value">${fmtMoney(c.gmvPerVideo)}<span style="font-size: 0.7rem; color: var(--text-muted);">/vid</span></div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>Min 3 videos required</p></div>';
        }

        function exportVideos() {
            if (!videosCache.filtered.length) {
                showToast('No data to export', 'error');
                return;
            }
            
            const headers = ['Video Title', 'Video ID', 'Creator', 'Brand', 'Status', 'GMV', 'Orders', 'Items', 'AOV', 'TikTok URL'];
            const rows = videosCache.filtered.map(v => {
                const tiktokUrl = v.video_id ? `https://www.tiktok.com/@${v.creator_name}/video/${v.video_id}` : '';
                return [
                    v.video_title || 'Untitled',
                    v.video_id || '',
                    v.creator_name,
                    BRAND_DISPLAY[v.brand] || v.brand,
                    v.managed ? 'Managed' : 'Unmanaged',
                    v.gmv.toFixed(2),
                    v.orders,
                    v.items_sold,
                    v.aov.toFixed(2),
                    tiktokUrl
                ];
            });
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `videos-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${videosCache.filtered.length} videos!`, 'success');
        }

        // Search input debounce for videos
        let videosSearchTimeout;
        document.getElementById('videosSearchInput').addEventListener('input', () => {
            clearTimeout(videosSearchTimeout);
            videosSearchTimeout = setTimeout(() => {
                pages.videos = 1;
                loadVideosData();
            }, 300);
        });

        // ==================== PRODUCTS ====================
        let productsCache = { filtered: [] };
        let productsChannelChartInstance = null;
        
        async function loadProductsData() {
            showLoading('products', 'Loading product data...');
            try {
            const brand = document.getElementById('productsBrandFilter').value;
            const startDate = document.getElementById('productsDateFilterStart').value;
            const endDate = document.getElementById('productsDateFilterEnd').value;
            const search = document.getElementById('productsSearchInput')?.value?.toLowerCase() || '';

            if (!startDate || !endDate) { hideLoading('products'); return; }

            // Calculate prior period dates
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);

            // Fetch current period data with pagination
            let allData = [];
            let page = 0;
            const pageSize = QUERY_PAGE_SIZE;
            let hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('product_performance')
                    .select('*')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    allData = allData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Fetch prior period data for trends
            let priorData = [];
            page = 0;
            hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('product_performance')
                    .select('*')
                    .gte('report_date', localDateStr(priorStart))
                    .lte('report_date', localDateStr(priorEnd))
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    priorData = priorData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Aggregate by product_id
            const productMap = new Map();
            allData.forEach(row => {
                const key = `${row.product_id}|||${row.brand}`;
                if (!productMap.has(key)) {
                    productMap.set(key, {
                        product_id: row.product_id,
                        product_name: row.product_name,
                        brand: row.brand,
                        status: row.status,
                        gmv: 0, orders: 0, items_sold: 0,
                        video_gmv: 0, live_gmv: 0, shop_tab_gmv: 0
                    });
                }
                const p = productMap.get(key);
                p.gmv += pFloat(row.gmv);
                p.orders += pInt(row.orders);
                p.items_sold += pInt(row.items_sold);
                p.video_gmv += pFloat(row.video_gmv);
                p.live_gmv += pFloat(row.live_gmv);
                p.shop_tab_gmv += pFloat(row.shop_tab_gmv);
            });

            let products = [...productMap.values()];

            // Apply search filter
            if (search) {
                products = products.filter(p => p.product_name?.toLowerCase().includes(search));
            }

            // Sort by GMV
            products.sort((a, b) => b.gmv - a.gmv);
            
            // Cache for export
            productsCache.filtered = products;

            // Aggregate prior period for trends
            const priorProductMap = new Map();
            priorData.forEach(row => {
                const key = `${row.product_id}|||${row.brand}`;
                if (!priorProductMap.has(key)) {
                    priorProductMap.set(key, { gmv: 0, orders: 0, items_sold: 0 });
                }
                const p = priorProductMap.get(key);
                p.gmv += pFloat(row.gmv);
                p.orders += pInt(row.orders);
                p.items_sold += pInt(row.items_sold);
            });
            const priorProducts = [...priorProductMap.values()];

            // Calculate current stats
            const totalGmv = products.reduce((s, p) => s + p.gmv, 0);
            const totalOrders = products.reduce((s, p) => s + p.orders, 0);
            const totalItems = products.reduce((s, p) => s + p.items_sold, 0);
            const totalVideoGmv = products.reduce((s, p) => s + p.video_gmv, 0);
            const totalLiveGmv = products.reduce((s, p) => s + p.live_gmv, 0);
            const totalShopGmv = products.reduce((s, p) => s + p.shop_tab_gmv, 0);

            // Calculate prior stats
            const priorGmv = priorProducts.reduce((s, p) => s + p.gmv, 0);
            const priorOrders = priorProducts.reduce((s, p) => s + p.orders, 0);
            const priorItems = priorProducts.reduce((s, p) => s + p.items_sold, 0);

            // Update stats with trends
            document.getElementById('productsStatGmv').textContent = fmtMoney(totalGmv);
            updateTrendIndicator('productsStatGmvChange', totalGmv, priorGmv);
            
            document.getElementById('productsStatTotal').textContent = products.length;
            updateTrendIndicator('productsStatTotalChange', products.length, priorProductMap.size);
            
            document.getElementById('productsStatOrders').textContent = fmt(totalOrders);
            updateTrendIndicator('productsStatOrdersChange', totalOrders, priorOrders);
            
            document.getElementById('productsStatItems').textContent = fmt(totalItems);
            updateTrendIndicator('productsStatItemsChange', totalItems, priorItems);
            
            document.getElementById('productsStatVideoGmv').textContent = fmtMoney(totalVideoGmv);
            document.getElementById('productsStatVideoPct').textContent = totalGmv > 0 ? `${(totalVideoGmv / totalGmv * 100).toFixed(0)}% of total` : '--% of total';
            document.getElementById('productsStatLiveGmv').textContent = fmtMoney(totalLiveGmv);
            document.getElementById('productsStatLivePct').textContent = totalGmv > 0 ? `${(totalLiveGmv / totalGmv * 100).toFixed(0)}% of total` : '--% of total';

            // Render insights
            renderProductInsights(products, totalVideoGmv, totalLiveGmv, totalShopGmv);

            // Update table count
            document.getElementById('productsTableCount').textContent = `${products.length} products`;

            // Paginate and render table
            const startIdx = (pages.products - 1) * PAGE_SIZE;
            const pageData = products.slice(startIdx, startIdx + PAGE_SIZE);

            document.getElementById('productsBody').innerHTML = pageData.map(p => `<tr>
                <td><div style="max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight:500;">${p.product_name || 'Unknown'}</div></td>
                <td><span class="badge-brand">${BRAND_DISPLAY[p.brand] || p.brand}</span></td>
                <td><span class="badge ${p.status === 'Active' ? 'badge-managed' : 'badge-unmanaged'}">${p.status || 'Unknown'}</span></td>
                <td><span class="gmv-value gmv-high">${fmtMoney(p.gmv)}</span></td>
                <td>${fmt(p.orders)}</td>
                <td>${fmt(p.items_sold)}</td>
                <td>${fmtMoney(p.video_gmv)}</td>
                <td>${fmtMoney(p.live_gmv)}</td>
                <td>${fmtMoney(p.shop_tab_gmv)}</td>
            </tr>`).join('') || '<tr><td colspan="9"><div class="empty-state"><h3>No products found</h3><p>Try adjusting your filters</p></div></td></tr>';

            renderPagination('productsPagination', products.length, pages.products, (p) => { pages.products = p; loadProductsData(); });
            } finally {
                hideLoading('products');
            }
        }

        function renderProductInsights(products, totalVideoGmv, totalLiveGmv, totalShopGmv) {
            // Top Products - top 5 by GMV
            const topProducts = products.slice(0, 5);
            document.getElementById('productsTopList').innerHTML = topProducts.length ? topProducts.map((p, i) => `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank">${i + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.product_name || 'Unknown'}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[p.brand] || p.brand}</div>
                    </div>
                    <div class="leaderboard-value">${fmtMoney(p.gmv)}</div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>No products</p></div>';

            // Channel Breakdown Chart
            renderProductsChannelChart(totalVideoGmv, totalLiveGmv, totalShopGmv);
        }

        function renderProductsChannelChart(videoGmv, liveGmv, shopGmv) {
            const ctx = document.getElementById('productsChannelChart');
            if (!ctx) return;
            
            if (productsChannelChartInstance) {
                productsChannelChartInstance.destroy();
            }

            productsChannelChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Video', 'LIVE', 'Shop Tab'],
                    datasets: [{
                        data: [videoGmv, liveGmv, shopGmv],
                        backgroundColor: ['#f5c518', '#e74c3c', '#3498db'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#9aa5b8',
                                padding: 15,
                                usePointStyle: true,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = total > 0 ? (ctx.raw / total * 100).toFixed(1) : 0;
                                    return `${ctx.label}: ${fmtMoney(ctx.raw)} (${pct}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function exportProducts() {
            if (!productsCache.filtered.length) {
                showToast('No data to export', 'error');
                return;
            }
            
            const headers = ['Product', 'Brand', 'Status', 'GMV', 'Orders', 'Items Sold', 'Video GMV', 'LIVE GMV', 'Shop GMV'];
            const rows = productsCache.filtered.map(p => [
                p.product_name || 'Unknown',
                p.brand,
                p.status || 'Unknown',
                p.gmv.toFixed(2),
                p.orders,
                p.items_sold,
                p.video_gmv.toFixed(2),
                p.live_gmv.toFixed(2),
                p.shop_tab_gmv.toFixed(2)
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `products-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Export complete!', 'success');
        }

        // Search input debounce for products
        let productsSearchTimeout;
        document.getElementById('productsSearchInput')?.addEventListener('input', () => {
            clearTimeout(productsSearchTimeout);
            productsSearchTimeout = setTimeout(() => {
                pages.products = 1;
                loadProductsData();
            }, 300);
        });

        // ==================== DAILY OPS ====================
        let spotlightCandidates = [];
        let currentSpotlightIndex = 0;
        let recentSpotlights = []; // Track recently spotlighted creators

        const TIER_THRESHOLDS = {
            ruby: 200000,
            diamond: 100000,
            platinum: 50000,
            gold: 20000,
            silver: 5000,
            bronze: 2000
        };

        const TIER_NAMES = {
            ruby: ' Ruby',
            diamond: ' Diamond',
            platinum: ' Platinum',
            gold: ' Gold',
            silver: ' Silver',
            bronze: ' Bronze',
            new: ' New'
        };

        function getTierFromGMV(gmv) {
            if (gmv >= TIER_THRESHOLDS.ruby) return 'ruby';
            if (gmv >= TIER_THRESHOLDS.diamond) return 'diamond';
            if (gmv >= TIER_THRESHOLDS.platinum) return 'platinum';
            if (gmv >= TIER_THRESHOLDS.gold) return 'gold';
            if (gmv >= TIER_THRESHOLDS.silver) return 'silver';
            if (gmv >= TIER_THRESHOLDS.bronze) return 'bronze';
            return 'new';
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            const text = el.innerText || el.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // Show feedback
                const btn = el.closest('.card').querySelector('.btn');
                const originalText = btn.textContent;
                btn.textContent = ' Copied!';
                btn.style.background = 'var(--success)';
                btn.style.color = '#000';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            });
        }
        
        // Generic copy function with visual feedback
        function copyText(text, buttonEl = null) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success', 2000);
                if (buttonEl) {
                    buttonEl.classList.add('copied');
                    setTimeout(() => buttonEl.classList.remove('copied'), 1500);
                }
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        // Animate number changes
        function animateValue(element, start, end, duration = 500) {
            const startTime = performance.now();
            const isFloat = end % 1 !== 0;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3); // easeOutCubic
                const current = start + (end - start) * easeProgress;
                
                if (isFloat) {
                    element.textContent = current.toFixed(2);
                } else {
                    element.textContent = Math.round(current).toLocaleString();
                }
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.classList.add('updated');
                    setTimeout(() => element.classList.remove('updated'), 400);
                }
            }
            
            requestAnimationFrame(update);
        }

        async function loadDailyOps() {
            showLoading('dailyops', 'Loading daily performance...');
            try {
            const today = new Date();
            
            // Get selected date from picker
            const datePickerEl = document.getElementById('dailyDatePicker');
            let selectedDateStr;
            
            // Try to get date from Litepicker instance
            const picker = datePickers['dailyDatePicker'];
            if (picker && picker.getDate()) {
                const pickerDate = picker.getDate();
                selectedDateStr = pickerDate.format('YYYY-MM-DD');
            } else if (datePickerEl && datePickerEl.value) {
                // Parse display format "Nov 24, 2025" or use as-is if already YYYY-MM-DD
                const val = datePickerEl.value;
                if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
                    selectedDateStr = val;
                } else {
                    // Try to parse display format
                    const parsed = new Date(val);
                    if (!isNaN(parsed.getTime())) {
                        selectedDateStr = parsed.toISOString().split('T')[0];
                    }
                }
            }
            
            // Default to most recent date with data (smart default)
            if (!selectedDateStr || selectedDateStr === 'Invalid Date' || selectedDateStr === 'undefined') {
                // Use most recent available date, fall back to yesterday
                if (availableDates.daily && availableDates.daily.length > 0) {
                    selectedDateStr = availableDates.daily[0]; // Most recent date with data
                } else {
                    // Fetch latest date directly from database
                    const { data: latestDate } = await supabaseClient
                        .from('creator_performance')
                        .select('report_date')
                        .eq('period_type', 'daily')
                        .order('report_date', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (latestDate && latestDate.report_date) {
                        selectedDateStr = latestDate.report_date;
                    } else {
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        selectedDateStr = yesterday.toISOString().split('T')[0];
                    }
                }
            }

            const brandFilter = document.getElementById('dailyBrandFilter').value;
            const brandLabel = brandFilter === 'all' ? 'All Brands' : (BRAND_DISPLAY[brandFilter] || brandFilter);

            // Format date nicely
            const displayDate = formatDate(selectedDateStr);
            document.getElementById('dailyOpsDate').textContent = 
                `${displayDate}  ${brandLabel}  Generated: ${today.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;

            // Check if data is stale (not from yesterday)
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            const selectedDate = new Date(selectedDateStr + 'T12:00:00');
            const daysDiff = Math.floor((yesterday - selectedDate) / (1000 * 60 * 60 * 24));
            
            // Fetch per-brand data health
            const { data: brandHealth } = await supabaseClient
                .from('creator_performance')
                .select('brand, report_date')
                .eq('period_type', 'daily')
                .gte('report_date', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])
                .order('report_date', { ascending: false });
            
            // Calculate last upload date per brand
            const allBrands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            const brandLastUpload = {};
            allBrands.forEach(b => brandLastUpload[b] = null);
            
            (brandHealth || []).forEach(row => {
                if (!brandLastUpload[row.brand] || row.report_date > brandLastUpload[row.brand]) {
                    brandLastUpload[row.brand] = row.report_date;
                }
            });
            
            // Show/hide stale data warning
            let staleWarning = document.getElementById('dailyStaleWarning');
            if (!staleWarning) {
                // Create warning element if it doesn't exist
                staleWarning = document.createElement('div');
                staleWarning.id = 'dailyStaleWarning';
                staleWarning.style.cssText = 'background: var(--warning-dim); border: 1px solid var(--warning); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;';
                const dailyContent = document.getElementById('dailyContent');
                if (dailyContent) {
                    dailyContent.insertBefore(staleWarning, dailyContent.firstChild);
                }
            }
            
            // Build brand status HTML
            const brandStatusHTML = allBrands.map(brand => {
                const lastDate = brandLastUpload[brand];
                const brandName = BRAND_DISPLAY[brand] || brand;
                if (!lastDate) {
                    return `<span style="display: inline-flex; align-items: center; gap: 4px; margin-right: 12px;"><span style="color: var(--danger);"></span> ${brandName}: No data</span>`;
                }
                const brandDaysDiff = Math.floor((yesterday - new Date(lastDate + 'T12:00:00')) / (1000 * 60 * 60 * 24));
                if (brandDaysDiff <= 0) {
                    return `<span style="display: inline-flex; align-items: center; gap: 4px; margin-right: 12px;"><span style="color: var(--success);"></span> ${brandName}</span>`;
                } else if (brandDaysDiff <= 2) {
                    return `<span style="display: inline-flex; align-items: center; gap: 4px; margin-right: 12px;"><span style="color: var(--warning);"></span> ${brandName}: ${brandDaysDiff}d old</span>`;
                } else {
                    return `<span style="display: inline-flex; align-items: center; gap: 4px; margin-right: 12px;"><span style="color: var(--danger);"></span> ${brandName}: ${brandDaysDiff}d old</span>`;
                }
            }).join('');
            
            // Count brands with issues
            const brandsWithIssues = allBrands.filter(b => {
                const lastDate = brandLastUpload[b];
                if (!lastDate) return true;
                const brandDaysDiff = Math.floor((yesterday - new Date(lastDate + 'T12:00:00')) / (1000 * 60 * 60 * 24));
                return brandDaysDiff > 0;
            }).length;
            
            if (daysDiff > 0 || brandsWithIssues > 0) {
                staleWarning.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 1.3rem;"></span>
                        <div style="flex: 1;">
                            <strong style="color: var(--warning);">Data Health Check</strong>
                            ${daysDiff > 0 ? `<div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">Showing ${displayDate}  ${daysDiff} day${daysDiff > 1 ? 's' : ''} behind. New data uploads needed.</div>` : ''}
                            <div style="margin-top: 8px; font-size: 0.85rem; display: flex; flex-wrap: wrap;">${brandStatusHTML}</div>
                        </div>
                    </div>
                `;
                staleWarning.style.display = 'block';
            } else {
                staleWarning.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3rem;"></span>
                        <div>
                            <strong style="color: var(--success);">All Data Current</strong>
                            <div style="margin-top: 4px; font-size: 0.85rem; display: flex; flex-wrap: wrap;">${brandStatusHTML}</div>
                        </div>
                    </div>
                `;
                staleWarning.style.display = 'block';
                staleWarning.style.background = 'var(--success-dim)';
                staleWarning.style.borderColor = 'var(--success)';
            }

            // Use RPC function for aggregated data (bypasses row limits)
            let dailyData = null;
            const { data: rpcData, error: rpcError } = await supabaseClient.rpc('get_daily_ops_data', {
                p_brand: brandFilter === 'all' ? null : brandFilter,
                p_date: selectedDateStr
            }).limit(50000);

            if (rpcError) {
                console.warn('RPC not available, using fallback query:', rpcError.message);
                // Fallback: direct query
                let query = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, orders, videos, refunds, est_commission')
                    .eq('report_date', selectedDateStr)
                    .eq('period_type', 'daily')
                    .limit(50000);
                
                if (brandFilter !== 'all') {
                    query = query.eq('brand', brandFilter);
                }
                
                const { data: fallbackData, error: fallbackError } = await query;
                if (fallbackError) {
                    console.error('Fallback query also failed:', fallbackError);
                    return;
                }
                dailyData = fallbackData;
            } else {
                dailyData = rpcData;
            }

            // Check for no data
            const noDataWarning = document.getElementById('dailyNoDataWarning');
            const dailyContent = document.getElementById('dailyContent');

            if (!dailyData || dailyData.length === 0) {
                noDataWarning.style.display = 'flex';
                dailyContent.style.display = 'none';
                document.getElementById('dailyProgressHero').style.display = 'none';
                return;
            } else {
                noDataWarning.style.display = 'none';
                dailyContent.style.display = 'block';
                document.getElementById('dailyProgressHero').style.display = 'block';
            }

            // Process the data
            const creators = dailyData.map(row => ({
                name: row.creator_name,
                brand: row.brand,
                gmv: pFloat(row.gmv),
                orders: pInt(row.orders),
                videos: pInt(row.videos),
                refunds: pFloat(row.refunds),
                commission: pFloat(row.est_commission),
                priorGmv: pFloat(row.prior_day_gmv),
                priorOrders: pInt(row.prior_day_orders),
                priorVideos: pInt(row.prior_day_videos),
                gmvChange: pFloat(row.prior_day_gmv) > 0 
                    ? ((pFloat(row.gmv) - pFloat(row.prior_day_gmv)) / pFloat(row.prior_day_gmv) * 100) 
                    : (pFloat(row.gmv) > 0 ? 100 : 0)
            }));

            // Calculate totals by brand
            const brandTotals = {};
            let totalGmv = 0, totalOrders = 0, totalVideos = 0, totalPriorGmv = 0;
            
            creators.forEach(c => {
                if (!brandTotals[c.brand]) {
                    brandTotals[c.brand] = { gmv: 0, orders: 0, videos: 0, creators: 0, priorGmv: 0 };
                }
                brandTotals[c.brand].gmv += c.gmv;
                brandTotals[c.brand].orders += c.orders;
                brandTotals[c.brand].videos += c.videos;
                brandTotals[c.brand].creators++;
                brandTotals[c.brand].priorGmv += c.priorGmv;
                
                totalGmv += c.gmv;
                totalOrders += c.orders;
                totalVideos += c.videos;
                totalPriorGmv += c.priorGmv;
            });

            // Detect wins and attention
            const wins = detectDailyWinsFromData(creators);
            const attention = detectDailyAttentionFromData(creators);

            // Store for brand action board
            window.dailyCreators = creators;
            window.dailyBrandTotals = brandTotals;
            window.dailyWins = wins;
            window.dailyAttention = attention;

            // Update snapshot stats
            const gmvChange = totalPriorGmv > 0 ? ((totalGmv - totalPriorGmv) / totalPriorGmv * 100) : 0;
            document.getElementById('dailyTotalGmv').textContent = fmtMoney(totalGmv);
            document.getElementById('dailyTotalOrders').textContent = fmt(totalOrders);
            document.getElementById('dailyTotalVideos').textContent = fmt(totalVideos);
            document.getElementById('dailyActiveCreators').textContent = fmt(creators.length);
            document.getElementById('dailyWinsCount').textContent = fmt(wins.length);
            
            const gmvChangeEl = document.getElementById('dailyGmvChange');
            if (gmvChange !== 0) {
                gmvChangeEl.textContent = `${gmvChange >= 0 ? '' : ''} ${Math.abs(gmvChange).toFixed(1)}% vs prior`;
                gmvChangeEl.className = `snapshot-change ${gmvChange >= 0 ? 'positive' : 'negative'}`;
            } else {
                gmvChangeEl.textContent = '--';
            }

            // Generate copyable summary
            generateDailySummary(creators, brandTotals, wins, attention, selectedDateStr, brandLabel);

            // Build brand action board
            buildDailyBrandActionBoard(creators, wins, attention, brandTotals);

            // Populate wins hero section
            renderDailyWinsHero(wins);

            // Update wins count badge
            document.getElementById('winsCount').textContent = wins.length;

            // Populate spotlight candidates from daily data
            populateSpotlightFromDaily(creators);
            } finally {
                hideLoading('dailyops');
            }
        }

        function populateSpotlightFromDaily(creators) {
            // Create spotlight candidates from MANAGED creators with good performance
            // but not in the top wins (those are already being celebrated)
            const topWinNames = new Set((window.dailyWins || []).slice(0, 10).map(w => w.name));
            
            spotlightCandidates = creators
                .filter(c => 
                    isManagedForBrand(c.name, c.brand) && // Only managed creators
                    c.gmv >= 50 && c.gmv < 500 && // Mid-tier performers
                    !topWinNames.has(c.name)
                )
                .map(c => ({
                    name: c.name,
                    brand: c.brand,
                    gmv: c.gmv,
                    orders: c.orders,
                    videos: c.videos,
                    daysActive: 1, // Single day context
                    avgGMVPerDay: c.gmv,
                    conversionRate: c.videos > 0 ? c.orders / c.videos : 0,
                    score: c.gmv + (c.videos * 50) // Simple scoring
                }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 20); // Keep top 20 candidates

            // Also populate by brand for brand detail view
            window.dailyBrandSpotlights = {};
            spotlightCandidates.forEach(c => {
                if (!window.dailyBrandSpotlights[c.brand]) {
                    window.dailyBrandSpotlights[c.brand] = [];
                }
                if (window.dailyBrandSpotlights[c.brand].length < 3) {
                    window.dailyBrandSpotlights[c.brand].push({
                        name: c.name,
                        gmv: c.gmv,
                        videos: c.videos,
                        daysActive: 1,
                        reason: c.videos >= 2 ? `Posted ${c.videos} videos today` : `Generated ${fmtMoney(c.gmv)} GMV`,
                        shoutout: `CREATOR SHOUTOUT \n\nGiving @${c.name}  a shout-out!\n\nKeep up the great work! `
                    });
                }
            });

            currentSpotlightIndex = 0;
            renderSpotlight();
        }

        function detectDailyWinsFromData(creators) {
            const wins = [];
            
            creators.forEach(c => {
                // Only include managed creators
                if (!isManagedForBrand(c.name, c.brand)) return;
                
                const reasons = [];
                
                // Big GMV day ($500+)
                if (c.gmv >= 500) {
                    reasons.push({ type: 'big_day', msg: ` ${fmtMoney(c.gmv)} GMV day!` });
                }
                
                // Huge growth (50%+ increase with meaningful volume)
                if (c.gmvChange >= 50 && c.gmv >= 100 && c.priorGmv >= 50) {
                    reasons.push({ type: 'growth', msg: ` +${c.gmvChange.toFixed(0)}% growth` });
                }
                
                // High video output (3+ videos)
                if (c.videos >= 3) {
                    reasons.push({ type: 'content', msg: ` ${c.videos} videos posted` });
                }
                
                // First sale (new creator)
                if (c.gmv > 0 && c.priorGmv === 0 && c.priorOrders === 0) {
                    reasons.push({ type: 'first_sale', msg: ` First tracked sale!` });
                }

                if (reasons.length > 0) {
                    wins.push({ ...c, reasons });
                }
            });

            // Sort by GMV
            wins.sort((a, b) => b.gmv - a.gmv);
            return wins;
        }

        function detectDailyAttentionFromData(creators) {
            const attention = [];
            
            creators.forEach(c => {
                // Only include managed creators
                if (!isManagedForBrand(c.name, c.brand)) return;
                
                const issues = [];
                
                // Big GMV drop (30%+ decline with previous meaningful volume)
                if (c.priorGmv >= 100 && c.gmv < c.priorGmv * 0.7) {
                    const dropPct = ((c.priorGmv - c.gmv) / c.priorGmv * 100).toFixed(0);
                    issues.push({ type: 'gmv_drop', severity: 2, msg: ` GMV down ${dropPct}%` });
                }
                
                // Was active, now no sales
                if (c.priorGmv >= 50 && c.gmv === 0) {
                    issues.push({ type: 'no_sales', severity: 3, msg: ` No sales today (had ${fmtMoney(c.priorGmv)} yesterday)` });
                }
                
                // Stopped posting (had videos, now none)
                if (c.priorVideos >= 1 && c.videos === 0 && c.priorGmv >= 100) {
                    issues.push({ type: 'no_content', severity: 2, msg: ` No videos (had ${c.priorVideos} yesterday)` });
                }

                if (issues.length > 0) {
                    issues.sort((a, b) => b.severity - a.severity);
                    attention.push({ ...c, issues });
                }
            });

            // Sort by severity then GMV impact
            attention.sort((a, b) => {
                const severityA = Math.max(...a.issues.map(i => i.severity));
                const severityB = Math.max(...b.issues.map(i => i.severity));
                if (severityB !== severityA) return severityB - severityA;
                return b.priorGmv - a.priorGmv;
            });
            
            return attention;
        }

        function generateDailySummary(creators, brandTotals, wins, attention, dateStr, brandLabel) {
            const totalGmv = creators.reduce((s, c) => s + c.gmv, 0);
            const totalOrders = creators.reduce((s, c) => s + c.orders, 0);
            const totalVideos = creators.reduce((s, c) => s + c.videos, 0);
            const priorTotalGmv = creators.reduce((s, c) => s + c.priorGmv, 0);
            const gmvChange = priorTotalGmv > 0 ? ((totalGmv - priorTotalGmv) / priorTotalGmv * 100) : 0;
            const activeCreators = creators.filter(c => c.gmv > 0).length;

            const emoji = gmvChange >= 10 ? '' : gmvChange >= 0 ? '' : gmvChange >= -10 ? '' : '';
            
            // Build summary
            let summary = ` DAILY OPS - ${formatDate(dateStr)}
${brandLabel}

${emoji} OVERALL HEALTH

 GMV: ${fmtMoney(totalGmv)} (${gmvChange >= 0 ? '+' : ''}${gmvChange.toFixed(1)}% DoD)
 Orders: ${fmt(totalOrders)}
 Videos: ${fmt(totalVideos)}
 Active Creators: ${activeCreators}

`;

            // Brand breakdown
            if (Object.keys(brandTotals).length > 1) {
                summary += ` BY BRAND\n\n`;
                Object.entries(brandTotals)
                    .sort((a, b) => b[1].gmv - a[1].gmv)
                    .forEach(([brand, data]) => {
                        const change = data.priorGmv > 0 ? ((data.gmv - data.priorGmv) / data.priorGmv * 100) : 0;
                        const icon = change >= 10 ? '' : change >= -10 ? '' : '';
                        summary += `${icon} ${BRAND_DISPLAY[brand]}: ${fmtMoney(data.gmv)} (${change >= 0 ? '+' : ''}${change.toFixed(0)}%)\n`;
                    });
                summary += '\n';
            }

            // Top wins
            if (wins.length > 0) {
                summary += ` TOP WINS (${wins.length} total)\n\n`;
                wins.slice(0, 5).forEach((w, i) => {
                    summary += `${i + 1}. ${w.name} (${BRAND_DISPLAY[w.brand]}): ${fmtMoney(w.gmv)} - ${w.reasons[0].msg}\n`;
                });
                summary += '\n';
            }

            // Attention needed
            if (attention.length > 0) {
                summary += ` NEEDS ATTENTION (${attention.length} creators)\n\n`;
                attention.slice(0, 5).forEach((a, i) => {
                    summary += `${i + 1}. ${a.name} (${BRAND_DISPLAY[a.brand]}): ${a.issues[0].msg}\n`;
                });
            }

            document.getElementById('morningMattContent').textContent = summary;
        }

        function buildDailyBrandActionBoard(creators, wins, attention, brandTotals) {
            const allBrands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            const container = document.getElementById('brandActionBoard');
            
            // Debug: log what brands we actually have
            console.log('Brand totals keys:', Object.keys(brandTotals));
            console.log('Brand totals:', brandTotals);
            
            // Group wins and attention by brand
            const winsByBrand = {};
            const attentionByBrand = {};
            
            allBrands.forEach(brand => {
                winsByBrand[brand] = wins.filter(w => w.brand === brand);
                attentionByBrand[brand] = attention.filter(a => a.brand === brand);
            });

            // Also check for brand keys that might be different format
            Object.keys(brandTotals).forEach(key => {
                if (!allBrands.includes(key)) {
                    console.log('Found unexpected brand key:', key);
                    winsByBrand[key] = wins.filter(w => w.brand === key);
                    attentionByBrand[key] = attention.filter(a => a.brand === key);
                }
            });

            // Store globally for detail view
            window.dailyWinsByBrand = winsByBrand;
            window.dailyAttentionByBrand = attentionByBrand;

            // Use actual brand keys from data, falling back to allBrands
            const brandsToShow = Object.keys(brandTotals).length > 0 ? Object.keys(brandTotals) : allBrands;

            // Build brand cards
            let totalActions = 0;
            container.innerHTML = brandsToShow.map(brand => {
                const data = brandTotals[brand] || { gmv: 0, orders: 0, videos: 0, creators: 0, priorGmv: 0 };
                const brandWins = winsByBrand[brand] || wins.filter(w => w.brand === brand);
                const brandAttention = attentionByBrand[brand] || attention.filter(a => a.brand === brand);
                const actions = brandWins.length + brandAttention.length;
                totalActions += actions;
                
                const change = data.priorGmv > 0 ? ((data.gmv - data.priorGmv) / data.priorGmv * 100) : 0;
                const healthClass = change >= 10 ? 'health-great' : change >= -10 ? 'health-ok' : 'health-bad';
                const isComplete = window.completedDailyBrands?.has(brand);
                const displayName = BRAND_DISPLAY[brand] || brand;
                
                return `
                    <div class="brand-action-card ${healthClass} ${isComplete ? 'completed' : ''}" onclick="showDailyBrandDetail('${brand}')">
                        <div class="brand-card-header">
                            <span class="brand-name">${displayName}</span>
                            ${isComplete ? '<span class="complete-badge"></span>' : ''}
                        </div>
                        <div class="brand-card-stats">
                            <div class="stat">${fmtMoney(data.gmv)}</div>
                            <div class="stat-change ${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}${change.toFixed(0)}%</div>
                        </div>
                        <div class="brand-card-actions">
                            ${brandWins.length > 0 ? `<span class="action-badge wins"> ${brandWins.length}</span>` : ''}
                            ${brandAttention.length > 0 ? `<span class="action-badge attention"> ${brandAttention.length}</span>` : ''}
                            ${actions === 0 ? '<span class="action-badge neutral"> All good</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('totalActionsCount').textContent = `${totalActions} actions`;

            // Build progress brands (new hero UI)
            const progressBrands = document.getElementById('dailyProgressBrands');
            if (progressBrands) {
                progressBrands.innerHTML = brandsToShow.map(brand => {
                    const isComplete = window.completedDailyBrands?.has(brand);
                    const data = brandTotals[brand] || { gmv: 0 };
                    const displayName = BRAND_DISPLAY[brand] || brand;
                    return `
                        <label class="brand-check ${isComplete ? 'completed' : ''}">
                            <input type="checkbox" ${isComplete ? 'checked' : ''} onchange="toggleDailyBrandComplete('${brand}', this.checked)">
                            <span>${displayName}</span>
                            <span style="margin-left: auto; font-weight: 600;">${fmtMoney(data.gmv)}</span>
                        </label>
                    `;
                }).join('');
            }

            updateDailyProgress();
        }

        function showDailyBrandDetail(brand) {
            const brandTotals = window.dailyBrandTotals || {};
            const data = brandTotals[brand] || { gmv: 0, orders: 0, videos: 0, creators: 0 };
            const brandWins = window.dailyWinsByBrand?.[brand] || [];
            const brandAttention = window.dailyAttentionByBrand?.[brand] || [];

            window.currentDailyBrand = brand;

            // Update header
            document.getElementById('brandDetailName').textContent = BRAND_DISPLAY[brand];
            
            // Update stats
            document.getElementById('brandDetailGmv').textContent = fmtMoney(data.gmv);
            document.getElementById('brandDetailOrders').textContent = fmt(data.orders);
            document.getElementById('brandDetailVideos').textContent = fmt(data.videos);
            document.getElementById('brandDetailCreators').textContent = fmt(data.creators);

            // Wins
            document.getElementById('brandWinsCount').textContent = brandWins.length;
            document.getElementById('brandWinsContainer').innerHTML = brandWins.length > 0 
                ? brandWins.map(w => `
                    <div class="action-item win">
                        <div class="action-header">
                            <strong>${w.name}</strong>
                            <span class="gmv">${fmtMoney(w.gmv)}</span>
                        </div>
                        <div class="action-reasons">${w.reasons.map(r => r.msg).join('  ')}</div>
                        <div class="action-buttons">
                            <button class="btn btn-tiny" onclick="copyWinMessage('${w.name}', '${brand}', ${w.gmv})"> Copy Shoutout</button>
                        </div>
                    </div>
                `).join('')
                : '<p class="empty-message">No wins to celebrate today</p>';

            // Attention
            document.getElementById('brandAttentionCount').textContent = brandAttention.length;
            document.getElementById('brandAttentionContainer').innerHTML = brandAttention.length > 0 
                ? brandAttention.map(a => `
                    <div class="action-item attention">
                        <div class="action-header">
                            <strong>${a.name}</strong>
                            <span class="prior-gmv">Was: ${fmtMoney(a.priorGmv)}</span>
                        </div>
                        <div class="action-issues">${a.issues.map(i => i.msg).join('  ')}</div>
                        <div class="action-buttons">
                            <button class="btn btn-tiny" onclick="copyFollowupMessage('${a.name}', '${brand}')"> Copy DM</button>
                        </div>
                    </div>
                `).join('')
                : '<p class="empty-message">No creators need attention</p>';

            // Spotlight (pick a random mid-tier creator)
            const midTierCreators = (window.dailyCreators || [])
                .filter(c => c.brand === brand && c.gmv >= 50 && c.gmv <= 300 && c.videos >= 1);
            const spotlight = midTierCreators[Math.floor(Math.random() * midTierCreators.length)];
            document.getElementById('brandSpotlightContainer').innerHTML = spotlight
                ? `<div class="spotlight-card">
                    <strong>${spotlight.name}</strong> - ${fmtMoney(spotlight.gmv)} with ${spotlight.videos} video(s)
                    <button class="btn btn-tiny" onclick="copySpotlightMessage('${spotlight.name}', '${brand}')"> Copy</button>
                   </div>`
                : '<p class="empty-message">No spotlight suggestions</p>';

            // Show detail, hide board
            document.getElementById('brandDailyDetail').style.display = 'block';
            document.getElementById('brandActionBoard').parentElement.parentElement.style.display = 'none';
        }

        function closeBrandDetail() {
            document.getElementById('brandDailyDetail').style.display = 'none';
            document.getElementById('brandActionBoard').parentElement.parentElement.style.display = 'block';
        }

        function markBrandComplete() {
            if (window.currentDailyBrand) {
                toggleDailyBrandComplete(window.currentDailyBrand, true);
                closeBrandDetail();
            }
        }

        function renderDailyWinsHero(wins) {
            console.log('Rendering wins:', wins?.length || 0);
            
            try {
                document.getElementById('winsCount').textContent = wins?.length || 0;
                
                if (!wins || wins.length === 0) {
                    document.getElementById('dailyWinsContainer').innerHTML = `
                        <div class="empty-state" style="padding: 40px;">
                            <div class="icon"></div>
                            <h3>No wins detected yet</h3>
                            <p>Wins are triggered by $500+ GMV days, 50%+ growth, 3+ videos posted, or first sales</p>
                        </div>
                    `;
                    return;
                }

                // Limit to first 50 for performance
                const winsToShow = wins.slice(0, 50);
                
                document.getElementById('dailyWinsContainer').innerHTML = winsToShow.map((w, i) => {
                    const safeName = (w.name || 'Unknown').replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const brandDisplay = BRAND_DISPLAY[w.brand] || w.brand || 'Unknown';
                    const reasons = w.reasons?.map(r => r.msg).join('  ') || '';
                    
                    return `
                        <div class="win-item" id="win-${i}">
                            <div class="win-info">
                                <div class="win-creator">@${w.name || 'Unknown'}</div>
                                <div class="win-details">
                                    <span class="badge-brand" style="font-size: 0.7rem;">${brandDisplay}</span>
                                    <span style="margin-left: 8px;">${reasons}</span>
                                </div>
                            </div>
                            <div class="win-gmv">${fmtMoney(w.gmv || 0)}</div>
                            <div class="win-actions">
                                <button class="btn btn-small" onclick="copyWinByIndex(${i})"> Copy</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (wins.length > 50) {
                    document.getElementById('dailyWinsContainer').innerHTML += `
                        <div style="text-align: center; padding: 16px; color: var(--text-muted);">
                            Showing 50 of ${wins.length} wins
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error rendering wins:', error);
                document.getElementById('dailyWinsContainer').innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <div class="icon"></div>
                        <h3>Error loading wins</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function copyWinByIndex(index) {
            const wins = window.dailyWins || [];
            const w = wins[index];
            if (!w) return;
            
            const msg = ` SHOUTOUT to @${w.name}!\n\nCrushed it with ${fmtMoney(w.gmv)} in sales! \n\nKeep that energy going! `;
            navigator.clipboard.writeText(msg);
            
            // Visual feedback
            const el = document.getElementById(`win-${index}`);
            if (el) {
                el.classList.add('copied');
                setTimeout(() => el.classList.remove('copied'), 2000);
            }
            showToast('Shoutout copied!', 'success');
        }

        function copyAllWins() {
            const wins = window.dailyWins || [];
            if (wins.length === 0) {
                showToast('No wins to copy', 'error');
                return;
            }
            
            const messages = wins.map(w => 
                ` @${w.name} - ${fmtMoney(w.gmv)} (${BRAND_DISPLAY[w.brand]})`
            ).join('\n');
            
            const header = ` TODAY'S WINS (${wins.length})\n${''.repeat(30)}\n`;
            navigator.clipboard.writeText(header + messages);
            showToast(`${wins.length} wins copied!`, 'success');
        }

        // Keep old function for compatibility
        function renderDailyWins(wins) {
            renderDailyWinsHero(wins);
        }

        function copyWinMessage(name, brand, gmv) {
            const msg = ` SHOUTOUT to @${name}! 

Crushed it with ${fmtMoney(gmv)} in sales! 

Keep that energy going! `;
            navigator.clipboard.writeText(msg);
            showToast('Win message copied!');
        }

        function copyFollowupMessage(name, brand) {
            const msg = `Hey @${name}! 

Just checking in - noticed things were a bit quiet yesterday. Everything good?

Let me know if you need any support with content ideas or product selection. We're here to help! `;
            navigator.clipboard.writeText(msg);
            showToast('Follow-up message copied!');
        }

        function copySpotlightMessage(name, brand) {
            const msg = ` Creator Spotlight: @${name}

Consistent work pays off! Keep posting and engaging - you're building something great! `;
            navigator.clipboard.writeText(msg);
            showToast('Spotlight message copied!');
        }

        // Brand action board state
        window.dailyBrandData = {};
        window.dailyBrandWins = {};
        window.dailyBrandAttention = {};
        window.dailyBrandSpotlights = {};
        window.dailyBrandDoD = {}; // Day-over-day changes
        window.completedDailyBrands = new Set();
        window.currentDailyBrand = null;

        window.weeklyBrandWinners = {};
        window.weeklyBrandAttention = {};
        window.completedWeeklyBrands = new Set();
        window.currentWeeklyBrand = null;

        // localStorage persistence for completed brands
        function loadCompletedBrands() {
            const today = localDateStr(new Date());
            const weekStart = getWeekStart();
            
            // Daily - reset if different day
            const dailyData = JSON.parse(localStorage.getItem('completedDailyBrands') || '{}');
            if (dailyData.date === today) {
                window.completedDailyBrands = new Set(dailyData.brands || []);
            } else {
                window.completedDailyBrands = new Set();
                localStorage.setItem('completedDailyBrands', JSON.stringify({ date: today, brands: [] }));
            }
            
            // Weekly - reset if different week
            const weeklyData = JSON.parse(localStorage.getItem('completedWeeklyBrands') || '{}');
            if (weeklyData.weekStart === weekStart) {
                window.completedWeeklyBrands = new Set(weeklyData.brands || []);
            } else {
                window.completedWeeklyBrands = new Set();
                localStorage.setItem('completedWeeklyBrands', JSON.stringify({ weekStart, brands: [] }));
            }
        }

        function getWeekStart() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Monday
            const monday = new Date(now);
            monday.setDate(diff);
            return localDateStr(monday);
        }

        function saveCompletedDailyBrands() {
            const today = localDateStr(new Date());
            localStorage.setItem('completedDailyBrands', JSON.stringify({
                date: today,
                brands: Array.from(window.completedDailyBrands)
            }));
        }

        function saveCompletedWeeklyBrands() {
            const weekStart = getWeekStart();
            localStorage.setItem('completedWeeklyBrands', JSON.stringify({
                weekStart,
                brands: Array.from(window.completedWeeklyBrands)
            }));
        }

        // Load on startup
        loadCompletedBrands();

        function toggleDailyBrandComplete(brandKey, checked) {
            if (checked === undefined) {
                // Toggle mode
                if (window.completedDailyBrands.has(brandKey)) {
                    window.completedDailyBrands.delete(brandKey);
                } else {
                    window.completedDailyBrands.add(brandKey);
                }
            } else {
                // Explicit set mode
                if (checked) {
                    window.completedDailyBrands.add(brandKey);
                } else {
                    window.completedDailyBrands.delete(brandKey);
                }
            }
            saveCompletedDailyBrands();
            
            // Update UI without full rebuild
            updateDailyProgress();
            
            // Update brand card styling
            document.querySelectorAll('.brand-action-card').forEach(card => {
                const brand = card.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                if (brand === brandKey) {
                    card.classList.toggle('completed', window.completedDailyBrands.has(brandKey));
                    const badge = card.querySelector('.complete-badge');
                    if (window.completedDailyBrands.has(brandKey) && !badge) {
                        card.querySelector('.brand-card-header').insertAdjacentHTML('beforeend', '<span class="complete-badge"></span>');
                    } else if (!window.completedDailyBrands.has(brandKey) && badge) {
                        badge.remove();
                    }
                }
            });
            
            // Update progress brand checks
            document.querySelectorAll('.brand-check').forEach(check => {
                const input = check.querySelector('input');
                if (check.textContent.includes(BRAND_DISPLAY[brandKey])) {
                    check.classList.toggle('completed', window.completedDailyBrands.has(brandKey));
                    if (input) input.checked = window.completedDailyBrands.has(brandKey);
                }
            });
        }

        function updateDailyProgress() {
            const total = 5;
            const completed = window.completedDailyBrands?.size || 0;
            const percentage = (completed / total) * 100;
            
            // Update progress bar
            const progressBar = document.getElementById('dailyProgressBar');
            if (progressBar) progressBar.style.width = `${percentage}%`;
            
            // Update progress text
            const progressText = document.getElementById('dailyProgressText');
            if (progressText) progressText.textContent = `${completed}/${total} brands complete`;
            
            // Legacy support
            const oldBar = document.getElementById('checklistProgressBar');
            if (oldBar) oldBar.style.width = `${percentage}%`;
            
            // Show celebration if all done
            if (completed === total) {
                showDailyComplete();
            }
        }

        function showDailyComplete() {
            const board = document.getElementById('brandActionBoard');
            if (board && !document.getElementById('dailyCompleteMsg')) {
                const msg = document.createElement('div');
                msg.id = 'dailyCompleteMsg';
                msg.className = 'all-complete-msg';
                msg.innerHTML = ' All brands done for today! Great work!';
                board.parentElement.insertBefore(msg, board);
            }
        }

        function openDailyBrandDetail(brandKey) {
            window.currentDailyBrand = brandKey;
            const brandDisplay = BRAND_DISPLAY[brandKey] || brandKey;
            const data = window.dailyBrandData[brandKey] || { gmv: 0, orders: 0, videos: 0, creators: 0 };
            const wins = window.dailyBrandWins[brandKey] || [];
            const attention = window.dailyBrandAttention[brandKey] || [];
            const spotlights = window.dailyBrandSpotlights[brandKey] || [];

            document.getElementById('brandDetailName').textContent = brandDisplay;
            document.getElementById('brandDetailGmv').textContent = fmtMoney(data.gmv);
            document.getElementById('brandDetailOrders').textContent = fmt(data.orders);
            document.getElementById('brandDetailVideos').textContent = fmt(data.videos);
            document.getElementById('brandDetailCreators').textContent = data.creators;

            // Wins
            document.getElementById('brandWinsCount').textContent = wins.length;
            const winsContainer = document.getElementById('brandWinsContainer');
            if (wins.length === 0) {
                winsContainer.innerHTML = '<p style="color: var(--text-muted);">No wins detected for this brand today.</p>';
            } else {
                winsContainer.innerHTML = wins.map((win, i) => `
                    <div class="win-card" style="margin-bottom: 8px;" onclick="copyBrandWin('${brandKey}', ${i})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${win.creatorName}</strong>
                            <span class="win-type ${win.type}">${win.typeLabel}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">${win.message}</div>
                    </div>
                `).join('');
            }

            // Attention
            document.getElementById('brandAttentionCount').textContent = attention.length;
            const attentionContainer = document.getElementById('brandAttentionContainer');
            if (attention.length === 0) {
                attentionContainer.innerHTML = '<p style="color: var(--text-muted);">All creators looking good!</p>';
            } else {
                attentionContainer.innerHTML = attention.map(c => `
                    <div style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${c.name}</strong>
                            <span style="font-size: 0.8rem; color: var(--text-muted);">${fmtMoney(c.gmv)}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--warning); margin-top: 4px;">${c.issues.map(i => i.message).join('  ')}</div>
                    </div>
                `).join('');
            }

            // Spotlight
            const spotlightContainer = document.getElementById('brandSpotlightContainer');
            if (spotlights.length === 0) {
                spotlightContainer.innerHTML = '<p style="color: var(--text-muted);">No spotlight candidates for this brand.</p>';
            } else {
                const s = spotlights[0];
                spotlightContainer.innerHTML = `
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong>${s.name}</strong>
                            <button class="btn btn-small" onclick="copyBrandSpotlight('${brandKey}')"> Copy Shoutout</button>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${s.reason}</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px;">
                            <div class="mini-stat"><div class="value">${fmtMoney(s.gmv)}</div><div class="label">GMV</div></div>
                            <div class="mini-stat"><div class="value">${s.videos}</div><div class="label">Videos</div></div>
                            <div class="mini-stat"><div class="value">${s.daysActive}</div><div class="label">Days</div></div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('brandDailyDetail').style.display = 'block';
            document.getElementById('brandActionBoard').parentElement.parentElement.style.display = 'none';
        }

        function closeBrandDetail() {
            document.getElementById('brandDailyDetail').style.display = 'none';
            document.getElementById('brandActionBoard').parentElement.parentElement.style.display = 'block';
        }

        function markBrandComplete() {
            if (window.currentDailyBrand) {
                window.completedDailyBrands.add(window.currentDailyBrand);
                saveCompletedDailyBrands();
                closeBrandDetail();
                buildDailyBrandActionBoard();
            }
        }

        function copyBrandWin(brandKey, index) {
            const wins = window.dailyBrandWins[brandKey] || [];
            if (wins[index] && wins[index].content) {
                navigator.clipboard.writeText(wins[index].content);
                // Visual feedback
                event.target.closest('.win-card').style.borderColor = 'var(--success)';
                setTimeout(() => {
                    event.target.closest('.win-card').style.borderColor = '';
                }, 1500);
            }
        }

        function copyBrandSpotlight(brandKey) {
            const spotlights = window.dailyBrandSpotlights[brandKey] || [];
            if (spotlights[0] && spotlights[0].shoutout) {
                navigator.clipboard.writeText(spotlights[0].shoutout);
            }
        }

        // Checklist functionality (legacy - kept for compatibility)
        function updateChecklist() {
            updateDailyProgress();
        }

        function updateWeeklyChecklist() {
            updateWeeklyProgress();
        }

        function updateWeeklyProgress() {
            const total = 5;
            const completed = window.completedWeeklyBrands.size;
            const percentage = (completed / total) * 100;
            document.getElementById('weeklyChecklistProgressBar').style.width = `${percentage}%`;
            
            // Show celebration if all done
            if (completed === total) {
                showWeeklyComplete();
            }
        }

        function showWeeklyComplete() {
            const board = document.getElementById('weeklyBrandBoard');
            if (board && !document.getElementById('weeklyCompleteMsg')) {
                const msg = document.createElement('div');
                msg.id = 'weeklyCompleteMsg';
                msg.className = 'all-complete-msg';
                msg.innerHTML = ' All brands done for the week! Amazing work!';
                board.parentElement.insertBefore(msg, board);
            }
        }

        async function generateMorningMatt(yesterdayData, dayBeforeData, dateStr, brandFilter) {
            // Aggregate yesterday's data
            const brandTotals = {};
            const creatorTotals = {};
            let totalGMV = 0;
            let totalOrders = 0;
            let totalVideos = 0;

            yesterdayData.forEach(row => {
                // Brand totals
                if (!brandTotals[row.brand]) {
                    brandTotals[row.brand] = { gmv: 0, orders: 0, videos: 0, creators: new Set() };
                }
                brandTotals[row.brand].gmv += pFloat(row.gmv);
                brandTotals[row.brand].orders += pInt(row.orders);
                brandTotals[row.brand].videos += pInt(row.videos);
                brandTotals[row.brand].creators.add(row.creator_name);

                // Creator totals
                const key = `${row.creator_name}|||${row.brand}`;
                if (!creatorTotals[key]) {
                    creatorTotals[key] = { name: row.creator_name, brand: row.brand, gmv: 0, orders: 0, videos: 0 };
                }
                creatorTotals[key].gmv += pFloat(row.gmv);
                creatorTotals[key].orders += pInt(row.orders);
                creatorTotals[key].videos += pInt(row.videos);

                totalGMV += pFloat(row.gmv);
                totalOrders += pInt(row.orders);
                totalVideos += pInt(row.videos);
            });

            // Day before totals for comparison (aggregate by brand too)
            let prevGMV = 0;
            const prevBrandTotals = {};
            dayBeforeData.forEach(row => {
                prevGMV += pFloat(row.gmv);
                if (!prevBrandTotals[row.brand]) {
                    prevBrandTotals[row.brand] = { gmv: 0, orders: 0, videos: 0 };
                }
                prevBrandTotals[row.brand].gmv += pFloat(row.gmv);
                prevBrandTotals[row.brand].orders += pInt(row.orders);
                prevBrandTotals[row.brand].videos += pInt(row.videos);
            });
            const gmvChange = prevGMV > 0 ? ((totalGMV - prevGMV) / prevGMV * 100).toFixed(1) : 0;
            const gmvArrow = gmvChange >= 0 ? '' : '';

            // Calculate per-brand DoD changes
            window.dailyBrandDoD = {};
            Object.keys(brandTotals).forEach(brand => {
                const current = brandTotals[brand].gmv;
                const prev = prevBrandTotals[brand]?.gmv || 0;
                window.dailyBrandDoD[brand] = prev > 0 ? ((current - prev) / prev * 100) : (current > 0 ? 100 : 0);
            });

            // Top 5 creators
            const topCreators = Object.values(creatorTotals)
                .sort((a, b) => b.gmv - a.gmv)
                .slice(0, 5);

            // Brand breakdown sorted by GMV
            const sortedBrands = Object.entries(brandTotals)
                .sort((a, b) => b[1].gmv - a[1].gmv);

            // Find best video (would need video data - simplified for now)
            const bestCreatorByOrders = Object.values(creatorTotals)
                .sort((a, b) => b.orders - a.orders)[0];

            // Generate the message
            let msg = ` MORNING MATT - ${formatDate(dateStr)}

 QUICK STATS
Total GMV: ${fmtMoney(totalGMV)} ${gmvArrow} ${gmvChange >= 0 ? '+' : ''}${gmvChange}% vs prior day
Orders: ${fmt(totalOrders)} | Videos Posted: ${fmt(totalVideos)}

 BY BRAND`;

            sortedBrands.forEach(([brand, data]) => {
                const displayName = BRAND_DISPLAY[brand] || brand;
                msg += `\n ${displayName}: ${fmtMoney(data.gmv)} (${data.creators.size} active creators)`;
            });

            msg += `\n
 TOP 5 PERFORMERS`;
            topCreators.forEach((c, i) => {
                const brandDisplay = BRAND_DISPLAY[c.brand] || c.brand;
                msg += `\n${i + 1}. ${c.name} (${brandDisplay}) - ${fmtMoney(c.gmv)}`;
            });

            msg += `\n
 TALKING POINTS
 Total active creators yesterday: ${Object.keys(creatorTotals).length}
 Highest converting creator: ${bestCreatorByOrders?.name || 'N/A'} (${bestCreatorByOrders?.orders || 0} orders)
 Average GMV per creator: ${fmtMoney(totalGMV / Math.max(Object.keys(creatorTotals).length, 1))}`;

            // Check for any notable achievements
            const bigWinners = Object.values(creatorTotals).filter(c => c.gmv >= 1000);
            if (bigWinners.length > 0) {
                msg += `\n ${bigWinners.length} creator(s) hit $1K+ GMV yesterday! `;
            }

            document.getElementById('morningMattContent').textContent = msg;

            // Populate brand data for action board
            Object.entries(brandTotals).forEach(([brandKey, data]) => {
                window.dailyBrandData[brandKey] = {
                    gmv: data.gmv,
                    orders: data.orders,
                    videos: data.videos,
                    creators: data.creators.size
                };
            });
        }

        async function detectDailyWins(yesterdayData, dayBeforeData, allTimeData) {
            const wins = [];

            // Aggregate current totals by creator
            const creatorTotals = {};
            yesterdayData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!creatorTotals[key]) {
                    creatorTotals[key] = { name: row.creator_name, brand: row.brand, gmv: 0, orders: 0, videos: 0 };
                }
                creatorTotals[key].gmv += pFloat(row.gmv);
                creatorTotals[key].orders += pInt(row.orders);
                creatorTotals[key].videos += pInt(row.videos);
            });

            // Day before totals
            const dayBeforeTotals = {};
            dayBeforeData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!dayBeforeTotals[key]) {
                    dayBeforeTotals[key] = { gmv: 0, orders: 0 };
                }
                dayBeforeTotals[key].gmv += pFloat(row.gmv);
                dayBeforeTotals[key].orders += pInt(row.orders);
            });

            // All-time totals for tier tracking
            const allTimeTotals = {};
            allTimeData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!allTimeTotals[key]) {
                    allTimeTotals[key] = { name: row.creator_name, brand: row.brand, gmv: 0 };
                }
                allTimeTotals[key].gmv += pFloat(row.gmv);
            });

            // Detect wins
            Object.entries(creatorTotals).forEach(([key, data]) => {
                const brandDisplay = BRAND_DISPLAY[data.brand] || data.brand;
                const prevData = dayBeforeTotals[key];
                const allTime = allTimeTotals[key];

                // First Sale Detection (had 0 orders day before, has orders now)
                if (data.orders > 0 && (!prevData || prevData.orders === 0)) {
                    wins.push({
                        type: 'first-sale',
                        typeName: 'First Sale',
                        creator: data.name,
                        brand: brandDisplay,
                        content: ` CREATOR WIN - FIRST SALE!\n\nCreator: @${data.name}\nBrand: ${brandDisplay}\nAchievement: Made their first sale! \nOrders: ${data.orders} | GMV: ${fmtMoney(data.gmv)}`,
                        priority: 5
                    });
                }

                // GMV Milestone Detection
                const milestones = [10000, 5000, 2500, 1000, 500];
                milestones.forEach(milestone => {
                    if (data.gmv >= milestone && (!prevData || prevData.gmv < milestone)) {
                        wins.push({
                            type: 'milestone',
                            typeName: `$${milestone >= 1000 ? (milestone/1000) + 'K' : milestone} Day`,
                            creator: data.name,
                            brand: brandDisplay,
                            content: ` CREATOR WIN - GMV MILESTONE!\n\nCreator: @${data.name}\nBrand: ${brandDisplay}\nAchievement: Hit ${fmtMoney(milestone)}+ in a single day! \nActual GMV: ${fmtMoney(data.gmv)}`,
                            priority: milestone >= 5000 ? 4 : 3
                        });
                    }
                });

                // Tier Promotion Detection
                if (allTime) {
                    const prevDayAllTime = allTime.gmv - data.gmv;
                    const prevTier = getTierFromGMV(prevDayAllTime);
                    const newTier = getTierFromGMV(allTime.gmv);
                    
                    if (prevTier !== newTier && TIER_THRESHOLDS[newTier] > (TIER_THRESHOLDS[prevTier] || 0)) {
                        wins.push({
                            type: 'tier',
                            typeName: 'Tier Up',
                            creator: data.name,
                            brand: brandDisplay,
                            content: ` CREATOR WIN - TIER PROMOTION!\n\nCreator: @${data.name}\nBrand: ${brandDisplay}\nAchievement: Advanced to ${TIER_NAMES[newTier]} tier! \nAll-Time GMV: ${fmtMoney(allTime.gmv)}`,
                            priority: 4
                        });
                    }
                }

                // Personal Best Detection (beat their own record)
                if (prevData && data.gmv > prevData.gmv * 2 && data.gmv >= 100) {
                    wins.push({
                        type: 'personal-best',
                        typeName: 'Personal Best',
                        creator: data.name,
                        brand: brandDisplay,
                        content: ` CREATOR WIN - PERSONAL BEST!\n\nCreator: @${data.name}\nBrand: ${brandDisplay}\nAchievement: More than doubled their GMV! \nYesterday: ${fmtMoney(data.gmv)} vs Prior: ${fmtMoney(prevData.gmv)}`,
                        priority: 2
                    });
                }
            });

            // Sort by priority and render
            wins.sort((a, b) => b.priority - a.priority);

            const container = document.getElementById('dailyWinsContainer');
            document.getElementById('winsCount').textContent = `${wins.length} win${wins.length !== 1 ? 's' : ''}`;

            if (wins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>No notable wins detected</h3>
                        <p>Check back after more data is uploaded</p>
                    </div>`;
                return;
            }

            // Store wins globally for click handler
            window.dailyWins = wins;

            // Populate wins by brand for action board
            window.dailyBrandWins = {};
            wins.forEach(win => {
                // Find the brand key from the display name
                const brandKey = Object.keys(BRAND_DISPLAY).find(k => BRAND_DISPLAY[k] === win.brand) || win.brand;
                if (!window.dailyBrandWins[brandKey]) {
                    window.dailyBrandWins[brandKey] = [];
                }
                window.dailyBrandWins[brandKey].push({
                    creatorName: win.creator,
                    type: win.type,
                    typeLabel: win.typeName,
                    message: win.content.split('\n')[3] || win.typeName, // Get the achievement line
                    content: win.content
                });
            });

            container.innerHTML = wins.map((win, index) => `
                <div class="win-card" data-win-index="${index}" onclick="copyWinByIndex(${index})">
                    <div class="win-header">
                        <span class="win-type ${win.type}">${win.typeName}</span>
                        <span class="win-brand">${win.brand}</span>
                    </div>
                    <div class="win-creator">${win.creator}</div>
                    <div class="win-content">${win.content}</div>
                    <div class="win-hint">Click to copy</div>
                </div>
            `).join('');
        }

        function copyWinByIndex(index) {
            const win = window.dailyWins[index];
            if (!win) return;
            const element = document.querySelector(`.win-card[data-win-index="${index}"]`);
            navigator.clipboard.writeText(win.content).then(() => {
                element.classList.add('copied');
                const hint = element.querySelector('.win-hint');
                hint.textContent = ' Copied to clipboard!';
                setTimeout(() => {
                    element.classList.remove('copied');
                    hint.textContent = 'Click to copy';
                }, 2000);
            });
        }

        function detectDailyAttention(yesterdayData, dayBeforeData, allTimeData) {
            // Reset daily attention
            window.dailyBrandAttention = {};

            // Aggregate yesterday by creator
            const yesterdayTotals = {};
            yesterdayData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!yesterdayTotals[key]) {
                    yesterdayTotals[key] = { name: row.creator_name, brand: row.brand, gmv: 0, orders: 0, videos: 0 };
                }
                yesterdayTotals[key].gmv += pFloat(row.gmv);
                yesterdayTotals[key].orders += pInt(row.orders);
                yesterdayTotals[key].videos += pInt(row.videos);
            });

            // Aggregate day before by creator
            const dayBeforeTotals = {};
            dayBeforeData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!dayBeforeTotals[key]) {
                    dayBeforeTotals[key] = { name: row.creator_name, brand: row.brand, gmv: 0, orders: 0, videos: 0 };
                }
                dayBeforeTotals[key].gmv += pFloat(row.gmv);
                dayBeforeTotals[key].orders += pInt(row.orders);
                dayBeforeTotals[key].videos += pInt(row.videos);
            });

            // Calculate 30-day averages
            const creatorAverages = {};
            allTimeData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!creatorAverages[key]) {
                    creatorAverages[key] = { name: row.creator_name, brand: row.brand, totalGmv: 0, days: new Set() };
                }
                creatorAverages[key].totalGmv += pFloat(row.gmv);
                creatorAverages[key].days.add(row.report_date);
            });

            // Detect attention issues
            Object.entries(yesterdayTotals).forEach(([key, data]) => {
                const issues = [];
                const prev = dayBeforeTotals[key];
                const avg = creatorAverages[key];
                const avgDaily = avg ? (avg.totalGmv / Math.max(avg.days.size, 1)) : 0;

                // GMV decline vs day before (>50% drop from meaningful day)
                if (prev && prev.gmv >= 50 && data.gmv < prev.gmv * 0.5) {
                    issues.push({
                        type: 'gmv_decline',
                        severity: 2,
                        message: `GMV down ${((1 - data.gmv / prev.gmv) * 100).toFixed(0)}% vs day before`
                    });
                }

                // Underperforming vs average (>60% below their normal)
                if (avgDaily >= 50 && data.gmv < avgDaily * 0.4) {
                    issues.push({
                        type: 'below_average',
                        severity: 2,
                        message: `${((1 - data.gmv / avgDaily) * 100).toFixed(0)}% below their usual ${fmtMoney(avgDaily)}/day`
                    });
                }

                // No videos posted (for active creators)
                if (data.videos === 0 && avg && avg.days.size >= 5) {
                    issues.push({
                        type: 'no_videos',
                        severity: 1,
                        message: 'No videos posted yesterday'
                    });
                }

                // Zero GMV for previously active creator
                if (data.gmv === 0 && prev && prev.gmv >= 100) {
                    issues.push({
                        type: 'zero_gmv',
                        severity: 2,
                        message: `Zero GMV (had ${fmtMoney(prev.gmv)} day before)`
                    });
                }

                if (issues.length > 0) {
                    if (!window.dailyBrandAttention[data.brand]) {
                        window.dailyBrandAttention[data.brand] = [];
                    }
                    window.dailyBrandAttention[data.brand].push({
                        name: data.name,
                        brand: BRAND_DISPLAY[data.brand] || data.brand,
                        gmv: data.gmv,
                        prevGmv: prev?.gmv || 0,
                        avgGmv: avgDaily,
                        videos: data.videos,
                        issues
                    });
                }
            });

            // Check for creators who were active day before but not yesterday
            Object.entries(dayBeforeTotals).forEach(([key, prev]) => {
                if (!yesterdayTotals[key] && prev.gmv >= 100) {
                    const [name, brand] = key.split('|||');
                    if (!window.dailyBrandAttention[brand]) {
                        window.dailyBrandAttention[brand] = [];
                    }
                    window.dailyBrandAttention[brand].push({
                        name,
                        brand: BRAND_DISPLAY[brand] || brand,
                        gmv: 0,
                        prevGmv: prev.gmv,
                        avgGmv: 0,
                        videos: 0,
                        issues: [{
                            type: 'inactive',
                            severity: 2,
                            message: `No activity (had ${fmtMoney(prev.gmv)} day before)`
                        }]
                    });
                }
            });
        }

        async function suggestSpotlight(yesterdayData, allTimeData) {
            // Aggregate all-time data
            const creatorStats = {};
            allTimeData.forEach(row => {
                // Only include managed creators
                if (!isManagedForBrand(row.creator_name, row.brand)) return;
                
                const key = `${row.creator_name}|||${row.brand}`;
                if (!creatorStats[key]) {
                    creatorStats[key] = { 
                        name: row.creator_name, 
                        brand: row.brand, 
                        gmv: 0, 
                        orders: 0, 
                        videos: 0,
                        days: new Set()
                    };
                }
                creatorStats[key].gmv += pFloat(row.gmv);
                creatorStats[key].orders += pInt(row.orders);
                creatorStats[key].videos += pInt(row.videos);
                creatorStats[key].days.add(row.report_date);
            });

            // Calculate scores for each creator
            spotlightCandidates = Object.values(creatorStats)
                .filter(c => c.gmv >= 100) // Minimum threshold
                .map(c => {
                    const daysActive = c.days.size;
                    const avgGMVPerDay = c.gmv / Math.max(daysActive, 1);
                    const conversionRate = c.videos > 0 ? (c.orders / c.videos) : 0;
                    
                    // Score based on consistency, growth, and performance
                    const consistencyScore = Math.min(daysActive / 20, 1) * 30; // Up to 30 points for consistency
                    const gmvScore = Math.min(c.gmv / 10000, 1) * 40; // Up to 40 points for total GMV
                    const conversionScore = Math.min(conversionRate / 0.5, 1) * 30; // Up to 30 points for conversion

                    return {
                        ...c,
                        daysActive,
                        avgGMVPerDay,
                        conversionRate,
                        score: consistencyScore + gmvScore + conversionScore
                    };
                })
                .sort((a, b) => b.score - a.score);

            // Filter out recently spotlighted
            spotlightCandidates = spotlightCandidates.filter(c => 
                !recentSpotlights.includes(`${c.name}|||${c.brand}`)
            );

            // Populate spotlights by brand for action board
            window.dailyBrandSpotlights = {};
            spotlightCandidates.forEach(c => {
                if (!window.dailyBrandSpotlights[c.brand]) {
                    // Determine spotlight reason
                    let reason = '';
                    if (c.daysActive >= 15) {
                        reason = `Consistency Champion - Active ${c.daysActive} days!`;
                    } else if (c.conversionRate >= 0.3) {
                        reason = `High Converter - ${(c.conversionRate * 100).toFixed(0)}% videos drive sales`;
                    } else if (c.avgGMVPerDay >= 500) {
                        reason = `Revenue Driver - Avg ${fmtMoney(c.avgGMVPerDay)}/day`;
                    } else {
                        reason = `Rising Star - Solid performance`;
                    }

                    const shoutout = `CREATOR SHOUTOUT \n\nGiving @${c.name}   a big shout-out today...\n\n${reason}\n\nKeep up the amazing work! `;

                    window.dailyBrandSpotlights[c.brand] = [{
                        name: c.name,
                        gmv: c.gmv,
                        videos: c.videos,
                        daysActive: c.daysActive,
                        reason,
                        shoutout
                    }];
                }
            });

            currentSpotlightIndex = 0;
            renderSpotlight();
        }

        function renderSpotlight() {
            const container = document.getElementById('spotlightContainer');
            
            if (spotlightCandidates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>No spotlight candidates</h3>
                        <p>Need more creator data to suggest spotlights</p>
                    </div>`;
                return;
            }

            const creator = spotlightCandidates[currentSpotlightIndex];
            const brandDisplay = BRAND_DISPLAY[creator.brand] || creator.brand;
            const tier = getTierFromGMV(creator.gmv);

            // Determine spotlight reason
            let reason = '';
            if (creator.daysActive >= 15) {
                reason = ` Consistency Champion - Active ${creator.daysActive} days in the last 30!`;
            } else if (creator.conversionRate >= 0.3) {
                reason = ` High Converter - ${(creator.conversionRate * 100).toFixed(0)}% of their videos drive sales!`;
            } else if (creator.avgGMVPerDay >= 500) {
                reason = ` Revenue Driver - Averaging ${fmtMoney(creator.avgGMVPerDay)} per active day!`;
            } else {
                reason = ` Rising Star - Solid performance with room to grow!`;
            }

            // Generate shoutout copy
            const shoutoutCopy = `CREATOR SHOUTOUT 

Giving @${creator.name}   a big shout-out today...

${reason.replace(/[]/g, '')}

${creator.daysActive >= 10 ? `They've been consistently showing up and posting content. ` : ''}${creator.gmv >= 1000 ? `They've driven ${fmtMoney(creator.gmv)} in GMV so far! ` : ''}${creator.conversionRate >= 0.2 ? `Their content converts at an impressive rate. ` : ''}

Keep up the amazing work! `;

            container.innerHTML = `
                <div class="spotlight-card">
                    <div class="spotlight-header">
                        <div>
                            <div class="spotlight-creator">@${creator.name}</div>
                            <div class="spotlight-brand">${brandDisplay}  ${TIER_NAMES[tier]}</div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Candidate ${currentSpotlightIndex + 1} of ${spotlightCandidates.length}
                        </div>
                    </div>
                    <div class="spotlight-stats">
                        <div class="spotlight-stat">
                            <div class="value">${fmtMoney(creator.gmv)}</div>
                            <div class="label">Total GMV</div>
                        </div>
                        <div class="spotlight-stat">
                            <div class="value">${creator.daysActive}</div>
                            <div class="label">Days Active</div>
                        </div>
                        <div class="spotlight-stat">
                            <div class="value">${fmt(creator.videos)}</div>
                            <div class="label">Videos</div>
                        </div>
                        <div class="spotlight-stat">
                            <div class="value">${(creator.conversionRate * 100).toFixed(0)}%</div>
                            <div class="label">Conv. Rate</div>
                        </div>
                    </div>
                    <div class="spotlight-reason">${reason}</div>
                    <div class="spotlight-copy" id="spotlightCopy">${shoutoutCopy}</div>
                    <div class="spotlight-actions">
                        <button class="btn btn-primary" onclick="copySpotlight()"> Copy Shoutout</button>
                        <button class="btn" onclick="markSpotlighted()"> Used This One</button>
                    </div>
                </div>
            `;
        }

        function getNewSpotlight() {
            currentSpotlightIndex = (currentSpotlightIndex + 1) % Math.max(spotlightCandidates.length, 1);
            renderSpotlight();
        }

        function copySpotlight() {
            const text = document.getElementById('spotlightCopy').textContent;
            const btn = document.querySelector('.spotlight-actions .btn-primary');
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = ' Copied!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = ' Copy Shoutout';
                    btn.style.background = '';
                }, 2000);
            });
        }

        function markSpotlighted() {
            const creator = spotlightCandidates[currentSpotlightIndex];
            if (creator) {
                recentSpotlights.push(`${creator.name}|||${creator.brand}`);
                if (recentSpotlights.length > 10) recentSpotlights.shift(); // Keep last 10
                spotlightCandidates.splice(currentSpotlightIndex, 1);
                currentSpotlightIndex = Math.min(currentSpotlightIndex, spotlightCandidates.length - 1);
                renderSpotlight();
            }
        }

        // ==================== WEEKLY OPS ====================
        
        function applyWeekPreset() {
            const weekOffset = document.getElementById('weekSelector').value;
            if (weekOffset === 'custom') return; // Don't change dates for custom
            
            const offset = parseInt(weekOffset) || 0;
            const today = new Date();
            
            const weekEnd = new Date(today);
            weekEnd.setDate(weekEnd.getDate() - 1 - (offset * 7));
            const weekStart = new Date(weekEnd);
            weekStart.setDate(weekStart.getDate() - 6);
            
            const startPicker = document.getElementById('weeklyStartDate');
            const endPicker = document.getElementById('weeklyEndDate');
            
            if (startPicker._flatpickr && endPicker._flatpickr) {
                startPicker._flatpickr.setDate(localDateStr(weekStart), false);
                endPicker._flatpickr.setDate(localDateStr(weekEnd), false);
            }
            
            loadWeeklyOps();
        }
        
        async function loadWeeklyOps() {
            showLoading('weeklyops', 'Loading weekly performance...');
            try {
            const today = new Date();
            
            // Get dates from pickers
            const startPickerEl = document.getElementById('weeklyStartDate');
            const endPickerEl = document.getElementById('weeklyEndDate');
            
            let thisWeekStartStr, thisWeekEndStr;
            
            if (startPickerEl && startPickerEl.value && endPickerEl && endPickerEl.value) {
                thisWeekStartStr = startPickerEl.value;
                thisWeekEndStr = endPickerEl.value;
            } else {
                // Smart default: use most recent date with data as week end
                let weekEndDate;
                if (availableDates.daily && availableDates.daily.length > 0) {
                    weekEndDate = new Date(availableDates.daily[0] + 'T12:00:00'); // Most recent date with data
                } else {
                    // Fetch latest date directly from database
                    const { data: latestDate } = await supabaseClient
                        .from('creator_performance')
                        .select('report_date')
                        .eq('period_type', 'daily')
                        .order('report_date', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (latestDate && latestDate.report_date) {
                        weekEndDate = new Date(latestDate.report_date + 'T12:00:00');
                    } else {
                        weekEndDate = new Date(today);
                        weekEndDate.setDate(weekEndDate.getDate() - 1);
                    }
                }
                const weekStartDate = new Date(weekEndDate);
                weekStartDate.setDate(weekStartDate.getDate() - 6);
                thisWeekStartStr = localDateStr(weekStartDate);
                thisWeekEndStr = localDateStr(weekEndDate);
            }
            
            const brandFilter = document.getElementById('weeklyBrandFilter').value;
            const brandLabel = brandFilter === 'all' ? 'All Brands' : (BRAND_DISPLAY[brandFilter] || brandFilter);

            document.getElementById('weeklyOpsDate').textContent = 
                `${formatDate(thisWeekStartStr)}  ${formatDate(thisWeekEndStr)} | ${brandLabel} | Generated: ${today.toLocaleTimeString()}`;

            // Check if data is stale (week end is not yesterday)
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekEndDate = new Date(thisWeekEndStr + 'T12:00:00');
            const daysDiff = Math.floor((yesterday - weekEndDate) / (1000 * 60 * 60 * 24));
            
            // Show/hide stale data warning
            let staleWarning = document.getElementById('weeklyStaleWarning');
            if (!staleWarning) {
                staleWarning = document.createElement('div');
                staleWarning.id = 'weeklyStaleWarning';
                staleWarning.style.cssText = 'background: var(--warning-dim); border: 1px solid var(--warning); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;';
                const weeklyContent = document.getElementById('weeklyContent');
                if (weeklyContent) {
                    weeklyContent.insertBefore(staleWarning, weeklyContent.firstChild);
                }
            }
            
            if (daysDiff > 0) {
                staleWarning.innerHTML = `
                    <span style="font-size: 1.3rem;"></span>
                    <div>
                        <strong style="color: var(--warning);">Data is ${daysDiff} day${daysDiff > 1 ? 's' : ''} old</strong>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Week ending ${formatDate(thisWeekEndStr)}  latest available data. New data uploads needed.</div>
                    </div>
                `;
                staleWarning.style.display = 'flex';
            } else {
                staleWarning.style.display = 'none';
            }

            // Use RPC function for aggregated data
            let weeklyData = null;
            const { data: rpcData, error: rpcError } = await supabaseClient.rpc('get_weekly_ops_data', {
                p_brand: brandFilter === 'all' ? null : brandFilter,
                p_week_start: thisWeekStartStr,
                p_week_end: thisWeekEndStr
            }).limit(50000);

            if (rpcError) {
                console.warn('RPC not available, using fallback query:', rpcError.message);
                // Fallback: direct query with aggregation in JS
                let query = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, orders, videos, refunds, est_commission, report_date')
                    .gte('report_date', thisWeekStartStr)
                    .lte('report_date', thisWeekEndStr)
                    .eq('period_type', 'daily')
                    .limit(50000);
                
                if (brandFilter !== 'all') {
                    query = query.eq('brand', brandFilter);
                }
                
                const { data: fallbackData, error: fallbackError } = await query;
                if (fallbackError) {
                    console.error('Fallback query also failed:', fallbackError);
                    return;
                }
                
                // Aggregate by creator_name + brand
                const aggregated = {};
                (fallbackData || []).forEach(row => {
                    const key = `${row.creator_name}|${row.brand}`;
                    if (!aggregated[key]) {
                        aggregated[key] = {
                            creator_name: row.creator_name,
                            brand: row.brand,
                            gmv: 0, orders: 0, videos: 0, refunds: 0, est_commission: 0,
                            days_active: 0
                        };
                    }
                    aggregated[key].gmv += pFloat(row.gmv);
                    aggregated[key].orders += pInt(row.orders);
                    aggregated[key].videos += pInt(row.videos);
                    aggregated[key].refunds += pFloat(row.refunds);
                    aggregated[key].est_commission += pFloat(row.est_commission);
                    aggregated[key].days_active++;
                });
                weeklyData = Object.values(aggregated);
            } else {
                weeklyData = rpcData;
            }

            // Process the data
            const creators = (weeklyData || []).map(row => ({
                name: row.creator_name,
                brand: row.brand,
                gmv: pFloat(row.gmv),
                orders: pInt(row.orders),
                videos: pInt(row.videos),
                refunds: pFloat(row.refunds),
                commission: pFloat(row.est_commission),
                daysActive: pInt(row.days_active),
                priorGmv: pFloat(row.prior_week_gmv),
                priorOrders: pInt(row.prior_week_orders),
                priorVideos: pInt(row.prior_week_videos),
                gmvChange: pFloat(row.prior_week_gmv) > 0 
                    ? ((pFloat(row.gmv) - pFloat(row.prior_week_gmv)) / pFloat(row.prior_week_gmv) * 100) 
                    : (pFloat(row.gmv) > 0 ? 100 : 0)
            }));

            // Calculate totals by brand
            const brandTotals = {};
            creators.forEach(c => {
                if (!brandTotals[c.brand]) {
                    brandTotals[c.brand] = { gmv: 0, orders: 0, videos: 0, creators: 0, priorGmv: 0, priorOrders: 0 };
                }
                brandTotals[c.brand].gmv += c.gmv;
                brandTotals[c.brand].orders += c.orders;
                brandTotals[c.brand].videos += c.videos;
                brandTotals[c.brand].creators++;
                brandTotals[c.brand].priorGmv += c.priorGmv;
                brandTotals[c.brand].priorOrders += c.priorOrders;
            });

            // Calculate overall totals
            const totalGmv = creators.reduce((s, c) => s + c.gmv, 0);
            const totalOrders = creators.reduce((s, c) => s + c.orders, 0);
            const totalVideos = creators.reduce((s, c) => s + c.videos, 0);
            const priorTotalGmv = creators.reduce((s, c) => s + c.priorGmv, 0);
            const priorTotalVideos = creators.reduce((s, c) => s + c.priorVideos, 0);
            
            const gmvChange = priorTotalGmv > 0 ? ((totalGmv - priorTotalGmv) / priorTotalGmv * 100) : 0;
            const videosChange = priorTotalVideos > 0 ? ((totalVideos - priorTotalVideos) / priorTotalVideos * 100) : 0;

            // Detect winners and attention
            const winners = detectWeeklyWinners(creators);
            const attention = detectWeeklyAttention(creators);

            // Store globally
            window.weeklyCreators = creators;
            window.weeklyBrandTotals = brandTotals;
            window.weeklyWinners = winners;
            window.weeklyAttention = attention;

            // Update stats
            document.getElementById('weeklyTotalGmv').textContent = fmtMoney(totalGmv);
            document.getElementById('weeklyGmvChange').textContent = `${gmvChange >= 0 ? '+' : ''}${gmvChange.toFixed(1)}% WoW`;
            document.getElementById('weeklyGmvChange').className = `stat-change ${gmvChange >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('weeklyTotalVideos').textContent = fmt(totalVideos);
            document.getElementById('weeklyVideosChange').textContent = `${videosChange >= 0 ? '+' : ''}${videosChange.toFixed(0)}% WoW`;
            document.getElementById('weeklyVideosChange').className = `stat-change ${videosChange >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('weeklyGrowingCount').textContent = winners.length;
            document.getElementById('weeklyAttentionCount').textContent = attention.length;
            document.getElementById('weeklyManagedAttention').textContent = `${attention.filter(a => isManagedForBrand(a.name, a.brand)).length} managed`;

            // Generate copyable summary
            generateWeeklySummaryText(creators, brandTotals, winners, attention, thisWeekStartStr, thisWeekEndStr, brandLabel);

            // Build brand board
            buildWeeklyBrandBoard(creators, winners, attention, brandTotals);

            // Render tables
            renderWeeklyWinners(winners);
            renderWeeklyAttention(attention);
            } finally {
                hideLoading('weeklyops');
            }
        }

        function detectWeeklyWinners(creators) {
            const winners = [];
            
            creators.forEach(c => {
                // Only include managed creators
                if (!isManagedForBrand(c.name, c.brand)) return;
                
                const reasons = [];
                
                // Top performer ($1000+ weekly)
                if (c.gmv >= 1000) {
                    reasons.push({ type: 'top_performer', msg: ` ${fmtMoney(c.gmv)} weekly GMV` });
                }
                
                // Big growth (50%+ with meaningful prior)
                if (c.gmvChange >= 50 && c.priorGmv >= 100) {
                    reasons.push({ type: 'growth', msg: ` +${c.gmvChange.toFixed(0)}% WoW growth` });
                }
                
                // Consistent poster (5+ videos)
                if (c.videos >= 5) {
                    reasons.push({ type: 'consistent', msg: ` ${c.videos} videos this week` });
                }
                
                // Active all week (6-7 days)
                if (c.daysActive >= 6) {
                    reasons.push({ type: 'dedication', msg: ` Active ${c.daysActive} days` });
                }
                
                // Breakout (low prior, high now)
                if (c.gmv >= 500 && c.priorGmv < 100) {
                    reasons.push({ type: 'breakout', msg: ` Breakout week!` });
                }

                if (reasons.length > 0) {
                    winners.push({ ...c, reasons });
                }
            });

            winners.sort((a, b) => b.gmv - a.gmv);
            return winners;
        }

        function detectWeeklyAttention(creators) {
            const attention = [];
            
            creators.forEach(c => {
                // Only include managed creators
                if (!isManagedForBrand(c.name, c.brand)) return;
                
                const issues = [];
                
                // Big GMV drop (30%+ decline)
                if (c.priorGmv >= 200 && c.gmv < c.priorGmv * 0.7) {
                    const dropPct = ((c.priorGmv - c.gmv) / c.priorGmv * 100).toFixed(0);
                    issues.push({ type: 'gmv_drop', severity: 2, msg: ` GMV down ${dropPct}% (${fmtMoney(c.priorGmv)}  ${fmtMoney(c.gmv)})` });
                }
                
                // Went inactive (had activity, now minimal)
                if (c.priorGmv >= 100 && c.gmv < 20) {
                    issues.push({ type: 'inactive', severity: 3, msg: ` Nearly inactive (was ${fmtMoney(c.priorGmv)})` });
                }
                
                // Stopped posting
                if (c.priorVideos >= 3 && c.videos <= 1) {
                    issues.push({ type: 'no_content', severity: 2, msg: ` Only ${c.videos} video (was ${c.priorVideos})` });
                }
                
                // Low activity days
                if (c.daysActive <= 2 && c.priorGmv >= 100) {
                    issues.push({ type: 'low_activity', severity: 1, msg: ` Only active ${c.daysActive} days` });
                }

                if (issues.length > 0) {
                    issues.sort((a, b) => b.severity - a.severity);
                    attention.push({ ...c, issues });
                }
            });

            attention.sort((a, b) => {
                const severityA = Math.max(...a.issues.map(i => i.severity));
                const severityB = Math.max(...b.issues.map(i => i.severity));
                if (severityB !== severityA) return severityB - severityA;
                return b.priorGmv - a.priorGmv;
            });
            
            return attention;
        }

        function generateWeeklySummaryText(creators, brandTotals, winners, attention, startDate, endDate, brandLabel) {
            const totalGmv = creators.reduce((s, c) => s + c.gmv, 0);
            const totalOrders = creators.reduce((s, c) => s + c.orders, 0);
            const totalVideos = creators.reduce((s, c) => s + c.videos, 0);
            const priorTotalGmv = creators.reduce((s, c) => s + c.priorGmv, 0);
            const gmvChange = priorTotalGmv > 0 ? ((totalGmv - priorTotalGmv) / priorTotalGmv * 100) : 0;
            const activeCreators = creators.filter(c => c.gmv > 0).length;

            const emoji = gmvChange >= 10 ? '' : gmvChange >= 0 ? '' : gmvChange >= -10 ? '' : '';
            
            let summary = ` WEEKLY REPORT - ${brandLabel}
${formatDate(startDate)}  ${formatDate(endDate)}

${emoji} OVERALL PERFORMANCE

 Total GMV: ${fmtMoney(totalGmv)} (${gmvChange >= 0 ? '+' : ''}${gmvChange.toFixed(1)}% WoW)
 Orders: ${fmt(totalOrders)}
 Videos: ${fmt(totalVideos)}
 Active Creators: ${activeCreators}
 Winners: ${winners.length}
 Need Attention: ${attention.length}

`;

            // Brand breakdown
            if (Object.keys(brandTotals).length > 1) {
                summary += ` BY BRAND\n\n`;
                Object.entries(brandTotals)
                    .sort((a, b) => b[1].gmv - a[1].gmv)
                    .forEach(([brand, data]) => {
                        const change = data.priorGmv > 0 ? ((data.gmv - data.priorGmv) / data.priorGmv * 100) : 0;
                        const icon = change >= 10 ? '' : change >= -10 ? '' : '';
                        summary += `${icon} ${BRAND_DISPLAY[brand]}: ${fmtMoney(data.gmv)} (${change >= 0 ? '+' : ''}${change.toFixed(0)}% WoW) | ${data.creators} creators\n`;
                    });
                summary += '\n';
            }

            // Top winners
            if (winners.length > 0) {
                summary += ` TOP PERFORMERS\n\n`;
                winners.slice(0, 5).forEach((w, i) => {
                    summary += `${i + 1}. ${w.name} (${BRAND_DISPLAY[w.brand]}): ${fmtMoney(w.gmv)} - ${w.reasons[0].msg}\n`;
                });
                summary += '\n';
            }

            // Attention needed
            if (attention.length > 0) {
                summary += ` NEEDS FOLLOW-UP\n\n`;
                attention.slice(0, 5).forEach((a, i) => {
                    const managed = isManagedForBrand(a.name, a.brand) ? ' [MANAGED]' : '';
                    summary += `${i + 1}. ${a.name}${managed} (${BRAND_DISPLAY[a.brand]}): ${a.issues[0].msg}\n`;
                });
            }

            document.getElementById('weeklySummaryContent').textContent = summary;
        }

        function buildWeeklyBrandBoard(creators, winners, attention, brandTotals) {
            const allBrands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            const container = document.getElementById('weeklyBrandBoard');
            const checklistContainer = document.getElementById('weeklyBrandChecklistItems');
            
            // Debug logging
            console.log('Weekly brand totals:', brandTotals);
            
            // Group by brand
            const winnersByBrand = {};
            const attentionByBrand = {};
            
            allBrands.forEach(brand => {
                winnersByBrand[brand] = winners.filter(w => w.brand === brand);
                attentionByBrand[brand] = attention.filter(a => a.brand === brand);
            });

            // Also check for brand keys that might be different format
            Object.keys(brandTotals).forEach(key => {
                if (!allBrands.includes(key)) {
                    console.log('Found unexpected brand key:', key);
                    winnersByBrand[key] = winners.filter(w => w.brand === key);
                    attentionByBrand[key] = attention.filter(a => a.brand === key);
                }
            });

            window.weeklyWinnersByBrand = winnersByBrand;
            window.weeklyAttentionByBrand = attentionByBrand;

            // Use actual brand keys from data, falling back to allBrands
            const brandsToShow = Object.keys(brandTotals).length > 0 ? 
                [...new Set([...allBrands, ...Object.keys(brandTotals)])] : allBrands;

            let totalActions = 0;
            container.innerHTML = brandsToShow.filter(brand => allBrands.includes(brand) || brandTotals[brand]).map(brand => {
                const data = brandTotals[brand] || { gmv: 0, orders: 0, videos: 0, creators: 0, priorGmv: 0 };
                const brandWinners = winnersByBrand[brand] || [];
                const brandAttention = attentionByBrand[brand] || [];
                const actions = brandWinners.length + brandAttention.length;
                totalActions += actions;
                
                const change = data.priorGmv > 0 ? ((data.gmv - data.priorGmv) / data.priorGmv * 100) : 0;
                const healthClass = change >= 10 ? 'health-great' : change >= -10 ? 'health-ok' : 'health-bad';
                const isComplete = window.completedWeeklyBrands?.has(brand);
                const displayName = BRAND_DISPLAY[brand] || brand;
                
                return `
                    <div class="brand-action-card ${healthClass} ${isComplete ? 'completed' : ''}" onclick="showWeeklyBrandDetail('${brand}')">
                        <div class="brand-card-header">
                            <span class="brand-name">${displayName}</span>
                            ${isComplete ? '<span class="complete-badge"></span>' : ''}
                        </div>
                        <div class="brand-card-stats">
                            <div class="stat">${fmtMoney(data.gmv)}</div>
                            <div class="stat-change ${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}${change.toFixed(0)}% WoW</div>
                        </div>
                        <div class="brand-card-actions">
                            ${brandWinners.length > 0 ? `<span class="action-badge wins"> ${brandWinners.length}</span>` : ''}
                            ${brandAttention.length > 0 ? `<span class="action-badge attention"> ${brandAttention.length}</span>` : ''}
                            ${actions === 0 ? '<span class="action-badge neutral"> Stable</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('weeklyTotalActions').textContent = `${totalActions} total actions`;

            // Checklist
            if (checklistContainer) {
                checklistContainer.innerHTML = allBrands.map(brand => {
                    const isComplete = window.completedWeeklyBrands?.has(brand);
                    const displayName = BRAND_DISPLAY[brand] || brand;
                    return `
                        <label class="checklist-item ${isComplete ? 'completed' : ''}">
                            <input type="checkbox" ${isComplete ? 'checked' : ''} onchange="toggleWeeklyBrandComplete('${brand}', this.checked)">
                            <span>${displayName}</span>
                        </label>
                    `;
                }).join('');
            }

            updateWeeklyProgress();
        }

        function showWeeklyBrandDetail(brand) {
            const brandTotals = window.weeklyBrandTotals || {};
            const data = brandTotals[brand] || { gmv: 0, orders: 0, videos: 0, creators: 0, priorGmv: 0 };
            const brandWinners = window.weeklyWinnersByBrand?.[brand] || [];
            const brandAttention = window.weeklyAttentionByBrand?.[brand] || [];

            window.currentWeeklyBrand = brand;
            const change = data.priorGmv > 0 ? ((data.gmv - data.priorGmv) / data.priorGmv * 100) : 0;

            // Update header
            document.getElementById('weeklyBrandDetailName').textContent = BRAND_DISPLAY[brand];
            
            // Update stats
            document.getElementById('weeklyBrandGmv').textContent = fmtMoney(data.gmv);
            document.getElementById('weeklyBrandChange').textContent = `${change >= 0 ? '+' : ''}${change.toFixed(0)}%`;
            document.getElementById('weeklyBrandChange').className = `value ${change >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('weeklyBrandOrders').textContent = fmt(data.orders);
            document.getElementById('weeklyBrandCreators').textContent = fmt(data.creators);

            // Winners
            document.getElementById('weeklyBrandWinnersCount').textContent = brandWinners.length;
            document.getElementById('weeklyBrandWinnersContainer').innerHTML = brandWinners.length > 0 
                ? brandWinners.map(w => `
                    <div class="action-item win">
                        <div class="action-header">
                            <strong>${w.name}</strong>
                            <span class="gmv">${fmtMoney(w.gmv)}</span>
                        </div>
                        <div class="action-reasons">${w.reasons.map(r => r.msg).join('  ')}</div>
                        <div class="action-buttons">
                            <button class="btn btn-tiny" onclick="copyWeeklyWinMessage('${w.name}', '${brand}', ${w.gmv})"> Copy Shoutout</button>
                        </div>
                    </div>
                `).join('')
                : '<p class="empty-message">No standout performers this week</p>';

            // Attention
            document.getElementById('weeklyBrandAttentionCount').textContent = brandAttention.length;
            document.getElementById('weeklyBrandAttentionContainer').innerHTML = brandAttention.length > 0 
                ? brandAttention.map(a => `
                    <div class="action-item attention">
                        <div class="action-header">
                            <strong>${a.name}</strong>
                            <span class="prior-gmv">Last wk: ${fmtMoney(a.priorGmv)}</span>
                        </div>
                        <div class="action-issues">${a.issues.map(i => i.msg).join('  ')}</div>
                        <div class="action-buttons">
                            <button class="btn btn-tiny" onclick="copyWeeklyFollowupMessage('${a.name}', '${brand}')"> Copy DM</button>
                        </div>
                    </div>
                `).join('')
                : '<p class="empty-message">All creators performing well</p>';

            // Client talking points
            const talkingPoints = generateClientTalkingPoints(brand, data, brandWinners, brandAttention);
            document.getElementById('weeklyBrandTalkingPoints').innerHTML = talkingPoints;

            // Show detail
            document.getElementById('weeklyBrandDetail').style.display = 'block';
            document.getElementById('weeklyBrandBoard').parentElement.parentElement.style.display = 'none';
        }

        function generateClientTalkingPoints(brand, data, winners, attention) {
            const change = data.priorGmv > 0 ? ((data.gmv - data.priorGmv) / data.priorGmv * 100) : 0;
            const emoji = change >= 10 ? '' : change >= 0 ? '' : '';
            
            let points = `<strong>${emoji} Overall:</strong> ${fmtMoney(data.gmv)} GMV this week (${change >= 0 ? '+' : ''}${change.toFixed(0)}% WoW)<br><br>`;
            
            if (winners.length > 0) {
                points += `<strong> Highlights:</strong><br>`;
                winners.slice(0, 3).forEach(w => {
                    points += ` ${w.name}: ${fmtMoney(w.gmv)} - ${w.reasons[0].msg}<br>`;
                });
                points += '<br>';
            }
            
            if (attention.length > 0) {
                points += `<strong> Action Items:</strong><br>`;
                points += ` ${attention.length} creator(s) need outreach this week<br>`;
                if (attention.some(a => a.issues.some(i => i.type === 'inactive'))) {
                    points += ` Re-engagement campaign for inactive creators<br>`;
                }
            } else {
                points += `<strong> Health:</strong> All creators performing as expected`;
            }
            
            return points;
        }

        function closeWeeklyBrandDetail() {
            document.getElementById('weeklyBrandDetail').style.display = 'none';
            document.getElementById('weeklyBrandBoard').parentElement.parentElement.style.display = 'block';
        }

        function markWeeklyBrandComplete() {
            if (window.currentWeeklyBrand) {
                toggleWeeklyBrandComplete(window.currentWeeklyBrand, true);
                closeWeeklyBrandDetail();
            }
        }

        function toggleWeeklyBrandComplete(brand, complete) {
            if (complete) {
                window.completedWeeklyBrands.add(brand);
            } else {
                window.completedWeeklyBrands.delete(brand);
            }
            saveCompletedWeeklyBrands();
            buildWeeklyBrandBoard(window.weeklyCreators || [], window.weeklyWinners || [], window.weeklyAttention || [], window.weeklyBrandTotals || {});
        }

        function updateWeeklyProgress() {
            const total = 5;
            const completed = window.completedWeeklyBrands?.size || 0;
            const pct = (completed / total) * 100;
            document.getElementById('weeklyChecklistProgressBar').style.width = `${pct}%`;
        }

        function renderWeeklyWinners(winners) {
            document.getElementById('winnersListCount').textContent = winners.length;
            document.getElementById('winnersTableBody').innerHTML = winners.length > 0
                ? winners.map(w => {
                    const managed = isManagedForBrand(w.name, w.brand);
                    return `
                        <tr>
                            <td><strong>${w.name}</strong></td>
                            <td><span class="badge-brand">${BRAND_DISPLAY[w.brand]}</span></td>
                            <td>${w.reasons[0].msg}</td>
                            <td class="gmv-value">${fmtMoney(w.gmv)}</td>
                            <td>${fmtMoney(w.priorGmv)}</td>
                            <td class="${w.gmvChange >= 0 ? 'positive' : 'negative'}">${w.gmvChange >= 0 ? '+' : ''}${w.gmvChange.toFixed(0)}%</td>
                            <td>${w.videos}</td>
                            <td>${managed ? '<span class="badge-managed">Managed</span>' : '<span class="badge-unmanaged">Unmanaged</span>'}</td>
                        </tr>
                    `;
                }).join('')
                : '<tr><td colspan="8"><div class="empty-state"><h3>No winners this week</h3></div></td></tr>';

            // Copy version
            let copyText = ` WEEKLY WINNERS\n\n\n`;
            winners.forEach((w, i) => {
                copyText += `${i + 1}. ${w.name} (${BRAND_DISPLAY[w.brand]})\n   ${fmtMoney(w.gmv)} | ${w.reasons[0].msg}\n\n`;
            });
            document.getElementById('weeklyWinnersContent').textContent = copyText;
        }

        function renderWeeklyAttention(attention) {
            document.getElementById('attentionListCount').textContent = attention.length;
            document.getElementById('attentionTableBody').innerHTML = attention.length > 0
                ? attention.map(a => {
                    const managed = isManagedForBrand(a.name, a.brand);
                    return `
                        <tr>
                            <td><strong>${a.name}</strong></td>
                            <td><span class="badge-brand">${BRAND_DISPLAY[a.brand]}</span></td>
                            <td>${a.issues.map(i => i.msg).join('<br>')}</td>
                            <td>${fmtMoney(a.gmv)}</td>
                            <td>${fmtMoney(a.priorGmv)}</td>
                            <td class="negative">${a.gmvChange.toFixed(0)}%</td>
                            <td>${a.videos} (${a.daysActive}d)</td>
                            <td>${managed ? '<span class="badge-managed">Managed</span>' : '<span class="badge-unmanaged">Unmanaged</span>'}</td>
                        </tr>
                    `;
                }).join('')
                : '<tr><td colspan="8"><div class="empty-state"><h3>All creators healthy!</h3></div></td></tr>';
        }

        function copyWeeklyWinMessage(name, brand, gmv) {
            const msg = ` WEEKLY WINNER 

Huge shoutout to @${name}! 

Absolutely crushed it this week with ${fmtMoney(gmv)} in sales! 

This is what consistency and great content looks like! Keep it up! `;
            navigator.clipboard.writeText(msg);
            showToast('Weekly win message copied!');
        }

        function copyWeeklyFollowupMessage(name, brand) {
            const msg = `Hey @${name}! 

Hope you're doing well! Just wanted to check in - I noticed things slowed down a bit this week.

How's everything going? Anything I can help with? Whether it's content ideas, product selection, or just brainstorming - I'm here for you!

Let's get you back to crushing it `;
            navigator.clipboard.writeText(msg);
            showToast('Follow-up message copied!');
        }

        function copyWeeklyBrandReport() {
            const brand = window.currentWeeklyBrand;
            if (!brand) return;
            
            const data = window.weeklyBrandTotals?.[brand] || {};
            const winners = window.weeklyWinnersByBrand?.[brand] || [];
            const attention = window.weeklyAttentionByBrand?.[brand] || [];
            const change = data.priorGmv > 0 ? ((data.gmv - data.priorGmv) / data.priorGmv * 100) : 0;

            let report = ` ${BRAND_DISPLAY[brand]} - Weekly Report


 GMV: ${fmtMoney(data.gmv)} (${change >= 0 ? '+' : ''}${change.toFixed(0)}% WoW)
 Orders: ${fmt(data.orders)}
 Videos: ${fmt(data.videos)}
 Active Creators: ${data.creators}

`;
            if (winners.length > 0) {
                report += ` TOP PERFORMERS:\n`;
                winners.slice(0, 5).forEach(w => {
                    report += ` ${w.name}: ${fmtMoney(w.gmv)}\n`;
                });
                report += '\n';
            }
            
            if (attention.length > 0) {
                report += ` NEED OUTREACH:\n`;
                attention.slice(0, 5).forEach(a => {
                    report += ` ${a.name}: ${a.issues[0].msg}\n`;
                });
            }

            navigator.clipboard.writeText(report);
            showToast('Brand report copied!');
        }

        function toggleWinnersView() {
            const tableView = document.getElementById('winnersTableView');
            const copyView = document.getElementById('winnersCopyView');
            if (tableView.style.display === 'none') {
                tableView.style.display = 'block';
                copyView.style.display = 'none';
            } else {
                tableView.style.display = 'none';
                copyView.style.display = 'block';
            }
        }

        function toggleAttentionView() {
            const tableView = document.getElementById('attentionTableView');
            const copyView = document.getElementById('attentionCopyView');
            if (!copyView) return;
            if (tableView.style.display === 'none') {
                tableView.style.display = 'block';
                copyView.style.display = 'none';
            } else {
                tableView.style.display = 'none';
                copyView.style.display = 'block';
            }
        }

        function generateWeeklySummary(thisWeekData, priorWeekData, startDate, endDate, brandLabel) {
            // Calculate totals
            let totalGmv = 0, totalOrders = 0, totalVideos = 0;
            let priorGmv = 0, priorOrders = 0, priorVideos = 0;
            const activeCreators = new Set();

            thisWeekData.forEach(row => {
                totalGmv += pFloat(row.gmv);
                totalOrders += pInt(row.orders);
                totalVideos += pInt(row.videos);
                activeCreators.add(row.creator_name);
            });

            priorWeekData.forEach(row => {
                priorGmv += pFloat(row.gmv);
                priorOrders += pInt(row.orders);
                priorVideos += pInt(row.videos);
            });

            const gmvChange = priorGmv > 0 ? ((totalGmv - priorGmv) / priorGmv * 100) : 0;
            const ordersChange = priorOrders > 0 ? ((totalOrders - priorOrders) / priorOrders * 100) : 0;
            const videosChange = priorVideos > 0 ? ((totalVideos - priorVideos) / priorVideos * 100) : 0;

            const winnersCount = window.weeklyWinners?.length || 0;
            const attentionCount = window.weeklyAttentionList?.length || 0;

            const summary = ` WEEKLY SUMMARY - ${brandLabel}
Week of ${formatDate(startDate)}  ${formatDate(endDate)}

 Total GMV: ${fmtMoney(totalGmv)} (${gmvChange >= 0 ? '+' : ''}${gmvChange.toFixed(1)}% WoW)
 Orders: ${fmt(totalOrders)} (${ordersChange >= 0 ? '+' : ''}${ordersChange.toFixed(1)}% WoW)
 Videos: ${fmt(totalVideos)} (${videosChange >= 0 ? '+' : ''}${videosChange.toFixed(1)}% WoW)
 Active Creators: ${activeCreators.size}

 Winners: ${winnersCount} creators crushing it
 Attention: ${attentionCount} creators need follow-up

${gmvChange >= 10 ? ' Strong week overall!' : gmvChange <= -10 ? ' GMV down - worth investigating' : ' Steady week'}`;

            document.getElementById('weeklySummaryContent').textContent = summary;
        }

        async function generateCreatorAttentionList(thisWeekData, priorWeekData, startDate, endDate, brandFilter) {
            // Aggregate this week by creator
            const thisWeekCreators = {};
            thisWeekData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!thisWeekCreators[key]) {
                    thisWeekCreators[key] = { 
                        name: row.creator_name, 
                        brand: row.brand, 
                        gmv: 0, 
                        orders: 0, 
                        videos: 0,
                        daysActive: new Set(),
                        dailyVideos: [] // Track videos per day for consistency
                    };
                }
                thisWeekCreators[key].gmv += pFloat(row.gmv);
                thisWeekCreators[key].orders += pInt(row.orders);
                thisWeekCreators[key].videos += pInt(row.videos);
                if (row.videos > 0 || row.gmv > 0) {
                    thisWeekCreators[key].daysActive.add(row.report_date);
                }
                if (row.videos > 0) {
                    thisWeekCreators[key].dailyVideos.push(row.videos);
                }
            });

            // Aggregate prior week by creator
            const priorWeekCreators = {};
            priorWeekData.forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!priorWeekCreators[key]) {
                    priorWeekCreators[key] = { gmv: 0, orders: 0, videos: 0 };
                }
                priorWeekCreators[key].gmv += pFloat(row.gmv);
                priorWeekCreators[key].orders += pInt(row.orders);
                priorWeekCreators[key].videos += pInt(row.videos);
            });

            const attentionList = [];

            // Check each creator
            Object.entries(thisWeekCreators).forEach(([key, data]) => {
                const prior = priorWeekCreators[key] || { gmv: 0, orders: 0, videos: 0 };
                const brandDisplay = BRAND_DISPLAY[data.brand] || data.brand;
                const issues = [];

                // Check for GMV decline (>30% drop)
                if (prior.gmv > 100 && data.gmv < prior.gmv * 0.7) {
                    const dropPct = ((prior.gmv - data.gmv) / prior.gmv * 100).toFixed(0);
                    issues.push({
                        type: 'gmv_decline',
                        severity: prior.gmv > 1000 ? 3 : 2,
                        message: `GMV down ${dropPct}% (${fmtMoney(prior.gmv)}  ${fmtMoney(data.gmv)})`
                    });
                }

                // Check for low posting (less than 3 videos this week)
                if (data.videos < 3 && prior.videos >= 3) {
                    issues.push({
                        type: 'low_posting',
                        severity: 2,
                        message: `Only ${data.videos} video${data.videos !== 1 ? 's' : ''} this week (was ${prior.videos} last week)`
                    });
                }

                // Check for no activity (0 videos AND was active before)
                if (data.videos === 0 && prior.videos > 0) {
                    issues.push({
                        type: 'inactive',
                        severity: 3,
                        message: `No videos posted this week (had ${prior.videos} last week)`
                    });
                }

                // Check for tier risk (close to dropping)
                const currentTier = getTierFromGMV(data.gmv * 4); // Rough monthly projection
                const thresholds = Object.entries(TIER_THRESHOLDS).sort((a, b) => b[1] - a[1]);
                for (const [tier, threshold] of thresholds) {
                    if (data.gmv * 4 >= threshold && data.gmv * 4 < threshold * 1.2) {
                        issues.push({
                            type: 'tier_risk',
                            severity: 1,
                            message: `At risk of dropping from ${TIER_NAMES[tier]} tier`
                        });
                        break;
                    }
                }

                // Check for posting inconsistency (irregular posting pattern)
                let consistencyScore = 'steady';
                if (data.dailyVideos && data.dailyVideos.length >= 2) {
                    const maxDaily = Math.max(...data.dailyVideos);
                    const avgDaily = data.dailyVideos.reduce((a, b) => a + b, 0) / data.dailyVideos.length;
                    const daysWithVideos = data.dailyVideos.length;
                    
                    // Inconsistent if: max is 3x+ average, or posting on less than 3 days with total 5+ videos
                    if (maxDaily >= avgDaily * 3 || (daysWithVideos <= 2 && data.videos >= 5)) {
                        consistencyScore = 'inconsistent';
                        if (data.gmv >= 500) { // Only flag if meaningful creator
                            issues.push({
                                type: 'inconsistent',
                                severity: 1,
                                message: `Inconsistent posting (${daysWithVideos} active days, ${data.videos} videos)`
                            });
                        }
                    }
                }

                if (issues.length > 0) {
                    const maxSeverity = Math.max(...issues.map(i => i.severity));
                    attentionList.push({
                        name: data.name,
                        brand: brandDisplay,
                        brandKey: data.brand,
                        gmv: data.gmv,
                        priorGmv: prior.gmv,
                        videos: data.videos,
                        priorVideos: prior.videos,
                        daysActive: data.daysActive.size,
                        consistencyScore,
                        issues,
                        severity: maxSeverity,
                        isManaged: isManagedForBrand(data.name, data.brand)
                    });
                }
            });

            // Also check for creators who were active last week but not this week at all
            Object.entries(priorWeekCreators).forEach(([key, prior]) => {
                if (!thisWeekCreators[key] && prior.gmv > 100) {
                    const [name, brand] = key.split('|||');
                    const brandDisplay = BRAND_DISPLAY[brand] || brand;
                    attentionList.push({
                        name,
                        brand: brandDisplay,
                        brandKey: brand,
                        gmv: 0,
                        priorGmv: prior.gmv,
                        videos: 0,
                        priorVideos: prior.videos,
                        issues: [{
                            type: 'disappeared',
                            severity: 3,
                            message: `No activity this week (had ${fmtMoney(prior.gmv)} GMV last week)`
                        }],
                        severity: 3,
                        isManaged: isManagedForBrand(name, brand)
                    });
                }
            });

            // Sort by severity (highest first), then by prior GMV (biggest losses first)
            attentionList.sort((a, b) => {
                if (b.severity !== a.severity) return b.severity - a.severity;
                return b.priorGmv - a.priorGmv;
            });

            // Filter to only managed creators for Matt's list
            const managedAttention = attentionList.filter(c => c.isManaged);
            const unmanagedAttention = attentionList.filter(c => !c.isManaged);

            // Generate the message
            let msg = ` CREATOR ATTENTION LIST - Week of ${formatDate(startDate)}

`;

            if (managedAttention.length === 0 && unmanagedAttention.length === 0) {
                msg += ` All creators looking good this week! No major concerns.`;
            } else {
                if (managedAttention.length > 0) {
                    msg += ` MANAGED CREATORS NEEDING ATTENTION (${managedAttention.length})


`;
                    managedAttention.slice(0, 15).forEach((c, i) => {
                        const severityIcon = c.severity >= 3 ? '' : c.severity >= 2 ? '' : '';
                        msg += `${i + 1}. ${severityIcon} ${c.name} (${c.brand})
`;
                        c.issues.forEach(issue => {
                            msg += `    ${issue.message}
`;
                        });
                        msg += `
`;
                    });

                    if (managedAttention.length > 15) {
                        msg += `   ... and ${managedAttention.length - 15} more managed creators needing attention

`;
                    }
                }

                if (unmanagedAttention.length > 0) {
                    msg += `
 UNMANAGED CREATORS WITH ISSUES (${unmanagedAttention.length})


`;
                    // Just show top 10 unmanaged by prior GMV
                    unmanagedAttention.slice(0, 10).forEach((c, i) => {
                        msg += `${i + 1}. ${c.name} (${c.brand}) - ${c.issues[0].message}
`;
                    });

                    if (unmanagedAttention.length > 10) {
                        msg += `   ... and ${unmanagedAttention.length - 10} more

`;
                    }
                }

                msg += `

 SUMMARY
 Managed creators needing attention: ${managedAttention.length}
 Unmanaged creators with issues: ${unmanagedAttention.length}
 Most common issue: ${getMostCommonIssue(attentionList)}`;
            }

            document.getElementById('creatorAttentionContent').textContent = msg;

            // Update stats and badge
            document.getElementById('weeklyAttentionCount').textContent = attentionList.length;
            document.getElementById('weeklyManagedAttention').textContent = `${managedAttention.length} managed`;
            const attentionListCount = document.getElementById('attentionListCount');
            if (attentionListCount) attentionListCount.textContent = attentionList.length;

            // Store for global access
            window.weeklyAttentionList = attentionList;

            // Populate attention by brand
            window.weeklyBrandAttention = {};
            attentionList.forEach(c => {
                if (!window.weeklyBrandAttention[c.brandKey]) {
                    window.weeklyBrandAttention[c.brandKey] = [];
                }
                window.weeklyBrandAttention[c.brandKey].push(c);
            });

            // Render the table
            const tableBody = document.getElementById('attentionTableBody');
            if (attentionList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon"></div><h3>All creators looking good!</h3><p>No major concerns this week</p></div></td></tr>`;
            } else {
                tableBody.innerHTML = attentionList.map(c => {
                    const gmvChange = c.priorGmv > 0 ? ((c.gmv - c.priorGmv) / c.priorGmv * 100) : 0;
                    const changeClass = gmvChange >= 0 ? 'positive' : 'negative';
                    const issueLabels = {
                        'gmv_decline': 'GMV ',
                        'low_posting': 'Low Posts',
                        'inactive': 'Inactive',
                        'tier_risk': 'Tier Risk',
                        'disappeared': 'Gone',
                        'inconsistent': 'Irregular'
                    };
                    const issueBadges = c.issues.map(i => {
                        const badgeClass = i.severity >= 3 ? 'severe' : i.severity >= 2 ? 'warning' : 'info';
                        return `<span class="issue-badge ${badgeClass}">${issueLabels[i.type] || i.type}</span>`;
                    }).join('');

                    const consistencyIndicator = c.consistencyScore === 'inconsistent' 
                        ? '<span title="Irregular posting pattern" style="color: var(--warning);"></span>' 
                        : '';

                    return `
                        <tr>
                            <td><strong>${c.name}</strong></td>
                            <td>${c.brand}</td>
                            <td>${issueBadges}</td>
                            <td>${fmtMoney(c.gmv)}</td>
                            <td>${fmtMoney(c.priorGmv)}</td>
                            <td><span class="change-indicator ${changeClass}">${gmvChange >= 0 ? '+' : ''}${gmvChange.toFixed(0)}%</span></td>
                            <td>${c.videos} ${consistencyIndicator} <span style="color: var(--text-muted); font-size: 0.75rem;">(${c.daysActive || '?'}d)</span></td>
                            <td><span class="status-badge ${c.isManaged ? 'managed' : 'unmanaged'}">${c.isManaged ? ' Managed' : 'Unmanaged'}</span></td>
                        </tr>
                    `;
                }).join('');
            }

            // Now generate winners list
            await generateWeeklyWinners(thisWeekCreators, priorWeekCreators, startDate, endDate);
        }

        async function generateWeeklyWinners(thisWeekCreators, priorWeekCreators, startDate, endDate) {
            const winners = [];

            // Check each creator for wins
            Object.entries(thisWeekCreators).forEach(([key, data]) => {
                const prior = priorWeekCreators[key] || { gmv: 0, orders: 0, videos: 0 };
                const brandDisplay = BRAND_DISPLAY[data.brand] || data.brand;
                const achievements = [];

                const gmvGrowth = prior.gmv > 50 ? ((data.gmv - prior.gmv) / prior.gmv * 100) : 0;
                const videoGrowth = prior.videos > 0 ? ((data.videos - prior.videos) / prior.videos * 100) : 0;

                // Big GMV growth (50%+ increase with meaningful volume)
                if (gmvGrowth >= 50 && data.gmv >= 200) {
                    achievements.push({
                        type: 'growth',
                        label: ' Growth',
                        message: `GMV up ${gmvGrowth.toFixed(0)}%`
                    });
                }

                // High performer (top GMV)
                if (data.gmv >= 2000) {
                    achievements.push({
                        type: 'top_performer',
                        label: ' Top Earner',
                        message: `${fmtMoney(data.gmv)} this week`
                    });
                }

                // Consistency king (7+ videos)
                if (data.videos >= 7) {
                    achievements.push({
                        type: 'consistent',
                        label: ' Consistent',
                        message: `${data.videos} videos posted`
                    });
                }

                // Video growth (doubled or more)
                if (videoGrowth >= 100 && data.videos >= 5) {
                    achievements.push({
                        type: 'video_growth',
                        label: ' Posting Up',
                        message: `${prior.videos}  ${data.videos} videos`
                    });
                }

                // New star (new or was tiny, now significant)
                if ((!prior.gmv || prior.gmv < 50) && data.gmv >= 500) {
                    achievements.push({
                        type: 'new_star',
                        label: ' Rising Star',
                        message: `New with ${fmtMoney(data.gmv)}`
                    });
                }

                // High conversion (good orders to videos ratio)
                if (data.videos > 0 && data.orders > 0 && (data.orders / data.videos) >= 0.5) {
                    achievements.push({
                        type: 'converter',
                        label: ' High Convert',
                        message: `${(data.orders / data.videos * 100).toFixed(0)}% conversion`
                    });
                }

                if (achievements.length > 0) {
                    winners.push({
                        name: data.name,
                        brand: brandDisplay,
                        brandKey: data.brand,
                        gmv: data.gmv,
                        priorGmv: prior.gmv,
                        videos: data.videos,
                        priorVideos: prior.videos,
                        gmvGrowth,
                        achievements,
                        isManaged: isManagedForBrand(data.name, data.brand),
                        score: data.gmv + (gmvGrowth * 10) + (data.videos * 50) // Score for sorting
                    });
                }
            });

            // Sort by score (best performers first)
            winners.sort((a, b) => b.score - a.score);

            // Store globally
            window.weeklyWinners = winners;

            // Populate winners by brand
            window.weeklyBrandWinners = {};
            winners.forEach(w => {
                if (!window.weeklyBrandWinners[w.brandKey]) {
                    window.weeklyBrandWinners[w.brandKey] = [];
                }
                window.weeklyBrandWinners[w.brandKey].push(w);
            });

            // Generate copy message
            const managedWinners = winners.filter(w => w.isManaged);
            const topWinners = winners.slice(0, 20);

            let msg = ` WEEKLY WINNERS - Week of ${formatDate(startDate)}

`;

            if (winners.length === 0) {
                msg += `No standout performances this week yet. Keep pushing!`;
            } else {
                msg += ` TOP PERFORMERS (${winners.length} total winners)


`;
                topWinners.forEach((w, i) => {
                    const achievementText = w.achievements.map(a => a.label).join(' ');
                    msg += `${i + 1}. ${w.name} (${w.brand}) ${achievementText}
    GMV: ${fmtMoney(w.gmv)} | Videos: ${w.videos} | Growth: ${w.gmvGrowth >= 0 ? '+' : ''}${w.gmvGrowth.toFixed(0)}%

`;
                });

                if (winners.length > 20) {
                    msg += `... and ${winners.length - 20} more winners!

`;
                }

                msg += `
 SUMMARY
 Total winners: ${winners.length}
 Managed winners: ${managedWinners.length}
 Top achievement: ${getTopAchievement(winners)}`;
            }

            document.getElementById('weeklyWinnersContent').textContent = msg;

            // Render the table
            const tableBody = document.getElementById('winnersTableBody');
            if (winners.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon"></div><h3>No standout winners yet</h3><p>Check back after more data comes in</p></div></td></tr>`;
            } else {
                tableBody.innerHTML = winners.slice(0, 50).map(w => {
                    const changeClass = w.gmvGrowth >= 0 ? 'positive' : 'negative';
                    const badgeColors = {
                        'top_performer': 'gold',
                        'growth': '',
                        'consistent': 'purple',
                        'video_growth': 'blue',
                        'new_star': 'cyan',
                        'converter': 'purple'
                    };
                    const achievementBadges = w.achievements.map(a => {
                        const colorClass = badgeColors[a.type] || '';
                        return `<span class="winner-badge ${colorClass}">${a.label}</span>`;
                    }).join('');

                    return `
                        <tr>
                            <td><strong>${w.name}</strong></td>
                            <td>${w.brand}</td>
                            <td>${achievementBadges}</td>
                            <td>${fmtMoney(w.gmv)}</td>
                            <td>${fmtMoney(w.priorGmv)}</td>
                            <td><span class="change-indicator ${changeClass}">${w.gmvGrowth >= 0 ? '+' : ''}${w.gmvGrowth.toFixed(0)}%</span></td>
                            <td>${w.videos} <span style="color: var(--text-muted); font-size: 0.75rem;">(was ${w.priorVideos})</span></td>
                            <td><span class="status-badge ${w.isManaged ? 'managed' : 'unmanaged'}">${w.isManaged ? ' Managed' : 'Unmanaged'}</span></td>
                        </tr>
                    `;
                }).join('');
            }

            // Update growing count stat and badge
            document.getElementById('weeklyGrowingCount').textContent = winners.length;
            const winnersListCount = document.getElementById('winnersListCount');
            if (winnersListCount) winnersListCount.textContent = winners.length;
        }

        function toggleWeeklyBrandComplete(brandKey, checked) {
            if (checked === undefined) {
                // Toggle mode
                if (window.completedWeeklyBrands.has(brandKey)) {
                    window.completedWeeklyBrands.delete(brandKey);
                } else {
                    window.completedWeeklyBrands.add(brandKey);
                }
            } else {
                // Explicit set mode
                if (checked) {
                    window.completedWeeklyBrands.add(brandKey);
                } else {
                    window.completedWeeklyBrands.delete(brandKey);
                }
            }
            saveCompletedWeeklyBrands();
            
            // Rebuild with stored data
            buildWeeklyBrandBoard(
                window.weeklyCreators || [], 
                window.weeklyWinners || [], 
                window.weeklyAttention || [], 
                window.weeklyBrandTotals || {}
            );
        }

        function openWeeklyBrandDetail(brandKey) {
            window.currentWeeklyBrand = brandKey;
            const brandDisplay = BRAND_DISPLAY[brandKey] || brandKey;
            const kpiData = window.brandKpiDetails?.[brandKey] || {};
            const winners = window.weeklyBrandWinners?.[brandKey] || [];
            const attention = window.weeklyBrandAttention?.[brandKey] || [];

            document.getElementById('weeklyBrandDetailName').textContent = brandDisplay;
            document.getElementById('weeklyBrandGmv').textContent = fmtMoney(kpiData.thisWeek?.gmv || 0);
            document.getElementById('weeklyBrandChange').textContent = `${kpiData.gmvChange >= 0 ? '+' : ''}${kpiData.gmvChange?.toFixed(1) || 0}%`;
            document.getElementById('weeklyBrandChange').className = `value ${kpiData.gmvChange >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('weeklyBrandOrders').textContent = fmt(kpiData.thisWeek?.orders || 0);
            document.getElementById('weeklyBrandCreators').textContent = kpiData.thisWeek?.creators?.size || 0;

            // Winners
            document.getElementById('weeklyBrandWinnersCount').textContent = winners.length;
            const winnersContainer = document.getElementById('weeklyBrandWinnersContainer');
            if (winners.length === 0) {
                winnersContainer.innerHTML = '<p style="color: var(--text-muted);">No standout winners for this brand this week.</p>';
            } else {
                // Store winners for copy
                window.currentBrandWinners = winners;
                winnersContainer.innerHTML = winners.slice(0, 10).map((w, i) => `
                    <div class="winner-item" style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease;" onclick="copyWinnerShoutout(${i}, this)" title="Click to copy shoutout">
                        <div>
                            <strong>${w.name}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${w.achievements.map(a => a.label).join(' ')}</div>
                        </div>
                        <div style="text-align: right; display: flex; align-items: center; gap: 12px;">
                            <div>
                                <div style="font-weight: 700; color: var(--success);">${fmtMoney(w.gmv)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${w.gmvGrowth >= 0 ? '+' : ''}${w.gmvGrowth.toFixed(0)}%</div>
                            </div>
                            <span style="font-size: 0.8rem; color: var(--text-muted);"></span>
                        </div>
                    </div>
                `).join('');
            }

            // Attention
            document.getElementById('weeklyBrandAttentionCount').textContent = attention.length;
            const attentionContainer = document.getElementById('weeklyBrandAttentionContainer');
            if (attention.length === 0) {
                attentionContainer.innerHTML = '<p style="color: var(--text-muted);">All creators looking good for this brand!</p>';
            } else {
                attentionContainer.innerHTML = attention.slice(0, 10).map(c => `
                    <div style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${c.name}</strong>
                            <span style="font-size: 0.8rem;">${fmtMoney(c.gmv)} <span style="color: var(--text-muted);">(was ${fmtMoney(c.priorGmv)})</span></span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--warning); margin-top: 4px;">${c.issues.map(i => i.message).join('  ')}</div>
                    </div>
                `).join('');
            }

            // Talking Points
            const talkingPointsEl = document.getElementById('weeklyBrandTalkingPoints');
            const gmvTrend = kpiData.gmvChange >= 10 ? ' Strong growth' : kpiData.gmvChange <= -10 ? ' Declining' : ' Steady';
            talkingPointsEl.innerHTML = `
                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li><strong>GMV:</strong> ${fmtMoney(kpiData.thisWeek?.gmv || 0)} (${kpiData.gmvChange >= 0 ? '+' : ''}${kpiData.gmvChange?.toFixed(1) || 0}% WoW) ${gmvTrend}</li>
                    <li><strong>Active Creators:</strong> ${kpiData.thisWeek?.creators?.size || 0}</li>
                    <li><strong>Top Performer:</strong> ${kpiData.topCreators?.[0]?.name || 'N/A'} - ${fmtMoney(kpiData.topCreators?.[0]?.gmv || 0)}</li>
                    <li><strong>Wins to celebrate:</strong> ${winners.length} creators crushing it</li>
                    <li><strong>Need follow-up:</strong> ${attention.length} creators ${attention.length > 0 ? '- recommend outreach' : ''}</li>
                </ul>
            `;

            document.getElementById('weeklyBrandDetail').style.display = 'block';
            document.getElementById('weeklyBrandBoard').parentElement.parentElement.style.display = 'none';
        }

        function closeWeeklyBrandDetail() {
            document.getElementById('weeklyBrandDetail').style.display = 'none';
            document.getElementById('weeklyBrandBoard').parentElement.parentElement.style.display = 'block';
        }

        function markWeeklyBrandComplete() {
            if (window.currentWeeklyBrand) {
                window.completedWeeklyBrands.add(window.currentWeeklyBrand);
                saveCompletedWeeklyBrands();
                closeWeeklyBrandDetail();
                buildWeeklyBrandBoard();
            }
        }

        function copyWeeklyBrandReport() {
            if (window.currentWeeklyBrand && window.brandKpiReports?.[window.currentWeeklyBrand]) {
                navigator.clipboard.writeText(window.brandKpiReports[window.currentWeeklyBrand]);
            }
        }

        function copyWinnerShoutout(index, element) {
            const winners = window.currentBrandWinners || [];
            const w = winners[index];
            if (!w) return;

            const brandDisplay = BRAND_DISPLAY[window.currentWeeklyBrand] || window.currentWeeklyBrand;
            const achievementText = w.achievements.map(a => a.label).join(' ');
            
            const shoutout = ` WEEKLY WINNER SHOUTOUT!

Big congratulations to @${w.name} for an incredible week with ${brandDisplay}! ${achievementText}

 Stats:
 GMV: ${fmtMoney(w.gmv)} (+${w.gmvGrowth.toFixed(0)}% growth!)
 Videos: ${w.videos}

Keep crushing it! `;

            navigator.clipboard.writeText(shoutout).then(() => {
                element.style.borderColor = 'var(--success)';
                element.style.background = 'var(--success-dim)';
                setTimeout(() => {
                    element.style.borderColor = 'transparent';
                    element.style.background = 'var(--bg-card)';
                }, 1500);
            });
        }

        function getTopAchievement(winners) {
            const counts = {};
            winners.forEach(w => {
                w.achievements.forEach(a => {
                    counts[a.type] = (counts[a.type] || 0) + 1;
                });
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            if (sorted.length === 0) return 'None';
            const typeLabels = {
                'growth': 'GMV Growth',
                'top_performer': 'Top Earners',
                'consistent': 'Consistency',
                'video_growth': 'Posting Growth',
                'new_star': 'Rising Stars',
                'converter': 'High Converters'
            };
            return typeLabels[sorted[0][0]] || sorted[0][0];
        }

        function toggleWinnersView() {
            const tableView = document.getElementById('winnersTableView');
            const copyView = document.getElementById('winnersCopyView');
            const toggleBtn = document.getElementById('winnersViewToggle');

            if (tableView.style.display === 'none') {
                tableView.style.display = 'block';
                copyView.style.display = 'none';
                toggleBtn.textContent = ' Show Copy Version';
            } else {
                tableView.style.display = 'none';
                copyView.style.display = 'block';
                toggleBtn.textContent = ' Show Table View';
            }
        }

        function toggleAttentionView() {
            const tableView = document.getElementById('attentionTableView');
            const copyView = document.getElementById('attentionCopyView');
            const toggleBtn = document.getElementById('attentionViewToggle');

            if (tableView.style.display === 'none') {
                tableView.style.display = 'block';
                copyView.style.display = 'none';
                toggleBtn.textContent = ' Show Copy Version';
            } else {
                tableView.style.display = 'none';
                copyView.style.display = 'block';
                toggleBtn.textContent = ' Show Table View';
            }
        }

        function getMostCommonIssue(list) {
            const counts = {};
            list.forEach(c => {
                c.issues.forEach(i => {
                    counts[i.type] = (counts[i.type] || 0) + 1;
                });
            });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            if (sorted.length === 0) return 'None';
            const typeLabels = {
                'gmv_decline': 'GMV decline',
                'low_posting': 'Low posting',
                'inactive': 'Inactive',
                'tier_risk': 'Tier risk',
                'disappeared': 'Disappeared',
                'inconsistent': 'Inconsistent posting'
            };
            return typeLabels[sorted[0][0]] || sorted[0][0];
        }

        async function generateBrandKpiReports(thisWeekData, priorWeekData, startDate, endDate, brandFilter) {
            // Aggregate by brand for this week
            const thisWeekBrands = {};
            const thisWeekCreatorGrowth = {}; // Track creator growth for stats
            
            thisWeekData.forEach(row => {
                if (!thisWeekBrands[row.brand]) {
                    thisWeekBrands[row.brand] = { 
                        gmv: 0, orders: 0, videos: 0, commission: 0,
                        creators: new Set(),
                        creatorData: {}
                    };
                }
                thisWeekBrands[row.brand].gmv += pFloat(row.gmv);
                thisWeekBrands[row.brand].orders += pInt(row.orders);
                thisWeekBrands[row.brand].videos += pInt(row.videos);
                thisWeekBrands[row.brand].commission += pFloat(row.est_commission);
                thisWeekBrands[row.brand].creators.add(row.creator_name);

                // Track individual creator performance
                if (!thisWeekBrands[row.brand].creatorData[row.creator_name]) {
                    thisWeekBrands[row.brand].creatorData[row.creator_name] = { gmv: 0, videos: 0, orders: 0 };
                }
                thisWeekBrands[row.brand].creatorData[row.creator_name].gmv += pFloat(row.gmv);
                thisWeekBrands[row.brand].creatorData[row.creator_name].videos += pInt(row.videos);
                thisWeekBrands[row.brand].creatorData[row.creator_name].orders += pInt(row.orders);

                // Track all creators for growth calculation
                const key = `${row.creator_name}|||${row.brand}`;
                if (!thisWeekCreatorGrowth[key]) thisWeekCreatorGrowth[key] = { gmv: 0 };
                thisWeekCreatorGrowth[key].gmv += pFloat(row.gmv);
            });

            // Aggregate by brand for prior week
            const priorWeekBrands = {};
            const priorWeekCreatorGrowth = {};
            
            priorWeekData.forEach(row => {
                if (!priorWeekBrands[row.brand]) {
                    priorWeekBrands[row.brand] = { gmv: 0, orders: 0, videos: 0, creatorData: {} };
                }
                priorWeekBrands[row.brand].gmv += pFloat(row.gmv);
                priorWeekBrands[row.brand].orders += pInt(row.orders);
                priorWeekBrands[row.brand].videos += pInt(row.videos);

                // Track individual creator for prior week
                if (!priorWeekBrands[row.brand].creatorData[row.creator_name]) {
                    priorWeekBrands[row.brand].creatorData[row.creator_name] = { gmv: 0, videos: 0 };
                }
                priorWeekBrands[row.brand].creatorData[row.creator_name].gmv += pFloat(row.gmv);
                priorWeekBrands[row.brand].creatorData[row.creator_name].videos += pInt(row.videos);

                // Track for growth calculation
                const key = `${row.creator_name}|||${row.brand}`;
                if (!priorWeekCreatorGrowth[key]) priorWeekCreatorGrowth[key] = { gmv: 0 };
                priorWeekCreatorGrowth[key].gmv += pFloat(row.gmv);
            });

            // Calculate growing creators (10%+ growth)
            let growingCount = 0;
            Object.entries(thisWeekCreatorGrowth).forEach(([key, data]) => {
                const prior = priorWeekCreatorGrowth[key];
                if (prior && prior.gmv > 50) { // Only count if had meaningful GMV before
                    const growth = (data.gmv - prior.gmv) / prior.gmv;
                    if (growth >= 0.1) growingCount++;
                }
            });

            // Calculate totals for weekly stats
            let totalGmv = 0, totalVideos = 0, priorTotalGmv = 0, priorTotalVideos = 0;
            Object.values(thisWeekBrands).forEach(b => {
                totalGmv += b.gmv;
                totalVideos += b.videos;
            });
            Object.values(priorWeekBrands).forEach(b => {
                priorTotalGmv += b.gmv;
                priorTotalVideos += b.videos;
            });

            const gmvChangeTotal = priorTotalGmv > 0 ? ((totalGmv - priorTotalGmv) / priorTotalGmv * 100) : 0;
            const videosChangeTotal = priorTotalVideos > 0 ? ((totalVideos - priorTotalVideos) / priorTotalVideos * 100) : 0;

            // Update weekly stats
            document.getElementById('weeklyTotalGmv').textContent = fmtMoney(totalGmv);
            document.getElementById('weeklyGmvChange').textContent = `${gmvChangeTotal >= 0 ? '+' : ''}${gmvChangeTotal.toFixed(1)}% WoW`;
            document.getElementById('weeklyGmvChange').className = `stat-change ${gmvChangeTotal >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('weeklyGrowingCount').textContent = growingCount;
            document.getElementById('weeklyTotalVideos').textContent = fmt(totalVideos);
            document.getElementById('weeklyVideosChange').textContent = `${videosChangeTotal >= 0 ? '+' : ''}${videosChangeTotal.toFixed(1)}% WoW`;
            document.getElementById('weeklyVideosChange').className = `stat-change ${videosChangeTotal >= 0 ? 'positive' : 'negative'}`;

            // Store reports for click-to-copy and detail view
            window.brandKpiReports = {};
            window.brandKpiDetails = {};
            window.weeklyDateRange = { startDate, endDate };

            const brands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            const container = document.getElementById('brandKpiContainer');
            
            let html = '<div class="brand-kpi-grid">';

            brands.forEach(brandKey => {
                const brandDisplay = BRAND_DISPLAY[brandKey] || brandKey;
                const thisWeek = thisWeekBrands[brandKey] || { gmv: 0, orders: 0, videos: 0, commission: 0, creators: new Set(), creatorData: {} };
                const priorWeek = priorWeekBrands[brandKey] || { gmv: 0, orders: 0, videos: 0, creatorData: {} };

                // Calculate changes
                const gmvChange = priorWeek.gmv > 0 ? ((thisWeek.gmv - priorWeek.gmv) / priorWeek.gmv * 100) : 0;
                const ordersChange = priorWeek.orders > 0 ? ((thisWeek.orders - priorWeek.orders) / priorWeek.orders * 100) : 0;
                const videosChange = priorWeek.videos > 0 ? ((thisWeek.videos - priorWeek.videos) / priorWeek.videos * 100) : 0;

                const aov = thisWeek.orders > 0 ? thisWeek.gmv / thisWeek.orders : 0;
                const gmvPerVideo = thisWeek.videos > 0 ? thisWeek.gmv / thisWeek.videos : 0;

                // All creators for this brand with their data
                const allCreators = Object.entries(thisWeek.creatorData)
                    .map(([name, data]) => {
                        const prior = priorWeek.creatorData?.[name] || { gmv: 0, videos: 0 };
                        const creatorGmvChange = prior.gmv > 0 ? ((data.gmv - prior.gmv) / prior.gmv * 100) : 0;
                        return { 
                            name, 
                            ...data, 
                            priorGmv: prior.gmv,
                            priorVideos: prior.videos,
                            gmvChange: creatorGmvChange,
                            isManaged: isManagedForBrand(name, brandKey)
                        };
                    })
                    .sort((a, b) => b.gmv - a.gmv);

                // Top 5 creators for this brand
                const topCreators = allCreators.slice(0, 5);

                // Store detail data
                window.brandKpiDetails[brandKey] = {
                    brandDisplay,
                    thisWeek,
                    priorWeek,
                    gmvChange,
                    ordersChange,
                    videosChange,
                    aov,
                    gmvPerVideo,
                    topCreators,
                    allCreators
                };

                // Generate report text
                const report = ` ${brandDisplay.toUpperCase()} - WEEKLY KPI REPORT
Week: ${formatDate(startDate)}  ${formatDate(endDate)}


 GMV: ${fmtMoney(thisWeek.gmv)} (${gmvChange >= 0 ? '+' : ''}${gmvChange.toFixed(1)}% WoW)
 Orders: ${fmt(thisWeek.orders)} (${ordersChange >= 0 ? '+' : ''}${ordersChange.toFixed(1)}% WoW)
 Videos: ${fmt(thisWeek.videos)} (${videosChange >= 0 ? '+' : ''}${videosChange.toFixed(1)}% WoW)
 Active Creators: ${thisWeek.creators.size}

 KEY METRICS
 AOV: ${fmtMoney(aov)}
 GMV per Video: ${fmtMoney(gmvPerVideo)}
 Est. Commission: ${fmtMoney(thisWeek.commission)}

 TOP 5 CREATORS
${topCreators.map((c, i) => `${i + 1}. ${c.name} - ${fmtMoney(c.gmv)} (${c.videos} videos)`).join('\n')}

${gmvChange >= 10 ? ' Strong week! GMV up significantly.' : gmvChange <= -10 ? ' GMV declined this week - may need attention.' : ' Steady performance this week.'}
`;

                window.brandKpiReports[brandKey] = report;

                // Generate card HTML
                const changeClass = gmvChange >= 0 ? 'positive' : 'negative';
                const changeIcon = gmvChange >= 0 ? '' : '';

                html += `
                <div class="brand-kpi-card" data-brand="${brandKey}" onclick="showBrandDetail('${brandKey}')">
                    <button class="quick-copy-btn" onclick="event.stopPropagation(); quickCopyBrandReport('${brandKey}', this)"> Copy</button>
                    <div class="brand-kpi-header">
                        <span class="brand-kpi-name">${brandDisplay}</span>
                        <span class="brand-kpi-change ${changeClass}">${changeIcon} ${gmvChange >= 0 ? '+' : ''}${gmvChange.toFixed(1)}%</span>
                    </div>
                    <div class="brand-kpi-gmv">${fmtMoney(thisWeek.gmv)}</div>
                    <div class="brand-kpi-stats">
                        <div><span class="label">Orders</span><span class="value">${fmt(thisWeek.orders)}</span></div>
                        <div><span class="label">Videos</span><span class="value">${fmt(thisWeek.videos)}</span></div>
                        <div><span class="label">Creators</span><span class="value">${thisWeek.creators.size}</span></div>
                    </div>
                    <div class="brand-kpi-hint">Click for details</div>
                </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function quickCopyBrandReport(brandKey, btn) {
            const report = window.brandKpiReports[brandKey];
            if (!report) return;

            navigator.clipboard.writeText(report).then(() => {
                btn.classList.add('copied');
                btn.textContent = ' Copied';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.textContent = ' Copy';
                }, 2000);
            });
        }

        let currentBrandDetail = null;

        function showBrandDetail(brandKey) {
            const overview = document.getElementById('brandKpiOverview');
            const detail = document.getElementById('brandKpiDetail');
            const select = document.getElementById('brandKpiSelect');

            if (brandKey === 'overview') {
                overview.style.display = 'block';
                detail.style.display = 'none';
                select.value = 'overview';
                currentBrandDetail = null;
                return;
            }

            const data = window.brandKpiDetails[brandKey];
            if (!data) return;

            currentBrandDetail = brandKey;
            select.value = brandKey;

            const { brandDisplay, thisWeek, priorWeek, gmvChange, ordersChange, videosChange, aov, gmvPerVideo, allCreators } = data;
            const dateRange = window.weeklyDateRange;

            const changeClass = gmvChange >= 0 ? 'positive' : 'negative';

            let html = `
                <div class="brand-detail-header">
                    <div>
                        <div class="brand-detail-title">${brandDisplay}</div>
                        <div class="brand-detail-subtitle">Week of ${formatDate(dateRange.startDate)}  ${formatDate(dateRange.endDate)}</div>
                    </div>
                    <div class="brand-detail-gmv">
                        <div class="value">${fmtMoney(thisWeek.gmv)}</div>
                        <div class="change ${changeClass}">${gmvChange >= 0 ? '' : ''} ${Math.abs(gmvChange).toFixed(1)}% vs last week</div>
                    </div>
                </div>

                <div class="brand-metrics-grid">
                    <div class="brand-metric-card">
                        <div class="value">${fmt(thisWeek.orders)}</div>
                        <div class="label">Orders</div>
                        <div class="change ${ordersChange >= 0 ? 'positive' : 'negative'}">${ordersChange >= 0 ? '+' : ''}${ordersChange.toFixed(1)}%</div>
                    </div>
                    <div class="brand-metric-card">
                        <div class="value">${fmt(thisWeek.videos)}</div>
                        <div class="label">Videos</div>
                        <div class="change ${videosChange >= 0 ? 'positive' : 'negative'}">${videosChange >= 0 ? '+' : ''}${videosChange.toFixed(1)}%</div>
                    </div>
                    <div class="brand-metric-card">
                        <div class="value">${fmtMoney(aov)}</div>
                        <div class="label">AOV</div>
                        <div class="change neutral">Avg Order Value</div>
                    </div>
                    <div class="brand-metric-card">
                        <div class="value">${fmtMoney(gmvPerVideo)}</div>
                        <div class="label">GMV/Video</div>
                        <div class="change neutral">Efficiency</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <div class="card-title"><span></span> All Creators (${allCreators.length})</div>
                    </div>
                    <div class="card-body no-padding">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Creator</th>
                                        <th>GMV</th>
                                        <th>Prior Week</th>
                                        <th>Change</th>
                                        <th>Videos</th>
                                        <th>Orders</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allCreators.slice(0, 50).map((c, i) => {
                                        const cChangeClass = c.gmvChange >= 0 ? 'positive' : 'negative';
                                        return `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td><strong>${c.name}</strong></td>
                                                <td>${fmtMoney(c.gmv)}</td>
                                                <td>${fmtMoney(c.priorGmv)}</td>
                                                <td><span class="change-indicator ${cChangeClass}">${c.gmvChange >= 0 ? '+' : ''}${c.gmvChange.toFixed(0)}%</span></td>
                                                <td>${c.videos}</td>
                                                <td>${c.orders}</td>
                                                <td><span class="status-badge ${c.isManaged ? 'managed' : 'unmanaged'}">${c.isManaged ? '' : '-'}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${allCreators.length > 50 ? `<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">... and ${allCreators.length - 50} more creators</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('brandDetailContent').innerHTML = html;
            overview.style.display = 'none';
            detail.style.display = 'block';
        }

        function copyCurrentBrandReport() {
            if (!currentBrandDetail) return;
            const report = window.brandKpiReports[currentBrandDetail];
            if (!report) return;

            navigator.clipboard.writeText(report).then(() => {
                const btn = event.target;
                btn.textContent = ' Copied!';
                setTimeout(() => {
                    btn.textContent = ' Copy Report';
                }, 2000);
            });
        }

        // ==================== THEME TOGGLE ====================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        }
        
        function updateThemeUI(theme) {
            const thumb = document.getElementById('themeThumb');
            const label = document.getElementById('themeLabel');
            
            if (thumb) thumb.textContent = theme === 'light' ? '' : '';
            if (label) label.textContent = theme === 'light' ? 'Light Mode' : 'Dark Mode';
        }
        
        // Initialize theme from localStorage
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            // Update UI after DOM loads
            document.addEventListener('DOMContentLoaded', () => updateThemeUI(savedTheme));
        })();

        // ==================== BULK ACTIONS ====================
        let selectedRosterIds = new Set();
        let selectedApplicationIds = new Set();
        
        // Roster Bulk Actions
        function toggleRosterSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('#rosterBody .bulk-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const id = cb.dataset.id;
                if (checkbox.checked) {
                    selectedRosterIds.add(id);
                    cb.closest('tr').classList.add('row-selected');
                } else {
                    selectedRosterIds.delete(id);
                    cb.closest('tr').classList.remove('row-selected');
                }
            });
            updateRosterBulkUI();
        }
        
        function toggleRosterSelect(checkbox, id) {
            if (checkbox.checked) {
                selectedRosterIds.add(id);
                checkbox.closest('tr').classList.add('row-selected');
            } else {
                selectedRosterIds.delete(id);
                checkbox.closest('tr').classList.remove('row-selected');
            }
            updateRosterBulkUI();
        }
        
        function updateRosterBulkUI() {
            const count = selectedRosterIds.size;
            document.getElementById('rosterSelectedCount').textContent = count;
            document.getElementById('rosterBulkActions').classList.toggle('show', count > 0);
        }
        
        function clearRosterSelection() {
            selectedRosterIds.clear();
            document.querySelectorAll('#rosterBody .bulk-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('row-selected');
            });
            document.querySelector('#view-roster .select-all-checkbox').checked = false;
            updateRosterBulkUI();
        }
        
        async function bulkUpdateRosterStatus(status) {
            // Status column doesn't exist in managed_creators table
            showToast('Status updates not available - column not in database', 'warning');
            return;
        }
        
        async function bulkUpdateRosterRole(role) {
            if (selectedRosterIds.size === 0) return;
            
            const roleLabel = role === 'incubator' ? 'Incubator' : 'Closer';
            if (!confirm(`Set ${selectedRosterIds.size} creator(s) to ${roleLabel}?`)) return;
            
            try {
                for (const id of selectedRosterIds) {
                    await supabaseClient.from('managed_creators').update({ role }).eq('id', id);
                }
                showToast(`${selectedRosterIds.size} creators updated to ${roleLabel}`, 'success');
                clearRosterSelection();
                loadRosterData();
            } catch (err) {
                console.error('Bulk role update error:', err);
                showToast('Error updating creators', 'error');
            }
        }
        
        async function bulkRemoveFromRoster() {
            if (selectedRosterIds.size === 0) return;
            
            if (!confirm(`Remove ${selectedRosterIds.size} creator(s) from roster? This cannot be undone.`)) return;
            
            try {
                for (const id of selectedRosterIds) {
                    await supabaseClient.from('managed_creators').delete().eq('id', id);
                }
                showToast(`${selectedRosterIds.size} creators removed from roster`, 'success');
                clearRosterSelection();
                loadRosterData();
            } catch (err) {
                console.error('Bulk delete error:', err);
                showToast('Error removing creators', 'error');
            }
        }
        
        function bulkExportRoster() {
            if (selectedRosterIds.size === 0) return;
            
            const selectedCreators = window.rosterData?.filter(c => selectedRosterIds.has(c.id)) || [];
            if (selectedCreators.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            
            const headers = ['Creator', 'Handle', 'Brand', 'Role', 'Status', 'GMV', 'Commission Rate'];
            const rows = selectedCreators.map(c => [
                c.creator_name,
                c.handle,
                c.brand,
                c.role,
                c.status,
                c.gmv || 0,
                c.commission_rate || ''
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            downloadCSV(csv, `roster-export-${selectedCreators.length}-creators.csv`);
            showToast(`Exported ${selectedCreators.length} creators`, 'success');
        }
        
        // Applications Bulk Actions
        function toggleApplicationsSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('#applicationsTableBody .bulk-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const id = cb.dataset.id;
                if (checkbox.checked) {
                    selectedApplicationIds.add(id);
                    cb.closest('tr').classList.add('row-selected');
                } else {
                    selectedApplicationIds.delete(id);
                    cb.closest('tr').classList.remove('row-selected');
                }
            });
            updateApplicationsBulkUI();
        }
        
        function toggleApplicationSelect(checkbox, id) {
            if (checkbox.checked) {
                selectedApplicationIds.add(id);
                checkbox.closest('tr').classList.add('row-selected');
            } else {
                selectedApplicationIds.delete(id);
                checkbox.closest('tr').classList.remove('row-selected');
            }
            updateApplicationsBulkUI();
        }
        
        function updateApplicationsBulkUI() {
            const count = selectedApplicationIds.size;
            document.getElementById('applicationsSelectedCount').textContent = count;
            document.getElementById('applicationsBulkActions').classList.toggle('show', count > 0);
        }
        
        function clearApplicationsSelection() {
            selectedApplicationIds.clear();
            document.querySelectorAll('#applicationsTableBody .bulk-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('row-selected');
            });
            document.querySelector('#view-applications .select-all-checkbox').checked = false;
            updateApplicationsBulkUI();
        }
        
        async function bulkApproveApplications() {
            if (selectedApplicationIds.size === 0) return;
            
            // Fetch the applications to check for Discord
            const { data: applications } = await supabaseClient
                .from('creator_applications')
                .select('*')
                .in('id', Array.from(selectedApplicationIds));
            
            // Check for Discord - accept discord_username, discord_name, or discord_id
            const missingDiscord = applications?.filter(a => {
                const hasDiscord = a.discord_username || a.discord_name || a.discord_id;
                return !hasDiscord || (typeof hasDiscord === 'string' && hasDiscord.trim() === '');
            }) || [];
            
            if (missingDiscord.length > 0) {
                const names = missingDiscord.map(a => a.full_name || a.tiktok_handle || 'Unknown').join(', ');
                showToast(`Cannot approve: ${missingDiscord.length} application(s) missing Discord (${names})`, 'error');
                return;
            }
            
            if (!confirm(`Approve ${selectedApplicationIds.size} application(s) and add to roster?`)) return;
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                for (const id of selectedApplicationIds) {
                    const app = applications.find(a => a.id === id);
                    if (!app) continue;
                    
                    try {
                        // Get Discord name (prefer OAuth username, then manual entry)
                        const discordName = app.discord_username || app.discord_name;
                        const tiktokHandle = normalizeTikTok(app.tiktok_handle);
                        
                        // First check by discord_id + brand (new flow)
                        let existing = null;
                        if (app.discord_id) {
                            const { data } = await supabaseClient
                                .from('managed_creators')
                                .select('id, discord_id, status')
                                .eq('discord_id', app.discord_id)
                                .eq('brand', app.brand)
                                .single();
                            existing = data;
                        }
                        
                        // Fallback: check by tiktok + brand
                        if (!existing && tiktokHandle) {
                            const { data } = await supabaseClient
                                .from('managed_creators')
                                .select('id, discord_id, status')
                                .eq('account_1', tiktokHandle)
                                .eq('brand', app.brand)
                                .single();
                            existing = data;
                        }
                        
                        let managedCreatorId;
                        
                        if (existing) {
                            // Update existing record (handles Applied  Active transition)
                            await supabaseClient
                                .from('managed_creators')
                                .update({
                                    discord_id: app.discord_id || existing.discord_id,
                                    discord_name: discordName ? normalizeDiscord(discordName) : undefined,
                                    discord_avatar: app.discord_avatar || undefined,
                                    email: app.email || undefined,
                                    real_name: app.full_name || undefined,
                                    application_id: app.id,
                                    status: 'Active',
                                    joined_at: new Date().toISOString()
                                })
                                .eq('id', existing.id);
                            
                            managedCreatorId = existing.id;
                        } else {
                            // Create new managed_creator (legacy flow)
                            const { data: newCreator, error: insertError } = await supabaseClient
                                .from('managed_creators')
                                .insert({
                                    real_name: app.full_name || null,
                                    discord_name: normalizeDiscord(discordName) || null,
                                    discord_id: app.discord_id || null,
                                    discord_avatar: app.discord_avatar || null,
                                    email: app.email || null,
                                    brand: app.brand || 'catakor',
                                    role: 'Incubator',
                                    status: 'Active',
                                    account_1: tiktokHandle,
                                    application_id: app.id,
                                    joined_at: new Date().toISOString(),
                                    notes: `Bulk approved on ${new Date().toLocaleDateString()}${app.discord_id ? ' (Discord OAuth)' : ''}`
                                })
                                .select()
                                .single();
                            
                            if (insertError) throw insertError;
                            managedCreatorId = newCreator.id;
                        }
                        
                        // Update application status and link
                        await supabaseClient
                            .from('creator_applications')
                            .update({ 
                                status: 'accepted',
                                managed_creator_id: managedCreatorId,
                                reviewed_by: adminName || 'Admin',
                                reviewed_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', id);
                        
                        successCount++;
                    } catch (appErr) {
                        console.warn('Failed to process application:', app.id, appErr);
                        errorCount++;
                    }
                }
                
                if (errorCount > 0) {
                    showToast(`${successCount} approved, ${errorCount} failed`, 'warning');
                } else {
                    showToast(`${successCount} applications approved and added to roster`, 'success');
                }
                
                clearApplicationsSelection();
                loadApplicationsData();
                await loadManagedCreators();
            } catch (err) {
                console.error('Bulk approve error:', err);
                showToast('Error approving applications', 'error');
            }
        }
        
        async function bulkRejectApplications() {
            if (selectedApplicationIds.size === 0) return;
            
            if (!confirm(`Reject ${selectedApplicationIds.size} application(s)?`)) return;
            
            try {
                for (const id of selectedApplicationIds) {
                    await supabaseClient.from('creator_applications').update({ status: 'rejected' }).eq('id', id);
                }
                showToast(`${selectedApplicationIds.size} applications rejected`, 'success');
                clearApplicationsSelection();
                loadApplicationsData();
            } catch (err) {
                console.error('Bulk reject error:', err);
                showToast('Error rejecting applications', 'error');
            }
        }
        
        function bulkExportApplications() {
            if (selectedApplicationIds.size === 0) return;
            
            const selectedApps = window.applicationsData?.filter(a => selectedApplicationIds.has(a.id)) || [];
            if (selectedApps.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            
            const headers = ['Name', 'Email', 'TikTok Handle', 'Brand', 'Followers', 'Status', 'Applied Date'];
            const rows = selectedApps.map(a => [
                a.name,
                a.email,
                a.tiktok_handle,
                a.brand,
                a.followers || '',
                a.status,
                new Date(a.created_at).toLocaleDateString()
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            downloadCSV(csv, `applications-export-${selectedApps.length}.csv`);
            showToast(`Exported ${selectedApps.length} applications`, 'success');
        }
        
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // ==================== ROSTER ====================
        let rosterCache = { filtered: [], withPerformance: [], grouped: [] };
        let rosterViewMode = 'identity'; // 'identity' or 'entries'
        
        // Handle brand filter change - populate product dropdown
        async function onRosterBrandFilterChange() {
            const brand = document.getElementById('rosterBrandFilter')?.value || 'all';
            const productFilter = document.getElementById('rosterProductFilter');
            
            if (!productFilter) {
                pages.roster = 1;
                loadRosterData();
                return;
            }
            
            // Hide product filter if "All Brands" selected
            if (brand === 'all') {
                productFilter.style.display = 'none';
                productFilter.value = 'all';
                pages.roster = 1;
                loadRosterData();
                return;
            }
            
            // Fetch products for this brand
            try {
                if (!brandProductsCache[brand]) {
                    const { data, error } = await supabaseClient
                        .from('products')
                        .select('product_key, display_name, product_ids')
                        .eq('brand', brand)
                        .eq('status', 'active')
                        .order('display_name');
                    
                    if (error) throw error;
                    brandProductsCache[brand] = data || [];
                }
                
                const products = brandProductsCache[brand];
                
                if (products.length === 0) {
                    productFilter.style.display = 'none';
                    productFilter.value = 'all';
                } else {
                    // Count creators assigned to each product
                    const productCounts = {};
                    managedCreators.filter(c => c.brand === brand).forEach(c => {
                        const pr = c.product_retainers || {};
                        Object.keys(pr).forEach(key => {
                            productCounts[key] = (productCounts[key] || 0) + 1;
                        });
                    });
                    
                    productFilter.innerHTML = '<option value="all">All Products</option>' + 
                        products.map(p => {
                            const count = productCounts[p.product_key] || 0;
                            const skuCount = (p.product_ids || []).length;
                            return `<option value="${p.product_key}">${p.display_name} (${count} creators${skuCount > 1 ? `, ${skuCount} SKUs` : ''})</option>`;
                        }).join('');
                    productFilter.style.display = 'block';
                }
            } catch (err) {
                console.error('Error loading products for roster filter:', err);
                productFilter.style.display = 'none';
            }
            
            pages.roster = 1;
            loadRosterData();
        }
        
        function setRosterView(mode) {
            rosterViewMode = mode;
            document.getElementById('rosterViewIdentity').classList.toggle('active', mode === 'identity');
            document.getElementById('rosterViewEntries').classList.toggle('active', mode === 'entries');
            document.getElementById('rosterTableTitle').textContent = mode === 'identity' ? 'All Creators' : 'All Roster Entries';
            pages.roster = 1;
            renderRosterTable();
        }
        
        async function loadRosterData() {
            showLoading('roster', 'Loading roster data...');
            try {
            const brand = document.getElementById('rosterBrandFilter').value;
            const selectedProduct = document.getElementById('rosterProductFilter')?.value || 'all';
            const status = document.getElementById('rosterStatusFilter').value;
            const search = document.getElementById('rosterSearchInput').value.toLowerCase();
            const startDate = document.getElementById('rosterDateFilterStart').value;
            const endDate = document.getElementById('rosterDateFilterEnd').value;

            if (!startDate || !endDate) { hideLoading('roster'); return; }

            // Calculate prior period
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);
            const priorStartStr = priorStart.toISOString().split('T')[0];
            const priorEndStr = priorEnd.toISOString().split('T')[0];

            // Fetch current period performance with pagination
            let currentPerfData = [];
            let page = 0;
            const pageSize = 30000; // Matches Supabase query limit
            let hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('creator_performance')
                    .select('creator_name, brand, gmv, orders, videos')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    currentPerfData = currentPerfData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break; // 10 pages  30k = 300k rows max
            }

            // Fetch prior period performance
            let priorPerfData = [];
            page = 0;
            hasMore = true;
            
            while (hasMore) {
                let query = supabaseClient.from('creator_performance')
                    .select('creator_name, brand, gmv')
                    .gte('report_date', priorStartStr)
                    .lte('report_date', priorEndStr)
                    .eq('period_type', 'daily')
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (brand !== 'all') query = query.eq('brand', brand);
                
                const { data, error } = await query;
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    priorPerfData = priorPerfData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break; // 10 pages  30k = 300k rows max
            }

            // Build performance maps - keyed by brand:creator_name for per-brand tracking
            // Use normalizeTikTok to strip @ and normalize handles
            const currentPerfMap = new Map();
            
            currentPerfData.forEach(row => {
                const creatorKey = normalizeTikTok(row.creator_name);
                if (!creatorKey) return;
                
                // Normalize brand to lowercase for consistent matching
                const normalizedBrand = (row.brand || '').toLowerCase();
                
                // Store by brand:creator_name for per-brand lookups
                const brandKey = `${normalizedBrand}:${creatorKey}`;
                if (!currentPerfMap.has(brandKey)) {
                    currentPerfMap.set(brandKey, { gmv: 0, orders: 0, videos: 0 });
                }
                const p = currentPerfMap.get(brandKey);
                p.gmv += pFloat(row.gmv);
                p.orders += pInt(row.orders);
                p.videos += pInt(row.videos);
            });

            const priorPerfMap = new Map();
            priorPerfData.forEach(row => {
                const creatorKey = normalizeTikTok(row.creator_name);
                if (!creatorKey) return;
                
                const normalizedBrand = (row.brand || '').toLowerCase();
                const brandKey = `${normalizedBrand}:${creatorKey}`;
                if (!priorPerfMap.has(brandKey)) {
                    priorPerfMap.set(brandKey, { gmv: 0 });
                }
                priorPerfMap.get(brandKey).gmv += pFloat(row.gmv);
            });

            // Filter roster
            let roster = [...managedCreators];
            if (brand !== 'all') roster = roster.filter(c => c.brand === brand);
            if (selectedProduct !== 'all') roster = filterCreatorsByProduct(roster, selectedProduct);
            if (status !== 'all') roster = roster.filter(c => (c.status || 'Active') === status);
            if (search) roster = roster.filter(c => 
                c.real_name?.toLowerCase().includes(search) || 
                c.discord_name?.toLowerCase().includes(search) || 
                c.account_1?.toLowerCase().includes(search) ||
                c.account_2?.toLowerCase().includes(search) ||
                c.account_3?.toLowerCase().includes(search) ||
                c.email?.toLowerCase().includes(search)
            );

            // Build multi-brand map (detect creators who work across multiple brands)
            const accountToBrands = new Map(); // account -> Set of brands
            const emailToBrands = new Map(); // email -> Set of brands
            const discordToBrands = new Map(); // discord -> Set of brands
            
            managedCreators.forEach(c => {
                const accounts = [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].filter(a => a);
                accounts.forEach(acc => {
                    const key = acc.toLowerCase();
                    if (!accountToBrands.has(key)) accountToBrands.set(key, new Set());
                    accountToBrands.get(key).add(c.brand);
                });
                if (c.email) {
                    const key = c.email.toLowerCase();
                    if (!emailToBrands.has(key)) emailToBrands.set(key, new Set());
                    emailToBrands.get(key).add(c.brand);
                }
                if (c.discord_name) {
                    const key = c.discord_name.toLowerCase();
                    if (!discordToBrands.has(key)) discordToBrands.set(key, new Set());
                    discordToBrands.get(key).add(c.brand);
                }
            });

            // Function to get all brands for a creator
            const getOtherBrands = (c) => {
                const allBrands = new Set();
                const accounts = [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].filter(a => a);
                accounts.forEach(acc => {
                    const brands = accountToBrands.get(acc.toLowerCase());
                    if (brands) brands.forEach(b => allBrands.add(b));
                });
                if (c.email) {
                    const brands = emailToBrands.get(c.email.toLowerCase());
                    if (brands) brands.forEach(b => allBrands.add(b));
                }
                if (c.discord_name) {
                    const brands = discordToBrands.get(c.discord_name.toLowerCase());
                    if (brands) brands.forEach(b => allBrands.add(b));
                }
                // Remove current brand to get "other" brands
                allBrands.delete(c.brand);
                return [...allBrands];
            };

            // Attach performance data to roster
            const rosterWithPerf = roster.map(c => {
                // Get performance for all accounts - using brand-specific keys
                const accounts = [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].filter(a => a);
                let gmv = 0, orders = 0, videos = 0, priorGmv = 0;
                
                // Normalize brand to match map keys
                const normalizedBrand = (c.brand || '').toLowerCase();
                
                accounts.forEach(acc => {
                    // Use normalizeTikTok for consistent handle matching
                    const normalizedHandle = normalizeTikTok(acc);
                    if (!normalizedHandle) return;
                    
                    // Use brand:creator_name key for per-brand GMV
                    const brandKey = `${normalizedBrand}:${normalizedHandle}`;
                    const current = currentPerfMap.get(brandKey);
                    const prior = priorPerfMap.get(brandKey);
                    
                    if (current) {
                        gmv += current.gmv;
                        orders += current.orders;
                        videos += current.videos;
                    }
                    if (prior) {
                        priorGmv += prior.gmv;
                    }
                });

                const gmvChange = priorGmv > 0 ? ((gmv - priorGmv) / priorGmv * 100) : (gmv > 0 ? 100 : 0);
                const tier = getTier(gmv);
                const otherBrands = getOtherBrands(c);

                return {
                    ...c,
                    gmv,
                    orders,
                    videos,
                    priorGmv,
                    gmvChange,
                    tier,
                    otherBrands,
                    isMultiBrand: otherBrands.length > 0
                };
            });

            // Sort by GMV descending
            rosterWithPerf.sort((a, b) => b.gmv - a.gmv);
            
            // Cache for export and insights
            rosterCache.filtered = roster;
            rosterCache.withPerformance = rosterWithPerf;
            rosterCache.perfMap = currentPerfMap; // Cache for per-account GMV lookups

            // Group by Discord for identity view
            const identityMap = new Map(); // discord -> grouped creator
            rosterWithPerf.forEach(c => {
                const key = c.discord_name ? c.discord_name.toLowerCase().trim() : `no-discord-${c.id}`;
                
                if (!identityMap.has(key)) {
                    identityMap.set(key, {
                        // Identity info (use first found)
                        id: c.id,
                        discord_name: c.discord_name,
                        real_name: c.real_name,
                        email: c.email,
                        phone: c.phone,
                        // Aggregated data
                        totalGmv: 0,
                        totalPriorGmv: 0,
                        totalRetainer: 0,
                        // Brand entries
                        entries: [],
                        brands: [],
                        uniqueBrands: new Set(),
                        roles: new Set(),
                        // Dates
                        joinedDate: null,
                        // Status (any active = active)
                        hasActive: false,
                        allStatuses: [],
                        // Data health
                        hasMissingData: false
                    });
                }
                
                const identity = identityMap.get(key);
                identity.entries.push(c);
                identity.brands.push(c.brand);
                identity.uniqueBrands.add(c.brand);
                if (c.role) identity.roles.add(c.role);
                identity.totalGmv += c.gmv;
                identity.totalPriorGmv += c.priorGmv;
                identity.totalRetainer += getTotalRetainer(c);
                identity.allStatuses.push(c.status || 'Active');
                if ((c.status || 'Active') === 'Active') identity.hasActive = true;
                
                // Use most complete name
                if (!identity.real_name && c.real_name) identity.real_name = c.real_name;
                if (!identity.email && c.email) identity.email = c.email;
                
                // Track earliest joined date
                if (c.created_at) {
                    if (!identity.joinedDate || c.created_at < identity.joinedDate) {
                        identity.joinedDate = c.created_at;
                    }
                }
                
                // Check data health
                if (!c.discord_name || !c.account_1 || !c.real_name) {
                    identity.hasMissingData = true;
                }
            });
            
            // Convert to array and add computed fields
            const groupedCreators = [...identityMap.values()].map(identity => ({
                ...identity,
                gmvChange: identity.totalPriorGmv > 0 
                    ? ((identity.totalGmv - identity.totalPriorGmv) / identity.totalPriorGmv * 100) 
                    : (identity.totalGmv > 0 ? 100 : 0),
                tier: getTier(identity.totalGmv),
                isMultiBrand: identity.uniqueBrands.size > 1,
                primaryStatus: identity.hasActive ? 'Active' : identity.allStatuses[0] || 'Active',
                primaryRole: identity.entries[0]?.role || 'Incubator',
                allRoles: [...identity.roles],
                uniqueBrandsList: [...identity.uniqueBrands]
            }));
            
            // Sort grouped by total GMV
            groupedCreators.sort((a, b) => b.totalGmv - a.totalGmv);
            rosterCache.grouped = groupedCreators;

            // Apply quick filter
            const quickFilter = document.getElementById('rosterQuickFilter')?.value || 'all';
            let filteredGrouped = [...groupedCreators];
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            if (quickFilter === 'top_performers') {
                filteredGrouped = filteredGrouped.filter(c => ['Gold', 'Platinum', 'Diamond', 'Ruby'].includes(c.tier.name));
            } else if (quickFilter === 'at_risk') {
                filteredGrouped = filteredGrouped.filter(c => c.gmvChange < -20);
            } else if (quickFilter === 'has_retainer') {
                filteredGrouped = filteredGrouped.filter(c => c.totalRetainer > 0);
            } else if (quickFilter === 'has_product') {
                filteredGrouped = filteredGrouped.filter(c => c.entries.some(e => hasAnyProductAssignment(e)));
            } else if (quickFilter === 'multi_brand') {
                filteredGrouped = filteredGrouped.filter(c => c.isMultiBrand);
            } else if (quickFilter === 'new_creators') {
                filteredGrouped = filteredGrouped.filter(c => c.joinedDate && c.joinedDate >= thirtyDaysAgo);
            } else if (quickFilter === 'missing_data') {
                filteredGrouped = filteredGrouped.filter(c => c.hasMissingData);
            }
            
            rosterCache.filteredGrouped = filteredGrouped;

            // Calculate stats (based on unique creators)
            const uniqueCreators = groupedCreators.length;
            const totalEntries = rosterWithPerf.length;
            const totalGmv = groupedCreators.reduce((s, c) => s + c.totalGmv, 0);
            const totalPriorGmv = groupedCreators.reduce((s, c) => s + c.totalPriorGmv, 0);
            const totalRetainer = groupedCreators.reduce((s, c) => s + c.totalRetainer, 0);
            const activeCount = groupedCreators.filter(c => c.hasActive).length;
            const churnedCount = groupedCreators.filter(c => !c.hasActive).length;
            const multiBrandCount = groupedCreators.filter(c => c.isMultiBrand).length;
            const avgGmv = uniqueCreators > 0 ? totalGmv / uniqueCreators : 0;
            const gmvChange = totalPriorGmv > 0 ? ((totalGmv - totalPriorGmv) / totalPriorGmv * 100) : 0;
            const missingDataCount = groupedCreators.filter(c => c.hasMissingData).length;

            // Update stats
            document.getElementById('rosterStatGmv').textContent = fmtMoney(totalGmv);
            const gmvChangeEl = document.getElementById('rosterStatGmvChange');
            if (gmvChangeEl) {
                if (gmvChange !== 0) {
                    gmvChangeEl.textContent = `${gmvChange >= 0 ? '' : ''} ${Math.abs(gmvChange).toFixed(1)}% vs prior`;
                    gmvChangeEl.className = `stat-change ${gmvChange >= 0 ? 'positive' : 'negative'}`;
                } else {
                    gmvChangeEl.textContent = '--';
                    gmvChangeEl.className = 'stat-change neutral';
                }
            }
            document.getElementById('rosterStatUniqueCreators').textContent = uniqueCreators;
            document.getElementById('rosterStatEntriesCount').textContent = `${totalEntries} roster entries`;
            document.getElementById('rosterStatActive').textContent = activeCount;
            document.getElementById('rosterStatChurned').textContent = `${churnedCount} churned`;
            document.getElementById('rosterStatAvgGmv').textContent = fmtMoney(avgGmv);
            document.getElementById('rosterStatMultiBrand').textContent = multiBrandCount;
            const multiBrandPctEl = document.getElementById('rosterStatMultiBrandPct');
            if (multiBrandPctEl) multiBrandPctEl.textContent = uniqueCreators > 0 ? `${Math.round(multiBrandCount / uniqueCreators * 100)}% of roster` : '0%';
            document.getElementById('rosterStatRetainer').textContent = fmtMoney(totalRetainer);
            const missingDataEl = document.getElementById('rosterStatMissingData');
            if (missingDataEl) missingDataEl.textContent = missingDataCount;

            // Render insights
            renderRosterInsights(rosterWithPerf);

            // Load applications
            loadApplicationsSummary();

            // Render table based on current view mode
            renderRosterTable();
            } finally {
                hideLoading('roster');
            }
        }

        function renderRosterTable() {
            const rosterWithPerf = rosterCache.withPerformance || [];
            const groupedCreators = rosterCache.filteredGrouped || rosterCache.grouped || [];
            
            const getRoleClass = (r) => {
                if (r === 'Incubator') return 'background:var(--blue-dim);color:var(--blue)';
                if (r === 'Closer') return 'background:var(--purple-dim);color:var(--purple)';
                if (r === 'Creatives') return 'background:var(--warning-dim);color:var(--warning)';
                return 'background:var(--bg-secondary);color:var(--text-secondary)';
            };

            const getStatusClass = (s) => {
                if (s === 'Active') return 'background:var(--success-dim);color:var(--success)';
                if (s === 'Active') return 'background:var(--success-dim);color:var(--success)';
                if (s === 'On Hold') return 'background:var(--warning-dim);color:var(--warning)';
                if (s === 'Churned') return 'background:var(--danger-dim);color:var(--danger)';
                return 'background:var(--bg-secondary);color:var(--text-secondary)';
            };

            if (rosterViewMode === 'identity') {
                // Identity view - grouped by creator
                document.getElementById('rosterTableHead').innerHTML = `
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" class="select-all-checkbox" onchange="toggleRosterSelectAll(this)"></th>
                        <th>Creator</th>
                        <th>Brands</th>
                        <th>Total GMV</th>
                        <th>Tier</th>
                        <th>Status</th>
                        <th>Retainer</th>
                        <th>ROI</th>
                        <th>Health</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                `;
                
                document.getElementById('rosterTableCount').textContent = `${groupedCreators.length} creators`;
                
                const startIdx = (pages.roster - 1) * PAGE_SIZE;
                const pageData = groupedCreators.slice(startIdx, startIdx + PAGE_SIZE);
                
                // Helper to format joined date
                const formatJoinedDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    const now = new Date();
                    const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
                    if (diffDays < 7) return `${diffDays}d ago`;
                    if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
                    if (diffDays < 365) return `${Math.floor(diffDays / 30)}mo ago`;
                    return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                };
                
                document.getElementById('rosterBody').innerHTML = pageData.map(c => {
                    const displayName = c.real_name || c.discord_name || c.entries[0]?.account_1 || 'Unknown';
                    
                    // Build brand pills - unique brands with count if multiple entries for same brand
                    const brandCounts = {};
                    c.brands.forEach(b => { brandCounts[b] = (brandCounts[b] || 0) + 1; });
                    const brandPills = c.uniqueBrandsList.map(b => {
                        const count = brandCounts[b];
                        return `<span class="brand-pill ${b}">${BRAND_DISPLAY[b] || b}${count > 1 ? ` (${count})` : ''}</span>`;
                    }).join('');
                    
                    const rowIdentifier = String(c.discord_name || c.entries[0]?.id || '');
                    
                    // Data health indicator
                    const healthIcon = c.hasMissingData 
                        ? '<span title="Missing data (Discord, TikTok, or Name)" style="color: var(--warning);"></span>'
                        : '<span title="Complete" style="color: var(--success);"></span>';
                    
                    return `
                        <tr class="roster-row-expandable" onclick="toggleCreatorExpand(this, '${rowIdentifier.replace(/'/g, "\\'")}')">
                            <td onclick="event.stopPropagation();">
                                <span class="roster-expand-icon"></span>
                                <input type="checkbox" class="bulk-checkbox" data-discord="${rowIdentifier.replace(/"/g, '&quot;')}" onchange="toggleRosterSelectIdentity(this)">
                            </td>
                            <td>
                                <div class="creator-cell">
                                    <div class="creator-avatar">${displayName.charAt(0).toUpperCase()}</div>
                                    <div>
                                        <span class="creator-name">${displayName}</span>
                                        ${c.discord_name ? `<div style="font-size: 0.75rem; color: var(--text-muted);"> ${c.discord_name}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td><div class="brand-pills">${brandPills}</div></td>
                            <td>
                                <span class="gmv-value ${c.totalGmv >= 1000 ? 'gmv-high' : ''}">${fmtMoney(c.totalGmv)}</span>
                                ${c.gmvChange !== 0 ? `<div style="font-size: 0.7rem;" class="${c.gmvChange >= 0 ? 'positive' : 'negative'}">${c.gmvChange >= 0 ? '' : ''}${Math.abs(c.gmvChange).toFixed(0)}%</div>` : ''}
                            </td>
                            <td><span class="badge-tier ${c.tier.class}">${c.tier.name}</span></td>
                            <td><span class="badge" style="${getStatusClass(c.primaryStatus)}">${c.primaryStatus}</span></td>
                            <td style="font-size: 0.85rem;">${(() => {
                                // Build retainer breakdown for tooltip
                                const parts = [];
                                c.entries.forEach(e => {
                                    const brandName = BRAND_DISPLAY[e.brand] || e.brand;
                                    if (e.retainer > 0) {
                                        parts.push(`${brandName}: ${fmtMoney(e.retainer)} base`);
                                    }
                                    const pr = e.product_retainers || {};
                                    Object.entries(pr).filter(([k,v]) => v > 0).forEach(([k,v]) => {
                                        const prodName = k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                        parts.push(`${brandName} ${prodName}: ${fmtMoney(v)}`);
                                    });
                                });
                                const tooltipText = parts.length > 0 ? parts.join('\\n') : '';
                                
                                if (c.totalRetainer > 0) {
                                    const hasMultiple = parts.length > 1;
                                    return `<span style="color: var(--success); cursor: ${hasMultiple ? 'help' : 'default'};" ${hasMultiple ? `title="${tooltipText}"` : ''}>${fmtMoney(c.totalRetainer)}${hasMultiple ? ' *' : ''}</span>`;
                                } else if (c.entries.some(e => e.retainer === 0 || Object.values(e.product_retainers || {}).some(v => v === 0))) {
                                    return '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.7rem;">Affiliate</span>';
                                }
                                return '<span style="color: var(--text-muted);"></span>';
                            })()}</td>
                            <td style="font-size: 0.85rem; text-align: center;">${c.totalRetainer > 0 ? (() => {
                                const roi = (c.totalGmv / c.totalRetainer).toFixed(1);
                                const color = roi >= 1 ? 'var(--success)' : 'var(--error)';
                                return `<span style="color: ${color}; font-weight: 600;">${roi}x</span>`;
                            })() : '<span style="color: var(--text-muted);"></span>'}</td>
                            <td style="text-align: center;">${healthIcon}</td>
                            <td style="font-size: 0.85rem; color: var(--text-muted);">${formatJoinedDate(c.joinedDate)}</td>
                            <td onclick="event.stopPropagation();">
                                <button class="action-btn" onclick="addCreatorToBrand('${rowIdentifier.replace(/'/g, "\\'")}')" title="Add to Brand" style="background: var(--success-dim); color: var(--success);"></button>
                            </td>
                        </tr>
                        <tr class="roster-detail-row" id="detail-${rowIdentifier.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none;">
                            <td colspan="11">
                                <div class="roster-brand-details">
                                    ${c.entries.map(e => {
                                        // Get all accounts for this entry
                                        const accounts = [e.account_1, e.account_2, e.account_3, e.account_4, e.account_5].filter(a => a && a.trim());
                                        const normalizedBrand = (e.brand || '').toLowerCase();
                                        const perfMap = rosterCache.perfMap || new Map();
                                        
                                        // Calculate per-account GMV
                                        const accountGmvs = accounts.map(acc => {
                                            const key = `${normalizedBrand}:${normalizeTikTok(acc)}`;
                                            const perf = perfMap.get(key);
                                            return {
                                                account: acc,
                                                gmv: perf?.gmv || 0
                                            };
                                        });
                                        
                                        const entryTotalGmv = accountGmvs.reduce((s, a) => s + a.gmv, 0);
                                        
                                        // Check if there are other entries for same brand (mergeable)
                                        const sameBrandEntries = c.entries.filter(x => x.brand === e.brand);
                                        const canMerge = sameBrandEntries.length > 1;
                                        const otherEntry = canMerge ? sameBrandEntries.find(x => x.id !== e.id) : null;
                                        
                                        return `
                                        <div class="roster-brand-detail-item" style="flex-direction: column; align-items: stretch;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                                    <span class="badge-brand">${BRAND_DISPLAY[e.brand] || e.brand}</span>
                                                    ${getRetainerBreakdownHtml(e)}
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 12px;">
                                                    <span class="gmv-value">${fmtMoney(entryTotalGmv)}</span>
                                                    <span class="badge-tier ${e.tier.class}">${e.tier.name}</span>
                                                    ${canMerge && otherEntry ? `<button class="action-btn" onclick="quickMergeEntries(${e.id}, ${otherEntry.id})" title="Merge other entry into this one" style="background: var(--purple-dim); color: var(--purple);"></button>` : ''}
                                                    <button class="action-btn view" onclick="editCreator(${e.id})" title="Edit"></button>
                                                    <button class="action-btn remove" onclick="deleteCreator(${e.id}, '${(e.real_name || e.account_1 || '').replace(/'/g, "\\'")}')" title="Remove Entry"></button>
                                                </div>
                                            </div>
                                            <div style="background: var(--bg-primary); border-radius: 6px; padding: 8px 12px;">
                                                ${accountGmvs.map((a, idx) => `
                                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; ${idx < accountGmvs.length - 1 ? 'border-bottom: 1px solid var(--border);' : ''}">
                                                        <span style="color: var(--text-muted);">@${a.account}</span>
                                                        <div style="display: flex; align-items: center; gap: 12px;">
                                                            <span style="font-weight: 500; ${a.gmv > 0 ? 'color: var(--success);' : 'color: var(--text-muted);'}">${fmtMoney(a.gmv)}</span>
                                                            <button class="action-btn" onclick="openCreatorDetail('${a.account.replace(/'/g, "\\'")}', '${e.brand}')" title="View Stats" style="padding: 2px 6px; font-size: 0.75rem;"></button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;}).join('')}
                                    <div style="display: flex; justify-content: flex-end; gap: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                                        <span style="color: var(--text-muted); font-size: 0.85rem;">
                                            Total Retainer: <strong style="color: var(--accent);">${fmtMoney(c.totalRetainer)}/mo</strong>
                                        </span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="11"><div class="empty-state"><h3>No creators in roster</h3><p>Add creators to start tracking their performance</p></div></td></tr>';
                
                renderPagination('rosterPagination', groupedCreators.length, pages.roster, (p) => { pages.roster = p; renderRosterTable(); });
                
            } else {
                // Entries view - one row per brand entry (original behavior)
                document.getElementById('rosterTableHead').innerHTML = `
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" class="select-all-checkbox" onchange="toggleRosterSelectAll(this)"></th>
                        <th>Creator</th>
                        <th>Brand</th>
                        <th>Status</th>
                        <th>GMV</th>
                        <th>Tier</th>
                        <th>Retainer</th>
                        <th>ROI</th>
                        <th>Health</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                `;
                
                // Helper to format joined date
                const formatJoinedDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    const now = new Date();
                    const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
                    if (diffDays < 7) return `${diffDays}d ago`;
                    if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
                    if (diffDays < 365) return `${Math.floor(diffDays / 30)}mo ago`;
                    return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                };
                
                document.getElementById('rosterTableCount').textContent = `${rosterWithPerf.length} entries`;
                
                const startIdx = (pages.roster - 1) * PAGE_SIZE;
                const pageData = rosterWithPerf.slice(startIdx, startIdx + PAGE_SIZE);
                
                document.getElementById('rosterBody').innerHTML = pageData.map(c => {
                    const primaryAccount = c.account_1 || '';
                    const creatorStatus = c.status || 'Active';
                    const multiBrandIndicator = c.isMultiBrand 
                        ? `<span title="Also works with: ${c.otherBrands.map(b => BRAND_DISPLAY[b] || b).join(', ')}" style="cursor: help; margin-left: 4px; font-size: 0.7rem; background: var(--purple-dim); color: var(--purple); padding: 2px 6px; border-radius: 4px;">+${c.otherBrands.length}</span>` 
                        : '';
                    
                    // Data health check
                    const hasMissingData = !c.discord_name || !c.account_1 || !c.real_name;
                    const healthIcon = hasMissingData 
                        ? '<span title="Missing data" style="color: var(--warning);"></span>'
                        : '<span title="Complete" style="color: var(--success);"></span>';

                    return `<tr onclick="openCreatorDetail('${primaryAccount.replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                        <td onclick="event.stopPropagation();">
                            <input type="checkbox" class="bulk-checkbox" data-id="${c.id}" onchange="toggleRosterSelect(this, '${c.id}')">
                        </td>
                        <td>
                            <div class="creator-cell">
                                <div class="creator-avatar">${(c.real_name || c.discord_name || '?').charAt(0).toUpperCase()}</div>
                                <div>
                                    <span class="creator-name">${c.real_name || 'Unknown'}${multiBrandIndicator}</span>
                                    ${c.discord_name ? `<div style="font-size: 0.75rem; color: var(--text-muted);">${c.discord_name}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td><span class="badge-brand">${BRAND_DISPLAY[c.brand] || c.brand}</span></td>
                        <td><span class="badge" style="${getStatusClass(creatorStatus)}">${creatorStatus}</span></td>
                        <td><span class="gmv-value ${c.gmv >= 1000 ? 'gmv-high' : ''}">${fmtMoney(c.gmv)}</span></td>
                        <td><span class="badge-tier ${c.tier.class}">${c.tier.name}</span></td>
                        <td style="font-size: 0.85rem;">${c.retainer > 0 ? `<span style="color: var(--success);">${fmtMoney(c.retainer)}</span>` : (c.retainer === 0 ? '<span class="badge" style="background: var(--blue-dim); color: var(--blue); font-size: 0.7rem;">Affiliate</span>' : '<span style="color: var(--text-muted);"></span>')}</td>
                        <td style="font-size: 0.85rem; text-align: center;">${c.retainer > 0 ? (() => {
                            const roi = (c.gmv / c.retainer).toFixed(1);
                            const color = roi >= 1 ? 'var(--success)' : 'var(--error)';
                            return `<span style="color: ${color}; font-weight: 600;">${roi}x</span>`;
                        })() : '<span style="color: var(--text-muted);"></span>'}</td>
                        <td style="text-align: center;">${healthIcon}</td>
                        <td style="font-size: 0.85rem; color: var(--text-muted);">${formatJoinedDate(c.created_at)}</td>
                        <td>
                            <button class="action-btn view" onclick="event.stopPropagation(); editCreator(${c.id})" title="Edit"></button>
                            <button class="action-btn remove" onclick="event.stopPropagation(); deleteCreator(${c.id}, '${(c.real_name || '').replace(/'/g, "\\'")}')" title="Delete"></button>
                        </td>
                    </tr>`;
                }).join('') || '<tr><td colspan="11"><div class="empty-state"><h3>No creators in roster</h3><p>Add creators to start tracking their performance</p></div></td></tr>';

                renderPagination('rosterPagination', rosterWithPerf.length, pages.roster, (p) => { pages.roster = p; renderRosterTable(); });
            }
            
            // Update roster health check
            updateRosterHealthCheck();
        }

        // Helper functions for identity view
        function toggleCreatorExpand(row, discordName) {
            const detailId = `detail-${(discordName || '').replace(/[^a-zA-Z0-9]/g, '_')}`;
            const detailRow = document.getElementById(detailId);
            const icon = row.querySelector('.roster-expand-icon');
            
            if (detailRow) {
                const isHidden = detailRow.style.display === 'none';
                detailRow.style.display = isHidden ? 'table-row' : 'none';
                if (icon) icon.classList.toggle('expanded', isHidden);
            }
        }

        function logContactForCreator(identifier) {
            // Find all entries for this creator and log contact for all
            const entries = getCreatorByDiscord(identifier);
            if (entries.length === 0) {
                // Try by ID
                const entry = managedCreators.find(c => c.id === parseInt(identifier));
                if (entry) {
                    logContact(entry.id);
                }
                return;
            }
            
            // Log contact for the first entry (will update by discord)
            logContact(entries[0].id);
        }

        function addCreatorToBrand(discordName) {
            // Open add creator modal with Discord pre-filled
            openAddCreatorModal();
            if (discordName) {
                document.getElementById('creatorDiscord').value = discordName;
                checkExistingDiscord();
            }
        }

        // Quick merge two entries for the same brand
        async function quickMergeEntries(keepId, mergeId) {
            const keepEntry = managedCreators.find(c => c.id === keepId);
            const mergeEntry = managedCreators.find(c => c.id === mergeId);
            
            if (!keepEntry || !mergeEntry) {
                showToast('Could not find entries to merge', 'error');
                return;
            }
            
            // Collect accounts from merge entry
            const mergeAccounts = [mergeEntry.account_1, mergeEntry.account_2, mergeEntry.account_3, mergeEntry.account_4, mergeEntry.account_5].filter(a => a && a.trim());
            
            // Find available slots in keep entry
            const keepAccounts = [keepEntry.account_1, keepEntry.account_2, keepEntry.account_3, keepEntry.account_4, keepEntry.account_5];
            
            // Try to add merge accounts to empty slots
            let nextSlot = keepAccounts.findIndex(a => !a || !a.trim());
            const accountsToAdd = [];
            
            for (const acc of mergeAccounts) {
                // Skip if already exists in keep entry
                if (keepAccounts.some(k => k && normalizeTikTok(k) === normalizeTikTok(acc))) continue;
                
                if (nextSlot >= 0 && nextSlot < 5) {
                    accountsToAdd.push({ slot: nextSlot + 1, account: acc });
                    keepAccounts[nextSlot] = acc;
                    nextSlot = keepAccounts.findIndex(a => !a || !a.trim());
                }
            }
            
            // Build update object
            const updateData = {};
            accountsToAdd.forEach(a => {
                updateData['account_' + a.slot] = a.account;
            });
            
            // Also merge retainer if mergeEntry has one and keepEntry doesn't
            if (mergeEntry.retainer && !keepEntry.retainer) {
                updateData.retainer = mergeEntry.retainer;
            }
            
            // Merge notes
            if (mergeEntry.notes && mergeEntry.notes.trim()) {
                const existingNotes = keepEntry.notes || '';
                updateData.notes = existingNotes + (existingNotes ? '\n' : '') + '[Merged] ' + mergeEntry.notes;
            }
            
            const accountsAdded = accountsToAdd.length;
            const totalAccounts = mergeAccounts.length;
            
            // Confirm
            const confirmMsg = accountsAdded === totalAccounts 
                ? 'Merge @' + mergeEntry.account_1 + ' into this entry?\n\nThis will add ' + accountsAdded + ' account(s) and delete the duplicate entry.'
                : 'Merge @' + mergeEntry.account_1 + ' into this entry?\n\nOnly ' + accountsAdded + ' of ' + totalAccounts + ' accounts can be added (max 5 slots).\n\nThe duplicate entry will be deleted.';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Update keep entry with new accounts
                if (Object.keys(updateData).length > 0) {
                    const { error: updateError } = await supabaseClient
                        .from('managed_creators')
                        .update(updateData)
                        .eq('id', keepId);
                    
                    if (updateError) throw updateError;
                }
                
                // Delete merge entry
                const { error: deleteError } = await supabaseClient
                    .from('managed_creators')
                    .delete()
                    .eq('id', mergeId);
                
                if (deleteError) throw deleteError;
                
                showToast('Merged! Added ' + accountsAdded + ' account(s)', 'success');
                logActivity('merge', 'Merged roster entries: @' + mergeEntry.account_1 + ' into @' + keepEntry.account_1, keepEntry.brand);
                
                // Refresh
                await loadManagedCreators();
                loadRosterData();
                
            } catch (err) {
                showToast('Error merging: ' + err.message, 'error');
                console.error(err);
            }
        }

        function toggleRosterSelectIdentity(checkbox) {
            const discord = checkbox.dataset.discord;
            // For identity view, select all entries with this discord
            const entries = getCreatorByDiscord(discord);
            entries.forEach(e => {
                const idStr = String(e.id);
                if (checkbox.checked) {
                    selectedRosterIds.add(idStr);
                } else {
                    selectedRosterIds.delete(idStr);
                }
            });
            updateRosterBulkUI();
        }

        async function bulkLogContact() {
            if (selectedRosterIds.size === 0) return;
            
            const today = new Date().toISOString().split('T')[0];
            const ids = [...selectedRosterIds].map(id => parseInt(id));
            const { error } = await supabaseClient.from('managed_creators')
                .update({ last_contact_date: today })
                .in('id', ids);
            
            if (error) {
                showToast('Error logging contact: ' + error.message, 'error');
                return;
            }
            
            showToast(`Logged contact for ${selectedRosterIds.size} entries`, 'success');
            clearRosterSelection();
            await loadManagedCreators();
            loadRosterData();
        }

        // Roster Health Check Functions
        let sameBrandDuplicates = []; // Store for merge modal
        
        function updateRosterHealthCheck() {
            const healthCheck = document.getElementById('rosterHealthCheck');
            if (!healthCheck) return;
            
            // Find creators with missing data
            const missingDiscord = managedCreators.filter(c => !c.discord_name || c.discord_name.trim() === '');
            const missingTikTok = managedCreators.filter(c => !c.account_1 || c.account_1.trim() === '');
            const missingName = managedCreators.filter(c => !c.real_name || c.real_name.trim() === '');
            
            // Find potential duplicates (same TikTok across entries in same brand)
            const duplicates = [];
            const seenAccounts = new Map();
            
            managedCreators.forEach(c => {
                const accounts = [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].filter(a => a);
                accounts.forEach(acc => {
                    const normalized = normalizeTikTok(acc);
                    if (!normalized) return;
                    const key = `${c.brand}:${normalized}`;
                    if (seenAccounts.has(key)) {
                        const existing = seenAccounts.get(key);
                        if (!duplicates.find(d => d.account === normalized && d.brand === c.brand)) {
                            duplicates.push({
                                account: normalized,
                                brand: c.brand,
                                creators: [existing, c]
                            });
                        }
                    } else {
                        seenAccounts.set(key, c);
                    }
                });
            });
            
            // Find same-brand duplicates (same Discord + same brand = needs merging)
            // These are creators who have multiple separate entries for the same brand
            sameBrandDuplicates = [];
            const discordBrandMap = new Map(); // discord:brand -> [entries]
            
            managedCreators.forEach(c => {
                if (!c.discord_name) return;
                const key = `${c.discord_name.toLowerCase().trim()}:${c.brand}`;
                if (!discordBrandMap.has(key)) {
                    discordBrandMap.set(key, []);
                }
                discordBrandMap.get(key).push(c);
            });
            
            discordBrandMap.forEach((entries, key) => {
                if (entries.length > 1) {
                    const [discord, brand] = key.split(':');
                    sameBrandDuplicates.push({
                        discord: entries[0].discord_name,
                        brand: brand,
                        entries: entries,
                        displayName: entries[0].real_name || entries[0].discord_name
                    });
                }
            });
            
            const hasIssues = missingDiscord.length > 0 || missingTikTok.length > 0 || missingName.length > 0 || duplicates.length > 0 || sameBrandDuplicates.length > 0;
            
            // Find creators missing discord_id (can still have discord_name)
            const missingDiscordId = managedCreators.filter(c => !c.discord_id || c.discord_id.trim() === '');
            
            // Show/hide health check section (always show if data integrity section is there)
            healthCheck.style.display = 'block';
            
            // Update summary badges
            const discordBadge = document.getElementById('healthMissingDiscord');
            const tiktokBadge = document.getElementById('healthMissingTikTok');
            const nameBadge = document.getElementById('healthMissingName');
            const dupBadge = document.getElementById('healthDuplicates');
            const sameBrandDupBadge = document.getElementById('healthSameBrandDupes');
            const discordIdBadge = document.getElementById('healthMissingDiscordId');
            
            if (missingDiscord.length > 0) {
                discordBadge.style.display = 'flex';
                document.getElementById('healthMissingDiscordCount').textContent = missingDiscord.length;
            } else {
                discordBadge.style.display = 'none';
            }
            
            if (missingTikTok.length > 0) {
                tiktokBadge.style.display = 'flex';
                document.getElementById('healthMissingTikTokCount').textContent = missingTikTok.length;
            } else {
                tiktokBadge.style.display = 'none';
            }
            
            if (missingName.length > 0) {
                nameBadge.style.display = 'flex';
                document.getElementById('healthMissingNameCount').textContent = missingName.length;
            } else {
                nameBadge.style.display = 'none';
            }
            
            if (missingDiscordId.length > 0) {
                discordIdBadge.style.display = 'flex';
                document.getElementById('healthMissingDiscordIdCount').textContent = missingDiscordId.length;
            } else {
                discordIdBadge.style.display = 'none';
            }
            
            if (duplicates.length > 0) {
                dupBadge.style.display = 'flex';
                document.getElementById('healthDuplicatesCount').textContent = duplicates.length;
            } else {
                dupBadge.style.display = 'none';
            }
            
            if (sameBrandDuplicates.length > 0) {
                sameBrandDupBadge.style.display = 'flex';
                document.getElementById('healthSameBrandDupesCount').textContent = sameBrandDuplicates.length;
            } else {
                sameBrandDupBadge.style.display = 'none';
            }
            
            // Populate detail lists
            const discordList = document.getElementById('healthMissingDiscordList');
            const discordItems = document.getElementById('healthMissingDiscordItems');
            if (missingDiscord.length > 0) {
                discordList.style.display = 'block';
                discordItems.innerHTML = missingDiscord.map(c => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                        <div>
                            <div style="font-weight: 500;">${c.real_name || c.account_1 || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                        </div>
                        <button class="btn btn-secondary" onclick="editCreator(${c.id})" style="font-size: 0.75rem; padding: 4px 10px;">Fix</button>
                    </div>
                `).join('');
            } else {
                discordList.style.display = 'none';
            }
            
            const tiktokList = document.getElementById('healthMissingTikTokList');
            const tiktokItems = document.getElementById('healthMissingTikTokItems');
            if (missingTikTok.length > 0) {
                tiktokList.style.display = 'block';
                tiktokItems.innerHTML = missingTikTok.map(c => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                        <div>
                            <div style="font-weight: 500;">${c.real_name || c.discord_name || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                        </div>
                        <button class="btn btn-secondary" onclick="editCreator(${c.id})" style="font-size: 0.75rem; padding: 4px 10px;">Fix</button>
                    </div>
                `).join('');
            } else {
                tiktokList.style.display = 'none';
            }
            
            const nameList = document.getElementById('healthMissingNameList');
            const nameItems = document.getElementById('healthMissingNameItems');
            if (missingName.length > 0) {
                nameList.style.display = 'block';
                nameItems.innerHTML = missingName.slice(0, 20).map(c => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                        <div>
                            <div style="font-weight: 500;">@${c.account_1 || '?'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}${c.discord_name ? '  ' + c.discord_name : ''}</div>
                        </div>
                        <button class="btn btn-secondary" onclick="editCreator(${c.id})" style="font-size: 0.75rem; padding: 4px 10px;">Fix</button>
                    </div>
                `).join('') + (missingName.length > 20 ? `<div style="padding: 8px; text-align: center; color: var(--text-muted);">+${missingName.length - 20} more</div>` : '');
            } else {
                nameList.style.display = 'none';
            }
            
            const dupList = document.getElementById('healthDuplicatesList');
            const dupItems = document.getElementById('healthDuplicatesItems');
            if (duplicates.length > 0) {
                dupList.style.display = 'block';
                dupItems.innerHTML = duplicates.map(d => `
                    <div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                        <div style="font-weight: 500;">@${d.account}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${BRAND_DISPLAY[d.brand] || d.brand} - ${d.creators.length} entries</div>
                    </div>
                `).join('');
            } else {
                dupList.style.display = 'none';
            }
            
            // Missing Discord ID list
            const discordIdList = document.getElementById('healthMissingDiscordIdList');
            const discordIdItems = document.getElementById('healthMissingDiscordIdItems');
            if (missingDiscordId.length > 0) {
                discordIdList.style.display = 'block';
                discordIdItems.innerHTML = missingDiscordId.slice(0, 15).map(c => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
                        <div>
                            <div style="font-weight: 500;">${c.real_name || c.discord_name || c.account_1 || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${BRAND_DISPLAY[c.brand] || c.brand}${c.discord_name ? '  ' + c.discord_name : ''}</div>
                        </div>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">Needs Discord login</span>
                    </div>
                `).join('') + (missingDiscordId.length > 15 ? `<div style="padding: 8px; text-align: center; color: var(--text-muted);">+${missingDiscordId.length - 15} more</div>` : '');
            } else {
                discordIdList.style.display = 'none';
            }
            
            // Trigger data integrity check
            runDataIntegrityCheck();
        }
        
        // Data integrity check - measures linking quality
        async function runDataIntegrityCheck() {
            try {
                // Check performance data linking
                const { data: perfStats } = await supabaseClient
                    .from('creator_performance')
                    .select('managed_creator_id', { count: 'exact', head: false });
                
                const totalPerf = perfStats?.length || 0;
                const linkedPerf = perfStats?.filter(p => p.managed_creator_id)?.length || 0;
                const linkedPct = totalPerf > 0 ? Math.round((linkedPerf / totalPerf) * 100) : 0;
                
                document.getElementById('integrityLinkedPct').textContent = linkedPct + '%';
                document.getElementById('integrityLinkedPct').style.color = linkedPct >= 90 ? 'var(--success)' : linkedPct >= 70 ? 'var(--warning)' : 'var(--danger)';
                
                const orphaned = totalPerf - linkedPerf;
                document.getElementById('integrityOrphaned').textContent = orphaned.toLocaleString();
                document.getElementById('integrityOrphaned').style.color = orphaned === 0 ? 'var(--success)' : orphaned < 1000 ? 'var(--warning)' : 'var(--danger)';
                
                // Update orphaned badge
                const orphanedBadge = document.getElementById('healthOrphanedPerf');
                if (orphaned > 0) {
                    orphanedBadge.style.display = 'flex';
                    document.getElementById('healthOrphanedPerfCount').textContent = orphaned.toLocaleString();
                } else {
                    orphanedBadge.style.display = 'none';
                }
                
                // Discord ID coverage
                const withDiscordId = managedCreators.filter(c => c.discord_id && c.discord_id.trim() !== '').length;
                const discordIdPct = managedCreators.length > 0 ? Math.round((withDiscordId / managedCreators.length) * 100) : 0;
                document.getElementById('integrityDiscordIdPct').textContent = discordIdPct + '%';
                document.getElementById('integrityDiscordIdPct').style.color = discordIdPct >= 90 ? 'var(--success)' : discordIdPct >= 70 ? 'var(--warning)' : 'var(--info)';
                
                // TikTok accounts count (check if table exists)
                const { data: tiktokData, error: tiktokError } = await supabaseClient
                    .from('tiktok_accounts')
                    .select('id', { count: 'exact', head: true });
                
                if (!tiktokError) {
                    const tiktokCount = tiktokData?.length || 0;
                    document.getElementById('integrityTikTokAccounts').textContent = tiktokCount.toLocaleString();
                } else {
                    // Table doesn't exist yet
                    document.getElementById('integrityTikTokAccounts').textContent = 'N/A';
                    document.getElementById('integrityTikTokAccounts').style.color = 'var(--text-muted)';
                }
                
            } catch (err) {
                console.error('Error running data integrity check:', err);
            }
        }
        
        // Show orphaned data modal
        async function showOrphanedDataModal() {
            // For now, just show a toast with options
            const result = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay show';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title"> Unlinked Performance Data</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 16px;">Performance data exists that isn't linked to any roster entry. This happens when:</p>
                            <ul style="margin-bottom: 16px; padding-left: 20px; color: var(--text-secondary);">
                                <li>Creator not added to roster yet</li>
                                <li>TikTok handle differs from roster entry</li>
                                <li>Data uploaded before migration</li>
                            </ul>
                            <p style="margin-bottom: 16px;">You can:</p>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button class="btn btn-primary" onclick="backfillPerformanceLinks(); this.closest('.modal-overlay').remove();">
                                     Auto-Link Now
                                </button>
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove();">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            });
        }
        
        // Backfill performance links using RPC or fallback
        async function backfillPerformanceLinks() {
            showToast('Linking performance data...', 'info');
            
            try {
                // Try RPC function first
                const { data, error } = await supabaseClient.rpc('backfill_performance_links');
                
                if (!error && data) {
                    const total = data.reduce((sum, d) => sum + d.linked_count, 0);
                    showToast(`Linked ${total} records across ${data.length} brands!`, 'success');
                    runDataIntegrityCheck();
                    return;
                }
                
                // Fallback: Manual linking per brand
                const brands = [...new Set(managedCreators.map(c => c.brand))];
                let totalLinked = 0;
                
                for (const brand of brands) {
                    // Get all tiktok handles for this brand
                    const brandCreators = managedCreators.filter(c => c.brand === brand);
                    const handles = [];
                    brandCreators.forEach(c => {
                        [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(acc => {
                            if (acc) handles.push({ handle: normalizeTikTok(acc), id: c.id });
                        });
                    });
                    
                    // Update performance records
                    for (const { handle, id } of handles) {
                        const { count } = await supabaseClient
                            .from('creator_performance')
                            .update({ managed_creator_id: id })
                            .eq('brand', brand)
                            .ilike('creator_name', handle)
                            .is('managed_creator_id', null);
                        
                        totalLinked += count || 0;
                    }
                }
                
                showToast(`Linked ${totalLinked} records!`, 'success');
                runDataIntegrityCheck();
                
            } catch (err) {
                console.error('Error backfilling links:', err);
                showToast('Error linking data: ' + err.message, 'error');
            }
        }
        
        function toggleRosterHealthDetails() {
            const details = document.getElementById('rosterHealthDetails');
            const toggleText = document.getElementById('rosterHealthToggleText');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                toggleText.textContent = 'Hide Details';
            } else {
                details.style.display = 'none';
                toggleText.textContent = 'Show Details';
            }
        }
        
        // ==================== MERGE ENTRIES TOOL ====================
        function openMergeEntriesModal() {
            document.getElementById('mergeEntriesModal').classList.add('show');
            renderMergeEntriesList();
        }
        
        function closeMergeEntriesModal() {
            document.getElementById('mergeEntriesModal').classList.remove('show');
        }
        
        function renderMergeEntriesList() {
            const container = document.getElementById('mergeEntriesList');
            
            if (sameBrandDuplicates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3> No duplicates found</h3>
                        <p>All your creators have unique entries per brand.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sameBrandDuplicates.map((dup, idx) => {
                // Sort entries by GMV (highest first) to suggest primary
                const sortedEntries = [...dup.entries].sort((a, b) => {
                    const gmvA = rosterCache.withPerformance?.find(r => r.id === a.id)?.gmv || 0;
                    const gmvB = rosterCache.withPerformance?.find(r => r.id === b.id)?.gmv || 0;
                    return gmvB - gmvA;
                });
                
                const accounts = sortedEntries.map(e => ({
                    id: e.id,
                    account: e.account_1,
                    gmv: rosterCache.withPerformance?.find(r => r.id === e.id)?.gmv || 0,
                    role: e.role,
                    retainer: e.retainer || 0
                })).filter(a => a.account);
                
                const totalGmv = accounts.reduce((s, a) => s + a.gmv, 0);
                const totalRetainer = sortedEntries.reduce((s, e) => s + (e.retainer || 0), 0);
                
                return `
                    <div class="merge-group" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">${dup.displayName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    <span class="badge-brand">${BRAND_DISPLAY[dup.brand] || dup.brand}</span>
                                    <span style="margin-left: 8px;">${dup.entries.length} separate entries</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: var(--success);">${fmtMoney(totalGmv)}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Combined GMV</div>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-primary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">Accounts to Merge</div>
                            ${accounts.map((a, i) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; ${i < accounts.length - 1 ? 'border-bottom: 1px solid var(--border);' : ''}">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" checked data-merge-group="${idx}" data-entry-id="${a.id}" data-account="${a.account || ''}" class="merge-account-checkbox">
                                        <span style="font-weight: 500;">@${a.account || '?'}</span>
                                        ${i === 0 ? '<span style="font-size: 0.7rem; background: var(--success-dim); color: var(--success); padding: 2px 6px; border-radius: 4px;">PRIMARY</span>' : ''}
                                    </div>
                                    <span style="font-weight: 500; ${a.gmv > 0 ? 'color: var(--success);' : ''}">${fmtMoney(a.gmv)}</span>
                                </div>
                            `).join('')}
                            ${totalRetainer > 0 ? `<div style="margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);">Total Retainer: <strong style="color: var(--accent);">${fmtMoney(totalRetainer)}/mo</strong></div>` : ''}
                        </div>
                        
                        <button class="btn btn-primary" onclick="executeMerge(${idx})" style="width: 100%;">
                             Merge ${accounts.length} accounts into 1 entry
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        async function executeMerge(groupIdx) {
            const dup = sameBrandDuplicates[groupIdx];
            if (!dup) return;
            
            // Get checked accounts
            const checkboxes = document.querySelectorAll(`input[data-merge-group="${groupIdx}"]:checked`);
            const selectedAccounts = [...checkboxes].map(cb => cb.dataset.account).filter(a => a && a !== 'undefined');
            
            if (selectedAccounts.length === 0) {
                showToast('Please select at least one account to keep', 'error');
                return;
            }
            
            // Sort entries by GMV to find primary (keep the one with highest GMV)
            const sortedEntries = [...dup.entries].sort((a, b) => {
                const gmvA = rosterCache.withPerformance?.find(r => r.id === a.id)?.gmv || 0;
                const gmvB = rosterCache.withPerformance?.find(r => r.id === b.id)?.gmv || 0;
                return gmvB - gmvA;
            });
            
            const primaryEntry = sortedEntries[0];
            const entriesToDelete = sortedEntries.slice(1);
            
            // Collect all unique accounts from all entries
            const allAccounts = new Set();
            sortedEntries.forEach(e => {
                [e.account_1, e.account_2, e.account_3, e.account_4, e.account_5].forEach(a => {
                    if (a && a.trim()) allAccounts.add(a.trim());
                });
            });
            
            // Only keep selected accounts
            const accountsToKeep = [...allAccounts].filter(a => selectedAccounts.includes(a));
            
            if (accountsToKeep.length > 5) {
                showToast('Cannot merge: more than 5 accounts. Please uncheck some.', 'error');
                return;
            }
            
            // Sum up retainers
            const totalRetainer = sortedEntries.reduce((s, e) => s + (e.retainer || 0), 0);
            
            // Prepare update for primary entry
            const updateData = {
                account_1: accountsToKeep[0] || null,
                account_2: accountsToKeep[1] || null,
                account_3: accountsToKeep[2] || null,
                account_4: accountsToKeep[3] || null,
                account_5: accountsToKeep[4] || null,
                retainer: totalRetainer
            };
            
            // Use best available name
            if (!primaryEntry.real_name) {
                const entryWithName = sortedEntries.find(e => e.real_name);
                if (entryWithName) updateData.real_name = entryWithName.real_name;
            }
            
            // Confirm before proceeding
            if (!confirm(`Merge ${dup.entries.length} entries into 1?\n\nPrimary entry: @${primaryEntry.account_1 || '?'}\nAccounts to keep: ${accountsToKeep.join(', ')}\nEntries to delete: ${entriesToDelete.length}`)) {
                return;
            }
            
            try {
                // Update primary entry with all accounts
                const { error: updateError } = await supabaseClient
                    .from('managed_creators')
                    .update(updateData)
                    .eq('id', primaryEntry.id);
                
                if (updateError) throw updateError;
                
                // Delete other entries
                if (entriesToDelete.length > 0) {
                    const idsToDelete = entriesToDelete.map(e => e.id);
                    const { error: deleteError } = await supabaseClient
                        .from('managed_creators')
                        .delete()
                        .in('id', idsToDelete);
                    
                    if (deleteError) throw deleteError;
                }
                
                showToast(`Merged ${dup.entries.length} entries into 1`, 'success');
                
                // Refresh data
                await loadManagedCreators();
                loadRosterData();
                
                // Re-render merge list
                renderMergeEntriesList();
                
            } catch (err) {
                showToast('Error merging: ' + err.message, 'error');
            }
        }

        // ==================== SMART MATCH TOOL ====================
        let smartMatchData = {
            orphanPerformance: [],  // TikTok handles with GMV but not in managed_creators
            missingDiscord: [],     // Managed creators missing Discord
            missingTikTok: [],      // Managed creators missing TikTok
            missingName: [],        // Managed creators missing real_name
            duplicates: [],         // Potential duplicate entries
            selectedMatches: new Map()  // id -> { type, data }
        };
        let currentSmartMatchTab = 'orphanPerformance';

        function openSmartMatchModal() {
            document.getElementById('smartMatchModal').classList.add('show');
            runSmartMatch();
        }

        function closeSmartMatchModal() {
            document.getElementById('smartMatchModal').classList.remove('show');
            smartMatchData.selectedMatches.clear();
            updateSmartMatchSelectedCount();
        }

        function switchSmartMatchTab(tab) {
            currentSmartMatchTab = tab;
            document.querySelectorAll('.smart-match-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tabOrphanPerformance').classList.toggle('active', tab === 'orphanPerformance');
            document.getElementById('tabMissingDiscord').classList.toggle('active', tab === 'missingDiscord');
            document.getElementById('tabMissingTikTok').classList.toggle('active', tab === 'missingTikTok');
            document.getElementById('tabMissingName').classList.toggle('active', tab === 'missingName');
            document.getElementById('tabDuplicates').classList.toggle('active', tab === 'duplicates');
            renderSmartMatchResults();
        }

        async function runSmartMatch() {
            const resultsContainer = document.getElementById('smartMatchResults');
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div> Analyzing data...</div>';
            
            const brandFilter = document.getElementById('smartMatchBrandFilter').value;
            
            try {
                // Get all TikTok handles currently in managed_creators
                const managedHandles = new Set();
                managedCreators.forEach(mc => {
                    [mc.account_1, mc.account_2, mc.account_3, mc.account_4, mc.account_5].forEach(acc => {
                        if (acc) managedHandles.add(normalizeTikTok(acc));
                    });
                });

                // Fetch all creator performance data to find orphans
                let allPerfData = [];
                let page = 0;
                const pageSize = QUERY_PAGE_SIZE;
                let hasMore = true;
                
                // Get last 30 days for relevance
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                while (hasMore) {
                    let query = supabaseClient.from('creator_performance')
                        .select('creator_name, brand, gmv, orders')
                        .gte('report_date', startDate.toISOString().split('T')[0])
                        .lte('report_date', endDate.toISOString().split('T')[0])
                        .eq('period_type', 'daily')
                        .range(page * pageSize, (page + 1) * pageSize - 1);
                    
                    if (brandFilter !== 'all') query = query.eq('brand', brandFilter);
                    
                    const { data, error } = await query;
                    if (error || !data || data.length === 0) {
                        hasMore = false;
                    } else {
                        allPerfData = allPerfData.concat(data);
                        hasMore = data.length === pageSize;
                        page++;
                    }
                    if (page >= MAX_PAGES) break;
                }

                // Aggregate performance by creator+brand
                const perfMap = new Map();
                allPerfData.forEach(row => {
                    const normalized = normalizeTikTok(row.creator_name);
                    if (!normalized) return;
                    const key = `${normalized}|||${row.brand}`;
                    if (!perfMap.has(key)) {
                        perfMap.set(key, { 
                            creator_name: row.creator_name, 
                            normalized,
                            brand: row.brand, 
                            gmv: 0, 
                            orders: 0 
                        });
                    }
                    const p = perfMap.get(key);
                    p.gmv += pFloat(row.gmv);
                    p.orders += pInt(row.orders);
                });

                // Find orphan performance (not managed for THAT brand)
                smartMatchData.orphanPerformance = [...perfMap.values()]
                    .filter(p => !isManagedForBrand(p.creator_name, p.brand) && p.gmv >= 100)
                    .sort((a, b) => b.gmv - a.gmv);

                // Find managed creators missing Discord
                smartMatchData.missingDiscord = managedCreators
                    .filter(mc => !mc.discord_name || mc.discord_name.trim() === '')
                    .filter(mc => brandFilter === 'all' || mc.brand === brandFilter);

                // Find managed creators missing TikTok
                smartMatchData.missingTikTok = managedCreators
                    .filter(mc => !mc.account_1 || mc.account_1.trim() === '')
                    .filter(mc => brandFilter === 'all' || mc.brand === brandFilter)
                    .map(mc => ({
                        ...mc,
                        // Try to find potential matches based on name similarity
                        potentialMatches: findPotentialTikTokMatches(mc, perfMap)
                    }));

                // Find managed creators missing name
                smartMatchData.missingName = managedCreators
                    .filter(mc => !mc.real_name || mc.real_name.trim() === '')
                    .filter(mc => brandFilter === 'all' || mc.brand === brandFilter);

                // Find duplicates
                smartMatchData.duplicates = findDuplicates(brandFilter);

                // Update tab counts
                document.getElementById('orphanPerformanceCount').textContent = smartMatchData.orphanPerformance.length;
                document.getElementById('missingDiscordTabCount').textContent = smartMatchData.missingDiscord.length;
                document.getElementById('missingTikTokTabCount').textContent = smartMatchData.missingTikTok.length;
                document.getElementById('missingNameTabCount').textContent = smartMatchData.missingName.length;
                document.getElementById('duplicatesTabCount').textContent = smartMatchData.duplicates.length;

                renderSmartMatchResults();
            } catch (err) {
                resultsContainer.innerHTML = `<div class="empty-state"><p>Error: ${err.message}</p></div>`;
            }
        }

        function findPotentialTikTokMatches(managedCreator, perfMap) {
            // Try to match based on discord name or real name similarity
            const matches = [];
            const searchTerms = [
                managedCreator.discord_name?.toLowerCase(),
                managedCreator.real_name?.toLowerCase()
            ].filter(t => t && t.length > 2);
            
            if (searchTerms.length === 0) return matches;

            perfMap.forEach((perf, key) => {
                if (perf.brand !== managedCreator.brand) return;
                
                const handle = perf.normalized.toLowerCase();
                let score = 0;
                
                searchTerms.forEach(term => {
                    // Exact match
                    if (handle === term) score += 100;
                    // Contains
                    else if (handle.includes(term) || term.includes(handle)) score += 50;
                    // Fuzzy match (first 4 chars)
                    else if (term.length >= 4 && handle.includes(term.substring(0, 4))) score += 25;
                });
                
                if (score > 0) {
                    matches.push({ ...perf, score });
                }
            });

            return matches.sort((a, b) => b.score - a.score).slice(0, 3);
        }

        function findDuplicates(brandFilter) {
            const duplicates = [];
            const seen = {
                tiktok: new Map(),  // brand:handle -> creator
                discord: new Map(), // brand:discord -> creator
                email: new Map()    // brand:email -> creator
            };
            
            const creatorsToCheck = brandFilter === 'all' 
                ? managedCreators 
                : managedCreators.filter(mc => mc.brand === brandFilter);
            
            creatorsToCheck.forEach(c => {
                // Check TikTok handles
                [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(acc => {
                    if (!acc) return;
                    const normalized = normalizeTikTok(acc);
                    if (!normalized) return;
                    const key = `${c.brand}:${normalized}`;
                    
                    if (seen.tiktok.has(key)) {
                        const existing = seen.tiktok.get(key);
                        // Check if this pair already exists
                        const existingDup = duplicates.find(d => 
                            d.type === 'tiktok' && 
                            d.matchValue === normalized && 
                            d.brand === c.brand
                        );
                        if (!existingDup) {
                            duplicates.push({
                                type: 'tiktok',
                                matchValue: normalized,
                                brand: c.brand,
                                creators: [existing, c]
                            });
                        } else if (!existingDup.creators.find(cr => cr.id === c.id)) {
                            existingDup.creators.push(c);
                        }
                    } else {
                        seen.tiktok.set(key, c);
                    }
                });
                
                // Check Discord
                if (c.discord_name && c.discord_name.trim()) {
                    const key = `${c.brand}:${c.discord_name.toLowerCase().trim()}`;
                    if (seen.discord.has(key)) {
                        const existing = seen.discord.get(key);
                        const existingDup = duplicates.find(d => 
                            d.type === 'discord' && 
                            d.matchValue.toLowerCase() === c.discord_name.toLowerCase().trim() && 
                            d.brand === c.brand
                        );
                        if (!existingDup) {
                            duplicates.push({
                                type: 'discord',
                                matchValue: c.discord_name,
                                brand: c.brand,
                                creators: [existing, c]
                            });
                        } else if (!existingDup.creators.find(cr => cr.id === c.id)) {
                            existingDup.creators.push(c);
                        }
                    } else {
                        seen.discord.set(key, c);
                    }
                }
                
                // Check Email
                if (c.email && c.email.trim()) {
                    const key = `${c.brand}:${c.email.toLowerCase().trim()}`;
                    if (seen.email.has(key)) {
                        const existing = seen.email.get(key);
                        const existingDup = duplicates.find(d => 
                            d.type === 'email' && 
                            d.matchValue.toLowerCase() === c.email.toLowerCase().trim() && 
                            d.brand === c.brand
                        );
                        if (!existingDup) {
                            duplicates.push({
                                type: 'email',
                                matchValue: c.email,
                                brand: c.brand,
                                creators: [existing, c]
                            });
                        } else if (!existingDup.creators.find(cr => cr.id === c.id)) {
                            existingDup.creators.push(c);
                        }
                    } else {
                        seen.email.set(key, c);
                    }
                }
            });
            
            return duplicates;
        }

        function renderSmartMatchResults() {
            const container = document.getElementById('smartMatchResults');
            const search = document.getElementById('smartMatchSearch').value.toLowerCase();
            
            if (currentSmartMatchTab === 'orphanPerformance') {
                let data = smartMatchData.orphanPerformance;
                if (search) data = data.filter(p => p.creator_name.toLowerCase().includes(search));
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 40px;"><h3> No orphan performance data</h3><p>All creators with GMV are already in your roster</p></div>';
                    return;
                }

                container.innerHTML = `
                    <div style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                        These TikTok handles have GMV in the last 30 days but aren't in your managed roster. 
                        Select any you want to add as new managed creators.
                    </div>
                    ${data.slice(0, 50).map(p => `
                        <div class="match-card ${smartMatchData.selectedMatches.has('orphan-' + p.normalized + '-' + p.brand) ? 'selected' : ''}" 
                             onclick="toggleOrphanSelection('${p.normalized}', '${p.brand}', '${p.creator_name.replace(/'/g, "\\'")}')"
                             style="cursor: pointer;">
                            <div class="match-card-header">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1rem;">@${p.creator_name}</div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">${BRAND_DISPLAY[p.brand] || p.brand}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: var(--success); font-size: 1.1rem;">${fmtMoney(p.gmv)}</div>
                                    <div style="color: var(--text-muted); font-size: 0.8rem;">${p.orders} orders</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm ${smartMatchData.selectedMatches.has('orphan-' + p.normalized + '-' + p.brand) ? 'btn-primary' : 'btn-secondary'}" 
                                        style="font-size: 0.8rem; padding: 4px 12px;">
                                    ${smartMatchData.selectedMatches.has('orphan-' + p.normalized + '-' + p.brand) ? ' Selected' : 'Select to Add'}
                                </button>
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); quickAddToRoster('${p.creator_name.replace(/'/g, "\\'")}', '${p.brand}'); closeSmartMatchModal();" 
                                        style="font-size: 0.8rem; padding: 4px 12px;">
                                    Quick Add 
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    ${data.length > 50 ? `<div style="padding: 16px; text-align: center; color: var(--text-muted);">Showing 50 of ${data.length} results</div>` : ''}
                `;
            } else if (currentSmartMatchTab === 'missingDiscord') {
                let data = smartMatchData.missingDiscord;
                if (search) data = data.filter(mc => 
                    (mc.real_name || '').toLowerCase().includes(search) || 
                    (mc.account_1 || '').toLowerCase().includes(search)
                );
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 40px;"><h3> No missing Discord</h3><p>All managed creators have Discord names assigned</p></div>';
                    return;
                }

                container.innerHTML = `
                    <div style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                        These managed creators are missing Discord usernames. Discord is used as the primary identity key for grouping creators across brands.
                    </div>
                    ${data.slice(0, 50).map(mc => `
                        <div class="match-card">
                            <div class="match-card-header">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1rem;">${mc.real_name || '@' + (mc.account_1 || 'Unknown')}</div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                                        ${mc.account_1 ? '@' + mc.account_1 + '  ' : ''}${BRAND_DISPLAY[mc.brand] || mc.brand}
                                    </div>
                                </div>
                                <button class="btn btn-secondary" onclick="editCreator(${mc.id})" style="font-size: 0.8rem; padding: 4px 12px;">
                                    Edit
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    ${data.length > 50 ? `<div style="padding: 16px; text-align: center; color: var(--text-muted);">Showing 50 of ${data.length} results</div>` : ''}
                `;
            } else if (currentSmartMatchTab === 'missingTikTok') {
                let data = smartMatchData.missingTikTok;
                if (search) data = data.filter(mc => 
                    (mc.real_name || '').toLowerCase().includes(search) || 
                    (mc.discord_name || '').toLowerCase().includes(search)
                );
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 40px;"><h3> No missing TikTok handles</h3><p>All managed creators have TikTok handles assigned</p></div>';
                    return;
                }

                container.innerHTML = `
                    <div style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                        These managed creators are missing TikTok handles. We've suggested potential matches based on name similarity.
                    </div>
                    ${data.slice(0, 50).map(mc => `
                        <div class="match-card">
                            <div class="match-card-header">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1rem;">${mc.real_name || 'Unknown'}</div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                                        ${mc.discord_name ? ' ' + mc.discord_name + '  ' : ''}${BRAND_DISPLAY[mc.brand] || mc.brand}
                                    </div>
                                </div>
                                <button class="btn btn-secondary" onclick="editCreator(${mc.id})" style="font-size: 0.8rem; padding: 4px 12px;">
                                    Edit
                                </button>
                            </div>
                            ${mc.potentialMatches.length > 0 ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">Potential matches:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${mc.potentialMatches.map(match => `
                                            <button class="btn btn-secondary" 
                                                    onclick="event.stopPropagation(); linkTikTokToCreator(${mc.id}, '${match.creator_name.replace(/'/g, "\\'")}')"
                                                    style="font-size: 0.8rem; padding: 6px 12px; display: flex; align-items: center; gap: 6px;">
                                                <span>@${match.creator_name}</span>
                                                <span style="color: var(--success);">${fmtMoney(match.gmv)}</span>
                                                <span class="match-confidence ${match.score >= 50 ? 'high' : match.score >= 25 ? 'medium' : 'low'}">${match.score}%</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; color: var(--text-muted); font-size: 0.85rem;">
                                    No automatic matches found. Try searching manually or edit to add TikTok handle.
                                </div>
                            `}
                        </div>
                    `).join('')}
                    ${data.length > 50 ? `<div style="padding: 16px; text-align: center; color: var(--text-muted);">Showing 50 of ${data.length} results</div>` : ''}
                `;
            } else if (currentSmartMatchTab === 'missingName') {
                let data = smartMatchData.missingName;
                if (search) data = data.filter(mc => 
                    (mc.account_1 || '').toLowerCase().includes(search) || 
                    (mc.discord_name || '').toLowerCase().includes(search)
                );
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 40px;"><h3> No missing names</h3><p>All managed creators have names assigned</p></div>';
                    return;
                }

                container.innerHTML = `
                    <div style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                        These managed creators are missing real names. Click edit to add their name, or use their TikTok handle as the name.
                    </div>
                    ${data.slice(0, 50).map(mc => `
                        <div class="match-card" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">@${mc.account_1 || '?'}</div>
                                <div style="color: var(--text-muted); font-size: 0.85rem;">
                                    ${mc.discord_name ? ' ' + mc.discord_name + '  ' : ''}${BRAND_DISPLAY[mc.brand] || mc.brand}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="useHandleAsName(${mc.id}, '${(mc.account_1 || '').replace(/'/g, "\\'")}')" 
                                        style="font-size: 0.8rem; padding: 4px 12px;">
                                    Use Handle as Name
                                </button>
                                <button class="btn btn-secondary" onclick="editCreator(${mc.id})" style="font-size: 0.8rem; padding: 4px 12px;">
                                    Edit
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    ${data.length > 50 ? `<div style="padding: 16px; text-align: center; color: var(--text-muted);">Showing 50 of ${data.length} results</div>` : ''}
                `;
            } else if (currentSmartMatchTab === 'duplicates') {
                let data = smartMatchData.duplicates;
                if (search) data = data.filter(d => 
                    d.matchValue.toLowerCase().includes(search) ||
                    d.creators.some(c => 
                        (c.real_name || '').toLowerCase().includes(search) ||
                        (c.discord_name || '').toLowerCase().includes(search)
                    )
                );
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 40px;"><h3> No duplicates found</h3><p>Your roster data is clean!</p></div>';
                    return;
                }

                const typeIcons = { tiktok: '', discord: '', email: '' };
                const typeLabels = { tiktok: 'Same TikTok', discord: 'Same Discord', email: 'Same Email' };

                container.innerHTML = `
                    <div style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
                        These entries appear to be duplicates based on matching identifiers. Review and merge or delete as needed.
                    </div>
                    ${data.map((d, idx) => `
                        <div class="match-card">
                            <div class="match-card-header">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 1.2rem;">${typeIcons[d.type]}</span>
                                        <span style="font-weight: 600;">${typeLabels[d.type]}: ${d.matchValue}</span>
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">
                                        ${BRAND_DISPLAY[d.brand] || d.brand}  ${d.creators.length} entries
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 16px; display: grid; gap: 12px;">
                                ${d.creators.map((c, cIdx) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; ${cIdx === 0 ? 'border: 2px solid var(--accent);' : ''}">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                                <span style="font-weight: 600;">${c.real_name || 'Unknown'}</span>
                                                ${cIdx === 0 ? '<span style="font-size: 0.7rem; background: var(--accent-dim); color: var(--accent); padding: 2px 6px; border-radius: 4px;">KEEP</span>' : ''}
                                            </div>
                                            <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; flex-wrap: wrap; gap: 12px;">
                                                ${c.account_1 ? `<span> @${c.account_1}</span>` : '<span style="color: var(--danger);"> No TikTok</span>'}
                                                ${c.discord_name ? `<span> ${c.discord_name}</span>` : '<span style="color: var(--warning);"> No Discord</span>'}
                                                ${c.email ? `<span> ${c.email}</span>` : ''}
                                                <span>Role: ${c.role || ''}</span>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 6px;">
                                            ${cIdx > 0 ? `
                                                <button class="btn btn-secondary" onclick="mergeDuplicates(${d.creators[0].id}, ${c.id})" 
                                                        style="font-size: 0.75rem; padding: 4px 10px;" title="Merge into first entry">
                                                     Merge
                                                </button>
                                                <button class="btn btn-secondary" onclick="deleteDuplicateEntry(${c.id}, '${(c.real_name || c.account_1 || '').replace(/'/g, "\\'")}')" 
                                                        style="font-size: 0.75rem; padding: 4px 10px; color: var(--danger);" title="Delete this entry">
                                                    
                                                </button>
                                            ` : `
                                                <button class="btn btn-secondary" onclick="editCreator(${c.id})" 
                                                        style="font-size: 0.75rem; padding: 4px 10px;">
                                                     Edit
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                `;
            }
        }

        function filterSmartMatchResults() {
            renderSmartMatchResults();
        }

        function toggleOrphanSelection(normalized, brand, creatorName) {
            const key = 'orphan-' + normalized + '-' + brand;
            if (smartMatchData.selectedMatches.has(key)) {
                smartMatchData.selectedMatches.delete(key);
            } else {
                smartMatchData.selectedMatches.set(key, {
                    type: 'orphan',
                    data: { normalized, brand, creator_name: creatorName }
                });
            }
            updateSmartMatchSelectedCount();
            renderSmartMatchResults();
        }

        function updateSmartMatchSelectedCount() {
            const count = smartMatchData.selectedMatches.size;
            document.getElementById('smartMatchSelectedCount').textContent = count + ' selected';
            document.getElementById('applyMatchesBtn').disabled = count === 0;
        }

        async function linkTikTokToCreator(creatorId, tiktokHandle) {
            if (!confirm(`Link @${tiktokHandle} to this creator?`)) return;
            
            const { error } = await supabaseClient.from('managed_creators')
                .update({ account_1: tiktokHandle.toLowerCase() })
                .eq('id', creatorId);
            
            if (error) {
                showToast('Error linking: ' + error.message, 'error');
                return;
            }
            
            showToast(`Linked @${tiktokHandle}!`, 'success');
            await loadManagedCreators();
            runSmartMatch();
        }

        async function useHandleAsName(creatorId, handle) {
            const { error } = await supabaseClient.from('managed_creators')
                .update({ real_name: handle })
                .eq('id', creatorId);
            
            if (error) {
                showToast('Error: ' + error.message, 'error');
                return;
            }
            
            showToast('Name updated!', 'success');
            await loadManagedCreators();
            runSmartMatch();
        }

        async function mergeDuplicates(keepId, mergeId) {
            // Get both records
            const keepRecord = managedCreators.find(c => c.id === keepId);
            const mergeRecord = managedCreators.find(c => c.id === mergeId);
            
            if (!keepRecord || !mergeRecord) {
                showToast('Could not find records to merge', 'error');
                return;
            }

            // Build merged data - fill in blanks from mergeRecord
            const mergedData = {};
            
            // Fill missing fields from merge record
            if (!keepRecord.real_name && mergeRecord.real_name) mergedData.real_name = mergeRecord.real_name;
            if (!keepRecord.discord_name && mergeRecord.discord_name) mergedData.discord_name = mergeRecord.discord_name;
            if (!keepRecord.discord_id && mergeRecord.discord_id) mergedData.discord_id = mergeRecord.discord_id;
            if (!keepRecord.email && mergeRecord.email) mergedData.email = mergeRecord.email;
            if (!keepRecord.account_1 && mergeRecord.account_1) mergedData.account_1 = mergeRecord.account_1;
            if (!keepRecord.account_2 && mergeRecord.account_2) mergedData.account_2 = mergeRecord.account_2;
            if (!keepRecord.account_3 && mergeRecord.account_3) mergedData.account_3 = mergeRecord.account_3;
            if (!keepRecord.notes && mergeRecord.notes) {
                mergedData.notes = mergeRecord.notes;
            } else if (keepRecord.notes && mergeRecord.notes && keepRecord.notes !== mergeRecord.notes) {
                mergedData.notes = keepRecord.notes + '\n---\n' + mergeRecord.notes;
            }
            
            // If merge record has a higher retainer, keep it
            if ((mergeRecord.retainer || 0) > (keepRecord.retainer || 0)) {
                mergedData.retainer = mergeRecord.retainer;
            }

            const hasUpdates = Object.keys(mergedData).length > 0;
            
            // Show confirmation
            const confirmMsg = hasUpdates 
                ? `Merge will:\n Update ${Object.keys(mergedData).length} field(s) in "${keepRecord.real_name || keepRecord.account_1 || 'Unknown'}"\n Delete "${mergeRecord.real_name || mergeRecord.account_1 || 'Unknown'}"\n\nContinue?`
                : `No new data to merge. Delete "${mergeRecord.real_name || mergeRecord.account_1 || 'Unknown'}"?`;
            
            if (!confirm(confirmMsg)) return;

            // Update keep record if there are changes
            if (hasUpdates) {
                const { error: updateError } = await supabaseClient.from('managed_creators')
                    .update(mergedData)
                    .eq('id', keepId);
                
                if (updateError) {
                    showToast('Error updating record: ' + updateError.message, 'error');
                    return;
                }
            }

            // Delete merge record
            const { error: deleteError } = await supabaseClient.from('managed_creators')
                .delete()
                .eq('id', mergeId);
            
            if (deleteError) {
                showToast('Error deleting duplicate: ' + deleteError.message, 'error');
                return;
            }

            showToast('Merged successfully!', 'success');
            await loadManagedCreators();
            runSmartMatch();
            loadRosterData();
        }

        async function deleteDuplicateEntry(id, name) {
            if (!confirm(`Delete "${name}" from roster?\n\nThis cannot be undone.`)) return;
            
            const { error } = await supabaseClient.from('managed_creators')
                .delete()
                .eq('id', id);
            
            if (error) {
                showToast('Error: ' + error.message, 'error');
                return;
            }
            
            showToast('Entry deleted', 'success');
            await loadManagedCreators();
            runSmartMatch();
            loadRosterData();
        }

        async function applySmartMatches() {
            const matches = [...smartMatchData.selectedMatches.values()];
            if (matches.length === 0) return;
            
            const orphans = matches.filter(m => m.type === 'orphan');
            
            if (orphans.length > 0) {
                const records = orphans.map(m => ({
                    brand: m.data.brand,
                    role: 'Incubator',
                    account_1: m.data.normalized,
                    real_name: m.data.creator_name // Use TikTok handle as name initially
                }));
                
                const { error } = await supabaseClient.from('managed_creators').insert(records);
                
                if (error) {
                    showToast('Error adding creators: ' + error.message, 'error');
                    return;
                }
                
                showToast(`Added ${orphans.length} creators to roster!`, 'success');
            }
            
            smartMatchData.selectedMatches.clear();
            updateSmartMatchSelectedCount();
            await loadManagedCreators();
            loadRosterData();
            runSmartMatch();
        }

        function renderRosterInsights(rosterWithPerf) {
            // Top Performers - top 5 by GMV
            const topPerformers = rosterWithPerf.filter(c => c.gmv > 0).slice(0, 5);
            document.getElementById('rosterTopPerformers').innerHTML = topPerformers.length ? topPerformers.map((c, i) => `
                <div class="leaderboard-item" onclick="openCreatorDetail('${(c.account_1 || '').replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                    <div class="leaderboard-rank">${i + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.real_name || c.account_1 || 'Unknown'}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[c.brand] || c.brand}  ${c.role || ''}</div>
                    </div>
                    <div class="leaderboard-value">${fmtMoney(c.gmv)}</div>
                </div>
            `).join('') : '<div class="empty-state" style="padding: 20px;"><p>No performance data</p></div>';

            // Needs Attention - roster creators with declining or zero GMV
            const needsAttention = rosterWithPerf
                .filter(c => c.gmv === 0 || c.gmvChange < -20)
                .sort((a, b) => a.gmvChange - b.gmvChange)
                .slice(0, 5);
            
            document.getElementById('rosterNeedsAttention').innerHTML = needsAttention.length ? needsAttention.map(c => {
                const reason = c.gmv === 0 ? 'No GMV' : `${Math.abs(c.gmvChange).toFixed(0)}%`;
                const reasonClass = c.gmv === 0 ? 'color: var(--warning)' : 'color: var(--danger)';
                return `
                <div class="leaderboard-item" onclick="openCreatorDetail('${(c.account_1 || '').replace(/'/g, "\\'")}', '${c.brand}')" style="cursor: pointer;">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.real_name || c.account_1 || 'Unknown'}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                    </div>
                    <div class="leaderboard-value" style="${reasonClass}">${reason}</div>
                </div>
            `}).join('') : '<div class="empty-state" style="padding: 20px;"><p>All creators performing well! </p></div>';

            // Follow-ups Due - creators with upcoming or overdue follow-ups
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const followupsDue = rosterWithPerf
                .filter(c => c.next_followup_date)
                .map(c => {
                    const followupDate = new Date(c.next_followup_date + 'T00:00:00');
                    const diffDays = Math.floor((followupDate - today) / (1000 * 60 * 60 * 24));
                    return { ...c, diffDays, followupDate };
                })
                .filter(c => c.diffDays <= 3) // Due within 3 days or overdue
                .sort((a, b) => a.diffDays - b.diffDays)
                .slice(0, 5);

            document.getElementById('rosterFollowups').innerHTML = followupsDue.length ? followupsDue.map(c => {
                let urgency = '';
                let urgencyStyle = '';
                if (c.diffDays < 0) {
                    urgency = `Overdue ${Math.abs(c.diffDays)}d`;
                    urgencyStyle = 'color: var(--danger); font-weight: 600;';
                } else if (c.diffDays === 0) {
                    urgency = 'Today';
                    urgencyStyle = 'color: var(--warning); font-weight: 600;';
                } else if (c.diffDays === 1) {
                    urgency = 'Tomorrow';
                    urgencyStyle = 'color: var(--warning);';
                } else {
                    urgency = `In ${c.diffDays}d`;
                    urgencyStyle = 'color: var(--text-muted);';
                }
                return `
                <div class="leaderboard-item" onclick="editCreator(${c.id})" style="cursor: pointer;">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${c.real_name || c.account_1 || 'Unknown'}</div>
                        <div class="leaderboard-brand">${BRAND_DISPLAY[c.brand] || c.brand}</div>
                    </div>
                    <div class="leaderboard-value" style="${urgencyStyle}">${urgency}</div>
                </div>
            `}).join('') : '<div class="empty-state" style="padding: 20px;"><p>No follow-ups scheduled</p></div>';
        }

        // Log contact quick action
        async function logContact(creatorId) {
            const today = new Date().toISOString().split('T')[0];
            
            // Prompt for next follow-up
            const nextFollowup = prompt('Next follow-up date (YYYY-MM-DD) or leave blank:');
            
            const updateData = { last_contact_date: today };
            if (nextFollowup && /^\d{4}-\d{2}-\d{2}$/.test(nextFollowup)) {
                updateData.next_followup_date = nextFollowup;
            }
            
            const { error } = await supabaseClient
                .from('managed_creators')
                .update(updateData)
                .eq('id', creatorId);
            
            if (error) {
                showToast('Error logging contact: ' + error.message, 'error');
                return;
            }
            
            showToast('Contact logged!', 'success');
            await loadManagedCreators();
            loadRosterData();
        }

        // Show all brand entries for a multi-brand creator
        function showAllBrands(creatorIdentifier) {
            const identifier = creatorIdentifier.toLowerCase();
            
            // Find all roster entries that match this creator
            const entries = managedCreators.filter(c => 
                c.real_name?.toLowerCase() === identifier ||
                c.discord_name?.toLowerCase() === identifier ||
                c.account_1?.toLowerCase() === identifier ||
                c.account_2?.toLowerCase() === identifier ||
                c.account_3?.toLowerCase() === identifier ||
                c.email?.toLowerCase() === identifier
            );
            
            if (entries.length === 0) {
                showToast('No entries found', 'error');
                return;
            }

            // Build modal content
            const content = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 16px; color: var(--text-primary);">
                        ${entries[0].real_name || entries[0].discord_name || entries[0].account_1} - All Brands
                    </h3>
                    <div style="display: grid; gap: 12px;">
                        ${entries.map(c => `
                            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span class="badge-brand">${BRAND_DISPLAY[c.brand] || c.brand}</span>
                                        <span class="badge" style="background: var(--bg-card); color: var(--text-secondary);">${c.role || ''}</span>
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                                        ${c.retainer ? `Retainer: ${fmtMoney(c.retainer)}/mo` : 'No retainer'}
                                        ${c.account_1 ? `  @${c.account_1}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="editCreator(${c.id}); closeAllBrandsModal();">Edit</button>
                                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openCreatorDetail('${(c.account_1 || '').replace(/'/g, "\\'")}', '${c.brand}'); closeAllBrandsModal();">View Stats</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                            Total Retainers: <strong style="color: var(--accent);">${fmtMoney(entries.reduce((s, c) => s + (c.retainer || 0), 0))}/mo</strong>
                        </div>
                        <button class="btn btn-secondary" onclick="closeAllBrandsModal()">Close</button>
                    </div>
                </div>
            `;

            // Show in a modal
            let modal = document.getElementById('allBrandsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'allBrandsModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal" style="max-width: 600px;"></div>`;
                document.body.appendChild(modal);
            }
            modal.querySelector('.modal').innerHTML = content;
            modal.classList.add('show');
        }

        function closeAllBrandsModal() {
            const modal = document.getElementById('allBrandsModal');
            if (modal) modal.classList.remove('show');
        }

        async function loadApplicationsSummary() {
            try {
                // Count pending applications
                const { data: pending, error: pendingError } = await supabaseClient
                    .from('creator_applications')
                    .select('id, brand', { count: 'exact' })
                    .eq('status', 'pending');

                const pendingCount = pending?.length || 0;

                // Count recent (last 7 days) approved
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const { data: recentApproved } = await supabaseClient
                    .from('creator_applications')
                    .select('id')
                    .eq('status', 'approved')
                    .gte('updated_at', sevenDaysAgo.toISOString());

                const recentApprovedCount = recentApproved?.length || 0;

                // Group pending by brand
                const pendingByBrand = {};
                (pending || []).forEach(app => {
                    pendingByBrand[app.brand] = (pendingByBrand[app.brand] || 0) + 1;
                });

                document.getElementById('rosterApplications').innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${pendingCount > 0 ? 'var(--warning-dim)' : 'var(--bg-secondary)'}; border-radius: 8px;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: ${pendingCount > 0 ? 'var(--warning)' : 'var(--text-primary)'};">${pendingCount}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Pending Review</div>
                            </div>
                            ${pendingCount > 0 ? `<button class="btn btn-secondary" onclick="switchView('applications')" style="padding: 6px 12px; font-size: 0.8rem;">Review </button>` : ''}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 600; color: var(--success);">${recentApprovedCount}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Approved (7 days)</div>
                            </div>
                        </div>
                        ${Object.keys(pendingByBrand).length > 0 ? `
                            <div style="font-size: 0.75rem; color: var(--text-muted); border-top: 1px solid var(--border); padding-top: 8px;">
                                ${Object.entries(pendingByBrand).map(([b, count]) => `${BRAND_DISPLAY[b] || b}: ${count}`).join('  ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (err) {
                document.getElementById('rosterApplications').innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <p>Applications not configured</p>
                        <a href="applications_schema.sql" style="color: var(--accent); font-size: 0.8rem;">Setup guide</a>
                    </div>
                `;
            }
        }

        function exportRoster() {
            if (!rosterCache.withPerformance.length) {
                showToast('No data to export', 'error');
                return;
            }
            
            const headers = ['Real Name', 'Discord', 'Email', 'Phone', 'Brand', 'Status', 'GMV', 'Prior GMV', 'Change %', 'Tier', 'Retainer', 'Last Contact', 'Next Follow-up', 'Account 1', 'Account 2', 'Account 3', 'Account 4', 'Account 5', 'Notes'];
            const rows = rosterCache.withPerformance.map(c => [
                c.real_name || '',
                c.discord_name || '',
                c.email || '',
                c.phone || '',
                BRAND_DISPLAY[c.brand] || c.brand,
                c.status || 'Active',
                c.gmv.toFixed(2),
                c.priorGmv.toFixed(2),
                c.gmvChange.toFixed(1),
                c.tier.name,
                c.retainer || 0,
                c.last_contact_date || '',
                c.next_followup_date || '',
                c.account_1 || '',
                c.account_2 || '',
                c.account_3 || '',
                c.account_4 || '',
                c.account_5 || '',
                (c.notes || '').replace(/[\n\r]+/g, ' ')
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `roster-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${rosterCache.withPerformance.length} creators!`, 'success');
        }

        // Search debounce for roster
        let rosterSearchTimeout;
        document.getElementById('rosterSearchInput').addEventListener('input', () => {
            clearTimeout(rosterSearchTimeout);
            rosterSearchTimeout = setTimeout(() => {
                pages.roster = 1;
                loadRosterData();
            }, 300);
        });

        // ==================== GOALS ====================
        async function loadGoalsData() {
            const { data: goals } = await supabaseClient.from('goals').select('*').order('created_at', { ascending: false });
            
            if (!goals || goals.length === 0) {
                document.getElementById('goalsTarget').textContent = '$0';
                document.getElementById('goalsCurrent').textContent = '$0';
                document.getElementById('goalsProgress').textContent = '0%';
                document.getElementById('goalsDaysLeft').textContent = '';
                document.getElementById('goalsBody').innerHTML = '<div class="empty-state"><div class="icon"></div><h3>No goals set</h3><p>Click "Set Goal" to create your first target</p></div>';
                return;
            }

            // Calculate progress for each goal
            const goalsWithProgress = await Promise.all(goals.map(async (g) => {
                // Fetch actual GMV for goal period
                let query = supabaseClient.from('creator_performance')
                    .select('gmv')
                    .gte('report_date', g.period_start)
                    .lte('report_date', g.period_end)
                    .eq('period_type', 'daily');
                
                if (g.goal_type === 'brand' && g.target_entity) {
                    query = query.eq('brand', g.target_entity);
                }
                
                const { data: perfData } = await query;
                const actualGmv = (perfData || []).reduce((s, p) => s + (p.gmv || 0), 0);
                const progress = g.target_gmv > 0 ? Math.min(100, (actualGmv / g.target_gmv * 100)) : 0;
                
                // Calculate days left
                const today = new Date();
                const endDate = new Date(g.period_end + 'T23:59:59');
                const daysLeft = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
                
                return { ...g, actualGmv, progress, daysLeft };
            }));

            // Update summary stats (use first/main goal)
            const mainGoal = goalsWithProgress[0];
            document.getElementById('goalsTarget').textContent = fmtMoney(mainGoal.target_gmv);
            document.getElementById('goalsCurrent').textContent = fmtMoney(mainGoal.actualGmv);
            document.getElementById('goalsProgress').textContent = mainGoal.progress.toFixed(0) + '%';
            document.getElementById('goalsDaysLeft').textContent = mainGoal.daysLeft;

            // Show all goals with progress
            document.getElementById('goalsBody').innerHTML = goalsWithProgress.map(g => {
                const progressClass = g.progress >= 100 ? 'green' : g.progress >= 50 ? 'yellow' : 'red';
                const statusText = g.progress >= 100 ? ' Goal achieved!' : 
                    g.daysLeft === 0 ? ' Goal period ended' : 
                    `${g.daysLeft} days remaining`;
                const statusColor = g.progress >= 100 ? 'var(--success)' : g.daysLeft === 0 ? 'var(--danger)' : 'var(--text-muted)';
                
                return `<div style="padding: 16px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong>${g.goal_type === 'brand' ? BRAND_DISPLAY[g.target_entity] || g.target_entity : 'All Brands'} - ${g.period_type}</strong>
                        <span style="color: var(--accent); font-family: 'Space Mono', monospace;">${fmtMoney(g.target_gmv)}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill ${progressClass}" style="width: ${g.progress}%"></div></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8rem;">
                        <span style="color: var(--text-primary); font-family: 'Space Mono', monospace;">${fmtMoney(g.actualGmv)} <span style="color: var(--text-muted);">/ ${fmtMoney(g.target_gmv)}</span></span>
                        <span style="color: ${statusColor};">${statusText}</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">
                        ${formatDate(g.period_start)}  ${formatDate(g.period_end)}
                    </div>
                </div>`;
            }).join('');
        }

        // ==================== ALERTS ====================
        async function loadAlertsData() {
            const { data: alerts } = await supabaseClient.from('alerts').select('*').order('created_at', { ascending: false }).limit(50);
            
            const alertsBody = document.getElementById('alertsBody');
            const alertCount = document.getElementById('alertCount');
            
            if (!alerts || alerts.length === 0) {
                if (alertsBody) alertsBody.innerHTML = '<div class="empty-state"><div class="icon"></div><h3>No alerts</h3><p>Alerts will appear when there are significant changes</p></div>';
                if (alertCount) alertCount.style.display = 'none';
                updateAlertsBell(0);
                return;
            }

            const unread = alerts.filter(a => !a.is_read).length;
            if (alertCount) {
                alertCount.textContent = unread;
                alertCount.style.display = unread > 0 ? 'inline' : 'none';
            }
            updateAlertsBell(unread);

            if (alertsBody) {
                alertsBody.innerHTML = alerts.map(a => {
                    const iconClass = a.severity === 'critical' ? 'danger' : a.severity === 'warning' ? 'warning' : a.alert_type.includes('success') ? 'success' : 'info';
                    const icon = a.severity === 'critical' ? '' : a.severity === 'warning' ? '' : '';
                    return `<div class="alert-item" style="${a.is_read ? 'opacity: 0.7' : ''}">
                        <div class="alert-icon ${iconClass}">${icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${a.message}</div>
                            <div class="alert-message">${a.creator_name ? `Creator: ${a.creator_name}` : ''} ${a.brand ? ` ${BRAND_DISPLAY[a.brand]}` : ''}</div>
                            <div class="alert-time">${new Date(a.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // ==================== AUTO ALERT GENERATION ====================
        async function generateAutoAlerts() {
            // Get yesterday and day before for comparison
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dayBefore = new Date();
            dayBefore.setDate(dayBefore.getDate() - 2);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const yesterdayStr = localDateStr(yesterday);
            const dayBeforeStr = localDateStr(dayBefore);
            const weekAgoStr = localDateStr(weekAgo);
            
            // Get recent performance data
            const { data: recentData } = await supabaseClient.from('creator_performance')
                .select('*')
                .gte('report_date', weekAgoStr)
                .eq('period_type', 'daily');
            
            if (!recentData || recentData.length === 0) return;
            
            // Group by creator (only managed creators)
            const creatorStats = new Map();
            recentData.forEach(row => {
                // Only include managed creators
                if (!isManagedForBrand(row.creator_name, row.brand)) return;
                
                const key = `${row.creator_name}|||${row.brand}`;
                if (!creatorStats.has(key)) {
                    creatorStats.set(key, { 
                        name: row.creator_name, 
                        brand: row.brand,
                        days: []
                    });
                }
                creatorStats.get(key).days.push({
                    date: row.report_date,
                    gmv: pFloat(row.gmv)
                });
            });
            
            const newAlerts = [];
            
            // Detect alerts
            creatorStats.forEach((stats, key) => {
                const days = stats.days.sort((a, b) => a.date.localeCompare(b.date));
                if (days.length < 2) return;
                
                const latestDay = days[days.length - 1];
                const previousDay = days[days.length - 2];
                const totalGmv = days.reduce((s, d) => s + d.gmv, 0);
                
                // Alert 1: GMV dropped more than 50% day over day (for significant creators)
                if (previousDay.gmv > 100 && latestDay.gmv < previousDay.gmv * 0.5) {
                    const dropPct = ((previousDay.gmv - latestDay.gmv) / previousDay.gmv * 100).toFixed(0);
                    newAlerts.push({
                        alert_type: 'gmv_drop',
                        severity: 'warning',
                        brand: stats.brand,
                        creator_name: stats.name,
                        message: `${stats.name} GMV dropped ${dropPct}%`,
                        metric_value: latestDay.gmv,
                        comparison_value: previousDay.gmv,
                        change_percent: -parseFloat(dropPct),
                        report_date: latestDay.date
                    });
                }
                
                // Alert 2: New top performer (>$500 in a day for first time)
                if (latestDay.gmv >= 500 && days.length <= 3) {
                    newAlerts.push({
                        alert_type: 'new_top_performer',
                        severity: 'info',
                        brand: stats.brand,
                        creator_name: stats.name,
                        message: ` New star! ${stats.name} hit ${fmtMoney(latestDay.gmv)} GMV`,
                        metric_value: latestDay.gmv,
                        report_date: latestDay.date
                    });
                }
                
                // Alert 3: Milestone achievement ($1K, $5K, $10K in a single day)
                const milestones = [10000, 5000, 1000];
                for (const milestone of milestones) {
                    if (latestDay.gmv >= milestone && previousDay.gmv < milestone) {
                        newAlerts.push({
                            alert_type: 'milestone',
                            severity: 'info',
                            brand: stats.brand,
                            creator_name: stats.name,
                            message: ` ${stats.name} crossed ${fmtMoney(milestone)} daily GMV!`,
                            metric_value: latestDay.gmv,
                            report_date: latestDay.date
                        });
                        break; // Only one milestone alert
                    }
                }
            });
            
            // Insert new alerts (avoid duplicates)
            if (newAlerts.length > 0) {
                for (const alert of newAlerts) {
                    // Check if similar alert exists in last 24 hours
                    const { data: existing } = await supabaseClient.from('alerts')
                        .select('id')
                        .eq('alert_type', alert.alert_type)
                        .eq('creator_name', alert.creator_name)
                        .gte('created_at', new Date(Date.now() - 86400000).toISOString())
                        .limit(1);
                    
                    if (!existing || existing.length === 0) {
                        await supabaseClient.from('alerts').insert([alert]);
                    }
                }
                
                // Refresh alerts display
                if (currentView === 'alerts') {
                    loadAlertsData();
                }
                
                // Update alert badge count
                const { count } = await supabaseClient.from('alerts').select('*', { count: 'exact', head: true }).eq('is_read', false);
                const badge = document.getElementById('alertCount');
                if (badge) {
                    badge.textContent = count || 0;
                    badge.style.display = count > 0 ? 'inline' : 'none';
                }
            }
        }

        // ==================== CREATOR DETAIL ====================
        let creatorDetailChartInstance = null;
        let currentCreatorDetail = { name: null, brand: null };
        
        async function openCreatorDetail(creatorName, brand) {
            // Store current creator for action buttons
            currentCreatorDetail = { name: creatorName, brand: brand };
            
            // Show loading state
            document.getElementById('creatorDetailTitle').textContent = creatorName;
            document.getElementById('creatorDetailBody').innerHTML = '<div class="loading"><div class="spinner"></div> Loading creator data...</div>';
            
            // Add action buttons
            document.getElementById('creatorDetailActions').innerHTML = `
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="showChangeBrandModal()">
                     Fix Brand
                </button>
                <button class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: var(--danger); color: white;" onclick="confirmRemoveCreator()">
                     Remove
                </button>
            `;
            
            document.getElementById('creatorDetailModal').classList.add('show');
            
            // Get date range from Creators section, fallback to Overview, then default
            let startDate = document.getElementById('creatorsDateFilterStart')?.value || 
                           document.getElementById('dateFilterStart')?.value;
            let endDate = document.getElementById('creatorsDateFilterEnd')?.value || 
                         document.getElementById('dateFilterEnd')?.value;
            
            // Default to last 30 days if no dates set
            if (!startDate || !endDate) {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                startDate = localDateStr(thirtyDaysAgo);
                endDate = localDateStr(today);
            }
            
            // Calculate prior period for comparison
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(start);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);

            // Fetch current period data with pagination
            let perfData = [];
            let page = 0;
            const pageSize = QUERY_PAGE_SIZE;
            let hasMore = true;
            
            while (hasMore) {
                const { data, error } = await supabaseClient.from('creator_performance')
                    .select('*')
                    .eq('creator_name', creatorName)
                    .eq('brand', brand)
                    .eq('period_type', 'daily')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate)
                    .order('report_date', { ascending: true })
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    perfData = perfData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Fetch prior period data
            let priorData = [];
            page = 0;
            hasMore = true;
            
            while (hasMore) {
                const { data, error } = await supabaseClient.from('creator_performance')
                    .select('*')
                    .eq('creator_name', creatorName)
                    .eq('brand', brand)
                    .eq('period_type', 'daily')
                    .gte('report_date', localDateStr(priorStart))
                    .lte('report_date', localDateStr(priorEnd))
                    .range(page * pageSize, (page + 1) * pageSize - 1);
                
                if (error || !data || data.length === 0) {
                    hasMore = false;
                } else {
                    priorData = priorData.concat(data);
                    hasMore = data.length === pageSize;
                    page++;
                }
                if (page >= MAX_PAGES) break;
            }

            // Aggregate current period
            const current = {
                gmv: 0, refunds: 0, orders: 0, items_sold: 0,
                videos: 0, live_streams: 0, est_commission: 0
            };
            perfData.forEach(p => {
                current.gmv += pFloat(p.gmv);
                current.refunds += pFloat(p.refunds);
                current.orders += pInt(p.orders);
                current.items_sold += pInt(p.items_sold);
                current.videos += pInt(p.videos);
                current.live_streams += pInt(p.live_streams);
                current.est_commission += pFloat(p.est_commission);
            });
            current.aov = current.orders > 0 ? current.gmv / current.orders : 0;

            // Aggregate prior period
            const prior = { gmv: 0, orders: 0, videos: 0 };
            priorData.forEach(p => {
                prior.gmv += pFloat(p.gmv);
                prior.orders += pInt(p.orders);
                prior.videos += pInt(p.videos);
            });

            // Calculate changes
            const gmvChange = prior.gmv > 0 ? ((current.gmv - prior.gmv) / prior.gmv * 100) : (current.gmv > 0 ? 100 : 0);
            const ordersChange = prior.orders > 0 ? ((current.orders - prior.orders) / prior.orders * 100) : (current.orders > 0 ? 100 : 0);
            const isNew = prior.gmv === 0 && current.gmv > 0;

            // Get videos for this creator and aggregate by video_id
            const { data: rawVideos } = await supabaseClient.from('video_performance')
                .select('*')
                .ilike('creator_name', creatorName)
                .eq('brand', brand)
                .gte('report_date', startDate)
                .lte('report_date', endDate);
            
            // Brand keyword patterns for mismatch detection
            const brandKeywords = {
                'physicians_choice': ['physicians choice', 'physician\'s choice', 'pc probiotic', 'digestive enzyme'],
                'catakor': ['cata-kor', 'catakor', 'cata kor'],
                'yerba_magic': ['yerba magic', 'yerba', 'mate'],
                'jiyu': ['jiyu', 'ji-yu', 'ji yu'],
                'peach_slices': ['peach slices', 'peach slice', 'acne']
            };
            
            function detectBrandMismatch(videoTitle, productName, taggedBrand) {
                const searchText = ((videoTitle || '') + ' ' + (productName || '')).toLowerCase();
                for (const [brandKey, keywords] of Object.entries(brandKeywords)) {
                    if (brandKey !== taggedBrand.toLowerCase()) {
                        for (const kw of keywords) {
                            if (searchText.includes(kw)) {
                                return brandKey; // Return the brand it likely belongs to
                            }
                        }
                    }
                }
                return null;
            }

            // Aggregate videos by video_id
            const videoMap = new Map();
            (rawVideos || []).forEach(row => {
                const key = row.video_id;
                if (!videoMap.has(key)) {
                    // Build proper TikTok URL from video_id and creator_name
                    const tiktokUrl = row.video_id ? `https://www.tiktok.com/@${creatorName}/video/${row.video_id}` : null;
                    const likelyBrand = detectBrandMismatch(row.video_title, row.product_name, brand);
                    videoMap.set(key, {
                        video_id: row.video_id,
                        video_title: row.video_title,
                        video_link: tiktokUrl,
                        taggedBrand: row.brand,
                        likelyBrand: likelyBrand, // If not null, this video may be mistagged
                        gmv: 0,
                        orders: 0,
                        views: 0
                    });
                }
                const v = videoMap.get(key);
                v.gmv += pFloat(row.gmv);
                v.orders += pInt(row.orders);
                v.views += pInt(row.views);
            });
            const videos = [...videoMap.values()].sort((a, b) => b.gmv - a.gmv).slice(0, 5);

            // Get notes for this creator
            const { data: notes } = await supabaseClient.from('creator_notes')
                .select('*')
                .eq('creator_name', creatorName)
                .order('created_at', { ascending: false })
                .limit(10);

            const managed = isManagedForBrand(creatorName, brand);
            const info = getManagedInfo(creatorName);
            const tier = getTier(current.gmv);
            
            // Format date range for display
            const dateRangeDisplay = `${new Date(startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(endDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            document.getElementById('creatorDetailBody').innerHTML = `
                <!-- Header Section -->
                <div class="detail-header">
                    <div class="detail-avatar" style="font-size: 2rem; width: 70px; height: 70px;">${creatorName.charAt(0).toUpperCase()}</div>
                    <div class="detail-info" style="flex: 1;">
                        <div class="detail-name" style="font-size: 1.5rem; margin-bottom: 4px;">${creatorName}</div>
                        ${info?.real_name ? `<div style="color: var(--text-secondary); margin-bottom: 8px;">${info.real_name}${info.discord ? `  Discord: ${info.discord}` : ''}</div>` : ''}
                        <div class="detail-meta" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                            <span class="badge-brand">${BRAND_DISPLAY[brand] || brand}</span>
                            <span class="badge-tier ${tier.class}">${tier.name}</span>
                            <span class="badge ${managed ? 'badge-managed' : 'badge-unmanaged'}">${managed ? ' Managed' : 'Unmanaged'}</span>
                            ${info?.role ? `<span class="badge" style="background: var(--bg-secondary);">${info.role}</span>` : ''}
                            ${info?.discord_channel_id ? `
                                <button onclick="openDiscordChat('${brand}', '${info.discord_channel_id}')" 
                                    style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; 
                                    background: #5865F2; color: white; border: none; border-radius: 6px; 
                                    font-size: 0.8rem; font-weight: 600; cursor: pointer; margin-left: 8px;"
                                    onmouseover="this.style.background='#4752C4'" 
                                    onmouseout="this.style.background='#5865F2'">
                                     Open Discord Chat
                                </button>
                            ` : (managed ? `
                                <span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 8px;">
                                    (No Discord channel linked)
                                </span>
                            ` : '')}
                        </div>
                    </div>
                    <div style="text-align: right; color: var(--text-muted); font-size: 0.85rem;">
                        <div> ${dateRangeDisplay}</div>
                        <div style="margin-top: 4px;">${daysDiff} days</div>
                    </div>
                </div>

                <!-- Key Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, rgba(245, 197, 24, 0.15) 0%, var(--bg-secondary) 100%); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent); font-family: 'Space Mono', monospace;">${fmtMoney(current.gmv)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Total GMV</div>
                        <div style="font-size: 0.85rem; margin-top: 4px;" class="${isNew ? '' : gmvChange >= 0 ? 'trend-up' : 'trend-down'}">
                            ${isNew ? ' New Creator' : `${gmvChange >= 0 ? '' : ''} ${Math.abs(gmvChange).toFixed(1)}% vs prior`}
                        </div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; font-family: 'Space Mono', monospace;">${fmt(current.orders)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Orders</div>
                        <div style="font-size: 0.85rem; margin-top: 4px; color: var(--text-muted);">Prior: ${fmt(prior.orders)}</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; font-family: 'Space Mono', monospace;">${current.videos}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Videos</div>
                        <div style="font-size: 0.85rem; margin-top: 4px; color: var(--text-muted);">Prior: ${prior.videos}</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; font-family: 'Space Mono', monospace;">${fmtMoney(current.est_commission)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Est. Commission</div>
                        ${info?.retainer ? `<div style="font-size: 0.85rem; margin-top: 4px; color: var(--text-muted);">+ $${info.retainer}/mo retainer</div>` : ''}
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- GMV Trend Chart -->
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 600; margin-bottom: 12px;"> GMV Trend</div>
                        <div style="height: 180px;">
                            <canvas id="creatorDetailChart"></canvas>
                        </div>
                    </div>

                    <!-- Additional Metrics -->
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 600; margin-bottom: 12px;"> Performance Metrics</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 600;">${fmtMoney(current.aov)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Avg Order Value</div>
                            </div>
                            <div style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 600;">${fmtMoney(current.videos > 0 ? current.gmv / current.videos : 0)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">GMV per Video</div>
                            </div>
                            <div style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 600;">${fmt(current.items_sold)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Items Sold</div>
                            </div>
                            <div style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 600;">${current.live_streams}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">LIVE Streams</div>
                            </div>
                            <div style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 600;">${fmtMoney(current.refunds)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Refunds</div>
                            </div>
                            <div style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 600;">${current.gmv > 0 ? ((current.refunds / current.gmv) * 100).toFixed(1) : 0}%</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Refund Rate</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Videos -->
                ${videos && videos.length > 0 ? `
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="font-weight: 600; margin-bottom: 12px;"> Top Performing Videos</div>
                    <div style="display: grid; gap: 8px;">
                        ${videos.map((v, i) => {
                            const hasVideo = v.video_id && v.video_id.toString().trim() !== '';
                            const mismatchBrand = v.likelyBrand; // Will be set if keywords suggest different brand
                            return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg-card); border-radius: 8px; ${hasVideo ? 'cursor: pointer;' : ''} ${mismatchBrand ? 'border: 1px solid var(--warning);' : ''}" ${hasVideo ? `onclick="openVideoEmbed('${v.video_id}', '${(v.video_title || 'Untitled Video').replace(/'/g, "\\'")}', ${v.gmv || 0}, ${v.orders || 0}, '${creatorName.replace(/'/g, "\\'")}')"` : ''}>
                                <div style="font-weight: 600; color: ${i < 3 ? 'var(--accent)' : 'var(--text-muted)'}; min-width: 28px;">#${i + 1}</div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                        <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); max-width: 280px;" title="${(v.video_title || 'Untitled Video').replace(/"/g, '&quot;')}">
                                            ${(v.video_title || 'Untitled Video').substring(0, 50)}${(v.video_title || '').length > 50 ? '...' : ''}
                                        </span>
                                        ${hasVideo ? '<span style="color: var(--accent); font-size: 0.8rem;"></span>' : ''}
                                        ${mismatchBrand ? `<span style="font-size: 0.65rem; background: var(--warning-dim); color: var(--warning); padding: 2px 6px; border-radius: 4px;" title="Video may belong to ${BRAND_DISPLAY[mismatchBrand] || mismatchBrand} based on content"> Check brand</span>` : ''}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${fmt(v.orders || 0)} orders</div>
                                </div>
                                <div style="text-align: right; flex-shrink: 0;">
                                    <div style="font-weight: 600; color: var(--accent);">${fmtMoney(v.gmv)}</div>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Notes Section -->
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 600;"> Notes</div>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="showAddNoteForm('${creatorName.replace(/'/g, "\\'")}')">+ Add Note</button>
                    </div>
                    <div id="creatorNotesContainer">
                        ${notes && notes.length > 0 ? notes.map(n => `
                            <div style="padding: 12px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; position: relative;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">
                                    ${new Date(n.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}
                                </div>
                                <div style="white-space: pre-wrap;">${n.note}</div>
                                <button onclick="deleteNote(${n.id})" style="position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem;" title="Delete note"></button>
                            </div>
                        `).join('') : '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No notes yet</div>'}
                    </div>
                    <div id="addNoteForm" style="display: none; margin-top: 12px;">
                        <textarea id="newNoteText" class="form-input" rows="3" placeholder="Add a note about this creator..." style="width: 100%; resize: vertical;"></textarea>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-primary" onclick="saveCreatorNote('${creatorName.replace(/'/g, "\\'")}', '${brand}')">Save Note</button>
                            <button class="btn btn-secondary" onclick="hideAddNoteForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; flex-wrap: wrap; padding-top: 16px; border-top: 1px solid var(--border);">
                    ${!managed ? `
                        <button class="btn btn-primary" onclick="quickAddToRoster('${creatorName.replace(/'/g, "\\'")}', '${brand}'); closeCreatorDetail();">
                             Add to Roster
                        </button>
                    ` : `
                        <button class="btn btn-secondary" onclick="editManagedCreator('${creatorName.replace(/'/g, "\\'")}'); closeCreatorDetail();">
                             Edit in Roster
                        </button>
                    `}
                    <button class="btn btn-secondary" onclick="window.open('https://www.tiktok.com/@${creatorName}', '_blank')">
                         View TikTok Profile
                    </button>
                    <button class="btn btn-secondary" onclick="switchView('videos'); document.getElementById('videosSearchInput').value = '${creatorName.replace(/'/g, "\\'")}'; loadVideosData(); closeCreatorDetail();">
                         View All Videos
                    </button>
                </div>
            `;

            // Render the GMV trend chart
            setTimeout(() => {
                renderCreatorDetailChart(perfData);
            }, 100);
        }

        function renderCreatorDetailChart(perfData) {
            const ctx = document.getElementById('creatorDetailChart');
            if (!ctx) return;
            
            if (creatorDetailChartInstance) {
                creatorDetailChartInstance.destroy();
            }
            
            const labels = perfData.map(d => {
                const date = new Date(d.report_date + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const values = perfData.map(d => pFloat(d.gmv));

            creatorDetailChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'GMV',
                        data: values,
                        borderColor: '#f5c518',
                        backgroundColor: 'rgba(245, 197, 24, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: values.length > 14 ? 0 : 3,
                        pointBackgroundColor: '#f5c518'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => fmtMoney(ctx.raw)
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#9aa5b8',
                                maxRotation: 45,
                                maxTicksLimit: 7
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#9aa5b8',
                                callback: (v) => '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'K' : v)
                            }
                        }
                    }
                }
            });
        }

        function showAddNoteForm(creatorName) {
            document.getElementById('addNoteForm').style.display = 'block';
            document.getElementById('newNoteText').focus();
        }

        function hideAddNoteForm() {
            document.getElementById('addNoteForm').style.display = 'none';
            document.getElementById('newNoteText').value = '';
        }

        async function saveCreatorNote(creatorName, brand) {
            const noteText = document.getElementById('newNoteText').value.trim();
            if (!noteText) {
                showToast('Please enter a note', 'error');
                return;
            }
            
            const { error } = await supabaseClient.from('creator_notes').insert({
                creator_name: creatorName,
                brand: brand,
                note: noteText
            });
            
            if (error) {
                showToast('Error saving note: ' + error.message, 'error');
                return;
            }
            
            showToast('Note saved!', 'success');
            hideAddNoteForm();
            
            // Refresh the modal to show the new note
            openCreatorDetail(creatorName, brand);
        }

        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            const { error } = await supabaseClient.from('creator_notes').delete().eq('id', noteId);
            
            if (error) {
                showToast('Error deleting note: ' + error.message, 'error');
                return;
            }
            
            // Remove from DOM
            event.target.closest('div[style*="padding: 12px"]').remove();
            showToast('Note deleted', 'success');
        }

        function editManagedCreator(creatorName) {
            // Find the managed creator and open edit modal
            const info = getManagedInfo(creatorName);
            if (info && info.id) {
                switchView('roster');
                setTimeout(() => {
                    editCreator(info.id);
                }, 300);
            } else {
                showToast('Creator not found in roster', 'error');
            }
        }

        function closeCreatorDetail() {
            document.getElementById('creatorDetailModal').classList.remove('show');
            if (creatorDetailChartInstance) {
                creatorDetailChartInstance.destroy();
                creatorDetailChartInstance = null;
            }
        }
        
        // ==================== CREATOR DATA MANAGEMENT ====================
        function showChangeBrandModal() {
            const { name, brand } = currentCreatorDetail;
            if (!name || !brand) return;
            
            const brands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            const otherBrands = brands.filter(b => b !== brand);
            
            const content = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 16px;"></div>
                    <h3 style="margin-bottom: 8px;">Change Brand for ${name}</h3>
                    <p style="color: var(--text-muted); margin-bottom: 24px;">
                        Current brand: <strong>${BRAND_DISPLAY[brand] || brand}</strong><br>
                        This will update all creator_performance and video_performance records.
                    </p>
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select new brand:</label>
                        <select id="newBrandSelect" class="form-input" style="width: 100%; max-width: 300px; margin: 0 auto;">
                            ${otherBrands.map(b => `<option value="${b}">${BRAND_DISPLAY[b] || b}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="executeChangeBrand('${name}', '${brand}')">
                            Change Brand
                        </button>
                    </div>
                </div>
            `;
            
            showConfirmModal(content);
        }
        
        async function executeChangeBrand(creatorName, oldBrand) {
            const newBrand = document.getElementById('newBrandSelect').value;
            if (!newBrand || newBrand === oldBrand) {
                showToast('Please select a different brand', 'error');
                return;
            }
            
            closeConfirmModal();
            showToast('Updating brand...', 'info');
            
            try {
                // Update creator_performance records
                const { error: cpError } = await supabaseClient
                    .from('creator_performance')
                    .update({ brand: newBrand })
                    .eq('creator_name', creatorName)
                    .eq('brand', oldBrand);
                
                if (cpError) throw cpError;
                
                // Update video_performance records
                const { error: vpError } = await supabaseClient
                    .from('video_performance')
                    .update({ brand: newBrand })
                    .ilike('creator_name', creatorName)
                    .eq('brand', oldBrand);
                
                if (vpError) throw vpError;
                
                showToast(` Brand changed to ${BRAND_DISPLAY[newBrand]}`, 'success');
                
                // Close modal and refresh
                closeCreatorDetail();
                currentCreatorDetail = { name: null, brand: null };
                
                // Refresh creators view if active
                if (window.creatorsDataLoaded) loadCreatorsData();
                
            } catch (err) {
                console.error('Change brand error:', err);
                showToast(`Error: ${err.message}`, 'error');
            }
        }
        
        function confirmRemoveCreator() {
            const { name, brand } = currentCreatorDetail;
            if (!name || !brand) return;
            
            const content = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 16px;"></div>
                    <h3 style="margin-bottom: 8px; color: var(--danger);">Remove Creator Data</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">
                        This will permanently delete all data for:<br>
                        <strong style="color: var(--text-primary);">${name}</strong> (${BRAND_DISPLAY[brand] || brand})
                    </p>
                    <div style="background: var(--danger-dim); border: 1px solid var(--danger); border-radius: 8px; padding: 12px; margin-bottom: 24px;">
                        <div style="font-size: 0.85rem; color: var(--danger);">
                             This action cannot be undone!<br>
                            All performance data and video records will be deleted.
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                        <button class="btn" style="background: var(--danger); color: white;" onclick="executeRemoveCreator('${name.replace(/'/g, "\\'")}', '${brand}')">
                             Delete Permanently
                        </button>
                    </div>
                </div>
            `;
            
            showConfirmModal(content);
        }
        
        async function executeRemoveCreator(creatorName, brand) {
            closeConfirmModal();
            showToast('Removing creator data...', 'info');
            
            try {
                // Delete creator_performance records
                const { error: cpError, count: cpCount } = await supabaseClient
                    .from('creator_performance')
                    .delete()
                    .eq('creator_name', creatorName)
                    .eq('brand', brand);
                
                if (cpError) throw cpError;
                
                // Delete video_performance records
                const { error: vpError, count: vpCount } = await supabaseClient
                    .from('video_performance')
                    .delete()
                    .ilike('creator_name', creatorName)
                    .eq('brand', brand);
                
                if (vpError) throw vpError;
                
                showToast(` Removed ${creatorName} from ${BRAND_DISPLAY[brand]}`, 'success');
                
                // Close modal and refresh
                closeCreatorDetail();
                currentCreatorDetail = { name: null, brand: null };
                
                // Refresh creators view if active
                if (window.creatorsDataLoaded) loadCreatorsData();
                
            } catch (err) {
                console.error('Remove creator error:', err);
                showToast(`Error: ${err.message}`, 'error');
            }
        }
        
        function showConfirmModal(content) {
            // Create a simple confirmation modal overlay
            let modal = document.getElementById('confirmActionModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'confirmActionModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal" style="max-width: 450px;"><div class="modal-body" id="confirmActionBody"></div></div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('confirmActionBody').innerHTML = content;
            modal.classList.add('show');
        }
        
        function closeConfirmModal() {
            const modal = document.getElementById('confirmActionModal');
            if (modal) modal.classList.remove('show');
        }

        // ==================== VIDEO PLAYER ====================
        function openVideoLink(url) {
            console.log('Opening video link:', url);
            if (!url || url === 'null' || url === 'undefined') {
                showToast('No video link available', 'error');
                return;
            }
            // Decode the URI in case it was encoded
            const decodedUrl = decodeURI(url);
            console.log('Decoded URL:', decodedUrl);
            
            // Open in new tab
            const newWindow = window.open(decodedUrl, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                // Popup was blocked
                showToast('Popup blocked - click the link below', 'warning');
                // Create a temporary link as fallback
                const tempLink = document.createElement('a');
                tempLink.href = decodedUrl;
                tempLink.target = '_blank';
                tempLink.click();
            }
        }
        
        let currentVideoUrl = '';
        
        function openVideoEmbed(videoId, title, gmv, orders, creatorName) {
            const modal = document.getElementById('videoPlayerModal');
            const content = document.getElementById('videoPlayerContent');
            const titleEl = document.getElementById('videoPlayerTitle');
            const statsEl = document.getElementById('videoPlayerStats');
            const linkEl = document.getElementById('videoPlayerLink');
            
            // Build and store the URL
            currentVideoUrl = `https://www.tiktok.com/@${creatorName}/video/${videoId}`;
            
            // Set title and stats
            titleEl.textContent = title || 'TikTok Video';
            titleEl.title = title || 'TikTok Video';
            statsEl.innerHTML = `${fmtMoney(gmv)} GMV  ${fmt(orders)} orders`;
            linkEl.href = currentVideoUrl;
            
            if (videoId) {
                // Use TikTok's embed
                content.innerHTML = `
                    <iframe 
                        src="https://www.tiktok.com/embed/v2/${videoId}" 
                        style="width: 100%; height: 100%; border: none;"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                `;
            } else {
                content.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                        <div>No video ID available</div>
                    </div>
                `;
            }
            
            modal.classList.add('show');
        }
        
        function copyVideoUrl() {
            if (currentVideoUrl) {
                navigator.clipboard.writeText(currentVideoUrl).then(() => {
                    showToast('URL copied to clipboard!', 'success');
                }).catch(() => {
                    showToast('Failed to copy URL', 'error');
                });
            }
        }

        // ==================== PDF EXPORT ====================
        function exportToPDF(viewId, title) {
            // Add print header
            const printHeader = document.createElement('div');
            printHeader.className = 'print-header';
            printHeader.innerHTML = `
                <img src="logo.png" alt="Creators Corner" onerror="this.outerHTML='<strong style=\\'color:#f5c518;font-size:1.5rem;\\'>CREATORS CORNER</strong>'">
                <h1>${title}</h1>
                <p>Generated: ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            `;
            
            const viewSection = document.getElementById(viewId);
            viewSection.insertBefore(printHeader, viewSection.firstChild);
            
            // Mark view as print-active
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('print-active'));
            viewSection.classList.add('print-active');
            
            // Trigger print
            window.print();
            
            // Cleanup
            setTimeout(() => {
                printHeader.remove();
                viewSection.classList.remove('print-active');
            }, 100);
        }

        // ==================== COMPARISON MODE ====================
        let comparePickers = {};
        
        function openComparisonModal() {
            document.getElementById('comparisonModal').classList.add('show');
            document.getElementById('comparisonResults').style.display = 'none';
            
            const dates = availableDates.daily || [];
            if (dates.length < 2) return;
            
            const sortedDates = [...dates].sort();
            const minDate = sortedDates[0];
            const maxDate = sortedDates[sortedDates.length - 1];
            
            // Default: Period A = last 7 days, Period B = 7 days before that
            const today = new Date();
            const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7);
            const twoWeeksAgo = new Date(today); twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            
            const config = (defaultDate) => ({
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'M j',
                minDate: minDate,
                maxDate: maxDate,
                defaultDate: defaultDate
            });
            
            // Destroy existing pickers
            Object.values(comparePickers).forEach(p => p?.destroy?.());
            
            comparePickers.startA = flatpickr('#compareStartA', config(localDateStr(weekAgo)));
            comparePickers.endA = flatpickr('#compareEndA', config(localDateStr(today)));
            comparePickers.startB = flatpickr('#compareStartB', config(localDateStr(twoWeeksAgo)));
            comparePickers.endB = flatpickr('#compareEndB', config(localDateStr(weekAgo)));
        }
        
        function closeComparisonModal() {
            document.getElementById('comparisonModal').classList.remove('show');
        }
        
        async function runComparison() {
            const startA = document.getElementById('compareStartA').value;
            const endA = document.getElementById('compareEndA').value;
            const startB = document.getElementById('compareStartB').value;
            const endB = document.getElementById('compareEndB').value;
            
            if (!startA || !endA || !startB || !endB) {
                showToast('Please select all dates', 'error');
                return;
            }
            
            // Fetch Period A data
            const { data: dataA } = await supabaseClient.from('creator_performance')
                .select('*')
                .gte('report_date', startA)
                .lte('report_date', endA)
                .eq('period_type', 'daily');
            
            // Fetch Period B data
            const { data: dataB } = await supabaseClient.from('creator_performance')
                .select('*')
                .gte('report_date', startB)
                .lte('report_date', endB)
                .eq('period_type', 'daily');
            
            // Aggregate
            const aggregate = (data) => ({
                gmv: (data || []).reduce((s, d) => s + (d.gmv || 0), 0),
                orders: (data || []).reduce((s, d) => s + (d.orders || 0), 0),
                videos: (data || []).reduce((s, d) => s + (d.videos || 0), 0),
                creators: new Set((data || []).map(d => d.creator_name)).size
            });
            
            const statsA = aggregate(dataA);
            const statsB = aggregate(dataB);
            
            // Calculate changes
            const pctChange = (a, b) => b > 0 ? ((a - b) / b * 100) : (a > 0 ? 100 : 0);
            
            const renderStats = (stats, label) => `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent);">${fmtMoney(stats.gmv)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">GMV</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 1.3rem; font-weight: 700;">${fmt(stats.orders)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Orders</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 1.3rem; font-weight: 700;">${stats.videos}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Videos</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 1.3rem; font-weight: 700;">${stats.creators}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Creators</div>
                    </div>
                </div>
            `;
            
            document.getElementById('comparisonA').innerHTML = renderStats(statsA, 'A');
            document.getElementById('comparisonB').innerHTML = renderStats(statsB, 'B');
            
            const gmvChange = pctChange(statsA.gmv, statsB.gmv);
            const ordersChange = pctChange(statsA.orders, statsB.orders);
            const videosChange = pctChange(statsA.videos, statsB.videos);
            const creatorsChange = pctChange(statsA.creators, statsB.creators);
            
            const changeClass = (val) => val >= 0 ? 'color: var(--success)' : 'color: var(--danger)';
            const changeIcon = (val) => val >= 0 ? '' : '';
            
            document.getElementById('comparisonSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; ${changeClass(gmvChange)}">${changeIcon(gmvChange)} ${Math.abs(gmvChange).toFixed(1)}%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">GMV</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; ${changeClass(ordersChange)}">${changeIcon(ordersChange)} ${Math.abs(ordersChange).toFixed(1)}%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Orders</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; ${changeClass(videosChange)}">${changeIcon(videosChange)} ${Math.abs(videosChange).toFixed(1)}%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Videos</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; ${changeClass(creatorsChange)}">${changeIcon(creatorsChange)} ${Math.abs(creatorsChange).toFixed(1)}%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Creators</div>
                    </div>
                </div>
                <p style="margin-top: 16px; color: var(--text-secondary); font-size: 0.85rem;">
                    Comparing <strong>Period A</strong> (${formatDate(startA)}  ${formatDate(endA)}) against <strong>Period B</strong> (${formatDate(startB)}  ${formatDate(endB)})
                </p>
            `;
            
            document.getElementById('comparisonResults').style.display = 'block';
        }

        // ==================== SETTINGS TAB SWITCHING ====================
        let settingsProductsLoaded = false;
        
        function switchSettingsTab(tab) {
            // Update tab styling
            document.querySelectorAll('.settings-tab').forEach(t => {
                t.classList.remove('active');
                t.style.background = 'transparent';
                t.style.color = 'var(--text-muted)';
            });
            const activeTab = document.querySelector(`.settings-tab[data-tab="${tab}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.background = 'var(--bg-card)';
                activeTab.style.color = 'var(--text-primary)';
            }
            
            // Show/hide tab content
            document.querySelectorAll('.settings-tab-content').forEach(c => c.style.display = 'none');
            const content = document.getElementById(`settings-tab-${tab}`);
            if (content) content.style.display = 'block';
            
            // Load data for specific tabs
            if (tab === 'products' && !settingsProductsLoaded) {
                settingsProductsLoaded = true;
                loadSettingsProducts();
            }
            if (tab === 'notifications') {
                renderDiscordRoutingTable();
            }
            if (tab === 'brands') {
                updateBrandSettings();
            }
            if (tab === 'application') {
                loadBrandAppSettings();
                renderBrandQuickLinks();
            }
        }
        
        // ==================== BRAND APPLICATION SETTINGS ====================
        let currentBrandAppSettings = {};
        let customFieldsCounter = 0;
        
        function loadBrandAppSettings() {
            const brand = document.getElementById('appSettingsBrandSelect')?.value || 'default';
            
            // Load from localStorage (could be database in future)
            const allSettings = JSON.parse(localStorage.getItem('brandAppSettings') || '{}');
            currentBrandAppSettings = allSettings[brand] || {};
            
            // Populate form fields
            document.getElementById('appSettingsTitle').value = currentBrandAppSettings.title || '';
            document.getElementById('appSettingsSubtitle').value = currentBrandAppSettings.subtitle || '';
            document.getElementById('appSettingsLogo').value = currentBrandAppSettings.logo || '';
            document.getElementById('appSettingsColor').value = currentBrandAppSettings.color || '#f5c518';
            document.getElementById('appSettingsColorText').value = currentBrandAppSettings.color || '#f5c518';
            document.getElementById('appSettingsWelcomeVideo').value = currentBrandAppSettings.welcome_video || '';
            document.getElementById('appSettingsThankYouVideo').value = currentBrandAppSettings.thank_you_video || '';
            document.getElementById('appSettingsSuccessTitle').value = currentBrandAppSettings.success_title || '';
            document.getElementById('appSettingsSuccessMsg').value = currentBrandAppSettings.success_message || '';
            document.getElementById('appSettingsDiscordClientId').value = currentBrandAppSettings.discord_client_id || '';
            
            // Load custom fields
            renderCustomFields(currentBrandAppSettings.custom_fields || []);
            
            // Sync color inputs
            document.getElementById('appSettingsColor').addEventListener('input', function() {
                document.getElementById('appSettingsColorText').value = this.value;
            });
        }
        
        function saveBrandAppSettings() {
            const brand = document.getElementById('appSettingsBrandSelect')?.value || 'default';
            
            // Collect settings
            const settings = {
                title: document.getElementById('appSettingsTitle').value.trim(),
                subtitle: document.getElementById('appSettingsSubtitle').value.trim(),
                logo: document.getElementById('appSettingsLogo').value.trim(),
                color: document.getElementById('appSettingsColorText').value.trim() || document.getElementById('appSettingsColor').value,
                welcome_video: document.getElementById('appSettingsWelcomeVideo').value.trim(),
                thank_you_video: document.getElementById('appSettingsThankYouVideo').value.trim(),
                success_title: document.getElementById('appSettingsSuccessTitle').value.trim(),
                success_message: document.getElementById('appSettingsSuccessMsg').value.trim(),
                discord_client_id: document.getElementById('appSettingsDiscordClientId').value.trim(),
                custom_fields: collectCustomFields()
            };
            
            // Save to localStorage
            const allSettings = JSON.parse(localStorage.getItem('brandAppSettings') || '{}');
            allSettings[brand] = settings;
            localStorage.setItem('brandAppSettings', JSON.stringify(allSettings));
            
            currentBrandAppSettings = settings;
            
            // Show success message
            const status = document.getElementById('appSettingsStatus');
            status.innerHTML = '<span style="color: var(--success);"> Settings saved!</span>';
            setTimeout(() => { status.innerHTML = ''; }, 3000);
            
            showToast(`${brand === 'default' ? 'Default' : BRAND_DISPLAY[brand]} application settings saved!`, 'success');
        }
        
        function resetBrandAppSettings() {
            const brand = document.getElementById('appSettingsBrandSelect')?.value || 'default';
            if (!confirm(`Reset ${brand === 'default' ? 'default' : BRAND_DISPLAY[brand]} application settings to blank?`)) return;
            
            const allSettings = JSON.parse(localStorage.getItem('brandAppSettings') || '{}');
            delete allSettings[brand];
            localStorage.setItem('brandAppSettings', JSON.stringify(allSettings));
            
            loadBrandAppSettings();
            showToast('Settings reset', 'success');
        }
        
        function collectCustomFields() {
            const fields = [];
            document.querySelectorAll('.custom-field-item').forEach(item => {
                fields.push({
                    id: item.dataset.fieldId,
                    label: item.querySelector('.field-label-input')?.value || '',
                    type: item.querySelector('.field-type-select')?.value || 'text',
                    required: item.querySelector('.field-required-check')?.checked || false,
                    placeholder: item.querySelector('.field-placeholder-input')?.value || ''
                });
            });
            return fields;
        }
        
        function renderCustomFields(fields) {
            const container = document.getElementById('customFieldsList');
            if (!fields || fields.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem; padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">No custom fields. Standard fields (Name, Email, TikTok, Brand) are always included.</div>';
                return;
            }
            
            container.innerHTML = fields.map((f, i) => `
                <div class="custom-field-item" data-field-id="${f.id || 'field_' + i}" style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; display: grid; grid-template-columns: 1fr 120px 80px auto; gap: 12px; align-items: center;">
                    <input type="text" class="form-input field-label-input" placeholder="Field Label" value="${f.label || ''}" style="font-size: 0.9rem;">
                    <select class="form-input field-type-select" style="font-size: 0.85rem;">
                        <option value="text" ${f.type === 'text' ? 'selected' : ''}>Text</option>
                        <option value="textarea" ${f.type === 'textarea' ? 'selected' : ''}>Long Text</option>
                        <option value="number" ${f.type === 'number' ? 'selected' : ''}>Number</option>
                        <option value="select" ${f.type === 'select' ? 'selected' : ''}>Dropdown</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; cursor: pointer;">
                        <input type="checkbox" class="field-required-check" ${f.required ? 'checked' : ''}> Required
                    </label>
                    <button class="btn" onclick="removeCustomField(this)" style="padding: 6px 10px; color: var(--danger);"></button>
                </div>
            `).join('');
        }
        
        function addCustomField() {
            const container = document.getElementById('customFieldsList');
            
            // Remove empty state message if present
            if (container.querySelector('div[style*="text-align: center"]')) {
                container.innerHTML = '';
            }
            
            const fieldId = 'custom_' + Date.now();
            const html = `
                <div class="custom-field-item" data-field-id="${fieldId}" style="padding: 16px; background: var(--bg-secondary); border-radius: 10px; display: grid; grid-template-columns: 1fr 120px 80px auto; gap: 12px; align-items: center;">
                    <input type="text" class="form-input field-label-input" placeholder="Field Label (e.g., Follower Count)" style="font-size: 0.9rem;">
                    <select class="form-input field-type-select" style="font-size: 0.85rem;">
                        <option value="text">Text</option>
                        <option value="textarea">Long Text</option>
                        <option value="number">Number</option>
                        <option value="select">Dropdown</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; cursor: pointer;">
                        <input type="checkbox" class="field-required-check"> Required
                    </label>
                    <button class="btn" onclick="removeCustomField(this)" style="padding: 6px 10px; color: var(--danger);"></button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
        
        function removeCustomField(btn) {
            btn.closest('.custom-field-item').remove();
            
            // Show empty state if no fields left
            const container = document.getElementById('customFieldsList');
            if (container.children.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem; padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">No custom fields. Standard fields (Name, Email, TikTok, Brand) are always included.</div>';
            }
        }
        
        function renderBrandQuickLinks() {
            const brands = [
                { key: 'catakor', name: 'Cata-Kor', icon: '' },
                { key: 'jiyu', name: 'JiYu', icon: '' },
                { key: 'physicians_choice', name: 'Physicians Choice', icon: '' },
                { key: 'peach_slices', name: 'Peach Slices', icon: '' },
                { key: 'yerba_magic', name: 'Yerba Magic', icon: '' },
                { key: 'toplux', name: 'Toplux Nutrition', icon: '' }
            ];
            
            const baseUrl = window.location.origin;
            const container = document.getElementById('brandQuickLinks');
            
            container.innerHTML = brands.map(b => `
                <div style="padding: 14px; background: var(--bg-secondary); border-radius: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.1rem;">${b.icon}</span>
                        <span style="font-weight: 500;">${b.name}</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="copyToClipboard('${baseUrl}/apply?brand=${b.key}')" style="padding: 6px 10px; font-size: 0.8rem;"> Copy</button>
                        <button class="btn" onclick="window.open('/apply?brand=${b.key}', '_blank')" style="padding: 6px 10px; font-size: 0.8rem;"></button>
                    </div>
                </div>
            `).join('');
        }
        
        function testApplyPageFromSettings() {
            const brand = document.getElementById('appSettingsBrandSelect')?.value || 'default';
            if (brand === 'default') {
                window.open('/apply', '_blank');
            } else {
                window.open('/apply?brand=' + brand, '_blank');
            }
        }
        
        // ==================== BRAND SETTINGS ====================
        async function updateBrandSettings() {
            const brand = document.getElementById('brandSettingsSelect')?.value || 'catakor';
            const baseUrl = window.location.origin;
            
            // Update URLs
            document.getElementById('brandApplyUrl').textContent = `${baseUrl}/apply?brand=${brand}`;
            document.getElementById('brandPortalUrl').textContent = `${baseUrl}/brand-portal?brand=${brand}`;
            
            // Update info cards
            const config = {
                'catakor': { icon: '', color: '#e74c3c', name: 'Cata-Kor' },
                'jiyu': { icon: '', color: '#9b59b6', name: 'JiYu' },
                'physicians_choice': { icon: '', color: '#3498db', name: 'Physicians Choice' },
                'peach_slices': { icon: '', color: '#ff6b9d', name: 'Peach Slices' },
                'yerba_magic': { icon: '', color: '#2ecc71', name: 'Yerba Magic' },
                'toplux': { icon: '', color: '#00b894', name: 'Toplux Nutrition' }
            };
            
            const c = config[brand] || { icon: '', color: '#888', name: brand };
            
            document.getElementById('brandInfoCards').innerHTML = `
                <div style="background: linear-gradient(135deg, ${c.color}20 0%, ${c.color}10 100%); border: 1px solid ${c.color}40; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">${c.icon}</div>
                    <div style="font-weight: 700; color: ${c.color};">${c.name}</div>
                </div>
            `;
            
            // Load stats for this brand
            try {
                // Get creator count
                const { data: creators } = await supabaseClient
                    .from('creator_roster')
                    .select('id')
                    .eq('brand', brand);
                document.getElementById('brandStatCreators').textContent = creators?.length || 0;
                
                // Get 30-day GMV
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                const { data: perfData } = await supabaseClient
                    .from('creator_performance')
                    .select('gmv')
                    .eq('brand', brand)
                    .eq('period_type', 'daily')
                    .gte('report_date', startDate.toISOString().split('T')[0])
                    .lte('report_date', endDate.toISOString().split('T')[0]);
                
                const totalGMV = perfData?.reduce((sum, r) => sum + (parseFloat(r.gmv) || 0), 0) || 0;
                document.getElementById('brandStatGMV').textContent = fmtMoney(totalGMV);
                
                // Get product count
                const { data: products } = await supabaseClient
                    .from('products')
                    .select('id')
                    .eq('brand', brand);
                document.getElementById('brandStatProducts').textContent = products?.length || 0;
                
                // Get pending applications
                const { data: apps } = await supabaseClient
                    .from('creator_applications')
                    .select('id')
                    .eq('brand', brand)
                    .eq('status', 'pending');
                document.getElementById('brandStatApps').textContent = apps?.length || 0;
                
            } catch (err) {
                console.error('Error loading brand stats:', err);
            }
        }
        
        function copyBrandApplyLink() {
            const brand = document.getElementById('brandSettingsSelect')?.value || 'catakor';
            const link = `${window.location.origin}/apply?brand=${brand}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast(`${BRAND_DISPLAY[brand]} apply link copied!`, 'success');
            });
        }
        
        function copyBrandPortalLink() {
            const brand = document.getElementById('brandSettingsSelect')?.value || 'catakor';
            const link = `${window.location.origin}/brand-portal?brand=${brand}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast(`${BRAND_DISPLAY[brand]} portal link copied!`, 'success');
            });
        }
        
        function openBrandPortalLink() {
            const brand = document.getElementById('brandSettingsSelect')?.value || 'catakor';
            window.open(`/brand-portal?brand=${brand}`, '_blank');
        }
        
        function testApplyPage() {
            const brand = document.getElementById('brandSettingsSelect')?.value || 'catakor';
            window.open(`/apply?brand=${brand}`, '_blank');
        }

        // ==================== DISCORD WEBHOOKS MANAGEMENT ====================
        let discordWebhooks = [];
        let notificationLog = [];
        
        function loadDiscordSettings() {
            // Load webhooks from localStorage
            discordWebhooks = JSON.parse(localStorage.getItem('discordWebhooks') || '[]');
            
            // Migrate old single webhook if exists
            const oldWebhook = localStorage.getItem('discordWebhook');
            if (oldWebhook && discordWebhooks.length === 0) {
                discordWebhooks.push({
                    id: 'migrated-' + Date.now(),
                    label: 'Main Webhook',
                    url: oldWebhook,
                    forWins: true,
                    forAlerts: true,
                    forReports: true,
                    forApplications: true,
                    brand: 'all'
                });
                localStorage.setItem('discordWebhooks', JSON.stringify(discordWebhooks));
            }
            
            // Load notification log
            notificationLog = JSON.parse(localStorage.getItem('notificationLog') || '[]');
            
            renderWebhooksList();
            renderNotificationLog();
        }
        
        function renderWebhooksList() {
            const container = document.getElementById('discordWebhooksList');
            const noWebhooksMsg = document.getElementById('noWebhooksMessage');
            
            if (!container) return;
            
            if (discordWebhooks.length === 0) {
                container.innerHTML = '';
                if (noWebhooksMsg) noWebhooksMsg.style.display = 'block';
                return;
            }
            
            if (noWebhooksMsg) noWebhooksMsg.style.display = 'none';
            
            container.innerHTML = discordWebhooks.map(w => {
                const tags = [];
                if (w.forWins) tags.push(' Wins');
                if (w.forAlerts) tags.push(' Alerts');
                if (w.forReports) tags.push(' Reports');
                if (w.forApplications) tags.push(' Apps');
                
                const brandTag = w.brand !== 'all' ? `<span style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; margin-left: 6px;">${BRAND_DISPLAY[w.brand] || w.brand}</span>` : '';
                
                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                        <div style="width: 36px; height: 36px; background: #5865F2; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.36-.698.772-1.362 1.225-1.993a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128c.12-.094.246-.194.373-.292a.074.074 0 0 1 .078-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.3 12.3 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.84 19.84 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.06.06 0 0 0-.031-.03z"/></svg>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; display: flex; align-items: center;">${sanitize(w.label)}${brandTag}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">${tags.join('  ') || 'No events selected'}</div>
                        </div>
                        <button class="btn btn-sm" onclick="editWebhook('${w.id}')" style="padding: 6px 10px;">Edit</button>
                        <button class="btn btn-sm" onclick="deleteWebhook('${w.id}')" style="padding: 6px 10px; color: var(--error);"></button>
                    </div>
                `;
            }).join('');
        }
        
        function openAddWebhookModal() {
            document.getElementById('webhookModalTitle').textContent = 'Add Discord Webhook';
            document.getElementById('webhookId').value = '';
            document.getElementById('webhookLabel').value = '';
            document.getElementById('webhookUrl').value = '';
            document.getElementById('webhookForWins').checked = true;
            document.getElementById('webhookForAlerts').checked = true;
            document.getElementById('webhookForReports').checked = false;
            document.getElementById('webhookForApplications').checked = false;
            document.getElementById('webhookBrand').value = 'all';
            document.getElementById('webhookModal').classList.add('show');
        }
        
        function editWebhook(id) {
            const webhook = discordWebhooks.find(w => w.id === id);
            if (!webhook) return;
            
            document.getElementById('webhookModalTitle').textContent = 'Edit Discord Webhook';
            document.getElementById('webhookId').value = webhook.id;
            document.getElementById('webhookLabel').value = webhook.label;
            document.getElementById('webhookUrl').value = webhook.url;
            document.getElementById('webhookForWins').checked = webhook.forWins;
            document.getElementById('webhookForAlerts').checked = webhook.forAlerts;
            document.getElementById('webhookForReports').checked = webhook.forReports;
            document.getElementById('webhookForApplications').checked = webhook.forApplications;
            document.getElementById('webhookBrand').value = webhook.brand || 'all';
            document.getElementById('webhookModal').classList.add('show');
        }
        
        function closeWebhookModal() {
            document.getElementById('webhookModal').classList.remove('show');
        }
        
        function saveWebhook() {
            const id = document.getElementById('webhookId').value || 'webhook-' + Date.now();
            const label = document.getElementById('webhookLabel').value.trim();
            const url = document.getElementById('webhookUrl').value.trim();
            
            if (!label || !url) {
                showToast('Please fill in label and URL', 'error');
                return;
            }
            
            if (!url.startsWith('https://discord.com/api/webhooks/')) {
                showToast('Invalid Discord webhook URL', 'error');
                return;
            }
            
            const webhookData = {
                id,
                label,
                url,
                forWins: document.getElementById('webhookForWins').checked,
                forAlerts: document.getElementById('webhookForAlerts').checked,
                forReports: document.getElementById('webhookForReports').checked,
                forApplications: document.getElementById('webhookForApplications').checked,
                brand: document.getElementById('webhookBrand').value
            };
            
            const existingIndex = discordWebhooks.findIndex(w => w.id === id);
            if (existingIndex >= 0) {
                discordWebhooks[existingIndex] = webhookData;
            } else {
                discordWebhooks.push(webhookData);
            }
            
            localStorage.setItem('discordWebhooks', JSON.stringify(discordWebhooks));
            showToast('Webhook saved!', 'success');
            closeWebhookModal();
            renderWebhooksList();
            renderDiscordRoutingTable();
        }
        
        function deleteWebhook(id) {
            if (!confirm('Delete this webhook?')) return;
            discordWebhooks = discordWebhooks.filter(w => w.id !== id);
            localStorage.setItem('discordWebhooks', JSON.stringify(discordWebhooks));
            showToast('Webhook deleted', 'success');
            renderWebhooksList();
            renderDiscordRoutingTable();
        }
        
        async function testWebhook() {
            const url = document.getElementById('webhookUrl').value.trim();
            const label = document.getElementById('webhookLabel').value.trim() || 'Test';
            
            if (!url) {
                showToast('Enter a webhook URL first', 'error');
                return;
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [{
                            title: ' Test Connection',
                            description: `Webhook "${label}" is working!\nCreators Corner is connected.`,
                            color: 5763719,
                            footer: { text: 'Creators Corner Dashboard' },
                            timestamp: new Date().toISOString()
                        }]
                    })
                });
                
                if (response.ok) {
                    showToast('Test message sent! Check Discord.', 'success');
                } else {
                    showToast('Failed to send - check webhook URL', 'error');
                }
            } catch (err) {
                showToast('Error connecting to Discord', 'error');
            }
        }
        
        function renderDiscordRoutingTable() {
            const container = document.getElementById('discordRoutingTable');
            const statusEl = document.getElementById('discordRoutingStatus');
            
            if (!container) return;
            
            if (discordWebhooks.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 8px;">
                    Add webhooks in <a href="#" onclick="switchSettingsTab('integrations'); return false;" style="color: var(--accent);">Integrations</a> to configure Discord routing
                </div>`;
                if (statusEl) statusEl.textContent = 'No webhooks configured';
                return;
            }
            
            if (statusEl) statusEl.textContent = `${discordWebhooks.length} webhook${discordWebhooks.length > 1 ? 's' : ''} configured`;
            
            const events = [
                { key: 'forWins', emoji: '', label: 'Wins & Milestones' },
                { key: 'forAlerts', emoji: '', label: 'Alerts & Issues' },
                { key: 'forReports', emoji: '', label: 'Weekly Reports' },
                { key: 'forApplications', emoji: '', label: 'New Applications' }
            ];
            
            container.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    ${events.map(e => {
                        const webhooksForEvent = discordWebhooks.filter(w => w[e.key]);
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="font-size: 1.1rem;">${e.emoji}</span>
                                <span style="flex: 1; font-size: 0.9rem;">${e.label}</span>
                                <div style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end;">
                                    ${webhooksForEvent.length > 0 
                                        ? webhooksForEvent.map(w => `<span style="background: #5865F2; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">${sanitize(w.label)}</span>`).join('')
                                        : '<span style="color: var(--text-muted); font-size: 0.75rem;">Not configured</span>'
                                    }
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // ==================== NOTIFICATION TRIGGERS ====================
        async function sendToWebhooks(eventType, embed, brand = 'all') {
            const webhooksToUse = discordWebhooks.filter(w => {
                if (!w[eventType]) return false;
                if (w.brand !== 'all' && brand !== 'all' && w.brand !== brand) return false;
                return true;
            });
            
            if (webhooksToUse.length === 0) {
                console.log(`No webhooks configured for ${eventType}`);
                return false;
            }
            
            let success = 0;
            for (const webhook of webhooksToUse) {
                try {
                    const response = await fetch(webhook.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ embeds: [embed] })
                    });
                    if (response.ok) success++;
                } catch (err) {
                    console.error(`Error sending to ${webhook.label}:`, err);
                }
            }
            
            // Log the notification
            logNotification(eventType, embed.title, webhooksToUse.map(w => w.label));
            
            return success > 0;
        }
        
        function logNotification(eventType, title, channels) {
            notificationLog.unshift({
                timestamp: new Date().toISOString(),
                eventType,
                title,
                channels
            });
            
            // Keep only last 50
            if (notificationLog.length > 50) {
                notificationLog = notificationLog.slice(0, 50);
            }
            
            localStorage.setItem('notificationLog', JSON.stringify(notificationLog));
            renderNotificationLog();
        }
        
        function renderNotificationLog() {
            const container = document.getElementById('notificationLog');
            if (!container) return;
            
            if (notificationLog.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-muted);">No notifications sent yet</div>';
                return;
            }
            
            container.innerHTML = notificationLog.map(n => {
                const time = new Date(n.timestamp).toLocaleString();
                const emoji = n.eventType === 'forWins' ? '' : n.eventType === 'forAlerts' ? '' : n.eventType === 'forReports' ? '' : '';
                
                return `
                    <div style="display: flex; gap: 10px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.85rem;">
                        <span>${emoji}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500;">${sanitize(n.title || 'Notification')}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);"> ${n.channels.join(', ')}</div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); white-space: nowrap;">${time}</div>
                    </div>
                `;
            }).join('');
        }
        
        function clearNotificationLog() {
            if (!confirm('Clear notification log?')) return;
            notificationLog = [];
            localStorage.setItem('notificationLog', JSON.stringify(notificationLog));
            renderNotificationLog();
            showToast('Log cleared', 'success');
        }
        
        async function triggerWinsNotification() {
            showToast('Generating wins notification...', 'info');
            
            // Get today's top performers from creator_performance
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            
            try {
                const { data, error } = await supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv')
                    .eq('report_date', dateStr)
                    .order('gmv', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    showToast('No performance data for yesterday', 'warning');
                    return;
                }
                
                const topCreators = data.filter(c => c.gmv > 0);
                if (topCreators.length === 0) {
                    showToast('No GMV recorded yesterday', 'warning');
                    return;
                }
                
                const fields = topCreators.slice(0, 3).map((c, i) => ({
                    name: `${['', '', ''][i]} ${c.creator_name}`,
                    value: `$${Math.round(c.gmv).toLocaleString()}  ${BRAND_DISPLAY[c.brand] || c.brand}`,
                    inline: false
                }));
                
                const embed = {
                    title: ' Daily Top Performers',
                    description: `Top creators for ${new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}`,
                    fields,
                    color: 16766720,
                    footer: { text: 'Creators Corner  Daily Wins' },
                    timestamp: new Date().toISOString()
                };
                
                const sent = await sendToWebhooks('forWins', embed);
                if (sent) {
                    showToast('Wins notification sent!', 'success');
                } else {
                    showToast('No webhooks configured for Wins', 'warning');
                }
                
            } catch (err) {
                console.error('Error triggering wins:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        async function triggerAlertsNotification() {
            showToast('Checking for alerts...', 'info');
            
            // This would check for ghost creators, underperformers, etc.
            // For now, send a summary based on posting data
            try {
                // Get ghost creators (no posts in 5+ days) from managed_creators
                // This is a simplified version
                
                const embed = {
                    title: ' Creator Alerts',
                    description: 'Daily alert summary',
                    fields: [
                        { name: ' Ghost Creators', value: 'Check Posting tab for details', inline: true },
                        { name: ' Attention Needed', value: 'Check Creators tab', inline: true }
                    ],
                    color: 16744576,
                    footer: { text: 'Creators Corner  Alerts' },
                    timestamp: new Date().toISOString()
                };
                
                const sent = await sendToWebhooks('forAlerts', embed);
                if (sent) {
                    showToast('Alerts notification sent!', 'success');
                } else {
                    showToast('No webhooks configured for Alerts', 'warning');
                }
                
            } catch (err) {
                console.error('Error triggering alerts:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        async function triggerWeeklyReport() {
            showToast('Generating weekly report...', 'info');
            
            // Calculate last 7 days
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);
            
            try {
                const { data, error } = await supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv')
                    .gte('report_date', startDate.toISOString().split('T')[0])
                    .lte('report_date', endDate.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                // Aggregate
                const totals = { gmv: 0 };
                const byBrand = {};
                
                (data || []).forEach(row => {
                    totals.gmv += parseFloat(row.gmv) || 0;
                    if (!byBrand[row.brand]) byBrand[row.brand] = 0;
                    byBrand[row.brand] += parseFloat(row.gmv) || 0;
                });
                
                const brandFields = Object.entries(byBrand)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([brand, gmv]) => ({
                        name: BRAND_DISPLAY[brand] || brand,
                        value: `$${Math.round(gmv).toLocaleString()}`,
                        inline: true
                    }));
                
                const embed = {
                    title: ' Weekly Performance Report',
                    description: `**${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}**\n\n **Total GMV: $${Math.round(totals.gmv).toLocaleString()}**`,
                    fields: brandFields,
                    color: 5763719,
                    footer: { text: 'Creators Corner  Weekly Report' },
                    timestamp: new Date().toISOString()
                };
                
                const sent = await sendToWebhooks('forReports', embed);
                if (sent) {
                    showToast('Weekly report sent!', 'success');
                } else {
                    showToast('No webhooks configured for Reports', 'warning');
                }
                
            } catch (err) {
                console.error('Error triggering weekly report:', err);
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        // ==================== WEEKLY REPORTS ====================
        async function generateWeeklyReport() {
            const period = document.getElementById('reportPeriod').value;
            const type = document.getElementById('reportType').value;
            const brand = document.getElementById('reportBrand').value;
            
            const includeGmv = document.getElementById('reportIncludeGmv').checked;
            const includeCreators = document.getElementById('reportIncludeCreators').checked;
            const includeVideos = document.getElementById('reportIncludeVideos').checked;
            const includeProducts = document.getElementById('reportIncludeProducts').checked;
            const includeTrends = document.getElementById('reportIncludeTrends').checked;
            
            showToast('Generating report...', 'info');
            
            // Calculate date range
            const now = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'last7':
                    endDate = new Date(now);
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'lastWeek':
                    const lastMonday = new Date(now);
                    lastMonday.setDate(lastMonday.getDate() - lastMonday.getDay() - 6);
                    const lastSunday = new Date(lastMonday);
                    lastSunday.setDate(lastSunday.getDate() + 6);
                    startDate = lastMonday;
                    endDate = lastSunday;
                    break;
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now);
                    break;
                case 'lastMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
            }
            
            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];
            
            try {
                // Fetch performance data
                let query = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv, items_sold, video_views')
                    .gte('report_date', startStr)
                    .lte('report_date', endStr);
                
                if (brand !== 'all') {
                    query = query.eq('brand', brand);
                }
                
                const { data: perfData, error } = await query;
                if (error) throw error;
                
                // Aggregate data
                const totals = { gmv: 0, items: 0, views: 0 };
                const byBrand = {};
                const byCreator = {};
                
                perfData?.forEach(row => {
                    totals.gmv += parseFloat(row.gmv) || 0;
                    totals.items += parseInt(row.items_sold) || 0;
                    totals.views += parseInt(row.video_views) || 0;
                    
                    // By brand
                    if (!byBrand[row.brand]) {
                        byBrand[row.brand] = { gmv: 0, items: 0, views: 0 };
                    }
                    byBrand[row.brand].gmv += parseFloat(row.gmv) || 0;
                    byBrand[row.brand].items += parseInt(row.items_sold) || 0;
                    byBrand[row.brand].views += parseInt(row.video_views) || 0;
                    
                    // By creator
                    if (!byCreator[row.creator_name]) {
                        byCreator[row.creator_name] = { gmv: 0, items: 0, brand: row.brand };
                    }
                    byCreator[row.creator_name].gmv += parseFloat(row.gmv) || 0;
                    byCreator[row.creator_name].items += parseInt(row.items_sold) || 0;
                });
                
                // Sort creators by GMV
                const topCreators = Object.entries(byCreator)
                    .sort((a, b) => b[1].gmv - a[1].gmv)
                    .slice(0, 10);
                
                // Build report
                let report = ` WEEKLY PERFORMANCE REPORT\n`;
                report += `\n`;
                report += ` Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}\n`;
                report += ` Brand: ${brand === 'all' ? 'All Brands' : BRAND_DISPLAY[brand] || brand}\n\n`;
                
                if (includeGmv) {
                    report += ` REVENUE SUMMARY\n`;
                    report += `\n`;
                    report += `Total GMV:    ${fmtMoney(totals.gmv)}\n`;
                    report += `Items Sold:   ${fmtNum(totals.items)}\n`;
                    report += `Video Views:  ${fmtNum(totals.views)}\n\n`;
                    
                    if (brand === 'all') {
                        report += ` BY BRAND\n`;
                        report += `\n`;
                        Object.entries(byBrand)
                            .sort((a, b) => b[1].gmv - a[1].gmv)
                            .forEach(([b, d]) => {
                                report += `${BRAND_DISPLAY[b] || b}: ${fmtMoney(d.gmv)}\n`;
                            });
                        report += `\n`;
                    }
                }
                
                if (includeCreators) {
                    report += ` TOP CREATORS\n`;
                    report += `\n`;
                    topCreators.forEach(([name, data], i) => {
                        const medal = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : `${i + 1}.`;
                        report += `${medal} ${name}: ${fmtMoney(data.gmv)}\n`;
                    });
                    report += `\n`;
                }
                
                report += `\n`;
                report += `Generated by Creators Corner Dashboard\n`;
                report += `${new Date().toLocaleString()}\n`;
                
                // Display report
                document.getElementById('reportPreview').style.display = 'block';
                document.getElementById('reportContent').textContent = report;
                
                showToast('Report generated!', 'success');
                
            } catch (err) {
                console.error('Error generating report:', err);
                showToast('Error generating report', 'error');
            }
        }
        
        function copyReportToClipboard() {
            const report = document.getElementById('reportContent').textContent;
            navigator.clipboard.writeText(report).then(() => {
                showToast('Report copied to clipboard!', 'success');
            });
        }
        
        // ==================== SHAREABLE REPORTS ====================
        let reportHistory = [];
        
        function initReportsTab() {
            reportHistory = JSON.parse(localStorage.getItem('reportHistory') || '[]');
            renderReportHistory();
            
            // Setup period change listener
            const periodSelect = document.getElementById('quickReportPeriod');
            if (periodSelect) {
                periodSelect.addEventListener('change', function() {
                    const customRange = document.getElementById('customDateRange');
                    if (customRange) {
                        customRange.style.display = this.value === 'custom' ? 'block' : 'none';
                    }
                });
            }
        }
        
        function getReportDateRange() {
            const period = document.getElementById('quickReportPeriod')?.value || 'last7';
            const now = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'last7':
                    endDate = new Date(now);
                    endDate.setDate(endDate.getDate() - 1);
                    startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - 6);
                    break;
                case 'lastWeek':
                    // Find last Sunday
                    const lastSunday = new Date(now);
                    lastSunday.setDate(lastSunday.getDate() - lastSunday.getDay());
                    if (lastSunday >= now) lastSunday.setDate(lastSunday.getDate() - 7);
                    endDate = new Date(lastSunday);
                    startDate = new Date(lastSunday);
                    startDate.setDate(startDate.getDate() - 6);
                    break;
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now);
                    endDate.setDate(endDate.getDate() - 1);
                    break;
                case 'lastMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'custom':
                    const startInput = document.getElementById('quickReportStart')?.value;
                    const endInput = document.getElementById('quickReportEnd')?.value;
                    if (startInput && endInput) {
                        startDate = new Date(startInput);
                        endDate = new Date(endInput);
                    } else {
                        endDate = new Date(now);
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 7);
                    }
                    break;
                default:
                    endDate = new Date(now);
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 7);
            }
            
            return {
                start: startDate.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        }
        
        function openShareableReport(brand) {
            const { start, end } = getReportDateRange();
            const url = `report.html?brand=${brand}&start=${start}&end=${end}`;
            
            // Add to history
            const brandName = brand === 'all' ? 'All Brands' : (BRAND_DISPLAY[brand] || brand);
            const historyItem = {
                brand,
                brandName,
                start,
                end,
                url,
                createdAt: new Date().toISOString()
            };
            
            reportHistory.unshift(historyItem);
            if (reportHistory.length > 20) reportHistory = reportHistory.slice(0, 20);
            localStorage.setItem('reportHistory', JSON.stringify(reportHistory));
            renderReportHistory();
            
            // Open in new tab
            window.open(url, '_blank');
            showToast(`${brandName} report opened in new tab`, 'success');
        }
        
        function renderReportHistory() {
            const container = document.getElementById('recentReportsList');
            if (!container) return;
            
            if (reportHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted); background: var(--bg-secondary); border-radius: 8px;">
                        No reports generated yet. Click a brand above to create one.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    ${reportHistory.slice(0, 10).map(r => {
                        const dateRange = `${formatDateShort(r.start)} - ${formatDateShort(r.end)}`;
                        const createdTime = new Date(r.createdAt).toLocaleString();
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${sanitize(r.brandName)}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${dateRange}</div>
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${createdTime}</div>
                                <button class="btn btn-sm" onclick="window.open('${r.url}', '_blank')" style="padding: 6px 12px;">Open</button>
                                <button class="btn btn-sm" onclick="copyReportUrl('${r.url}')" style="padding: 6px 12px;"></button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function formatDateShort(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function copyReportUrl(url) {
            const fullUrl = window.location.origin + '/' + url;
            navigator.clipboard.writeText(fullUrl).then(() => {
                showToast('Report link copied!', 'success');
            });
        }
        
        function clearReportHistory() {
            if (!confirm('Clear report history?')) return;
            reportHistory = [];
            localStorage.setItem('reportHistory', JSON.stringify(reportHistory));
            renderReportHistory();
            showToast('History cleared', 'success');
        }
        
        // Initialize reports tab when settings loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initReportsTab, 500);
        });
        
        // ==================== LEGACY TEXT REPORTS ====================
        async function sendReportToDiscord() {
            // Use the new webhook system
            const webhooks = JSON.parse(localStorage.getItem('discordWebhooks') || '[]');
            const reportWebhooks = webhooks.filter(w => w.forReports);
            
            if (reportWebhooks.length === 0) {
                // Fall back to old single webhook
                const webhook = localStorage.getItem('discordWebhook');
                if (!webhook) {
                    showToast('No Discord webhooks configured for Reports', 'error');
                    return;
                }
                reportWebhooks.push({ url: webhook, label: 'Main' });
            }
            
            const report = document.getElementById('reportContent').textContent;
            
            let sent = 0;
            for (const webhook of reportWebhooks) {
                try {
                    const response = await fetch(webhook.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content: '```\n' + report.substring(0, 1900) + '\n```'
                        })
                    });
                    if (response.ok) sent++;
                } catch (err) {
                    console.error('Error sending to Discord:', err);
                }
            }
            
            if (sent > 0) {
                showToast(`Report sent to ${sent} Discord channel(s)!`, 'success');
            } else {
                showToast('Failed to send report', 'error');
            }
        }
        
        function saveReportSettings() {
            const settings = {
                autoSendDiscord: document.getElementById('autoSendDiscord').checked,
                autoSendEmail: document.getElementById('autoSendEmail').checked,
                scheduleWeekly: document.getElementById('scheduleWeekly').checked
            };
            localStorage.setItem('reportSettings', JSON.stringify(settings));
            showToast('Report settings saved', 'success');
        }
        
        function loadReportSettings() {
            const settings = JSON.parse(localStorage.getItem('reportSettings') || '{}');
            if (document.getElementById('autoSendDiscord')) {
                document.getElementById('autoSendDiscord').checked = settings.autoSendDiscord || false;
                document.getElementById('autoSendEmail').checked = settings.autoSendEmail || false;
                document.getElementById('scheduleWeekly').checked = settings.scheduleWeekly || false;
            }
        }
        
        function saveDiscordWebhook() {
            const webhook = document.getElementById('discordWebhook').value.trim();
            if (webhook && !webhook.startsWith('https://discord.com/api/webhooks/')) {
                showToast('Invalid webhook URL', 'error');
                return;
            }
            localStorage.setItem('discordWebhook', webhook);
            showToast('Webhook saved!', 'success');
            document.getElementById('discordStatus').innerHTML = webhook ? '<span style="color: var(--success);"> Webhook configured</span>' : '';
            updateIntegrationQuickStatus('discord', !!webhook);
        }
        
        async function testDiscordWebhook() {
            const webhook = localStorage.getItem('discordWebhook');
            if (!webhook) {
                showToast('Please save a webhook URL first', 'error');
                return;
            }
            
            const testMessage = {
                embeds: [{
                    title: ' Test Connection',
                    description: 'Your Discord webhook is working! Creators Corner is connected.',
                    color: 16111923, // Yellow
                    footer: { text: 'Creators Corner Dashboard' },
                    timestamp: new Date().toISOString()
                }]
            };
            
            try {
                const response = await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testMessage)
                });
                
                if (response.ok) {
                    showToast('Test message sent! Check your Discord.', 'success');
                } else {
                    showToast('Failed to send test message', 'error');
                }
            } catch (error) {
                showToast('Error connecting to Discord', 'error');
                console.error('Discord webhook error:', error);
            }
        }
        
        // Application Page Settings
        function saveApplicationSettings() {
            const settings = {
                welcomeVideoUrl: document.getElementById('welcomeVideoUrl').value.trim(),
                thankYouVideoUrl: document.getElementById('thankYouVideoUrl').value.trim(),
                discordClientId: document.getElementById('discordClientId').value.trim()
            };
            
            localStorage.setItem('applicationSettings', JSON.stringify(settings));
            showToast('Application settings saved!', 'success');
            
            const statusEl = document.getElementById('applicationSettingsStatus');
            statusEl.innerHTML = '<div style="color: var(--success); font-size: 0.9rem;"> Settings saved. Changes will appear on the application page.</div>';
        }
        
        function loadApplicationSettings() {
            const settings = JSON.parse(localStorage.getItem('applicationSettings') || '{}');
            
            if (document.getElementById('welcomeVideoUrl')) {
                document.getElementById('welcomeVideoUrl').value = settings.welcomeVideoUrl || '';
            }
            if (document.getElementById('thankYouVideoUrl')) {
                document.getElementById('thankYouVideoUrl').value = settings.thankYouVideoUrl || '';
            }
            if (document.getElementById('discordClientId')) {
                document.getElementById('discordClientId').value = settings.discordClientId || '';
            }
        }
        
        function previewApplicationPage() {
            window.open('apply.html', '_blank');
        }
        
        async function sendToDiscord(embed) {
            const webhook = localStorage.getItem('discordWebhook');
            if (!webhook) return false;
            
            try {
                const response = await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ embeds: [embed] })
                });
                return response.ok;
            } catch (error) {
                console.error('Discord send error:', error);
                return false;
            }
        }
        
        function sendWinToDiscord(creatorName, brand, gmv, reason) {
            const settings = JSON.parse(localStorage.getItem('discordNotifySettings') || '{}');
            if (settings.dailyWins === false) return;
            
            sendToDiscord({
                title: ' Daily Win!',
                description: `**${creatorName}** (${BRAND_DISPLAY[brand] || brand})`,
                fields: [
                    { name: ' GMV', value: fmtMoney(gmv), inline: true },
                    { name: ' Achievement', value: reason, inline: true }
                ],
                color: 16766720, // Gold
                footer: { text: 'Creators Corner  Daily Ops' },
                timestamp: new Date().toISOString()
            });
        }
        
        function sendWeeklyWinnerToDiscord(creatorName, brand, gmv, rank) {
            const settings = JSON.parse(localStorage.getItem('discordNotifySettings') || '{}');
            if (settings.weeklyWinners === false) return;
            
            const medals = ['', '', ''];
            sendToDiscord({
                title: `${medals[rank - 1] || ''} Weekly Winner #${rank}`,
                description: `**${creatorName}** (${BRAND_DISPLAY[brand] || brand})`,
                fields: [
                    { name: ' Weekly GMV', value: fmtMoney(gmv), inline: true }
                ],
                color: rank === 1 ? 16766720 : rank === 2 ? 12632256 : 13467442,
                footer: { text: 'Creators Corner  Weekly Ops' },
                timestamp: new Date().toISOString()
            });
        }
        
        function sendAttentionToDiscord(creatorName, brand, issue) {
            const settings = JSON.parse(localStorage.getItem('discordNotifySettings') || '{}');
            if (settings.attention === false) return;
            
            sendToDiscord({
                title: ' Creator Attention Needed',
                description: `**${creatorName}** (${BRAND_DISPLAY[brand] || brand})`,
                fields: [
                    { name: ' Issue', value: issue, inline: false }
                ],
                color: 16744576, // Orange/Red
                footer: { text: 'Creators Corner  Alert' },
                timestamp: new Date().toISOString()
            });
        }

        // ==================== EMAIL/SMS INTEGRATION ====================
        function loadEmailSmsSettings() {
            const emailSettings = JSON.parse(localStorage.getItem('emailSettings') || '{}');
            const smsSettings = JSON.parse(localStorage.getItem('smsSettings') || '{}');
            const sheetsSettings = JSON.parse(localStorage.getItem('sheetsSettings') || '{}');
            const notifySettings = JSON.parse(localStorage.getItem('notifyChannels') || '{}');
            const webhook = localStorage.getItem('discordWebhook') || '';
            
            // Email
            document.getElementById('resendApiKey').value = emailSettings.apiKey || '';
            document.getElementById('resendFromEmail').value = emailSettings.fromEmail || '';
            if (emailSettings.apiKey) {
                document.getElementById('emailStatus').innerHTML = '<span style="color: var(--success);"> Email configured</span>';
            }
            
            // SMS
            document.getElementById('twilioSid').value = smsSettings.sid || '';
            document.getElementById('twilioToken').value = smsSettings.token || '';
            document.getElementById('twilioPhone').value = smsSettings.phone || '';
            if (smsSettings.sid) {
                document.getElementById('smsStatus').innerHTML = '<span style="color: var(--success);"> SMS configured</span>';
            }
            
            // Google Sheets
            document.getElementById('googleSheetId').value = sheetsSettings.sheetId || '';
            document.getElementById('googleServiceEmail').value = sheetsSettings.serviceEmail || '';
            if (sheetsSettings.sheetId) {
                document.getElementById('sheetsStatus').innerHTML = '<span style="color: var(--success);"> Sheets configured</span>';
            }
            
            // Channel preferences
            document.getElementById('emailDailyWins').checked = notifySettings.emailDailyWins || false;
            document.getElementById('smsDailyWins').checked = notifySettings.smsDailyWins || false;
            document.getElementById('emailWeeklySummary').checked = notifySettings.emailWeeklySummary !== false;
            document.getElementById('smsWeeklySummary').checked = notifySettings.smsWeeklySummary || false;
            document.getElementById('emailAttention').checked = notifySettings.emailAttention !== false;
            document.getElementById('smsAttention').checked = notifySettings.smsAttention !== false;
            document.getElementById('emailGoals').checked = notifySettings.emailGoals || false;
            document.getElementById('smsGoals').checked = notifySettings.smsGoals || false;
            document.getElementById('notifyGoals').checked = notifySettings.discordGoals || false;
            
            // Update quick status indicators
            updateIntegrationQuickStatus('discord', !!webhook);
            updateIntegrationQuickStatus('email', !!emailSettings.apiKey);
            updateIntegrationQuickStatus('sms', !!smsSettings.sid);
            updateIntegrationQuickStatus('sheets', !!sheetsSettings.sheetId);
            
            // Load subscribers
            loadSubscribers();
        }
        
        function updateIntegrationQuickStatus(type, isConnected) {
            const badgeEl = document.getElementById(`${type}StatusBadge`);
            
            if (badgeEl) {
                badgeEl.textContent = isConnected ? 'Connected' : 'Not connected';
                badgeEl.style.background = isConnected ? 'rgba(34, 197, 94, 0.2)' : 'var(--bg-secondary)';
                badgeEl.style.color = isConnected ? '#22c55e' : 'var(--text-muted)';
            }
        }
        
        function saveEmailSettings() {
            const apiKey = document.getElementById('resendApiKey').value.trim();
            const fromEmail = document.getElementById('resendFromEmail').value.trim();
            
            // Validation
            if (apiKey && !apiKey.startsWith('re_')) {
                showToast('Invalid Resend API key format (should start with "re_")', 'error');
                return;
            }
            
            if (fromEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(fromEmail)) {
                showToast('Invalid email address format', 'error');
                return;
            }
            
            const settings = { apiKey, fromEmail };
            localStorage.setItem('emailSettings', JSON.stringify(settings));
            showToast('Email settings saved!', 'success');
            document.getElementById('emailStatus').innerHTML = settings.apiKey ? '<span style="color: var(--success);"> Email configured</span>' : '';
            updateIntegrationQuickStatus('email', !!settings.apiKey);
        }
        
        function saveSmsSettings() {
            const sid = document.getElementById('twilioSid').value.trim();
            const token = document.getElementById('twilioToken').value.trim();
            const phone = document.getElementById('twilioPhone').value.trim();
            
            // Validation
            if (sid && !sid.startsWith('AC')) {
                showToast('Invalid Twilio SID format (should start with "AC")', 'error');
                return;
            }
            
            if (phone && !/^\+[1-9]\d{1,14}$/.test(phone)) {
                showToast('Invalid phone number format. Use E.164 format (e.g., +15551234567)', 'error');
                return;
            }
            
            const settings = { sid, token, phone };
            localStorage.setItem('smsSettings', JSON.stringify(settings));
            showToast('SMS settings saved!', 'success');
            document.getElementById('smsStatus').innerHTML = settings.sid ? '<span style="color: var(--success);"> SMS configured</span>' : '';
            updateIntegrationQuickStatus('sms', !!settings.sid);
        }
        
        function saveSheetsSettings() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const serviceEmail = document.getElementById('googleServiceEmail').value.trim();
            
            // Basic validation
            if (sheetId && sheetId.length < 20) {
                showToast('Invalid Google Sheet ID (should be longer)', 'error');
                return;
            }
            
            if (serviceEmail && !serviceEmail.includes('@') && !serviceEmail.includes('.iam.gserviceaccount.com')) {
                showToast('Invalid service account email format', 'warning');
            }
            
            const settings = { sheetId, serviceEmail };
            localStorage.setItem('sheetsSettings', JSON.stringify(settings));
            showToast('Google Sheets settings saved!', 'success');
            document.getElementById('sheetsStatus').innerHTML = settings.sheetId ? '<span style="color: var(--success);"> Sheets configured</span>' : '';
            updateIntegrationQuickStatus('sheets', !!settings.sheetId);
        }
        
        function testSheetsConnection() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            
            if (!sheetId) {
                showToast('Please enter a Sheet ID first', 'warning');
                return;
            }
            
            // Open the sheet in a new tab to verify it exists
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
            window.open(url, '_blank');
            
            document.getElementById('sheetsStatus').innerHTML = '<span style="color: var(--accent);"> Opened sheet in new tab - verify access</span>';
            showToast('Sheet opened in new tab. Verify you have edit access.', 'info');
        }
        
        function saveNotificationSettings() {
            // Discord settings
            const discordSettings = {
                dailyWins: document.getElementById('notifyDailyWins').checked,
                weeklyWinners: document.getElementById('notifyWeeklyWinners').checked,
                attention: document.getElementById('notifyAttention').checked
            };
            localStorage.setItem('discordNotifySettings', JSON.stringify(discordSettings));
            
            // Channel preferences
            const channelSettings = {
                emailDailyWins: document.getElementById('emailDailyWins').checked,
                smsDailyWins: document.getElementById('smsDailyWins').checked,
                emailWeeklySummary: document.getElementById('emailWeeklySummary').checked,
                smsWeeklySummary: document.getElementById('smsWeeklySummary').checked,
                emailAttention: document.getElementById('emailAttention').checked,
                smsAttention: document.getElementById('smsAttention').checked,
                emailGoals: document.getElementById('emailGoals').checked,
                smsGoals: document.getElementById('smsGoals').checked,
                discordGoals: document.getElementById('notifyGoals').checked
            };
            localStorage.setItem('notifyChannels', JSON.stringify(channelSettings));
            
            showToast('Notification preferences saved!', 'success');
        }
        
        async function testEmailAlert() {
            const emailSettings = JSON.parse(localStorage.getItem('emailSettings') || '{}');
            if (!emailSettings.apiKey || !emailSettings.fromEmail) {
                showToast('Please save email settings first', 'error');
                return;
            }
            
            const testEmail = prompt('Enter your email address to receive test:');
            if (!testEmail) return;
            
            showToast('Sending test email...', 'info');
            
            // Note: In production, this would call your Supabase Edge Function
            // For now, we'll show how to call it
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-alert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        type: 'email',
                        to: testEmail,
                        subject: ' Test Email from Creators Corner',
                        html: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                <h1 style="color: #f5c518;"> Email Connected!</h1>
                                <p>Your Creators Corner email alerts are working correctly.</p>
                                <p>You'll receive notifications about:</p>
                                <ul>
                                    <li> Daily Wins</li>
                                    <li> Weekly Summaries</li>
                                    <li> Attention Alerts</li>
                                </ul>
                                <hr style="border: 1px solid #eee;">
                                <p style="color: #666; font-size: 12px;">Creators Corner Dashboard</p>
                            </div>
                        `,
                        alertType: 'test'
                    })
                });
                
                if (response.ok) {
                    showToast('Test email sent! Check your inbox.', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to send test email', 'error');
                }
            } catch (error) {
                console.error('Email test error:', error);
                showToast('Error: Edge function not deployed. See setup instructions.', 'error');
            }
        }
        
        async function testSmsAlert() {
            const smsSettings = JSON.parse(localStorage.getItem('smsSettings') || '{}');
            if (!smsSettings.sid || !smsSettings.token || !smsSettings.phone) {
                showToast('Please save SMS settings first', 'error');
                return;
            }
            
            const testPhone = prompt('Enter phone number to receive test (with country code, e.g. +1234567890):');
            if (!testPhone) return;
            
            showToast('Sending test SMS...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-alert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        type: 'sms',
                        to: testPhone,
                        message: ' Creators Corner SMS alerts connected! You\'ll receive notifications for wins and alerts.',
                        alertType: 'test'
                    })
                });
                
                if (response.ok) {
                    showToast('Test SMS sent! Check your phone.', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to send test SMS', 'error');
                }
            } catch (error) {
                console.error('SMS test error:', error);
                showToast('Error: Edge function not deployed. See setup instructions.', 'error');
            }
        }

        // ==================== SUBSCRIBER MANAGEMENT ====================
        async function loadSubscribers() {
            const { data, error } = await supabaseClient
                .from('alert_subscribers')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.log('Subscribers table not found - run setup SQL first');
                document.getElementById('subscribersTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 20px;">
                            <p>Subscriber table not set up yet.</p>
                            <small>Run the <code>supabase_alerts_setup.sql</code> script in your Supabase SQL Editor.</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (!data || data.length === 0) {
                document.getElementById('subscribersTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 20px;">
                            No subscribers yet. Click "Add Subscriber" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            document.getElementById('subscribersTable').innerHTML = data.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.email || '-'}</td>
                    <td>${s.phone || '-'}</td>
                    <td>${s.brand ? BRAND_DISPLAY[s.brand] || s.brand : 'All'}</td>
                    <td>
                        <span class="badge ${s.is_active ? 'badge-managed' : 'badge-unmanaged'}">
                            ${s.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn" onclick="editSubscriber('${s.id}')" style="padding: 4px 8px; font-size: 0.8rem;"></button>
                        <button class="btn" onclick="toggleSubscriber('${s.id}', ${!s.is_active})" style="padding: 4px 8px; font-size: 0.8rem;">
                            ${s.is_active ? '' : ''}
                        </button>
                        <button class="btn" onclick="deleteSubscriber('${s.id}')" style="padding: 4px 8px; font-size: 0.8rem; color: var(--danger);"></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openAddSubscriberModal() {
            document.getElementById('subscriberModalTitle').textContent = 'Add Subscriber';
            document.getElementById('editSubscriberId').value = '';
            document.getElementById('subscriberName').value = '';
            document.getElementById('subscriberEmail').value = '';
            document.getElementById('subscriberPhone').value = '';
            document.getElementById('subscriberBrand').value = '';
            document.getElementById('subNotifyWins').checked = true;
            document.getElementById('subNotifyWeekly').checked = true;
            document.getElementById('subNotifyAttention').checked = true;
            document.getElementById('subNotifyGoals').checked = false;
            document.getElementById('subscriberModal').classList.add('show');
        }
        
        async function editSubscriber(id) {
            const { data } = await supabaseClient.from('alert_subscribers').select('*').eq('id', id).single();
            if (!data) return;
            
            document.getElementById('subscriberModalTitle').textContent = 'Edit Subscriber';
            document.getElementById('editSubscriberId').value = id;
            document.getElementById('subscriberName').value = data.name || '';
            document.getElementById('subscriberEmail').value = data.email || '';
            document.getElementById('subscriberPhone').value = data.phone || '';
            document.getElementById('subscriberBrand').value = data.brand || '';
            document.getElementById('subNotifyWins').checked = data.notify_daily_wins;
            document.getElementById('subNotifyWeekly').checked = data.notify_weekly_summary;
            document.getElementById('subNotifyAttention').checked = data.notify_attention_alerts;
            document.getElementById('subNotifyGoals').checked = data.notify_goal_progress;
            document.getElementById('subscriberModal').classList.add('show');
        }
        
        function closeSubscriberModal() {
            document.getElementById('subscriberModal').classList.remove('show');
        }
        
        async function saveSubscriber() {
            const id = document.getElementById('editSubscriberId').value;
            const name = document.getElementById('subscriberName').value.trim();
            const email = document.getElementById('subscriberEmail').value.trim();
            const phone = document.getElementById('subscriberPhone').value.trim();
            const brand = document.getElementById('subscriberBrand').value || null;
            
            if (!name) {
                showToast('Name is required', 'error');
                return;
            }
            
            if (!email && !phone) {
                showToast('Email or phone is required', 'error');
                return;
            }
            
            // Email validation
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('Invalid email address format', 'error');
                return;
            }
            
            // Phone validation (E.164 format)
            if (phone && !/^\+[1-9]\d{1,14}$/.test(phone)) {
                showToast('Invalid phone number. Use E.164 format (e.g., +15551234567)', 'error');
                return;
            }
            
            const subscriberData = {
                name,
                email: email || null,
                phone: phone || null,
                brand,
                notify_daily_wins: document.getElementById('subNotifyWins').checked,
                notify_weekly_summary: document.getElementById('subNotifyWeekly').checked,
                notify_attention_alerts: document.getElementById('subNotifyAttention').checked,
                notify_goal_progress: document.getElementById('subNotifyGoals').checked,
                updated_at: new Date().toISOString()
            };
            
            let error;
            if (id) {
                ({ error } = await supabaseClient.from('alert_subscribers').update(subscriberData).eq('id', id));
            } else {
                ({ error } = await supabaseClient.from('alert_subscribers').insert([subscriberData]));
            }
            
            if (error) {
                showToast('Error saving subscriber', 'error');
                console.error(error);
                return;
            }
            
            showToast('Subscriber saved!', 'success');
            closeSubscriberModal();
            loadSubscribers();
        }
        
        async function toggleSubscriber(id, isActive) {
            const { error } = await supabaseClient
                .from('alert_subscribers')
                .update({ is_active: isActive, updated_at: new Date().toISOString() })
                .eq('id', id);
            
            if (error) {
                showToast('Error updating subscriber', 'error');
                return;
            }
            
            showToast(isActive ? 'Subscriber activated' : 'Subscriber paused', 'success');
            loadSubscribers();
        }
        
        async function deleteSubscriber(id) {
            if (!confirm('Are you sure you want to delete this subscriber?')) return;
            
            const { error } = await supabaseClient.from('alert_subscribers').delete().eq('id', id);
            
            if (error) {
                showToast('Error deleting subscriber', 'error');
                return;
            }
            
            showToast('Subscriber deleted', 'success');
            loadSubscribers();
        }

        // ==================== MODALS ====================
        function openAddCreatorModal() {
            document.getElementById('modalTitle').textContent = 'Add Creator';
            document.getElementById('editCreatorId').value = '';
            document.getElementById('creatorRealName').value = '';
            document.getElementById('creatorDiscord').value = '';
            document.getElementById('creatorEmail').value = '';
            document.getElementById('creatorPhone').value = '';
            document.getElementById('creatorBrand').value = 'catakor';
            document.getElementById('creatorRole').value = 'Incubator';
            document.getElementById('creatorStatus').value = 'Active';
            document.getElementById('creatorRetainer').value = '0';
            document.getElementById('creatorMonthlyPostReq').value = '30';
            document.getElementById('creatorContractLength').value = '30';
            document.getElementById('creatorRetainerStartDate').value = '';
            updateContractSummary();
            document.getElementById('creatorLastContact').value = '';
            document.getElementById('creatorNextFollowup').value = '';
            document.getElementById('creatorAccount1').value = '';
            document.getElementById('creatorAccount2').value = '';
            document.getElementById('creatorAccount3').value = '';
            document.getElementById('creatorAccount4').value = '';
            document.getElementById('creatorAccount5').value = '';
            document.getElementById('creatorNotes').value = '';
            document.getElementById('existingCreatorHint').style.display = 'none';
            document.getElementById('crossBrandTikTokHint').style.display = 'none';
            document.getElementById('creatorPerformanceMetrics').style.display = 'none';
            crossBrandTikTokMatch = null;
            document.getElementById('creatorModal').classList.add('show');
        }

        function editCreator(id) {
            const creator = managedCreators.find(c => c.id === id);
            if (!creator) return;
            document.getElementById('modalTitle').textContent = 'Edit Creator';
            document.getElementById('editCreatorId').value = id;
            document.getElementById('creatorRealName').value = creator.real_name || '';
            document.getElementById('creatorDiscord').value = creator.discord_name || '';
            document.getElementById('creatorEmail').value = creator.email || '';
            document.getElementById('creatorPhone').value = creator.phone || '';
            document.getElementById('creatorBrand').value = creator.brand || 'catakor';
            document.getElementById('creatorRole').value = creator.role || 'Incubator';
            document.getElementById('creatorStatus').value = creator.status || 'Active';
            document.getElementById('creatorRetainer').value = creator.retainer || 0;
            document.getElementById('creatorMonthlyPostReq').value = creator.monthly_post_requirement || 30;
            document.getElementById('creatorContractLength').value = creator.contract_length_days || 30;
            document.getElementById('creatorRetainerStartDate').value = creator.retainer_start_date || '';
            updateContractSummary();
            document.getElementById('creatorLastContact').value = creator.last_contact_date || '';
            document.getElementById('creatorNextFollowup').value = creator.next_followup_date || '';
            document.getElementById('creatorDiscordChannelId').value = creator.discord_channel_id || '';
            document.getElementById('creatorDiscordUserId').value = creator.discord_user_id || '';
            document.getElementById('creatorAccount1').value = creator.account_1 || '';
            document.getElementById('creatorAccount2').value = creator.account_2 || '';
            document.getElementById('creatorAccount3').value = creator.account_3 || '';
            document.getElementById('creatorAccount4').value = creator.account_4 || '';
            document.getElementById('creatorAccount5').value = creator.account_5 || '';
            document.getElementById('creatorNotes').value = creator.notes || '';
            document.getElementById('crossBrandTikTokHint').style.display = 'none';
            crossBrandTikTokMatch = null;
            document.getElementById('creatorModal').classList.add('show');
            
            // Load performance metrics
            loadCreatorMetrics(creator.id, creator.brand, creator.account_1);
            
            // Load compensation section for this brand
            loadCompensation(creator.brand, creator.retainer || 0, creator.product_retainers || {});
        }

        function closeModal() { document.getElementById('creatorModal').classList.remove('show'); }
        
        function updateContractSummary() {
            const posts = document.getElementById('creatorMonthlyPostReq')?.value || 30;
            const days = document.getElementById('creatorContractLength')?.value || 30;
            const el = document.getElementById('contractSummary');
            if (el) {
                el.innerHTML = `<strong>${posts} posts</strong> in <strong>${days} days</strong>`;
            }
        }
        
        function setContractStartToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('creatorRetainerStartDate').value = today;
            showToast('Contract start date set to today', 'success');
        }

        // ==================== RETAINER HISTORY & METRICS ====================
        
        let currentEditingCreatorId = null;
        
        async function showRetainerHistory() {
            const creatorId = document.getElementById('editCreatorId').value;
            if (!creatorId) {
                showToast('Save creator first to view history', 'warning');
                return;
            }
            
            const content = document.getElementById('retainerHistoryContent');
            content.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';
            document.getElementById('retainerHistoryModal').classList.add('show');
            
            try {
                const { data, error } = await supabaseClient
                    .from('retainer_history')
                    .select('*')
                    .eq('creator_id', creatorId)
                    .order('changed_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No retainer history found</div>';
                    return;
                }
                
                const changeIcons = {
                    'initial': '',
                    'increase': '',
                    'decrease': '',
                    'removed': ''
                };
                
                content.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="padding: 10px; text-align: left;">Date</th>
                                <th style="padding: 10px; text-align: left;">Change</th>
                                <th style="padding: 10px; text-align: right;">Amount</th>
                                <th style="padding: 10px; text-align: left;">By</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(h => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 10px;">${new Date(h.changed_at).toLocaleDateString()}</td>
                                    <td style="padding: 10px;">${changeIcons[h.change_type] || ''} ${h.change_type}</td>
                                    <td style="padding: 10px; text-align: right;">
                                        ${h.old_amount ? `<span style="color: var(--text-muted); text-decoration: line-through;">${fmtMoney(h.old_amount)}</span>  ` : ''}
                                        <span style="color: ${h.new_amount > 0 ? 'var(--success)' : 'var(--danger)'};">${fmtMoney(h.new_amount)}</span>
                                    </td>
                                    <td style="padding: 10px; color: var(--text-muted);">${h.changed_by || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                console.error('Failed to load retainer history:', err);
                content.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    ${err.message.includes('does not exist') ? 'Retainer history table not set up yet. Run the SQL migration.' : 'Error loading history'}
                </div>`;
            }
        }
        
        function closeRetainerHistoryModal() {
            document.getElementById('retainerHistoryModal').classList.remove('show');
        }
        
        async function loadCreatorMetrics(creatorId, brand, account) {
            const metricsDiv = document.getElementById('creatorPerformanceMetrics');
            if (!creatorId) {
                metricsDiv.style.display = 'none';
                return;
            }
            
            metricsDiv.style.display = 'block';
            currentEditingCreatorId = creatorId;
            
            try {
                // Get last 90 days of performance
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                const startDate = ninetyDaysAgo.toISOString().split('T')[0];
                
                const { data: perfData } = await supabaseClient
                    .from('creator_performance')
                    .select('gmv, orders, report_date')
                    .eq('brand', brand)
                    .ilike('creator_name', account)
                    .gte('report_date', startDate);
                
                const totalGmv = (perfData || []).reduce((s, p) => s + (parseFloat(p.gmv) || 0), 0);
                const totalOrders = (perfData || []).reduce((s, p) => s + (parseInt(p.orders) || 0), 0);
                const lastActiveDate = (perfData || []).length > 0 ? 
                    Math.max(...perfData.map(p => new Date(p.report_date).getTime())) : null;
                
                document.getElementById('metricGmv').textContent = fmtMoney(totalGmv);
                document.getElementById('metricOrders').textContent = totalOrders.toLocaleString();
                
                if (lastActiveDate) {
                    const daysSinceActive = Math.floor((Date.now() - lastActiveDate) / (1000 * 60 * 60 * 24));
                    document.getElementById('metricLastActive').textContent = daysSinceActive === 0 ? 'Today' : 
                        (daysSinceActive === 1 ? 'Yesterday' : `${daysSinceActive}d ago`);
                    document.getElementById('metricLastActive').style.color = daysSinceActive > 14 ? 'var(--danger)' : 
                        (daysSinceActive > 7 ? 'var(--warning)' : 'var(--success)');
                } else {
                    document.getElementById('metricLastActive').textContent = 'Never';
                    document.getElementById('metricLastActive').style.color = 'var(--danger)';
                }
                
                // Calculate retainer ROI (GMV / Retainer)
                const retainer = parseFloat(document.getElementById('creatorRetainer').value) || 0;
                const roiX = retainer > 0 ? (totalGmv / retainer) : null;
                
                if (roiX !== null) {
                    document.getElementById('metricRetainerRoi').textContent = `${roiX.toFixed(1)}x`;
                    document.getElementById('metricRetainerRoi').style.color = 
                        roiX >= 1 ? 'var(--success)' : (roiX >= 0.5 ? 'var(--warning)' : 'var(--error)');
                } else {
                    document.getElementById('metricRetainerRoi').textContent = '';
                    document.getElementById('metricRetainerRoi').style.color = '';
                }
                
                // Health indicator
                const healthDiv = document.getElementById('creatorHealthIndicator');
                let healthScore = 0;
                let healthIssues = [];
                
                if (totalGmv > 1000) healthScore += 2;
                else if (totalGmv > 100) healthScore += 1;
                else healthIssues.push('Low GMV');
                
                if (lastActiveDate && (Date.now() - lastActiveDate) < 7 * 24 * 60 * 60 * 1000) healthScore += 2;
                else if (lastActiveDate && (Date.now() - lastActiveDate) < 14 * 24 * 60 * 60 * 1000) healthScore += 1;
                else healthIssues.push('Inactive');
                
                if (retainer > 0) {
                    if (roiX && roiX >= 1) healthScore += 2;
                    else if (roiX && roiX >= 0.5) healthScore += 1;
                    else if (roiX && roiX < 0.5) healthIssues.push('Low ROI');
                }
                
                if (healthScore >= 4) {
                    healthDiv.innerHTML = ' <strong>Healthy</strong> - Keep this creator!';
                    healthDiv.style.background = 'var(--success-dim)';
                    healthDiv.style.color = 'var(--success)';
                } else if (healthScore >= 2) {
                    healthDiv.innerHTML = ` <strong>Watch</strong> - ${healthIssues.join(', ') || 'Could improve'}`;
                    healthDiv.style.background = 'var(--warning-dim)';
                    healthDiv.style.color = 'var(--warning)';
                } else {
                    healthDiv.innerHTML = ` <strong>At Risk</strong> - ${healthIssues.join(', ')}. Consider action.`;
                    healthDiv.style.background = 'var(--danger-dim)';
                    healthDiv.style.color = 'var(--danger)';
                }
                
            } catch (err) {
                console.error('Failed to load metrics:', err);
            }
        }
        
        function refreshCreatorMetrics() {
            const creatorId = document.getElementById('editCreatorId').value;
            const brand = document.getElementById('creatorBrand').value;
            const account = document.getElementById('creatorAccount1').value;
            if (creatorId && account) {
                loadCreatorMetrics(creatorId, brand, account);
            }
        }

        // Check if Discord already exists in roster (for auto-fill)
        function checkExistingDiscord() {
            const discordInput = document.getElementById('creatorDiscord');
            const hint = document.getElementById('existingCreatorHint');
            const brandsSpan = document.getElementById('existingCreatorBrands');
            const editId = document.getElementById('editCreatorId').value;
            
            const discord = discordInput.value.trim();
            if (!discord) {
                hint.style.display = 'none';
                return;
            }
            
            // Find existing entries with this Discord
            const existingEntries = getCreatorByDiscord(discord);
            
            // If editing, exclude the current entry
            const otherEntries = editId 
                ? existingEntries.filter(e => e.id !== parseInt(editId))
                : existingEntries;
            
            if (otherEntries.length > 0) {
                const brands = otherEntries.map(e => BRAND_DISPLAY[e.brand] || e.brand).join(', ');
                const name = otherEntries[0].real_name || otherEntries[0].discord_name;
                brandsSpan.innerHTML = `<strong>${name}</strong> already in: ${brands}`;
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
            }
        }
        
        // Store cross-brand match for TikTok
        let crossBrandTikTokMatch = null;
        
        function checkCrossBrandTikTok() {
            const tiktokInput = document.getElementById('creatorAccount1');
            const hint = document.getElementById('crossBrandTikTokHint');
            const infoSpan = document.getElementById('crossBrandTikTokInfo');
            const editId = document.getElementById('editCreatorId').value;
            const currentBrand = document.getElementById('creatorBrand').value;
            
            const tiktok = normalizeTikTok(tiktokInput.value);
            if (!tiktok) {
                hint.style.display = 'none';
                crossBrandTikTokMatch = null;
                return;
            }
            
            // Find existing entries with this TikTok in OTHER brands
            const match = managedCreators.find(mc => 
                mc.brand !== currentBrand &&
                (editId ? mc.id !== parseInt(editId) : true) &&
                (normalizeTikTok(mc.account_1) === tiktok ||
                 normalizeTikTok(mc.account_2) === tiktok ||
                 normalizeTikTok(mc.account_3) === tiktok ||
                 normalizeTikTok(mc.account_4) === tiktok ||
                 normalizeTikTok(mc.account_5) === tiktok)
            );
            
            if (match) {
                crossBrandTikTokMatch = match;
                const name = match.real_name || match.discord_name || '@' + tiktok;
                infoSpan.innerHTML = `<strong>${name}</strong> in ${BRAND_DISPLAY[match.brand] || match.brand}`;
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
                crossBrandTikTokMatch = null;
            }
        }
        
        function autoFillFromTikTok() {
            if (!crossBrandTikTokMatch) {
                showToast('No cross-brand match found', 'info');
                return;
            }
            
            const match = crossBrandTikTokMatch;
            
            // Only fill empty fields
            const fillIfEmpty = (fieldId, value) => {
                const field = document.getElementById(fieldId);
                if (field && !field.value && value) {
                    field.value = value;
                }
            };
            
            fillIfEmpty('creatorRealName', match.real_name);
            fillIfEmpty('creatorDiscord', match.discord_name);
            fillIfEmpty('creatorEmail', match.email);
            fillIfEmpty('creatorPhone', match.phone);
            fillIfEmpty('creatorAccount2', match.account_2);
            fillIfEmpty('creatorAccount3', match.account_3);
            fillIfEmpty('creatorAccount4', match.account_4);
            fillIfEmpty('creatorAccount5', match.account_5);
            
            // Copy role
            if (match.role) {
                document.getElementById('creatorRole').value = match.role;
            }
            
            showToast(`Info copied from ${BRAND_DISPLAY[match.brand]} profile!`, 'success');
        }

        // Auto-fill form from existing Discord entries
        function autoFillFromDiscord() {
            const discord = document.getElementById('creatorDiscord').value.trim();
            const canonical = getCanonicalCreatorInfo(discord);
            
            if (!canonical) {
                showToast('No existing info found', 'info');
                return;
            }
            
            // Only fill empty fields (don't overwrite user input)
            const fillIfEmpty = (fieldId, value) => {
                const field = document.getElementById(fieldId);
                if (field && !field.value && value) {
                    field.value = value;
                }
            };
            
            fillIfEmpty('creatorRealName', canonical.real_name);
            fillIfEmpty('creatorEmail', canonical.email);
            fillIfEmpty('creatorPhone', canonical.phone);
            fillIfEmpty('creatorAccount1', canonical.account_1);
            fillIfEmpty('creatorAccount2', canonical.account_2);
            fillIfEmpty('creatorAccount3', canonical.account_3);
            fillIfEmpty('creatorAccount4', canonical.account_4);
            fillIfEmpty('creatorAccount5', canonical.account_5);
            
            // Copy role if it's set
            if (canonical.role) {
                document.getElementById('creatorRole').value = canonical.role;
            }
            
            showToast('Info copied from existing profile!', 'success');
        }

        async function saveCreator() {
            const id = document.getElementById('editCreatorId').value;
            const validationError = document.getElementById('creatorValidationError');
            const validationMessage = document.getElementById('creatorValidationMessage');
            
            // Hide previous errors
            validationError.style.display = 'none';
            
            // Get values
            const realName = document.getElementById('creatorRealName').value.trim();
            const discordName = normalizeDiscord(document.getElementById('creatorDiscord').value);
            const account1Raw = document.getElementById('creatorAccount1').value;
            const retainer = parseFloat(document.getElementById('creatorRetainer').value) || 0;
            
            // Collect missing required fields
            const missingFields = [];
            
            if (!discordName) {
                missingFields.push('Discord Name');
                document.getElementById('creatorDiscord').style.borderColor = 'var(--danger)';
            } else {
                document.getElementById('creatorDiscord').style.borderColor = '';
            }
            
            if (!account1Raw.trim()) {
                missingFields.push('Primary TikTok Account');
                document.getElementById('creatorAccount1').style.borderColor = 'var(--danger)';
            } else {
                document.getElementById('creatorAccount1').style.borderColor = '';
            }
            
            // Show validation error if missing required fields
            if (missingFields.length > 0) {
                validationMessage.textContent = missingFields.join(', ');
                validationError.style.display = 'block';
                validationError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // TikTok username validation (strip @ and validate format)
            const cleanUsername = (u) => {
                if (!u) return null;
                let clean = normalizeTikTok(u);
                // TikTok usernames: 2-24 chars, letters, numbers, underscores, periods
                if (clean && !/^[a-z0-9_.]{2,24}$/.test(clean)) {
                    return { error: `Invalid TikTok username: ${u}` };
                }
                return clean || null;
            };
            
            const acc1 = cleanUsername(document.getElementById('creatorAccount1').value);
            const acc2 = cleanUsername(document.getElementById('creatorAccount2').value);
            const acc3 = cleanUsername(document.getElementById('creatorAccount3').value);
            const acc4 = cleanUsername(document.getElementById('creatorAccount4').value);
            const acc5 = cleanUsername(document.getElementById('creatorAccount5').value);
            
            if (acc1?.error) { showToast(acc1.error, 'error'); return; }
            if (acc2?.error) { showToast(acc2.error, 'error'); return; }
            if (acc3?.error) { showToast(acc3.error, 'error'); return; }
            if (acc4?.error) { showToast(acc4.error, 'error'); return; }
            if (acc5?.error) { showToast(acc5.error, 'error'); return; }
            
            // Retainer validation
            if (retainer < 0) {
                showToast('Retainer cannot be negative', 'error');
                return;
            }
            if (retainer > 50000) {
                if (!confirm(`Retainer of ${fmtMoney(retainer)}/month seems high. Continue?`)) return;
            }
            
            // Check for duplicate accounts within the SAME brand (allow same creator across different brands)
            const selectedBrand = document.getElementById('creatorBrand').value;
            if (acc1) {
                const existingCreator = managedCreators.find(c => 
                    c.id != id && 
                    c.brand === selectedBrand && 
                    (c.account_1 === acc1 || c.account_2 === acc1 || c.account_3 === acc1 || c.account_4 === acc1 || c.account_5 === acc1)
                );
                if (existingCreator) {
                    showToast(`Account @${acc1} is already assigned to ${existingCreator.real_name || existingCreator.discord_name || 'another creator'} for ${BRAND_DISPLAY[selectedBrand]}`, 'error');
                    return;
                }
                
                // If same account exists for different brand, show info (not error)
                const otherBrandCreator = managedCreators.find(c => 
                    c.id != id && 
                    c.brand !== selectedBrand && 
                    (c.account_1 === acc1 || c.account_2 === acc1 || c.account_3 === acc1 || c.account_4 === acc1 || c.account_5 === acc1)
                );
                if (otherBrandCreator && !id) {
                    // Only show on new entries, not edits
                    showToast(`Note: @${acc1} also works with ${BRAND_DISPLAY[otherBrandCreator.brand]}`, 'info');
                }
            }
            
            const data = {
                real_name: realName || null,
                discord_name: discordName,
                email: document.getElementById('creatorEmail').value.trim() || null,
                phone: document.getElementById('creatorPhone').value.trim() || null,
                brand: document.getElementById('creatorBrand').value,
                role: document.getElementById('creatorRole').value,
                status: document.getElementById('creatorStatus').value,
                retainer: retainer,
                monthly_post_requirement: parseInt(document.getElementById('creatorMonthlyPostReq').value) || 30,
                contract_length_days: parseInt(document.getElementById('creatorContractLength').value) || 30,
                retainer_start_date: document.getElementById('creatorRetainerStartDate').value || null,
                last_contact_date: document.getElementById('creatorLastContact').value || null,
                next_followup_date: document.getElementById('creatorNextFollowup').value || null,
                discord_channel_id: document.getElementById('creatorDiscordChannelId').value.trim() || null,
                discord_user_id: document.getElementById('creatorDiscordUserId').value.trim() || null,
                account_1: acc1,
                account_2: acc2,
                account_3: acc3,
                account_4: acc4,
                account_5: acc5,
                notes: document.getElementById('creatorNotes').value.trim() || null,
                updated_by: adminName || 'Admin',
                product_assignments: getSelectedProductAssignments(),
                product_retainers: getProductRetainers()
            };

            let error, newId;
            let oldData = null;
            
            if (id) {
                // Get old data for audit log
                oldData = managedCreators.find(c => c.id === parseInt(id));
                ({ error } = await supabaseClient.from('managed_creators').update(data).eq('id', id));
                newId = id;
            } else {
                data.created_by = adminName || 'Admin';
                const result = await supabaseClient.from('managed_creators').insert([data]).select('id').single();
                error = result.error;
                newId = result.data?.id;
            }

            if (error) { showToast('Error: ' + error.message, 'error'); return; }
            
            // Log to audit table (if it exists)
            try {
                await supabaseClient.from('roster_audit_log').insert({
                    managed_creator_id: parseInt(newId),
                    action: id ? 'update' : 'create',
                    changed_by: adminName || 'Admin',
                    old_values: oldData ? {
                        discord_name: oldData.discord_name,
                        real_name: oldData.real_name,
                        email: oldData.email,
                        role: oldData.role,
                        status: oldData.status,
                        account_1: oldData.account_1
                    } : null,
                    new_values: {
                        discord_name: data.discord_name,
                        real_name: data.real_name,
                        email: data.email,
                        role: data.role,
                        status: data.status,
                        account_1: data.account_1
                    },
                    notes: id ? 'Updated via roster modal' : 'Created via roster modal'
                });
            } catch (auditErr) {
                // Audit table might not exist yet - that's ok
                console.log('Audit log skipped (table may not exist):', auditErr.message);
            }
            
            // Track retainer changes
            try {
                const oldRetainer = oldData?.retainer || 0;
                const newRetainer = data.retainer || 0;
                
                if (oldRetainer !== newRetainer) {
                    let changeType = 'initial';
                    if (oldData) {
                        if (newRetainer === 0) changeType = 'removed';
                        else if (newRetainer > oldRetainer) changeType = 'increase';
                        else changeType = 'decrease';
                    }
                    
                    await supabaseClient.from('retainer_history').insert({
                        creator_id: parseInt(newId),
                        brand: data.brand,
                        old_amount: oldRetainer,
                        new_amount: newRetainer,
                        change_type: changeType,
                        changed_by: adminName || 'Admin'
                    });
                    
                    if (changeType !== 'initial') {
                        const changeText = changeType === 'removed' ? 'removed' : 
                            (changeType === 'increase' ? `increased from ${fmtMoney(oldRetainer)} to ${fmtMoney(newRetainer)}` : 
                            `decreased from ${fmtMoney(oldRetainer)} to ${fmtMoney(newRetainer)}`);
                        showToast(`Retainer ${changeText}`, 'info');
                    }
                }
            } catch (retainerErr) {
                console.log('Retainer history skipped (table may not exist):', retainerErr.message);
            }
            
            closeModal();
            showToast(id ? 'Creator updated' : 'Creator added', 'success');
            logActivity(id ? 'edit' : 'add', `${id ? 'Updated' : 'Added'} creator: ${data.real_name || data.discord_name}`, data.brand);
            await loadManagedCreators();
            loadRosterData();
            loadOverviewData();
            // Also refresh Creators view if it's been loaded
            if (window.creatorsDataLoaded) loadCreatorsData();
            // Also refresh Posting view if it's been loaded
            if (window.postingDataLoaded) loadPostingData();
        }

        async function deleteCreator(id, name) {
            if (!confirm(`Remove ${name} from roster?`)) return;
            
            // Get old data for audit
            const oldData = managedCreators.find(c => c.id === id);
            
            const { error } = await supabaseClient.from('managed_creators').delete().eq('id', id);
            if (error) { showToast('Error: ' + error.message, 'error'); return; }
            
            // Log deletion
            try {
                await supabaseClient.from('roster_audit_log').insert({
                    managed_creator_id: id,
                    action: 'delete',
                    changed_by: adminName || 'Admin',
                    old_values: oldData ? {
                        discord_name: oldData.discord_name,
                        real_name: oldData.real_name,
                        brand: oldData.brand,
                        account_1: oldData.account_1
                    } : null,
                    notes: `Deleted ${name}`
                });
            } catch (auditErr) {
                console.log('Audit log skipped:', auditErr.message);
            }
            
            showToast('Creator removed', 'success');
            logActivity('delete', `Removed creator: ${name}`, oldData?.brand);
            await loadManagedCreators();
            loadRosterData();
            loadOverviewData();
        }

        async function quickAddToRoster(username, brand) {
            // Open the Add Creator modal with pre-filled data
            // This ensures Discord and other required fields are captured
            openAddCreatorModal();
            
            // Pre-fill the TikTok account and brand
            document.getElementById('creatorAccount1').value = normalizeTikTok(username) || '';
            document.getElementById('creatorBrand').value = brand || 'catakor';
            
            // Focus on the Discord field since that's required
            setTimeout(() => {
                document.getElementById('creatorDiscord').focus();
            }, 100);
            
            showToast('Please fill in Discord name to complete adding this creator', 'info');
        }

        // Goal Modal
        function openGoalModal() { document.getElementById('goalModal').classList.add('show'); }
        function closeGoalModal() { document.getElementById('goalModal').classList.remove('show'); }

        document.getElementById('goalType').addEventListener('change', (e) => {
            document.getElementById('goalBrandGroup').style.display = e.target.value === 'brand' ? 'block' : 'none';
        });

        async function saveGoal() {
            const goalType = document.getElementById('goalType').value;
            const targetGmv = parseFloat(document.getElementById('goalTargetGmv').value) || 0;
            const periodType = document.getElementById('goalPeriod').value;
            
            // Validation
            if (targetGmv <= 0) {
                showToast('Please enter a target GMV greater than $0', 'error');
                return;
            }
            
            if (targetGmv > 10000000) {
                showToast('Target GMV seems unrealistically high. Please check your value.', 'error');
                return;
            }
            
            // Calculate period dates based on period type
            const today = new Date();
            let periodEnd = new Date();
            
            switch (periodType) {
                case 'daily':
                    // End of today
                    break;
                case 'weekly':
                    periodEnd.setDate(periodEnd.getDate() + 7);
                    break;
                case 'monthly':
                    periodEnd.setMonth(periodEnd.getMonth() + 1);
                    break;
                case 'quarterly':
                    periodEnd.setMonth(periodEnd.getMonth() + 3);
                    break;
                default:
                    periodEnd.setDate(periodEnd.getDate() + 30);
            }
            
            const targetEntity = goalType === 'brand' ? document.getElementById('goalBrand').value : null;
            
            // Check for duplicate active goals
            const { data: existingGoals } = await supabaseClient.from('goals')
                .select('*')
                .eq('goal_type', goalType)
                .eq('period_type', periodType)
                .gte('period_end', localDateStr(today));
            
            if (existingGoals && existingGoals.length > 0) {
                const duplicate = existingGoals.find(g => 
                    (goalType === 'overall') || 
                    (goalType === 'brand' && g.target_entity === targetEntity)
                );
                if (duplicate) {
                    if (!confirm(`An active ${periodType} goal already exists for ${goalType === 'brand' ? BRAND_DISPLAY[targetEntity] : 'all brands'}. Create another?`)) {
                        return;
                    }
                }
            }
            
            const data = {
                goal_type: goalType,
                target_entity: targetEntity,
                period_type: periodType,
                period_start: localDateStr(today),
                period_end: localDateStr(periodEnd),
                target_gmv: targetGmv
            };

            const { error } = await supabaseClient.from('goals').insert([data]);
            if (error) { showToast('Error: ' + error.message, 'error'); return; }
            closeGoalModal();
            showToast('Goal created', 'success');
            loadGoalsData();
        }

        async function markAllAlertsRead() {
            await supabaseClient.from('alerts').update({ is_read: true }).eq('is_read', false);
            loadAlertsData();
            showToast('All alerts marked as read', 'success');
        }

        // ==================== COMMISSION CALCULATOR ====================
        let calculatedPayouts = [];

        async function initCalculator() {
            // Load brand settings from database
            await loadBrandSettings();
            // Initialize month dropdown for revenue share
            populateRevShareMonths();
        }

        // ==================== REVENUE SHARE CALCULATOR ====================
        // Brand settings cached from database
        let brandSettingsCache = null;
        
        async function loadBrandSettings() {
            try {
                const { data, error } = await supabaseClient
                    .from('brand_settings')
                    .select('brand, commission_rate, retainer, launch_fee, launch_fee_name, launch_fee_ends');
                
                if (error) throw error;
                
                // Convert to lookup objects
                brandSettingsCache = {
                    rates: {},
                    retainers: {},
                    launchFees: {}
                };
                
                const today = new Date().toISOString().split('T')[0];
                
                (data || []).forEach(row => {
                    brandSettingsCache.rates[row.brand] = parseFloat(row.commission_rate) || 2.5;
                    brandSettingsCache.retainers[row.brand] = parseFloat(row.retainer) || 0;
                    
                    // Only include launch fee if it hasn't expired
                    const feeEnds = row.launch_fee_ends;
                    const isActive = !feeEnds || feeEnds >= today;
                    
                    brandSettingsCache.launchFees[row.brand] = {
                        amount: isActive ? (parseFloat(row.launch_fee) || 0) : 0,
                        name: row.launch_fee_name || '',
                        ends: row.launch_fee_ends || '',
                        isActive: isActive && (parseFloat(row.launch_fee) || 0) > 0
                    };
                });
                
                return brandSettingsCache;
            } catch (err) {
                console.error('Failed to load brand settings:', err);
                return { rates: {}, retainers: {}, launchFees: {} };
            }
        }
        
        function getRevShareRates() {
            return brandSettingsCache?.rates || {};
        }
        
        async function saveRevShareRate(brand, rate) {
            try {
                const { error } = await supabaseClient
                    .from('brand_settings')
                    .update({ commission_rate: rate, updated_at: new Date().toISOString() })
                    .eq('brand', brand);
                
                if (error) throw error;
                
                // Update cache
                if (brandSettingsCache) {
                    brandSettingsCache.rates[brand] = rate;
                }
            } catch (err) {
                console.error('Failed to save commission rate:', err);
                showToast('Failed to save rate: ' + err.message, 'error');
            }
        }
        
        function getRetainers() {
            return brandSettingsCache?.retainers || {};
        }
        
        async function saveRetainer(brand, amount) {
            try {
                const { error } = await supabaseClient
                    .from('brand_settings')
                    .update({ retainer: amount, updated_at: new Date().toISOString() })
                    .eq('brand', brand);
                
                if (error) throw error;
                
                // Update cache
                if (brandSettingsCache) {
                    brandSettingsCache.retainers[brand] = amount;
                }
            } catch (err) {
                console.error('Failed to save retainer:', err);
                showToast('Failed to save retainer: ' + err.message, 'error');
            }
        }
        
        function populateRevShareMonths() {
            const select = document.getElementById('revShareMonth');
            if (!select) return;
            
            const months = [];
            const now = new Date();
            
            // Last 12 months
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                months.push({ value, label });
            }
            
            select.innerHTML = months.map((m, i) => 
                `<option value="${m.value}" ${i === 1 ? 'selected' : ''}>${m.label}</option>`
            ).join('');
        }
        
        async function calculateRevenueShare() {
            const monthValue = document.getElementById('revShareMonth')?.value;
            if (!monthValue) return;
            
            // Load brand settings from database if not cached
            if (!brandSettingsCache) {
                await loadBrandSettings();
            }
            
            const [year, month] = monthValue.split('-').map(Number);
            const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
            const endDate = new Date(year, month, 0).toISOString().split('T')[0]; // Last day of month
            
            // Define brands
            const brands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            
            // Show loading state
            const tbody = document.getElementById('revShareBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" style="text-align: center; padding: 60px;">
                        <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                        <div id="loadingText" style="font-weight: 600; color: var(--text-primary);">Loading data...</div>
                        <div id="loadingProgress" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">Fetching page 1...</div>
                    </td>
                </tr>
            `;
            
            // Reset summary while loading
            document.getElementById('revTotalGmv').textContent = '...';
            document.getElementById('revTotalShare').textContent = '...';
            document.getElementById('revTotalRetainers').textContent = '...';
            document.getElementById('revTotalEarnings').textContent = '...';
            document.getElementById('revTylerShare').textContent = '...';
            document.getElementById('revMattShare').textContent = '...';
            document.getElementById('revShareFooter').style.display = 'none';
            
            // Reset goal tracker while loading
            document.getElementById('goalCurrentAmount').textContent = '...';
            document.getElementById('goalPercentText').textContent = 'Calculating...';
            document.getElementById('goalProgressText').textContent = 'Loading...';
            
            try {
                // Get ALL performance data - paginate with 1000 row limit
                let allPerfData = [];
                let page = 0;
                const pageSize = QUERY_PAGE_SIZE; // Supabase max per query
                let hasMore = true;
                
                while (hasMore) {
                    // Update loading progress
                    const progressEl = document.getElementById('loadingProgress');
                    if (progressEl) {
                        progressEl.textContent = `Fetching page ${page + 1}... (${allPerfData.length.toLocaleString()} rows so far)`;
                    }
                    
                    const { data: perfData, error: perfError } = await supabaseClient
                        .from('creator_performance')
                        .select('creator_name, brand, gmv, orders')
                        .gte('report_date', startDate)
                        .lte('report_date', endDate)
                        .eq('period_type', 'daily')
                        .range(page * pageSize, (page + 1) * pageSize - 1);
                    
                    if (perfError) throw perfError;
                    
                    if (perfData && perfData.length > 0) {
                        allPerfData = allPerfData.concat(perfData);
                        page++;
                        hasMore = perfData.length === pageSize; // Continue if we got a full page
                    } else {
                        hasMore = false;
                    }
                }
                
                // Update loading to show calculating
                const progressEl = document.getElementById('loadingProgress');
                if (progressEl) {
                    progressEl.textContent = `Calculating from ${allPerfData.length.toLocaleString()} rows...`;
                }
                
                console.log('Total performance rows fetched:', allPerfData.length);
                
                // Build managed creators lookup using normalizeTikTok for consistent matching
                const managedLookup = new Set();
                managedCreators.forEach(mc => {
                    [mc.account_1, mc.account_2, mc.account_3, mc.account_4, mc.account_5].forEach(acct => {
                        const normalized = normalizeTikTok(acct);
                        if (normalized) managedLookup.add(`${normalized}|||${mc.brand}`);
                    });
                });
                
                // Aggregate GMV by brand AND build creator-level data (managed creators only)
                const brandTotals = {};
                const creatorGmvByBrand = {}; // Move this up to calculate commission properly
                brands.forEach(b => {
                    brandTotals[b] = 0;
                    creatorGmvByBrand[b] = {};
                });
                
                allPerfData.forEach(row => {
                    const normalized = normalizeTikTok(row.creator_name);
                    if (!normalized) return;
                    const key = `${normalized}|||${row.brand}`;
                    if (managedLookup.has(key)) {
                        brandTotals[row.brand] = (brandTotals[row.brand] || 0) + (parseFloat(row.gmv) || 0);
                        
                        // Build creator-level data
                        if (!creatorGmvByBrand[row.brand][normalized]) {
                            creatorGmvByBrand[row.brand][normalized] = { 
                                creator_name: row.creator_name, 
                                normalized: normalized,
                                brand: row.brand,
                                gmv: 0, 
                                orders: 0 
                            };
                        }
                        creatorGmvByBrand[row.brand][normalized].gmv += parseFloat(row.gmv) || 0;
                        creatorGmvByBrand[row.brand][normalized].orders += parseInt(row.orders) || 0;
                    }
                });
                
                // Get rates and retainers
                const rates = getRevShareRates();
                const retainers = getRetainers();
                const launchFees = brandSettingsCache?.launchFees || {};
                const marketingGmvData = getMarketingGmv(monthValue);
                
                // Calculate commission per brand by summing individual creator commissions
                // This respects custom creator rates (e.g., 1% for select Cata-Kor creators)
                function calculateBrandCommission(brand, affiliateGmv, marketingGmv) {
                    const brandRate = (rates[brand] || 2) / 100;
                    let creatorCommission = 0;
                    
                    // Sum individual creator commissions (respecting custom rates)
                    const brandCreators = creatorGmvByBrand[brand] || {};
                    for (const creator of Object.values(brandCreators)) {
                        const creatorRate = getCreatorRate(brand, creator.creator_name);
                        creatorCommission += creator.gmv * creatorRate;
                    }
                    
                    // Marketing GMV always uses 1% rate (not brand rate)
                    const marketingCommission = marketingGmv * 0.01;
                    
                    return {
                        affiliateCommission: creatorCommission,
                        marketingCommission: marketingCommission,
                        totalCommission: creatorCommission + marketingCommission,
                        effectiveRate: affiliateGmv > 0 ? (creatorCommission / affiliateGmv) : brandRate
                    };
                }
                
                // Calculate splits
                let totalAffiliateGmv = 0;
                let totalMarketingGmv = 0;
                let totalGmv = 0;
                let totalCommission = 0;
                let totalRetainers = 0;
                let totalLaunchFees = 0;
                
                const brandRows = brands.map(brand => {
                    const affiliateGmv = brandTotals[brand] || 0;
                    const marketingGmv = marketingGmvData[brand] || 0;
                    const gmv = affiliateGmv + marketingGmv;
                    const brandRate = rates[brand] || 2;
                    
                    // Calculate commission using individual creator rates
                    const commissionCalc = calculateBrandCommission(brand, affiliateGmv, marketingGmv);
                    const commission = commissionCalc.totalCommission;
                    const effectiveRate = gmv > 0 ? (commission / gmv) * 100 : brandRate;
                    
                    const retainer = retainers[brand] || 0;
                    const launchFee = launchFees[brand] || { amount: 0, name: '', ends: '', isActive: false };
                    const totalFees = retainer + launchFee.amount;
                    const total = commission + totalFees;
                    const tyler = total / 2;
                    const matt = total / 2;
                    
                    totalAffiliateGmv += affiliateGmv;
                    totalMarketingGmv += marketingGmv;
                    totalGmv += gmv;
                    totalCommission += commission;
                    totalRetainers += retainer;
                    totalLaunchFees += launchFee.amount;
                    
                    return { brand, affiliateGmv, marketingGmv, gmv, rate: brandRate, effectiveRate, commission, retainer, launchFee, totalFees, total, tyler, matt };
                });
                
                const totalEarnings = totalCommission + totalRetainers + totalLaunchFees;
                const tylerTotal = totalEarnings / 2;
                const mattTotal = totalEarnings / 2;
                
                // Update summary
                document.getElementById('revTotalGmv').textContent = fmtMoney(totalGmv);
                document.getElementById('revTotalShare').textContent = fmtMoney(totalCommission);
                document.getElementById('revTotalRetainers').textContent = fmtMoney(totalRetainers);
                document.getElementById('revTotalLaunchFees').textContent = fmtMoney(totalLaunchFees);
                document.getElementById('revTotalEarnings').textContent = fmtMoney(totalEarnings);
                document.getElementById('revTylerShare').textContent = fmtMoney(tylerTotal);
                document.getElementById('revMattShare').textContent = fmtMoney(mattTotal);
                
                // Update goal tracker with monthly total earnings
                updateGoalUI(totalEarnings);
                
                // Render table
                const tbody = document.getElementById('revShareBody');
                tbody.innerHTML = brandRows.map(row => {
                    const launchFeeDisplay = row.launchFee.isActive 
                        ? `<div style="font-size: 0.75rem; color: var(--info);">
                             ${row.launchFee.name || 'Launch Fee'}
                             <br><span style="color: var(--text-muted);">ends ${row.launchFee.ends || 'TBD'}</span>
                           </div>`
                        : '';
                    
                    return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 32px; height: 32px; border-radius: 8px; background: var(--accent-dim); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">
                                    ${BRAND_ICONS[row.brand] || ''}
                                </div>
                                <span style="font-weight: 600;">${BRAND_DISPLAY[row.brand] || row.brand}</span>
                            </div>
                        </td>
                        <td style="text-align: right; font-weight: 500; color: var(--accent);">${fmtMoney(row.affiliateGmv)}</td>
                        <td style="text-align: right;">
                            $<input type="number" 
                                value="${row.marketingGmv}" 
                                min="0" max="10000000" step="100" 
                                style="width: 90px; text-align: right; background: var(--bg-secondary); border: 1px solid var(--purple); border-radius: 6px; padding: 4px 8px; color: var(--purple); font-weight: 600;"
                                onchange="updateMarketingGmv('${row.brand}', this.value)"
                                title="Marketing account GMV (manual entry)"
                            >
                        </td>
                        <td style="text-align: right; font-weight: 600; color: var(--accent);">${fmtMoney(row.gmv)}</td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <div style="display: flex; align-items: center; gap: 2px;">
                                    <input type="number" 
                                        value="${row.rate}" 
                                        min="0" max="10" step="0.5" 
                                        style="width: 50px; text-align: center; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; padding: 4px 6px; color: var(--text-primary); font-weight: 600; font-size: 0.85rem;"
                                        onchange="updateBrandRate('${row.brand}', this.value)"
                                        title="Base brand rate"
                                    >%
                                </div>
                                ${Math.abs(row.effectiveRate - row.rate) > 0.01 ? `
                                    <div style="font-size: 0.7rem; color: var(--accent);" title="Effective rate after custom creator rates">
                                        eff: ${row.effectiveRate.toFixed(2)}%
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                        <td style="text-align: right; color: var(--success);">${fmtMoney(row.commission)}</td>
                        <td style="text-align: center;">
                            $<input type="number" 
                                value="${row.retainer}" 
                                min="0" max="100000" step="100" 
                                style="width: 80px; text-align: center; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; padding: 4px 8px; color: var(--text-primary); font-weight: 600;"
                                onchange="updateBrandRetainer('${row.brand}', this.value)"
                            >
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    $<input type="number" 
                                        value="${row.launchFee.amount}" 
                                        min="0" max="100000" step="100" 
                                        style="width: 80px; text-align: center; background: var(--bg-secondary); border: 1px solid ${row.launchFee.isActive ? 'var(--info)' : 'var(--border-light)'}; border-radius: 6px; padding: 4px 8px; color: ${row.launchFee.isActive ? 'var(--info)' : 'var(--text-primary)'}; font-weight: 600;"
                                        onchange="openLaunchFeeModal('${row.brand}', this.value)"
                                        title="Click to set launch fee details"
                                    >
                                </div>
                                ${launchFeeDisplay}
                            </div>
                        </td>
                        <td style="text-align: right; font-weight: 600; color: var(--success);">${fmtMoney(row.total)}</td>
                        <td style="text-align: right; color: var(--blue);">${fmtMoney(row.tyler)}</td>
                        <td style="text-align: right; color: var(--purple);">${fmtMoney(row.matt)}</td>
                    </tr>
                `}).join('');
                
                // Update footer
                document.getElementById('revShareFooter').style.display = 'table-footer-group';
                document.getElementById('footerAffiliateGmv').textContent = fmtMoney(totalAffiliateGmv);
                document.getElementById('footerMarketingGmv').textContent = fmtMoney(totalMarketingGmv);
                document.getElementById('footerGmv').textContent = fmtMoney(totalGmv);
                document.getElementById('footerCommission').textContent = fmtMoney(totalCommission);
                document.getElementById('footerRetainer').textContent = fmtMoney(totalRetainers);
                document.getElementById('footerLaunchFee').textContent = fmtMoney(totalLaunchFees);
                document.getElementById('footerTotal').textContent = fmtMoney(totalEarnings);
                document.getElementById('footerTyler').textContent = fmtMoney(tylerTotal);
                document.getElementById('footerMatt').textContent = fmtMoney(mattTotal);
                
                // Build top creators by brand for invoices (all creators, sorted by GMV)
                const topCreatorsByBrand = {};
                for (const brand of brands) {
                    if (creatorGmvByBrand[brand]) {
                        topCreatorsByBrand[brand] = Object.values(creatorGmvByBrand[brand])
                            .sort((a, b) => b.gmv - a.gmv);
                    } else {
                        topCreatorsByBrand[brand] = [];
                    }
                }
                
                // Cache data for exports
                cachedEarningsData = {
                    brandRows,
                    totalAffiliateGmv,
                    totalMarketingGmv,
                    totalGmv,
                    totalCommission,
                    totalRetainers,
                    totalLaunchFees,
                    totalEarnings,
                    tylerTotal,
                    mattTotal,
                    topCreatorsByBrand,
                    creatorGmvByBrand // Full creator breakdown
                };
                
                // Render creator breakdown table
                renderCreatorBreakdown();
                
            } catch (err) {
                console.error('Failed to calculate revenue share:', err);
                showToast('Failed to calculate: ' + err.message, 'error');
            }
        }
        
        // ==================== CREATOR BREAKDOWN ====================
        // Custom creator rates stored in localStorage (creator_name -> rate override)
        // Format: { 'catakor': { 'creatorhandle': 0.01, ... }, ... }
        let customCreatorRates = JSON.parse(localStorage.getItem('customCreatorRates') || '{}');
        
        function getCreatorRate(brand, creatorName) {
            const brandRates = customCreatorRates[brand] || {};
            const normalized = normalizeTikTok(creatorName);
            if (brandRates[normalized] !== undefined) {
                return brandRates[normalized];
            }
            // Fall back to brand rate
            const brandRate = getRevShareRates()[brand] || 2;
            return brandRate / 100; // Convert percentage to decimal
        }
        
        function setCreatorRate(brand, creatorName, rate) {
            if (!customCreatorRates[brand]) customCreatorRates[brand] = {};
            const normalized = normalizeTikTok(creatorName);
            
            // Get brand default rate
            const brandRate = (getRevShareRates()[brand] || 2) / 100;
            
            if (rate === brandRate) {
                // If same as brand default, remove override
                delete customCreatorRates[brand][normalized];
                if (Object.keys(customCreatorRates[brand]).length === 0) {
                    delete customCreatorRates[brand];
                }
            } else {
                customCreatorRates[brand][normalized] = rate;
            }
            
            localStorage.setItem('customCreatorRates', JSON.stringify(customCreatorRates));
            
            // Recalculate brand breakdown with new rates
            recalculateBrandTotals();
            renderCreatorBreakdown();
            showToast(`${creatorName} rate updated to ${(rate * 100).toFixed(1)}%`, 'success');
        }
        
        // Recalculate brand totals without refetching data
        function recalculateBrandTotals() {
            if (!cachedEarningsData?.creatorGmvByBrand) return;
            
            const brands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            const rates = getRevShareRates();
            const retainers = getRetainers();
            const launchFees = brandSettingsCache?.launchFees || {};
            const monthValue = document.getElementById('revShareMonth')?.value;
            const marketingGmvData = getMarketingGmv(monthValue);
            const creatorGmvByBrand = cachedEarningsData.creatorGmvByBrand;
            
            let totalAffiliateGmv = 0;
            let totalMarketingGmv = 0;
            let totalGmv = 0;
            let totalCommission = 0;
            let totalRetainers = 0;
            let totalLaunchFees = 0;
            
            const brandRows = brands.map(brand => {
                // Sum affiliate GMV from creators
                const brandCreators = creatorGmvByBrand[brand] || {};
                let affiliateGmv = 0;
                let creatorCommission = 0;
                
                for (const creator of Object.values(brandCreators)) {
                    affiliateGmv += creator.gmv;
                    const creatorRate = getCreatorRate(brand, creator.creator_name);
                    creatorCommission += creator.gmv * creatorRate;
                }
                
                const marketingGmv = marketingGmvData[brand] || 0;
                const brandRate = (rates[brand] || 2) / 100;
                const marketingCommission = marketingGmv * 0.01; // Marketing always 1%
                
                const gmv = affiliateGmv + marketingGmv;
                const commission = creatorCommission + marketingCommission;
                const effectiveRate = gmv > 0 ? (commission / gmv) * 100 : (rates[brand] || 2);
                
                const retainer = retainers[brand] || 0;
                const launchFee = launchFees[brand] || { amount: 0, name: '', ends: '', isActive: false };
                const total = commission + retainer + launchFee.amount;
                
                totalAffiliateGmv += affiliateGmv;
                totalMarketingGmv += marketingGmv;
                totalGmv += gmv;
                totalCommission += commission;
                totalRetainers += retainer;
                totalLaunchFees += launchFee.amount;
                
                return { brand, affiliateGmv, marketingGmv, gmv, rate: rates[brand] || 2, effectiveRate, commission, retainer, launchFee, total, tyler: total / 2, matt: total / 2 };
            });
            
            const totalEarnings = totalCommission + totalRetainers + totalLaunchFees;
            
            // Update summary displays
            document.getElementById('revTotalGmv').textContent = fmtMoney(totalGmv);
            document.getElementById('revTotalShare').textContent = fmtMoney(totalCommission);
            document.getElementById('revTotalRetainers').textContent = fmtMoney(totalRetainers);
            document.getElementById('revTotalLaunchFees').textContent = fmtMoney(totalLaunchFees);
            document.getElementById('revTotalEarnings').textContent = fmtMoney(totalEarnings);
            document.getElementById('revTylerShare').textContent = fmtMoney(totalEarnings / 2);
            document.getElementById('revMattShare').textContent = fmtMoney(totalEarnings / 2);
            
            // Update goal tracker
            updateGoalUI(totalEarnings);
            
            // Update brand table
            const tbody = document.getElementById('revShareBody');
            tbody.innerHTML = brandRows.map(row => {
                const launchFeeDisplay = row.launchFee.isActive 
                    ? `<div style="font-size: 0.75rem; color: var(--info);">
                         ${row.launchFee.name || 'Launch Fee'}
                         <br><span style="color: var(--text-muted);">ends ${row.launchFee.ends || 'TBD'}</span>
                       </div>`
                    : '';
                
                return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; background: var(--accent-dim); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">
                                ${BRAND_ICONS[row.brand] || ''}
                            </div>
                            <span style="font-weight: 600;">${BRAND_DISPLAY[row.brand] || row.brand}</span>
                        </div>
                    </td>
                    <td style="text-align: right; font-weight: 500; color: var(--accent);">${fmtMoney(row.affiliateGmv)}</td>
                    <td style="text-align: right;">
                        $<input type="number" 
                            value="${row.marketingGmv}" 
                            min="0" max="10000000" step="100" 
                            style="width: 90px; text-align: right; background: var(--bg-secondary); border: 1px solid var(--purple); border-radius: 6px; padding: 4px 8px; color: var(--purple); font-weight: 600;"
                            onchange="updateMarketingGmv('${row.brand}', this.value)"
                            title="Marketing account GMV (manual entry)"
                        >
                    </td>
                    <td style="text-align: right; font-weight: 600; color: var(--accent);">${fmtMoney(row.gmv)}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                            <div style="display: flex; align-items: center; gap: 2px;">
                                <input type="number" 
                                    value="${row.rate}" 
                                    min="0" max="10" step="0.5" 
                                    style="width: 50px; text-align: center; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; padding: 4px 6px; color: var(--text-primary); font-weight: 600; font-size: 0.85rem;"
                                    onchange="updateBrandRate('${row.brand}', this.value)"
                                    title="Base brand rate"
                                >%
                            </div>
                            ${Math.abs(row.effectiveRate - row.rate) > 0.01 ? `
                                <div style="font-size: 0.7rem; color: var(--accent);" title="Effective rate after custom creator rates">
                                    eff: ${row.effectiveRate.toFixed(2)}%
                                </div>
                            ` : ''}
                        </div>
                    </td>
                    <td style="text-align: right; color: var(--success);">${fmtMoney(row.commission)}</td>
                    <td style="text-align: center;">
                        $<input type="number" 
                            value="${row.retainer}" 
                            min="0" max="100000" step="100" 
                            style="width: 80px; text-align: center; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; padding: 4px 8px; color: var(--text-primary); font-weight: 600;"
                            onchange="updateBrandRetainer('${row.brand}', this.value)"
                        >
                    </td>
                    <td style="text-align: center;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                $<input type="number" 
                                    value="${row.launchFee.amount}" 
                                    min="0" max="100000" step="100" 
                                    style="width: 80px; text-align: center; background: var(--bg-secondary); border: 1px solid ${row.launchFee.isActive ? 'var(--info)' : 'var(--border-light)'}; border-radius: 6px; padding: 4px 8px; color: ${row.launchFee.isActive ? 'var(--info)' : 'var(--text-primary)'}; font-weight: 600;"
                                    onchange="openLaunchFeeModal('${row.brand}', this.value)"
                                    title="Click to set launch fee details"
                                >
                            </div>
                            ${launchFeeDisplay}
                        </div>
                    </td>
                    <td style="text-align: right; font-weight: 600; color: var(--success);">${fmtMoney(row.total)}</td>
                    <td style="text-align: right; color: var(--blue);">${fmtMoney(row.tyler)}</td>
                    <td style="text-align: right; color: var(--purple);">${fmtMoney(row.matt)}</td>
                </tr>
            `}).join('');
            
            // Update footer
            document.getElementById('footerAffiliateGmv').textContent = fmtMoney(totalAffiliateGmv);
            document.getElementById('footerMarketingGmv').textContent = fmtMoney(totalMarketingGmv);
            document.getElementById('footerGmv').textContent = fmtMoney(totalGmv);
            document.getElementById('footerCommission').textContent = fmtMoney(totalCommission);
            document.getElementById('footerRetainer').textContent = fmtMoney(totalRetainers);
            document.getElementById('footerLaunchFee').textContent = fmtMoney(totalLaunchFees);
            document.getElementById('footerTotal').textContent = fmtMoney(totalEarnings);
            document.getElementById('footerTyler').textContent = fmtMoney(totalEarnings / 2);
            document.getElementById('footerMatt').textContent = fmtMoney(totalEarnings / 2);
            
            // Update cached data
            cachedEarningsData.brandRows = brandRows;
            cachedEarningsData.totalCommission = totalCommission;
            cachedEarningsData.totalEarnings = totalEarnings;
            cachedEarningsData.tylerTotal = totalEarnings / 2;
            cachedEarningsData.mattTotal = totalEarnings / 2;
        }
        
        function openCreatorRateModal(brand, creatorName, currentRate) {
            const brandRate = (getRevShareRates()[brand] || 2) / 100;
            const isCustom = currentRate !== brandRate;
            
            const modalHtml = `
                <div id="creatorRateModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;" onclick="if(event.target.id==='creatorRateModal')this.remove()">
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;"></span>
                            Commission Rate
                        </h3>
                        <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">
                            <strong>${creatorName}</strong>  ${BRAND_DISPLAY[brand] || brand}
                        </p>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">
                                Commission Rate (Brand default: ${(brandRate * 100).toFixed(1)}%)
                            </label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="creatorRateInput" value="${(currentRate * 100).toFixed(1)}" 
                                    min="0" max="10" step="0.5"
                                    style="flex: 1; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1.1rem; font-weight: 600;">
                                <span style="color: var(--text-muted); font-size: 1.1rem;">%</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-secondary" style="flex: 1;" onclick="setCreatorRate('${brand}', '${creatorName}', ${brandRate}); document.getElementById('creatorRateModal').remove();">
                                Reset to Default
                            </button>
                            <button class="btn btn-primary" style="flex: 1;" onclick="setCreatorRate('${brand}', '${creatorName}', parseFloat(document.getElementById('creatorRateInput').value) / 100); document.getElementById('creatorRateModal').remove();">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('creatorRateInput').focus();
        }
        
        function renderCreatorBreakdown() {
            const tbody = document.getElementById('creatorBreakdownBody');
            if (!tbody) return;
            
            const creatorGmvByBrand = cachedEarningsData?.creatorGmvByBrand;
            if (!creatorGmvByBrand) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Calculate earnings to see creator breakdown</td></tr>';
                return;
            }
            
            // Get filter
            const selectedBrand = document.getElementById('creatorBreakdownBrand')?.value || 'all';
            
            // Flatten all creators
            let allCreators = [];
            for (const [brand, creators] of Object.entries(creatorGmvByBrand)) {
                if (selectedBrand !== 'all' && brand !== selectedBrand) continue;
                
                for (const creator of Object.values(creators)) {
                    const rate = getCreatorRate(brand, creator.creator_name);
                    const brandRate = (getRevShareRates()[brand] || 2) / 100;
                    const isCustomRate = rate !== brandRate;
                    
                    allCreators.push({
                        ...creator,
                        rate,
                        isCustomRate,
                        commission: creator.gmv * rate
                    });
                }
            }
            
            // Sort by GMV descending
            allCreators.sort((a, b) => b.gmv - a.gmv);
            
            // Calculate totals
            const totalGmv = allCreators.reduce((s, c) => s + c.gmv, 0);
            const totalCommission = allCreators.reduce((s, c) => s + c.commission, 0);
            const customCount = allCreators.filter(c => c.isCustomRate).length;
            
            // Calculate weighted average rate
            const avgRate = totalGmv > 0 ? (totalCommission / totalGmv) : 0.02;
            
            // Update summary
            document.getElementById('cbCreatorCount').textContent = allCreators.length;
            document.getElementById('cbTotalGmv').textContent = fmtMoney(totalGmv);
            document.getElementById('cbAvgRate').textContent = (avgRate * 100).toFixed(1) + '%';
            document.getElementById('cbTotalCommission').textContent = fmtMoney(totalCommission);
            
            // Show/hide custom rate notice
            const noticeEl = document.getElementById('customRateNotice');
            if (noticeEl) {
                noticeEl.style.display = customCount > 0 ? 'block' : 'none';
                document.getElementById('customRateCount').textContent = customCount;
            }
            
            if (allCreators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No creators found for this period</td></tr>';
                return;
            }
            
            // Render table
            tbody.innerHTML = allCreators.map((c, i) => {
                const pctOfTotal = totalGmv > 0 ? ((c.gmv / totalGmv) * 100).toFixed(1) : '0.0';
                const rateClass = c.isCustomRate ? 'custom' : 'standard';
                const rateDisplay = (c.rate * 100).toFixed(1);
                
                return `
                    <tr>
                        <td style="color: ${i < 3 ? 'var(--accent)' : 'var(--text-muted)'}; font-weight: 600;">${i + 1}</td>
                        <td>
                            <div style="font-weight: 500;">${c.creator_name}</div>
                        </td>
                        <td>
                            <span style="display: inline-flex; align-items: center; gap: 6px;">
                                <span style="font-size: 0.9rem;">${BRAND_ICONS[c.brand] || ''}</span>
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">${BRAND_DISPLAY[c.brand] || c.brand}</span>
                            </span>
                        </td>
                        <td style="text-align: right; font-weight: 600; color: var(--accent);">${fmtMoney(c.gmv)}</td>
                        <td style="text-align: right;">${c.orders.toLocaleString()}</td>
                        <td style="text-align: center;">
                            <span class="rate-badge ${rateClass}" 
                                onclick="openCreatorRateModal('${c.brand}', '${c.creator_name.replace(/'/g, "\\'")}', ${c.rate})"
                                title="Click to edit rate">
                                ${rateDisplay}%
                            </span>
                        </td>
                        <td style="text-align: right; color: var(--success); font-weight: 500;">${fmtMoney(c.commission)}</td>
                        <td style="text-align: right; color: var(--text-muted);">${pctOfTotal}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function exportCreatorBreakdownCSV() {
            const creatorGmvByBrand = cachedEarningsData?.creatorGmvByBrand;
            if (!creatorGmvByBrand) {
                showToast('No data to export. Calculate earnings first.', 'error');
                return;
            }
            
            const selectedBrand = document.getElementById('creatorBreakdownBrand')?.value || 'all';
            const monthValue = document.getElementById('revShareMonth')?.value || 'unknown';
            
            // Flatten all creators
            let allCreators = [];
            for (const [brand, creators] of Object.entries(creatorGmvByBrand)) {
                if (selectedBrand !== 'all' && brand !== selectedBrand) continue;
                
                for (const creator of Object.values(creators)) {
                    const rate = getCreatorRate(brand, creator.creator_name);
                    allCreators.push({
                        creator_name: creator.creator_name,
                        brand: BRAND_DISPLAY[brand] || brand,
                        gmv: creator.gmv,
                        orders: creator.orders,
                        rate_percent: (rate * 100).toFixed(1),
                        commission: creator.gmv * rate
                    });
                }
            }
            
            // Sort by GMV
            allCreators.sort((a, b) => b.gmv - a.gmv);
            
            // Build CSV
            const headers = ['Creator', 'Brand', 'GMV', 'Orders', 'Rate %', 'Commission'];
            const rows = allCreators.map(c => [
                c.creator_name,
                c.brand,
                c.gmv.toFixed(2),
                c.orders,
                c.rate_percent,
                c.commission.toFixed(2)
            ]);
            
            // Add totals row
            const totalGmv = allCreators.reduce((s, c) => s + c.gmv, 0);
            const totalCommission = allCreators.reduce((s, c) => s + c.commission, 0);
            rows.push(['TOTAL', '', totalGmv.toFixed(2), '', '', totalCommission.toFixed(2)]);
            
            const csv = [headers, ...rows].map(r => r.map(v => `"${v}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `creator-breakdown-${selectedBrand === 'all' ? 'all-brands' : selectedBrand}-${monthValue}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Creator breakdown exported!', 'success');
        }
        
        async function updateBrandRate(brand, value) {
            const rate = parseFloat(value) || 2.5;
            await saveRevShareRate(brand, rate);
            calculateRevenueShare();
            showToast(`${BRAND_DISPLAY[brand]} commission rate updated to ${rate}%`, 'success');
        }
        
        async function updateBrandRetainer(brand, value) {
            const retainer = parseFloat(value) || 0;
            await saveRetainer(brand, retainer);
            calculateRevenueShare();
            showToast(`${BRAND_DISPLAY[brand]} retainer updated to ${fmtMoney(retainer)}`, 'success');
        }
        
        // Launch Fee Modal
        function openLaunchFeeModal(brand, currentAmount) {
            const launchFee = brandSettingsCache?.launchFees?.[brand] || { amount: 0, name: '', ends: '' };
            const amount = currentAmount !== undefined ? currentAmount : launchFee.amount;
            
            const modalHtml = `
                <div id="launchFeeModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;"></span>
                            Launch Fee - ${BRAND_DISPLAY[brand] || brand}
                        </h3>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Launch/Product Name</label>
                            <input type="text" id="launchFeeName" value="${launchFee.name || ''}" 
                                placeholder="e.g., Fiber Gummies Launch"
                                style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Launch Fee Amount</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: var(--text-muted);">$</span>
                                <input type="number" id="launchFeeAmount" value="${amount}" min="0" max="100000" step="100"
                                    style="flex: 1; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Fee Ends (Leave blank for ongoing)</label>
                            <input type="date" id="launchFeeEnds" value="${launchFee.ends || ''}"
                                style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeLaunchFeeModal()" 
                                style="flex: 1; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="saveLaunchFee('${brand}')" 
                                style="flex: 1; padding: 12px; background: var(--info); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                                Save Launch Fee
                            </button>
                        </div>
                        
                        ${launchFee.amount > 0 ? `
                        <button onclick="clearLaunchFee('${brand}')" 
                            style="width: 100%; margin-top: 12px; padding: 10px; background: transparent; border: 1px solid var(--danger); border-radius: 8px; color: var(--danger); font-weight: 500; cursor: pointer; font-size: 0.85rem;">
                            Remove Launch Fee
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeLaunchFeeModal() {
            document.getElementById('launchFeeModal')?.remove();
        }
        
        async function saveLaunchFee(brand) {
            const name = document.getElementById('launchFeeName')?.value || '';
            const amount = parseFloat(document.getElementById('launchFeeAmount')?.value) || 0;
            const ends = document.getElementById('launchFeeEnds')?.value || null;
            
            try {
                const { error } = await supabaseClient
                    .from('brand_settings')
                    .update({ 
                        launch_fee: amount, 
                        launch_fee_name: name || null,
                        launch_fee_ends: ends,
                        updated_at: new Date().toISOString() 
                    })
                    .eq('brand', brand);
                
                if (error) throw error;
                
                // Update cache
                if (brandSettingsCache) {
                    brandSettingsCache.launchFees[brand] = {
                        amount: amount,
                        name: name,
                        ends: ends,
                        isActive: amount > 0
                    };
                }
                
                closeLaunchFeeModal();
                calculateRevenueShare();
                showToast(`${BRAND_DISPLAY[brand]} launch fee updated`, 'success');
            } catch (err) {
                console.error('Failed to save launch fee:', err);
                showToast('Failed to save: ' + err.message, 'error');
            }
        }
        
        async function clearLaunchFee(brand) {
            try {
                const { error } = await supabaseClient
                    .from('brand_settings')
                    .update({ 
                        launch_fee: 0, 
                        launch_fee_name: null,
                        launch_fee_ends: null,
                        updated_at: new Date().toISOString() 
                    })
                    .eq('brand', brand);
                
                if (error) throw error;
                
                // Update cache
                if (brandSettingsCache) {
                    brandSettingsCache.launchFees[brand] = {
                        amount: 0,
                        name: '',
                        ends: '',
                        isActive: false
                    };
                }
                
                closeLaunchFeeModal();
                calculateRevenueShare();
                showToast(`${BRAND_DISPLAY[brand]} launch fee removed`, 'success');
            } catch (err) {
                console.error('Failed to clear launch fee:', err);
                showToast('Failed to clear: ' + err.message, 'error');
            }
        }
        
        // Marketing GMV storage (per month, per brand) - stays in localStorage since it's per-month data
        function getMarketingGmv(monthKey) {
            try {
                const all = JSON.parse(localStorage.getItem('marketing_gmv') || '{}');
                return all[monthKey] || {};
            } catch {
                return {};
            }
        }
        
        function saveMarketingGmv(monthKey, brand, amount) {
            try {
                const all = JSON.parse(localStorage.getItem('marketing_gmv') || '{}');
                if (!all[monthKey]) all[monthKey] = {};
                all[monthKey][brand] = amount;
                localStorage.setItem('marketing_gmv', JSON.stringify(all));
            } catch (e) {
                console.error('Failed to save marketing GMV:', e);
            }
        }
        
        function updateMarketingGmv(brand, value) {
            const monthKey = document.getElementById('revShareMonth')?.value;
            if (!monthKey) return;
            const amount = parseFloat(value) || 0;
            saveMarketingGmv(monthKey, brand, amount);
            calculateRevenueShare();
            showToast(`${BRAND_DISPLAY[brand]} marketing GMV updated to ${fmtMoney(amount)}`, 'success');
        }
        
        // Goal tracker - uses monthly total earnings from calculateRevenueShare
        const REVENUE_GOAL = 100000;
        
        function updateGoalUI(currentAmount) {
            const percent = Math.min((currentAmount / REVENUE_GOAL) * 100, 100);
            const remaining = Math.max(REVENUE_GOAL - currentAmount, 0);
            
            document.getElementById('goalCurrentAmount').textContent = fmtMoney(currentAmount);
            document.getElementById('goalPercentText').textContent = `${percent.toFixed(1)}% complete`;
            document.getElementById('goalProgressBar').style.width = `${percent}%`;
            
            if (remaining > 0) {
                document.getElementById('goalProgressText').textContent = `${fmtMoney(remaining)} to go`;
            } else {
                document.getElementById('goalProgressText').textContent = ' Goal reached!';
                document.getElementById('goalProgressBar').style.background = 'linear-gradient(90deg, #fbbf24, #f59e0b)';
            }
        }
        
        // Brand icons for display
        const BRAND_ICONS = {
            'catakor': '',
            'jiyu': '',
            'physicians_choice': '',
            'peach_slices': '',
            'yerba_magic': ''
        };

        // ==================== CLIENT REPORT GENERATION ====================
        // Brand logo paths (local files in /logos folder)
        const BRAND_LOGOS = {
            'catakor': 'logos/catakor.png',
            'jiyu': 'logos/jiyu.png',
            'physicians_choice': 'logos/physicians_choice.png',
            'peach_slices': 'logos/peach_slices.png',
            'yerba_magic': 'logos/yerba_magic.png'
        };
        
        // Store uploaded brand logo as base64
        let uploadedBrandLogo = null;
        let clientReportPicker = null;
        
        function handleBrandLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedBrandLogo = e.target.result;
                const img = document.getElementById('brandLogoImg');
                const placeholder = document.getElementById('brandLogoPlaceholder');
                img.src = uploadedBrandLogo;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        function clearBrandLogo() {
            uploadedBrandLogo = null;
            const img = document.getElementById('brandLogoImg');
            const placeholder = document.getElementById('brandLogoPlaceholder');
            img.src = '';
            img.style.display = 'none';
            placeholder.style.display = 'block';
            document.getElementById('brandLogoUpload').value = '';
        }
        
        function openClientReportModal() {
            document.getElementById('clientReportModal').classList.add('show');
            document.getElementById('clientReportPreviewContainer').style.display = 'none';
            
            // Initialize Litepicker for date range
            const el = document.getElementById('clientReportDateRange');
            const startHidden = document.getElementById('clientReportStartDate');
            const endHidden = document.getElementById('clientReportEndDate');
            
            if (!clientReportPicker && el) {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                clientReportPicker = new Litepicker({
                    element: el,
                    singleMode: false,
                    numberOfMonths: 2,
                    numberOfColumns: 2,
                    firstDay: 0,
                    startDate: thirtyDaysAgo,
                    endDate: yesterday,
                    format: 'MMM D, YYYY',
                    delimiter: '  ',
                    autoApply: true,
                    showTooltip: true,
                    tooltipText: { one: 'day', other: 'days' },
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            if (date1 && date2) {
                                startHidden.value = date1.format('YYYY-MM-DD');
                                endHidden.value = date2.format('YYYY-MM-DD');
                                // Set to custom when manually selecting dates
                                document.getElementById('clientReportPeriod').value = 'custom';
                            }
                        });
                    }
                });
                
                // Set initial hidden values
                startHidden.value = localDateStr(thirtyDaysAgo);
                endHidden.value = localDateStr(yesterday);
            }
            
            // Apply default preset (Last 30 Days)
            handleReportPeriodChange();
            
            // Auto-load brand logo
            updateReportBrandLogo();
        }
        
        function handleReportPeriodChange() {
            const period = document.getElementById('clientReportPeriod').value;
            if (period === 'custom' || !clientReportPicker) return;
            
            const today = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'last7':
                    endDate = new Date(today);
                    endDate.setDate(endDate.getDate() - 1);
                    startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - 6);
                    break;
                case 'last14':
                    endDate = new Date(today);
                    endDate.setDate(endDate.getDate() - 1);
                    startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - 13);
                    break;
                case 'last30':
                    endDate = new Date(today);
                    endDate.setDate(endDate.getDate() - 1);
                    startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - 29);
                    break;
                case 'mtd':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today);
                    endDate.setDate(endDate.getDate() - 1);
                    break;
                case 'lastmonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
            }
            
            if (startDate && endDate) {
                clientReportPicker.setDateRange(startDate, endDate);
                document.getElementById('clientReportStartDate').value = localDateStr(startDate);
                document.getElementById('clientReportEndDate').value = localDateStr(endDate);
            }
        }
        
        function toggleCustomDateRange() {
            // Deprecated - using Litepicker now
        }
        
        function updateReportBrandLogo() {
            const brand = document.getElementById('clientReportBrand').value;
            const logoPath = BRAND_LOGOS[brand];
            const img = document.getElementById('brandLogoImg');
            const placeholder = document.getElementById('brandLogoPlaceholder');
            
            if (logoPath) {
                // Load the stored logo
                img.src = logoPath;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                
                // Also convert to base64 for PDF embedding
                fetch(logoPath)
                    .then(res => res.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            uploadedBrandLogo = reader.result;
                        };
                        reader.readAsDataURL(blob);
                    })
                    .catch(() => {
                        // If fetch fails, just show the image directly
                        uploadedBrandLogo = null;
                    });
            } else {
                img.style.display = 'none';
                placeholder.style.display = 'inline';
                placeholder.textContent = 'No logo available';
                uploadedBrandLogo = null;
            }
        }
        
        function closeClientReportModal() {
            document.getElementById('clientReportModal').classList.remove('show');
        }
        
        function getReportDateRange(period) {
            // Always use the hidden date inputs set by Litepicker
            const startStr = document.getElementById('clientReportStartDate').value;
            const endStr = document.getElementById('clientReportEndDate').value;
            
            const startDate = new Date(startStr + 'T00:00:00');
            const endDate = new Date(endStr + 'T00:00:00');
            
            return {
                start: startStr,
                end: endStr,
                display: `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`
            };
        }
        
        async function fetchClientReportData(brand, dateRange) {
            // Calculate prior period for WoW comparison
            const startDate = new Date(dateRange.start + 'T00:00:00');
            const endDate = new Date(dateRange.end + 'T00:00:00');
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const priorEnd = new Date(startDate);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorStart.getDate() - daysDiff + 1);
            const priorStartStr = localDateStr(priorStart);
            const priorEndStr = localDateStr(priorEnd);
            
            // Fetch current period creator performance with pagination
            let allPerfData = [];
            let page = 0;
            let hasMore = true;
            while (hasMore && page < MAX_PAGES) {
                const { data } = await supabaseClient
                    .from('creator_performance')
                    .select('creator_name, gmv, orders, videos, report_date, items_sold, est_commission')
                    .eq('brand', brand)
                    .eq('period_type', 'daily')
                    .gte('report_date', dateRange.start)
                    .lte('report_date', dateRange.end)
                    .range(page * QUERY_PAGE_SIZE, (page + 1) * QUERY_PAGE_SIZE - 1);
                if (!data || data.length === 0) hasMore = false;
                else {
                    allPerfData = allPerfData.concat(data);
                    hasMore = data.length === QUERY_PAGE_SIZE;
                    page++;
                }
            }
            
            // Fetch prior period for comparison
            let priorPerfData = [];
            page = 0;
            hasMore = true;
            while (hasMore && page < MAX_PAGES) {
                const { data } = await supabaseClient
                    .from('creator_performance')
                    .select('creator_name, gmv, orders, videos')
                    .eq('brand', brand)
                    .eq('period_type', 'daily')
                    .gte('report_date', priorStartStr)
                    .lte('report_date', priorEndStr)
                    .range(page * QUERY_PAGE_SIZE, (page + 1) * QUERY_PAGE_SIZE - 1);
                if (!data || data.length === 0) hasMore = false;
                else {
                    priorPerfData = priorPerfData.concat(data);
                    hasMore = data.length === QUERY_PAGE_SIZE;
                    page++;
                }
            }
            
            // Build daily breakdown
            const dailyMap = new Map();
            allPerfData.forEach(row => {
                const date = row.report_date;
                if (!dailyMap.has(date)) {
                    dailyMap.set(date, { date, gmv: 0, orders: 0, videos: 0, creators: new Set() });
                }
                const d = dailyMap.get(date);
                d.gmv += pFloat(row.gmv);
                d.orders += pInt(row.orders);
                d.videos += pInt(row.videos);
                d.creators.add(row.creator_name);
            });
            const dailyBreakdown = [...dailyMap.values()]
                .map(d => ({ ...d, creators: d.creators.size }))
                .sort((a, b) => a.date.localeCompare(b.date));
            
            // Build day of week breakdown
            const dayOfWeekMap = { 0: { day: 'Sun', gmv: 0, orders: 0 }, 1: { day: 'Mon', gmv: 0, orders: 0 }, 2: { day: 'Tue', gmv: 0, orders: 0 }, 3: { day: 'Wed', gmv: 0, orders: 0 }, 4: { day: 'Thu', gmv: 0, orders: 0 }, 5: { day: 'Fri', gmv: 0, orders: 0 }, 6: { day: 'Sat', gmv: 0, orders: 0 } };
            dailyBreakdown.forEach(d => {
                const dayNum = new Date(d.date + 'T00:00:00').getDay();
                dayOfWeekMap[dayNum].gmv += d.gmv;
                dayOfWeekMap[dayNum].orders += d.orders;
            });
            const dayOfWeekBreakdown = Object.values(dayOfWeekMap);
            
            // Aggregate by creator
            const creatorMap = new Map();
            allPerfData.forEach(row => {
                if (!creatorMap.has(row.creator_name)) {
                    creatorMap.set(row.creator_name, { creator_name: row.creator_name, gmv: 0, orders: 0, videos: 0, items_sold: 0, est_commission: 0 });
                }
                const c = creatorMap.get(row.creator_name);
                c.gmv += pFloat(row.gmv);
                c.orders += pInt(row.orders);
                c.videos += pInt(row.videos);
                c.items_sold += pInt(row.items_sold);
                c.est_commission += pFloat(row.est_commission);
            });
            const creators = [...creatorMap.values()].sort((a, b) => b.gmv - a.gmv);
            
            // Calculate prior period totals and track prior creators
            const priorTotals = { gmv: 0, orders: 0, videos: 0, creators: new Set() };
            priorPerfData.forEach(row => {
                priorTotals.gmv += pFloat(row.gmv);
                priorTotals.orders += pInt(row.orders);
                priorTotals.videos += pInt(row.videos);
                priorTotals.creators.add(row.creator_name.toLowerCase());
            });
            
            // Calculate new vs returning creators
            const currentCreatorNames = new Set(creators.map(c => c.creator_name.toLowerCase()));
            let newCreators = 0, returningCreators = 0;
            let newCreatorsGmv = 0, returningCreatorsGmv = 0;
            creators.forEach(c => {
                const isReturning = priorTotals.creators.has(c.creator_name.toLowerCase());
                if (isReturning) {
                    returningCreators++;
                    returningCreatorsGmv += c.gmv;
                } else {
                    newCreators++;
                    newCreatorsGmv += c.gmv;
                }
            });
            
            // Fetch video performance with pagination
            let allVideoData = [];
            page = 0;
            hasMore = true;
            while (hasMore && page < MAX_PAGES) {
                const { data } = await supabaseClient
                    .from('video_performance')
                    .select('video_id, video_title, video_link, creator_name, gmv, orders')
                    .eq('brand', brand)
                    .gte('report_date', dateRange.start)
                    .lte('report_date', dateRange.end)
                    .range(page * QUERY_PAGE_SIZE, (page + 1) * QUERY_PAGE_SIZE - 1);
                if (!data || data.length === 0) hasMore = false;
                else {
                    allVideoData = allVideoData.concat(data);
                    hasMore = data.length === QUERY_PAGE_SIZE;
                    page++;
                }
            }
            
            // Aggregate by video
            const videoMap = new Map();
            allVideoData.forEach(row => {
                if (!videoMap.has(row.video_id)) {
                    videoMap.set(row.video_id, { 
                        video_id: row.video_id, 
                        video_title: row.video_title,
                        video_link: row.video_link,
                        creator_name: row.creator_name, 
                        gmv: 0, 
                        orders: 0 
                    });
                }
                const v = videoMap.get(row.video_id);
                v.gmv += pFloat(row.gmv);
                v.orders += pInt(row.orders);
            });
            const videos = [...videoMap.values()].sort((a, b) => b.gmv - a.gmv);
            
            // Fetch product performance
            const productMap = new Map();
            allVideoData.forEach(row => {
                if (!row.product_name) return;
                if (!productMap.has(row.product_name)) {
                    productMap.set(row.product_name, { product_name: row.product_name, gmv: 0, orders: 0 });
                }
                const p = productMap.get(row.product_name);
                p.gmv += pFloat(row.gmv);
                p.orders += pInt(row.orders);
            });
            const products = [...productMap.values()].sort((a, b) => b.gmv - a.gmv);
            
            // Calculate totals
            const totalGmv = creators.reduce((s, c) => s + c.gmv, 0);
            const totalOrders = creators.reduce((s, c) => s + c.orders, 0);
            const totalVideos = creators.reduce((s, c) => s + c.videos, 0);
            const totalCommission = creators.reduce((s, c) => s + c.est_commission, 0);
            
            // Calculate WoW changes
            const gmvChange = priorTotals.gmv > 0 ? ((totalGmv - priorTotals.gmv) / priorTotals.gmv * 100) : 0;
            const ordersChange = priorTotals.orders > 0 ? ((totalOrders - priorTotals.orders) / priorTotals.orders * 100) : 0;
            const videosChange = priorTotals.videos > 0 ? ((totalVideos - priorTotals.videos) / priorTotals.videos * 100) : 0;
            const creatorsChange = priorTotals.creators.size > 0 ? ((creators.length - priorTotals.creators.size) / priorTotals.creators.size * 100) : 0;
            
            // Fetch roster to determine managed status (check all account fields)
            const { data: rosterData } = await supabaseClient
                .from('managed_creators')
                .select('account_1, account_2, account_3, account_4, account_5')
                .eq('brand', brand);
            
            // Build set of all managed account names (lowercase)
            const managedSet = new Set();
            (rosterData || []).forEach(r => {
                [r.account_1, r.account_2, r.account_3, r.account_4, r.account_5].forEach(acct => {
                    if (acct) managedSet.add(acct.toLowerCase());
                });
            });
            
            // Calculate managed vs unmanaged breakdown
            let managedGmv = 0, unmanagedGmv = 0;
            let managedOrders = 0, unmanagedOrders = 0;
            let managedCreators = 0, unmanagedCreators = 0;
            let managedVideos = 0, unmanagedVideos = 0;
            
            creators.forEach(c => {
                const isManaged = managedSet.has(c.creator_name.toLowerCase());
                if (isManaged) {
                    managedGmv += c.gmv;
                    managedOrders += c.orders;
                    managedVideos += c.videos;
                    managedCreators++;
                } else {
                    unmanagedGmv += c.gmv;
                    unmanagedOrders += c.orders;
                    unmanagedVideos += c.videos;
                    unmanagedCreators++;
                }
            });
            
            return {
                totalGmv,
                totalOrders,
                totalVideos,
                totalCreators: creators.length,
                totalCommission,
                priorGmv: priorTotals.gmv,
                priorOrders: priorTotals.orders,
                priorVideos: priorTotals.videos,
                priorCreators: priorTotals.creators.size,
                gmvChange,
                ordersChange,
                videosChange,
                creatorsChange,
                dailyBreakdown,
                dayOfWeekBreakdown,
                creators: creators.slice(0, 10),
                allCreators: creators,
                videos: videos.slice(0, 10),
                topVideo: videos[0],
                products: products.slice(0, 5),
                avgOrderValue: totalOrders > 0 ? totalGmv / totalOrders : 0,
                avgGmvPerCreator: creators.length > 0 ? totalGmv / creators.length : 0,
                // Managed vs Unmanaged
                managedGmv,
                unmanagedGmv,
                managedOrders,
                unmanagedOrders,
                managedCreators,
                unmanagedCreators,
                managedVideos,
                unmanagedVideos,
                managedPct: totalGmv > 0 ? (managedGmv / totalGmv * 100) : 0,
                // New vs Returning
                newCreators,
                returningCreators,
                newCreatorsGmv,
                returningCreatorsGmv,
                newCreatorsPct: creators.length > 0 ? (newCreators / creators.length * 100) : 0
            };
        }
        
        async function previewClientReport() {
            const brand = document.getElementById('clientReportBrand').value;
            const period = document.getElementById('clientReportPeriod').value;
            const dateRange = getReportDateRange(period);
            
            document.getElementById('clientReportPreviewContainer').style.display = 'block';
            document.getElementById('clientReportPreview').innerHTML = '<p style="text-align: center; color: #666;">Loading data...</p>';
            
            try {
                const data = await fetchClientReportData(brand, dateRange);
                const html = generateClientReportHTML(brand, dateRange, data);
                document.getElementById('clientReportPreview').innerHTML = html;
            } catch (err) {
                document.getElementById('clientReportPreview').innerHTML = '<p style="text-align: center; color: #c00;">Error loading data</p>';
                console.error(err);
            }
        }
        
        function generateClientReportHTML(brand, dateRange, data) {
            const includeExecutiveSummary = document.getElementById('reportIncludeExecutiveSummary').checked;
            const includeSummary = document.getElementById('reportIncludeSummary').checked;
            const includeWoW = document.getElementById('reportIncludeWoW').checked;
            const includeDaily = document.getElementById('reportIncludeDaily').checked;
            const includeCreators = document.getElementById('reportIncludeCreators').checked;
            const includeVideos = document.getElementById('reportIncludeVideos').checked;
            const includeProducts = document.getElementById('reportIncludeProducts').checked;
            const includeManaged = document.getElementById('reportIncludeManaged').checked;
            const includeHighlights = document.getElementById('reportIncludeHighlights').checked;
            const includeNewReturning = document.getElementById('reportIncludeNewReturning').checked;
            const includeDayOfWeek = document.getElementById('reportIncludeDayOfWeek').checked;
            const includeBrandLogo = document.getElementById('reportIncludeBrandLogo').checked;
            const includeAgencyLogo = document.getElementById('reportIncludeAgencyLogo').checked;
            
            // Get logo - use uploaded base64 if available
            const brandLogoUrl = uploadedBrandLogo || '';
            const agencyLogoUrl = 'logo-dark.png';
            
            // Generate executive summary text
            const topCreator = data.creators[0];
            const topVideo = data.videos[0];
            const gmvTrend = data.gmvChange >= 0 ? 'up' : 'down';
            const gmvTrendText = data.gmvChange >= 0 ? 'increase' : 'decrease';
            const bestDay = data.dailyBreakdown.length > 0 ? data.dailyBreakdown.reduce((best, d) => d.gmv > best.gmv ? d : best, { gmv: 0, date: '' }) : { gmv: 0, date: '' };
            const maxDailyGmv = data.dailyBreakdown.length > 0 ? Math.max(...data.dailyBreakdown.map(d => d.gmv)) : 0;
            
            // Helper for change indicator
            const changeIndicator = (val, large = false) => {
                if (val === 0 || isNaN(val)) return '';
                const color = val >= 0 ? '#059669' : '#dc2626';
                const bgColor = val >= 0 ? 'rgba(5, 150, 105, 0.1)' : 'rgba(220, 38, 38, 0.1)';
                const arrow = val >= 0 ? '' : '';
                const size = large ? 'font-size: 16px; padding: 6px 12px;' : 'font-size: 12px; padding: 4px 8px;';
                return `<span style="display: inline-block; ${size} background: ${bgColor}; color: ${color}; font-weight: 600; border-radius: 20px;">${arrow} ${Math.abs(val).toFixed(1)}%</span>`;
            };
            
            // Medal for top 3
            const medal = (i) => {
                if (i === 0) return '<span style="font-size: 18px;"></span>';
                if (i === 1) return '<span style="font-size: 18px;"></span>';
                if (i === 2) return '<span style="font-size: 18px;"></span>';
                return `<span style="display: inline-block; width: 24px; height: 24px; background: #e5e7eb; border-radius: 50%; text-align: center; line-height: 24px; font-size: 12px; font-weight: 600; color: #666;">${i + 1}</span>`;
            };
            
            // Build TikTok creator URL
            const creatorUrl = (name) => `https://www.tiktok.com/@${encodeURIComponent(name)}`;
            
            // Build video URL
            const videoUrl = (v) => {
                if (v.video_link && v.video_link.includes('tiktok.com')) return v.video_link;
                if (v.video_id && v.creator_name) return `https://www.tiktok.com/@${encodeURIComponent(v.creator_name)}/video/${v.video_id}`;
                return null;
            };
            
            // Progress bar helper
            const progressBar = (value, max, color = '#f5c518') => {
                const pct = max > 0 ? (value / max * 100) : 0;
                return `<div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                    <div style="width: ${pct}%; height: 100%; background: ${color}; border-radius: 3px;"></div>
                </div>`;
            };
            
            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 850px; margin: 0 auto; color: #1a1a1a;">
                    
                    <!-- ===== HEADER ===== -->
                    <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 32px; border-radius: 16px; margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
                            ${includeBrandLogo && brandLogoUrl ? `
                            <img src="${brandLogoUrl}" alt="${BRAND_DISPLAY[brand] || brand}" style="max-height: 50px; max-width: 160px; object-fit: contain;">
                            ` : `<div style="font-size: 24px; font-weight: 700;">${BRAND_DISPLAY[brand] || brand}</div>`}
                            ${includeAgencyLogo ? `
                            <div style="text-align: right;">
                                <div style="font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Powered by</div>
                                <img src="${agencyLogoUrl}" alt="Creators Corner" style="max-height: 32px; filter: invert(1) brightness(2);">
                            </div>
                            ` : ''}
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 24px;">
                            <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Performance Report</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">${dateRange.display}</div>
                        </div>
                    </div>
                    
                    ${includeExecutiveSummary ? `
                    <!-- ===== EXECUTIVE SUMMARY ===== -->
                    <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="font-size: 20px;"></span>
                            <span style="font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #92400e;">Executive Summary</span>
                        </div>
                        <div style="color: #78350f; line-height: 1.8; font-size: 15px;">
                            This period, <strong>${BRAND_DISPLAY[brand] || brand}</strong> generated <strong style="color: #059669;">$${data.totalGmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</strong> in GMV 
                            from <strong>${data.totalOrders.toLocaleString()}</strong> orders across <strong>${data.totalCreators.toLocaleString()}</strong> active creators.
                            ${data.priorGmv > 0 ? `This represents a <strong style="color: ${data.gmvChange >= 0 ? '#059669' : '#dc2626'};">${Math.abs(data.gmvChange).toFixed(1)}% ${gmvTrendText}</strong> compared to the prior period.` : ''}
                            ${topCreator ? `<strong>@${topCreator.creator_name}</strong> led the pack with $${topCreator.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} in sales.` : ''}
                            ${bestDay.date ? `Peak performance occurred on <strong>${new Date(bestDay.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</strong> with $${bestDay.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} GMV.` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeHighlights ? `
                    <!-- ===== TOP 3 HIGHLIGHTS ===== -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                        <!-- Top Creator -->
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;"></div>
                            <div style="font-size: 11px; color: #92400e; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Top Creator</div>
                            ${topCreator ? `
                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px;">@${topCreator.creator_name}</div>
                            <div style="font-size: 20px; font-weight: 800; color: #059669;">$${topCreator.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${topCreator.orders} orders  ${topCreator.videos} videos</div>
                            ` : '<div style="color: #6b7280;">No data</div>'}
                        </div>
                        
                        <!-- Top Video -->
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;"></div>
                            <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Top Video</div>
                            ${data.topVideo ? `
                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${(data.topVideo.video_title || 'Untitled').substring(0, 25)}${(data.topVideo.video_title || '').length > 25 ? '...' : ''}</div>
                            <div style="font-size: 20px; font-weight: 800; color: #059669;">$${data.topVideo.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">by @${data.topVideo.creator_name}</div>
                            ` : '<div style="color: #6b7280;">No data</div>'}
                        </div>
                        
                        <!-- Best Day -->
                        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 32px; margin-bottom: 8px;"></div>
                            <div style="font-size: 11px; color: #065f46; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Best Day</div>
                            ${bestDay.date ? `
                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px;">${new Date(bestDay.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                            <div style="font-size: 20px; font-weight: 800; color: #059669;">$${bestDay.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${bestDay.orders} orders</div>
                            ` : '<div style="color: #6b7280;">No data</div>'}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeSummary ? `
                    <!-- ===== HERO STAT ===== -->
                    <div style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 32px; border-radius: 16px; margin-bottom: 24px; text-align: center;">
                        <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.8; margin-bottom: 8px;">Total GMV</div>
                        <div style="font-size: 48px; font-weight: 800; letter-spacing: -1px; margin-bottom: 8px;">$${data.totalGmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                        ${includeWoW && data.priorGmv > 0 ? `
                        <div style="display: inline-block; background: rgba(255,255,255,0.2); padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                            ${data.gmvChange >= 0 ? '' : ''} ${Math.abs(data.gmvChange).toFixed(1)}% vs prior period
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- ===== KEY METRICS ===== -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="font-size: 32px; margin-bottom: 8px;"></div>
                            <div style="font-size: 28px; font-weight: 700; color: #1a1a1a;">${data.totalOrders.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px;">Orders</div>
                            ${includeWoW && data.priorOrders > 0 ? `<div style="margin-top: 8px;">${changeIndicator(data.ordersChange)}</div>` : ''}
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="font-size: 32px; margin-bottom: 8px;"></div>
                            <div style="font-size: 28px; font-weight: 700; color: #1a1a1a;">${data.totalCreators.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px;">Active Creators</div>
                            ${includeWoW && data.priorCreators > 0 ? `<div style="margin-top: 8px;">${changeIndicator(data.creatorsChange)}</div>` : ''}
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="font-size: 32px; margin-bottom: 8px;"></div>
                            <div style="font-size: 28px; font-weight: 700; color: #1a1a1a;">${data.totalVideos.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px;">Videos Posted</div>
                            ${includeWoW && data.priorVideos > 0 ? `<div style="margin-top: 8px;">${changeIndicator(data.videosChange)}</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- ===== SECONDARY METRICS ===== -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">
                        <div style="background: #f9fafb; border-radius: 10px; padding: 16px; text-align: center;">
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">Avg Order Value</div>
                            <div style="font-size: 22px; font-weight: 700; color: #1a1a1a;">$${data.avgOrderValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </div>
                        <div style="background: #f9fafb; border-radius: 10px; padding: 16px; text-align: center;">
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">Avg GMV / Creator</div>
                            <div style="font-size: 22px; font-weight: 700; color: #1a1a1a;">$${data.avgGmvPerCreator.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                        </div>
                        <div style="background: #f9fafb; border-radius: 10px; padding: 16px; text-align: center;">
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">Est. Commission</div>
                            <div style="font-size: 22px; font-weight: 700; color: #1a1a1a;">$${data.totalCommission.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeManaged && (data.managedGmv > 0 || data.unmanagedGmv > 0) ? `
                    <!-- ===== MANAGED VS UNMANAGED ===== -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px;"></span>
                            <span style="font-size: 18px; font-weight: 700;">Managed vs Unmanaged Performance</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 24px; align-items: center;">
                            <!-- Managed Side -->
                            <div style="text-align: center;">
                                <div style="font-size: 12px; font-weight: 600; color: #059669; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;"> Managed</div>
                                <div style="font-size: 36px; font-weight: 800; color: #059669; margin-bottom: 8px;">$${data.managedGmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div style="display: flex; justify-content: center; gap: 16px; font-size: 13px; color: #6b7280;">
                                    <span><strong style="color: #1a1a1a;">${data.managedCreators}</strong> creators</span>
                                    <span><strong style="color: #1a1a1a;">${data.managedOrders.toLocaleString()}</strong> orders</span>
                                </div>
                            </div>
                            
                            <!-- Donut Chart Visual -->
                            <div style="position: relative; width: 140px; height: 140px;">
                                <svg viewBox="0 0 36 36" style="width: 140px; height: 140px; transform: rotate(-90deg);">
                                    <!-- Background circle -->
                                    <circle cx="18" cy="18" r="15.9" fill="none" stroke="#e5e7eb" stroke-width="3"></circle>
                                    <!-- Managed portion (green) -->
                                    <circle cx="18" cy="18" r="15.9" fill="none" stroke="#059669" stroke-width="3" 
                                        stroke-dasharray="${data.managedPct} ${100 - data.managedPct}" stroke-linecap="round"></circle>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 24px; font-weight: 800; color: #059669;">${data.managedPct.toFixed(0)}%</div>
                                    <div style="font-size: 10px; color: #6b7280; text-transform: uppercase;">Managed</div>
                                </div>
                            </div>
                            
                            <!-- Unmanaged Side -->
                            <div style="text-align: center;">
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">Unmanaged</div>
                                <div style="font-size: 36px; font-weight: 800; color: #6b7280; margin-bottom: 8px;">$${data.unmanagedGmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div style="display: flex; justify-content: center; gap: 16px; font-size: 13px; color: #6b7280;">
                                    <span><strong style="color: #1a1a1a;">${data.unmanagedCreators}</strong> creators</span>
                                    <span><strong style="color: #1a1a1a;">${data.unmanagedOrders.toLocaleString()}</strong> orders</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div style="margin-top: 20px;">
                            <div style="height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; display: flex;">
                                <div style="width: ${data.managedPct}%; background: linear-gradient(90deg, #059669, #10b981); transition: width 0.3s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                                <span style="color: #059669; font-weight: 600;"> ${data.managedPct.toFixed(1)}% Managed</span>
                                <span style="color: #6b7280;">${(100 - data.managedPct).toFixed(1)}% Unmanaged</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeNewReturning ? `
                    <!-- ===== NEW VS RETURNING CREATORS ===== -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px;"></span>
                            <span style="font-size: 18px; font-weight: 700;">New vs Returning Creators</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- New Creators -->
                            <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 12px; font-weight: 600; color: #059669; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;"> New This Period</div>
                                <div style="font-size: 36px; font-weight: 800; color: #059669; margin-bottom: 4px;">${data.newCreators}</div>
                                <div style="font-size: 13px; color: #065f46;">creators (${data.newCreatorsPct.toFixed(0)}%)</div>
                                <div style="font-size: 18px; font-weight: 700; color: #059669; margin-top: 12px;">$${data.newCreatorsGmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div style="font-size: 11px; color: #6b7280;">GMV from new creators</div>
                            </div>
                            
                            <!-- Returning Creators -->
                            <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 12px; font-weight: 600; color: #2563eb; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;"> Returning</div>
                                <div style="font-size: 36px; font-weight: 800; color: #2563eb; margin-bottom: 4px;">${data.returningCreators}</div>
                                <div style="font-size: 13px; color: #1e40af;">creators (${(100 - data.newCreatorsPct).toFixed(0)}%)</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2563eb; margin-top: 12px;">$${data.returningCreatorsGmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div style="font-size: 11px; color: #6b7280;">GMV from returning creators</div>
                            </div>
                        </div>
                        
                        <!-- Comparison Bar -->
                        <div style="margin-top: 16px;">
                            <div style="height: 10px; background: #dbeafe; border-radius: 5px; overflow: hidden; display: flex;">
                                <div style="width: ${data.newCreatorsPct}%; background: linear-gradient(90deg, #059669, #10b981);"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: #6b7280;">
                                <span>New: ${data.newCreatorsPct.toFixed(1)}%</span>
                                <span>Returning: ${(100 - data.newCreatorsPct).toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeDayOfWeek && data.dayOfWeekBreakdown ? `
                    <!-- ===== DAY OF WEEK PERFORMANCE ===== -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px;"></span>
                            <span style="font-size: 18px; font-weight: 700;">Performance by Day of Week</span>
                        </div>
                        
                        <div style="display: flex; gap: 8px; align-items: flex-end; height: 140px;">
                            ${(() => {
                                const maxDowGmv = Math.max(...data.dayOfWeekBreakdown.map(d => d.gmv));
                                return data.dayOfWeekBreakdown.map((d, i) => {
                                    const height = maxDowGmv > 0 ? (d.gmv / maxDowGmv * 100) : 0;
                                    const isMax = d.gmv === maxDowGmv && d.gmv > 0;
                                    const isWeekend = i === 0 || i === 6;
                                    return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                        <div style="font-size: 11px; font-weight: 600; color: ${isMax ? '#059669' : '#6b7280'};">$${(d.gmv/1000).toFixed(1)}k</div>
                                        <div style="width: 100%; height: ${Math.max(height, 8)}%; background: ${isMax ? 'linear-gradient(180deg, #059669, #047857)' : isWeekend ? 'linear-gradient(180deg, #8b5cf6, #7c3aed)' : 'linear-gradient(180deg, #3b82f6, #2563eb)'}; border-radius: 6px 6px 0 0; min-height: 8px;"></div>
                                        <div style="font-size: 12px; font-weight: 600; color: ${isMax ? '#059669' : isWeekend ? '#7c3aed' : '#1a1a1a'};">${d.day}</div>
                                    </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                        
                        <div style="display: flex; justify-content: center; gap: 24px; margin-top: 16px; font-size: 12px;">
                            <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; background: #3b82f6; border-radius: 3px;"></span> Weekday</span>
                            <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 3px;"></span> Weekend</span>
                            <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; background: #059669; border-radius: 3px;"></span> Best Day</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeDaily && data.dailyBreakdown.length > 0 ? `
                    <!-- ===== DAILY BREAKDOWN ===== -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px;"></span>
                            <span style="font-size: 18px; font-weight: 700;">Daily Performance</span>
                        </div>
                        
                        <!-- Visual Bar Chart -->
                        <div style="display: flex; align-items: flex-end; gap: 8px; height: 120px; margin-bottom: 24px; padding: 0 4px;">
                            ${data.dailyBreakdown.map((d, i) => {
                                const height = maxDailyGmv > 0 ? (d.gmv / maxDailyGmv * 100) : 0;
                                const isMax = d.gmv === maxDailyGmv;
                                const dayLabel = new Date(d.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short' });
                                return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                    <div style="font-size: 10px; font-weight: 600; color: ${isMax ? '#059669' : '#6b7280'};">$${(d.gmv/1000).toFixed(1)}k</div>
                                    <div style="width: 100%; height: ${Math.max(height, 5)}%; background: ${isMax ? 'linear-gradient(180deg, #059669, #047857)' : 'linear-gradient(180deg, #f5c518, #eab308)'}; border-radius: 4px 4px 0 0; min-height: 4px;"></div>
                                    <div style="font-size: 10px; color: #6b7280; font-weight: 500;">${dayLabel}</div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Data Table -->
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="text-align: left; padding: 12px 8px; font-weight: 600; color: #6b7280; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px;">Date</th>
                                    <th style="text-align: right; padding: 12px 8px; font-weight: 600; color: #6b7280; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px;">GMV</th>
                                    <th style="text-align: right; padding: 12px 8px; font-weight: 600; color: #6b7280; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px;">Orders</th>
                                    <th style="text-align: right; padding: 12px 8px; font-weight: 600; color: #6b7280; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px;">Creators</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.dailyBreakdown.map((d, i) => {
                                    const isMax = d.gmv === maxDailyGmv;
                                    return `
                                    <tr style="border-bottom: 1px solid #f3f4f6; ${isMax ? 'background: #f0fdf4;' : i % 2 === 0 ? 'background: #fafafa;' : ''}">
                                        <td style="padding: 12px 8px; font-weight: 500;">${new Date(d.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} ${isMax ? '<span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px;">PEAK</span>' : ''}</td>
                                        <td style="text-align: right; padding: 12px 8px; font-weight: 600; color: #059669;">$${d.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                        <td style="text-align: right; padding: 12px 8px;">${d.orders.toLocaleString()}</td>
                                        <td style="text-align: right; padding: 12px 8px;">${d.creators.toLocaleString()}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                    
                    ${includeCreators && data.creators.length > 0 ? `
                    <!-- ===== TOP CREATORS ===== -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px;"></span>
                            <span style="font-size: 18px; font-weight: 700;">Top Performing Creators</span>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${data.creators.map((c, i) => {
                                const pctOfTotal = data.totalGmv > 0 ? (c.gmv / data.totalGmv * 100) : 0;
                                return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${i < 3 ? '#fffbeb' : '#f9fafb'}; border-radius: 10px; ${i < 3 ? 'border: 1px solid #fde68a;' : ''}">
                                    <div style="width: 36px; text-align: center;">${medal(i)}</div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <a href="${creatorUrl(c.creator_name)}" target="_blank" style="font-weight: 600; color: #1a1a1a; text-decoration: none; font-size: 14px;">@${c.creator_name}</a>
                                            <span style="font-size: 11px; color: #6b7280;">${c.videos} videos</span>
                                        </div>
                                        ${progressBar(c.gmv, data.creators[0].gmv, i < 3 ? '#f5c518' : '#d1d5db')}
                                    </div>
                                    <div style="text-align: right; min-width: 100px;">
                                        <div style="font-size: 16px; font-weight: 700; color: #059669;">$${c.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                        <div style="font-size: 11px; color: #6b7280;">${pctOfTotal.toFixed(1)}% of total</div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeVideos && data.videos.length > 0 ? `
                    <!-- ===== TOP VIDEOS ===== -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px;"></span>
                            <span style="font-size: 18px; font-weight: 700;">Top Performing Videos</span>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${data.videos.slice(0, 10).map((v, i) => {
                                const vUrl = videoUrl(v);
                                const title = v.video_title || 'Untitled Video';
                                const displayTitle = title.length > 60 ? title.substring(0, 60) + '...' : title;
                                return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${i % 2 === 0 ? '#f9fafb' : 'white'}; border-radius: 10px;">
                                    <div style="width: 28px; text-align: center;">${medal(i)}</div>
                                    <div style="flex: 1; min-width: 0;">
                                        ${vUrl ? `<a href="${vUrl}" target="_blank" style="font-weight: 500; color: #1a1a1a; text-decoration: none; font-size: 13px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${displayTitle}</a>` : `<span style="font-size: 13px; color: #1a1a1a;">${displayTitle}</span>`}
                                        <a href="${creatorUrl(v.creator_name)}" target="_blank" style="font-size: 12px; color: #6b7280; text-decoration: none;">@${v.creator_name}</a>
                                    </div>
                                    <div style="text-align: right; min-width: 80px;">
                                        <div style="font-size: 15px; font-weight: 700; color: #059669;">$${v.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${includeProducts && data.products.length > 0 ? `
                    <!-- ===== TOP PRODUCTS ===== -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <span style="font-size: 24px;"></span>
                            <span style="font-size: 18px; font-weight: 700;">Top Products</span>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${data.products.map((p, i) => `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${i % 2 === 0 ? '#f9fafb' : 'white'}; border-radius: 10px;">
                                    <div style="width: 28px; text-align: center; font-weight: 700; color: ${i < 3 ? '#f5c518' : '#9ca3af'};">${i + 1}</div>
                                    <div style="flex: 1; font-size: 13px; font-weight: 500; color: #1a1a1a;">${p.product_name}</div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: 700; color: #059669;">$${p.gmv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                        <div style="font-size: 11px; color: #6b7280;">${p.orders.toLocaleString()} orders</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ===== FOOTER ===== -->
                    <div style="text-align: center; padding: 24px; border-top: 1px solid #e5e7eb; color: #9ca3af; font-size: 12px;">
                        <div style="margin-bottom: 8px;">Report generated ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        ${includeAgencyLogo ? '<div style="font-weight: 500; color: #6b7280;">Creators Corner  TikTok Shop Creator Marketing</div>' : ''}
                    </div>
                </div>
            `;
        }
        
        async function generateClientReport() {
            const brand = document.getElementById('clientReportBrand').value;
            const period = document.getElementById('clientReportPeriod').value;
            const dateRange = getReportDateRange(period);
            
            showToast('Generating report...', 'info');
            
            try {
                const data = await fetchClientReportData(brand, dateRange);
                const html = generateClientReportHTML(brand, dateRange, data);
                
                // Open in new window (user can Ctrl+P > Save as PDF to preserve links)
                const printWindow = window.open('', '_blank');
                printWindow.document.write(
                    '<!DOCTYPE html>' +
                    '<html>' +
                    '<head>' +
                    '<meta charset="UTF-8">' +
                    '<title>' + (BRAND_DISPLAY[brand] || brand) + ' Performance Report - ' + dateRange.display + '</title>' +
                    '<style>' +
                    'body { margin: 0; padding: 40px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }' +
                    '@media print { ' +
                    '  body { padding: 20px; }' +
                    '  .no-print { display: none !important; }' +
                    '  a { color: #059669 !important; text-decoration: underline !important; }' +
                    '}' +
                    '</style>' +
                    '</head>' +
                    '<body>' +
                    '<div class="no-print" style="background: #1a1a1a; color: white; padding: 16px 24px; margin: -40px -40px 24px -40px; display: flex; justify-content: space-between; align-items: center;">' +
                    '  <span> <strong>To save as PDF with clickable links:</strong> Press <kbd style="background: #333; padding: 4px 8px; border-radius: 4px; margin: 0 4px;">Ctrl+P</kbd> (or <kbd style="background: #333; padding: 4px 8px; border-radius: 4px; margin: 0 4px;">+P</kbd>)  Select "Save as PDF"</span>' +
                    '  <button onclick="window.print()" style="background: #f5c518; color: #1a1a1a; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;"> Print / Save PDF</button>' +
                    '</div>' +
                    html +
                    '</body>' +
                    '</html>'
                );
                printWindow.document.close();
                
                showToast('Report opened in new tab!', 'success');
                closeClientReportModal();
            } catch (err) {
                showToast('Error generating report: ' + err.message, 'error');
                console.error(err);
            }
        }

        // ==================== INVOICE GENERATION ====================
        let cachedEarningsData = null;
        
        function openInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('show');
            previewInvoice();
        }
        
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.remove('show');
        }
        
        function exportEarningsSummary() {
            if (!cachedEarningsData) {
                showToast('Please calculate earnings first', 'error');
                return;
            }
            
            const month = document.getElementById('revShareMonth')?.value || 'unknown';
            const rows = [
                ['Brand', 'Affiliate GMV', 'Marketing GMV', 'Total GMV', 'Commission %', 'Commission', 'Base Retainer', 'Launch Fee', 'Launch Name', 'Total', 'Tyler (50%)', 'Matt (50%)'],
                ...cachedEarningsData.brandRows.map(r => [
                    BRAND_DISPLAY[r.brand] || r.brand,
                    r.affiliateGmv.toFixed(2),
                    r.marketingGmv.toFixed(2),
                    r.gmv.toFixed(2),
                    r.rate + '%',
                    r.commission.toFixed(2),
                    r.retainer.toFixed(2),
                    r.launchFee.amount.toFixed(2),
                    r.launchFee.name || '',
                    r.total.toFixed(2),
                    r.tyler.toFixed(2),
                    r.matt.toFixed(2)
                ]),
                [],
                ['TOTAL', cachedEarningsData.totalAffiliateGmv.toFixed(2), cachedEarningsData.totalMarketingGmv.toFixed(2), cachedEarningsData.totalGmv.toFixed(2), '', cachedEarningsData.totalCommission.toFixed(2), cachedEarningsData.totalRetainers.toFixed(2), cachedEarningsData.totalLaunchFees.toFixed(2), '', cachedEarningsData.totalEarnings.toFixed(2), cachedEarningsData.tylerTotal.toFixed(2), cachedEarningsData.mattTotal.toFixed(2)]
            ];
            
            const csv = rows.map(row => row.join(',')).join('\n');
            downloadCSV(csv, `earnings-summary-${month}.csv`);
            showToast('Earnings summary exported!', 'success');
        }
        
        async function previewInvoice() {
            if (!cachedEarningsData) {
                document.getElementById('invoicePreview').innerHTML = '<p style="text-align: center; color: #666;">Please calculate earnings first</p>';
                return;
            }
            
            // Get first selected brand for preview
            const brandMap = {
                'catakor': 'invoiceCatakor',
                'jiyu': 'invoiceJiyu',
                'physicians_choice': 'invoicePC',
                'peach_slices': 'invoicePeach',
                'yerba_magic': 'invoiceYerba'
            };
            
            let previewBrand = null;
            for (const [brand, checkboxId] of Object.entries(brandMap)) {
                if (document.getElementById(checkboxId)?.checked) {
                    previewBrand = brand;
                    break;
                }
            }
            
            if (!previewBrand) {
                document.getElementById('invoicePreview').innerHTML = '<p style="text-align: center; color: #666;">Select at least one brand</p>';
                return;
            }
            
            const invoiceHtml = await generateInvoiceHTML(previewBrand);
            document.getElementById('invoicePreview').innerHTML = invoiceHtml;
        }
        
        async function generateInvoiceHTML(brand) {
            const monthValue = document.getElementById('revShareMonth')?.value;
            if (!monthValue || !cachedEarningsData) return '<p>No data available</p>';
            
            const [year, month] = monthValue.split('-').map(Number);
            const monthName = new Date(year, month - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
            const invoiceDate = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const invoiceNum = `INV-${year}${String(month).padStart(2, '0')}-${brand.substring(0, 3).toUpperCase()}`;
            
            const brandData = cachedEarningsData.brandRows.find(r => r.brand === brand);
            if (!brandData) return '<p>No data for this brand</p>';
            
            // Get top creators for this brand
            const topCreators = cachedEarningsData.topCreatorsByBrand?.[brand] || [];
            
            // Check for custom rates in this brand
            const brandCreators = cachedEarningsData.creatorGmvByBrand?.[brand] || {};
            const brandRate = (getRevShareRates()[brand] || 2) / 100;
            const creatorsWithCustomRates = Object.values(brandCreators)
                .map(c => ({
                    ...c,
                    rate: getCreatorRate(brand, c.creator_name),
                    commission: c.gmv * getCreatorRate(brand, c.creator_name)
                }))
                .filter(c => Math.abs(c.rate - brandRate) > 0.001)
                .sort((a, b) => b.gmv - a.gmv);
            
            const hasCustomRates = creatorsWithCustomRates.length > 0;
            
            return `
                <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 3px solid #f5c518; padding-bottom: 20px;">
                        <div>
                            <div style="font-size: 28px; font-weight: 700; color: #f5c518; margin-bottom: 4px;">CREATORS CORNER</div>
                            <div style="color: #666; font-size: 14px;">Creator Marketing Agency</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; font-weight: 700; color: #1a1a1a;">INVOICE</div>
                            <div style="color: #666; font-size: 14px;">${invoiceNum}</div>
                        </div>
                    </div>
                    
                    <!-- Bill To & Invoice Details -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
                        <div>
                            <div style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 8px;">Bill To</div>
                            <div style="font-size: 18px; font-weight: 600; color: #1a1a1a;">${BRAND_DISPLAY[brand] || brand}</div>
                            <div style="color: #666; font-size: 14px;">TikTok Shop Partner</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="margin-bottom: 8px;">
                                <span style="color: #888; font-size: 12px;">Invoice Date:</span>
                                <span style="color: #1a1a1a; font-weight: 500; margin-left: 8px;">${invoiceDate}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="color: #888; font-size: 12px;">Period:</span>
                                <span style="color: #1a1a1a; font-weight: 500; margin-left: 8px;">${monthName}</span>
                            </div>
                            <div>
                                <span style="color: #888; font-size: 12px;">Due Date:</span>
                                <span style="color: #1a1a1a; font-weight: 500; margin-left: 8px;">Upon Receipt</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Summary -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                        <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 16px;"> Performance Summary</div>
                        <div style="display: grid; grid-template-columns: repeat(${brandData.marketingGmv > 0 ? '4' : '3'}, 1fr); gap: 16px; text-align: center;">
                            <div>
                                <div style="font-size: 12px; color: #888; margin-bottom: 4px;">Affiliate GMV</div>
                                <div style="font-size: 20px; font-weight: 700; color: #1a1a1a;">$${brandData.affiliateGmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            </div>
                            ${brandData.marketingGmv > 0 ? `
                            <div>
                                <div style="font-size: 12px; color: #888; margin-bottom: 4px;">Marketing GMV</div>
                                <div style="font-size: 20px; font-weight: 700; color: #7c3aed;">$${brandData.marketingGmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                            </div>
                            ` : ''}
                            <div>
                                <div style="font-size: 12px; color: #888; margin-bottom: 4px;">Active Creators</div>
                                <div style="font-size: 20px; font-weight: 700; color: #1a1a1a;">${topCreators.length || ''}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #888; margin-bottom: 4px;">Effective Rate</div>
                                <div style="font-size: 20px; font-weight: 700; color: #1a1a1a;">${brandData.effectiveRate.toFixed(2)}%</div>
                            </div>
                        </div>
                        ${brandData.marketingGmv > 0 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; text-align: center;">
                            <span style="font-size: 12px; color: #888;">Total Managed GMV:</span>
                            <span style="font-size: 16px; font-weight: 700; color: #1a1a1a; margin-left: 8px;">$${brandData.gmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Line Items -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e5e7eb;">
                                <th style="text-align: left; padding: 12px 0; font-size: 12px; color: #888; text-transform: uppercase;">Description</th>
                                <th style="text-align: right; padding: 12px 0; font-size: 12px; color: #888; text-transform: uppercase;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${brandData.affiliateGmv > 0 ? `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 16px 0;">
                                    <div style="font-weight: 500; color: #1a1a1a;">Affiliate Creator Commission</div>
                                    <div style="font-size: 13px; color: #666;">${topCreators.length} creators  ${Math.abs(brandData.effectiveRate - brandData.rate) > 0.01 
                                        ? `Variable rates (avg ${(topCreators.reduce((s, c) => s + (c.gmv * getCreatorRate(brand, c.creator_name)), 0) / brandData.affiliateGmv * 100).toFixed(2)}%)`
                                        : `${brandData.rate}%`
                                    } on $${brandData.affiliateGmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} GMV</div>
                                </td>
                                <td style="text-align: right; padding: 16px 0; font-weight: 500; color: #1a1a1a;">$${topCreators.reduce((s, c) => s + (c.gmv * getCreatorRate(brand, c.creator_name)), 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                            ` : ''}
                            ${brandData.marketingGmv > 0 ? `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 16px 0;">
                                    <div style="font-weight: 500; color: #1a1a1a;">Marketing Account Commission</div>
                                    <div style="font-size: 13px; color: #666;">1% on $${brandData.marketingGmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} marketing GMV</div>
                                </td>
                                <td style="text-align: right; padding: 16px 0; font-weight: 500; color: #1a1a1a;">$${(brandData.marketingGmv * 0.01).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                            ` : ''}
                            ${brandData.retainer > 0 ? `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 16px 0;">
                                    <div style="font-weight: 500; color: #1a1a1a;">Monthly Retainer</div>
                                    <div style="font-size: 13px; color: #666;">Creator management & support services</div>
                                </td>
                                <td style="text-align: right; padding: 16px 0; font-weight: 500; color: #1a1a1a;">$${brandData.retainer.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                            ` : ''}
                            ${brandData.launchFee?.amount > 0 ? `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 16px 0;">
                                    <div style="font-weight: 500; color: #1a1a1a;">Launch Fee</div>
                                    <div style="font-size: 13px; color: #666;">${brandData.launchFee.name || 'Product launch support'}</div>
                                </td>
                                <td style="text-align: right; padding: 16px 0; font-weight: 500; color: #1a1a1a;">$${brandData.launchFee.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                            ` : ''}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td style="padding: 20px 0; font-size: 18px; font-weight: 700; color: #1a1a1a;">Total Due</td>
                                <td style="text-align: right; padding: 20px 0; font-size: 24px; font-weight: 700; color: #16a34a;">$${brandData.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    ${topCreators.length > 0 || brandData.marketingGmv > 0 ? `
                    <!-- All Creators Breakdown -->
                    <div style="margin-bottom: 30px;">
                        <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;"> GMV Breakdown</div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="text-align: left; padding: 6px 10px; color: #666;">#</th>
                                    <th style="text-align: left; padding: 6px 10px; color: #666;">Source</th>
                                    <th style="text-align: right; padding: 6px 10px; color: #666;">GMV</th>
                                    <th style="text-align: center; padding: 6px 10px; color: #666;">Rate</th>
                                    <th style="text-align: right; padding: 6px 10px; color: #666;">Commission</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topCreators.map((c, i) => {
                                    const creatorRate = getCreatorRate(brand, c.creator_name);
                                    const creatorCommission = c.gmv * creatorRate;
                                    const isCustom = Math.abs(creatorRate - brandRate) > 0.001;
                                    return `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 6px 10px; color: #888;">${i + 1}</td>
                                        <td style="padding: 6px 10px; color: #1a1a1a;">@${c.creator_name}</td>
                                        <td style="text-align: right; padding: 6px 10px; color: #1a1a1a;">$${c.gmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: center; padding: 6px 10px; color: ${isCustom ? '#f59e0b' : '#666'}; font-weight: ${isCustom ? '600' : '400'};">${(creatorRate * 100).toFixed(1)}%</td>
                                        <td style="text-align: right; padding: 6px 10px; font-weight: 500; color: #16a34a;">$${creatorCommission.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    </tr>
                                `}).join('')}
                                ${brandData.marketingGmv > 0 ? `
                                <tr style="border-bottom: 1px solid #e5e7eb; background: #f5f3ff;">
                                    <td style="padding: 6px 10px; color: #7c3aed;"></td>
                                    <td style="padding: 6px 10px; color: #7c3aed; font-weight: 500;">Marketing Account</td>
                                    <td style="text-align: right; padding: 6px 10px; color: #7c3aed; font-weight: 500;">$${brandData.marketingGmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="text-align: center; padding: 6px 10px; color: #7c3aed;">1.0%</td>
                                    <td style="text-align: right; padding: 6px 10px; font-weight: 500; color: #7c3aed;">$${(brandData.marketingGmv * 0.01).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                                ` : ''}
                            </tbody>
                            <tfoot>
                                <tr style="background: #f0fdf4; font-weight: 600;">
                                    <td colspan="2" style="padding: 8px 10px; color: #1a1a1a;">TOTAL${brandData.marketingGmv > 0 ? ` (${topCreators.length} creators + marketing)` : ` (${topCreators.length} creators)`}</td>
                                    <td style="text-align: right; padding: 8px 10px; color: #1a1a1a;">$${brandData.gmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="text-align: center; padding: 8px 10px; color: #666;">${brandData.effectiveRate.toFixed(2)}%</td>
                                    <td style="text-align: right; padding: 8px 10px; color: #16a34a;">$${brandData.commission.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    ` : ''}
                    
                    ${hasCustomRates ? `
                    <!-- Custom Rates Summary -->
                    <div style="margin-bottom: 30px; padding: 12px 16px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px;">
                        <div style="font-size: 13px; font-weight: 600; color: #92400e; margin-bottom: 8px;"> Custom Rate Summary</div>
                        <div style="font-size: 12px; color: #78350f;">
                            ${creatorsWithCustomRates.length} creator(s) have adjusted rates (highlighted in orange above). 
                            Standard rate: ${(brandRate * 100).toFixed(1)}%
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Footer -->
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; color: #888; font-size: 13px;">
                        <p style="margin-bottom: 8px;">Thank you for partnering with Creators Corner!</p>
                        <p>Questions? Contact us at creators.corner.agency@gmail.com</p>
                    </div>
                </div>
            `;
        }
        
        async function generateAllInvoices() {
            if (!cachedEarningsData) {
                showToast('Please calculate earnings first', 'error');
                return;
            }
            
            const brandMap = {
                'catakor': 'invoiceCatakor',
                'jiyu': 'invoiceJiyu',
                'physicians_choice': 'invoicePC',
                'peach_slices': 'invoicePeach',
                'yerba_magic': 'invoiceYerba'
            };
            
            const selectedBrands = [];
            for (const [brand, checkboxId] of Object.entries(brandMap)) {
                if (document.getElementById(checkboxId)?.checked) {
                    selectedBrands.push(brand);
                }
            }
            
            if (selectedBrands.length === 0) {
                showToast('Select at least one brand', 'error');
                return;
            }
            
            // Generate invoices for each selected brand
            for (const brand of selectedBrands) {
                const invoiceHtml = await generateInvoiceHTML(brand);
                const monthValue = document.getElementById('revShareMonth')?.value || 'unknown';
                
                // Create a printable window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(
                    '<!DOCTYPE html>' +
                    '<html>' +
                    '<head>' +
                    '<title>Invoice - ' + (BRAND_DISPLAY[brand] || brand) + ' - ' + monthValue + '</title>' +
                    '<style>body { margin: 0; padding: 20px; } @media print { body { padding: 0; } }</style>' +
                    '</head>' +
                    '<body>' +
                    invoiceHtml +
                    '<script>window.onload = function() { window.print(); }</' + 'script>' +
                    '</body>' +
                    '</html>'
                );
                printWindow.document.close();
            }
            
            showToast(`Generated ${selectedBrands.length} invoice(s)`, 'success');
            closeInvoiceModal();
        }

        // ==================== NOTIFICATION CENTER ====================
        let notifications = [];
        let notificationFilter = 'all';
        
        function toggleNotificationCenter(event) {
            event.stopPropagation();
            const center = document.getElementById('notificationCenter');
            center.classList.toggle('show');
            
            if (center.classList.contains('show')) {
                loadNotifications();
            }
        }
        
        function closeNotificationCenter() {
            document.getElementById('notificationCenter')?.classList.remove('show');
        }
        
        // Close notification center when clicking outside
        document.addEventListener('click', (e) => {
            const center = document.getElementById('notificationCenter');
            const bell = document.getElementById('notificationBell');
            if (center && !center.contains(e.target) && !bell?.contains(e.target)) {
                center.classList.remove('show');
            }
        });
        
        async function loadNotifications() {
            try {
                // Generate notifications from various sources
                notifications = [];
                
                // 1. Get pending applications
                const { data: pendingApps } = await supabaseClient
                    .from('creator_applications')
                    .select('id, full_name, brand, created_at')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (pendingApps) {
                    pendingApps.forEach(app => {
                        notifications.push({
                            id: `app-${app.id}`,
                            type: 'application',
                            icon: '',
                            iconClass: 'application',
                            title: 'New Application',
                            message: `${app.full_name} applied for ${BRAND_DISPLAY[app.brand] || app.brand}`,
                            time: app.created_at,
                            action: () => { switchView('applications'); closeNotificationCenter(); },
                            read: false
                        });
                    });
                }
                
                // 2. Get pending payments
                const { data: pendingPayments } = await supabaseClient
                    .from('payment_status')
                    .select('id, creator_handle, amount, created_at')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (pendingPayments) {
                    const totalPending = pendingPayments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
                    if (pendingPayments.length > 0) {
                        notifications.push({
                            id: 'payments-pending',
                            type: 'alert',
                            icon: '',
                            iconClass: 'payment',
                            title: 'Payments Pending',
                            message: `${pendingPayments.length} payments (${fmtMoney(totalPending)}) need processing`,
                            time: pendingPayments[0].created_at,
                            action: () => { switchView('payments'); closeNotificationCenter(); },
                            read: false
                        });
                    }
                }
                
                // 3. Check for recent wins (top performers in last 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const { data: recentWins } = await supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv')
                    .gte('report_date', sevenDaysAgo.toISOString().split('T')[0])
                    .order('gmv', { ascending: false })
                    .limit(3);
                
                if (recentWins && recentWins.length > 0) {
                    const topCreator = recentWins[0];
                    if (topCreator.gmv >= 1000) {
                        notifications.push({
                            id: `win-${topCreator.creator_name}`,
                            type: 'win',
                            icon: '',
                            iconClass: 'win',
                            title: 'Top Performer!',
                            message: `${topCreator.creator_name} hit ${fmtMoney(topCreator.gmv)} GMV this week`,
                            time: new Date().toISOString(),
                            action: () => { switchView('creators'); closeNotificationCenter(); },
                            read: false
                        });
                    }
                }
                
                // 4. Check for payment issues
                const { data: paymentIssues } = await supabaseClient
                    .from('payment_status')
                    .select('id, creator_handle, amount')
                    .eq('status', 'issue')
                    .limit(5);
                
                if (paymentIssues && paymentIssues.length > 0) {
                    notifications.push({
                        id: 'payment-issues',
                        type: 'alert',
                        icon: '',
                        iconClass: 'alert',
                        title: 'Payment Issues',
                        message: `${paymentIssues.length} payment(s) flagged with issues`,
                        time: new Date().toISOString(),
                        action: () => { switchView('payments'); closeNotificationCenter(); },
                        read: false
                    });
                }
                
                // 5. Check for missing data (from data health)
                const { data: dataHealth, error: dhError } = await supabaseClient.rpc('get_data_health', { p_days_back: 3 });
                if (dataHealth && !dhError) {
                    const missingCount = dataHealth.filter(d => !d.has_data).length;
                    
                    if (missingCount > 0) {
                        notifications.push({
                            id: 'data-missing',
                            type: 'alert',
                            icon: '',
                            iconClass: 'alert',
                            title: 'Missing Data',
                            message: `${missingCount} brand-days missing uploads in last 3 days`,
                            time: new Date().toISOString(),
                            action: () => { switchView('datastatus'); closeNotificationCenter(); },
                            read: false
                        });
                    }
                }
                
                // Sort by time (newest first)
                notifications.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // Update UI
                renderNotifications();
                updateNotificationBadge();
                
            } catch (err) {
                console.error('Error loading notifications:', err);
            }
        }
        
        function renderNotifications() {
            const list = document.getElementById('notificationList');
            if (!list) return;
            
            let filtered = notifications;
            if (notificationFilter === 'wins') {
                filtered = notifications.filter(n => n.type === 'win');
            } else if (notificationFilter === 'alerts') {
                filtered = notifications.filter(n => n.type === 'alert');
            } else if (notificationFilter === 'apps') {
                filtered = notifications.filter(n => n.type === 'application');
            }
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="notification-empty">
                        <div class="empty-icon"></div>
                        <div>All caught up!</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="handleNotificationClick('${n.id}')">
                    <div class="notification-icon ${n.iconClass}">${n.icon}</div>
                    <div class="notification-content">
                        <div class="title">${n.title}</div>
                        <div class="message">${n.message}</div>
                        <div class="time">${formatTimeAgo(n.time)}</div>
                    </div>
                </div>
            `).join('');
            
            // Update tab counts
            document.getElementById('tabCountAll').textContent = notifications.length;
        }
        
        function filterNotifications(filter) {
            notificationFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.notification-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === filter);
            });
            
            renderNotifications();
        }
        
        function handleNotificationClick(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                if (notification.action) {
                    notification.action();
                }
                updateNotificationBadge();
            }
        }
        
        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
            updateNotificationBadge();
            showToast('All notifications marked as read', 'success');
        }
        
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationCount');
            const bell = document.getElementById('notificationBell');
            
            if (badge) {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
            }
            
            if (bell) {
                bell.classList.toggle('has-alerts', unreadCount > 0);
            }
        }
        
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        // Load notifications on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadNotifications, 2000); // Load after initial data
            // Refresh every 5 minutes
            setInterval(loadNotifications, 300000);
        });

        // ==================== UTILITIES ====================
        function renderPagination(containerId, total, currentPage, onPageChange) {
            const totalPages = Math.ceil(total / PAGE_SIZE);
            if (totalPages <= 1) { document.getElementById(containerId).innerHTML = ''; return; }
            document.getElementById(containerId).innerHTML = `
                <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="(${onPageChange})(${currentPage - 1})"> Prev</button>
                <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
                <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="(${onPageChange})(${currentPage + 1})">Next </button>
            `;
        }

        function showToast(message, type = 'success', duration = 4000) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            const toastProgress = document.getElementById('toastProgress');
            
            // Set icon based on type
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            toastIcon.textContent = icons[type] || icons.success;
            toastMessage.textContent = message;
            
            // Reset and restart progress animation
            toastProgress.style.animation = 'none';
            toastProgress.offsetHeight; // Trigger reflow
            toastProgress.style.animation = `toastProgress ${duration}ms linear forwards`;
            
            toast.className = `toast ${type} show`;
            
            // Clear any existing timeout
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => hideToast(), duration);
        }
        
        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('show');
            if (window.toastTimeout) {
                clearTimeout(window.toastTimeout);
                window.toastTimeout = null;
            }
        }

        async function exportCreators() {
            showToast('Preparing export...', 'info');
            
            const brand = document.getElementById('creatorsBrandFilter').value;
            const startDate = document.getElementById('creatorsDateFilterStart').value;
            const endDate = document.getElementById('creatorsDateFilterEnd').value;
            
            if (!startDate || !endDate) {
                showToast('Please select a date range first', 'error');
                return;
            }
            
            let query = supabaseClient.from('creator_performance').select('*')
                .gte('report_date', startDate)
                .lte('report_date', endDate)
                .eq('period_type', 'daily')
                .limit(50000);
            if (brand !== 'all') query = query.eq('brand', brand);
            
            const { data, error } = await query;
            
            if (error) {
                showToast('Error fetching data', 'error');
                return;
            }
            
            // Aggregate by creator
            const creatorMap = new Map();
            (data || []).forEach(row => {
                const key = `${row.creator_name}|||${row.brand}`;
                if (!creatorMap.has(key)) {
                    creatorMap.set(key, {
                        creator_name: row.creator_name,
                        brand: row.brand,
                        gmv: 0, orders: 0, videos: 0, items_sold: 0, 
                        est_commission: 0, live_streams: 0
                    });
                }
                const c = creatorMap.get(key);
                c.gmv += pFloat(row.gmv);
                c.orders += pInt(row.orders);
                c.videos += pInt(row.videos);
                c.items_sold += pInt(row.items_sold);
                c.est_commission += pFloat(row.est_commission);
                c.live_streams += pInt(row.live_streams);
            });
            
            const creators = [...creatorMap.values()].sort((a, b) => b.gmv - a.gmv);
            
            // Build CSV
            const headers = ['Creator', 'Brand', 'GMV', 'Orders', 'Videos', 'Items Sold', 'Est Commission', 'Live Streams', 'GMV per Video', 'Tier', 'Managed'];
            const rows = creators.map(c => {
                const tier = getTier(c.gmv);
                const managed = isManagedForBrand(c.creator_name, c.brand);
                const gmvPerVideo = c.videos > 0 ? (c.gmv / c.videos).toFixed(2) : '0';
                return [
                    c.creator_name,
                    BRAND_DISPLAY[c.brand] || c.brand,
                    c.gmv.toFixed(2),
                    c.orders,
                    c.videos,
                    c.items_sold,
                    c.est_commission.toFixed(2),
                    c.live_streams,
                    gmvPerVideo,
                    tier.name,
                    managed ? 'Yes' : 'No'
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `creators_${startDate}_to_${endDate}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${creators.length} creators!`, 'success');
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        const shortcuts = {
            // Command palette
            'k': { ctrl: true, action: () => openCommandPalette(), desc: 'Open command palette' },
            '/': { action: () => openCommandPalette(), desc: 'Open search' },
            
            // Modal controls
            'Escape': { action: () => closeAllModals(), desc: 'Close modals' },
            
            // View navigation (Ctrl+Number)
            '1': { ctrl: true, action: () => switchView('opscenter'), desc: 'Ops Center' },
            '2': { ctrl: true, action: () => switchView('overview'), desc: 'Dashboard' },
            '3': { ctrl: true, action: () => switchView('brands'), desc: 'Brands' },
            '4': { ctrl: true, action: () => switchView('creators'), desc: 'Creators' },
            '5': { ctrl: true, action: () => switchView('videos'), desc: 'Videos' },
            '6': { ctrl: true, action: () => switchView('products'), desc: 'Products' },
            '7': { ctrl: true, action: () => switchView('roster'), desc: 'Roster' },
            '8': { ctrl: true, action: () => switchView('payments'), desc: 'Payments' },
            '9': { ctrl: true, action: () => switchView('applications'), desc: 'Applications' },
            
            // Quick actions
            'r': { ctrl: true, shift: true, action: () => loadViewData(), desc: 'Refresh current view' },
            'n': { ctrl: true, action: () => focusSearch(), desc: 'Focus search input' },
            'u': { ctrl: true, shift: true, action: () => switchView('upload'), desc: 'Go to Upload' },
            
            // Help
            '?': { shift: true, action: () => showKeyboardShortcutsHelp(), desc: 'Show keyboard shortcuts' }
        };
        
        function focusSearch() {
            // Find the search input in the current view
            const currentView = document.querySelector('.view-section.active');
            if (currentView) {
                const searchInput = currentView.querySelector('.search-input, input[type="text"][placeholder*="Search"]');
                if (searchInput) {
                    searchInput.focus();
                    return;
                }
            }
            // Fallback to command palette
            openCommandPalette();
        }
        
        function showKeyboardShortcutsHelp() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'keyboardHelpModal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 style="margin: 0;"> Keyboard Shortcuts</h2>
                        <button class="modal-close" onclick="document.getElementById('keyboardHelpModal').remove()"></button>
                    </div>
                    <div class="modal-body" style="padding: 0;">
                        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border);">
                            <div style="font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 12px;">Navigation</div>
                            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 0.9rem;">
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 1</kbd><span>Ops Center</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 2</kbd><span>Dashboard</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 3</kbd><span>Brands</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 4</kbd><span>Creators</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 5</kbd><span>Videos</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 6</kbd><span>Products</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 7</kbd><span>Roster</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 8</kbd><span>Payments</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + 9</kbd><span>Applications</span>
                            </div>
                        </div>
                        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border);">
                            <div style="font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 12px;">Actions</div>
                            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 0.9rem;">
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + K</kbd><span>Command palette</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">/</kbd><span>Quick search</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl + N</kbd><span>Focus search input</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl+Shift+R</kbd><span>Refresh view</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Ctrl+Shift+U</kbd><span>Go to Upload</span>
                                <kbd style="background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; font-family: monospace;">Escape</kbd><span>Close modal</span>
                            </div>
                        </div>
                        <div style="padding: 16px 20px;">
                            <div style="font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 12px;">Tips</div>
                            <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 0.85rem;">
                                <li>Press <kbd style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.8rem;">?</kbd> anytime to show this help</li>
                                <li>On Mac, use  instead of Ctrl</li>
                                <li>Press Escape in any input to unfocus</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }
            
            const key = e.key;
            const shortcut = shortcuts[key];
            
            if (shortcut) {
                const ctrlKey = e.ctrlKey || e.metaKey;
                const shiftKey = e.shiftKey;
                
                if ((shortcut.ctrl && ctrlKey) || (!shortcut.ctrl && !ctrlKey)) {
                    if ((shortcut.shift && shiftKey) || (!shortcut.shift && !shiftKey)) {
                        e.preventDefault();
                        shortcut.action();
                    }
                }
            }
        });

        // Settings nav toggle
        function toggleSettingsNav() {
            const group = document.getElementById('settingsNavGroup');
            const arrow = document.getElementById('settingsNavArrow');
            if (group.style.display === 'none' || !group.style.display) {
                group.style.display = 'block';
                arrow.textContent = '';
            } else {
                group.style.display = 'none';
                arrow.textContent = '';
            }
        }
        
        function toggleDataExplorerNav() {
            const group = document.getElementById('dataExplorerNavGroup');
            const arrow = document.getElementById('dataExplorerNavArrow');
            if (group.style.display === 'none' || !group.style.display) {
                group.style.display = 'block';
                arrow.textContent = '';
            } else {
                group.style.display = 'none';
                arrow.textContent = '';
            }
        }

        // Auto-expand settings if current view is in settings group
        function checkSettingsNavExpand(viewName) {
            const settingsViews = ['settings', 'goals', 'activity', 'datastatus', 'users'];
            if (settingsViews.includes(viewName)) {
                const group = document.getElementById('settingsNavGroup');
                const arrow = document.getElementById('settingsNavArrow');
                if (group) {
                    group.style.display = 'block';
                    arrow.textContent = '';
                }
            }
            
            const dataExplorerViews = ['creators', 'videos', 'products'];
            if (dataExplorerViews.includes(viewName)) {
                const group = document.getElementById('dataExplorerNavGroup');
                const arrow = document.getElementById('dataExplorerNavArrow');
                if (group) {
                    group.style.display = 'block';
                    arrow.textContent = '';
                }
            }
        }

        // Update alerts bell count
        function updateAlertsBell(count) {
            const bell = document.getElementById('alertsBell');
            const countEl = document.getElementById('alertsBellCount');
            if (countEl) countEl.textContent = count;
            if (bell) {
                if (count > 0) {
                    bell.classList.add('has-alerts');
                } else {
                    bell.classList.remove('has-alerts');
                }
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
            document.getElementById('commandPalette')?.classList.remove('show');
            closeMobileMenu();
        }

        // Command Palette
        function openCommandPalette() {
            let palette = document.getElementById('commandPalette');
            if (!palette) {
                palette = document.createElement('div');
                palette.id = 'commandPalette';
                palette.className = 'command-palette';
                palette.innerHTML = `
                    <div class="command-input-wrap">
                        <span class="command-icon"></span>
                        <input type="text" id="commandInput" placeholder="Search creators, views, or type a command..." autocomplete="off">
                        <span class="command-hint">ESC to close</span>
                    </div>
                    <div class="command-results" id="commandResults"></div>
                `;
                document.body.appendChild(palette);
                
                // Add styles
                const style = document.createElement('style');
                style.textContent = `
                    .command-palette {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.7);
                        display: none;
                        justify-content: center;
                        padding-top: 15vh;
                        z-index: 10000;
                    }
                    .command-palette.show { display: flex; }
                    .command-input-wrap {
                        background: var(--bg-card);
                        border: 1px solid var(--border);
                        border-radius: 12px;
                        padding: 16px 20px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        width: 600px;
                        max-width: 90vw;
                    }
                    .command-icon { font-size: 1.2rem; }
                    .command-input-wrap input {
                        flex: 1;
                        background: transparent;
                        border: none;
                        outline: none;
                        color: var(--text-primary);
                        font-size: 1.1rem;
                        font-family: inherit;
                    }
                    .command-hint { font-size: 0.75rem; color: var(--text-muted); }
                    .command-results {
                        position: absolute;
                        top: calc(15vh + 60px);
                        width: 600px;
                        max-width: 90vw;
                        max-height: 50vh;
                        overflow-y: auto;
                        background: var(--bg-card);
                        border: 1px solid var(--border);
                        border-radius: 12px;
                        display: none;
                    }
                    .command-results.has-results { display: block; }
                    .command-result {
                        padding: 12px 20px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        cursor: pointer;
                        border-bottom: 1px solid var(--border);
                    }
                    .command-result:last-child { border-bottom: none; }
                    .command-result:hover { background: var(--bg-card-hover); }
                    .command-result.selected { background: var(--accent-dim); }
                    .command-result-icon { font-size: 1.2rem; }
                    .command-result-text { flex: 1; }
                    .command-result-title { font-weight: 600; }
                    .command-result-desc { font-size: 0.8rem; color: var(--text-muted); }
                    .command-result-shortcut { font-size: 0.7rem; color: var(--text-muted); background: var(--bg-secondary); padding: 4px 8px; border-radius: 4px; }
                `;
                document.head.appendChild(style);
                
                // Input handler
                document.getElementById('commandInput').addEventListener('input', handleCommandSearch);
                document.getElementById('commandInput').addEventListener('keydown', handleCommandKeydown);
            }
            
            palette.classList.add('show');
            document.getElementById('commandInput').value = '';
            document.getElementById('commandInput').focus();
            document.getElementById('commandResults').innerHTML = '';
            document.getElementById('commandResults').classList.remove('has-results');
            
            // Show default options
            showDefaultCommands();
        }

        function showDefaultCommands() {
            const commands = [
                { icon: '', title: 'Ops Center', desc: 'Creator health quadrants', action: () => switchView('opscenter'), shortcut: '1' },
                { icon: '', title: 'Dashboard', desc: 'Main overview', action: () => switchView('overview'), shortcut: '2' },
                { icon: '', title: 'Brands', desc: 'Brand deep dive', action: () => switchView('brands'), shortcut: '3' },
                { icon: '', title: 'Creators', desc: 'All creators', action: () => switchView('creators'), shortcut: '4' },
                { icon: '', title: 'Videos', desc: 'Video performance', action: () => switchView('videos'), shortcut: '5' },
                { icon: '', title: 'Products', desc: 'Product analytics', action: () => switchView('products'), shortcut: '6' },
                { icon: '', title: 'Roster', desc: 'Managed creators', action: () => switchView('roster'), shortcut: '7' },
                { icon: '', title: 'Payments', desc: 'Payment tracking', action: () => switchView('payments'), shortcut: '8' },
                { icon: '', title: 'Applications', desc: 'Creator applications', action: () => switchView('applications'), shortcut: '9' },
                { icon: '', title: 'Upload Data', desc: 'Import new data', action: () => switchView('upload'), shortcut: 'U' },
                { icon: '', title: 'Refresh Data', desc: 'Reload current view', action: () => refreshCurrentView(), shortcut: 'R' },
                { icon: '', title: 'Keyboard Shortcuts', desc: 'View all shortcuts', action: () => showKeyboardShortcutsHelp(), shortcut: '?' }
            ];
            
            renderCommandResults(commands);
        }

        let commandResults = [];
        let selectedIndex = 0;

        async function handleCommandSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (!query) {
                showDefaultCommands();
                return;
            }
            
            const results = [];
            
            // Search views
            const views = [
                { icon: '', title: 'Ops Center', desc: 'Creator health quadrants', action: () => switchView('opscenter') },
                { icon: '', title: 'Dashboard', desc: 'Main overview', action: () => switchView('overview') },
                { icon: '', title: 'Brands', desc: 'Brand deep dive', action: () => switchView('brands') },
                { icon: '', title: 'Creators', desc: 'All creators', action: () => switchView('creators') },
                { icon: '', title: 'Videos', desc: 'Video performance', action: () => switchView('videos') },
                { icon: '', title: 'Products', desc: 'Product analytics', action: () => switchView('products') },
                { icon: '', title: 'Roster', desc: 'Managed creators', action: () => switchView('roster') },
                { icon: '', title: 'Payments', desc: 'Payment tracking', action: () => switchView('payments') },
                { icon: '', title: 'Applications', desc: 'Creator applications', action: () => switchView('applications') },
                { icon: '', title: 'Upload', desc: 'Import new data', action: () => switchView('upload') },
                { icon: '', title: 'Refresh', desc: 'Reload current view', action: () => refreshCurrentView() },
                { icon: '', title: 'Keyboard Shortcuts', desc: 'View all shortcuts', action: () => showKeyboardShortcutsHelp() }
            ];
            
            views.forEach(v => {
                if (v.title.toLowerCase().includes(query) || v.desc.toLowerCase().includes(query)) {
                    results.push(v);
                }
            });
            
            // Search creators
            if (query.length >= 2) {
                const matchingCreators = managedCreators
                    .filter(c => 
                        (c.real_name || '').toLowerCase().includes(query) ||
                        (c.discord_name || '').toLowerCase().includes(query) ||
                        (c.account_1 || '').toLowerCase().includes(query)
                    )
                    .slice(0, 5);
                
                matchingCreators.forEach(c => {
                    results.push({
                        icon: '',
                        title: c.real_name || c.discord_name || c.account_1,
                        desc: `${BRAND_DISPLAY[c.brand] || c.brand}  ${c.role || 'Creator'}`,
                        action: () => { switchView('roster'); editCreator(c.id); }
                    });
                });
            }
            
            renderCommandResults(results.length > 0 ? results : [{ icon: '', title: 'No results', desc: `No matches for "${query}"`, action: () => {} }]);
        }

        function renderCommandResults(results) {
            commandResults = results;
            selectedIndex = 0;
            
            const container = document.getElementById('commandResults');
            container.innerHTML = results.map((r, i) => `
                <div class="command-result ${i === 0 ? 'selected' : ''}" data-index="${i}">
                    <span class="command-result-icon">${r.icon}</span>
                    <div class="command-result-text">
                        <div class="command-result-title">${r.title}</div>
                        <div class="command-result-desc">${r.desc}</div>
                    </div>
                    ${r.shortcut ? `<span class="command-result-shortcut">${r.shortcut}</span>` : ''}
                </div>
            `).join('');
            
            container.classList.toggle('has-results', results.length > 0);
            
            // Add click handlers
            container.querySelectorAll('.command-result').forEach(el => {
                el.addEventListener('click', () => {
                    const index = parseInt(el.dataset.index);
                    executeCommand(index);
                });
            });
        }

        function handleCommandKeydown(e) {
            if (e.key === 'Escape') {
                document.getElementById('commandPalette').classList.remove('show');
                return;
            }
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, commandResults.length - 1);
                updateSelectedResult();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelectedResult();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                executeCommand(selectedIndex);
            }
        }

        function updateSelectedResult() {
            document.querySelectorAll('.command-result').forEach((el, i) => {
                el.classList.toggle('selected', i === selectedIndex);
            });
            // Scroll into view
            document.querySelector('.command-result.selected')?.scrollIntoView({ block: 'nearest' });
        }

        function executeCommand(index) {
            if (commandResults[index]) {
                commandResults[index].action();
                document.getElementById('commandPalette').classList.remove('show');
            }
        }

        // ==================== DATA FRESHNESS ====================
        async function loadBrandFreshness() {
            try {
                const container = document.getElementById('brandFreshnessIndicators');
                if (!container) return; // Element was removed
                
                const { data, error } = await supabaseClient
                    .from('upload_tracking')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = `<div style="font-size: 0.75rem; color: var(--text-muted); text-align: center;">No upload data</div>`;
                    return;
                }
                
                // Group by brand, get latest upload per brand
                const brandLatest = {};
                data.forEach(d => {
                    if (!brandLatest[d.brand] || new Date(d.uploaded_at) > new Date(brandLatest[d.brand].uploaded_at)) {
                        brandLatest[d.brand] = d;
                    }
                });
                
                let html = '';
                Object.entries(brandLatest).forEach(([brand, info]) => {
                    const uploadDate = new Date(info.uploaded_at);
                    const now = new Date();
                    const daysAgo = Math.floor((now - uploadDate) / (1000 * 60 * 60 * 24));
                    
                    let statusColor = 'var(--success)';
                    let statusIcon = '';
                    if (daysAgo >= 3) {
                        statusColor = 'var(--danger)';
                        statusIcon = '';
                    } else if (daysAgo >= 1) {
                        statusColor = 'var(--warning)';
                        statusIcon = '';
                    }
                    
                    const displayName = BRAND_DISPLAY[brand] || brand;
                    const timeAgo = daysAgo === 0 ? 'Today' : daysAgo === 1 ? '1 day ago' : `${daysAgo} days ago`;
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 0.75rem;">
                            <span style="color: var(--text-secondary);">${statusIcon} ${displayName}</span>
                            <span style="color: ${statusColor};">${timeAgo}</span>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (err) {
                console.error('Failed to load freshness:', err);
            }
        }

        // ==================== ACTIVITY LOG ====================
        async function loadActivityData() {
            showLoading('activity', 'Loading activity log...');
            const typeFilter = document.getElementById('activityTypeFilter')?.value || 'all';
            const brandFilter = document.getElementById('activityBrandFilter')?.value || 'all';
            
            try {
                let query = supabaseClient
                    .from('activity_log')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (typeFilter !== 'all') query = query.eq('activity_type', typeFilter);
                if (brandFilter !== 'all') query = query.eq('brand', brandFilter);
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                const container = document.getElementById('activityList');
                
                if (!data || data.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-muted);">No activity recorded yet</div>`;
                    return;
                }
                
                const typeIcons = {
                    'upload': '',
                    'edit': '',
                    'delete': '',
                    'payment': '',
                    'note': '',
                    'login': '',
                    'export': ''
                };
                
                const typeColors = {
                    'upload': 'var(--success)',
                    'edit': 'var(--blue)',
                    'delete': 'var(--danger)',
                    'payment': 'var(--accent)',
                    'note': 'var(--purple)',
                    'login': 'var(--text-muted)',
                    'export': 'var(--cyan)'
                };
                
                container.innerHTML = data.map(a => {
                    const time = new Date(a.created_at).toLocaleString();
                    const icon = typeIcons[a.activity_type] || '';
                    const color = typeColors[a.activity_type] || 'var(--text-muted)';
                    const brandDisplay = a.brand ? (BRAND_DISPLAY[a.brand] || a.brand) : '';
                    
                    return `
                        <div style="display: flex; gap: 12px; padding: 14px 20px; border-bottom: 1px solid var(--border);">
                            <div style="font-size: 1.3rem;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: var(--text-primary);">${a.description}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
                                    ${a.user_name || a.user_email || 'System'} 
                                    ${brandDisplay ? ` <span style="color: ${color};">${brandDisplay}</span>` : ''}
                                     ${time}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Failed to load activity:', err);
            } finally {
                hideLoading('activity');
            }
        }

        async function logActivity(type, description, brand = null, details = null) {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const user = session?.user;
                
                await supabaseClient.from('activity_log').insert({
                    activity_type: type,
                    description: description,
                    brand: brand,
                    details: details,
                    user_email: user?.email,
                    user_name: user?.user_metadata?.name || user?.user_metadata?.full_name
                });
            } catch (err) {
                console.warn('Failed to log activity:', err);
            }
        }

        // ==================== CREATOR NOTES ====================
        let currentNotesCreator = null;

        function openNotesModal(creatorHandle, creatorName, brand) {
            currentNotesCreator = { handle: creatorHandle, name: creatorName, brand: brand };
            document.getElementById('notesCreatorHandle').value = creatorHandle;
            document.getElementById('notesCreatorBrand').value = brand || '';
            document.getElementById('notesCreatorName').textContent = creatorName || creatorHandle;
            document.getElementById('noteText').value = '';
            document.getElementById('noteType').value = 'general';
            document.getElementById('notePinned').checked = false;
            
            loadCreatorNotes(creatorHandle);
            document.getElementById('notesModal').classList.add('show');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('show');
            currentNotesCreator = null;
        }

        async function loadCreatorNotes(creatorHandle) {
            const container = document.getElementById('notesHistory');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('creator_notes')
                    .select('*')
                    .eq('creator_handle', creatorHandle)
                    .order('is_pinned', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No notes yet</div>';
                    return;
                }
                
                const typeIcons = {
                    'general': '',
                    'payment': '',
                    'performance': '',
                    'communication': '',
                    'urgent': ''
                };
                
                container.innerHTML = data.map(n => {
                    const time = new Date(n.created_at).toLocaleString();
                    const icon = typeIcons[n.note_type] || '';
                    const pinIcon = n.is_pinned ? ' ' : '';
                    
                    return `
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; ${n.is_pinned ? 'border-left: 3px solid var(--accent);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                <span style="font-size: 0.8rem; font-weight: 600;">${pinIcon}${icon} ${n.note_type.charAt(0).toUpperCase() + n.note_type.slice(1)}</span>
                                <button onclick="deleteNote('${n.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8rem;"></button>
                            </div>
                            <div style="color: var(--text-primary); font-size: 0.9rem; margin-bottom: 6px;">${n.note}</div>
                            <div style="color: var(--text-muted); font-size: 0.75rem;">${n.created_by || 'Unknown'}  ${time}</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Failed to load notes:', err);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">Failed to load notes</div>';
            }
        }

        async function saveCreatorNote() {
            const text = document.getElementById('noteText').value.trim();
            if (!text) {
                showToast('Please enter a note', 'error');
                return;
            }
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const userName = session?.user?.user_metadata?.name || session?.user?.email || 'Admin';
                
                const { error } = await supabaseClient.from('creator_notes').insert({
                    creator_handle: document.getElementById('notesCreatorHandle').value,
                    brand: document.getElementById('notesCreatorBrand').value || null,
                    note_type: document.getElementById('noteType').value,
                    note: text,
                    is_pinned: document.getElementById('notePinned').checked,
                    created_by: userName
                });
                
                if (error) throw error;
                
                document.getElementById('noteText').value = '';
                showToast('Note added!', 'success');
                loadCreatorNotes(document.getElementById('notesCreatorHandle').value);
                
                logActivity('note', `Added note for ${currentNotesCreator?.name || currentNotesCreator?.handle}`, currentNotesCreator?.brand);
            } catch (err) {
                console.error('Failed to save note:', err);
                showToast('Failed to save note', 'error');
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            try {
                const { error } = await supabaseClient.from('creator_notes').delete().eq('id', noteId);
                if (error) throw error;
                
                showToast('Note deleted', 'success');
                loadCreatorNotes(document.getElementById('notesCreatorHandle').value);
            } catch (err) {
                console.error('Failed to delete note:', err);
                showToast('Failed to delete note', 'error');
            }
        }

        // ==================== PAYMENTS (creator_payments table) ====================
        let selectedPaymentIds = new Set();
        let paymentsStatusFilter = 'all';
        let allPaymentsData = [];

        async function loadPaymentsView() {
            showLoading('payments', 'Loading payment data...');
            const periodFilter = document.getElementById('paymentsPeriodFilter')?.value || '';
            const brandFilter = document.getElementById('paymentsBrandFilter')?.value || 'all';
            
            try {
                // Load from creator_payments table
                let query = supabaseClient
                    .from('creator_payments')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (periodFilter) query = query.eq('period_month', periodFilter);
                if (brandFilter !== 'all') query = query.eq('brand', brandFilter);
                if (paymentsStatusFilter !== 'all') query = query.eq('status', paymentsStatusFilter);
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                allPaymentsData = data || [];
                
                // Load GMV data for ROI calculation (last 30 days by default, or period-specific)
                const gmvByCreatorBrand = {};
                if (allPaymentsData.length > 0) {
                    // Get unique creator-brand pairs
                    const creatorBrands = [...new Set(allPaymentsData.map(p => `${p.creator_name}|${p.brand}`))];
                    const creators = [...new Set(allPaymentsData.map(p => p.creator_name.toLowerCase()))];
                    
                    // Fetch GMV for last 30 days
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    
                    const { data: perfData } = await supabaseClient
                        .from('creator_performance')
                        .select('creator_name, brand, gmv')
                        .gte('report_date', startDate.toISOString().split('T')[0])
                        .lte('report_date', endDate.toISOString().split('T')[0]);
                    
                    if (perfData) {
                        perfData.forEach(p => {
                            const key = `${p.creator_name.toLowerCase()}|${p.brand}`;
                            gmvByCreatorBrand[key] = (gmvByCreatorBrand[key] || 0) + (parseFloat(p.gmv) || 0);
                        });
                    }
                }
                
                // Attach GMV to payment data
                allPaymentsData = allPaymentsData.map(p => ({
                    ...p,
                    gmv30d: gmvByCreatorBrand[`${p.creator_name.toLowerCase()}|${p.brand}`] || 0
                }));
                
                // Update stats
                let pendingTotal = 0, approvedTotal = 0, paidTotal = 0;
                
                allPaymentsData.forEach(p => {
                    const amt = parseFloat(p.amount) || 0;
                    if (p.status === 'pending') pendingTotal += amt;
                    if (p.status === 'approved') approvedTotal += amt;
                    if (p.status === 'paid') paidTotal += amt;
                });
                
                document.getElementById('paymentsPendingTotal').textContent = fmtMoney(pendingTotal);
                document.getElementById('paymentsApprovedTotal').textContent = fmtMoney(approvedTotal);
                document.getElementById('paymentsPaidTotal').textContent = fmtMoney(paidTotal);
                document.getElementById('paymentsCount').textContent = allPaymentsData.length;
                
                // Populate period filter
                await populatePaymentsPeriodFilter();
                
                // Render table
                renderPaymentsTable(allPaymentsData);
                
                // Load creators on retainer
                await loadRetainerCreators();
                
            } catch (err) {
                console.error('Failed to load payments:', err);
                showToast('Failed to load payments', 'error');
            } finally {
                hideLoading('payments');
            }
        }

        function renderPaymentsTable(data) {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 60px 40px;">
                            <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No payment records yet</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">Click <strong>Add Payment</strong> to record a retainer claim, top-up, or bonus</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const statusBadges = {
                'pending': '<span class="badge" style="background: var(--warning-dim); color: var(--warning);"> Pending</span>',
                'approved': '<span class="badge" style="background: var(--blue-dim); color: var(--blue);"> Approved</span>',
                'paid': '<span class="badge" style="background: var(--success-dim); color: var(--success);"> Paid</span>',
                'rejected': '<span class="badge" style="background: var(--danger-dim); color: var(--danger);"> Rejected</span>'
            };
            
            const typeBadges = {
                'retainer': '<span class="badge" style="background: var(--accent-dim); color: var(--accent);"> Retainer</span>',
                'commission_topup': '<span class="badge" style="background: var(--purple-dim); color: var(--purple);"> Top-Up</span>',
                'bonus': '<span class="badge" style="background: var(--success-dim); color: var(--success);"> Bonus</span>',
                'other': '<span class="badge" style="background: var(--bg-tertiary); color: var(--text-muted);"> Other</span>'
            };
            
            tbody.innerHTML = data.map(p => {
                const dates = [];
                if (p.date_submitted) dates.push(`Sub: ${new Date(p.date_submitted).toLocaleDateString()}`);
                if (p.date_approved) dates.push(`Apr: ${new Date(p.date_approved).toLocaleDateString()}`);
                if (p.date_paid) dates.push(`Paid: ${new Date(p.date_paid).toLocaleDateString()}`);
                
                // Calculate ROI for retainer payments
                let roiDisplay = '<span style="color: var(--text-muted);"></span>';
                if (p.payment_type === 'retainer' && p.amount > 0 && p.gmv30d !== undefined) {
                    const roi = (p.gmv30d / p.amount).toFixed(1);
                    const roiColor = roi >= 1 ? 'var(--success)' : 'var(--error)';
                    roiDisplay = `<span style="color: ${roiColor}; font-weight: 600;">${roi}x</span>`;
                }
                
                return `
                <tr data-id="${p.id}">
                    <td><input type="checkbox" class="payment-check" data-id="${p.id}" ${selectedPaymentIds.has(p.id) ? 'checked' : ''} onchange="togglePaymentSelect('${p.id}')"></td>
                    <td><div class="creator-name">@${p.creator_name}</div></td>
                    <td><span class="badge-brand">${BRAND_DISPLAY[p.brand] || p.brand}</span></td>
                    <td>${typeBadges[p.payment_type] || p.payment_type}</td>
                    <td style="text-align: right; font-weight: 600; color: var(--success);">${fmtMoney(p.amount)}</td>
                    <td style="font-size: 0.85rem; color: var(--text-muted);">${p.period_month || ''}</td>
                    <td style="text-align: center;">${roiDisplay}</td>
                    <td>${statusBadges[p.status] || p.status}</td>
                    <td style="font-size: 0.75rem; color: var(--text-muted);">${dates.join('<br>') || ''}</td>
                    <td style="text-align: right;">
                        <div style="display: flex; gap: 4px; justify-content: flex-end;">
                            ${p.status === 'pending' ? `<button class="btn btn-small" onclick="approvePayment('${p.id}')" title="Approve" style="background: var(--blue-dim); color: var(--blue);"></button>` : ''}
                            ${p.status === 'approved' ? `<button class="btn btn-small btn-success" onclick="markPaymentPaid('${p.id}')" title="Mark Paid"></button>` : ''}
                            ${p.status === 'pending' ? `<button class="btn btn-small" onclick="rejectPayment('${p.id}')" title="Reject" style="background: var(--danger-dim); color: var(--danger);"></button>` : ''}
                            <button class="btn btn-small" onclick="editPayment('${p.id}')" title="Edit"></button>
                            <button class="btn btn-small" onclick="deletePayment('${p.id}')" title="Delete" style="background: var(--danger-dim); color: var(--danger);"></button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        async function populatePaymentsPeriodFilter() {
            try {
                const { data } = await supabaseClient
                    .from('creator_payments')
                    .select('period_month')
                    .order('period_month', { ascending: false });
                
                const periods = [...new Set((data || []).map(d => d.period_month).filter(Boolean))];
                
                // Add current and next month if not present
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                if (!periods.includes(currentMonth)) periods.unshift(currentMonth);
                
                const select = document.getElementById('paymentsPeriodFilter');
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">All Periods</option>' + 
                    periods.map(p => {
                        const [year, month] = p.split('-');
                        const monthName = new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        return `<option value="${p}" ${p === currentValue ? 'selected' : ''}>${monthName}</option>`;
                    }).join('');
            } catch (err) {
                console.error('Failed to load payment periods:', err);
            }
        }

        async function loadRetainerCreators() {
            const container = document.getElementById('retainerCreatorsList');
            if (!container) {
                console.warn('retainerCreatorsList container not found');
                return;
            }
            
            try {
                // Fetch creators with retainers including identity info
                const { data, error } = await supabaseClient
                    .from('managed_creators')
                    .select('account_1, brand, retainer, discord_name, real_name');
                
                if (error) {
                    console.error('Supabase query error:', error);
                    container.innerHTML = '<div style="color: var(--text-muted);">Could not load retainer data</div>';
                    return;
                }
                
                // Filter for those with retainers
                const withRetainers = (data || []).filter(c => c.account_1 && c.retainer && parseFloat(c.retainer) > 0);
                
                if (withRetainers.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted);">No creators on retainer found. Add retainer amounts in the Roster.</div>';
                    return;
                }
                
                // Group by identity (discord_name) like the roster does
                const identityMap = new Map();
                withRetainers.forEach(c => {
                    const key = (c.discord_name || c.account_1 || '').toLowerCase().trim();
                    if (!identityMap.has(key)) {
                        identityMap.set(key, {
                            displayName: c.real_name || c.discord_name || c.account_1,
                            retainers: [] // {brand, amount, account}
                        });
                    }
                    identityMap.get(key).retainers.push({
                        brand: c.brand,
                        amount: parseFloat(c.retainer),
                        account: c.account_1
                    });
                });
                
                // Convert to array and sort by total retainer amount
                const grouped = [...identityMap.values()]
                    .map(g => ({
                        ...g,
                        totalRetainer: g.retainers.reduce((sum, r) => sum + r.amount, 0)
                    }))
                    .sort((a, b) => a.displayName.localeCompare(b.displayName)); // Sort alphabetically by name
                
                // Render as a clean table layout
                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border); text-align: left;">
                                <th style="padding: 8px 12px; color: var(--text-muted); font-weight: 500;">Creator</th>
                                <th style="padding: 8px 12px; color: var(--text-muted); font-weight: 500;">Brand</th>
                                <th style="padding: 8px 12px; color: var(--text-muted); font-weight: 500; text-align: right;">Amount</th>
                                <th style="padding: 8px 12px; width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody id="quickClaimTableBody">
                            ${grouped.flatMap(creator => 
                                creator.retainers.map((r, idx) => `
                                    <tr class="quick-claim-row" data-name="${creator.displayName.toLowerCase()}" data-brand="${r.brand}" style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px 12px; font-weight: ${idx === 0 ? '600' : '400'};">
                                            ${idx === 0 ? creator.displayName : '<span style="color: var(--text-muted);"></span>'}
                                        </td>
                                        <td style="padding: 10px 12px;">
                                            <span class="badge-brand" style="font-size: 0.75rem;">${BRAND_DISPLAY[r.brand] || r.brand}</span>
                                        </td>
                                        <td style="padding: 10px 12px; text-align: right; color: var(--success); font-weight: 500;">
                                            ${fmtMoney(r.amount)}
                                        </td>
                                        <td style="padding: 10px 12px; text-align: right;">
                                            <button class="btn btn-sm btn-primary" 
                                                onclick="quickAddRetainer('${creator.displayName.replace(/'/g, "\\'")}', '${r.account}', '${r.brand}', ${r.amount})"
                                                style="padding: 4px 12px; font-size: 0.8rem;">
                                                + Claim
                                            </button>
                                        </td>
                                    </tr>
                                `)
                            ).join('')}
                        </tbody>
                    </table>
                    <div id="quickClaimSummary" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; color: var(--text-muted); font-size: 0.85rem;">
                        <span>${grouped.length} creators on retainer</span>
                        <span>Total: <strong style="color: var(--success);">${fmtMoney(grouped.reduce((s, c) => s + c.totalRetainer, 0))}/mo</strong></span>
                    </div>
                `;
                
            } catch (err) {
                console.error('Failed to load retainer creators:', err);
                container.innerHTML = '<div style="color: var(--text-muted);">Could not load retainer data</div>';
            }
        }

        function quickAddRetainer(displayName, account, brand, amount) {
            document.getElementById('addPaymentCreator').value = displayName;
            document.getElementById('addPaymentBrand').value = brand;
            document.getElementById('addPaymentType').value = 'retainer';
            document.getElementById('addPaymentAmount').value = amount;
            
            // Set period to current month
            const now = new Date();
            document.getElementById('addPaymentPeriod').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            openAddPaymentModal();
        }
        
        function filterQuickClaimTable() {
            const search = (document.getElementById('quickClaimSearch')?.value || '').toLowerCase().trim();
            const rows = document.querySelectorAll('.quick-claim-row');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const name = row.dataset.name || '';
                const brand = row.dataset.brand || '';
                const matches = !search || name.includes(search) || (BRAND_DISPLAY[brand] || brand).toLowerCase().includes(search);
                row.style.display = matches ? '' : 'none';
                if (matches) visibleCount++;
            });
            
            // Update visible count in summary
            const summary = document.getElementById('quickClaimSummary');
            if (summary && search) {
                const totalCreators = document.querySelectorAll('.quick-claim-row').length;
                summary.querySelector('span').textContent = `Showing ${visibleCount} of ${totalCreators} creators`;
            }
        }

        function setPaymentsStatusFilter(status) {
            paymentsStatusFilter = status;
            
            // Update button styles
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.classList.remove('btn-primary');
            });
            const activeBtn = document.getElementById('filter' + status.charAt(0).toUpperCase() + status.slice(1));
            if (activeBtn) activeBtn.classList.add('btn-primary');
            
            loadPaymentsView();
        }

        function filterPaymentsTable() {
            const search = document.getElementById('paymentsSearchInput').value.toLowerCase();
            const filtered = allPaymentsData.filter(p => 
                p.creator_name.toLowerCase().includes(search) ||
                (p.notes && p.notes.toLowerCase().includes(search))
            );
            renderPaymentsTable(filtered);
        }

        function togglePaymentSelect(id) {
            if (selectedPaymentIds.has(id)) {
                selectedPaymentIds.delete(id);
            } else {
                selectedPaymentIds.add(id);
            }
        }

        function toggleAllPayments(checkbox) {
            const checkboxes = document.querySelectorAll('.payment-check');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedPaymentIds.add(cb.dataset.id);
                } else {
                    selectedPaymentIds.delete(cb.dataset.id);
                }
            });
        }

        async function bulkApproveSelected() {
            if (selectedPaymentIds.size === 0) {
                showToast('No payments selected', 'warning');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .update({ 
                        status: 'approved', 
                        date_approved: new Date().toISOString().split('T')[0],
                        updated_at: new Date().toISOString()
                    })
                    .in('id', Array.from(selectedPaymentIds))
                    .eq('status', 'pending');
                
                if (error) throw error;
                
                showToast(`Approved ${selectedPaymentIds.size} payments`, 'success');
                selectedPaymentIds.clear();
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to bulk approve:', err);
                showToast('Failed to approve payments', 'error');
            }
        }

        async function bulkMarkPaidSelected() {
            if (selectedPaymentIds.size === 0) {
                showToast('No payments selected', 'warning');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .update({ 
                        status: 'paid', 
                        date_paid: new Date().toISOString().split('T')[0],
                        updated_at: new Date().toISOString()
                    })
                    .in('id', Array.from(selectedPaymentIds));
                
                if (error) throw error;
                
                showToast(`Marked ${selectedPaymentIds.size} payments as paid`, 'success');
                selectedPaymentIds.clear();
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to bulk mark paid:', err);
                showToast('Failed to update payments', 'error');
            }
        }

        async function approvePayment(id) {
            try {
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .update({ 
                        status: 'approved', 
                        date_approved: new Date().toISOString().split('T')[0],
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Payment approved', 'success');
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to approve:', err);
                showToast('Failed to approve payment', 'error');
            }
        }

        async function markPaymentPaid(id) {
            try {
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .update({ 
                        status: 'paid', 
                        date_paid: new Date().toISOString().split('T')[0],
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Payment marked as paid', 'success');
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to mark paid:', err);
                showToast('Failed to update payment', 'error');
            }
        }

        async function rejectPayment(id) {
            if (!confirm('Reject this payment claim?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .update({ 
                        status: 'rejected',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Payment rejected', 'warning');
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to reject:', err);
                showToast('Failed to reject payment', 'error');
            }
        }

        async function deletePayment(id) {
            if (!confirm('Delete this payment record? This cannot be undone.')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Payment deleted', 'success');
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to delete:', err);
                showToast('Failed to delete payment', 'error');
            }
        }

        let editingPaymentId = null;
        
        async function editPayment(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('creator_payments')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                editingPaymentId = id;
                
                // Populate edit form
                document.getElementById('editPaymentCreator').value = data.creator_name || '';
                document.getElementById('editPaymentBrand').value = data.brand || '';
                document.getElementById('editPaymentType').value = data.payment_type || 'retainer';
                document.getElementById('editPaymentAmount').value = data.amount || '';
                document.getElementById('editPaymentPeriod').value = data.period_month || '';
                document.getElementById('editPaymentStatus').value = data.status || 'pending';
                document.getElementById('editPaymentNotes').value = data.notes || '';
                
                document.getElementById('editPaymentModal').classList.add('show');
            } catch (err) {
                console.error('Failed to load payment:', err);
                showToast('Failed to load payment details', 'error');
            }
        }
        
        function closeEditPaymentModal() {
            document.getElementById('editPaymentModal').classList.remove('show');
            editingPaymentId = null;
        }
        
        async function submitEditPayment() {
            if (!editingPaymentId) return;
            
            const creatorName = document.getElementById('editPaymentCreator').value.trim();
            const brand = document.getElementById('editPaymentBrand').value;
            const paymentType = document.getElementById('editPaymentType').value;
            const amount = parseFloat(document.getElementById('editPaymentAmount').value);
            const periodMonth = document.getElementById('editPaymentPeriod').value;
            const status = document.getElementById('editPaymentStatus').value;
            const notes = document.getElementById('editPaymentNotes').value.trim();
            
            if (!creatorName || !brand || !amount || !periodMonth) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const updateData = {
                    creator_name: creatorName,
                    brand: brand,
                    payment_type: paymentType,
                    amount: amount,
                    period_month: periodMonth,
                    status: status,
                    notes: notes || null,
                    updated_at: new Date().toISOString()
                };
                
                // Update date fields based on status
                if (status === 'approved') {
                    updateData.date_approved = updateData.date_approved || new Date().toISOString().split('T')[0];
                }
                if (status === 'paid') {
                    updateData.date_paid = updateData.date_paid || new Date().toISOString().split('T')[0];
                }
                
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .update(updateData)
                    .eq('id', editingPaymentId);
                
                if (error) throw error;
                
                showToast('Payment updated', 'success');
                closeEditPaymentModal();
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to update payment:', err);
                showToast('Failed to update payment', 'error');
            }
        }

        // Add Payment Modal
        function openAddPaymentModal() {
            // Set default period to current month
            const now = new Date();
            document.getElementById('addPaymentPeriod').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // Load creator suggestions
            loadCreatorSuggestions();
            
            document.getElementById('addPaymentModal').classList.add('show');
        }

        function closeAddPaymentModal() {
            document.getElementById('addPaymentModal').classList.remove('show');
            // Clear form
            document.getElementById('addPaymentCreator').value = '';
            document.getElementById('addPaymentAmount').value = '';
            document.getElementById('addPaymentNotes').value = '';
        }

        async function loadCreatorSuggestions() {
            try {
                const { data } = await supabaseClient
                    .from('managed_creators')
                    .select('account_1')
                    .order('account_1');
                
                const datalist = document.getElementById('creatorSuggestions');
                datalist.innerHTML = (data || []).filter(c => c.account_1).map(c => `<option value="${c.account_1}">`).join('');
            } catch (err) {
                console.error('Failed to load creator suggestions:', err);
            }
        }

        async function submitAddPayment() {
            const creatorName = document.getElementById('addPaymentCreator').value.trim().replace('@', '');
            const brand = document.getElementById('addPaymentBrand').value;
            const paymentType = document.getElementById('addPaymentType').value;
            const amount = parseFloat(document.getElementById('addPaymentAmount').value);
            const periodMonth = document.getElementById('addPaymentPeriod').value;
            const notes = document.getElementById('addPaymentNotes').value.trim();
            
            if (!creatorName || !amount || !periodMonth) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .insert({
                        creator_name: creatorName,
                        brand: brand,
                        payment_type: paymentType,
                        amount: amount,
                        period_month: periodMonth,
                        date_submitted: new Date().toISOString().split('T')[0],
                        status: 'pending',
                        notes: notes || null
                    });
                
                if (error) throw error;
                
                showToast('Payment record added!', 'success');
                closeAddPaymentModal();
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to add payment:', err);
                showToast('Failed to add payment: ' + err.message, 'error');
            }
        }

        // ==================== 1% COMMISSIONS CALCULATOR ====================
        let commissionsData = [];
        let commissionsBaselineRates = {};
        let currentCommissionsBrand = null;
        let currentCommissionsPeriod = null;
        let commissionsSortColumn = 'commission';
        let commissionsSortAsc = false;
        
        async function loadCommissionsData() {
            // Load baseline rates
            await loadBaselineRates();
            // Load history if on history tab
            if (document.getElementById('commissions-history')?.style.display !== 'none') {
                loadCommissionsHistory();
            }
        }
        
        async function loadBaselineRates() {
            try {
                const { data, error } = await supabaseClient
                    .from('product_commission_rates')
                    .select('*')
                    .order('brand');
                
                if (error) throw error;
                
                // Organize by brand -> product_id
                commissionsBaselineRates = {};
                (data || []).forEach(rate => {
                    if (!commissionsBaselineRates[rate.brand]) {
                        commissionsBaselineRates[rate.brand] = {};
                    }
                    const key = rate.product_id || '_default';
                    commissionsBaselineRates[rate.brand][key] = {
                        standard: parseFloat(rate.standard_commission_baseline) || 25,
                        shopAds: parseFloat(rate.shop_ads_commission_baseline) || 15
                    };
                });
                
                console.log('Loaded baseline rates:', commissionsBaselineRates);
            } catch (err) {
                console.error('Error loading baseline rates:', err);
                // Set defaults if table doesn't exist
                commissionsBaselineRates = {
                    'jiyu': { '_default': { standard: 25, shopAds: 15 } },
                    'catakor': { '_default': { standard: 25, shopAds: 15 } },
                    'physicians_choice': { '_default': { standard: 20, shopAds: 15 } },
                    'peach_slices': { '_default': { standard: 20, shopAds: 15 } },
                    'yerba_magic': { '_default': { standard: 25, shopAds: 15 } }
                };
            }
        }
        
        function switchCommissionsTab(tab) {
            document.getElementById('commTabCalculator').classList.toggle('active', tab === 'calculator');
            document.getElementById('commTabHistory').classList.toggle('active', tab === 'history');
            document.getElementById('commissions-calculator').style.display = tab === 'calculator' ? 'block' : 'none';
            document.getElementById('commissions-history').style.display = tab === 'history' ? 'block' : 'none';
            
            if (tab === 'history') {
                loadCommissionsHistory();
            }
        }
        
        function showUploadCommissionsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'uploadCommissionsModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title"> Upload Affiliate Orders</h3>
                        <button class="modal-close" onclick="closeUploadCommissionsModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Brand</label>
                            <select id="uploadCommBrand" class="form-control" required>
                                <option value="">Select Brand...</option>
                                <option value="jiyu">JiYu</option>
                                <option value="catakor">Cata-Kor</option>
                                <option value="physicians_choice">Physicians Choice</option>
                                <option value="peach_slices">Peach Slices</option>
                                <option value="yerba_magic">Yerba Magic</option>
                            <option value="toplux">Toplux Nutrition</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Period (Month)</label>
                            <input type="month" id="uploadCommPeriod" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Affiliate Orders CSV</label>
                            <input type="file" id="uploadCommFile" accept=".csv" class="form-control" required>
                            <small style="color: var(--text-muted);">File from TikTok Shop: creator_order_all_*.csv</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeUploadCommissionsModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="processCommissionsFile()"> Calculate</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Set default period to last month
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            document.getElementById('uploadCommPeriod').value = lastMonth.toISOString().slice(0, 7);
        }
        
        function closeUploadCommissionsModal() {
            document.getElementById('uploadCommissionsModal')?.remove();
        }
        
        async function processCommissionsFile() {
            const brand = document.getElementById('uploadCommBrand').value;
            const period = document.getElementById('uploadCommPeriod').value;
            const fileInput = document.getElementById('uploadCommFile');
            
            if (!brand || !period || !fileInput.files[0]) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            currentCommissionsBrand = brand;
            currentCommissionsPeriod = period;
            
            showLoading('commissions', 'Processing affiliate orders...');
            closeUploadCommissionsModal();
            
            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const rows = parseCSV(text);
                
                console.log(`Parsed ${rows.length} rows from CSV`);
                if (rows.length > 0) {
                    console.log('Sample row:', rows[0]);
                }
                
                // Get baseline rates for this brand
                const brandRates = commissionsBaselineRates[brand] || { '_default': { standard: 25, shopAds: 15 } };
                const defaultRates = brandRates['_default'] || { standard: 25, shopAds: 15 };
                console.log('Using baseline rates:', defaultRates);
                
                // Process each row
                const creatorTotals = {};
                let processedRows = 0;
                let completedOrProcessing = 0;
                let hasCreatorName = 0;
                let has1PctRate = 0;
                
                rows.forEach(row => {
                    const orderStatus = row['Order Status'];
                    if (orderStatus !== 'Completed' && orderStatus !== 'Processing') return;
                    completedOrProcessing++;
                    
                    const creatorName = (row['Creator Username'] || '').toLowerCase();
                    if (!creatorName) return;
                    hasCreatorName++;
                    
                    const standardRate = parseFloat(row['Standard commission rate']) || 0;
                    const shopAdsRate = parseFloat(row['Shop Ads commission rate']) || 0;
                    const estCommissionBase = parseFloat(row['Est. Commission Base']) || 0;
                    const productId = row['Product ID'] || '';
                    
                    // Check if either rate is 1%
                    if (standardRate !== 1 && shopAdsRate !== 1) return;
                    has1PctRate++;
                    
                    // Get rates for this product (or default)
                    const productRates = brandRates[productId] || defaultRates;
                    
                    // Initialize creator if needed
                    if (!creatorTotals[creatorName]) {
                        creatorTotals[creatorName] = {
                            creator: creatorName,
                            brand: brand,
                            orders: 0,
                            standardGmv: 0,
                            shopAdsGmv: 0,
                            standardCommission: 0,
                            shopAdsCommission: 0,
                            totalCommission: 0
                        };
                    }
                    
                    const c = creatorTotals[creatorName];
                    c.orders++;
                    processedRows++;
                    
                    // Calculate standard commission (if rate = 1)
                    if (standardRate === 1) {
                        c.standardGmv += estCommissionBase;
                        const commissionPct = (productRates.standard - 1) / 100;
                        c.standardCommission += estCommissionBase * commissionPct;
                    }
                    
                    // Calculate shop ads commission (if rate = 1)
                    if (shopAdsRate === 1) {
                        c.shopAdsGmv += estCommissionBase;
                        const commissionPct = (productRates.shopAds - 1) / 100;
                        c.shopAdsCommission += estCommissionBase * commissionPct;
                    }
                    
                    c.totalCommission = c.standardCommission + c.shopAdsCommission;
                });
                
                // Convert to array and sort
                commissionsData = Object.values(creatorTotals).sort((a, b) => b.totalCommission - a.totalCommission);
                
                console.log('=== COMMISSION PROCESSING SUMMARY ===');
                console.log(`Total rows: ${rows.length}`);
                console.log(`Completed/Processing: ${completedOrProcessing}`);
                console.log(`With creator name: ${hasCreatorName}`);
                console.log(`With 1% rate: ${has1PctRate}`);
                console.log(`Final qualifying rows: ${processedRows}`);
                console.log(`Unique creators: ${commissionsData.length}`);
                
                if (commissionsData.length === 0) {
                    hideLoading('commissions');
                    showToast(`No creators found with 1% commission rate.\n\nCompleted/Processing orders: ${completedOrProcessing}\nWith 1% rate: ${has1PctRate}`, 'warning');
                    return;
                }
                
                // Update UI
                renderCommissionsResults();
                
                const totalComm = commissionsData.reduce((sum, c) => sum + c.totalCommission, 0);
                showToast(`Found ${commissionsData.length} creators with $${totalComm.toFixed(2)} total commission`, 'success');
                
            } catch (err) {
                console.error('Error processing commissions file:', err);
                showToast('Error processing file: ' + err.message, 'error');
            } finally {
                hideLoading('commissions');
            }
        }
        
        function parseCSV(text) {
            const lines = text.split('\n');
            if (lines.length < 2) return [];
            
            // Parse header
            const headers = parseCSVLine(lines[0]);
            
            // Parse rows
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = values[idx] || '';
                });
                rows.push(row);
            }
            return rows;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function renderCommissionsResults() {
            // Show results section
            document.getElementById('commissionsUploadArea').style.display = 'none';
            document.getElementById('commissionsResults').style.display = 'block';
            
            // Update summary
            const totalGmv = commissionsData.reduce((sum, c) => sum + c.standardGmv + c.shopAdsGmv, 0);
            const totalCommission = commissionsData.reduce((sum, c) => sum + c.totalCommission, 0);
            
            document.getElementById('commPeriod').textContent = formatPeriod(currentCommissionsPeriod) + '  ' + BRAND_DISPLAY[currentCommissionsBrand];
            document.getElementById('commCreatorCount').textContent = commissionsData.length;
            document.getElementById('commTotalGmv').textContent = '$' + totalGmv.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('commTotalCommission').textContent = '$' + totalCommission.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            renderCommissionsTable();
        }
        
        function renderCommissionsTable() {
            const tbody = document.getElementById('commissionsTableBody');
            const tfoot = document.getElementById('commissionsTableFoot');
            
            // Apply filters
            const searchTerm = (document.getElementById('commSearchInput')?.value || '').toLowerCase();
            let filtered = commissionsData.filter(c => 
                c.creator.toLowerCase().includes(searchTerm)
            );
            
            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch (commissionsSortColumn) {
                    case 'creator': aVal = a.creator; bVal = b.creator; break;
                    case 'orders': aVal = a.orders; bVal = b.orders; break;
                    case 'standardGmv': aVal = a.standardGmv; bVal = b.standardGmv; break;
                    case 'shopAdsGmv': aVal = a.shopAdsGmv; bVal = b.shopAdsGmv; break;
                    case 'commission': aVal = a.totalCommission; bVal = b.totalCommission; break;
                    default: aVal = a.totalCommission; bVal = b.totalCommission;
                }
                if (typeof aVal === 'string') {
                    return commissionsSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return commissionsSortAsc ? aVal - bVal : bVal - aVal;
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No results found</td></tr>';
                tfoot.style.display = 'none';
                return;
            }
            
            tbody.innerHTML = filtered.map(c => `
                <tr>
                    <td><a href="https://tiktok.com/@${c.creator}" target="_blank" style="color: var(--accent); text-decoration: none;">@${c.creator}</a></td>
                    <td>${BRAND_DISPLAY[c.brand] || c.brand}</td>
                    <td style="text-align: right;">${c.orders.toLocaleString()}</td>
                    <td style="text-align: right;">$${c.standardGmv.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td style="text-align: right;">$${c.shopAdsGmv.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td style="text-align: right; font-weight: 600; color: var(--success);">$${c.totalCommission.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `).join('');
            
            // Update footer totals
            const totalOrders = filtered.reduce((sum, c) => sum + c.orders, 0);
            const totalStandardGmv = filtered.reduce((sum, c) => sum + c.standardGmv, 0);
            const totalShopAdsGmv = filtered.reduce((sum, c) => sum + c.shopAdsGmv, 0);
            const totalCommission = filtered.reduce((sum, c) => sum + c.totalCommission, 0);
            
            document.getElementById('commFootOrders').textContent = totalOrders.toLocaleString();
            document.getElementById('commFootStandardGmv').textContent = '$' + totalStandardGmv.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('commFootShopAdsGmv').textContent = '$' + totalShopAdsGmv.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('commFootCommission').textContent = '$' + totalCommission.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            tfoot.style.display = 'table-footer-group';
        }
        
        function filterCommissionsTable() {
            renderCommissionsTable();
        }
        
        function sortCommissionsTable(column) {
            if (commissionsSortColumn === column) {
                commissionsSortAsc = !commissionsSortAsc;
            } else {
                commissionsSortColumn = column;
                commissionsSortAsc = false;
            }
            renderCommissionsTable();
        }
        
        function formatPeriod(period) {
            if (!period) return '-';
            const [year, month] = period.split('-');
            const date = new Date(year, parseInt(month) - 1, 1);
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
        
        function exportCommissionsCSV() {
            if (commissionsData.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const headers = ['Creator', 'Brand', 'Orders', 'Standard GMV', 'Shop Ads GMV', 'Standard Commission', 'Shop Ads Commission', 'Total Commission'];
            const rows = commissionsData.map(c => [
                c.creator,
                c.brand,
                c.orders,
                c.standardGmv.toFixed(2),
                c.shopAdsGmv.toFixed(2),
                c.standardCommission.toFixed(2),
                c.shopAdsCommission.toFixed(2),
                c.totalCommission.toFixed(2)
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `commissions_${currentCommissionsBrand}_${currentCommissionsPeriod}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('CSV exported!', 'success');
        }
        
        async function saveCommissionsToDatabase() {
            if (commissionsData.length === 0) {
                showToast('No data to save', 'warning');
                return;
            }
            
            if (!confirm(`Save ${commissionsData.length} commission records for ${formatPeriod(currentCommissionsPeriod)}?`)) return;
            
            showLoading('commissions', 'Saving to database...');
            
            try {
                // Prepare records
                const records = commissionsData.map(c => ({
                    brand: c.brand,
                    period_month: currentCommissionsPeriod,
                    creator_name: c.creator,
                    total_orders: c.orders,
                    completed_orders: c.orders,
                    standard_gmv: c.standardGmv,
                    shop_ads_gmv: c.shopAdsGmv,
                    standard_commission: c.standardCommission,
                    shop_ads_commission: c.shopAdsCommission,
                    total_commission: c.totalCommission,
                    is_managed: false,  // Not filtered by roster
                    calculated_at: new Date().toISOString()
                }));
                
                // Upsert records (update if exists)
                const { error } = await supabaseClient
                    .from('creator_commissions')
                    .upsert(records, { 
                        onConflict: 'brand,period_month,creator_name',
                        ignoreDuplicates: false 
                    });
                
                if (error) throw error;
                
                // Log the upload
                const totalCommission = commissionsData.reduce((sum, c) => sum + c.totalCommission, 0);
                await supabaseClient.from('commission_uploads').insert({
                    brand: currentCommissionsBrand,
                    period_month: currentCommissionsPeriod,
                    total_creators: commissionsData.length,
                    managed_creators: commissionsData.length,
                    total_commission: totalCommission,
                    uploaded_at: new Date().toISOString()
                });
                
                showToast(`Saved ${records.length} commission records!`, 'success');
                
            } catch (err) {
                console.error('Error saving commissions:', err);
                showToast('Error saving: ' + err.message, 'error');
            } finally {
                hideLoading('commissions');
            }
        }
        
        async function loadCommissionsHistory() {
            const tbody = document.getElementById('commissionsHistoryBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';
            
            try {
                const brandFilter = document.getElementById('historyBrandFilter')?.value || 'all';
                
                let query = supabaseClient
                    .from('creator_commissions')
                    .select('*')
                    .order('period_month', { ascending: false })
                    .order('total_commission', { ascending: false })
                    .limit(500);
                
                if (brandFilter !== 'all') {
                    query = query.eq('brand', brandFilter);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No commission history found</td></tr>';
                    return;
                }
                
                // Populate period filter
                const periods = [...new Set(data.map(d => d.period_month))].sort().reverse();
                const periodSelect = document.getElementById('historyPeriodFilter');
                periodSelect.innerHTML = '<option value="all">All Periods</option>' + 
                    periods.map(p => `<option value="${p}">${formatPeriod(p)}</option>`).join('');
                
                // Filter by period if selected
                const periodFilter = periodSelect.value;
                let filtered = data;
                if (periodFilter !== 'all') {
                    filtered = data.filter(d => d.period_month === periodFilter);
                }
                
                tbody.innerHTML = filtered.map(d => `
                    <tr>
                        <td>${formatPeriod(d.period_month)}</td>
                        <td>${BRAND_DISPLAY[d.brand] || d.brand}</td>
                        <td><a href="https://tiktok.com/@${d.creator_name}" target="_blank" style="color: var(--accent);">@${d.creator_name}</a></td>
                        <td style="text-align: right;">${d.total_orders?.toLocaleString() || 0}</td>
                        <td style="text-align: right;">$${((d.standard_gmv || 0) + (d.shop_ads_gmv || 0)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td style="text-align: right; font-weight: 600; color: var(--success);">$${(d.total_commission || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td style="text-align: right; font-size: 0.8rem; color: var(--text-muted);">${d.calculated_at ? new Date(d.calculated_at).toLocaleDateString() : '-'}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error('Error loading commission history:', err);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);">Error loading history</td></tr>';
            }
        }
        
        function showBaselineRatesModal() {
            const brands = ['jiyu', 'catakor', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'baselineRatesModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title"> Baseline Commission Rates</h3>
                        <button class="modal-close" onclick="closeBaselineRatesModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px;">Set the default commission rates for each brand. These are used to calculate the 1% creator commissions.</p>
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Brand</th>
                                    <th style="text-align: center;">Standard %</th>
                                    <th style="text-align: center;">Shop Ads %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${brands.map(brand => {
                                    const rates = commissionsBaselineRates[brand]?.['_default'] || { standard: 25, shopAds: 15 };
                                    return `
                                        <tr>
                                            <td>${BRAND_DISPLAY[brand] || brand}</td>
                                            <td style="text-align: center;"><input type="number" id="rate_${brand}_standard" value="${rates.standard}" min="0" max="100" step="0.1" style="width: 70px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">%</td>
                                            <td style="text-align: center;"><input type="number" id="rate_${brand}_shopads" value="${rates.shopAds}" min="0" max="100" step="0.1" style="width: 70px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeBaselineRatesModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveBaselineRates()"> Save Rates</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeBaselineRatesModal() {
            document.getElementById('baselineRatesModal')?.remove();
        }
        
        async function saveBaselineRates() {
            const brands = ['jiyu', 'catakor', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            
            try {
                for (const brand of brands) {
                    const standard = parseFloat(document.getElementById(`rate_${brand}_standard`).value) || 25;
                    const shopAds = parseFloat(document.getElementById(`rate_${brand}_shopads`).value) || 15;
                    
                    await supabaseClient
                        .from('product_commission_rates')
                        .upsert({
                            brand: brand,
                            product_id: null,
                            product_name: 'Brand Default',
                            standard_commission_baseline: standard,
                            shop_ads_commission_baseline: shopAds,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'brand,product_id' });
                    
                    // Update local cache
                    if (!commissionsBaselineRates[brand]) commissionsBaselineRates[brand] = {};
                    commissionsBaselineRates[brand]['_default'] = { standard, shopAds };
                }
                
                showToast('Baseline rates saved!', 'success');
                closeBaselineRatesModal();
                
            } catch (err) {
                console.error('Error saving baseline rates:', err);
                showToast('Error saving rates: ' + err.message, 'error');
            }
        }

        // ==================== MONTHLY PERFORMANCE REPORT ====================
        function openMonthlyReportModal() {
            // Populate month selector
            const monthSelect = document.getElementById('reportMonth');
            const now = new Date();
            const months = [];
            
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                months.push({ value, label });
            }
            
            monthSelect.innerHTML = months.map((m, i) => 
                `<option value="${m.value}" ${i === 1 ? 'selected' : ''}>${m.label}</option>`
            ).join('');
            
            document.getElementById('monthlyReportModal').classList.add('show');
        }

        function closeMonthlyReportModal() {
            document.getElementById('monthlyReportModal').classList.remove('show');
        }

        async function generateMonthlyReport() {
            const brand = document.getElementById('reportBrand').value;
            const monthValue = document.getElementById('reportMonth').value;
            const [year, month] = monthValue.split('-');
            const monthName = new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const preview = document.getElementById('monthlyReportPreview');
            preview.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">Generating report...</div>';
            
            try {
                // 1. Get performance data (GMV, orders) for the month
                const startDate = `${monthValue}-01`;
                const endDate = new Date(year, month, 0).toISOString().split('T')[0]; // Last day of month
                
                const { data: perfData, error: perfError } = await supabaseClient
                    .from('creator_performance')
                    .select('*')
                    .eq('brand', brand)
                    .gte('report_date', startDate)
                    .lte('report_date', endDate);
                
                if (perfError) throw perfError;
                
                // Aggregate by creator
                const creatorStats = {};
                let totalGmv = 0, totalOrders = 0;
                
                (perfData || []).forEach(row => {
                    const name = row.creator_name;
                    if (!creatorStats[name]) {
                        creatorStats[name] = { gmv: 0, orders: 0 };
                    }
                    creatorStats[name].gmv += parseFloat(row.gmv) || 0;
                    creatorStats[name].orders += parseInt(row.orders) || 0;
                    totalGmv += parseFloat(row.gmv) || 0;
                    totalOrders += parseInt(row.orders) || 0;
                });
                
                const creatorList = Object.entries(creatorStats)
                    .map(([name, stats]) => ({ name, ...stats }))
                    .sort((a, b) => b.gmv - a.gmv);
                
                // 2. Get payments data for the month (retainers, top-ups paid)
                const { data: paymentsData, error: paymentsError } = await supabaseClient
                    .from('creator_payments')
                    .select('*')
                    .eq('brand', brand)
                    .eq('period_month', monthValue)
                    .eq('status', 'paid');
                
                if (paymentsError) throw paymentsError;
                
                let totalRetainersPaid = 0, totalTopUpsPaid = 0, totalBonusesPaid = 0;
                const paidRetainers = [];
                const paidTopUps = [];
                
                (paymentsData || []).forEach(p => {
                    const amt = parseFloat(p.amount) || 0;
                    if (p.payment_type === 'retainer') {
                        totalRetainersPaid += amt;
                        paidRetainers.push({ name: p.creator_name, amount: amt });
                    } else if (p.payment_type === 'commission_topup') {
                        totalTopUpsPaid += amt;
                        paidTopUps.push({ name: p.creator_name, amount: amt });
                    } else if (p.payment_type === 'bonus') {
                        totalBonusesPaid += amt;
                    }
                });
                
                // 3. Calculate creator commissions (what TikTok pays creators)
                // Assuming average 10% commission to creators on GMV
                const avgCreatorCommissionRate = 0.10;
                const estimatedCreatorCommissions = totalGmv * avgCreatorCommissionRate;
                
                // 4. Get CC fees from calculator data (stored rates/retainers)
                const brandRate = parseFloat(localStorage.getItem(`rate_${brand}`)) || 2;
                const ccRetainer = parseFloat(localStorage.getItem(`retainer_${brand}`)) || 0;
                const ccCommission = totalGmv * (brandRate / 100);
                const ccTotal = ccCommission + ccRetainer;
                
                // 5. Calculate totals
                const totalBrandSpend = estimatedCreatorCommissions + totalRetainersPaid + totalTopUpsPaid + totalBonusesPaid + ccTotal;
                const roi = totalBrandSpend > 0 ? (totalGmv / totalBrandSpend) : 0;
                const costPerOrder = totalOrders > 0 ? (totalBrandSpend / totalOrders) : 0;
                
                // Generate HTML
                preview.innerHTML = `
                    <div style="padding: 40px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                            <div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px;">Monthly Performance & ROI Report</div>
                            <div style="font-size: 28px; font-weight: 700; color: #1a1a1a; margin: 8px 0;">${BRAND_DISPLAY[brand] || brand}</div>
                            <div style="font-size: 16px; color: #666;">${monthName}</div>
                        </div>
                        
                        <!-- Executive Summary -->
                        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 24px; margin-bottom: 30px;">
                            <div style="font-size: 14px; font-weight: 600; color: #166534; margin-bottom: 16px;"> Executive Summary</div>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; text-align: center;">
                                <div>
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Total GMV</div>
                                    <div style="font-size: 22px; font-weight: 700; color: #1a1a1a;">$${totalGmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Total Orders</div>
                                    <div style="font-size: 22px; font-weight: 700; color: #1a1a1a;">${totalOrders.toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Brand Spend</div>
                                    <div style="font-size: 22px; font-weight: 700; color: #dc2626;">$${totalBrandSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 8px;">
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">ROI</div>
                                    <div style="font-size: 22px; font-weight: 700; color: #16a34a;">${roi.toFixed(1)}x</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Cost/Order</div>
                                    <div style="font-size: 22px; font-weight: 700; color: #1a1a1a;">$${costPerOrder.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Spend Breakdown -->
                        <div style="margin-bottom: 30px;">
                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;"> Brand Spend Breakdown</div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="text-align: left; padding: 10px 12px; color: #666;">Category</th>
                                        <th style="text-align: right; padding: 10px 12px; color: #666;">Amount</th>
                                        <th style="text-align: right; padding: 10px 12px; color: #666;">% of Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px 12px;">Creator Commissions (est. 10% of GMV)</td>
                                        <td style="text-align: right; padding: 10px 12px;">$${estimatedCreatorCommissions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 10px 12px; color: #666;">${totalBrandSpend > 0 ? ((estimatedCreatorCommissions / totalBrandSpend) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px 12px;">Creator Retainers Paid (${paidRetainers.length} creators)</td>
                                        <td style="text-align: right; padding: 10px 12px;">$${totalRetainersPaid.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 10px 12px; color: #666;">${totalBrandSpend > 0 ? ((totalRetainersPaid / totalBrandSpend) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    ${totalTopUpsPaid > 0 ? `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px 12px;">Commission Top-Ups (${paidTopUps.length} creators)</td>
                                        <td style="text-align: right; padding: 10px 12px;">$${totalTopUpsPaid.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 10px 12px; color: #666;">${((totalTopUpsPaid / totalBrandSpend) * 100).toFixed(1)}%</td>
                                    </tr>
                                    ` : ''}
                                    ${totalBonusesPaid > 0 ? `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px 12px;">Bonuses</td>
                                        <td style="text-align: right; padding: 10px 12px;">$${totalBonusesPaid.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 10px 12px; color: #666;">${((totalBonusesPaid / totalBrandSpend) * 100).toFixed(1)}%</td>
                                    </tr>
                                    ` : ''}
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px 12px;">Creators Corner Commission (${brandRate}%)</td>
                                        <td style="text-align: right; padding: 10px 12px;">$${ccCommission.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 10px 12px; color: #666;">${totalBrandSpend > 0 ? ((ccCommission / totalBrandSpend) * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    ${ccRetainer > 0 ? `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px 12px;">Creators Corner Retainer</td>
                                        <td style="text-align: right; padding: 10px 12px;">$${ccRetainer.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 10px 12px; color: #666;">${((ccRetainer / totalBrandSpend) * 100).toFixed(1)}%</td>
                                    </tr>
                                    ` : ''}
                                </tbody>
                                <tfoot>
                                    <tr style="background: #fef2f2;">
                                        <td style="padding: 12px; font-weight: 700;">TOTAL BRAND SPEND</td>
                                        <td style="text-align: right; padding: 12px; font-weight: 700; color: #dc2626;">$${totalBrandSpend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 12px; font-weight: 700;">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Creator Performance -->
                        <div style="margin-bottom: 30px;">
                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;"> Creator Performance (${creatorList.length} creators)</div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="text-align: left; padding: 8px 10px; color: #666;">#</th>
                                        <th style="text-align: left; padding: 8px 10px; color: #666;">Creator</th>
                                        <th style="text-align: right; padding: 8px 10px; color: #666;">GMV</th>
                                        <th style="text-align: right; padding: 8px 10px; color: #666;">Orders</th>
                                        <th style="text-align: right; padding: 8px 10px; color: #666;">% of Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${creatorList.map((c, i) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 6px 10px; color: #888;">${i + 1}</td>
                                            <td style="padding: 6px 10px;">@${c.name}</td>
                                            <td style="text-align: right; padding: 6px 10px; font-weight: 500;">$${c.gmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                            <td style="text-align: right; padding: 6px 10px;">${c.orders.toLocaleString()}</td>
                                            <td style="text-align: right; padding: 6px 10px; color: #666;">${totalGmv > 0 ? ((c.gmv / totalGmv) * 100).toFixed(1) : 0}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f0fdf4; font-weight: 600;">
                                        <td colspan="2" style="padding: 10px;">TOTAL</td>
                                        <td style="text-align: right; padding: 10px;">$${totalGmv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td style="text-align: right; padding: 10px;">${totalOrders.toLocaleString()}</td>
                                        <td style="text-align: right; padding: 10px;">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- ROI Analysis -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;"> ROI Analysis</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                                <div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">GMV : Spend Ratio</div>
                                    <div style="font-size: 28px; font-weight: 700; color: #16a34a;">${roi.toFixed(1)} : 1</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Avg Order Value</div>
                                    <div style="font-size: 28px; font-weight: 700; color: #1a1a1a;">$${totalOrders > 0 ? (totalGmv / totalOrders).toFixed(2) : '0.00'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Cost per $1 GMV</div>
                                    <div style="font-size: 28px; font-weight: 700; color: #1a1a1a;">$${totalGmv > 0 ? (totalBrandSpend / totalGmv).toFixed(2) : '0.00'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #888; font-size: 11px;">
                            Report generated by Creators Corner  ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                `;
                
            } catch (err) {
                console.error('Failed to generate report:', err);
                preview.innerHTML = `<div style="padding: 40px; text-align: center; color: #dc2626;">Error generating report: ${err.message}</div>`;
            }
        }

        function downloadReportPDF() {
            const content = document.getElementById('monthlyReportPreview').innerHTML;
            const brand = document.getElementById('reportBrand').value;
            const month = document.getElementById('reportMonth').value;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${BRAND_DISPLAY[brand] || brand} - ${month} Report</title>
                    <style>
                        body { margin: 0; padding: 0; }
                        @media print {
                            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                        }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyReportHTML() {
            const content = document.getElementById('monthlyReportPreview').innerHTML;
            navigator.clipboard.writeText(content).then(() => {
                showToast('HTML copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        // ==================== SPEND FORECAST ====================
        
        function openForecastModal() {
            // Populate month options (current month + next 2 months)
            const select = document.getElementById('forecastMonth');
            const now = new Date();
            const months = [];
            
            for (let i = 0; i < 3; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                months.push({ value, label });
            }
            
            select.innerHTML = months.map((m, i) => 
                `<option value="${m.value}" ${i === 0 ? 'selected' : ''}>${m.label}</option>`
            ).join('');
            
            document.getElementById('forecastModal').classList.add('show');
            generateForecast();
        }
        
        function closeForecastModal() {
            document.getElementById('forecastModal').classList.remove('show');
        }
        
        async function generateForecast() {
            const brand = document.getElementById('forecastBrand').value;
            const monthValue = document.getElementById('forecastMonth').value;
            const [year, month] = monthValue.split('-');
            const monthName = new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const content = document.getElementById('forecastContent');
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Calculating forecast...</div>';
            
            try {
                // 1. Get all creators on retainer for this brand
                const { data: rosterData, error: rosterError } = await supabaseClient
                    .from('managed_creators')
                    .select('account_1, real_name, discord_name, retainer')
                    .eq('brand', brand);
                
                if (rosterError) throw rosterError;
                
                const creatorsOnRetainer = (rosterData || []).filter(c => c.retainer && parseFloat(c.retainer) > 0);
                const maxRetainerSpend = creatorsOnRetainer.reduce((sum, c) => sum + parseFloat(c.retainer), 0);
                const retainerCount = creatorsOnRetainer.length;
                
                // 2. Get historical claim data (last 3 months of paid retainers)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                const historicalStartMonth = `${threeMonthsAgo.getFullYear()}-${String(threeMonthsAgo.getMonth() + 1).padStart(2, '0')}`;
                
                const { data: historicalPayments, error: histError } = await supabaseClient
                    .from('creator_payments')
                    .select('creator_name, amount, period_month, payment_type')
                    .eq('brand', brand)
                    .eq('payment_type', 'retainer')
                    .eq('status', 'paid')
                    .gte('period_month', historicalStartMonth);
                
                if (histError) throw histError;
                
                // Calculate historical claim rate
                let claimRate = 0.75; // Default 75% if no history
                let historicalMonths = 0;
                let totalHistoricalClaimed = 0;
                let totalHistoricalPossible = 0;
                
                if (historicalPayments && historicalPayments.length > 0) {
                    // Group by month
                    const monthlyData = {};
                    historicalPayments.forEach(p => {
                        if (!monthlyData[p.period_month]) {
                            monthlyData[p.period_month] = { claimed: 0, claimants: new Set() };
                        }
                        monthlyData[p.period_month].claimed += parseFloat(p.amount);
                        monthlyData[p.period_month].claimants.add(p.creator_name);
                    });
                    
                    historicalMonths = Object.keys(monthlyData).length;
                    
                    // For each historical month, calculate what % of max was claimed
                    Object.values(monthlyData).forEach(m => {
                        totalHistoricalClaimed += m.claimed;
                        totalHistoricalPossible += maxRetainerSpend; // Assume same roster size
                    });
                    
                    if (totalHistoricalPossible > 0) {
                        claimRate = totalHistoricalClaimed / totalHistoricalPossible;
                        claimRate = Math.min(Math.max(claimRate, 0.3), 1.0); // Clamp between 30% and 100%
                    }
                }
                
                // 3. Get already paid/pending for this month
                const { data: currentMonthPayments } = await supabaseClient
                    .from('creator_payments')
                    .select('creator_name, amount, status, payment_type')
                    .eq('brand', brand)
                    .eq('period_month', monthValue);
                
                const alreadyPaid = (currentMonthPayments || [])
                    .filter(p => p.status === 'paid' && p.payment_type === 'retainer')
                    .reduce((sum, p) => sum + parseFloat(p.amount), 0);
                    
                const pendingApproval = (currentMonthPayments || [])
                    .filter(p => (p.status === 'pending' || p.status === 'approved') && p.payment_type === 'retainer')
                    .reduce((sum, p) => sum + parseFloat(p.amount), 0);
                
                const paidCreators = new Set((currentMonthPayments || [])
                    .filter(p => p.payment_type === 'retainer')
                    .map(p => p.creator_name.toLowerCase()));
                
                // 4. Calculate forecasts
                const estimatedSpend = maxRetainerSpend * claimRate;
                const remainingEstimate = Math.max(0, estimatedSpend - alreadyPaid - pendingApproval);
                const lowEstimate = maxRetainerSpend * Math.max(0.5, claimRate - 0.15);
                const highEstimate = maxRetainerSpend * Math.min(1.0, claimRate + 0.10);
                
                // 5. List unclaimed creators
                const unclaimedCreators = creatorsOnRetainer
                    .filter(c => !paidCreators.has((c.real_name || c.discord_name || c.account_1 || '').toLowerCase()))
                    .sort((a, b) => parseFloat(b.retainer) - parseFloat(a.retainer));
                
                // Render forecast
                content.innerHTML = `
                    <div style="display: grid; gap: 20px;">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">Max Possible</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${fmtMoney(maxRetainerSpend)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${retainerCount} creators</div>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--purple-dim), var(--bg-secondary)); border-radius: 12px; padding: 16px; text-align: center; border: 1px solid var(--purple);">
                                <div style="font-size: 0.8rem; color: var(--purple); margin-bottom: 4px;">Estimated Spend</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple);">${fmtMoney(estimatedSpend)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${Math.round(claimRate * 100)}% claim rate</div>
                            </div>
                            <div style="background: var(--success-dim); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--success); margin-bottom: 4px;">Already Paid</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${fmtMoney(alreadyPaid)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${paidCreators.size} creators</div>
                            </div>
                            <div style="background: var(--warning-dim); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--warning); margin-bottom: 4px;">Pending</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${fmtMoney(pendingApproval)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">awaiting approval</div>
                            </div>
                        </div>
                        
                        <!-- Range Estimate -->
                        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px;">
                            <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 12px;"> Spend Range Estimate</div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Conservative</div>
                                    <div style="font-size: 1.2rem; font-weight: 600;">${fmtMoney(lowEstimate)}</div>
                                </div>
                                <div style="flex: 2; height: 8px; background: linear-gradient(90deg, var(--success), var(--warning), var(--danger)); border-radius: 4px; position: relative;">
                                    <div style="position: absolute; left: ${Math.min(100, (estimatedSpend / maxRetainerSpend) * 100)}%; top: -6px; width: 3px; height: 20px; background: var(--text-primary); border-radius: 2px;"></div>
                                </div>
                                <div style="text-align: center; flex: 1;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Optimistic</div>
                                    <div style="font-size: 1.2rem; font-weight: 600;">${fmtMoney(highEstimate)}</div>
                                </div>
                            </div>
                            ${historicalMonths > 0 ? `
                                <div style="margin-top: 12px; font-size: 0.8rem; color: var(--text-muted);">
                                    Based on ${historicalMonths} months of payment history (${Math.round(claimRate * 100)}% average claim rate)
                                </div>
                            ` : `
                                <div style="margin-top: 12px; font-size: 0.8rem; color: var(--warning);">
                                     No payment history yet - using 75% default claim rate. Accuracy will improve as you track payments.
                                </div>
                            `}
                        </div>
                        
                        <!-- Unclaimed Creators -->
                        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-size: 0.9rem; font-weight: 600;"> Not Yet Claimed This Month (${unclaimedCreators.length})</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Potential: ${fmtMoney(unclaimedCreators.reduce((s, c) => s + parseFloat(c.retainer), 0))}
                                </div>
                            </div>
                            ${unclaimedCreators.length === 0 ? `
                                <div style="color: var(--success); text-align: center; padding: 20px;"> All creators have claimed!</div>
                            ` : `
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table style="width: 100%; font-size: 0.85rem;">
                                        ${unclaimedCreators.slice(0, 15).map(c => `
                                            <tr style="border-bottom: 1px solid var(--border);">
                                                <td style="padding: 8px 0;">${c.real_name || c.discord_name || c.account_1}</td>
                                                <td style="padding: 8px 0; text-align: right; color: var(--success);">${fmtMoney(c.retainer)}</td>
                                            </tr>
                                        `).join('')}
                                        ${unclaimedCreators.length > 15 ? `
                                            <tr><td colspan="2" style="padding: 8px 0; color: var(--text-muted); text-align: center;">
                                                +${unclaimedCreators.length - 15} more creators
                                            </td></tr>
                                        ` : ''}
                                    </table>
                                </div>
                            `}
                        </div>
                        
                        <!-- Quick Summary for Copy -->
                        <div id="forecastSummaryText" style="display: none;">
${BRAND_DISPLAY[brand]} - ${monthName} Spend Forecast

Max Possible: ${fmtMoney(maxRetainerSpend)} (${retainerCount} creators on retainer)
Estimated Spend: ${fmtMoney(estimatedSpend)} (${Math.round(claimRate * 100)}% claim rate)
Range: ${fmtMoney(lowEstimate)} - ${fmtMoney(highEstimate)}

Already Paid: ${fmtMoney(alreadyPaid)}
Pending Approval: ${fmtMoney(pendingApproval)}
Remaining Estimate: ${fmtMoney(remainingEstimate)}

${unclaimedCreators.length} creators have not yet claimed.
                        </div>
                    </div>
                `;
                
            } catch (err) {
                console.error('Failed to generate forecast:', err);
                content.innerHTML = `<div style="padding: 40px; text-align: center; color: var(--danger);">Error: ${err.message}</div>`;
            }
        }
        
        function copyForecastToClipboard() {
            const summaryEl = document.getElementById('forecastSummaryText');
            if (!summaryEl) {
                showToast('Generate forecast first', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(summaryEl.textContent.trim()).then(() => {
                showToast('Forecast copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        function filterPaymentsByStatus(status) {
            setPaymentsStatusFilter(status);
        }

        // Legacy function redirect
        function loadPaymentsData() {
            loadPaymentsView();
        }

        function openBulkPaymentModal() {
            if (selectedPaymentIds.size === 0) {
                showToast('Select payments first', 'error');
                return;
            }
            document.getElementById('bulkPaymentModal').classList.add('show');
        }

        function closeBulkPaymentModal() {
            document.getElementById('bulkPaymentModal').classList.remove('show');
        }

        async function applyBulkPayment() {
            if (selectedPaymentIds.size === 0) return;
            
            const status = document.getElementById('bulkPaymentStatus').value;
            const method = document.getElementById('bulkPaymentMethod').value;
            const reference = document.getElementById('bulkPaymentReference').value;
            
            try {
                const updateData = {
                    status: status,
                    updated_at: new Date().toISOString()
                };
                
                if (method) updateData.payment_method = method;
                if (reference) updateData.payment_reference = reference;
                if (status === 'paid') updateData.paid_at = new Date().toISOString();
                
                const ids = Array.from(selectedPaymentIds);
                
                const { error } = await supabaseClient
                    .from('creator_payments')
                    .update(updateData)
                    .in('id', ids);
                
                if (error) throw error;
                
                showToast(`Updated ${ids.length} payments!`, 'success');
                selectedPaymentIds.clear();
                closeBulkPaymentModal();
                loadPaymentsView();
            } catch (err) {
                console.error('Failed to bulk update:', err);
                showToast('Failed to update payments', 'error');
            }
        }

        async function exportPaymentsCSV() {
            try {
                const brandFilter = document.getElementById('paymentsBrandFilter')?.value || 'all';
                const periodFilter = document.getElementById('paymentsPeriodFilter')?.value || '';
                
                let query = supabaseClient.from('creator_payments').select('*').order('creator_name');
                if (brandFilter !== 'all') query = query.eq('brand', brandFilter);
                if (periodFilter) query = query.eq('period_month', periodFilter);
                if (paymentsStatusFilter !== 'all') query = query.eq('status', paymentsStatusFilter);
                
                const { data, error } = await query;
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    showToast('No data to export', 'warning');
                    return;
                }
                
                // CSV header
                const headers = ['Creator', 'Brand', 'Type', 'Amount', 'Period', 'Status', 'Date Submitted', 'Date Approved', 'Date Paid', 'Notes'];
                const rows = data.map(p => [
                    p.creator_name,
                    BRAND_DISPLAY[p.brand] || p.brand,
                    p.payment_type,
                    p.amount,
                    p.period_month,
                    p.status,
                    p.date_submitted || '',
                    p.date_approved || '',
                    p.date_paid || '',
                    (p.notes || '').replace(/,/g, ';').replace(/\n/g, ' ')
                ]);
                
                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payments_export_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                
                showToast('CSV exported!', 'success');
            } catch (err) {
                console.error('Failed to export:', err);
                showToast('Failed to export', 'error');
            }
        }

        // ==================== GENERATE PAYMENTS FROM PERFORMANCE ====================
        // ==================== GENERATE PAYMENTS ====================
        function openGeneratePaymentsModal() {
            // Set default dates to last week
            setPayPeriodLastWeek();
            document.getElementById('paymentPreviewSection').style.display = 'none';
            document.getElementById('generatePaymentsModal').classList.add('show');
        }
        
        function closeGeneratePaymentsModal() {
            document.getElementById('generatePaymentsModal').classList.remove('show');
        }
        
        function setPayPeriodLastWeek() {
            const end = new Date();
            end.setDate(end.getDate() - 1); // Yesterday
            const start = new Date(end);
            start.setDate(start.getDate() - 6); // 7 days total
            
            document.getElementById('payPeriodStart').value = localDateStr(start);
            document.getElementById('payPeriodEnd').value = localDateStr(end);
        }
        
        function setPayPeriodLast2Weeks() {
            const end = new Date();
            end.setDate(end.getDate() - 1);
            const start = new Date(end);
            start.setDate(start.getDate() - 13); // 14 days total
            
            document.getElementById('payPeriodStart').value = localDateStr(start);
            document.getElementById('payPeriodEnd').value = localDateStr(end);
        }
        
        function setPayPeriodLastMonth() {
            const end = new Date();
            end.setDate(end.getDate() - 1);
            const start = new Date(end);
            start.setMonth(start.getMonth() - 1);
            
            document.getElementById('payPeriodStart').value = localDateStr(start);
            document.getElementById('payPeriodEnd').value = localDateStr(end);
        }
        
        function setPayPeriodThisMonth() {
            const end = new Date();
            end.setDate(end.getDate() - 1);
            const start = new Date(end.getFullYear(), end.getMonth(), 1);
            
            document.getElementById('payPeriodStart').value = localDateStr(start);
            document.getElementById('payPeriodEnd').value = localDateStr(end);
        }
        
        async function previewPayments() {
            const startDate = document.getElementById('payPeriodStart').value;
            const endDate = document.getElementById('payPeriodEnd').value;
            const brandSelect = document.getElementById('paymentsBrandSelect').value;
            
            if (!startDate || !endDate) {
                showToast('Please select a date range', 'error');
                return;
            }
            
            try {
                // Get performance data for the period
                let query = supabaseClient
                    .from('creator_performance')
                    .select('creator_name, brand, gmv')
                    .gte('report_date', startDate)
                    .lte('report_date', endDate);
                
                if (brandSelect !== 'all') {
                    query = query.eq('brand', brandSelect);
                }
                
                const { data: perfData, error: perfError } = await query;
                if (perfError) throw perfError;
                
                // Get roster with commission rates
                const { data: rosterData, error: rosterError } = await supabaseClient
                    .from('managed_creators')
                    .select('account_1, account_2, account_3, account_4, account_5, brand, commission_rate');
                if (rosterError) throw rosterError;
                
                // Build lookup for commission rates
                const commissionLookup = {};
                (rosterData || []).forEach(r => {
                    const rate = parseFloat(r.commission_rate) || 0.10;
                    [r.account_1, r.account_2, r.account_3, r.account_4, r.account_5].forEach(acct => {
                        if (acct) {
                            const key = `${acct.toLowerCase()}|||${r.brand}`;
                            commissionLookup[key] = rate;
                        }
                    });
                });
                
                // Aggregate GMV by creator and brand
                const creatorTotals = {};
                (perfData || []).forEach(row => {
                    const key = `${row.creator_name}|||${row.brand}`;
                    if (!creatorTotals[key]) {
                        creatorTotals[key] = { 
                            creator: row.creator_name, 
                            brand: row.brand, 
                            gmv: 0 
                        };
                    }
                    creatorTotals[key].gmv += parseFloat(row.gmv) || 0;
                });
                
                // Calculate commissions
                const payments = Object.values(creatorTotals)
                    .filter(c => c.gmv > 0)
                    .map(c => {
                        const lookupKey = `${c.creator.toLowerCase()}|||${c.brand}`;
                        const rate = commissionLookup[lookupKey] || 0.10;
                        return {
                            creator: c.creator,
                            brand: c.brand,
                            gmv: c.gmv,
                            rate: rate,
                            amount: c.gmv * rate
                        };
                    })
                    .filter(p => p.amount >= 1) // Only include if $1+
                    .sort((a, b) => b.amount - a.amount);
                
                // Store for confirmation
                window.pendingPayments = payments;
                window.pendingPayPeriod = `${startDate} to ${endDate}`;
                
                // Show preview
                const previewBody = document.getElementById('paymentPreviewBody');
                const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
                
                if (payments.length === 0) {
                    previewBody.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                            No payments to generate for this period.<br>
                            <span style="font-size: 0.85rem;">Make sure creators have GMV and are in the Roster.</span>
                        </div>
                    `;
                } else {
                    previewBody.innerHTML = `
                        <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-light);">
                            <strong>${payments.length} creators</strong>  <strong style="color: var(--success);">${fmtMoney(totalAmount)}</strong> total
                        </div>
                        ${payments.slice(0, 10).map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.85rem;">
                                <span>${p.creator} <span style="color: var(--text-muted);"> ${BRAND_DISPLAY[p.brand] || p.brand}</span></span>
                                <span style="font-weight: 600;">${fmtMoney(p.amount)}</span>
                            </div>
                        `).join('')}
                        ${payments.length > 10 ? `<div style="text-align: center; color: var(--text-muted); padding-top: 8px; font-size: 0.8rem;">+ ${payments.length - 10} more creators</div>` : ''}
                    `;
                }
                
                document.getElementById('paymentPreviewSection').style.display = 'block';
                
            } catch (err) {
                console.error('Failed to preview payments:', err);
                showToast('Failed to generate preview', 'error');
            }
        }
        
        async function confirmGeneratePayments() {
            const payments = window.pendingPayments || [];
            const payPeriod = window.pendingPayPeriod || '';
            
            if (payments.length === 0) {
                showToast('No payments to generate. Preview first.', 'error');
                return;
            }
            
            try {
                // Create payment records
                const records = payments.map(p => ({
                    creator_handle: p.creator,
                    brand: p.brand,
                    pay_period: payPeriod,
                    gmv: p.gmv,
                    commission_rate: p.rate,
                    amount: p.amount,
                    status: 'pending',
                    created_at: new Date().toISOString()
                }));
                
                const { error } = await supabaseClient
                    .from('payment_status')
                    .insert(records);
                
                if (error) throw error;
                
                showToast(`Generated ${payments.length} payment records!`, 'success');
                logActivity('payment', `Generated ${payments.length} payments for ${payPeriod}`, 'all');
                closeGeneratePaymentsModal();
                loadPaymentsData();
                
            } catch (err) {
                console.error('Failed to generate payments:', err);
                showToast('Failed to generate payments: ' + err.message, 'error');
            }
        }

        // ==================== USER MANAGEMENT ====================
        let allUsers = [];
        
        async function loadUsersData() {
            showLoading('users', 'Loading user data...');
            try {
                const statusFilter = document.getElementById('userStatusFilter')?.value || 'all';
                const roleFilter = document.getElementById('userRoleFilter')?.value || 'all';
                
                let query = supabaseClient.from('user_profiles').select('*').order('created_at', { ascending: false });
                
                if (statusFilter !== 'all') {
                    query = query.eq('status', statusFilter);
                }
                if (roleFilter !== 'all') {
                    query = query.eq('role', roleFilter);
                }
                
                const { data, error } = await query;
                if (error) throw error;
                
                allUsers = data || [];
                renderUsersTable(allUsers);
                updateUserStats(allUsers);
                updatePendingBadge(allUsers);
                
            } catch (err) {
                console.error('Error loading users:', err);
                showToast('Failed to load users', 'error');
            } finally {
                hideLoading('users');
            }
        }
        
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const statusColors = {
                    'pending': 'warning',
                    'approved': 'success',
                    'rejected': 'danger'
                };
                const statusIcons = {
                    'pending': '',
                    'approved': '',
                    'rejected': ''
                };
                const roleConfig = {
                    'admin': { icon: '', label: 'Admin', color: '#f5c518', bg: 'rgba(245, 197, 24, 0.15)' },
                    'content_lead': { icon: '', label: 'Content Lead', color: '#ec4899', bg: 'rgba(236, 72, 153, 0.15)' },
                    'analyst': { icon: '', label: 'Analyst', color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.15)' },
                    'payments': { icon: '', label: 'Payments', color: '#22c55e', bg: 'rgba(34, 197, 94, 0.15)' },
                    'automations': { icon: '', label: 'Automations', color: '#6b7280', bg: 'rgba(107, 114, 128, 0.15)' },
                    'va': { icon: '', label: 'VA', color: '#06b6d4', bg: 'rgba(6, 182, 212, 0.15)' },
                    'creator': { icon: '', label: 'Creator', color: '#a855f7', bg: 'rgba(168, 85, 247, 0.15)' },
                    'brand': { icon: '', label: 'Brand', color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.15)' }
                };
                
                const status = user.status || 'pending';
                const role = user.role || 'creator';
                const roleInfo = roleConfig[role] || roleConfig.creator;
                const initial = (user.name || user.email || '?')[0].toUpperCase();
                const avatarUrl = user.discord_avatar ? 
                    `https://cdn.discordapp.com/avatars/${user.discord_id}/${user.discord_avatar}.png` : null;
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${avatarUrl ? 
                                    `<img src="${avatarUrl}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--accent);">` :
                                    `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent-dim); border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--accent); font-size: 0.8rem;">${initial}</div>`
                                }
                                <span style="font-weight: 600;">${user.name || 'Unknown'}</span>
                            </div>
                        </td>
                        <td style="color: var(--text-muted); font-size: 0.85rem;">${user.email || '-'}</td>
                        <td><span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: ${roleInfo.bg}; color: ${roleInfo.color};">${roleInfo.icon} ${roleInfo.label}</span></td>
                        <td><span class="badge badge-${statusColors[status] || 'secondary'}">${statusIcons[status] || ''} ${status.toUpperCase()}</span></td>
                        <td>${user.creator_handle ? `<span style="color: var(--accent);">@${user.creator_handle}</span>` : '<span style="color: var(--text-muted);">-</span>'}</td>
                        <td>${user.brand ? `<span class="badge badge-outline">${BRAND_DISPLAY[user.brand] || user.brand}</span>` : '<span style="color: var(--text-muted);">-</span>'}</td>
                        <td style="color: var(--text-muted); font-size: 0.8rem;">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td style="text-align: right;">
                            <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                ${status === 'pending' ? `
                                    <button class="btn btn-small btn-success" onclick="quickApproveUser('${user.id}')" title="Approve"></button>
                                    <button class="btn btn-small btn-danger" onclick="quickRejectUser('${user.id}')" title="Reject"></button>
                                ` : ''}
                                <button class="btn btn-small" onclick="openEditUserModal('${user.id}')" title="Edit"></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateUserStats(users) {
            const pending = users.filter(u => !u.status || u.status === 'pending').length;
            const approved = users.filter(u => u.status === 'approved').length;
            const creators = users.filter(u => u.role === 'creator').length;
            const teamRoles = ['admin', 'content_lead', 'analyst', 'payments', 'automations', 'va'];
            const team = users.filter(u => teamRoles.includes(u.role)).length;
            
            document.getElementById('statPendingUsers').textContent = pending;
            document.getElementById('statApprovedUsers').textContent = approved;
            document.getElementById('statCreatorUsers').textContent = creators;
            document.getElementById('statTotalUsers').textContent = team;
            
            // Store for later use
            window.userStats = { pending, approved, creators, team, total: users.length };
        }
        
        function filterUsersByStatus(status) {
            document.getElementById('userStatusFilter').value = status;
            document.getElementById('userRoleFilter').value = 'all';
            loadUsersData();
        }
        
        function filterUsersByRole(role) {
            document.getElementById('userRoleFilter').value = role;
            document.getElementById('userStatusFilter').value = 'all';
            loadUsersData();
        }
        
        async function quickApproveUser(userId) {
            try {
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update({ status: 'approved' })
                    .eq('id', userId);
                
                if (error) throw error;
                showToast('User approved!', 'success');
                loadUsersData();
            } catch (err) {
                console.error('Error approving user:', err);
                showToast('Failed to approve user', 'error');
            }
        }
        
        async function quickRejectUser(userId) {
            if (!confirm('Are you sure you want to reject this user?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update({ status: 'rejected' })
                    .eq('id', userId);
                
                if (error) throw error;
                showToast('User rejected', 'success');
                loadUsersData();
            } catch (err) {
                console.error('Error rejecting user:', err);
                showToast('Failed to reject user', 'error');
            }
        }
        
        function updatePendingBadge(users) {
            const pending = users.filter(u => !u.status || u.status === 'pending').length;
            const badge = document.getElementById('pendingUsersBadge');
            if (badge) {
                badge.textContent = pending;
                badge.style.display = pending > 0 ? 'inline-block' : 'none';
            }
        }
        
        // Lightweight function to update pending users badge on init
        async function updatePendingUsersBadge() {
            try {
                // Get pending counts from all user types
                const [internalRes, brandsRes] = await Promise.all([
                    supabaseClient.from('user_profiles').select('id, status').eq('status', 'pending'),
                    supabaseClient.from('brand_portal_users').select('id, status').eq('status', 'pending')
                ]);
                
                const pendingInternal = (internalRes.data || []).length;
                const pendingBrands = (brandsRes.data || []).length;
                const pendingTotal = pendingInternal + pendingBrands;
                
                const badge = document.getElementById('pendingUsersBadge');
                if (badge) {
                    badge.textContent = pendingTotal;
                    badge.style.display = pendingTotal > 0 ? 'inline-block' : 'none';
                }
                
                console.log(`Pending users badge: ${pendingTotal} (internal: ${pendingInternal}, brands: ${pendingBrands})`);
            } catch (err) {
                console.warn('Could not update pending users badge:', err);
            }
        }
        
        async function quickApproveUser(userId) {
            try {
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update({ status: 'approved', updated_at: new Date().toISOString() })
                    .eq('id', userId);
                    
                if (error) throw error;
                
                showToast('User approved!', 'success');
                logActivity('edit', 'Quick approved user', null, { user_id: userId });
                loadUsersData();
            } catch (err) {
                console.error('Error approving user:', err);
                showToast('Failed to approve user', 'error');
            }
        }
        
        async function quickRejectUser(userId) {
            if (!confirm('Are you sure you want to reject this user?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update({ status: 'rejected', updated_at: new Date().toISOString() })
                    .eq('id', userId);
                    
                if (error) throw error;
                
                showToast('User rejected', 'warning');
                logActivity('edit', 'Rejected user', null, { user_id: userId });
                loadUsersData();
            } catch (err) {
                console.error('Error rejecting user:', err);
                showToast('Failed to reject user', 'error');
            }
        }
        
        function openEditUserModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').textContent = user.name || 'Unknown';
            document.getElementById('editUserEmail').textContent = user.email || '';
            document.getElementById('editUserStatus').value = user.status || 'pending';
            document.getElementById('editUserRole').value = user.role || 'creator';
            document.getElementById('editCreatorHandle').value = user.creator_handle || '';
            document.getElementById('editUserBrand').value = user.brand || '';
            
            // Set avatar
            const avatarEl = document.getElementById('editUserAvatar');
            if (user.discord_avatar && user.discord_id) {
                avatarEl.innerHTML = `<img src="https://cdn.discordapp.com/avatars/${user.discord_id}/${user.discord_avatar}.png" style="width: 100%; height: 100%; border-radius: 50%;">`;
            } else {
                avatarEl.textContent = (user.name || user.email || '?')[0].toUpperCase();
            }
            
            toggleUserRoleFields();
            document.getElementById('editUserModal').classList.add('show');
        }
        
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('show');
        }
        
        function toggleUserRoleFields() {
            const role = document.getElementById('editUserRole').value;
            document.getElementById('creatorFields').style.display = role === 'creator' ? 'block' : 'none';
            document.getElementById('brandFields').style.display = role === 'brand' ? 'block' : 'none';
        }
        
        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const status = document.getElementById('editUserStatus').value;
            const role = document.getElementById('editUserRole').value;
            const creatorHandle = document.getElementById('editCreatorHandle').value.replace('@', '').trim();
            const brand = document.getElementById('editUserBrand').value;
            
            try {
                const updateData = {
                    status,
                    role,
                    creator_handle: role === 'creator' ? creatorHandle : null,
                    brand: role === 'brand' ? brand : null,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update(updateData)
                    .eq('id', userId);
                    
                if (error) throw error;
                
                showToast('User updated successfully!', 'success');
                logActivity('edit', `Updated user: ${document.getElementById('editUserName').textContent}`, null, updateData);
                closeEditUserModal();
                loadUsersData();
            } catch (err) {
                console.error('Error saving user:', err);
                showToast('Failed to save changes', 'error');
            }
        }
        
        async function rejectUser() {
            const userId = document.getElementById('editUserId').value;
            if (!confirm('Are you sure you want to reject this user?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update({ status: 'rejected', updated_at: new Date().toISOString() })
                    .eq('id', userId);
                    
                if (error) throw error;
                
                showToast('User rejected', 'warning');
                logActivity('edit', `Rejected user: ${document.getElementById('editUserName').textContent}`);
                closeEditUserModal();
                loadUsersData();
            } catch (err) {
                console.error('Error rejecting user:', err);
                showToast('Failed to reject user', 'error');
            }
        }

        // ==================== CONSOLIDATED USER MANAGEMENT ====================
        let currentUsersTab = 'internal';
        let currentCreatorsSubTab = 'roster';
        let internalTeamData = [];
        let creatorsData = [];
        let brandsData = [];
        let accountRequestsData = [];
        let applicationsData = [];

        // Tab switching
        function switchUsersTab(tab) {
            currentUsersTab = tab;
            
            // Update tab button styling (using IDs to avoid conflict with Ops Center tabs)
            ['internal', 'creators', 'brands'].forEach(t => {
                const btn = document.getElementById(`usersTab-${t}-btn`);
                if (btn) {
                    if (t === tab) {
                        btn.classList.add('active');
                        btn.style.background = 'var(--bg-card)';
                        btn.style.color = 'var(--text-primary)';
                        btn.style.fontWeight = '600';
                        btn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    } else {
                        btn.classList.remove('active');
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--text-muted)';
                        btn.style.fontWeight = '500';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Update tab content
            document.querySelectorAll('.users-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`usersTab-${tab}`).style.display = 'block';
            
            // Load data for the tab
            if (tab === 'internal') loadInternalTeam();
            else if (tab === 'creators') {
                // Load the roster by default, and trigger the current sub-tab
                switchCreatorsSubTab(currentCreatorsSubTab || 'roster');
            }
            else if (tab === 'brands') loadBrandsTab();
        }

        function switchCreatorsSubTab(subTab) {
            currentCreatorsSubTab = subTab;
            
            // Update sub-tab button styling
            ['roster', 'claims', 'requests', 'applications'].forEach(t => {
                const btn = document.getElementById(`creatorsSubTab-${t}`);
                if (btn) {
                    if (t === subTab) {
                        btn.style.background = 'var(--bg-card)';
                        btn.style.color = 'var(--text-primary)';
                        btn.style.fontWeight = '600';
                        btn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
                    } else {
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--text-muted)';
                        btn.style.fontWeight = '500';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Update sub-tab content
            document.querySelectorAll('[id^="creatorsSubContent-"]').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`creatorsSubContent-${subTab}`).style.display = 'block';
            
            // Load data
            if (subTab === 'roster') loadCreatorsRoster();
            else if (subTab === 'claims') loadClaimRequests();
            else if (subTab === 'requests') loadAccountRequests();
            else if (subTab === 'applications') loadApplicationsSubTab();
        }

        function refreshUsersTab() {
            if (currentUsersTab === 'internal') loadInternalTeam();
            else if (currentUsersTab === 'creators') loadRosterTab();
            else if (currentUsersTab === 'brands') loadBrandsTab();
            showToast('Refreshed!', 'success');
        }

        // Load all counts for stats
        async function loadUsersData() {
            showLoading('users', 'Loading user data...');
            try {
                // Load counts in parallel
                const [internalRes, creatorsRes, brandsRes] = await Promise.all([
                    supabaseClient.from('user_profiles').select('id, status, role').in('role', ['admin', 'content_lead', 'analyst', 'payments', 'automations', 'va']),
                    supabaseClient.from('managed_creators').select('id'),
                    supabaseClient.from('brand_portal_users').select('id, status')
                ]);

                // Calculate counts
                const internalData = internalRes.data || [];
                const creatorsDataAll = creatorsRes.data || [];
                const brandsDataAll = brandsRes.data || [];

                const internalCount = internalData.length;
                const creatorsCount = creatorsDataAll.length;
                const brandsCount = brandsDataAll.length;

                const pendingInternal = internalData.filter(u => u.status === 'pending').length;
                const pendingCreators = 0; // managed_creators doesn't have status column
                const pendingBrands = brandsDataAll.filter(b => b.status === 'pending').length;
                const pendingTotal = pendingInternal + pendingCreators + pendingBrands;

                // Update stats
                document.getElementById('statInternalCount').textContent = internalCount;
                document.getElementById('statCreatorsCount').textContent = creatorsCount;
                document.getElementById('statBrandsCount').textContent = brandsCount;
                document.getElementById('statPendingTotal').textContent = pendingTotal;

                // Update badges
                updateTabBadge('internalPendingBadge', pendingInternal);
                updateTabBadge('creatorsPendingBadge', pendingCreators);
                updateTabBadge('brandsPendingBadge', pendingBrands);
                updateTabBadge('pendingUsersBadge', pendingTotal);

                // Load current tab data
                if (currentUsersTab === 'internal') await loadInternalTeam();
                else if (currentUsersTab === 'creators') await loadRosterTab();
                else if (currentUsersTab === 'brands') await loadBrandsTab();

            } catch (err) {
                console.error('Error loading users data:', err);
                showToast('Failed to load users', 'error');
            } finally {
                hideLoading('users');
            }
        }

        function updateTabBadge(id, count) {
            const badge = document.getElementById(id);
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }

        // ==================== INTERNAL TEAM TAB ====================
        let pendingAccessRequests = [];
        
        async function loadInternalTeam() {
            const tbody = document.getElementById('internalTeamBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';

            try {
                // Load pending access requests first
                await loadPendingAccessRequests();
                
                const statusFilter = document.getElementById('internalStatusFilter')?.value || 'all';
                const roleFilter = document.getElementById('internalRoleFilter')?.value || 'all';

                let query = supabaseClient.from('user_profiles')
                    .select('*')
                    .in('role', ['admin', 'content_lead', 'analyst', 'payments', 'automations', 'va'])
                    .order('created_at', { ascending: false });

                if (statusFilter !== 'all') query = query.eq('status', statusFilter);
                if (roleFilter !== 'all') query = query.eq('role', roleFilter);

                const { data, error } = await query;
                if (error) throw error;

                internalTeamData = data || [];
                renderInternalTeamTable(internalTeamData);

            } catch (err) {
                console.error('Error loading internal team:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--danger);">Failed to load team data</td></tr>';
            }
        }

        async function loadPendingAccessRequests() {
            try {
                const { data, error } = await supabaseClient
                    .from('admin_access_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.log('Access requests table may not exist yet:', error.message);
                    pendingAccessRequests = [];
                } else {
                    pendingAccessRequests = data || [];
                }

                renderPendingAccessRequests();
                
                // Update badge
                const badge = document.getElementById('internalPendingBadge');
                if (badge) {
                    const totalPending = pendingAccessRequests.length + (internalTeamData?.filter(u => u.status === 'pending').length || 0);
                    badge.textContent = totalPending;
                    badge.style.display = totalPending > 0 ? 'inline-block' : 'none';
                }
            } catch (err) {
                console.error('Error loading access requests:', err);
                pendingAccessRequests = [];
            }
        }

        function renderPendingAccessRequests() {
            const section = document.getElementById('pendingAccessRequestsSection');
            const tbody = document.getElementById('pendingAccessRequestsBody');
            const countBadge = document.getElementById('pendingRequestsCount');
            
            if (!section || !tbody) return;

            if (pendingAccessRequests.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            countBadge.textContent = pendingAccessRequests.length;

            const roleConfig = {
                'admin': { icon: '', label: 'Admin', color: '#f5c518' },
                'content_lead': { icon: '', label: 'Content Lead', color: '#ec4899' },
                'analyst': { icon: '', label: 'Analyst', color: '#8b5cf6' },
                'payments': { icon: '', label: 'Payments', color: '#22c55e' },
                'automations': { icon: '', label: 'Automations', color: '#6b7280' },
                'va': { icon: '', label: 'VA', color: '#06b6d4' }
            };

            tbody.innerHTML = pendingAccessRequests.map(req => {
                const roleInfo = roleConfig[req.requested_role] || { icon: '', label: req.requested_role, color: '#888' };
                const submitted = new Date(req.created_at).toLocaleDateString();
                
                let avatarHtml = '';
                if (req.discord_avatar) {
                    avatarHtml = `<img src="${req.discord_avatar}" style="width: 100%; height: 100%; border-radius: 50%;" onerror="this.outerHTML='${(req.name || '?')[0].toUpperCase()}'">`;
                } else {
                    const name = encodeURIComponent(req.name || req.email?.split('@')[0] || 'U');
                    avatarHtml = `<img src="https://ui-avatars.com/api/?name=${name}&background=f59e0b&color=fff&size=36" style="width: 100%; height: 100%; border-radius: 50%;">`;
                }

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-weight: 600; overflow: hidden;">
                                    ${avatarHtml}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${req.name || 'Unknown'}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">${req.discord_username || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td style="color: var(--text-secondary);">${req.email || '-'}</td>
                        <td>
                            <select id="approveRole_${req.id}" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;">
                                ${Object.entries(roleConfig).map(([value, info]) => 
                                    `<option value="${value}" ${req.requested_role === value ? 'selected' : ''}>${info.icon} ${info.label}</option>`
                                ).join('')}
                            </select>
                        </td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-muted);" title="${req.reason || ''}">${req.reason || '-'}</td>
                        <td style="color: var(--text-muted);">${submitted}</td>
                        <td style="text-align: right;">
                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                <button onclick="approveAccessRequest('${req.id}', '${req.user_id}', '${req.email}', '${req.name}')" class="btn btn-sm" style="background: var(--success); color: #fff;"> Approve</button>
                                <button onclick="denyAccessRequest('${req.id}', '${req.name}')" class="btn btn-sm" style="background: var(--danger); color: #fff;"> Deny</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function approveAccessRequest(requestId, userId, email, name) {
            const roleSelect = document.getElementById(`approveRole_${requestId}`);
            const role = roleSelect?.value || 'va';

            try {
                // Create user_profiles entry
                const { error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .upsert({
                        user_id: userId,
                        email: email,
                        name: name,
                        role: role,
                        status: 'approved',
                        created_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (profileError) throw profileError;

                // Update request status
                const { error: requestError } = await supabaseClient
                    .from('admin_access_requests')
                    .update({ 
                        status: 'approved',
                        approved_role: role,
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: window.currentUser?.name || 'admin'
                    })
                    .eq('id', requestId);

                if (requestError) throw requestError;

                showToast(`${name} approved as ${role}!`, 'success');
                loadInternalTeam();
            } catch (err) {
                console.error('Error approving request:', err);
                showToast('Failed to approve request', 'error');
            }
        }

        async function denyAccessRequest(requestId, name) {
            const reason = prompt(`Reason for denying ${name}'s request (optional):`);
            
            try {
                const { error } = await supabaseClient
                    .from('admin_access_requests')
                    .update({ 
                        status: 'denied',
                        denied_reason: reason || 'Request not approved',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: window.currentUser?.name || 'admin'
                    })
                    .eq('id', requestId);

                if (error) throw error;

                showToast(`${name}'s request denied`, 'info');
                loadInternalTeam();
            } catch (err) {
                console.error('Error denying request:', err);
                showToast('Failed to deny request', 'error');
            }
        }

        function renderInternalTeamTable(users) {
            const tbody = document.getElementById('internalTeamBody');
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No team members found</td></tr>';
                return;
            }

            const roleConfig = {
                'admin': { icon: '', label: 'Admin', color: '#f5c518' },
                'content_lead': { icon: '', label: 'Content Lead', color: '#ec4899' },
                'analyst': { icon: '', label: 'Analyst', color: '#8b5cf6' },
                'payments': { icon: '', label: 'Payments', color: '#22c55e' },
                'automations': { icon: '', label: 'Automations', color: '#6b7280' },
                'va': { icon: '', label: 'VA', color: '#06b6d4' }
            };

            tbody.innerHTML = users.map(user => {
                const roleInfo = roleConfig[user.role] || { icon: '', label: user.role, color: '#888' };
                const status = user.status || 'pending';
                const statusIcon = status === 'approved' ? '' : status === 'rejected' ? '' : '';
                const statusColor = status === 'approved' ? 'var(--success)' : status === 'rejected' ? 'var(--danger)' : 'var(--warning)';
                const joined = user.created_at ? new Date(user.created_at).toLocaleDateString() : '-';
                
                // Generate avatar - try Discord first, then Gravatar, then initials
                let avatarHtml = '';
                if (user.discord_avatar && user.discord_id) {
                    avatarHtml = `<img src="https://cdn.discordapp.com/avatars/${user.discord_id}/${user.discord_avatar}.png" style="width: 100%; height: 100%; border-radius: 50%;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                  <span style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center;">${(user.name || user.email || '?')[0].toUpperCase()}</span>`;
                } else if (user.email) {
                    // Use UI Avatars as fallback (generates nice letter avatars)
                    const name = encodeURIComponent(user.name || user.email.split('@')[0]);
                    avatarHtml = `<img src="https://ui-avatars.com/api/?name=${name}&background=${roleInfo.color.replace('#', '')}&color=fff&size=36" style="width: 100%; height: 100%; border-radius: 50%;">`;
                } else {
                    avatarHtml = (user.name || user.email || '?')[0].toUpperCase();
                }

                // Role dropdown options
                const roleOptions = Object.entries(roleConfig).map(([value, info]) => 
                    `<option value="${value}" ${user.role === value ? 'selected' : ''}>${info.icon} ${info.label}</option>`
                ).join('');

                return `
                    <tr data-user-id="${user.id}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, ${roleInfo.color}33, ${roleInfo.color}66); display: flex; align-items: center; justify-content: center; font-size: 1rem; overflow: hidden;">
                                    ${avatarHtml}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${user.name || 'Unknown'}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${user.discord_id ? `Discord: ${user.discord_id}` : ''}</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-size: 0.85rem;">${user.email || '-'}</td>
                        <td>
                            ${status === 'approved' ? `
                                <select onchange="updateInternalUserRole('${user.id}', this.value)" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.8rem; cursor: pointer;">
                                    ${roleOptions}
                                </select>
                            ` : `
                                <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; background: ${roleInfo.color}22; color: ${roleInfo.color}; font-size: 0.8rem; font-weight: 600;">${roleInfo.icon} ${roleInfo.label}</span>
                            `}
                        </td>
                        <td><span style="color: ${statusColor};">${statusIcon} ${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td style="font-size: 0.85rem;">${joined}</td>
                        <td style="text-align: right;">
                            ${status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="approveInternalUser('${user.id}')" style="margin-right: 4px;" title="Approve"></button>
                                <button class="btn btn-sm btn-danger" onclick="rejectInternalUser('${user.id}')" title="Reject"></button>
                            ` : `
                                <button class="btn btn-sm btn-danger" onclick="removeInternalUser('${user.id}', '${(user.name || user.email || '').replace(/'/g, "\\'")}')" title="Remove from team"></button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function updateInternalUserRole(userId, newRole) {
            try {
                const { error } = await supabaseClient.from('user_profiles')
                    .update({ role: newRole })
                    .eq('id', userId);
                if (error) throw error;
                showToast(`Role updated to ${newRole}`, 'success');
                // Update local data without full reload
                const user = internalTeamData.find(u => u.id === userId);
                if (user) user.role = newRole;
            } catch (err) {
                console.error(err);
                showToast('Failed to update role', 'error');
                loadInternalTeam(); // Reload on error to reset dropdown
            }
        }

        async function removeInternalUser(userId, userName) {
            if (!confirm(`Remove ${userName} from the team?\n\nThis will delete their profile. They can re-register later if needed.`)) return;
            
            try {
                const { error } = await supabaseClient.from('user_profiles')
                    .delete()
                    .eq('id', userId);
                if (error) throw error;
                showToast(`${userName} removed from team`, 'success');
                loadInternalTeam();
                loadUsersData();
            } catch (err) {
                console.error(err);
                showToast('Failed to remove user', 'error');
            }
        }

        async function approveInternalUser(userId) {
            const role = prompt('Assign role (admin, content_lead, analyst, payments, automations, va):');
            if (!role || !['admin', 'content_lead', 'analyst', 'payments', 'automations', 'va'].includes(role)) {
                showToast('Invalid role', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient.from('user_profiles')
                    .update({ status: 'approved', role: role })
                    .eq('id', userId);
                if (error) throw error;
                showToast('User approved!', 'success');
                loadInternalTeam();
                loadUsersData();
            } catch (err) {
                console.error(err);
                showToast('Failed to approve user', 'error');
            }
        }

        async function rejectInternalUser(userId) {
            if (!confirm('Reject this user?')) return;
            try {
                const { error } = await supabaseClient.from('user_profiles')
                    .update({ status: 'rejected' })
                    .eq('id', userId);
                if (error) throw error;
                showToast('User rejected', 'warning');
                loadInternalTeam();
                loadUsersData();
            } catch (err) {
                console.error(err);
                showToast('Failed to reject user', 'error');
            }
        }

        function showInviteTeamModal() {
            document.getElementById('adminPortalLink').textContent = window.location.origin + '/admin.html';
            document.getElementById('inviteTeamModal').style.display = 'flex';
        }

        function hideInviteTeamModal() {
            document.getElementById('inviteTeamModal').style.display = 'none';
        }

        function copyAdminPortalLink() {
            navigator.clipboard.writeText(window.location.origin + '/admin.html');
            showToast('Link copied!', 'success');
        }

        // ==================== CREATORS TAB ====================
        async function loadRosterTab() {
            await loadCreatorsRoster();
            await loadClaimRequestsCount();
            await loadAccountRequestsCount();
            await loadApplicationsCount();
        }

        async function loadCreatorsRoster() {
            const tbody = document.getElementById('creatorsRosterBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';

            try {
                const statusFilter = document.getElementById('rosterStatusFilter')?.value || 'all';
                const brandFilter = document.getElementById('rosterBrandFilter')?.value || 'all';

                let query = supabaseClient.from('managed_creators')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (statusFilter !== 'all') query = query.eq('status', statusFilter);
                if (brandFilter !== 'all') query = query.eq('brand', brandFilter);

                const { data, error } = await query;
                if (error) throw error;

                creatorsData = data || [];
                document.getElementById('rosterCountLabel').textContent = `${creatorsData.length} creators`;
                renderCreatorsRosterTable(creatorsData);

            } catch (err) {
                console.error('Error loading creators:', err);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);">Failed to load creators</td></tr>';
            }
        }

        function renderCreatorsRosterTable(creators) {
            const tbody = document.getElementById('creatorsRosterBody');
            if (!creators || creators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No creators found</td></tr>';
                return;
            }

            tbody.innerHTML = creators.map(c => {
                const status = c.status || 'Active';
                const statusIcon = status === 'Active' ? '' : status === 'Inactive' ? '' : '';
                const statusColor = status === 'Active' ? 'var(--success)' : status === 'Inactive' ? 'var(--danger)' : 'var(--warning)';
                const hasDiscord = c.discord_id || c.discord_user_id;
                const joined = c.created_at ? new Date(c.created_at).toLocaleDateString() : '-';
                const brandDisplay = BRAND_DISPLAY[c.brand] || c.brand || '-';

                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${c.real_name || c.account_1 || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${c.email || ''}</div>
                        </td>
                        <td><code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">@${c.account_1 || '-'}</code></td>
                        <td>${brandDisplay}</td>
                        <td><span style="color: ${statusColor};">${statusIcon} ${status}</span></td>
                        <td>${hasDiscord ? `<span style="color: var(--success);"> Linked</span>` : '<span style="color: var(--text-muted);"> No</span>'}</td>
                        <td>${joined}</td>
                        <td style="text-align: right;">
                            <button class="btn btn-sm" onclick="viewCreatorDetails('${c.id}')" style="margin-right: 4px;"></button>
                            ${hasDiscord ? `<button class="btn btn-sm" onclick="unlinkCreatorDiscord('${c.id}')" title="Unlink Discord"></button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterRosterTable() {
            const search = document.getElementById('rosterSearch')?.value?.toLowerCase() || '';
            const filtered = creatorsData.filter(c => {
                const name = (c.real_name || '').toLowerCase();
                const handle = (c.account_1 || '').toLowerCase();
                return name.includes(search) || handle.includes(search);
            });
            renderCreatorsRosterTable(filtered);
        }

        function viewCreatorDetails(id) {
            const creator = creatorsData.find(c => c.id == id);
            if (creator) {
                let details = `CREATOR DETAILS\n${'='.repeat(40)}\n\n`;
                details += `Name: ${creator.real_name || 'Unknown'}\n`;
                details += `Primary Handle: @${creator.account_1 || '-'}\n`;
                if (creator.account_2) details += `Account 2: @${creator.account_2}\n`;
                if (creator.account_3) details += `Account 3: @${creator.account_3}\n`;
                if (creator.account_4) details += `Account 4: @${creator.account_4}\n`;
                if (creator.account_5) details += `Account 5: @${creator.account_5}\n`;
                details += `\nEmail: ${creator.email || '-'}\n`;
                details += `Brand: ${BRAND_DISPLAY[creator.brand] || creator.brand || '-'}\n`;
                details += `Status: ${creator.status || 'Active'}\n`;
                details += `Discord ID: ${creator.discord_id || 'Not linked'}\n`;
                details += `Created: ${creator.created_at ? new Date(creator.created_at).toLocaleString() : '-'}`;
                
                alert(details);
            }
        }

        async function unlinkCreatorDiscord(id) {
            const creator = creatorsData.find(c => c.id == id);
            if (!creator) return;

            if (!confirm(`Unlink Discord from ${creator.real_name || creator.account_1}?\n\nThey will need to re-claim their account to access the Creator Portal again.`)) {
                return;
            }

            try {
                const { error } = await supabaseClient.from('managed_creators')
                    .update({ 
                        discord_id: null, 
                        discord_user_id: null,
                        discord_avatar: null 
                    })
                    .eq('id', id);

                if (error) throw error;

                showToast(`Unlinked Discord from ${creator.real_name || creator.account_1}`, 'success');
                logActivity('edit', `Unlinked Discord from creator ${creator.real_name || creator.account_1}`);
                loadCreatorsRoster();

            } catch (err) {
                console.error('Error unlinking Discord:', err);
                showToast('Failed to unlink Discord', 'error');
            }
        }

        // ==================== CLAIM REQUESTS ====================
        let claimRequestsData = [];

        async function loadClaimRequestsCount() {
            try {
                const { data } = await supabaseClient.from('creator_claim_requests')
                    .select('id')
                    .eq('status', 'pending');
                updateTabBadge('claimRequestsBadge', data?.length || 0);
            } catch (err) {
                console.warn('Could not load claim requests count');
            }
        }

        async function loadClaimRequests() {
            const tbody = document.getElementById('claimRequestsBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';

            try {
                const { data, error } = await supabaseClient.from('creator_claim_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                claimRequestsData = data || [];
                updateTabBadge('claimRequestsBadge', claimRequestsData.length);

                if (claimRequestsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No pending claim requests </td></tr>';
                    return;
                }

                tbody.innerHTML = claimRequestsData.map(req => {
                    const records = req.found_records || [];
                    const totalBrands = records.length;
                    const totalAccounts = records.reduce((sum, r) => sum + (r.accounts?.length || 0), 0);
                    const totalGmv = records.reduce((sum, r) => sum + (r.gmv || 0), 0);
                    const timeAgo = formatTimeAgoAdmin(new Date(req.created_at));

                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--purple-dim); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                        ${req.discord_avatar ? `<img src="${req.discord_avatar}" style="width: 100%; height: 100%; object-fit: cover;">` : `<span style="font-weight: 700;">${(req.discord_username || '?')[0].toUpperCase()}</span>`}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${req.discord_username || 'Unknown'}</div>
                                        <div style="font-size: 0.8rem; color: var(--purple);">Discord: ${req.discord_username || '-'}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${req.discord_email || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="font-weight: 600;">${totalBrands} brand${totalBrands !== 1 ? 's' : ''}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${totalAccounts} account${totalAccounts !== 1 ? 's' : ''}</div>
                                ${req.searched_handle ? `<div style="font-size: 0.75rem; color: var(--accent);">Searched: @${req.searched_handle}</div>` : ''}
                                <button class="btn btn-sm" style="margin-top: 6px; font-size: 0.75rem;" onclick="viewClaimDetails('${req.id}')">View Details</button>
                            </td>
                            <td>
                                <span style="color: ${totalGmv > 0 ? 'var(--success)' : 'var(--text-muted)'}; font-weight: 600;">
                                    ${totalGmv > 0 ? '$' + totalGmv.toLocaleString() : '$0'}
                                </span>
                            </td>
                            <td style="color: var(--text-muted);">${timeAgo}</td>
                            <td style="text-align: right;">
                                <button class="btn btn-sm btn-success" onclick="approveClaimRequest('${req.id}')" style="margin-right: 4px;"> Approve</button>
                                <button class="btn btn-sm btn-danger" onclick="denyClaimRequest('${req.id}')"> Deny</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading claim requests:', err);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">Failed to load claim requests</td></tr>';
            }
        }

        function viewClaimDetails(requestId) {
            const req = claimRequestsData.find(r => r.id === requestId);
            if (!req) return;

            const records = req.found_records || [];
            let details = `CLAIM REQUEST DETAILS\n${'='.repeat(40)}\n\n`;
            details += `Discord: ${req.discord_username}\n`;
            details += `Email: ${req.discord_email || '-'}\n`;
            details += `Searched Handle: @${req.searched_handle}\n\n`;
            details += `FOUND RECORDS:\n${'-'.repeat(40)}\n`;

            records.forEach((r, i) => {
                details += `\n${i + 1}. ${r.brand}\n`;
                details += `   Accounts: ${r.accounts?.map(a => '@' + a).join(', ') || '-'}\n`;
                details += `   GMV: $${(r.gmv || 0).toLocaleString()}\n`;
            });

            alert(details);
        }

        async function approveClaimRequest(requestId) {
            const req = claimRequestsData.find(r => r.id === requestId);
            if (!req) return;

            const records = req.found_records || [];
            const totalBrands = records.length;
            const totalAccounts = records.reduce((sum, r) => sum + (r.accounts?.length || 0), 0);

            if (!confirm(`Approve this claim?\n\nThis will link ${req.discord_username}'s Discord to ${totalBrands} brand(s) with ${totalAccounts} account(s).`)) {
                return;
            }

            try {
                // Update all managed_creators records with Discord ID
                const creatorIds = (req.managed_creator_ids || []).map(id => parseInt(id, 10)).filter(id => !isNaN(id));
                if (creatorIds.length > 0) {
                    const { error: updateError } = await supabaseClient
                        .from('managed_creators')
                        .update({ 
                            discord_id: req.discord_id,
                            discord_user_id: req.discord_id
                        })
                        .in('id', creatorIds);

                    if (updateError) throw updateError;
                }

                // Mark claim request as approved
                const { error: claimError } = await supabaseClient
                    .from('creator_claim_requests')
                    .update({ 
                        status: 'approved',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: window.currentUser?.username || 'admin'
                    })
                    .eq('id', requestId);

                if (claimError) throw claimError;

                showToast(`Approved! ${req.discord_username} can now access the portal.`, 'success');
                logActivity('edit', `Approved claim request for ${req.discord_username} - linked ${totalBrands} brands`);
                loadClaimRequests();
                loadUsersData();

            } catch (err) {
                console.error('Error approving claim:', err);
                showToast('Failed to approve claim request', 'error');
            }
        }

        async function denyClaimRequest(requestId) {
            const req = claimRequestsData.find(r => r.id === requestId);
            if (!req) return;

            const reason = prompt('Reason for denial (optional):');
            
            try {
                const { error } = await supabaseClient
                    .from('creator_claim_requests')
                    .update({ 
                        status: 'denied',
                        denied_reason: reason || null,
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: window.currentUser?.username || 'admin'
                    })
                    .eq('id', requestId);

                if (error) throw error;

                showToast('Claim request denied', 'warning');
                logActivity('edit', `Denied claim request for ${req.discord_username}`);
                loadClaimRequests();

            } catch (err) {
                console.error('Error denying claim:', err);
                showToast('Failed to deny claim request', 'error');
            }
        }

        function formatTimeAgoAdmin(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        async function loadAccountRequestsCount() {
            try {
                const { data } = await supabaseClient.from('creator_account_requests')
                    .select('id')
                    .eq('status', 'pending');
                updateTabBadge('accountRequestsBadge', data?.length || 0);
            } catch (err) {
                console.warn('Could not load account requests count');
            }
        }

        async function loadAccountRequests() {
            const tbody = document.getElementById('creatorsRequestsBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';

            try {
                const { data, error } = await supabaseClient.from('creator_account_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                if (error) throw error;

                accountRequestsData = data || [];
                updateTabBadge('accountRequestsBadge', accountRequestsData.length);

                if (accountRequestsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No pending requests</td></tr>';
                    return;
                }

                tbody.innerHTML = accountRequestsData.map(r => `
                    <tr>
                        <td>${r.discord_username || r.discord_id}</td>
                        <td><code>@${r.requested_handle}</code></td>
                        <td>${r.has_existing_data ? '<span style="color: var(--warning);"> Yes</span>' : 'No'}</td>
                        <td>${new Date(r.created_at).toLocaleDateString()}</td>
                        <td style="text-align: right;">
                            <button class="btn btn-sm btn-success" onclick="approveAccountRequest('${r.id}')" style="margin-right: 4px;"></button>
                            <button class="btn btn-sm btn-danger" onclick="rejectAccountRequest('${r.id}')"></button>
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">Failed to load requests</td></tr>';
            }
        }

        async function approveAccountRequest(id) {
            try {
                const { error } = await supabaseClient.from('creator_account_requests')
                    .update({ status: 'approved' })
                    .eq('id', id);
                if (error) throw error;
                showToast('Request approved!', 'success');
                loadAccountRequests();
            } catch (err) {
                console.error(err);
                showToast('Failed to approve request', 'error');
            }
        }

        async function rejectAccountRequest(id) {
            if (!confirm('Reject this request?')) return;
            try {
                const { error } = await supabaseClient.from('creator_account_requests')
                    .update({ status: 'rejected' })
                    .eq('id', id);
                if (error) throw error;
                showToast('Request rejected', 'warning');
                loadAccountRequests();
            } catch (err) {
                console.error(err);
                showToast('Failed to reject request', 'error');
            }
        }

        async function loadApplicationsCount() {
            try {
                const { data } = await supabaseClient.from('creator_applications')
                    .select('id')
                    .eq('status', 'pending');
                updateTabBadge('applicationsBadge', data?.length || 0);
            } catch (err) {
                console.warn('Could not load applications count');
            }
        }

        async function loadApplicationsSubTab() {
            const tbody = document.getElementById('creatorsApplicationsBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';

            try {
                const { data, error } = await supabaseClient.from('creator_applications')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                if (error) throw error;

                applicationsData = data || [];
                const pending = applicationsData.filter(a => a.status === 'pending').length;
                updateTabBadge('applicationsBadge', pending);

                if (applicationsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No applications</td></tr>';
                    return;
                }

                tbody.innerHTML = applicationsData.map(a => {
                    const status = a.status || 'pending';
                    const statusIcon = status === 'approved' ? '' : status === 'rejected' ? '' : '';
                    const statusColor = status === 'approved' ? 'var(--success)' : status === 'rejected' ? 'var(--danger)' : 'var(--warning)';
                    const hasDiscord = a.discord_id && a.discord_id.trim();
                    const displayName = a.discord_username || a.discord_name || a.name || a.first_name || 'Unknown';

                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${displayName}</div>
                                ${hasDiscord ? `<div style="font-size: 0.75rem; color: var(--purple);">@${a.discord_username || a.discord_name || 'Discord linked'}</div>` : `<div style="font-size: 0.75rem; color: var(--text-muted);"> No Discord</div>`}
                            </td>
                            <td>${a.email || '-'}</td>
                            <td><code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">@${a.tiktok_handle || a.tiktok || '-'}</code></td>
                            <td>${a.followers ? Number(a.followers).toLocaleString() : '-'}</td>
                            <td>${a.created_at ? new Date(a.created_at).toLocaleDateString() : '-'}</td>
                            <td><span style="color: ${statusColor};">${statusIcon} ${status}</span></td>
                            <td style="text-align: right;">
                                ${status === 'pending' ? `
                                    <button class="btn btn-sm btn-success" onclick="approveApplication('${a.id}')" style="margin-right: 4px;"> Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectApplication('${a.id}')"></button>
                                ` : `
                                    <button class="btn btn-sm" onclick="viewApplicationDetails('${a.id}')"></button>
                                `}
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);">Failed to load applications</td></tr>';
            }
        }

        async function approveApplication(id) {
            // Get the application data
            const app = applicationsData.find(a => String(a.id) === String(id));
            if (!app) {
                showToast('Application not found', 'error');
                return;
            }

            const tiktokHandle = (app.tiktok_handle || app.tiktok || '').replace('@', '').toLowerCase().trim();
            
            if (!tiktokHandle) {
                showToast('No TikTok handle found for this application', 'error');
                return;
            }

            // Check if this handle already exists in managed_creators (all 10 account columns)
            const { data: existing, error: checkError } = await supabaseClient.from('managed_creators')
                .select('id, account_1, brand')
                .or(`account_1.ilike.${tiktokHandle},account_2.ilike.${tiktokHandle},account_3.ilike.${tiktokHandle},account_4.ilike.${tiktokHandle},account_5.ilike.${tiktokHandle},account_6.ilike.${tiktokHandle},account_7.ilike.${tiktokHandle},account_8.ilike.${tiktokHandle},account_9.ilike.${tiktokHandle},account_10.ilike.${tiktokHandle}`)
                .limit(1);
            
            if (checkError) {
                console.error('Check error:', checkError);
            }
            
            if (existing && existing.length > 0) {
                const existingRecord = existing[0];
                showToast(`@${tiktokHandle} already exists in the ${BRAND_DISPLAY[existingRecord.brand] || existingRecord.brand} roster`, 'error');
                return;
            }

            // Ask which brand to assign
            const displayName = app.discord_username || app.name || app.first_name || 'this creator';
            const brand = prompt(
                `Approve ${displayName}?\n\n` +
                `TikTok: @${tiktokHandle}\n` +
                `Discord: ${app.discord_username || 'not linked'}\n` +
                `Email: ${app.email || 'none'}\n\n` +
                `Enter brand to assign:\n` +
                ` catakor\n` +
                ` jiyu\n` +
                ` physicians_choice\n` +
                ` peach_slices\n` +
                ` yerba_magic`
            );

            if (!brand) return; // Cancelled

            const validBrands = ['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'];
            const normalizedBrand = brand.toLowerCase().replace(/[- ]/g, '_');
            
            if (!validBrands.includes(normalizedBrand)) {
                showToast('Invalid brand. Please enter a valid brand name.', 'error');
                return;
            }

            try {
                // Create managed_creators record
                const insertData = {
                    account_1: tiktokHandle,
                    real_name: app.name || app.first_name || null,
                    email: app.email || null,
                    brand: normalizedBrand,
                    status: 'Active'
                };
                
                // Only add discord fields if they exist
                if (app.discord_id) {
                    insertData.discord_id = app.discord_id;
                    insertData.discord_user_id = app.discord_id;
                }
                if (app.discord_username || app.discord_name) {
                    insertData.discord_name = app.discord_username || app.discord_name;
                }
                
                console.log('Inserting managed_creator:', insertData);
                
                const { data: insertedData, error: createError } = await supabaseClient.from('managed_creators')
                    .insert(insertData)
                    .select();

                if (createError) {
                    console.error('Create error:', createError);
                    // Check if it's a duplicate
                    if (createError.message?.includes('duplicate') || createError.code === '23505') {
                        showToast('This TikTok handle or Discord already exists in the roster', 'error');
                        return;
                    }
                    throw createError;
                }
                
                console.log('Inserted successfully:', insertedData);

                // Update application status
                const { error: updateError } = await supabaseClient.from('creator_applications')
                    .update({ status: 'approved' })
                    .eq('id', String(app.id));
                
                if (updateError) {
                    console.error('Update error:', updateError);
                    // Still show success since creator was added
                    showToast(`Creator added to roster! (Note: application status update failed)`, 'warning');
                } else {
                    showToast(`Approved! ${displayName} added to ${BRAND_DISPLAY[normalizedBrand] || normalizedBrand} roster.`, 'success');
                }
                
                logActivity('create', `Approved application for ${displayName} (@${tiktokHandle}) - added to ${normalizedBrand}`);
                loadApplicationsSubTab();
                loadUsersData();

            } catch (err) {
                console.error('Error approving application:', err);
                showToast('Failed to approve: ' + (err.message || JSON.stringify(err)), 'error');
            }
        }

        async function rejectApplication(id) {
            const app = applicationsData.find(a => a.id === id);
            const reason = prompt(`Reject ${app?.name || 'this application'}?\n\nEnter reason (optional):`);
            
            if (reason === null) return; // Cancelled
            
            try {
                const { error } = await supabaseClient.from('creator_applications')
                    .update({ 
                        status: 'rejected',
                        rejection_reason: reason || null
                    })
                    .eq('id', id);
                if (error) throw error;
                showToast('Application rejected', 'warning');
                loadApplicationsSubTab();
            } catch (err) {
                console.error(err);
                showToast('Failed to reject', 'error');
            }
        }

        function viewApplicationDetails(id) {
            const app = applicationsData.find(a => a.id === id);
            if (!app) return;

            // Build a proper modal instead of alert
            const modal = document.getElementById('applicationModal');
            const modalBody = modal.querySelector('.modal-body');
            
            // Parse extra_data for all answers
            let extraData = {};
            try {
                extraData = typeof app.extra_data === 'string' ? JSON.parse(app.extra_data) : (app.extra_data || {});
            } catch (e) {
                extraData = {};
            }
            
            // Get field labels mapping (if saved)
            const fieldLabels = extraData._fieldLabels || {};
            
            // System/internal fields to exclude from display
            const hiddenFields = ['discord_oauth', 'discord_global_name', '_fieldLabels'];
            
            // Build ALL form answers dynamically
            const allAnswers = Object.entries(extraData)
                .filter(([key]) => !hiddenFields.includes(key))
                .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                .map(([key, value]) => {
                    // Use saved label if available, otherwise format the key nicely
                    let label = fieldLabels[key];
                    if (!label) {
                        // Try to make a nice label from the key
                        label = key
                            .replace(/^field_\d+$/, 'Custom Field')
                            .replace(/^custom_\d+$/, 'Custom Field')
                            .replace(/_/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                    }
                    return { key, label, value };
                });
            
            // Separate into known fields (show first) and custom fields
            const knownFieldOrder = ['full_name', 'email', 'phone', 'tiktok_handle', 'follower_count', 'avg_views', 'content_niche', 'why_join', 'heard_about_us', 'sample_video', 'sample_video_url'];
            const knownAnswers = allAnswers.filter(a => knownFieldOrder.includes(a.key)).sort((a, b) => knownFieldOrder.indexOf(a.key) - knownFieldOrder.indexOf(b.key));
            const customAnswers = allAnswers.filter(a => !knownFieldOrder.includes(a.key));
            
            // Render answers
            const renderAnswers = (answers) => answers.map(a => {
                let displayValue = a.value;
                // Make URLs clickable
                if (typeof displayValue === 'string' && displayValue.startsWith('http')) {
                    displayValue = `<a href="${displayValue}" target="_blank" style="color: var(--accent);">View Link </a>`;
                }
                // Format booleans
                if (typeof displayValue === 'boolean') {
                    displayValue = displayValue ? ' Yes' : ' No';
                }
                return `<div class="detail-row"><span class="detail-label">${a.label}:</span><span class="detail-value">${displayValue || '-'}</span></div>`;
            }).join('');
            
            // Update modal title with status
            const modalTitle = modal.querySelector('.modal-title');
            if (modalTitle) {
                modalTitle.innerHTML = ` Review Application <span style="font-size: 0.7rem; padding: 4px 10px; border-radius: 12px; margin-left: 10px; background: ${app.status === 'accepted' ? 'var(--success-dim)' : app.status === 'rejected' ? 'var(--danger-dim)' : 'var(--warning-dim)'}; color: ${app.status === 'accepted' ? 'var(--success)' : app.status === 'rejected' ? 'var(--danger)' : 'var(--warning)'};">${app.status?.toUpperCase() || 'PENDING'}</span>`;
            }
            
            modalBody.innerHTML = `
                <style>
                    .detail-section { background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
                    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
                    .detail-row:last-child { border-bottom: none; }
                    .detail-label { color: var(--text-muted); font-size: 0.9rem; min-width: 140px; }
                    .detail-value { color: var(--text-primary); font-weight: 500; text-align: right; max-width: 55%; word-break: break-word; }
                </style>
                
                <div style="padding: 20px;">
                    <div class="detail-section">
                        <h4 style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">Discord</h4>
                        <div class="detail-row"><span class="detail-label">Username:</span><span class="detail-value">${app.discord_username || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">Discord ID:</span><span class="detail-value" style="font-family: monospace; font-size: 0.85rem;">${app.discord_id || '-'}</span></div>
                    </div>
                    
                    <div class="detail-section">
                        <h4 style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">Form Answers</h4>
                        ${renderAnswers(knownAnswers)}
                        ${customAnswers.length > 0 ? renderAnswers(customAnswers) : ''}
                        ${allAnswers.length === 0 ? '<div style="color: var(--text-muted); font-style: italic; padding: 12px 0;">No form data available</div>' : ''}
                    </div>
                    
                    <div class="detail-section">
                        <h4 style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">Meta</h4>
                        <div class="detail-row"><span class="detail-label">Brand:</span><span class="detail-value">${BRAND_DISPLAY[app.brand] || app.brand || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">Funnel:</span><span class="detail-value">${app.funnel_slug || 'default'}</span></div>
                        <div class="detail-row"><span class="detail-label">Applied:</span><span class="detail-value">${app.created_at ? new Date(app.created_at).toLocaleString() : '-'}</span></div>
                    </div>
                    
                    ${app.notes ? `
                    <div class="detail-section">
                        <h4 style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">Notes</h4>
                        <p style="color: var(--text-secondary); margin: 0;">${app.notes}</p>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <button class="btn" onclick="closeApplicationModal()">Close</button>
                        ${app.status === 'pending' || app.status === 'reviewing' ? `
                            <button class="btn btn-success" onclick="approveApplication('${app.id}'); closeApplicationModal();"> Approve</button>
                            <button class="btn btn-danger" onclick="rejectApplication('${app.id}'); closeApplicationModal();"> Reject</button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function closeApplicationModal() {
            document.getElementById('applicationModal').classList.remove('show');
        }

        // ==================== BRAND CLIENTS TAB ====================
        async function loadBrandsTab() {
            const tbody = document.getElementById('brandsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';

            try {
                const statusFilter = document.getElementById('brandsStatusFilter')?.value || 'all';
                const brandFilter = document.getElementById('brandsBrandFilter')?.value || 'all';

                let query = supabaseClient.from('brand_portal_users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (statusFilter !== 'all') query = query.eq('status', statusFilter);
                if (brandFilter !== 'all') query = query.eq('assigned_brand', brandFilter);

                const { data, error } = await query;
                if (error) throw error;

                brandsData = data || [];
                renderBrandsTable(brandsData);

            } catch (err) {
                console.error('Error loading brand users:', err);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);">Failed to load brand users</td></tr>';
            }
        }

        function renderBrandsTable(users) {
            const tbody = document.getElementById('brandsTableBody');
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No brand users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => {
                const status = u.status || 'pending';
                const statusIcon = status === 'approved' ? '' : status === 'denied' ? '' : '';
                const statusColor = status === 'approved' ? 'var(--success)' : status === 'denied' ? 'var(--danger)' : 'var(--warning)';
                const brandDisplay = BRAND_DISPLAY[u.assigned_brand] || u.assigned_brand || 'Not assigned';
                const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never';
                const role = u.role === 'admin' ? ' Admin' : ' User';

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--blue-dim); display: flex; align-items: center; justify-content: center;">
                                    ${u.discord_avatar ? `<img src="${u.discord_avatar}" style="width: 100%; height: 100%; border-radius: 50%;">` : (u.discord_username || '?')[0].toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${u.discord_username || 'Unknown'}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">${u.discord_id || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td>${u.discord_email || '-'}</td>
                        <td>${brandDisplay}</td>
                        <td>${role}</td>
                        <td><span style="color: ${statusColor};">${statusIcon} ${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td>${lastLogin}</td>
                        <td style="text-align: right;">
                            ${status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="approveBrandUser('${u.id}')" style="margin-right: 4px;"></button>
                                <button class="btn btn-sm btn-danger" onclick="denyBrandUser('${u.id}')"></button>
                            ` : `
                                <button class="btn btn-sm" onclick="editBrandUser('${u.id}')"></button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function approveBrandUser(id) {
            const brand = prompt('Assign brand (catakor, jiyu, physicians_choice, peach_slices, yerba_magic):');
            if (!brand || !['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'].includes(brand)) {
                showToast('Invalid brand', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ status: 'approved', assigned_brand: brand })
                    .eq('id', id);
                if (error) throw error;
                showToast('Brand user approved!', 'success');
                loadBrandsTab();
                loadUsersData();
            } catch (err) {
                console.error(err);
                showToast('Failed to approve', 'error');
            }
        }

        async function denyBrandUser(id) {
            const reason = prompt('Denial reason (optional):');
            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ status: 'denied', denied_reason: reason || null })
                    .eq('id', id);
                if (error) throw error;
                showToast('Brand user denied', 'warning');
                loadBrandsTab();
                loadUsersData();
            } catch (err) {
                console.error(err);
                showToast('Failed to deny', 'error');
            }
        }

        async function editBrandUser(id) {
            const user = brandsData.find(u => u.id == id);
            if (!user) return;

            const newBrand = prompt(`Current brand: ${user.assigned_brand || 'None'}\nNew brand (catakor, jiyu, physicians_choice, peach_slices, yerba_magic):`, user.assigned_brand || '');
            if (!newBrand) return;

            if (!['catakor', 'jiyu', 'physicians_choice', 'peach_slices', 'yerba_magic'].includes(newBrand)) {
                showToast('Invalid brand', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ assigned_brand: newBrand })
                    .eq('id', id);
                if (error) throw error;
                showToast('Brand updated!', 'success');
                loadBrandsTab();
            } catch (err) {
                console.error(err);
                showToast('Failed to update', 'error');
            }
        }

        function copyBrandPortalLink() {
            navigator.clipboard.writeText(window.location.origin + '/brand-portal.html');
            showToast('Link copied!', 'success');
        }

        // ==================== BRAND PORTAL USER MANAGEMENT ====================
        let allPortalUsers = [];
        
        async function loadPortalUsers() {
            showLoading('brandportal', 'Loading portal users...');
            try {
                const statusFilter = document.getElementById('portalStatusFilter')?.value || 'all';
                const brandFilter = document.getElementById('portalBrandFilter')?.value || 'all';
                
                let query = supabaseClient.from('brand_portal_users').select('*').order('created_at', { ascending: false });
                
                if (statusFilter !== 'all') {
                    query = query.eq('status', statusFilter);
                }
                if (brandFilter !== 'all') {
                    query = query.eq('assigned_brand', brandFilter);
                }
                
                const { data, error } = await query;
                if (error) {
                    if (error.code === '42P01') {
                        // Table doesn't exist yet
                        document.getElementById('portalUsersBody').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Run brand_portal_users_table.sql migration first</td></tr>';
                        return;
                    }
                    throw error;
                }
                
                allPortalUsers = data || [];
                renderPortalUsersTable(allPortalUsers);
                updatePortalStats(allPortalUsers);
                updatePendingPortalBadge();
                
            } catch (err) {
                console.error('Error loading portal users:', err);
                showToast('Failed to load portal users', 'error');
            } finally {
                hideLoading('brandportal');
            }
        }
        
        function renderPortalUsersTable(users) {
            const tbody = document.getElementById('portalUsersBody');
            if (!tbody) return;
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No portal users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const statusColors = { 'pending': 'warning', 'approved': 'success', 'denied': 'danger' };
                const statusIcons = { 'pending': '', 'approved': '', 'denied': '' };
                const status = user.status || 'pending';
                const initial = (user.discord_username || '?')[0].toUpperCase();
                const avatarUrl = user.discord_avatar;
                const brandDisplay = BRAND_DISPLAY[user.assigned_brand] || user.assigned_brand || 'Not Assigned';
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${avatarUrl ? 
                                    `<img src="${avatarUrl}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">` :
                                    `<div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accent-dim); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--accent);">${initial}</div>`
                                }
                                <div>
                                    <div style="font-weight: 600;">${user.discord_username || 'Unknown'}</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-family: 'Space Mono', monospace; font-size: 0.8rem;">${user.discord_id || '-'}</td>
                        <td>${user.discord_email || '-'}</td>
                        <td>
                            ${status === 'approved' ? 
                                `<span class="brand-pill ${user.assigned_brand || ''}">${brandDisplay}</span>` :
                                `<select onchange="assignPortalBrand('${user.id}', this.value)" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 0.8rem;">
                                    <option value="">Select Brand...</option>
                                    <option value="catakor" ${user.assigned_brand === 'catakor' ? 'selected' : ''}>Cata-Kor</option>
                                    <option value="jiyu" ${user.assigned_brand === 'jiyu' ? 'selected' : ''}>JiYu</option>
                                    <option value="physicians_choice" ${user.assigned_brand === 'physicians_choice' ? 'selected' : ''}>Physicians Choice</option>
                                    <option value="peach_slices" ${user.assigned_brand === 'peach_slices' ? 'selected' : ''}>Peach Slices</option>
                                    <option value="yerba_magic" ${user.assigned_brand === 'yerba_magic' ? 'selected' : ''}>Yerba Magic</option>
                                </select>`
                            }
                        </td>
                        <td>
                            <select onchange="updatePortalUserRole('${user.id}', this.value)" style="padding: 4px 8px; border-radius: 4px; border: 1px solid ${user.role === 'admin' ? 'var(--warning)' : 'var(--border)'}; background: ${user.role === 'admin' ? 'var(--warning-dim)' : 'var(--bg-secondary)'}; color: var(--text-primary); font-size: 0.8rem; font-weight: ${user.role === 'admin' ? '600' : '400'};">
                                <option value="" ${!user.role ? 'selected' : ''}>User</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}> Admin</option>
                            </select>
                        </td>
                        <td><span class="badge badge-${statusColors[status]}">${statusIcons[status]} ${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td style="color: var(--text-muted);">${lastLogin}</td>
                        <td>
                            <div style="display: flex; gap: 6px;">
                                ${status === 'pending' ? `
                                    <button class="btn btn-sm" style="background: var(--success); color: white;" onclick="approvePortalUser('${user.id}')"> Approve</button>
                                    <button class="btn btn-sm" style="background: var(--error); color: white;" onclick="denyPortalUser('${user.id}')"> Deny</button>
                                ` : status === 'approved' ? `
                                    <button class="btn btn-sm" onclick="denyPortalUser('${user.id}')">Revoke</button>
                                ` : `
                                    <button class="btn btn-sm" onclick="approvePortalUser('${user.id}')">Re-approve</button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updatePortalStats(users) {
            const pending = users.filter(u => u.status === 'pending').length;
            const approved = users.filter(u => u.status === 'approved').length;
            const denied = users.filter(u => u.status === 'denied').length;
            const admins = users.filter(u => u.role === 'admin').length;
            
            document.getElementById('statPendingPortal').textContent = pending;
            document.getElementById('statApprovedPortal').textContent = approved;
            document.getElementById('statDeniedPortal').textContent = denied;
            document.getElementById('statTotalPortal').textContent = users.length;
            document.getElementById('statAdminPortal').textContent = admins;
        }
        
        async function updatePendingPortalBadge() {
            try {
                const { data, error } = await supabaseClient.from('brand_portal_users').select('id').eq('status', 'pending');
                if (error) return;
                const badge = document.getElementById('pendingPortalBadge');
                if (badge) {
                    const count = (data || []).length;
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'inline-flex' : 'none';
                }
            } catch (err) {
                console.error(err);
            }
        }
        
        async function assignPortalBrand(userId, brand) {
            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ assigned_brand: brand })
                    .eq('id', userId);
                if (error) throw error;
                
                // Update local array so approve check works
                const user = allPortalUsers.find(u => u.id == userId);
                if (user) user.assigned_brand = brand;
                
                showToast('Brand assigned', 'success');
            } catch (err) {
                console.error(err);
                showToast('Failed to assign brand', 'error');
            }
        }
        
        async function updatePortalUserRole(userId, role) {
            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ role: role || null })
                    .eq('id', userId);
                if (error) throw error;
                
                // Update local array
                const user = allPortalUsers.find(u => u.id == userId);
                if (user) user.role = role || null;
                
                // Re-render to update styling
                renderPortalUsersTable(allPortalUsers);
                
                showToast(role === 'admin' ? ' User promoted to Admin' : 'Role updated to User', 'success');
            } catch (err) {
                console.error(err);
                showToast('Failed to update role', 'error');
            }
        }
        
        async function approvePortalUser(userId) {
            const user = allPortalUsers.find(u => u.id == userId);
            if (!user?.assigned_brand) {
                showToast('Please assign a brand first', 'warning');
                return;
            }
            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ 
                        status: 'approved', 
                        approved_by: adminName || 'Admin',
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                if (error) throw error;
                showToast('User approved! They can now access the portal.', 'success');
                loadPortalUsers();
            } catch (err) {
                console.error(err);
                showToast('Failed to approve user', 'error');
            }
        }
        
        async function denyPortalUser(userId) {
            const reason = prompt('Reason for denial (optional):');
            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ 
                        status: 'denied',
                        denied_reason: reason || null
                    })
                    .eq('id', userId);
                if (error) throw error;
                showToast('User denied', 'success');
                loadPortalUsers();
            } catch (err) {
                console.error(err);
                showToast('Failed to deny user', 'error');
            }
        }
        
        function copyPortalLink() {
            const link = window.location.origin + '/brand-portal.html';
            navigator.clipboard.writeText(link);
            showToast('Portal link copied!', 'success');
        }

        // ==================== CREATOR PORTAL ====================
        let creatorPortalData = [];
        let creatorApplicantsData = [];
        let groupedCreators = [];
        let portalAdmins = [];
        let accountRequests = [];
        
        async function loadCreatorPortalData() {
            showLoading('creatorportal', 'Loading creator portal data...');
            try {
                const brandFilter = document.getElementById('creatorPortalBrandFilter')?.value || 'all';
                const statusFilter = document.getElementById('creatorPortalStatusFilter')?.value || 'all';
                
                // Load creators from managed_creators
                let creatorsQuery = supabaseClient.from('managed_creators').select('*').order('account_1', { ascending: true });
                
                const { data: creators, error: creatorsError } = await creatorsQuery;
                if (creatorsError) throw creatorsError;
                
                creatorPortalData = creators || [];
                
                // Group creators by discord_id or account_1
                groupedCreators = groupCreatorsByIdentity(creatorPortalData);
                
                // Apply filters
                let filteredCreators = groupedCreators;
                if (brandFilter !== 'all') {
                    filteredCreators = filteredCreators.filter(g => g.brands.includes(brandFilter));
                }
                if (statusFilter === 'linked') {
                    filteredCreators = filteredCreators.filter(g => g.hasDiscord);
                } else if (statusFilter === 'unlinked') {
                    filteredCreators = filteredCreators.filter(g => !g.hasDiscord);
                }
                
                // Load pending applicants
                let applicantsQuery = supabaseClient.from('creator_applications').select('*').in('status', ['pending', 'reviewing', 'waitlist']).order('created_at', { ascending: false });
                if (brandFilter !== 'all') {
                    applicantsQuery = applicantsQuery.eq('brand', brandFilter);
                }
                
                const { data: applicants, error: applicantsError } = await applicantsQuery;
                if (applicantsError) throw applicantsError;
                
                creatorApplicantsData = applicants || [];
                
                // Load portal admins
                const { data: admins } = await supabaseClient.from('brand_portal_users').select('*').eq('role', 'admin').order('created_at', { ascending: false });
                portalAdmins = admins || [];
                
                // Load pending account requests
                const { data: requests } = await supabaseClient.from('creator_account_requests').select('*').eq('status', 'pending').order('created_at', { ascending: false });
                accountRequests = requests || [];
                
                // Render tables
                renderCreatorPortalTable(filteredCreators);
                renderCreatorApplicantsTable(creatorApplicantsData);
                renderPortalAdminsTable(portalAdmins);
                renderAccountRequestsTable(accountRequests);
                updateCreatorPortalStats();
                
            } catch (err) {
                console.error('Error loading creator portal data:', err);
                showToast('Failed to load creator portal data', 'error');
            } finally {
                hideLoading('creatorportal');
            }
        }
        
        function groupCreatorsByIdentity(creators) {
            const groups = {};
            
            creators.forEach(c => {
                // Group key: discord_id if available, otherwise first account
                const key = (c.discord_id && c.discord_id.trim()) ? `d_${c.discord_id}` : `a_${(c.account_1 || '').toLowerCase()}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        key: key,
                        displayName: c.real_name || c.account_1 || 'Unknown',
                        discordId: c.discord_id || null,
                        discordName: c.discord_name || null,
                        discordAvatar: c.discord_avatar || null,
                        hasDiscord: !!(c.discord_id && c.discord_id.trim()),
                        brands: [],
                        accounts: [],
                        records: []
                    };
                }
                
                // Add brand if not already present
                if (c.brand && !groups[key].brands.includes(c.brand)) {
                    groups[key].brands.push(c.brand);
                }
                
                // Add accounts
                [c.account_1, c.account_2, c.account_3, c.account_4, c.account_5].forEach(a => {
                    if (a && a.trim() && !groups[key].accounts.includes(a.toLowerCase())) {
                        groups[key].accounts.push(a.toLowerCase());
                    }
                });
                
                // Keep reference to original records (for linking)
                groups[key].records.push(c);
                
                // Update display name if we find a real_name
                if (c.real_name && (!groups[key].displayName || groups[key].displayName === c.account_1)) {
                    groups[key].displayName = c.real_name;
                }
                
                // Update discord info if found
                if (c.discord_id && c.discord_id.trim()) {
                    groups[key].hasDiscord = true;
                    groups[key].discordId = c.discord_id;
                    groups[key].discordName = c.discord_name || groups[key].discordName;
                    groups[key].discordAvatar = c.discord_avatar || groups[key].discordAvatar;
                }
            });
            
            return Object.values(groups).sort((a, b) => a.displayName.localeCompare(b.displayName));
        }
        
        let selectedCreatorKeys = new Set();
        
        function renderCreatorPortalTable(creators) {
            const tbody = document.getElementById('creatorPortalBody');
            if (!creators || creators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No creators found</td></tr>';
                return;
            }
            
            const brandDisplay = { 'catakor': 'Cata-Kor', 'jiyu': 'JiYu', 'physicians_choice': 'Physicians Choice', 'peach_slices': 'Peach Slices', 'yerba_magic': 'Yerba Magic' };
            const brandColors = { 'catakor': '#ef4444', 'jiyu': '#8b5cf6', 'physicians_choice': '#3b82f6', 'peach_slices': '#f59e0b', 'yerba_magic': '#22c55e' };
            
            tbody.innerHTML = creators.map(g => {
                const accounts = g.accounts.map(a => `@${a}`).join(', ');
                const brandBadges = g.brands.map(b => `<span class="badge" style="background: ${brandColors[b] || '#666'}20; color: ${brandColors[b] || '#666'}; font-size: 0.7rem; padding: 2px 6px; margin-right: 4px;">${brandDisplay[b] || b}</span>`).join('');
                const firstRecordId = g.records[0]?.id;
                const isSelected = selectedCreatorKeys.has(g.key);
                
                return `<tr data-search="${g.displayName.toLowerCase()} ${g.discordName?.toLowerCase() || ''} ${g.accounts.join(' ')}" data-key="${g.key}" style="${isSelected ? 'background: var(--accent-dim);' : ''}">
                    <td style="text-align: center;">
                        <input type="checkbox" class="creator-checkbox" data-key="${g.key}" ${isSelected ? 'checked' : ''} onchange="toggleCreatorSelection('${g.key}')">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${g.hasDiscord ? 'var(--success-dim)' : 'var(--warning-dim)'}; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0;">
                                ${g.discordAvatar ? `<img src="${g.discordAvatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : g.displayName.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${g.displayName}</div>
                                ${g.brands.length > 1 ? `<div style="font-size: 0.7rem; color: var(--purple);"> ${g.brands.length} brands</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-size: 0.85rem;">${g.discordName || '-'}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">${g.hasDiscord ? g.discordId : 'Not linked'}</div>
                    </td>
                    <td style="max-width: 180px;">${brandBadges || '-'}</td>
                    <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${accounts}">${accounts || '-'}</td>
                    <td>
                        ${g.hasDiscord 
                            ? '<span class="status-badge" style="background: var(--success-dim); color: var(--success);"> Can Login</span>'
                            : '<span class="status-badge" style="background: var(--warning-dim); color: var(--warning);"> No Access</span>'
                        }
                    </td>
                    <td>
                        <div style="display: flex; gap: 6px;">
                            ${!g.hasDiscord ? `<button class="btn btn-sm" onclick="promptLinkDiscordGroup('${g.key}', '${g.displayName.replace(/'/g, "\\'")}')"> Link</button>` : ''}
                            <button class="btn btn-sm" onclick="viewCreatorInPortal(${firstRecordId})"> View</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            
            updateMergeBar();
        }
        
        function toggleCreatorSelection(key) {
            if (selectedCreatorKeys.has(key)) {
                selectedCreatorKeys.delete(key);
            } else {
                selectedCreatorKeys.add(key);
            }
            updateMergeBar();
            updateRowHighlights();
        }
        
        function toggleSelectAllCreators(checkbox) {
            const visibleRows = document.querySelectorAll('#creatorPortalBody tr[data-key]:not([style*="display: none"])');
            visibleRows.forEach(row => {
                const key = row.getAttribute('data-key');
                if (checkbox.checked) {
                    selectedCreatorKeys.add(key);
                } else {
                    selectedCreatorKeys.delete(key);
                }
                const cb = row.querySelector('.creator-checkbox');
                if (cb) cb.checked = checkbox.checked;
            });
            updateMergeBar();
            updateRowHighlights();
        }
        
        function updateRowHighlights() {
            document.querySelectorAll('#creatorPortalBody tr[data-key]').forEach(row => {
                const key = row.getAttribute('data-key');
                row.style.background = selectedCreatorKeys.has(key) ? 'var(--accent-dim)' : '';
            });
        }
        
        function updateMergeBar() {
            const mergeBar = document.getElementById('mergeBar');
            const mergeCount = document.getElementById('mergeCount');
            const count = selectedCreatorKeys.size;
            
            if (count >= 2) {
                mergeBar.style.display = 'flex';
                mergeCount.textContent = `${count} selected`;
            } else {
                mergeBar.style.display = 'none';
            }
        }
        
        function clearMergeSelection() {
            selectedCreatorKeys.clear();
            document.querySelectorAll('.creator-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllCreators').checked = false;
            updateMergeBar();
            updateRowHighlights();
        }
        
        function showMergeModal() {
            if (selectedCreatorKeys.size < 2) {
                showToast('Select at least 2 creators to merge', 'warning');
                return;
            }
            
            const modal = document.getElementById('mergeCreatorsModal');
            const preview = document.getElementById('mergePreview');
            const stats = document.getElementById('mergeStats');
            
            // Get selected creators
            const selected = groupedCreators.filter(g => selectedCreatorKeys.has(g.key));
            
            // Build preview
            let totalRecords = 0;
            let allBrands = new Set();
            let allAccounts = new Set();
            let existingDiscordId = null;
            
            preview.innerHTML = selected.map(g => {
                totalRecords += g.records.length;
                g.brands.forEach(b => allBrands.add(b));
                g.accounts.forEach(a => allAccounts.add(a));
                if (g.hasDiscord && !existingDiscordId) existingDiscordId = g.discordId;
                
                return `<div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                    <div style="width: 28px; height: 28px; border-radius: 50%; background: ${g.hasDiscord ? 'var(--success-dim)' : 'var(--warning-dim)'}; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                        ${g.displayName.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9rem;">${g.displayName}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${g.accounts.map(a => '@' + a).join(', ')}</div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${g.records.length} record${g.records.length > 1 ? 's' : ''}</div>
                </div>`;
            }).join('');
            
            // Build stats
            stats.innerHTML = `
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div><strong>${selected.length}</strong> creators</div>
                    <div><strong>${totalRecords}</strong> database records</div>
                    <div><strong>${allBrands.size}</strong> brands</div>
                    <div><strong>${allAccounts.size}</strong> TikTok accounts</div>
                </div>
            `;
            
            // Pre-fill Discord ID if one exists
            const discordInput = document.getElementById('mergeDiscordId');
            discordInput.value = existingDiscordId || '';
            
            modal.style.display = 'flex';
        }
        
        function hideMergeModal() {
            document.getElementById('mergeCreatorsModal').style.display = 'none';
        }
        
        async function executeMerge() {
            const discordId = document.getElementById('mergeDiscordId').value.trim();
            if (!discordId) {
                showToast('Please enter a Discord ID', 'warning');
                return;
            }
            
            const selected = groupedCreators.filter(g => selectedCreatorKeys.has(g.key));
            const allRecords = selected.flatMap(g => g.records);
            
            if (!confirm(`This will update ${allRecords.length} database records with Discord ID: ${discordId}\n\nAre you sure?`)) {
                return;
            }
            
            try {
                let updated = 0;
                for (const record of allRecords) {
                    const { error } = await supabaseClient.from('managed_creators')
                        .update({ discord_id: discordId })
                        .eq('id', record.id);
                    if (!error) updated++;
                }
                
                showToast(`Merged ${selected.length} creators (${updated} records updated)!`, 'success');
                hideMergeModal();
                clearMergeSelection();
                loadCreatorPortalData();
            } catch (err) {
                console.error(err);
                showToast('Failed to merge creators', 'error');
            }
        }
        
        function filterCreatorPortalTable() {
            const search = document.getElementById('creatorPortalSearch').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#creatorPortalBody tr[data-search]');
            
            rows.forEach(row => {
                const searchData = row.getAttribute('data-search') || '';
                row.style.display = searchData.includes(search) ? '' : 'none';
            });
        }
        
        function renderCreatorApplicantsTable(applicants) {
            const tbody = document.getElementById('creatorApplicantsBody');
            if (!applicants || applicants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No pending applicants</td></tr>';
                return;
            }
            
            tbody.innerHTML = applicants.map(a => {
                const hasDiscord = a.discord_id && a.discord_id.trim() !== '';
                const statusColors = { 'pending': 'warning', 'reviewing': 'blue', 'waitlist': 'purple' };
                
                return `<tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--${statusColors[a.status] || 'warning'}-dim); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">
                                ${(a.discord_username || a.tiktok_handle || '?').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${a.discord_username || a.tiktok_handle || 'Unknown'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">ID: ${a.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-size: 0.85rem;">${a.discord_username || '-'}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">${hasDiscord ? a.discord_id : 'Not linked'}</div>
                    </td>
                    <td>@${a.tiktok_handle || '-'}</td>
                    <td><span class="status-badge status-${a.status}">${a.status}</span></td>
                    <td>${a.created_at ? new Date(a.created_at).toLocaleDateString() : '-'}</td>
                    <td>
                        ${hasDiscord 
                            ? '<span class="status-badge" style="background: var(--success-dim); color: var(--success);"> Can View Learn</span>'
                            : '<span class="status-badge" style="background: var(--error-dim); color: var(--error);"> No Access</span>'
                        }
                    </td>
                    <td>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-sm" onclick="switchView('applications')"> Manage</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function renderPortalAdminsTable(admins) {
            const tbody = document.getElementById('portalAdminsBody');
            if (!admins || admins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No admins configured</td></tr>';
                return;
            }
            
            tbody.innerHTML = admins.map(a => {
                return `<tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accent-dim); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">
                                ${a.discord_avatar ? `<img src="${a.discord_avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : (a.discord_username || '?').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${a.discord_username || 'Unknown'}</div>
                                <div style="font-size: 0.75rem; color: var(--accent);"> Admin</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-size: 0.85rem;">${a.discord_username || '-'}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">${a.discord_id || '-'}</div>
                    </td>
                    <td>${a.discord_email || '-'}</td>
                    <td>${a.created_at ? new Date(a.created_at).toLocaleDateString() : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removePortalAdmin('${a.id}', '${(a.discord_username || '').replace(/'/g, "\\'")}')"> Remove</button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function renderAccountRequestsTable(requests) {
            const tbody = document.getElementById('accountRequestsBody');
            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No pending account requests </td></tr>';
                return;
            }
            
            tbody.innerHTML = requests.map(r => {
                return `<tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--info-dim); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">
                                ${(r.discord_username || '?').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${r.discord_username || 'Unknown'}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${r.discord_id || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-weight: 600; color: var(--accent);">@${r.tiktok_handle}</div>
                        ${r.notes ? `<div style="font-size: 0.7rem; color: var(--text-muted);">${r.notes}</div>` : ''}
                    </td>
                    <td>
                        ${r.has_existing_data 
                            ? '<span class="status-badge" style="background: var(--warning-dim); color: var(--warning);"> Yes - Verify</span>'
                            : '<span class="status-badge" style="background: var(--success-dim); color: var(--success);"> No data</span>'
                        }
                    </td>
                    <td>${r.created_at ? new Date(r.created_at).toLocaleDateString() : '-'}</td>
                    <td>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-sm btn-success" onclick="approveAccountRequest(${r.id}, '${r.discord_id}', '${r.tiktok_handle}', '${(r.discord_username || '').replace(/'/g, "\\'")}')"> Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="denyAccountRequest(${r.id}, '${(r.discord_username || '').replace(/'/g, "\\'")}', '${r.tiktok_handle}')"> Deny</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        
        async function approveAccountRequest(requestId, discordId, tiktokHandle, discordUsername) {
            if (!confirm(`Approve @${tiktokHandle} for ${discordUsername}?\n\nThis will link the account to their Discord.`)) return;
            
            try {
                // Update request status
                const { error: updateError } = await supabaseClient
                    .from('creator_account_requests')
                    .update({ 
                        status: 'approved',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: window.currentUser?.username || 'admin'
                    })
                    .eq('id', requestId);
                
                if (updateError) throw updateError;
                
                // Check if account exists in managed_creators without discord
                const { data: existingRecord } = await supabaseClient
                    .from('managed_creators')
                    .select('id')
                    .or(`account_1.ilike.${tiktokHandle},account_2.ilike.${tiktokHandle},account_3.ilike.${tiktokHandle},account_4.ilike.${tiktokHandle},account_5.ilike.${tiktokHandle}`)
                    .is('discord_id', null)
                    .limit(1);
                
                if (existingRecord && existingRecord.length > 0) {
                    // Link Discord to existing record
                    await supabaseClient
                        .from('managed_creators')
                        .update({ discord_id: discordId })
                        .eq('id', existingRecord[0].id);
                }
                
                showToast(`Approved @${tiktokHandle} for ${discordUsername}!`, 'success');
                loadCreatorPortalData();
            } catch (err) {
                console.error('Error approving request:', err);
                showToast('Failed to approve request', 'error');
            }
        }
        
        async function denyAccountRequest(requestId, discordUsername, tiktokHandle) {
            const reason = prompt(`Deny @${tiktokHandle} for ${discordUsername}?\n\nEnter a reason (optional):`);
            if (reason === null) return; // Cancelled
            
            try {
                const { error } = await supabaseClient
                    .from('creator_account_requests')
                    .update({ 
                        status: 'denied',
                        denial_reason: reason || 'Request denied by admin',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: window.currentUser?.username || 'admin'
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                showToast(`Denied @${tiktokHandle} for ${discordUsername}`, 'info');
                loadCreatorPortalData();
            } catch (err) {
                console.error('Error denying request:', err);
                showToast('Failed to deny request', 'error');
            }
        }
        
        function updateCreatorPortalStats() {
            const linked = groupedCreators.filter(g => g.hasDiscord).length;
            const unlinked = groupedCreators.filter(g => !g.hasDiscord).length;
            const total = groupedCreators.length;
            const pending = creatorApplicantsData.length;
            const linkRate = total > 0 ? Math.round((linked / total) * 100) : 0;
            
            document.getElementById('statLinkedCreators').textContent = linked.toLocaleString();
            document.getElementById('statUnlinkedCreators').textContent = unlinked.toLocaleString();
            document.getElementById('statTotalActiveCreators').textContent = total.toLocaleString();
            document.getElementById('statPendingApplicants').textContent = pending.toLocaleString();
            document.getElementById('statLinkRate').textContent = linkRate + '%';
            
            // Update badges
            const badge = document.getElementById('pendingCreatorPortalBadge');
            const applicantsBadge = document.getElementById('applicantsTabBadge');
            const requestsBadge = document.getElementById('accountRequestsBadge');
            
            if (unlinked > 0) {
                badge.textContent = unlinked;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
            if (pending > 0) {
                applicantsBadge.textContent = pending;
                applicantsBadge.style.display = 'inline-flex';
            } else {
                applicantsBadge.style.display = 'none';
            }
            if (accountRequests.length > 0) {
                requestsBadge.textContent = accountRequests.length;
                requestsBadge.style.display = 'inline-flex';
            } else {
                requestsBadge.style.display = 'none';
            }
        }
        
        function switchCreatorPortalTab(tab) {
            // Update tab buttons
            document.querySelectorAll('[data-cptab]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cptab === tab);
            });
            // Show/hide content
            document.getElementById('cpTab-creators').style.display = tab === 'creators' ? 'block' : 'none';
            document.getElementById('cpTab-requests').style.display = tab === 'requests' ? 'block' : 'none';
            document.getElementById('cpTab-applicants').style.display = tab === 'applicants' ? 'block' : 'none';
            document.getElementById('cpTab-admins').style.display = tab === 'admins' ? 'block' : 'none';
        }
        
        function copyCreatorPortalLink() {
            const link = window.location.origin + '/creator-portal.html';
            navigator.clipboard.writeText(link);
            showToast('Creator Portal link copied!', 'success');
        }
        
        async function promptLinkDiscordGroup(groupKey, creatorName) {
            const discordId = prompt(`Enter Discord ID for ${creatorName}:\n\n(You can find this by right-clicking the user in Discord with Developer Mode enabled)`);
            if (!discordId || !discordId.trim()) return;
            
            // Find all records in this group
            const group = groupedCreators.find(g => g.key === groupKey);
            if (!group) return;
            
            try {
                // First, link the selected group's records
                const recordsToLink = [...group.records];
                
                // Search for other potential matches (same real_name or overlapping accounts)
                const realName = group.displayName;
                const accounts = group.accounts;
                
                // Find other unlinked groups that might be the same person
                const potentialMatches = groupedCreators.filter(g => {
                    if (g.key === groupKey) return false; // Skip current group
                    if (g.hasDiscord) return false; // Skip already linked
                    
                    // Check name match (case insensitive)
                    const nameMatch = realName && g.displayName && 
                        realName.toLowerCase() === g.displayName.toLowerCase();
                    
                    // Check for overlapping accounts
                    const accountOverlap = g.accounts.some(a => accounts.includes(a));
                    
                    return nameMatch || accountOverlap;
                });
                
                // If there are potential matches, ask user
                if (potentialMatches.length > 0) {
                    const matchInfo = potentialMatches.map(m => {
                        const brands = m.brands.map(b => {
                            const brandDisplay = { 'catakor': 'Cata-Kor', 'jiyu': 'JiYu', 'physicians_choice': 'Physicians Choice', 'peach_slices': 'Peach Slices', 'yerba_magic': 'Yerba Magic' };
                            return brandDisplay[b] || b;
                        }).join(', ');
                        return ` ${m.displayName} (${brands}) - @${m.accounts[0]}`;
                    }).join('\n');
                    
                    const linkAll = confirm(
                        `Found ${potentialMatches.length} other entry(s) that might be the same person:\n\n` +
                        `${matchInfo}\n\n` +
                        `Link ALL of them with this Discord ID?`
                    );
                    
                    if (linkAll) {
                        potentialMatches.forEach(m => {
                            recordsToLink.push(...m.records);
                        });
                    }
                }
                
                // Update all records
                for (const record of recordsToLink) {
                    await supabaseClient.from('managed_creators')
                        .update({ discord_id: discordId.trim() })
                        .eq('id', record.id);
                }
                
                showToast(`Discord linked for ${creatorName} (${recordsToLink.length} record${recordsToLink.length > 1 ? 's' : ''})!`, 'success');
                loadCreatorPortalData();
            } catch (err) {
                console.error(err);
                showToast('Failed to link Discord', 'error');
            }
        }
        
        function viewCreatorInPortal(creatorId) {
            window.open(`/creator-portal.html?creator=${creatorId}`, '_blank');
        }
        
        // Portal Admin management
        function showAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'flex';
            document.getElementById('newAdminDiscordId').value = '';
            document.getElementById('newAdminDiscordId').focus();
        }
        
        function hideAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'none';
        }
        
        async function addPortalAdmin() {
            const discordId = document.getElementById('newAdminDiscordId').value.trim();
            if (!discordId) {
                showToast('Please enter a Discord ID', 'warning');
                return;
            }
            
            try {
                // Check if user exists in brand_portal_users
                const { data: existing } = await supabaseClient.from('brand_portal_users').select('*').eq('discord_id', discordId).single();
                
                if (existing) {
                    // Update existing user to admin
                    const { error } = await supabaseClient.from('brand_portal_users')
                        .update({ role: 'admin' })
                        .eq('discord_id', discordId);
                    if (error) throw error;
                    showToast(`${existing.discord_username || 'User'} is now a Portal Admin!`, 'success');
                } else {
                    // Create new admin user
                    const { error } = await supabaseClient.from('brand_portal_users')
                        .insert({ 
                            discord_id: discordId, 
                            role: 'admin', 
                            status: 'approved',
                            discord_username: 'Admin (pending login)'
                        });
                    if (error) throw error;
                    showToast('Admin added! They need to log into Creator Portal once to complete setup.', 'success');
                }
                
                hideAddAdminModal();
                loadCreatorPortalData();
            } catch (err) {
                console.error(err);
                showToast('Failed to add admin', 'error');
            }
        }
        
        async function removePortalAdmin(id, username) {
            if (!confirm(`Remove admin access for ${username}?`)) return;
            
            try {
                const { error } = await supabaseClient.from('brand_portal_users')
                    .update({ role: 'user' })
                    .eq('id', id);
                if (error) throw error;
                showToast(`${username} is no longer an admin`, 'success');
                loadCreatorPortalData();
            } catch (err) {
                console.error(err);
                showToast('Failed to remove admin', 'error');
            }
        }

        // ==================== CREATOR APPLICATIONS ====================
        let allApplications = [];
        
        async function loadApplicationsData() {
            showLoading('applications', 'Loading applications...');
            try {
                const statusFilter = document.getElementById('appStatusFilter')?.value || 'pending';
                const brandFilter = document.getElementById('appBrandFilter')?.value || 'all';
                
                let query = supabaseClient.from('creator_applications').select('*').order('created_at', { ascending: false });
                
                if (statusFilter !== 'all') {
                    query = query.eq('status', statusFilter);
                }
                if (brandFilter !== 'all') {
                    query = query.eq('brand', brandFilter);
                }
                
                const { data, error } = await query;
                if (error) throw error;
                
                allApplications = data || [];
                renderApplicationsTable(allApplications, statusFilter, brandFilter);
                updateApplicationStats();
                
            } catch (err) {
                console.error('Error loading applications:', err);
                showToast('Failed to load applications', 'error');
            } finally {
                hideLoading('applications');
            }
        }
        
        function filterApplicationsByStatus(status) {
            document.getElementById('appStatusFilter').value = status;
            loadApplicationsData();
        }
        
        async function updateApplicationStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('creator_applications')
                    .select('status');
                    
                if (error) throw error;
                
                const stats = {
                    pending: 0,
                    reviewing: 0,
                    accepted: 0,
                    rejected: 0,
                    total: data?.length || 0
                };
                
                data?.forEach(app => {
                    if (stats.hasOwnProperty(app.status)) {
                        stats[app.status]++;
                    }
                });
                
                document.getElementById('statPendingApps').textContent = stats.pending;
                document.getElementById('statReviewingApps').textContent = stats.reviewing;
                document.getElementById('statAcceptedApps').textContent = stats.accepted;
                document.getElementById('statRejectedApps').textContent = stats.rejected;
                document.getElementById('statTotalApps').textContent = stats.total;
                
                // Update badge
                const badge = document.getElementById('pendingAppsBadge');
                if (badge) {
                    badge.textContent = stats.pending;
                    badge.style.display = stats.pending > 0 ? 'inline-block' : 'none';
                }
                
                // Store stats for empty state
                window.appStats = stats;
            } catch (err) {
                console.error('Error updating app stats:', err);
            }
        }
        
        function renderApplicationsTable(applications, statusFilter = 'pending', brandFilter = 'all') {
            const tbody = document.getElementById('applicationsTableBody');
            if (!tbody) return;
            
            if (!applications || applications.length === 0) {
                const stats = window.appStats || {};
                const statusLabels = {
                    'pending': 'pending',
                    'reviewing': 'in review',
                    'accepted': 'accepted',
                    'rejected': 'rejected',
                    'waitlist': 'on waitlist',
                    'all': ''
                };
                
                let emptyMessage = '';
                let suggestion = '';
                
                if (statusFilter === 'pending' && stats.pending === 0) {
                    emptyMessage = ' No pending applications!';
                    if (stats.total > 0) {
                        suggestion = `You have ${stats.total} total application${stats.total > 1 ? 's' : ''}.`;
                        if (stats.reviewing > 0) suggestion += ` <a href="#" onclick="filterApplicationsByStatus('reviewing'); return false;" style="color: var(--accent);">${stats.reviewing} in review</a>`;
                        if (stats.accepted > 0) suggestion += `${stats.reviewing > 0 ? ',' : ''} <a href="#" onclick="filterApplicationsByStatus('accepted'); return false;" style="color: var(--success);">${stats.accepted} accepted</a>`;
                        if (stats.rejected > 0) suggestion += `${(stats.reviewing > 0 || stats.accepted > 0) ? ',' : ''} <a href="#" onclick="filterApplicationsByStatus('rejected'); return false;" style="color: var(--danger);">${stats.rejected} rejected</a>`;
                    } else {
                        suggestion = 'Share your application link to start receiving applications!';
                    }
                } else if (statusFilter !== 'all') {
                    emptyMessage = `No ${statusLabels[statusFilter]} applications`;
                    suggestion = `<a href="#" onclick="filterApplicationsByStatus('all'); return false;" style="color: var(--accent);">View all applications</a>`;
                } else {
                    emptyMessage = 'No applications found';
                    suggestion = 'Share your application link to start receiving applications!';
                }
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 60px 40px;">
                            <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${emptyMessage}</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">${suggestion}</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const statusColors = {
                'pending': 'warning',
                'reviewing': 'info',
                'accepted': 'success',
                'rejected': 'danger',
                'waitlist': 'purple'
            };
            const statusIcons = {
                'pending': '',
                'reviewing': '',
                'accepted': '',
                'rejected': '',
                'waitlist': ''
            };
            
            tbody.innerHTML = applications.map(app => {
                const hasDiscord = app.discord_username || app.discord_name || app.discord_id;
                const discordVerified = app.discord_id ? true : false;
                const discordIcon = hasDiscord ? (discordVerified ? '<span title="Discord OAuth Verified" style="color: #5865F2; margin-left: 6px;"></span>' : '<span title="Discord (manual)" style="color: var(--text-muted); margin-left: 6px;"></span>') : '';
                
                return `
                <tr>
                    <td onclick="event.stopPropagation();">
                        <input type="checkbox" class="bulk-checkbox" data-id="${app.id}" onchange="toggleApplicationSelect(this, '${app.id}')">
                    </td>
                    <td>
                        <div style="font-weight: 600;">${app.full_name || 'Unknown'}${discordIcon}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${app.email || (hasDiscord ? (app.discord_username || app.discord_name) : '')}</div>
                    </td>
                    <td>
                        <a href="https://tiktok.com/@${app.tiktok_handle}" target="_blank" style="color: var(--accent); font-weight: 500;">
                            @${app.tiktok_handle}
                        </a>
                    </td>
                    <td><span class="badge badge-outline">${BRAND_DISPLAY[app.brand] || app.brand}</span></td>
                    <td>${app.follower_count || '-'}</td>
                    <td><span class="badge badge-${statusColors[app.status] || 'secondary'}">${statusIcons[app.status] || ''} ${app.status}</span></td>
                    <td style="color: var(--text-muted); font-size: 0.8rem;">${new Date(app.created_at).toLocaleDateString()}</td>
                    <td style="text-align: right;">
                        <div style="display: flex; gap: 6px; justify-content: flex-end;">
                            ${app.status === 'pending' || app.status === 'reviewing' ? `
                                <button class="btn btn-small btn-success" onclick="quickAcceptFromTable('${app.id}')" title="Accept"></button>
                                <button class="btn btn-small btn-danger" onclick="quickRejectFromTable('${app.id}')" title="Reject"></button>
                            ` : ''}
                            <button class="btn btn-small" onclick="openApplicationModal('${app.id}')" title="Review"></button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }
        
        function openApplicationModal(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;
            
            // Parse extra_data for all answers
            let extraData = {};
            try {
                extraData = typeof app.extra_data === 'string' ? JSON.parse(app.extra_data) : (app.extra_data || {});
            } catch (e) {
                extraData = {};
            }
            
            // Get field labels mapping (if saved)
            const fieldLabels = extraData._fieldLabels || {};
            
            // System/internal fields to exclude from display
            const hiddenFields = ['discord_oauth', 'discord_global_name', '_fieldLabels', 'brand'];
            
            // Build ALL form answers dynamically
            const allAnswers = Object.entries(extraData)
                .filter(([key]) => !hiddenFields.includes(key))
                .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                .map(([key, value]) => {
                    // Use saved label if available, otherwise format the key nicely
                    let label = fieldLabels[key];
                    if (!label) {
                        label = key
                            .replace(/^field_\d+$/, 'Custom Field')
                            .replace(/^custom_\d+$/, 'Custom Field')
                            .replace(/_/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                    }
                    return { key, label, value };
                });
            
            // Render answers HTML
            const renderAnswers = (answers) => answers.map(a => {
                let displayValue = a.value;
                if (typeof displayValue === 'string' && displayValue.startsWith('http')) {
                    displayValue = `<a href="${displayValue}" target="_blank" style="color: var(--accent);">View Link </a>`;
                }
                if (typeof displayValue === 'boolean') {
                    displayValue = displayValue ? ' Yes' : ' No';
                }
                return `
                    <div style="padding: 12px 0; border-bottom: 1px solid var(--border-light);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">${a.label}</div>
                        <div style="color: var(--text-primary);">${displayValue || '-'}</div>
                    </div>
                `;
            }).join('');
            
            // Get the modal body and rebuild it dynamically
            const modal = document.getElementById('applicationModal');
            const modalBody = modal.querySelector('.modal-body');
            
            // Discord avatar HTML
            const discordAvatarHtml = app.discord_avatar 
                ? `<img src="${app.discord_avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` 
                : '<span style="color: white; font-size: 1.25rem;"></span>';
            
            modalBody.innerHTML = `
                <input type="hidden" id="appId" value="${app.id}">
                
                <!-- Applicant Header -->
                <div style="padding: 20px 24px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 60px; height: 60px; background: var(--accent-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden;">
                            ${app.discord_avatar ? `<img src="${app.discord_avatar}" style="width: 100%; height: 100%; object-fit: cover;">` : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.25rem; color: var(--text-primary);">${app.full_name || extraData.full_name || 'Unknown'}</div>
                            <div style="display: flex; gap: 12px; margin-top: 4px; flex-wrap: wrap;">
                                ${app.email ? `<span style="font-size: 0.85rem; color: var(--text-muted);">${app.email}</span>` : ''}
                                ${app.phone ? `<span style="font-size: 0.85rem; color: var(--text-muted);">${app.phone}</span>` : ''}
                            </div>
                        </div>
                        <div class="badge badge-primary" style="font-size: 0.9rem; padding: 8px 16px;">${BRAND_DISPLAY[app.brand] || app.brand}</div>
                    </div>
                </div>
                
                <!-- TikTok Info -->
                ${app.tiktok_handle ? `
                <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-light);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">TikTok Profile</div>
                    <div style="display: flex; align-items: center; gap: 16px; background: var(--bg-secondary); padding: 16px; border-radius: 12px;">
                        <a href="https://tiktok.com/@${app.tiktok_handle}" target="_blank" style="font-weight: 600; font-size: 1.1rem; color: var(--accent);">@${app.tiktok_handle}</a>
                        <div style="display: flex; gap: 8px; margin-left: auto;">
                            ${app.follower_count ? `<span class="badge" style="background: var(--bg-card); color: var(--text-secondary);">${app.follower_count} followers</span>` : ''}
                            ${app.avg_views ? `<span class="badge" style="background: var(--bg-card); color: var(--text-secondary);">${app.avg_views} avg views</span>` : ''}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Discord Info -->
                ${app.discord_username || app.discord_id ? `
                <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-light);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Discord</div>
                    <div style="display: flex; align-items: center; gap: 16px; background: var(--bg-secondary); padding: 16px; border-radius: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #5865F2; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${discordAvatarHtml}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">${app.discord_username || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">ID: ${app.discord_id || 'N/A'}</div>
                        </div>
                        ${app.discord_id ? `<span class="badge" style="background: rgba(88, 101, 242, 0.15); color: #5865F2; border: 1px solid #5865F2;"> OAUTH VERIFIED</span>` : ''}
                    </div>
                </div>
                ` : ''}
                
                <!-- Form Answers -->
                <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-light);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Form Answers</div>
                    ${allAnswers.length > 0 ? renderAnswers(allAnswers) : '<div style="color: var(--text-muted); font-style: italic;">No additional form data</div>'}
                </div>
                
                <!-- Admin Controls -->
                <div style="padding: 20px 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Status</label>
                            <select id="appStatus" class="form-input" onchange="toggleAcceptOptions()" style="width: 100%;">
                                <option value="pending" ${app.status === 'pending' ? 'selected' : ''}> Pending</option>
                                <option value="reviewing" ${app.status === 'reviewing' ? 'selected' : ''}> Reviewing</option>
                                <option value="accepted" ${app.status === 'accepted' ? 'selected' : ''}> Accepted</option>
                                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}> Rejected</option>
                                <option value="waitlist" ${app.status === 'waitlist' ? 'selected' : ''}> Waitlist</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Admin Notes</label>
                            <input type="text" id="appNotes" class="form-input" placeholder="Add a note..." value="${app.admin_notes || ''}" style="width: 100%;">
                        </div>
                    </div>
                    
                    <div id="acceptOptions" style="display: ${app.status === 'accepted' ? 'block' : 'none'}; margin-top: 16px; padding: 16px; background: var(--success-dim); border-radius: 12px;">
                        <div style="font-size: 0.85rem; color: var(--success); margin-bottom: 8px;"> Accepting will create a managed creator record</div>
                    </div>
                </div>
                
                <!-- Footer Actions -->
                <div style="padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-light); display: flex; gap: 12px; justify-content: space-between;">
                    <button class="btn btn-danger" onclick="quickRejectApplication()"> Reject</button>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" onclick="closeApplicationModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveApplicationChanges()"> Save Changes</button>
                        <button class="btn btn-success" onclick="quickAcceptApplication()"> Accept</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        function toggleAcceptOptions() {
            const status = document.getElementById('appStatus').value;
            document.getElementById('acceptOptions').style.display = status === 'accepted' ? 'block' : 'none';
        }
        
        // Add event listener for status change
        document.addEventListener('DOMContentLoaded', () => {
            const appStatusEl = document.getElementById('appStatus');
            if (appStatusEl) {
                appStatusEl.addEventListener('change', toggleAcceptOptions);
            }
        });
        
        async function saveApplicationChanges() {
            const appId = document.getElementById('appId').value;
            const status = document.getElementById('appStatus').value;
            const notes = document.getElementById('appNotes').value;
            
            try {
                const app = allApplications.find(a => a.id === appId);
                
                // Update application
                const { error } = await supabaseClient
                    .from('creator_applications')
                    .update({
                        status,
                        admin_notes: notes,
                        reviewed_by: adminName || 'Admin',
                        reviewed_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', appId);
                    
                if (error) throw error;
                
                // Sync status with managed_creators
                if (app?.discord_id) {
                    const managedCreatorStatus = status === 'accepted' ? 'Active' 
                        : status === 'rejected' ? 'Inactive'
                        : status === 'reviewing' ? 'Pending'
                        : 'Applied';
                    
                    // Check if managed_creators record exists
                    const { data: existing } = await supabaseClient
                        .from('managed_creators')
                        .select('id')
                        .eq('discord_id', app.discord_id)
                        .eq('brand', app.brand)
                        .single();
                    
                    if (existing) {
                        // Update existing record status
                        await supabaseClient
                            .from('managed_creators')
                            .update({ 
                                status: managedCreatorStatus,
                                ...(status === 'accepted' ? { joined_at: new Date().toISOString() } : {})
                            })
                            .eq('id', existing.id);
                    }
                }
                
                // If accepted, add to roster (handles both update and create)
                if (status === 'accepted' && app) {
                    await addApplicationToRoster(app);
                }
                
                showToast('Application updated!', 'success');
                logActivity('edit', `Updated application: ${app?.full_name} (${status})`, app?.brand);
                closeApplicationModal();
                loadApplicationsData();
            } catch (err) {
                console.error('Error saving application:', err);
                showToast('Failed to save changes', 'error');
            }
        }
        
        // Unified function to add application to managed_creators
        async function addApplicationToRoster(app) {
            const commissionRate = parseFloat(document.getElementById('appCommissionRate')?.value || 10);
            const creatorRole = document.getElementById('appCreatorRole')?.value || 'Incubator';
            
            try {
                // Get discord name (prefer OAuth username)
                const discordName = app.discord_username || app.discord_name;
                const tiktokHandle = normalizeTikTok(app.tiktok_handle);
                
                // First, check for existing record by discord_id + brand (from new application flow)
                let existing = null;
                if (app.discord_id) {
                    const { data } = await supabaseClient
                        .from('managed_creators')
                        .select('id, discord_id, status')
                        .eq('discord_id', app.discord_id)
                        .eq('brand', app.brand)
                        .single();
                    existing = data;
                }
                
                // Fallback: check by tiktok + brand (for legacy data)
                if (!existing && tiktokHandle) {
                    const { data } = await supabaseClient
                        .from('managed_creators')
                        .select('id, discord_id, status')
                        .eq('account_1', tiktokHandle)
                        .eq('brand', app.brand)
                        .single();
                    existing = data;
                }
                
                let managedCreatorId;
                
                if (existing) {
                    // Update existing record (could be Applied, Pending, or even Inactive being reactivated)
                    const { error: updateError } = await supabaseClient
                        .from('managed_creators')
                        .update({
                            discord_id: app.discord_id || existing.discord_id,
                            discord_name: discordName || undefined,
                            discord_avatar: app.discord_avatar || undefined,
                            email: app.email || undefined,
                            real_name: app.full_name || undefined,
                            application_id: app.id,
                            status: 'Active',
                            role: creatorRole,
                            joined_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);
                    
                    if (updateError) throw updateError;
                    managedCreatorId = existing.id;
                    
                    const wasApplied = existing.status === 'Applied' || existing.status === 'Pending';
                    showToast(wasApplied ? `${app.full_name} approved!` : 'Creator updated in roster', 'success');
                } else {
                    // Create new managed_creator (legacy flow - shouldn't happen with new applications)
                    const { data: newCreator, error: insertError } = await supabaseClient
                        .from('managed_creators')
                        .insert({
                            real_name: app.full_name || null,
                            discord_name: normalizeDiscord(discordName) || null,
                            discord_id: app.discord_id || null,
                            discord_avatar: app.discord_avatar || null,
                            email: app.email || null,
                            brand: app.brand || 'catakor',
                            role: creatorRole,
                            status: 'Active',
                            account_1: tiktokHandle,
                            application_id: app.id,
                            joined_at: new Date().toISOString(),
                            notes: `Created from application on ${new Date().toLocaleDateString()}${app.discord_id ? ' (Discord OAuth)' : ''}`
                        })
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    managedCreatorId = newCreator.id;
                    showToast(`${app.full_name} added to roster!`, 'success');
                }
                
                // Update application with managed_creator_id
                await supabaseClient
                    .from('creator_applications')
                    .update({ managed_creator_id: managedCreatorId })
                    .eq('id', app.id);
                
                logActivity('edit', `Added ${app.full_name} (@${app.tiktok_handle}) to roster`, app.brand);
                
                return managedCreatorId;
            } catch (err) {
                console.error('Error adding to roster:', err);
                showToast('Failed to add to roster', 'error');
                return null;
            }
        }
        
        async function quickAcceptFromTable(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;
            
            // Check for Discord
            const hasDiscord = app.discord_username || app.discord_name || app.discord_id;
            if (!hasDiscord) {
                showToast('Cannot accept: Missing Discord username', 'error');
                return;
            }
            
            if (!confirm(`Accept ${app.full_name} (@${app.tiktok_handle}) and add to ${BRAND_DISPLAY[app.brand]} roster?`)) return;
            
            try {
                // Update application status
                await supabaseClient
                    .from('creator_applications')
                    .update({
                        status: 'accepted',
                        reviewed_by: adminName || 'Admin',
                        reviewed_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', appId);
                
                // Add to managed_creators using unified function
                await addApplicationToRoster(app);
                
                showToast(`${app.full_name} accepted and added to roster!`, 'success');
                logActivity('edit', `Accepted application: ${app.full_name} (@${app.tiktok_handle})`, app.brand);
                loadApplicationsData();
                await loadManagedCreators();
            } catch (err) {
                console.error('Error accepting application:', err);
                showToast('Failed to accept application', 'error');
            }
        }
        
        async function quickRejectFromTable(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;
            
            if (!confirm(`Reject application from ${app.full_name}?`)) return;
            
            try {
                await supabaseClient
                    .from('creator_applications')
                    .update({
                        status: 'rejected',
                        reviewed_by: adminName || 'Admin',
                        reviewed_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', appId);
                
                showToast('Application rejected', 'warning');
                logActivity('edit', `Rejected application: ${app.full_name}`, app.brand);
                loadApplicationsData();
            } catch (err) {
                console.error('Error rejecting application:', err);
                showToast('Failed to reject application', 'error');
            }
        }
        
        async function quickAcceptApplication() {
            const appId = document.getElementById('appId').value;
            document.getElementById('appStatus').value = 'accepted';
            await saveApplicationChanges();
        }
        
        async function quickRejectApplication() {
            const appId = document.getElementById('appId').value;
            const app = allApplications.find(a => a.id === appId);
            
            if (!confirm(`Reject application from ${app?.full_name}?`)) return;
            
            document.getElementById('appStatus').value = 'rejected';
            await saveApplicationChanges();
        }
        
        function copyApplicationLink() {
            const brandFilter = document.getElementById('appBrandFilter')?.value;
            let link = window.location.origin + '/apply.html';
            if (brandFilter && brandFilter !== 'all') {
                link += '?brand=' + brandFilter;
            }
            
            navigator.clipboard.writeText(link).then(() => {
                showToast('Application link copied!', 'success');
            }).catch(() => {
                showToast('Failed to copy link', 'error');
            });
        }
        
        function toggleApplyLinksDropdown() {
            const dropdown = document.getElementById('applyLinksDropdown');
            const isOpen = dropdown.style.display === 'block';
            dropdown.style.display = isOpen ? 'none' : 'block';
            
            // Close on click outside
            if (!isOpen) {
                setTimeout(() => {
                    document.addEventListener('click', closeApplyLinksDropdown);
                }, 10);
            }
        }
        
        function closeApplyLinksDropdown(e) {
            const dropdown = document.getElementById('applyLinksDropdown');
            if (!e.target.closest('.dropdown')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeApplyLinksDropdown);
            }
        }
        
        function copyBrandLink(brand) {
            let link = window.location.origin + '/apply.html';
            if (brand) {
                link += '?brand=' + brand;
            }
            
            navigator.clipboard.writeText(link).then(() => {
                const brandName = brand ? (BRAND_DISPLAY[brand] || brand) : 'Generic';
                showToast(`${brandName} link copied!`, 'success');
                document.getElementById('applyLinksDropdown').style.display = 'none';
            }).catch(() => {
                showToast('Failed to copy link', 'error');
            });
        }
        
        async function loadPendingAppsCount() {
            try {
                const { data, error } = await supabaseClient
                    .from('creator_applications')
                    .select('id')
                    .eq('status', 'pending');
                if (!error && data) {
                    const pending = data.length;
                    const badge = document.getElementById('pendingAppsBadge');
                    if (badge) {
                        badge.textContent = pending;
                        badge.style.display = pending > 0 ? 'inline-block' : 'none';
                    }
                }
            } catch (err) {
                console.error('Error loading pending apps count:', err);
            }
        }

        // Update loadViewData to include new views
        const originalLoadViewData = loadViewData;
        window.loadViewData = function() {
            switch(currentView) {
                case 'payments': loadPaymentsData(); return;
                case 'activity': loadActivityData(); return;
                case 'users': loadUsersData(); return;
                case 'applications': loadApplicationsData(); return;
                case 'datastatus': loadDataHealth(); return;
            }
            originalLoadViewData();
        };

        // Load freshness on init
        const originalInit = init;
        window.init = async function() {
            await originalInit();
            loadBrandFreshness();
            // Load pending counts for badges
            loadPendingUsersCount();
            loadPendingAppsCount();
        };
        
        async function loadPendingUsersCount() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('id, status')
                    .or('status.is.null,status.eq.pending');
                if (!error && data) {
                    const pending = data.length;
                    const badge = document.getElementById('pendingUsersBadge');
                    if (badge) {
                        badge.textContent = pending;
                        badge.style.display = pending > 0 ? 'inline-block' : 'none';
                    }
                }
            } catch (err) {
                console.error('Error loading pending count:', err);
            }
        }

        // ==================== PORTAL CONFIG ====================
        
        function switchConfigTab(tab) {
            // Update buttons
            document.querySelectorAll('#view-portalconfig .period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            // Show/hide tabs
            document.querySelectorAll('.config-tab').forEach(t => t.style.display = 'none');
            document.getElementById(`config${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
            
            // Load data for tab
            if (tab === 'campaigns') loadCampaigns();
            if (tab === 'faq') loadFaqItems();
            if (tab === 'resources') loadResources();
        }
        
        // ========== CAMPAIGNS ==========
        
        async function loadCampaigns() {
            const tbody = document.getElementById('campaignsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Loading...</td></tr>';
            
            const { data, error } = await supabaseClient
                .from('brand_campaigns')
                .select('*')
                .order('display_order', { ascending: true });
            
            if (error) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--danger);">
                    Error loading campaigns. Table may not exist yet.<br>
                    <button class="btn btn-sm" style="margin-top: 8px;" onclick="window.open('sql/brand_campaigns.sql', '_blank')">View SQL Migration</button>
                </td></tr>`;
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">No campaigns found. Add your first campaign!</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(c => `
                <tr>
                    <td style="text-align: center; font-size: 1.5rem;">${c.icon || ''}</td>
                    <td><code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">${c.brand}</code></td>
                    <td><strong>${c.name}</strong><br><span style="font-size: 0.8rem; color: var(--text-muted);">${c.description || ''}</span></td>
                    <td>${c.commission_text || '-'}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${c.discord_url ? `<a href="${c.discord_url}" target="_blank" style="color: var(--accent);"> Link</a>` : '-'}
                    </td>
                    <td style="text-align: center;">
                        ${c.active 
                            ? '<span style="color: var(--success);"> Active</span>' 
                            : '<span style="color: var(--text-muted);">Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="editCampaign('${c.id}')"></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCampaign('${c.id}', '${c.name}')"></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openAddCampaignModal() {
            document.getElementById('campaignModalTitle').textContent = 'Add Campaign';
            document.getElementById('campaignForm').reset();
            document.getElementById('campaignId').value = '';
            document.getElementById('campaignActive').checked = true;
            document.getElementById('campaignColor').value = '#3b82f6';
            document.getElementById('campaignModal').style.display = 'flex';
        }
        
        async function editCampaign(id) {
            const { data, error } = await supabaseClient
                .from('brand_campaigns')
                .select('*')
                .eq('id', id)
                .single();
            
            if (error || !data) {
                showToast('Failed to load campaign', 'error');
                return;
            }
            
            document.getElementById('campaignModalTitle').textContent = 'Edit Campaign';
            document.getElementById('campaignId').value = data.id;
            document.getElementById('campaignBrand').value = data.brand || '';
            document.getElementById('campaignName').value = data.name || '';
            document.getElementById('campaignDescription').value = data.description || '';
            document.getElementById('campaignCommission').value = data.commission_text || '';
            document.getElementById('campaignIcon').value = data.icon || '';
            document.getElementById('campaignColor').value = data.color || '#3b82f6';
            document.getElementById('campaignApplyUrl').value = data.apply_url || '';
            document.getElementById('campaignDiscordUrl').value = data.discord_url || '';
            document.getElementById('campaignOrder').value = data.display_order || 0;
            document.getElementById('campaignActive').checked = data.active !== false;
            document.getElementById('campaignModal').style.display = 'flex';
        }
        
        function closeCampaignModal() {
            document.getElementById('campaignModal').style.display = 'none';
        }
        
        async function saveCampaign(event) {
            event.preventDefault();
            
            const id = document.getElementById('campaignId').value;
            const campaignData = {
                brand: document.getElementById('campaignBrand').value.trim().toLowerCase(),
                name: document.getElementById('campaignName').value.trim(),
                description: document.getElementById('campaignDescription').value.trim(),
                commission_text: document.getElementById('campaignCommission').value.trim(),
                icon: document.getElementById('campaignIcon').value.trim() || '',
                color: document.getElementById('campaignColor').value,
                apply_url: document.getElementById('campaignApplyUrl').value.trim() || `apply.html?brand=${document.getElementById('campaignBrand').value.trim().toLowerCase()}`,
                discord_url: document.getElementById('campaignDiscordUrl').value.trim(),
                display_order: parseInt(document.getElementById('campaignOrder').value) || 0,
                active: document.getElementById('campaignActive').checked,
                updated_at: new Date().toISOString()
            };
            
            let error;
            if (id) {
                ({ error } = await supabaseClient.from('brand_campaigns').update(campaignData).eq('id', id));
            } else {
                ({ error } = await supabaseClient.from('brand_campaigns').insert(campaignData));
            }
            
            if (error) {
                showToast('Failed to save campaign: ' + error.message, 'error');
                return;
            }
            
            showToast('Campaign saved!', 'success');
            closeCampaignModal();
            loadCampaigns();
        }
        
        async function deleteCampaign(id, name) {
            if (!confirm(`Delete campaign "${name}"? This cannot be undone.`)) return;
            
            const { error } = await supabaseClient.from('brand_campaigns').delete().eq('id', id);
            
            if (error) {
                showToast('Failed to delete campaign', 'error');
                return;
            }
            
            showToast('Campaign deleted', 'success');
            loadCampaigns();
        }
        
        // ========== FAQ ==========
        
        async function loadFaqItems() {
            const container = document.getElementById('faqItemsList');
            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
            
            const { data, error } = await supabaseClient
                .from('portal_faq')
                .select('*')
                .order('display_order', { ascending: true });
            
            if (error) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--danger);">
                    Error loading FAQ. Table may not exist yet.<br>
                    <button class="btn btn-sm" style="margin-top: 8px;" onclick="window.open('sql/brand_campaigns.sql', '_blank')">View SQL Migration</button>
                </div>`;
                return;
            }
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No FAQ items found. Add your first question!</div>';
                return;
            }
            
            container.innerHTML = data.map(f => `
                <div style="display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; align-items: flex-start;">
                    <div style="font-size: 1.5rem;">${f.icon || ''}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${f.question}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">${f.answer}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">
                            Order: ${f.display_order || 0}  ${f.active ? '<span style="color: var(--success);">Active</span>' : '<span style="color: var(--text-muted);">Inactive</span>'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 4px;">
                        <button class="btn btn-sm" onclick="editFaq('${f.id}')"></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFaq('${f.id}')"></button>
                    </div>
                </div>
            `).join('');
        }
        
        function openAddFaqModal() {
            document.getElementById('faqModalTitle').textContent = 'Add FAQ';
            document.getElementById('faqForm').reset();
            document.getElementById('faqId').value = '';
            document.getElementById('faqActive').checked = true;
            document.getElementById('faqModal').style.display = 'flex';
        }
        
        async function editFaq(id) {
            const { data, error } = await supabaseClient
                .from('portal_faq')
                .select('*')
                .eq('id', id)
                .single();
            
            if (error || !data) {
                showToast('Failed to load FAQ', 'error');
                return;
            }
            
            document.getElementById('faqModalTitle').textContent = 'Edit FAQ';
            document.getElementById('faqId').value = data.id;
            document.getElementById('faqIcon').value = data.icon || '';
            document.getElementById('faqQuestion').value = data.question || '';
            document.getElementById('faqAnswer').value = data.answer || '';
            document.getElementById('faqOrder').value = data.display_order || 0;
            document.getElementById('faqActive').checked = data.active !== false;
            document.getElementById('faqModal').style.display = 'flex';
        }
        
        function closeFaqModal() {
            document.getElementById('faqModal').style.display = 'none';
        }
        
        async function saveFaq(event) {
            event.preventDefault();
            
            const id = document.getElementById('faqId').value;
            const faqData = {
                icon: document.getElementById('faqIcon').value.trim() || '',
                question: document.getElementById('faqQuestion').value.trim(),
                answer: document.getElementById('faqAnswer').value.trim(),
                display_order: parseInt(document.getElementById('faqOrder').value) || 0,
                active: document.getElementById('faqActive').checked,
                updated_at: new Date().toISOString()
            };
            
            let error;
            if (id) {
                ({ error } = await supabaseClient.from('portal_faq').update(faqData).eq('id', id));
            } else {
                ({ error } = await supabaseClient.from('portal_faq').insert(faqData));
            }
            
            if (error) {
                showToast('Failed to save FAQ: ' + error.message, 'error');
                return;
            }
            
            showToast('FAQ saved!', 'success');
            closeFaqModal();
            loadFaqItems();
        }
        
        async function deleteFaq(id) {
            if (!confirm('Delete this FAQ item?')) return;
            
            const { error } = await supabaseClient.from('portal_faq').delete().eq('id', id);
            
            if (error) {
                showToast('Failed to delete FAQ', 'error');
                return;
            }
            
            showToast('FAQ deleted', 'success');
            loadFaqItems();
        }
        
        // ========== RESOURCES ==========
        
        async function loadResources() {
            const container = document.getElementById('resourcesList');
            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
            
            const { data, error } = await supabaseClient
                .from('portal_resources')
                .select('*')
                .order('display_order', { ascending: true });
            
            if (error) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--danger);">
                    Error loading resources. Table may not exist yet.<br>
                    <button class="btn btn-sm" style="margin-top: 8px;" onclick="window.open('sql/brand_campaigns.sql', '_blank')">View SQL Migration</button>
                </div>`;
                return;
            }
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No resources found. Add your first resource!</div>';
                return;
            }
            
            const fileTypeIcons = { pdf: '', doc: '', image: '', video: '', other: '' };
            
            container.innerHTML = data.map(r => `
                <div style="display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; align-items: center;">
                    <div style="font-size: 1.5rem;">${r.icon || fileTypeIcons[r.file_type] || ''}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${r.title}</div>
                        ${r.description ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">${r.description}</div>` : ''}
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                            ${r.file_type?.toUpperCase() || 'FILE'}  ${r.brand || 'All Brands'}  ${r.active ? '<span style="color: var(--success);">Active</span>' : '<span style="color: var(--text-muted);">Inactive</span>'}
                        </div>
                    </div>
                    <a href="${r.file_url}" target="_blank" class="btn btn-sm"> View</a>
                    <button class="btn btn-sm" onclick="editResource('${r.id}')"></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteResource('${r.id}')"></button>
                </div>
            `).join('');
        }
        
        function openAddResourceModal() {
            document.getElementById('resourceModalTitle').textContent = 'Add Resource';
            document.getElementById('resourceForm').reset();
            document.getElementById('resourceId').value = '';
            document.getElementById('resourceActive').checked = true;
            document.getElementById('resourceModal').style.display = 'flex';
        }
        
        async function editResource(id) {
            const { data, error } = await supabaseClient
                .from('portal_resources')
                .select('*')
                .eq('id', id)
                .single();
            
            if (error || !data) {
                showToast('Failed to load resource', 'error');
                return;
            }
            
            document.getElementById('resourceModalTitle').textContent = 'Edit Resource';
            document.getElementById('resourceId').value = data.id;
            document.getElementById('resourceTitle').value = data.title || '';
            document.getElementById('resourceDescription').value = data.description || '';
            document.getElementById('resourceFileUrl').value = data.file_url || '';
            document.getElementById('resourceIcon').value = data.icon || '';
            document.getElementById('resourceFileType').value = data.file_type || 'pdf';
            document.getElementById('resourceBrand').value = data.brand || '';
            document.getElementById('resourceOrder').value = data.display_order || 0;
            document.getElementById('resourceActive').checked = data.active !== false;
            document.getElementById('resourceModal').style.display = 'flex';
        }
        
        function closeResourceModal() {
            document.getElementById('resourceModal').style.display = 'none';
        }
        
        async function saveResource(event) {
            event.preventDefault();
            
            const id = document.getElementById('resourceId').value;
            const resourceData = {
                title: document.getElementById('resourceTitle').value.trim(),
                description: document.getElementById('resourceDescription').value.trim(),
                file_url: document.getElementById('resourceFileUrl').value.trim(),
                icon: document.getElementById('resourceIcon').value.trim() || '',
                file_type: document.getElementById('resourceFileType').value,
                brand: document.getElementById('resourceBrand').value || null,
                display_order: parseInt(document.getElementById('resourceOrder').value) || 0,
                active: document.getElementById('resourceActive').checked,
                updated_at: new Date().toISOString()
            };
            
            let error;
            if (id) {
                ({ error } = await supabaseClient.from('portal_resources').update(resourceData).eq('id', id));
            } else {
                ({ error } = await supabaseClient.from('portal_resources').insert(resourceData));
            }
            
            if (error) {
                showToast('Failed to save resource: ' + error.message, 'error');
                return;
            }
            
            showToast('Resource saved!', 'success');
            closeResourceModal();
            loadResources();
        }
        
        async function deleteResource(id) {
            if (!confirm('Delete this resource?')) return;
            
            const { error } = await supabaseClient.from('portal_resources').delete().eq('id', id);
            
            if (error) {
                showToast('Failed to delete resource', 'error');
                return;
            }
            
            showToast('Resource deleted', 'success');
            loadResources();
        }

        // ==================== APPLICATION FUNNEL BUILDER ====================
        
        let currentFunnel = {
            id: null,
            name: '',
            slug: '',
            brand: null,
            status: 'draft',
            steps: [
                { id: 'step1', title: 'Your Info', icon: '' },
                { id: 'step2', title: 'TikTok Profile', icon: '' },
                { id: 'step3', title: 'Application', icon: '' }
            ],
            fields: [],
            settings: {
                header_title: 'Apply to Join Our Creator Network',
                header_subtitle: 'Partner with top brands and earn commissions',
                primary_color: '#f5c518',
                success_title: 'Application Received! ',
                success_message: 'We\'ll review your application and get back to you within 48 hours.'
            }
        };
        
        async function loadFunnelsData() {
            try {
                const { data, error } = await supabaseClient
                    .from('application_funnels')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                renderFunnelsGrid(data || []);
            } catch (err) {
                console.error('Error loading funnels:', err);
                document.getElementById('funnelsTableBody').innerHTML = `
                    <tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        Failed to load funnels. <button class="btn btn-sm" onclick="loadFunnelsData()">Retry</button>
                    </td></tr>`;
            }
        }
        
        function renderFunnelsGrid(funnels) {
            const grid = document.getElementById('funnelsGrid');
            if (!funnels || funnels.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <div style="font-size: 4rem; margin-bottom: 16px;"></div>
                        <h3 style="font-size: 1.25rem; margin-bottom: 8px;">No Funnels Yet</h3>
                        <p style="color: var(--text-muted); margin-bottom: 24px;">Create your first application funnel to start collecting creator applications</p>
                        <button class="btn btn-primary" onclick="openFunnelBuilder()"> Create Your First Funnel</button>
                    </div>`;
                return;
            }
            
            const statusBadge = (status) => {
                const styles = { 
                    active: 'background: var(--success-dim); color: var(--success);', 
                    draft: 'background: var(--warning-dim); color: var(--warning);', 
                    archived: 'background: var(--bg-secondary); color: var(--text-muted);' 
                };
                const labels = { active: 'Active', draft: 'Draft', archived: 'Archived' };
                return `<span style="padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; ${styles[status] || styles.draft}">${labels[status] || status}</span>`;
            };
            
            grid.innerHTML = `
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Funnel</th>
                            <th style="width: 15%;">Brand</th>
                            <th style="width: 10%; text-align: center;">Status</th>
                            <th style="width: 8%; text-align: right;">Views</th>
                            <th style="width: 8%; text-align: right;">Applies</th>
                            <th style="width: 8%; text-align: right;">Rate</th>
                            <th style="width: 21%; text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${funnels.map(f => {
                            const conversion = f.views > 0 ? ((f.submissions / f.views) * 100).toFixed(1) : '0.0';
                            const brandName = f.brand ? (BRAND_DISPLAY[f.brand] || f.brand) : '';
                            const link = `${window.location.origin}/apply.html?funnel=${f.slug}`;
                            
                            return `
                                <tr>
                                    <td>
                                        <div style="font-weight: 600;">${f.name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">/apply.html?funnel=${f.slug}</div>
                                    </td>
                                    <td>${brandName}</td>
                                    <td style="text-align: center;">${statusBadge(f.status)}</td>
                                    <td style="text-align: right; font-weight: 500;">${(f.views || 0).toLocaleString()}</td>
                                    <td style="text-align: right; font-weight: 500;">${(f.submissions || 0).toLocaleString()}</td>
                                    <td style="text-align: right; font-weight: 500; color: ${parseFloat(conversion) > 5 ? 'var(--success)' : 'var(--text-secondary)'};">${conversion}%</td>
                                    <td style="text-align: right;">
                                        <div style="display: flex; gap: 4px; justify-content: flex-end;">
                                            <button class="btn btn-sm" onclick="editFunnel('${f.id}')" title="Edit"></button>
                                            <button class="btn btn-sm" onclick="copyFunnelLink('${f.slug}')" title="Copy Link"></button>
                                            <button class="btn btn-sm" onclick="window.open('${link}', '_blank')" title="Preview"></button>
                                            <button class="btn btn-sm" onclick="duplicateFunnel('${f.id}')" title="Duplicate"></button>
                                            <button class="btn btn-sm" onclick="deleteFunnel('${f.id}')" title="Delete" style="color: var(--danger);"></button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function copyFunnelLink(slug) {
            const link = `${window.location.origin}/apply.html?funnel=${slug}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Link copied!', 'success');
            });
        }
        
        function openFunnelBuilder(funnelId = null) {
            // Reset to default if creating new
            if (!funnelId) {
                currentFunnel = {
                    id: null,
                    name: '',
                    slug: '',
                    brand: null,
                    status: 'draft',
                    steps: [
                        { id: 'step1', title: 'Your Info', icon: '' },
                        { id: 'step2', title: 'TikTok Profile', icon: '' },
                        { id: 'step3', title: 'Application', icon: '' }
                    ],
                    fields: [
                        { id: 'full_name', type: 'text', label: 'Full Name', required: true, step: 'step1', placeholder: 'Your full name', width: 'full' },
                        { id: 'email', type: 'email', label: 'Email', required: true, step: 'step1', placeholder: 'you@email.com', width: 'half' },
                        { id: 'discord_name', type: 'text', label: 'Discord Username', required: true, step: 'step1', placeholder: 'username', width: 'half' },
                        { id: 'tiktok_handle', type: 'text', label: 'TikTok Handle', required: true, step: 'step2', placeholder: '@yourusername', width: 'full' },
                        { id: 'follower_count', type: 'select', label: 'Follower Count', required: true, step: 'step2', width: 'half', options: [
                            { value: '0-1k', label: '0 - 1,000' },
                            { value: '1k-5k', label: '1,000 - 5,000' },
                            { value: '5k-10k', label: '5,000 - 10,000' },
                            { value: '10k-50k', label: '10,000 - 50,000' },
                            { value: '50k+', label: '50,000+' }
                        ]},
                        { id: 'brand', type: 'select', label: 'Which brand?', required: true, step: 'step3', width: 'full', options: [
                            { value: 'catakor', label: 'Cata-Kor' },
                            { value: 'jiyu', label: 'JiYu' },
                            { value: 'physicians_choice', label: 'Physicians Choice' },
                            { value: 'peach_slices', label: 'Peach Slices' },
                            { value: 'yerba_magic', label: 'Yerba Magic' }
                        ]}
                    ],
                    settings: {
                        header_title: 'Apply to Join Our Creator Network',
                        header_subtitle: 'Partner with top brands and earn commissions',
                        primary_color: '#f5c518',
                        success_title: 'Application Received! ',
                        success_message: 'We\'ll review your application and get back to you within 48 hours.'
                    }
                };
                document.getElementById('funnelBuilderTitle').textContent = 'Create Application Funnel';
            }
            
            populateFunnelBuilder();
            document.getElementById('funnelBuilderModal').classList.add('show');
        }
        
        function closeFunnelBuilder() {
            document.getElementById('funnelBuilderModal').classList.remove('show');
        }
        
        async function editFunnel(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('application_funnels')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                currentFunnel = {
                    id: data.id,
                    name: data.name,
                    slug: data.slug,
                    brand: data.brand,
                    status: data.status,
                    steps: data.steps || [],
                    fields: data.fields || [],
                    settings: data.settings || {}
                };
                
                document.getElementById('funnelBuilderTitle').textContent = 'Edit Funnel: ' + data.name;
                populateFunnelBuilder();
                document.getElementById('funnelBuilderModal').classList.add('show');
            } catch (err) {
                console.error('Error loading funnel:', err);
                showToast('Failed to load funnel', 'error');
            }
        }
        
        async function duplicateFunnel(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('application_funnels')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                const newFunnel = {
                    name: data.name + ' (Copy)',
                    slug: data.slug + '-copy-' + Date.now(),
                    brand: data.brand,
                    status: 'draft',
                    steps: data.steps,
                    fields: data.fields,
                    settings: data.settings
                };
                
                const { error: insertError } = await supabaseClient
                    .from('application_funnels')
                    .insert([newFunnel]);
                
                if (insertError) throw insertError;
                
                showToast('Funnel duplicated!', 'success');
                loadFunnelsData();
            } catch (err) {
                console.error('Error duplicating funnel:', err);
                showToast('Failed to duplicate funnel', 'error');
            }
        }
        
        async function deleteFunnel(id) {
            if (!confirm('Are you sure you want to delete this funnel?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('application_funnels')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showToast('Funnel deleted', 'success');
                loadFunnelsData();
            } catch (err) {
                console.error('Error deleting funnel:', err);
                showToast('Failed to delete funnel', 'error');
            }
        }
        
        function populateFunnelBuilder() {
            // Initialize active step
            currentFunnel.activeStep = currentFunnel.steps[0]?.id || 'step1';
            
            // Basic info
            document.getElementById('funnelName').value = currentFunnel.name || '';
            document.getElementById('funnelSlug').value = currentFunnel.slug || '';
            document.getElementById('funnelBrand').value = currentFunnel.brand || '';
            document.getElementById('funnelStatus').value = currentFunnel.status || 'draft';
            
            // Branding
            const settings = currentFunnel.settings || {};
            document.getElementById('funnelPrimaryColor').value = settings.primary_color || '#f5c518';
            document.getElementById('funnelPrimaryColorText').value = settings.primary_color || '#f5c518';
            document.getElementById('funnelHeaderTitle').value = settings.header_title || '';
            document.getElementById('funnelHeaderSubtitle').value = settings.header_subtitle || '';
            document.getElementById('funnelLogoUrl').value = settings.logo_url || '';
            document.getElementById('funnelWelcomeVideo').value = settings.welcome_video_url || '';
            
            // Settings
            document.getElementById('funnelSuccessTitle').value = settings.success_title || '';
            document.getElementById('funnelSuccessMessage').value = settings.success_message || '';
            document.getElementById('funnelThankYouVideo').value = settings.thank_you_video_url || '';
            document.getElementById('funnelDiscordOAuth').checked = settings.discord_oauth_enabled || false;
            document.getElementById('funnelDiscordClientId').value = settings.discord_client_id || '';
            document.getElementById('funnelDiscordLink').value = settings.discord_server_link || '';
            
            // Toggle Discord settings visibility
            toggleDiscordSettings();
            
            // Render fields and steps
            renderStepsTabs();
            renderFieldsList();
            updateFunnelPreview();
        }
        
        function toggleDiscordSettings() {
            const enabled = document.getElementById('funnelDiscordOAuth').checked;
            document.getElementById('discordOAuthSettings').style.display = enabled ? 'block' : 'none';
        }
        
        function copyDiscordRedirect() {
            const input = document.getElementById('funnelDiscordRedirect');
            input.select();
            document.execCommand('copy');
            showToast('Redirect URI copied!', 'success');
        }
        
        function renderFieldsList() {
            const container = document.getElementById('fieldsList');
            const activeStep = currentFunnel.activeStep || (currentFunnel.steps[0]?.id);
            const fieldsInStep = currentFunnel.fields.filter(f => f.step === activeStep);
            
            const fieldIcons = {
                'text': 'Aa',
                'email': '',
                'tel': '',
                'tiktok': '',
                'select': '',
                'textarea': '',
                'number': '#',
                'url': '',
                'checkbox': ''
            };
            
            if (fieldsInStep.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = fieldsInStep.map((field, idx) => {
                const globalIdx = currentFunnel.fields.findIndex(f => f.id === field.id);
                const icon = fieldIcons[field.type] || '';
                return `
                    <div class="field-item-new" draggable="true" data-idx="${globalIdx}" data-field-id="${field.id}" 
                         ondragstart="dragFieldReorder(event)" ondragover="allowDropReorder(event)" ondrop="dropFieldReorder(event)">
                        <div class="field-icon">${icon}</div>
                        <div class="field-info">
                            <div class="field-label-new">
                                ${field.label}
                                ${field.required ? '<span class="required-badge">Required</span>' : ''}
                            </div>
                            <div class="field-meta-new">${field.type}${field.placeholder ? '  ' + field.placeholder : ''}</div>
                        </div>
                        <div class="field-actions-new">
                            <button onclick="editField(${globalIdx})" title="Edit"></button>
                            <button onclick="deleteField(${globalIdx})" title="Delete" style="color: var(--danger);"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderStepsTabs() {
            const container = document.getElementById('stepsTabs');
            const activeStep = currentFunnel.activeStep || (currentFunnel.steps[0]?.id);
            
            container.innerHTML = currentFunnel.steps.map((step, idx) => {
                const fieldCount = currentFunnel.fields.filter(f => f.step === step.id).length;
                const isActive = step.id === activeStep;
                const canDelete = currentFunnel.steps.length > 1;
                return `
                    <div class="step-tab ${isActive ? 'active' : ''}" style="position: relative;">
                        <div onclick="switchToStep('${step.id}')" style="display: flex; align-items: center; gap: 6px; flex: 1;">
                            <span>${step.icon}</span>
                            <span>${step.title}</span>
                            <span style="opacity: 0.6; font-size: 0.75rem;">(${fieldCount})</span>
                        </div>
                        ${canDelete ? `<button onclick="event.stopPropagation(); deleteStep(${idx})" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 2px 6px; font-size: 0.8rem; opacity: 0.6; transition: all 0.2s;" onmouseover="this.style.opacity=1; this.style.color='var(--danger)';" onmouseout="this.style.opacity=0.6; this.style.color='var(--text-muted)';"></button>` : ''}
                    </div>
                `;
            }).join('') + `
                <div class="step-tab" onclick="addStep()" style="border-style: dashed; color: var(--text-muted);">
                    + Add Step
                </div>
            `;
        }
        
        function switchToStep(stepId) {
            currentFunnel.activeStep = stepId;
            renderStepsTabs();
            renderFieldsList();
            updateFunnelPreview();
        }
        
        function renderStepsList() {
            // For backwards compatibility, render both formats
            renderStepsTabs();
            
            const container = document.getElementById('stepsList');
            if (!container) return;
            
            container.innerHTML = currentFunnel.steps.map((step, idx) => {
                const fieldCount = currentFunnel.fields.filter(f => f.step === step.id).length;
                return `
                    <div class="step-item" draggable="true" data-idx="${idx}">
                        <span class="drag-handle"></span>
                        <span style="font-size: 1.25rem;">${step.icon}</span>
                        <div style="flex: 1;">
                            <input type="text" value="${step.title}" class="form-input" style="padding: 6px 10px; font-size: 0.9rem;"
                                   onchange="updateStepTitle(${idx}, this.value)">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">${fieldCount} fields</div>
                        </div>
                        <button onclick="deleteStep(${idx})" style="background: none; border: none; cursor: pointer; color: var(--danger);"></button>
                    </div>
                `;
            }).join('');
        }
        
        // Settings section toggle
        function toggleSettingsSection(section) {
            const content = document.getElementById(`settingsSection-${section}`);
            const isOpen = content.classList.contains('show');
            
            // Close all sections
            document.querySelectorAll('.settings-section-content').forEach(c => c.classList.remove('show'));
            document.querySelectorAll('.settings-toggle').forEach(t => t.textContent = '');
            
            // Toggle this one
            if (!isOpen) {
                content.classList.add('show');
                content.previousElementSibling.querySelector('.settings-toggle').textContent = '';
            }
        }
        
        // Auto-generate slug from name
        function autoGenerateSlug() {
            const name = document.getElementById('funnelName').value;
            const slug = name.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
            document.getElementById('funnelSlug').value = slug;
        }
        
        // Drag and drop for adding new fields from palette
        let draggedFieldType = null;
        
        function dragFieldStart(event, type) {
            draggedFieldType = type;
            event.dataTransfer.setData('text/plain', type);
            event.dataTransfer.effectAllowed = 'copy';
        }
        
        function dragOverField(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
            document.getElementById('fieldsDropZone').classList.add('drag-over');
        }
        
        function dragLeaveField(event) {
            document.getElementById('fieldsDropZone').classList.remove('drag-over');
        }
        
        function dropField(event) {
            event.preventDefault();
            document.getElementById('fieldsDropZone').classList.remove('drag-over');
            
            if (draggedFieldType) {
                addFieldOfType(draggedFieldType);
                draggedFieldType = null;
            }
        }
        
        // Drag and drop for reordering fields
        let draggedFieldIdx = null;
        
        function dragFieldReorder(event) {
            draggedFieldIdx = parseInt(event.target.closest('.field-item-new').dataset.idx);
            event.dataTransfer.setData('text/plain', draggedFieldIdx);
            event.dataTransfer.effectAllowed = 'move';
            event.target.closest('.field-item-new').classList.add('dragging');
        }
        
        function allowDropReorder(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function dropFieldReorder(event) {
            event.preventDefault();
            const targetIdx = parseInt(event.target.closest('.field-item-new').dataset.idx);
            
            if (draggedFieldIdx !== null && draggedFieldIdx !== targetIdx) {
                // Reorder fields
                const field = currentFunnel.fields.splice(draggedFieldIdx, 1)[0];
                currentFunnel.fields.splice(targetIdx, 0, field);
                renderFieldsList();
                updateFunnelPreview();
            }
            
            document.querySelectorAll('.field-item-new').forEach(el => el.classList.remove('dragging'));
            draggedFieldIdx = null;
        }
        
        // Preview device switching
        function setPreviewDevice(device) {
            document.querySelectorAll('.preview-device-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.preview-device-btn[onclick*="${device}"]`).classList.add('active');
            
            const preview = document.getElementById('funnelPreview');
            preview.className = device === 'mobile' ? 'preview-mobile' : 'preview-desktop';
        }
        
        function switchFunnelTab(tab) {
            document.querySelectorAll('.funnel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.funnel-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.funnel-tab[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(`funnelTab-${tab}`)?.classList.add('active');
        }
        
        function addFieldOfType(type) {
            const id = 'field_' + Date.now();
            const labels = {
                text: 'Text Field',
                email: 'Email',
                tel: 'Phone',
                tiktok: 'TikTok Handle',
                url: 'URL',
                number: 'Number',
                select: 'Dropdown',
                textarea: 'Text Area',
                checkbox: 'Checkbox'
            };
            
            const placeholders = {
                text: 'Enter text...',
                email: 'you@email.com',
                tel: '(555) 123-4567',
                tiktok: '@username',
                url: 'https://...',
                number: '0',
                textarea: 'Tell us more...'
            };
            
            const activeStep = currentFunnel.activeStep || currentFunnel.steps[0]?.id || 'step1';
            
            currentFunnel.fields.push({
                id: id,
                type: type,
                label: labels[type] || 'New Field',
                placeholder: placeholders[type] || '',
                required: false,
                step: activeStep,
                placeholder: '',
                width: 'full',
                options: type === 'select' ? [{ value: 'option1', label: 'Option 1' }] : undefined
            });
            
            renderFieldsList();
            updateFunnelPreview();
            
            // Open editor for the new field
            editField(currentFunnel.fields.length - 1);
        }
        
        function addField() {
            addFieldOfType('text');
        }
        
        function editField(idx) {
            const field = currentFunnel.fields[idx];
            if (!field) return;
            
            document.getElementById('editingFieldId').value = idx;
            document.getElementById('fieldLabel').value = field.label || '';
            document.getElementById('fieldId').value = field.id || '';
            document.getElementById('fieldType').value = field.type || 'text';
            document.getElementById('fieldPlaceholder').value = field.placeholder || '';
            document.getElementById('fieldWidth').value = field.width || 'full';
            document.getElementById('fieldRequired').checked = field.required || false;
            
            // Populate step dropdown
            const stepSelect = document.getElementById('fieldStep');
            stepSelect.innerHTML = currentFunnel.steps.map(s => 
                `<option value="${s.id}" ${field.step === s.id ? 'selected' : ''}>${s.icon} ${s.title}</option>`
            ).join('');
            
            // Options for select
            if (field.type === 'select' && field.options) {
                document.getElementById('fieldOptions').value = field.options.map(o => `${o.value}|${o.label}`).join('\n');
            } else {
                document.getElementById('fieldOptions').value = '';
            }
            
            toggleFieldOptions();
            document.getElementById('fieldEditorModal').classList.add('show');
        }
        
        function toggleFieldOptions() {
            const type = document.getElementById('fieldType').value;
            document.getElementById('fieldOptionsGroup').style.display = type === 'select' ? 'block' : 'none';
        }
        
        function closeFieldEditor() {
            document.getElementById('fieldEditorModal').classList.remove('show');
        }
        
        function saveFieldEdit() {
            const idx = parseInt(document.getElementById('editingFieldId').value);
            const field = currentFunnel.fields[idx];
            if (!field) return;
            
            field.label = document.getElementById('fieldLabel').value;
            field.id = document.getElementById('fieldId').value || 'field_' + Date.now();
            field.type = document.getElementById('fieldType').value;
            field.placeholder = document.getElementById('fieldPlaceholder').value;
            field.step = document.getElementById('fieldStep').value;
            field.width = document.getElementById('fieldWidth').value;
            field.required = document.getElementById('fieldRequired').checked;
            
            if (field.type === 'select') {
                const optionsText = document.getElementById('fieldOptions').value;
                field.options = optionsText.split('\n').filter(l => l.trim()).map(line => {
                    const [value, label] = line.split('|');
                    return { value: value?.trim() || '', label: label?.trim() || value?.trim() || '' };
                });
            }
            
            closeFieldEditor();
            renderFieldsList();
            updateFunnelPreview();
        }
        
        function deleteField(idx) {
            currentFunnel.fields.splice(idx, 1);
            renderFieldsList();
            updateFunnelPreview();
        }
        
        function addStep() {
            const id = 'step_' + Date.now();
            const icons = ['', '', '', '', '', '', '', ''];
            const icon = icons[currentFunnel.steps.length % icons.length];
            
            currentFunnel.steps.push({
                id: id,
                title: 'Step ' + (currentFunnel.steps.length + 1),
                icon: icon
            });
            
            // Switch to the new step
            currentFunnel.activeStep = id;
            renderStepsTabs();
            renderFieldsList();
            updateFunnelPreview();
        }
        
        function updateStepTitle(idx, title) {
            if (currentFunnel.steps[idx]) {
                currentFunnel.steps[idx].title = title;
                renderStepsTabs();
                updateFunnelPreview();
            }
        }
        
        function deleteStep(idx) {
            if (currentFunnel.steps.length <= 1) {
                showToast('Must have at least one step', 'error');
                return;
            }
            const stepId = currentFunnel.steps[idx].id;
            // Move fields from this step to the first remaining step
            const remainingSteps = currentFunnel.steps.filter((_, i) => i !== idx);
            currentFunnel.fields.forEach(f => {
                if (f.step === stepId) f.step = remainingSteps[0].id;
            });
            currentFunnel.steps.splice(idx, 1);
            
            // Update active step if needed
            if (currentFunnel.activeStep === stepId) {
                currentFunnel.activeStep = currentFunnel.steps[0].id;
            }
            
            renderStepsTabs();
            renderFieldsList();
            updateFunnelPreview();
        }
        
        function updateFunnelPreview() {
            const settings = currentFunnel.settings || {};
            const primaryColor = document.getElementById('funnelPrimaryColor')?.value || settings.primary_color || '#f5c518';
            const headerTitle = document.getElementById('funnelHeaderTitle')?.value || settings.header_title || 'Apply to Join';
            const headerSubtitle = document.getElementById('funnelHeaderSubtitle')?.value || settings.header_subtitle || '';
            const logoUrl = document.getElementById('funnelLogoUrl')?.value || settings.logo_url || '';
            
            const activeStep = currentFunnel.activeStep || currentFunnel.steps[0]?.id;
            const activeStepIdx = currentFunnel.steps.findIndex(s => s.id === activeStep);
            const stepFields = currentFunnel.fields.filter(f => f.step === activeStep);
            
            const preview = document.getElementById('funnelPreview');
            preview.innerHTML = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        ${logoUrl ? `<img src="${logoUrl}" style="height: 40px; margin-bottom: 12px;">` : ''}
                        <h2 style="color: ${primaryColor}; font-size: 1.25rem; margin: 0 0 6px 0;">${headerTitle}</h2>
                        ${headerSubtitle ? `<p style="color: #888; font-size: 0.85rem; margin: 0;">${headerSubtitle}</p>` : ''}
                    </div>
                    
                    <!-- Steps Progress -->
                    ${currentFunnel.steps.length > 1 ? `
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            ${currentFunnel.steps.map((s, i) => `
                                <div style="flex: 1; text-align: center; padding: 8px 4px; border-radius: 6px; font-size: 0.75rem;
                                    ${i === activeStepIdx ? `background: ${primaryColor}; color: #000; font-weight: 600;` : 
                                      i < activeStepIdx ? `background: ${primaryColor}40; color: ${primaryColor};` : 
                                      'background: #222; color: #666;'}">
                                    ${s.icon} ${s.title}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Form Fields -->
                    <div style="display: flex; flex-direction: column; gap: 14px;">
                        ${stepFields.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; color: #666; font-size: 0.85rem;">
                                <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                                Drag fields from the left to add them here
                            </div>
                        ` : stepFields.map(f => `
                            <div>
                                <label style="display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 4px;">
                                    ${f.label} ${f.required ? '<span style="color: #ff4444;">*</span>' : ''}
                                </label>
                                ${f.type === 'select' ? `
                                    <select disabled style="width: 100%; padding: 10px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #666; font-size: 0.9rem;">
                                        <option>Select...</option>
                                    </select>
                                ` : f.type === 'textarea' ? `
                                    <textarea disabled placeholder="${f.placeholder || ''}" style="width: 100%; padding: 10px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 0.9rem; min-height: 80px; resize: none;"></textarea>
                                ` : f.type === 'checkbox' ? `
                                    <label style="display: flex; align-items: center; gap: 8px; color: #ccc; font-size: 0.9rem;">
                                        <input type="checkbox" disabled style="width: 18px; height: 18px;">
                                        ${f.placeholder || 'I agree'}
                                    </label>
                                ` : `
                                    <input type="${f.type === 'tiktok' ? 'text' : f.type}" disabled placeholder="${f.placeholder || ''}" 
                                           style="width: 100%; padding: 10px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 0.9rem; box-sizing: border-box;">
                                `}
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Submit Button -->
                    <button style="width: 100%; margin-top: 20px; padding: 14px; background: ${primaryColor}; color: #000; border: none; border-radius: 10px; font-weight: 600; font-size: 0.95rem; cursor: pointer;">
                        ${activeStepIdx < currentFunnel.steps.length - 1 ? 'Next Step ' : 'Submit Application'}
                    </button>
                </div>
            `;
        }
        
        // Upload video to Supabase Storage
        async function uploadFunnelVideo(type, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('video/')) {
                showToast('Please upload a video file (MP4, WebM)', 'error');
                return;
            }
            
            // Validate file size (500MB max)
            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('Video must be under 500MB', 'error');
                return;
            }
            
            const previewId = type === 'welcome' ? 'welcomeVideoPreview' : 'thankYouVideoPreview';
            const inputId = type === 'welcome' ? 'funnelWelcomeVideo' : 'funnelThankYouVideo';
            
            // Show uploading state
            document.getElementById(previewId).innerHTML = `
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                    <div style="margin-bottom: 8px;"> Uploading...</div>
                    <div style="height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                        <div id="${type}UploadProgress" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            
            try {
                // Generate unique filename
                const ext = file.name.split('.').pop();
                const filename = `${type}_${Date.now()}.${ext}`;
                const path = `funnel-videos/${filename}`;
                
                // Upload to Supabase Storage
                const { data, error } = await supabaseClient.storage
                    .from('public-videos')
                    .upload(path, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) throw error;
                
                // Get public URL
                const { data: urlData } = supabaseClient.storage
                    .from('public-videos')
                    .getPublicUrl(path);
                
                const videoUrl = urlData.publicUrl;
                
                // Update input field
                document.getElementById(inputId).value = videoUrl;
                
                // Show preview
                document.getElementById(previewId).innerHTML = `
                    <div style="position: relative; border-radius: 8px; overflow: hidden; background: var(--bg-secondary);">
                        <video src="${videoUrl}" style="width: 100%; max-height: 150px; object-fit: cover;" controls muted></video>
                        <button onclick="removeVideoPreview('${type}')" style="position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;"> Remove</button>
                    </div>
                `;
                
                showToast('Video uploaded!', 'success');
                updateFunnelPreview();
                
            } catch (err) {
                console.error('Upload error:', err);
                document.getElementById(previewId).innerHTML = '';
                
                if (err.message?.includes('storage/bucket-not-found') || err.message?.includes('not found')) {
                    showToast('Storage bucket not set up. Create a "public" bucket in Supabase Storage.', 'error');
                } else {
                    showToast('Upload failed: ' + err.message, 'error');
                }
            }
            
            // Clear file input
            input.value = '';
        }
        
        function removeVideoPreview(type) {
            const previewId = type === 'welcome' ? 'welcomeVideoPreview' : 'thankYouVideoPreview';
            const inputId = type === 'welcome' ? 'funnelWelcomeVideo' : 'funnelThankYouVideo';
            
            document.getElementById(previewId).innerHTML = '';
            document.getElementById(inputId).value = '';
            updateFunnelPreview();
        }
        
        async function saveFunnel() {
            // Gather all data
            const name = document.getElementById('funnelName').value.trim();
            const slug = document.getElementById('funnelSlug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
            
            if (!name) {
                showToast('Please enter a funnel name', 'error');
                return;
            }
            if (!slug) {
                showToast('Please enter a URL slug', 'error');
                return;
            }
            
            const funnelData = {
                name: name,
                slug: slug,
                brand: document.getElementById('funnelBrand').value || null,
                status: document.getElementById('funnelStatus').value || 'draft',
                steps: currentFunnel.steps,
                fields: currentFunnel.fields,
                settings: {
                    primary_color: document.getElementById('funnelPrimaryColor').value,
                    header_title: document.getElementById('funnelHeaderTitle').value,
                    header_subtitle: document.getElementById('funnelHeaderSubtitle').value,
                    logo_url: document.getElementById('funnelLogoUrl').value,
                    welcome_video_url: document.getElementById('funnelWelcomeVideo').value,
                    success_title: document.getElementById('funnelSuccessTitle').value,
                    success_message: document.getElementById('funnelSuccessMessage').value,
                    thank_you_video_url: document.getElementById('funnelThankYouVideo').value,
                    discord_oauth_enabled: document.getElementById('funnelDiscordOAuth').checked,
                    discord_client_id: document.getElementById('funnelDiscordClientId').value,
                    discord_server_link: document.getElementById('funnelDiscordLink').value
                }
            };
            
            try {
                if (currentFunnel.id) {
                    // Update existing
                    const { error } = await supabaseClient
                        .from('application_funnels')
                        .update(funnelData)
                        .eq('id', currentFunnel.id);
                    
                    if (error) throw error;
                    showToast('Funnel updated!', 'success');
                } else {
                    // Create new
                    const { error } = await supabaseClient
                        .from('application_funnels')
                        .insert([funnelData]);
                    
                    if (error) throw error;
                    showToast('Funnel created!', 'success');
                }
                
                closeFunnelBuilder();
                loadFunnelsData();
            } catch (err) {
                console.error('Error saving funnel:', err);
                if (err.message?.includes('duplicate')) {
                    showToast('Slug already exists. Choose a different one.', 'error');
                } else {
                    showToast('Failed to save funnel: ' + err.message, 'error');
                }
            }
        }
        
        function previewFunnelFullPage() {
            const slug = document.getElementById('funnelSlug').value || 'preview';
            window.open(`/apply.html?funnel=${slug}&preview=1`, '_blank');
        }

        // Init - wait for DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        console.log('Script loaded, init scheduled');
    </script>
</body>
</html>