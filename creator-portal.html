<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Creator Portal | Creators Corner</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6a6a7a;
            --border: #2a2a3a;
            --accent: #f5c518;
            --accent-dim: rgba(245, 197, 24, 0.15);
            --success: #22c55e;
            --success-dim: rgba(34, 197, 94, 0.15);
            --warning: #f59e0b;
            --warning-dim: rgba(245, 158, 11, 0.15);
            --danger: #ef4444;
            --danger-dim: rgba(239, 68, 68, 0.15);
            --info: #3b82f6;
            --info-dim: rgba(59, 130, 246, 0.15);
            --purple: #8b5cf6;
            --purple-dim: rgba(139, 92, 246, 0.15);
            --tab-height: 60px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* ==================== LOGIN SCREEN ==================== */
        #loginScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 24px;
            text-align: center;
            position: relative;
            z-index: 2000;
            background: var(--bg-primary);
        }

        .login-logo-img {
            height: 80px;
            width: auto;
            margin-bottom: 24px;
            object-fit: contain;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--accent);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            font-weight: 800;
            color: #000;
            margin-bottom: 24px;
        }

        .login-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-muted);
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            background: #5865F2;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, background 0.1s;
            -webkit-tap-highlight-color: rgba(88, 101, 242, 0.5);
            touch-action: manipulation;
            user-select: none;
            min-height: 56px;
            min-width: 280px;
            pointer-events: auto !important;
            position: relative;
            z-index: 10;
        }

        .login-btn:hover {
            background: #4752C4;
        }

        .login-btn:active {
            transform: scale(0.97);
            background: #3C45A5;
        }

        .login-social-proof {
            margin-top: 24px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* ==================== LOADING SCREEN ==================== */
        #loadingScreen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            color: var(--text-muted);
            font-size: 0.95rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* ==================== APP CONTAINER ==================== */
        #appContainer {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            padding-bottom: calc(var(--tab-height) + var(--safe-bottom));
        }

        #appContainer.show {
            display: flex;
        }

        /* ==================== TOP HEADER ==================== */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo-img {
            height: 28px;
            width: auto;
            object-fit: contain;
        }

        .header-logo {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 800;
            color: #000;
        }

        .header-brand {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .brand-switcher {
            padding: 6px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-card);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==================== BOTTOM TAB BAR ==================== */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--tab-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: none; /* Hidden by default, shown when app loads */
            align-items: center;
            justify-content: space-around;
            z-index: 1000;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.7rem;
            transition: color 0.2s;
            cursor: pointer;
        }

        .tab-item .tab-icon {
            font-size: 1.4rem;
            transition: transform 0.2s;
        }

        .tab-item.active {
            color: var(--accent);
        }

        .tab-item.active .tab-icon {
            transform: scale(1.1);
        }

        .tab-item.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-link {
            color: var(--accent);
            font-size: 0.8rem;
            text-decoration: none;
        }

        .btn-small {
            padding: 6px 12px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .account-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .account-item:last-child {
            margin-bottom: 0;
        }

        .account-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .account-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .account-handle {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .account-status {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .status-active {
            background: var(--success-dim);
            color: var(--success);
        }

        .status-pending {
            background: var(--warning-dim);
            color: var(--warning);
        }

        .status-denied {
            background: var(--danger-dim);
            color: var(--danger);
        }

        .account-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            font-size: 1rem;
        }

        /* ==================== STATS GRID ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, var(--bg-card), var(--accent-dim));
            border: 1px solid rgba(245, 197, 24, 0.3);
        }

        /* Featured GMV card - spans full width */
        .stat-card.featured {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(245, 197, 24, 0.15), rgba(245, 197, 24, 0.05));
            border: 1px solid rgba(245, 197, 24, 0.3);
            padding: 20px;
        }

        .stat-card.featured .stat-value {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent), #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.featured .stat-label {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-value.accent { color: var(--accent); }
        .stat-value.success { color: var(--success); }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .stat-change.up { color: var(--success); }
        .stat-change.down { color: var(--danger); }

        /* Number animation */
        .stat-value.animate {
            animation: countUp 0.6s ease-out;
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== STREAK CARD ==================== */
        .streak-card {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }

        .streak-card.inactive {
            background: var(--bg-card);
        }

        .streak-emoji {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .streak-count {
            font-size: 2rem;
            font-weight: 800;
        }

        .streak-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .streak-message {
            font-size: 0.8rem;
            margin-top: 8px;
            opacity: 0.8;
        }

        /* ==================== TIER BADGE ==================== */
        .tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .tier-unranked { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .tier-bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .tier-silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: #000; }
        .tier-gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .tier-platinum { background: linear-gradient(135deg, #e5e4e2, #b8b8b8); color: #000; }

        /* ==================== PROGRESS BAR ==================== */
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--warning));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ==================== CHART TOGGLE ==================== */
        .chart-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 3px;
            border-radius: 8px;
        }

        .chart-toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-toggle-btn.active {
            background: var(--accent);
            color: #000;
        }

        /* ==================== VIDEO LIST (detailed view) ==================== */
        .video-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .video-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .video-list-item:hover {
            background: var(--bg-hover);
        }

        .video-list-thumb {
            width: 50px;
            height: 50px;
            background: var(--bg-hover);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .video-list-info {
            flex: 1;
            min-width: 0;
        }

        .video-list-title {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-list-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-list-stats {
            text-align: right;
            flex-shrink: 0;
        }

        .video-list-gmv {
            font-weight: 700;
            color: var(--success);
        }

        .video-list-orders {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ==================== PRODUCT BREAKDOWN ==================== */
        .product-bar {
            margin-bottom: 12px;
        }

        .product-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .product-bar-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .product-bar-value {
            font-weight: 600;
            color: var(--accent);
        }

        .product-bar-track {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .product-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ==================== JOURNAL ENTRIES ==================== */
        .journal-entry {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .journal-entry:last-child {
            margin-bottom: 0;
        }

        .journal-entry:hover {
            border-color: var(--accent);
        }

        .journal-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .journal-entry-icon {
            font-size: 1.1rem;
        }

        .journal-entry-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .journal-entry-content {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .journal-entry-achieved {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--success);
        }

        .journal-month-group {
            margin-bottom: 20px;
        }

        .journal-month-header {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        /* ==================== VIDEO GRID ==================== */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 400px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
        }

        .video-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.2s;
            cursor: pointer;
        }

        .video-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .video-card:hover .video-card-thumb::before {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-card-thumb {
            position: relative;
            aspect-ratio: 9/12;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .video-card-thumbnail {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .video-card-thumbnail.loaded {
            display: block !important;
        }

        /* TikTok-style animated gradient overlay - shows on top of thumbnail too */
        .video-card-thumb::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 50%);
            z-index: 1;
        }

        .video-card-thumb::before {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.95);
            border-radius: 50%;
            z-index: 2;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .video-card-play {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-40%, -50%);
            z-index: 3;
            width: 0;
            height: 0;
            border-left: 18px solid #fe2c55;
            border-top: 11px solid transparent;
            border-bottom: 11px solid transparent;
        }

        .video-card-rank {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 700;
            z-index: 4;
        }

        .video-card-gmv {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: var(--success);
            color: #000;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 4;
        }

        .video-card-info {
            padding: 10px;
        }

        .video-card-creator {
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .video-card-product {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-card-stats {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* ==================== CAMPAIGNS ==================== */
        .campaign-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .campaign-card:last-child {
            margin-bottom: 0;
        }

        .campaign-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .campaign-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .campaign-info {
            flex: 1;
            min-width: 0;
        }

        .campaign-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .campaign-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .campaign-commission {
            font-size: 0.75rem;
            color: var(--success);
            font-weight: 600;
        }

        .campaign-apply-btn {
            padding: 8px 12px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            align-self: center;
        }

        /* ==================== LEADERBOARD ==================== */
        /* Your Position Card */
        .rank-position-card {
            background: linear-gradient(135deg, var(--accent-dim), rgba(245, 197, 24, 0.05));
            border: 1px solid rgba(245, 197, 24, 0.3);
            margin-bottom: 16px;
        }

        .rank-position-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .rank-position-rank {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
        }

        .rank-position-info {
            flex: 1;
        }

        .rank-position-label {
            font-weight: 600;
            font-size: 1rem;
        }

        .rank-position-total {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .rank-position-movement {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .rank-position-movement.up {
            background: var(--success-dim);
            color: var(--success);
        }

        .rank-position-movement.down {
            background: var(--danger-dim);
            color: var(--danger);
        }

        .rank-position-movement.same {
            background: var(--bg-secondary);
            color: var(--text-muted);
        }

        .rank-position-gmv {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .rank-progress-section {
            margin-bottom: 12px;
        }

        .rank-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .rank-progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .rank-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .rank-motivation {
            text-align: center;
            font-size: 0.9rem;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            color: var(--text-secondary);
        }

        .rank-motivation:empty {
            display: none;
        }

        /* Podium */
        .rank-podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 16px;
            padding: 16px 8px 0;
        }

        .podium-item {
            flex: 1;
            max-width: 120px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .podium-item:hover {
            transform: translateY(-4px);
        }

        .podium-medal {
            font-size: 1.75rem;
            margin-bottom: 4px;
        }

        .podium-name {
            font-size: 0.8rem;
            font-weight: 600;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
            margin-bottom: 2px;
            min-height: 1.8em;
        }
        
        .podium-name.long-name {
            font-size: 0.7rem;
        }
        
        .podium-name.very-long-name {
            font-size: 0.6rem;
        }

        .podium-gmv {
            font-size: 0.75rem;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .podium-base {
            padding: 12px 8px 8px;
            border-radius: 8px 8px 0 0;
            font-weight: 800;
            font-size: 1.25rem;
        }

        .podium-item.first .podium-base {
            background: linear-gradient(180deg, #f5c518, #d4a516);
            color: #000;
            padding-top: 24px;
        }

        .podium-item.second .podium-base {
            background: linear-gradient(180deg, #a8a8a8, #8a8a8a);
            color: #000;
            padding-top: 16px;
        }

        .podium-item.third .podium-base {
            background: linear-gradient(180deg, #cd7f32, #b06c28);
            color: #000;
            padding-top: 12px;
        }

        .podium-item.highlight .podium-name {
            color: var(--accent);
        }

        /* Leaderboard List */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-primary);
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .leaderboard-item:nth-child(odd) {
            background: var(--bg-secondary);
        }

        .leaderboard-item:hover {
            background: var(--bg-hover);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item.highlight {
            background: var(--accent-dim) !important;
            border-left: 3px solid var(--accent);
        }

        .leaderboard-rank {
            font-size: 0.9rem;
            font-weight: 700;
            width: 32px;
            text-align: center;
            color: var(--text-muted);
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
        }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            word-break: break-word;
            overflow-wrap: break-word;
            font-size: 0.9rem;
            line-height: 1.2;
        }

        .leaderboard-tier {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 2px;
        }

        .leaderboard-stats {
            text-align: right;
        }

        .leaderboard-gmv {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.95rem;
        }

        .leaderboard-change {
            font-size: 0.75rem;
        }

        .leaderboard-change.up { color: var(--success); }
        .leaderboard-change.down { color: var(--danger); }

        /* ==================== VIDEO LIST ==================== */
        .video-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .video-item:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .video-item:last-child {
            margin-bottom: 0;
        }

        .video-thumb {
            width: 70px;
            height: 90px;
            background: var(--bg-card);
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.5rem;
        }

        .video-details {
            flex: 1;
            min-width: 0;
        }

        .video-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .video-gmv {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success);
        }

        .video-orders {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* ==================== TRAINING CARDS ==================== */
        .training-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .training-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .training-card:active {
            background: var(--bg-hover);
        }

        .training-card:last-child {
            margin-bottom: 0;
        }

        .training-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--accent-dim);
            flex-shrink: 0;
        }

        .training-info {
            flex: 1;
        }

        .training-title {
            font-weight: 600;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .training-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .training-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }

        .training-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--accent);
            color: #000;
            font-weight: 600;
            display: inline-block;
        }

        .training-duration {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .training-new {
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 4px;
            background: var(--danger);
            color: #fff;
            font-weight: 700;
        }

        .training-play {
            align-self: center;
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        /* ==================== CREATOR SPOTLIGHT ==================== */
        .spotlight-card {
            background: linear-gradient(135deg, var(--bg-card), var(--purple-dim));
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .spotlight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .spotlight-label {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .spotlight-content {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .spotlight-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .spotlight-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .spotlight-stat {
            font-size: 0.85rem;
            color: var(--success);
        }

        .spotlight-quote {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--text-secondary);
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--purple);
            margin-bottom: 12px;
        }

        .spotlight-cta {
            display: block;
            text-align: center;
            padding: 10px;
            background: var(--purple);
            color: #fff;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .spotlight-cta:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* ==================== QUICK TIPS ==================== */
        .tips-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-nav-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tips-nav-btn:hover {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .tips-counter {
            font-size: 0.8rem;
            color: var(--text-muted);
            min-width: 30px;
            text-align: center;
        }

        .tips-container {
            position: relative;
            min-height: 100px;
        }

        .tip-card {
            display: none;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .tip-card.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .tip-category {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .tip-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        /* ==================== FAQ ==================== */
        .faq-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .faq-item:hover {
            background: var(--bg-hover);
        }

        .faq-question {
            font-weight: 600;
            padding: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .faq-toggle {
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .faq-item.open .faq-toggle {
            transform: rotate(45deg);
        }

        .faq-answer {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 14px;
        }

        .faq-item.open .faq-answer {
            max-height: 200px;
            padding: 0 14px 14px;
        }

        /* ==================== COMING SOON ==================== */
        .coming-soon-section {
            text-align: center;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .coming-soon-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .coming-soon-text {
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .coming-soon-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .coming-soon-inline {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* ==================== PROFILE SECTION ==================== */
        .profile-hero-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .profile-hero-bg {
            height: 80px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            position: relative;
        }

        .profile-hero-bg::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to top, var(--bg-card), transparent);
        }

        .profile-hero-content {
            text-align: center;
            padding: 0 20px 16px;
            margin-top: -50px;
            position: relative;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--bg-secondary);
            margin: 0 auto 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            border: 4px solid var(--bg-card);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .profile-handle-large {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .profile-member-since {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .profile-quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .profile-quick-stat {
            padding: 16px 8px;
            text-align: center;
            border-right: 1px solid var(--border);
        }

        .profile-quick-stat:last-child {
            border-right: none;
        }

        .profile-quick-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }

        .profile-quick-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Profile Brands */
        .profile-brands-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .profile-brand-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .profile-brand-tag-icon {
            font-size: 1rem;
        }

        /* Career Journey */
        .career-journey {
            position: relative;
        }

        .journey-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            position: relative;
        }

        .journey-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 42px;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .journey-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            z-index: 1;
        }

        .journey-icon.gold { background: linear-gradient(135deg, #ffd700, #ffaa00); }
        .journey-icon.purple { background: var(--purple-dim); }
        .journey-icon.green { background: var(--success-dim); }
        .journey-icon.blue { background: var(--info-dim); }

        .journey-content {
            flex: 1;
        }

        .journey-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .journey-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .journey-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        /* Profile Support Links */
        .profile-support-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s;
        }

        .profile-support-link:last-child {
            margin-bottom: 0;
        }

        .profile-support-link:hover {
            background: var(--bg-hover);
        }

        .profile-footer {
            text-align: center;
            padding: 20px 0 10px;
        }

        .profile-header {
            text-align: center;
            padding: 20px 0;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-card);
            margin: 0 auto 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-handle {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .profile-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .profile-item-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .profile-item-value {
            font-weight: 500;
        }

        /* ==================== PAYMENT HISTORY ==================== */
        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .payment-info {
            display: flex;
            flex-direction: column;
        }

        .payment-period {
            font-weight: 600;
        }

        .payment-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .payment-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .payment-status {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .payment-status.paid { background: var(--success-dim); color: var(--success); }
        .payment-status.pending { background: var(--warning-dim); color: var(--warning); }
        .payment-status.approved { background: var(--info-dim); color: var(--info); }

        /* Payment Summary */
        .payment-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .payment-summary-item {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .payment-summary-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
        }

        .payment-summary-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .payment-summary-value.paid { color: var(--success); }
        .payment-summary-value.pending { color: var(--warning); }

        /* Tier Progress Card */
        .tier-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .tier-progress-current {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1rem;
        }

        .tier-progress-emoji {
            font-size: 1.25rem;
        }

        .tier-progress-next {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .tier-progress-next-name {
            color: var(--accent);
        }

        .tier-progress-bar-container {
            margin-bottom: 12px;
        }

        .tier-progress-bar {
            height: 10px;
            background: var(--bg-secondary);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .tier-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--purple) 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .tier-progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .tier-progress-remaining {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .tier-progress-amount {
            color: var(--accent);
            font-weight: 700;
        }

        #tierProgressCard.maxed .tier-progress-remaining {
            color: var(--success);
        }

        /* Best Video Card */
        .best-video-content {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .best-video-thumb {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            background: var(--bg-secondary);
            overflow: hidden;
            flex-shrink: 0;
        }

        .best-video-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .best-video-info {
            flex: 1;
            min-width: 0;
        }

        .best-video-product {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .best-video-stats {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .best-video-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .best-video-stat-value {
            color: var(--accent);
            font-weight: 600;
        }

        .best-video-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Notification Preferences */
        .notification-prefs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .notification-pref-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-pref-item:hover {
            background: var(--bg-hover);
        }

        .notification-pref-info {
            flex: 1;
        }

        .notification-pref-title {
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
        }

        .notification-pref-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .notification-pref-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* ==================== PENDING STATE ==================== */
        .pending-card {
            text-align: center;
            padding: 40px 20px;
        }

        .pending-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .pending-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .pending-message {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .pending-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pending-step {
            width: 40px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
        }

        .pending-step.complete { background: var(--success); }
        .pending-step.current { background: var(--accent); animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ==================== CLAIM FLOW ==================== */
        .claim-flow {
            text-align: center;
            padding: 20px 0;
        }

        .claim-step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            margin-bottom: 24px;
        }

        .claim-step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .claim-step.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        .claim-step.completed {
            background: var(--success);
            border-color: var(--success);
            color: #fff;
        }

        .claim-step-line {
            width: 40px;
            height: 2px;
            background: var(--border);
            transition: background 0.3s ease;
        }

        .claim-step-line.active {
            background: var(--accent);
        }

        .claim-input-wrapper {
            position: relative;
            max-width: 300px;
            margin: 0 auto 16px;
        }

        .claim-at {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 600;
        }

        .claim-input {
            width: 100%;
            padding: 14px 16px 14px 36px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .claim-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .claim-input::placeholder {
            color: var(--text-muted);
        }

        .claim-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 12px;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            border: none;
        }

        .claim-btn.primary {
            background: var(--accent);
            color: #000;
        }

        .claim-btn.primary:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .claim-btn.primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .claim-btn.secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .claim-btn.secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .claim-btn-icon {
            font-size: 1.1rem;
        }

        .claim-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            max-width: 300px;
            margin: 20px auto;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .claim-divider::before,
        .claim-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .claim-records {
            max-width: 350px;
            margin: 0 auto 20px;
            text-align: left;
        }

        .claim-record-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .claim-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .claim-brand-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .claim-status-badge {
            background: var(--success-dim);
            color: var(--success);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .claim-accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .claim-account-tag {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .claim-gmv {
            margin-top: 10px;
            color: var(--success);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .claim-verify-notice {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 350px;
            margin: 0 auto 20px;
            padding: 16px;
            background: var(--warning-dim);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 12px;
            text-align: left;
        }

        .claim-verify-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .claim-verify-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .claim-verify-text strong {
            color: var(--warning);
            font-size: 0.9rem;
        }

        .claim-verify-text span {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .claim-success-notice {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            max-width: 350px;
            margin: 20px auto;
            padding: 16px;
            background: var(--success-dim);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
        }

        .claim-success-icon {
            font-size: 1.3rem;
        }

        .claim-success-text {
            color: var(--success);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .claim-pending-time {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== ACHIEVEMENTS ==================== */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .achievement-item {
            text-align: center;
            padding: 16px 8px;
            background: var(--bg-secondary);
            border-radius: 12px;
            position: relative;
            transition: all 0.2s;
        }

        .achievement-item.locked {
            opacity: 0.5;
        }

        .achievement-item.unlocked {
            background: linear-gradient(135deg, var(--accent-dim), var(--bg-secondary));
            border: 1px solid var(--accent);
        }

        .achievement-item.unlocked .achievement-icon {
            animation: achievementPop 0.5s ease;
        }

        @keyframes achievementPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .achievement-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .achievement-item.unlocked .achievement-name {
            color: var(--text-primary);
            font-weight: 600;
        }

        .achievement-progress {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ==================== EMPTY STATES ==================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        /* ==================== QUICK LINKS ==================== */
        .quick-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            text-decoration: none;
            color: var(--text-primary);
            transition: background 0.2s;
        }

        .quick-link:active {
            background: var(--bg-hover);
        }

        .quick-link-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: var(--bg-card);
        }

        .quick-link-text {
            flex: 1;
        }

        .quick-link-title {
            font-weight: 600;
        }

        .quick-link-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .quick-link-arrow {
            color: var(--text-muted);
        }

        /* ==================== PERIOD SELECTOR ==================== */
        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .period-selector::-webkit-scrollbar {
            display: none;
        }

        .period-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .period-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }

        /* ==================== LEADERBOARD TABS ==================== */
        .leaderboard-tab {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .leaderboard-tab:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .leaderboard-tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }

        .video-leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .video-leaderboard-item:hover {
            background: var(--bg-hover);
        }

        .video-leaderboard-item:last-child {
            border-bottom: none;
        }

        .video-leaderboard-rank {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .video-leaderboard-rank.top3 {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: #000;
        }

        .video-leaderboard-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--bg-secondary);
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-leaderboard-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .video-leaderboard-product {
            font-weight: 600;
            font-size: 0.9rem;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
        }

        .video-leaderboard-creator {
            font-size: 0.8rem;
            color: var(--text-muted);
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
        }

        .video-leaderboard-stats {
            text-align: right;
            flex-shrink: 0;
        }

        .video-leaderboard-gmv {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--success);
        }

        .video-leaderboard-orders {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .video-leaderboard-new-badge {
            background: var(--accent);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .video-leaderboard-is-me {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--accent);
        }

        /* ==================== LOGOUT BTN ==================== */
        .logout-btn {
            width: 100%;
            padding: 14px;
            background: var(--danger-dim);
            border: 1px solid var(--danger);
            border-radius: 12px;
            color: var(--danger);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        /* ==================== VIDEO MODAL ==================== */
        .video-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            flex-direction: column;
            padding: 20px;
        }

        .video-modal.show {
            display: flex;
        }

        .video-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            z-index: 10001;
        }

        .video-modal-title {
            color: white;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            margin-top: 40px;
        }

        .video-modal-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-modal-content iframe {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            border: none;
            border-radius: 12px;
        }

        /* ==================== UTILITIES ==================== */
        .hidden { display: none !important; }
        .mb-0 { margin-bottom: 0 !important; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .text-sm { font-size: 0.85rem; }

        /* ==================== ADMIN MODE ==================== */
        .admin-banner {
            display: none;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            padding: 8px 16px;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-size: 0.85rem;
        }

        .admin-banner.show {
            display: flex;
        }

        .admin-badge {
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        .admin-viewing {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-creator-search {
            padding: 6px 10px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            font-size: 0.85rem;
            width: 150px;
        }

        .admin-creator-search::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .admin-creator-select {
            padding: 6px 10px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            font-size: 0.85rem;
            max-width: 250px;
            cursor: pointer;
        }

        .admin-creator-select option {
            background: #1a1a24;
            color: white;
        }

        .admin-exit-btn {
            padding: 6px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 600;
        }

        .admin-exit-btn:hover {
            background: rgba(0,0,0,0.5);
        }

        /* ==================== DESKTOP ADJUSTMENTS ==================== */
        @media (min-width: 768px) {
            .main-content {
                max-width: 600px;
                margin: 0 auto;
                padding: 24px;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .stat-card.featured {
                grid-column: span 4;
            }

            .achievements-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="loginScreen">
        <img src="logo.png" alt="Creators Corner" class="login-logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="login-logo" style="display: none;">CC</div>
        <h1 class="login-title">Creator Portal</h1>
        <p class="login-subtitle">Track your GMV. Climb the ranks. Get paid.</p>
        
        <!-- In-app browser warning (hidden by default) -->
        <div id="inAppWarning" style="display: none; background: #FEF3C7; color: #92400E; padding: 16px; border-radius: 12px; margin-bottom: 20px; max-width: 320px; text-align: left;">
            <div style="font-weight: 600; margin-bottom: 8px;"> Open in your browser</div>
            <div style="font-size: 0.9rem; margin-bottom: 12px;">Discord's browser can't complete sign-in. Tap below to copy the link, then paste in Chrome or Safari.</div>
            <button id="copyLinkBtn" style="width: 100%; padding: 12px; background: #92400E; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                 Copy Link
            </button>
            <div id="copyConfirm" style="display: none; text-align: center; margin-top: 8px; font-size: 0.85rem; color: #059669;"> Copied! Now paste in your browser</div>
        </div>
        
        <button id="discordLoginBtn" class="login-btn" type="button">
            <svg width="24" height="24" viewBox="0 0 71 55" fill="currentColor" style="pointer-events: none;">
                <path d="M60.1 4.9A58.5 58.5 0 0045.4.5a.2.2 0 00-.2.1 40.8 40.8 0 00-1.8 3.7 54 54 0 00-16.2 0A37.4 37.4 0 0025.4.6a.2.2 0 00-.2-.1 58.4 58.4 0 00-14.7 4.4.2.2 0 00-.1.1C1.5 18.7-.9 32 .3 45.2v.1a58.9 58.9 0 0018 9 .2.2 0 00.3-.1 42.5 42.5 0 003.6-5.9.2.2 0 00-.1-.3 38.8 38.8 0 01-5.5-2.6.2.2 0 010-.4l1.1-.9a.2.2 0 01.2 0 42 42 0 0035.8 0 .2.2 0 01.2 0l1.1.9a.2.2 0 010 .4 36.4 36.4 0 01-5.5 2.6.2.2 0 00-.1.3 47.7 47.7 0 003.6 5.9.2.2 0 00.3.1 58.7 58.7 0 0018-9v-.1c1.4-15-2.4-28-10-39.5a.2.2 0 00-.1-.1zM23.7 37.1c-3.4 0-6.2-3.1-6.2-7s2.7-7 6.2-7 6.3 3.2 6.2 7-2.8 7-6.2 7zm23 0c-3.4 0-6.2-3.1-6.2-7s2.7-7 6.2-7 6.3 3.2 6.2 7-2.7 7-6.2 7z"/>
            </svg>
            <span style="pointer-events: none;">Continue with Discord</span>
        </button>
        <p class="login-social-proof">Join 1,500+ creators earning on TikTok Shop</p>
    </div>

    <!-- ==================== LOADING SCREEN ==================== -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-message" id="loadingMessage">Loading your dashboard...</div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div id="appContainer">
        <!-- Admin Banner (shown when viewing as another creator) -->
        <div id="adminBanner" class="admin-banner">
            <span class="admin-badge">ADMIN</span>
            <div class="admin-viewing">
                <input type="text" id="adminCreatorSearch" class="admin-creator-search" placeholder=" Search creators..." oninput="filterAdminCreatorDropdown()">
                <select id="adminCreatorSelect" class="admin-creator-select" onchange="switchViewingCreator()">
                    <option value="">Select creator...</option>
                </select>
            </div>
            <button class="admin-exit-btn" onclick="exitAdminMode()"> Exit</button>
        </div>
        <!-- Top Header -->
        <header class="app-header">
            <div class="header-left">
                <img src="logo.png" alt="CC" class="header-logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="header-logo" style="display: none;">CC</div>
                <select id="brandSwitcher" class="brand-switcher" onchange="switchBrand(this.value)">
                    <option value="all">All Brands</option>
                </select>
            </div>
            <div class="header-right">
                <div id="headerAvatar" class="header-avatar"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- ==================== HOME VIEW ==================== -->
            <div id="view-home" class="view-section active">
                <!-- Welcome + Tier -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h1 style="font-size: 1.25rem; font-weight: 700;">Hey, <span id="homeName">Creator</span>! </h1>
                        <p class="text-muted text-sm" id="homeSubtitle">Let's crush it today</p>
                    </div>
                    <div id="homeTierBadge" class="tier-badge tier-unranked">Unranked</div>
                </div>

                <!-- Pending Status (shown for pending applicants) -->
                <div id="pendingStatusCard" class="card pending-card hidden">
                    <div class="pending-icon"></div>
                    <h2 class="pending-title">Application Under Review</h2>
                    <p class="pending-message">Thanks for applying! Our team is reviewing your application. You'll get full access once approved.</p>
                    <div class="pending-steps">
                        <div class="pending-step complete"></div>
                        <div class="pending-step current"></div>
                        <div class="pending-step"></div>
                    </div>
                </div>

                <!-- Period Selector (hidden for pending) -->
                <div id="homePeriodSelector" style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                        <div class="period-selector" style="margin: 0;">
                            <button class="period-btn active" data-period="7" onclick="setHomePeriod(7)">7D</button>
                            <button class="period-btn" data-period="14" onclick="setHomePeriod(14)">14D</button>
                            <button class="period-btn" data-period="30" onclick="setHomePeriod(30)">30D</button>
                            <button class="period-btn" data-period="90" onclick="setHomePeriod(90)">90D</button>
                        </div>
                        <div id="homeDateRange" style="font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
                            <span style="opacity: 0.7;"></span>
                            <span id="homeDateRangeText">Dec 12  Dec 18</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid (hidden for pending) -->
                <div id="homeStats" class="stats-grid">
                    <div class="stat-card featured">
                        <div class="stat-label"> Your GMV</div>
                        <div class="stat-value" id="homeGmv">$0</div>
                        <div class="stat-change" id="homeGmvChange"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Orders</div>
                        <div class="stat-value" id="homeOrders">0</div>
                        <div class="stat-change" id="homeOrdersChange"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Videos</div>
                        <div class="stat-value" id="homeVideos">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rank</div>
                        <div class="stat-value" id="homeRank">#-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">All-Time GMV</div>
                        <div class="stat-value" id="homeAllTimeGmv">$0</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">Since Oct 2024</div>
                    </div>
                </div>

                <!-- Next Milestone (hidden for pending) -->
                <div id="homeMilestoneCard" class="card" style="background: linear-gradient(135deg, var(--bg-card), var(--purple-dim)); border: 1px solid rgba(139, 92, 246, 0.3); display: none;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;" id="milestoneTitle">Next: Partner Tier</div>
                            <div class="text-sm text-muted" id="milestoneSubtitle">$2,500 away from unlocking</div>
                        </div>
                        <div style="font-weight: 700; color: var(--purple);" id="milestoneProgress">50%</div>
                    </div>
                    <div style="margin-top: 12px; background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden;">
                        <div id="milestoneBar" style="height: 100%; background: linear-gradient(90deg, var(--purple), var(--accent)); width: 50%; transition: width 0.5s ease;"></div>
                    </div>
                </div>

                <!-- Streak Card (hidden for pending) -->
                <div id="homeStreakCard" class="streak-card">
                    <div class="streak-emoji" id="streakEmoji"></div>
                    <div class="streak-count"><span id="streakCount">0</span> day streak</div>
                    <div class="streak-label">Keep posting to build your streak!</div>
                    <div class="streak-message" id="streakMessage">Post today to start!</div>
                </div>

                <!-- Call Your Shot Journal (hidden for pending) -->
                <div id="homeJournalCard" class="card">
                    <div class="card-header">
                        <div class="card-title"> Call Your Shot</div>
                        <button id="journalAddBtn" class="btn-small" onclick="showAddJournalModal()">+ New</button>
                    </div>
                    <p id="journalSubtitle" style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">Set goals, track your journey, reflect on how far you've come.</p>
                    <div id="journalEntries">
                        <div class="empty-state" style="padding: 20px;">
                            <div class="empty-icon"></div>
                            <div>No entries yet</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">Call your first shot!</div>
                        </div>
                    </div>
                    <div id="journalShowMore" style="display: none; text-align: center; margin-top: 12px;">
                        <button class="btn-link" onclick="showAllJournalEntries()">View all entries </button>
                    </div>
                </div>

                <!-- What's Winning (hidden for pending) -->
                <div id="homeWinningCard" class="card">
                    <div class="card-header">
                        <div class="card-title"> Top Performing Videos</div>
                        <span class="text-muted text-sm" id="winningPeriodLabel">Last 7 days</span>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">See what's crushing it across the brand</p>
                    <div id="winningVideos" class="video-grid">
                        <div class="empty-state">
                            <div class="spinner" style="margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- Pro Tip (dismissible) -->
                <div id="proTipCard" class="card" style="background: linear-gradient(135deg, var(--bg-card), var(--info-dim)); border: 1px solid rgba(59, 130, 246, 0.2); position: relative;">
                    <button onclick="dismissProTip()" style="position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 4px;"></button>
                    <div style="display: flex; gap: 12px;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="padding-right: 24px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">Pro Tip</div>
                            <div class="text-sm text-muted" id="proTipText">Videos posted between 6-9 PM EST typically get 40% more views!</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div id="homeRecentCard" class="card">
                    <div class="card-header">
                        <div class="card-title"> Your Recent Videos</div>
                        <span class="text-muted text-sm" id="recentPeriodLabel">Last 7 days</span>
                    </div>
                    <div id="recentVideos">
                        <div class="empty-state">
                            <div class="spinner" style="margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ==================== STATS VIEW ==================== -->
            <div id="view-stats" class="view-section">
                <h1 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 16px;"> Your Stats</h1>
                
                <!-- Period Selector -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                        <div class="period-selector" style="margin: 0;">
                            <button class="period-btn active" data-period="7" onclick="setStatsPeriod(7)">7D</button>
                            <button class="period-btn" data-period="30" onclick="setStatsPeriod(30)">30D</button>
                            <button class="period-btn" data-period="90" onclick="setStatsPeriod(90)">90D</button>
                            <button class="period-btn" data-period="all" onclick="setStatsPeriod('all')">All</button>
                        </div>
                        <div id="statsDateRange" style="font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
                            <span style="opacity: 0.7;"></span>
                            <span id="statsDateRangeText">Dec 12  Dec 18</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Summary -->
                <div class="stats-grid">
                    <div class="stat-card featured">
                        <div class="stat-label"> Total GMV</div>
                        <div class="stat-value" id="statsGmv">$0</div>
                        <div class="stat-change" id="statsGmvChange"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Orders</div>
                        <div class="stat-value" id="statsOrders">0</div>
                        <div class="stat-change" id="statsOrdersChange"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Videos</div>
                        <div class="stat-value" id="statsVideos">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg/Video</div>
                        <div class="stat-value" id="statsAvgGmv">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Conversion</div>
                        <div class="stat-value" id="statsConversion">0%</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">orders per video</div>
                    </div>
                </div>

                <!-- Insights Row -->
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-title mb-16"> Insights</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 10px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;"> Best Day</div>
                            <div style="font-weight: 700; color: var(--success);" id="statsBestDayGmv">$0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);" id="statsBestDayDate">-</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 10px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;"> vs Prior Period</div>
                            <div style="font-weight: 700;" id="statsPriorChange">-</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);" id="statsPriorLabel">-</div>
                        </div>
                    </div>
                </div>

                <!-- Product Breakdown -->
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-title mb-16"> Product Breakdown</div>
                    <div id="statsProductBreakdown">
                        <div class="empty-state" style="padding: 16px;">
                            <div class="spinner" style="margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- GMV Chart -->
                <div class="card">
                    <div class="card-header" style="margin-bottom: 12px;">
                        <div class="card-title"> Trend</div>
                        <div class="chart-toggle">
                            <button class="chart-toggle-btn active" data-metric="gmv" onclick="switchChartMetric('gmv')">GMV</button>
                            <button class="chart-toggle-btn" data-metric="orders" onclick="switchChartMetric('orders')">Orders</button>
                        </div>
                    </div>
                    <div style="position: relative; height: 200px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>

                <!-- Your Top Videos -->
                <div class="card mb-0">
                    <div class="card-header">
                        <div class="card-title"> Your Top Videos</div>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">Click to watch</p>
                    <div id="statsVideoList" class="video-list">
                        <div class="empty-state">
                            <div class="spinner" style="margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== RANK VIEW ==================== -->
            <div id="view-rank" class="view-section">
                <h1 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 8px;"> Leaderboards</h1>
                <p class="text-muted text-sm mb-16">See who's crushing it</p>

                <!-- Period Selector -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                        <div class="period-selector" style="margin: 0;">
                            <button class="period-btn active" data-period="7" onclick="setRankPeriod('7')">Last 7D</button>
                            <button class="period-btn" data-period="thisMonth" onclick="setRankPeriod('thisMonth')">This Month</button>
                            <button class="period-btn" data-period="lastMonth" onclick="setRankPeriod('lastMonth')">Last Month</button>
                            <button class="period-btn" data-period="quarter" onclick="setRankPeriod('quarter')">Quarter</button>
                        </div>
                        <div id="rankDateRange" style="font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
                            <span style="opacity: 0.7;"></span>
                            <span id="rankDateRangeText">Dec 12  Dec 18</span>
                        </div>
                    </div>
                </div>

                <!-- Your Position - Enhanced -->
                <div id="rankYourPosition" class="card rank-position-card">
                    <div class="rank-position-header">
                        <div class="rank-position-rank" id="rankYourRank">#-</div>
                        <div class="rank-position-info">
                            <div class="rank-position-label">Your Position</div>
                            <div class="rank-position-total" id="rankTotalCreators">of - creators</div>
                        </div>
                        <div class="rank-position-movement" id="rankMovement"></div>
                    </div>
                    <div class="rank-position-gmv">
                        <span id="rankYourGmv">$0</span>
                        <span class="text-muted"> GMV</span>
                    </div>
                    <div class="rank-progress-section" id="rankProgressSection">
                        <div class="rank-progress-label">
                            <span id="rankProgressText">-</span>
                            <span id="rankBeatNext" style="color: var(--accent);"></span>
                        </div>
                        <div class="rank-progress-bar">
                            <div class="rank-progress-fill" id="rankProgressFill" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="rank-motivation" id="rankMotivation"></div>
                </div>

                <!-- Leaderboard Tabs -->
                <div class="leaderboard-tabs" style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px;">
                    <button class="leaderboard-tab active" data-tab="creators" onclick="switchLeaderboardTab('creators')">
                         Top Creators
                    </button>
                    <button class="leaderboard-tab" data-tab="videos" onclick="switchLeaderboardTab('videos')">
                         Top Videos
                    </button>
                    <button class="leaderboard-tab" data-tab="newVideos" onclick="switchLeaderboardTab('newVideos')">
                         Hot New Videos
                    </button>
                </div>

                <!-- TOP CREATORS LEADERBOARD -->
                <div id="leaderboard-creators" class="leaderboard-section">
                    <!-- Top 3 Podium -->
                    <div id="rankPodium" class="rank-podium">
                        <div class="podium-item second" id="podium2">
                            <div class="podium-medal"></div>
                            <div class="podium-name">-</div>
                            <div class="podium-gmv">$0</div>
                            <div class="podium-base">2</div>
                        </div>
                        <div class="podium-item first" id="podium1">
                            <div class="podium-medal"></div>
                            <div class="podium-name">-</div>
                            <div class="podium-gmv">$0</div>
                            <div class="podium-base">1</div>
                        </div>
                        <div class="podium-item third" id="podium3">
                            <div class="podium-medal"></div>
                            <div class="podium-name">-</div>
                            <div class="podium-gmv">$0</div>
                            <div class="podium-base">3</div>
                        </div>
                    </div>

                    <!-- Full Creator Leaderboard -->
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <div style="padding: 16px 16px 12px; border-bottom: 1px solid var(--border);">
                            <div class="card-title" style="margin: 0;">Full Rankings</div>
                        </div>
                        <div id="leaderboardList">
                            <div class="empty-state">
                                <div class="spinner" style="margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOP VIDEOS LEADERBOARD -->
                <div id="leaderboard-videos" class="leaderboard-section" style="display: none;">
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <div style="padding: 16px 16px 12px; border-bottom: 1px solid var(--border);">
                            <div class="card-title" style="margin: 0;"> Best Performing Videos</div>
                            <div class="text-muted text-sm" style="margin-top: 4px;">Highest GMV videos this period</div>
                        </div>
                        <div id="topVideosList">
                            <div class="empty-state">
                                <div class="spinner" style="margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HOT NEW VIDEOS LEADERBOARD -->
                <div id="leaderboard-newVideos" class="leaderboard-section" style="display: none;">
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <div style="padding: 16px 16px 12px; border-bottom: 1px solid var(--border);">
                            <div class="card-title" style="margin: 0;"> Hot New Videos</div>
                            <div class="text-muted text-sm" style="margin-top: 4px;">Videos posted in the last 7 days</div>
                        </div>
                        <div id="newVideosList">
                            <div class="empty-state">
                                <div class="spinner" style="margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== LEARN VIEW ==================== -->
            <div id="view-learn" class="view-section">
                <h1 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 16px;"> Learn</h1>

                <!-- Video Trainings -->
                <div class="card">
                    <div class="card-title mb-16"> Video Trainings</div>
                    
                    <div class="training-card" onclick="openVideo('ea0febfb31a24d4b93ff274f15d92c50', 'GMV Max 101: Understanding the Algorithm')">
                        <div class="training-icon"></div>
                        <div class="training-info">
                            <div class="training-title">GMV Max 101</div>
                            <div class="training-desc">Understanding the Algorithm</div>
                            <div class="training-meta">
                                <span class="training-badge">ESSENTIAL</span>
                                <span class="training-duration">12 min</span>
                            </div>
                        </div>
                        <div class="training-play"></div>
                    </div>

                    <div class="training-card" onclick="openVideo('8471a3b885e34f52a94eb4ddaf06d17e', 'Beans Interview: $5M GMV Creator')">
                        <div class="training-icon"></div>
                        <div class="training-info">
                            <div class="training-title">
                                Beans Interview
                                <span class="training-new">NEW</span>
                            </div>
                            <div class="training-desc">$5M GMV Creator & Founder of Daily Virals</div>
                            <div class="training-meta">
                                <span class="training-badge" style="background: var(--purple);">INTERVIEW</span>
                                <span class="training-duration">28 min</span>
                            </div>
                        </div>
                        <div class="training-play"></div>
                    </div>

                    <div class="training-card" onclick="openVideo('915c9de24a634c688758c0681f01a234', 'The Alter Ego Effect')">
                        <div class="training-icon"></div>
                        <div class="training-info">
                            <div class="training-title">The Alter Ego Effect</div>
                            <div class="training-desc">Stepping into Your $100k/mo Identity</div>
                            <div class="training-meta">
                                <span class="training-badge" style="background: var(--success);">MINDSET</span>
                                <span class="training-duration">18 min</span>
                            </div>
                        </div>
                        <div class="training-play"></div>
                    </div>
                </div>

                <!-- Creator Spotlight -->
                <div class="card spotlight-card">
                    <div class="spotlight-header">
                        <span class="spotlight-label"> Creator Spotlight</span>
                        <span class="text-muted text-sm">Weekly feature</span>
                    </div>
                    <div class="spotlight-content">
                        <div class="spotlight-avatar"></div>
                        <div class="spotlight-info">
                            <div class="spotlight-name" id="spotlightName">Top Creator</div>
                            <div class="spotlight-stat" id="spotlightStat">$50K+ GMV this month</div>
                        </div>
                    </div>
                    <div class="spotlight-quote" id="spotlightQuote">
                        "Consistency is everything. I post 2-3 videos daily and focus on solving real problems with the products."
                    </div>
                    <a href="#" id="spotlightLink" class="spotlight-cta" target="_blank">
                        Watch their content 
                    </a>
                </div>

                <!-- Quick Tips -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"> Quick Tips</div>
                        <div class="tips-nav">
                            <button class="tips-nav-btn" onclick="prevTip()"></button>
                            <span class="tips-counter"><span id="tipCurrent">1</span>/<span id="tipTotal">4</span></span>
                            <button class="tips-nav-btn" onclick="nextTip()"></button>
                        </div>
                    </div>
                    <div class="tips-container" id="tipsContainer">
                        <div class="tip-card active" data-category="content">
                            <div class="tip-category"> Content</div>
                            <div class="tip-text">Hook viewers in the first 2 seconds. Start with a problem, question, or bold statement.</div>
                        </div>
                        <div class="tip-card" data-category="algorithm">
                            <div class="tip-category"> Algorithm</div>
                            <div class="tip-text">Post during peak hours (6-9 PM EST) and engage with comments in the first hour for maximum reach.</div>
                        </div>
                        <div class="tip-card" data-category="sales">
                            <div class="tip-category"> Sales</div>
                            <div class="tip-text">Show the product in action solving a real problem. Transformation videos convert 3x better than static reviews.</div>
                        </div>
                        <div class="tip-card" data-category="mindset">
                            <div class="tip-category"> Mindset</div>
                            <div class="tip-text">Not every video will go viral. Focus on volume and iteration - your breakthrough is often just a few posts away.</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="card">
                    <div class="card-title mb-16"> Quick Links</div>
                    
                    <a href="#" id="discordLink" target="_blank" class="quick-link">
                        <div class="quick-link-icon" style="background: rgba(88, 101, 242, 0.2);"></div>
                        <div class="quick-link-text">
                            <div class="quick-link-title">Join Our Discord</div>
                            <div class="quick-link-desc">Connect with creators & get support</div>
                        </div>
                        <span class="quick-link-arrow"></span>
                    </a>

                    <a href="https://seller-us.tiktok.com/university" target="_blank" class="quick-link">
                        <div class="quick-link-icon"></div>
                        <div class="quick-link-text">
                            <div class="quick-link-title">TikTok Shop University</div>
                            <div class="quick-link-desc">Official TikTok creator training</div>
                        </div>
                        <span class="quick-link-arrow"></span>
                    </a>
                </div>

                <!-- Available Campaigns -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"> Join More Brands</div>
                        <span class="text-muted text-sm">Expand your reach</span>
                    </div>
                    <div id="availableCampaigns">
                        <div class="empty-state">
                            <div class="spinner" style="margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- Resource Downloads -->
                <div class="card">
                    <div class="card-title mb-16"> Resources</div>
                    <div id="portalResources">
                        <div class="coming-soon-section">
                            <div class="coming-soon-icon"></div>
                            <div class="coming-soon-text">Coming Soon</div>
                            <div class="coming-soon-desc">Brand guidelines, product sheets & sample scripts</div>
                        </div>
                    </div>
                </div>

                <!-- FAQ -->
                <div class="card mb-0">
                    <div class="card-title mb-16"> FAQ</div>
                    <div id="portalFaq">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            <div class="spinner" style="margin: 0 auto 10px;"></div>
                            Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== PROFILE VIEW ==================== -->
            <div id="view-profile" class="view-section">
                <!-- Profile Header Card -->
                <div class="profile-hero-card">
                    <div class="profile-hero-bg"></div>
                    <div class="profile-hero-content">
                        <div id="profileAvatar" class="profile-avatar-large"></div>
                        <div id="profileName" class="profile-name-large">Creator</div>
                        <div id="profileHandle" class="profile-handle-large">@tiktok</div>
                        <div id="profileTier" class="tier-badge tier-unranked" style="margin-top: 8px;">Unranked</div>
                        <div id="profileMemberSince" class="profile-member-since">Member since Dec 2024</div>
                    </div>
                </div>

                <!-- Tier Progress Card -->
                <div class="card" id="tierProgressCard">
                    <div class="tier-progress-header">
                        <div class="tier-progress-current">
                            <span class="tier-progress-emoji" id="tierProgressEmoji"></span>
                            <span id="tierProgressName">Unranked</span>
                        </div>
                        <div class="tier-progress-next" id="tierProgressNext">
                            Next: <span class="tier-progress-next-name">Bronze</span> 
                        </div>
                    </div>
                    <div class="tier-progress-bar-container">
                        <div class="tier-progress-bar">
                            <div class="tier-progress-fill" id="tierProgressFill" style="width: 0%;"></div>
                        </div>
                        <div class="tier-progress-labels">
                            <span id="tierProgressCurrent">$0</span>
                            <span id="tierProgressTarget">$2,000</span>
                        </div>
                    </div>
                    <div class="tier-progress-remaining" id="tierProgressRemaining">
                        <span class="tier-progress-amount">$2,000</span> to go
                    </div>
                </div>

                <!-- Your Best Video -->
                <div class="card" id="bestVideoCard" style="display: none;">
                    <div class="card-header">
                        <div class="card-title"> Your Best Video</div>
                        <span class="text-muted text-sm">All time</span>
                    </div>
                    <div id="bestVideoContent" class="best-video-content">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Your Brands -->
                <div class="card">
                    <div class="card-title mb-16"> Your Brands</div>
                    <div id="profileBrandsList" class="profile-brands-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Achievements -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"> Achievements</div>
                        <span class="text-muted text-sm"><span id="achievementCount">0</span>/12 unlocked</span>
                    </div>
                    <div class="achievements-grid" id="achievementsGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- TikTok Accounts Management -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"> TikTok Accounts</div>
                        <button class="btn-small" onclick="showAddAccountModal()">+ Add</button>
                    </div>
                    <div id="tiktokAccountsList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Payment History -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"> Payment History</div>
                        <span class="text-muted text-sm" id="totalEarnings">$0 earned</span>
                    </div>
                    <div id="paymentSummary" class="payment-summary" style="display: none;">
                        <div class="payment-summary-item">
                            <span class="payment-summary-label">Total Paid</span>
                            <span class="payment-summary-value paid" id="paymentTotalPaid">$0</span>
                        </div>
                        <div class="payment-summary-item">
                            <span class="payment-summary-label">Pending</span>
                            <span class="payment-summary-value pending" id="paymentTotalPending">$0</span>
                        </div>
                    </div>
                    <div id="paymentHistory">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div>No payments yet</div>
                        </div>
                    </div>
                </div>

                <!-- Notification Preferences -->
                <div class="card">
                    <div class="card-title mb-16"> Notification Preferences</div>
                    <div class="notification-prefs">
                        <label class="notification-pref-item">
                            <div class="notification-pref-info">
                                <span class="notification-pref-title">Weekly Summary</span>
                                <span class="notification-pref-desc">Get a weekly email with your performance stats</span>
                            </div>
                            <input type="checkbox" id="prefWeeklySummary" onchange="saveNotificationPref('weekly_summary', this.checked)">
                        </label>
                        <label class="notification-pref-item">
                            <div class="notification-pref-info">
                                <span class="notification-pref-title">Milestone Alerts</span>
                                <span class="notification-pref-desc">Get notified when you hit new milestones</span>
                            </div>
                            <input type="checkbox" id="prefMilestones" onchange="saveNotificationPref('milestones', this.checked)" checked>
                        </label>
                        <label class="notification-pref-item">
                            <div class="notification-pref-info">
                                <span class="notification-pref-title">Payment Notifications</span>
                                <span class="notification-pref-desc">Get notified when payments are processed</span>
                            </div>
                            <input type="checkbox" id="prefPayments" onchange="saveNotificationPref('payments', this.checked)" checked>
                        </label>
                        <label class="notification-pref-item">
                            <div class="notification-pref-info">
                                <span class="notification-pref-title">New Campaign Alerts</span>
                                <span class="notification-pref-desc">Be notified when new brand campaigns launch</span>
                            </div>
                            <input type="checkbox" id="prefCampaigns" onchange="saveNotificationPref('campaigns', this.checked)" checked>
                        </label>
                    </div>
                </div>

                <!-- Account Info -->
                <div class="card">
                    <div class="card-title mb-16"> Account</div>
                    
                    <div class="profile-item">
                        <span class="profile-item-label">Discord</span>
                        <span id="profileDiscord" class="profile-item-value">-</span>
                    </div>
                    <div class="profile-item">
                        <span class="profile-item-label">Email</span>
                        <span id="profileEmail" class="profile-item-value">-</span>
                    </div>
                    <div class="profile-item mb-0">
                        <span class="profile-item-label">Status</span>
                        <span id="profileStatus" class="profile-item-value">Active</span>
                    </div>
                </div>

                <!-- Support -->
                <div class="card">
                    <div class="card-title mb-16"> Need Help?</div>
                    <a href="#" id="profileDiscordLink" target="_blank" class="profile-support-link">
                        <span>Join Discord Community</span>
                        <span></span>
                    </a>
                    <a href="mailto:support@creatorscorner.com" class="profile-support-link">
                        <span>Email Support</span>
                        <span></span>
                    </a>
                </div>

                <!-- Logout -->
                <button class="logout-btn" onclick="logout()"> Log Out</button>
                
                <div class="profile-footer">
                    <div class="text-muted text-sm">Creators Corner v3.91</div>
                </div>
            </div>
        </main>

        <!-- Bottom Tab Bar -->
        <nav class="tab-bar">
            <div class="tab-item active" data-view="home" onclick="switchView('home')">
                <span class="tab-icon"></span>
                <span>Home</span>
            </div>
            <div class="tab-item" data-view="stats" onclick="switchView('stats')">
                <span class="tab-icon"></span>
                <span>Stats</span>
            </div>
            <div class="tab-item" data-view="rank" onclick="switchView('rank')">
                <span class="tab-icon"></span>
                <span>Rank</span>
            </div>
            <div class="tab-item" data-view="learn" onclick="switchView('learn')">
                <span class="tab-icon"></span>
                <span>Learn</span>
            </div>
            <div class="tab-item" data-view="profile" onclick="switchView('profile')">
                <span class="tab-icon"></span>
                <span>Profile</span>
            </div>
        </nav>
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="video-modal">
        <button class="video-modal-close" onclick="closeVideo()"></button>
        <div id="videoModalTitle" class="video-modal-title"></div>
        <div class="video-modal-content">
            <iframe id="videoFrame" allowfullscreen></iframe>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; padding: 20px; overflow-y: auto;">
        <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 400px; margin: 40px auto; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.1rem;"> Add TikTok Account</h3>
                <button onclick="hideAddAccountModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; line-height: 1.5;">
                Add another TikTok account to your profile. If the account has existing data, it will require admin verification to ensure account ownership.
            </p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary);">TikTok Handle</label>
                <div style="display: flex; align-items: center; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border); overflow: hidden;">
                    <span style="padding: 12px; color: var(--text-muted);">@</span>
                    <input type="text" id="newAccountHandle" placeholder="yourhandle" 
                        style="flex: 1; padding: 12px 12px 12px 0; background: transparent; border: none; color: var(--text-primary); font-size: 1rem; outline: none;">
                </div>
            </div>
            
            <div id="addAccountMessage" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem;"></div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="hideAddAccountModal()" style="flex: 1; padding: 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem; cursor: pointer;">Cancel</button>
                <button onclick="submitAccountRequest()" style="flex: 1; padding: 14px; background: var(--accent); border: none; border-radius: 10px; color: #000; font-weight: 600; font-size: 0.95rem; cursor: pointer;">Request</button>
            </div>
        </div>
    </div>

    <!-- Journal Entry Modal -->
    <div id="journalModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; padding: 20px; overflow-y: auto;">
        <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 450px; margin: 40px auto; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.1rem;"> Call Your Shot</h3>
                <button onclick="hideJournalModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;"></button>
            </div>
            
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; line-height: 1.5;">
                Set a goal, capture a reflection, or celebrate a milestone. Look back later to see how far you've come!
            </p>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary);">Type</label>
                <select id="journalEntryType" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem;">
                    <option value="goal"> Goal - Something I'm shooting for</option>
                    <option value="reflection"> Reflection - Thoughts on my journey</option>
                    <option value="milestone"> Milestone - Something I achieved</option>
                    <option value="gratitude"> Gratitude - Something I'm thankful for</option>
                    <option value="lesson"> Lesson - Something I learned</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary);">Your Entry</label>
                <textarea id="journalEntryText" placeholder="What's on your mind? Set a goal, share a win, or capture a thought..." 
                    style="width: 100%; padding: 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem; min-height: 120px; resize: vertical; font-family: inherit;"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="hideJournalModal()" style="flex: 1; padding: 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem; cursor: pointer;">Cancel</button>
                <button onclick="saveJournalEntry()" style="flex: 1; padding: 14px; background: var(--accent); border: none; border-radius: 10px; color: #000; font-weight: 600; font-size: 0.95rem; cursor: pointer;">Save Entry</button>
            </div>
        </div>
    </div>

    <!-- All Journal Entries Modal -->
    <div id="journalAllModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; padding: 20px; overflow-y: auto;">
        <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 500px; margin: 20px auto; border: 1px solid var(--border); max-height: calc(100vh - 40px); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: var(--bg-card); padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                <h3 id="journalAllModalTitle" style="font-size: 1.1rem;"> Your Journey</h3>
                <div style="display: flex; gap: 8px;">
                    <button id="journalAllAddBtn" onclick="showAddJournalModal(); hideAllJournalModal();" style="padding: 8px 12px; background: var(--accent); border: none; border-radius: 8px; color: #000; font-size: 0.85rem; font-weight: 600; cursor: pointer;">+ New</button>
                    <button onclick="hideAllJournalModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;"></button>
                </div>
            </div>
            
            <div id="allJournalEntries">
                <div class="empty-state"><div class="spinner" style="margin: 0 auto;"></div></div>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div id="videoPlayerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 1100;">
        <!-- Close button -->
        <button onclick="hideVideoPlayer()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 44px; height: 44px; border-radius: 50%; z-index: 10; display: flex; align-items: center; justify-content: center;"></button>
        
        <!-- Clickable overlay for closing -->
        <div id="videoPlayerOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div>
        
        <!-- Video Container -->
        <div style="position: relative; z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 16px 16px; pointer-events: none;">
            <!-- TikTok embed container -->
            <div id="videoPlayerEmbed" style="pointer-events: auto; width: 100%; max-width: 340px; height: 100%; max-height: 600px; background: #000; border-radius: 8px; overflow: hidden;">
                <!-- iframe loads here -->
            </div>
            
            <!-- Info bar below video -->
            <div style="pointer-events: auto; width: 100%; max-width: 340px; display: flex; justify-content: space-between; align-items: center; padding: 12px 0 0;">
                <div>
                    <div id="videoPlayerCreator" style="font-weight: 600; font-size: 0.95rem; color: white;"></div>
                    <div id="videoPlayerProduct" style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 2px;"></div>
                </div>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <div style="text-align: center;">
                        <div id="videoPlayerGmv" style="font-weight: 700; color: var(--success); font-size: 1.1rem;"></div>
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">GMV</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="videoPlayerOrders" style="font-weight: 700; color: white; font-size: 1.1rem;"></div>
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Orders</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://elrsgxlyejlkzjcnhmak.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscnNneGx5ZWpsa3pqY25obWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQ5OTUsImV4cCI6MjA3OTU5MDk5NX0.8XScMdGkFRqRIDMPY3gWS5tk0Z8NbGzDXuH1dsnBdZ0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Brand display names
        const BRAND_DISPLAY = {
            'catakor': 'Cata-Kor',
            'jiyu': 'JiYu',
            'physicians_choice': 'Physicians Choice',
            'peach_slices': 'Peach Slices',
            'yerba_magic': 'Yerba Magic',
            'toplux': 'Toplux Nutrition'
        };

        // Tier thresholds (30-day GMV) - matches admin dashboard
        const TIERS = [
            { name: 'Unranked', min: 0, max: 1999, class: 'tier-unranked', emoji: '' },
            { name: 'Bronze', min: 2000, max: 4999, class: 'tier-bronze', emoji: '' },
            { name: 'Silver', min: 5000, max: 19999, class: 'tier-silver', emoji: '' },
            { name: 'Gold', min: 20000, max: 49999, class: 'tier-gold', emoji: '' },
            { name: 'Platinum', min: 50000, max: Infinity, class: 'tier-platinum', emoji: '' }
        ];

        // Achievements
        const ACHIEVEMENTS = [
            { id: 'first_sale', icon: '', name: 'First Sale', check: (s) => s.totalOrders >= 1 },
            { id: 'ten_sales', icon: '', name: '10 Sales', check: (s) => s.totalOrders >= 10 },
            { id: 'hundred_sales', icon: '', name: '100 Sales', check: (s) => s.totalOrders >= 100 },
            { id: 'first_video', icon: '', name: 'First Video', check: (s) => s.totalVideos >= 1 },
            { id: 'ten_videos', icon: '', name: '10 Videos', check: (s) => s.totalVideos >= 10 },
            { id: 'fifty_videos', icon: '', name: '50 Videos', check: (s) => s.totalVideos >= 50 },
            { id: 'hundred_gmv', icon: '', name: '$100 GMV', check: (s) => s.totalGmv >= 100 },
            { id: 'thousand_gmv', icon: '', name: '$1K GMV', check: (s) => s.totalGmv >= 1000 },
            { id: 'five_k_gmv', icon: '', name: '$5K GMV', check: (s) => s.totalGmv >= 5000 },
            { id: 'bronze_tier', icon: '', name: 'Bronze', check: (s) => ['Bronze', 'Silver', 'Gold', 'Platinum'].includes(s.tier?.name) },
            { id: 'silver_tier', icon: '', name: 'Silver', check: (s) => ['Silver', 'Gold', 'Platinum'].includes(s.tier?.name) },
            { id: 'week_streak', icon: '', name: '7 Day Streak', check: (s) => s.streak >= 7 }
        ];

        // Pro tips (rotates randomly)
        const PRO_TIPS = [
            "Videos posted between 6-9 PM EST typically get 40% more views!",
            "Hook viewers in the first 3 seconds - that's when most people scroll away.",
            "Authentic reviews perform 3x better than scripted content.",
            "Respond to comments quickly to boost engagement.",
            "Use trending sounds to increase your reach.",
            "Post consistently - the algorithm rewards daily creators.",
            "Show the product in use within the first 5 seconds.",
            "Natural lighting makes your videos look more professional."
        ];

        // ==================== STATE ====================
        let currentUser = null;
        let currentProfile = null;
        let creatorProfiles = [];
        let currentBrand = 'all';
        let userStatus = 'unknown'; // 'accepted', 'pending', 'not_found'
        let currentView = 'home';
        let statsPeriod = 7;
        let homePeriod = 7;
        let statsChartInstance = null;
        
        // Admin mode
        let isAdmin = false;
        let allManagedCreators = []; // For admin dropdown
        let adminGroupedCreators = []; // Grouped creators for search/filter
        let pendingApplications = []; // Pending applications for admin view
        let viewingAsCreator = null; // Creator being viewed in admin mode

        // ==================== HELPERS ====================
        const fmtMoney = (n) => '$' + (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const fmtNum = (n) => (parseInt(n) || 0).toLocaleString();
        const pFloat = (v) => parseFloat(v) || 0;
        const pInt = (v) => parseInt(v) || 0;

        function getTier(gmv30d) {
            for (const tier of TIERS) {
                if (gmv30d >= tier.min && gmv30d <= tier.max) return tier;
            }
            return TIERS[0];
        }

        function localDateStr(d) {
            return d.toISOString().split('T')[0];
        }

        // ==================== AUTH (Supabase with Discord) ====================
        async function loginWithDiscord() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'discord',
                options: { redirectTo: window.location.origin + '/creator-portal.html' }
            });
            if (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        async function handleAuthStateChange() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session?.user) {
                showLoading();
                
                // Extract Discord info from Supabase user metadata
                const user = session.user;
                currentUser = {
                    id: user.user_metadata?.provider_id || user.id,
                    username: user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0],
                    global_name: user.user_metadata?.full_name || user.user_metadata?.name,
                    avatar: user.user_metadata?.avatar_url || null,
                    email: user.email
                };
                
                await loadCreatorData();
            } else {
                showLogin();
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentProfile = null;
            userStatus = 'unknown';
            showLogin();
        }

        // Listen for auth changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                handleAuthStateChange();
            } else if (event === 'SIGNED_OUT') {
                showLogin();
            }
        });

        // ==================== UI STATE ====================
        const loadingMessages = [
            "Counting your GMV...",
            "Loading your wins...",
            "Preparing your stats...",
            "Checking the leaderboard...",
            "Almost there..."
        ];
        let loadingMessageIndex = 0;
        let loadingMessageInterval = null;

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('appContainer').classList.remove('show');
            // Hide tab bar on login screen
            const tabBar = document.querySelector('.tab-bar');
            if (tabBar) tabBar.style.display = 'none';
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
                loadingMessageInterval = null;
            }
        }

        function showLoading() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('show');
            
            // Start rotating loading messages
            loadingMessageIndex = 0;
            const messageEl = document.getElementById('loadingMessage');
            messageEl.textContent = loadingMessages[0];
            
            if (loadingMessageInterval) clearInterval(loadingMessageInterval);
            loadingMessageInterval = setInterval(() => {
                loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
                messageEl.textContent = loadingMessages[loadingMessageIndex];
            }, 2000);
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('show');
            // Show tab bar when app is visible
            const tabBar = document.querySelector('.tab-bar');
            if (tabBar) tabBar.style.display = 'flex';
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
                loadingMessageInterval = null;
            }
        }

        function switchView(view) {
            currentView = view;
            
            // Update tabs
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            // Update views
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.toggle('active', section.id === `view-${view}`);
            });

            // Load view-specific data
            if (userStatus === 'accepted') {
                if (view === 'stats') loadStatsData();
                if (view === 'rank') loadAllLeaderboards();
                if (view === 'profile') loadProfileData();
                if (view === 'learn') {
                    loadAvailableCampaigns();
                    loadCreatorSpotlight();
                    updateBrandDiscordLink();
                    loadPortalFaq();
                    loadPortalResources();
                }
            }
        }

        function switchBrand(brand) {
            currentBrand = brand;
            
            // Update currentProfile if specific brand selected
            if (brand !== 'all' && creatorProfiles.length > 0) {
                currentProfile = creatorProfiles.find(p => p.brand === brand) || creatorProfiles[0];
            }
            
            // Reload current view data
            if (userStatus === 'accepted') {
                loadHomeData();
                if (currentView === 'stats') loadStatsData();
                if (currentView === 'rank') loadAllLeaderboards();
            }
        }

        // ==================== LOAD CREATOR DATA ====================
        async function loadCreatorData() {
            try {
                // First, check if user is an admin (from brand_portal_users)
                const { data: adminCheck } = await supabaseClient
                    .from('brand_portal_users')
                    .select('role')
                    .eq('discord_id', currentUser.id)
                    .single();
                
                if (adminCheck?.role === 'admin') {
                    isAdmin = true;
                    await setupAdminMode();
                    return;
                }
                
                // Get ALL managed_creators records for this discord_id (all statuses)
                // Note: This may fail with 406 for new applicants due to RLS - that's ok, we fall back to creator_applications
                let allProfiles = [];
                try {
                    const { data, error } = await supabaseClient
                        .from('managed_creators')
                        .select('*')
                        .eq('discord_id', currentUser.id)
                        .in('status', ['Active', 'Applied', 'Pending'])
                        .order('status', { ascending: true }); // Active first, then Applied, then Pending
                    
                    if (!error && data) {
                        allProfiles = data;
                    }
                } catch (e) {
                    console.log('managed_creators query failed (expected for new applicants):', e);
                }

                if (allProfiles && allProfiles.length > 0) {
                    // Separate by status
                    const activeProfiles = allProfiles.filter(p => p.status === 'Active');
                    const pendingProfiles = allProfiles.filter(p => p.status === 'Applied' || p.status === 'Pending');
                    
                    // Store all profiles for brand switcher
                    creatorProfiles = allProfiles;
                    
                    if (activeProfiles.length > 0) {
                        // Has at least one active brand - show full dashboard
                        userStatus = 'accepted';
                        currentProfile = activeProfiles[0];
                        currentBrand = activeProfiles.length === 1 ? activeProfiles[0].brand : 'all';
                        
                        setupBrandSwitcher();
                        showApp();
                        setupAcceptedUI();
                        loadHomeData();
                        
                        // If also has pending applications, show notification
                        if (pendingProfiles.length > 0) {
                            showPendingBrandsNotice(pendingProfiles);
                        }
                    } else {
                        // Only pending/applied - show application status UI
                        userStatus = 'pending';
                        currentProfile = pendingProfiles[0];
                        showApp();
                        setupApplicationStatusUI(pendingProfiles);
                    }
                } else {
                    // Check for legacy pending applications (in creator_applications but not managed_creators)
                    const { data: applications } = await supabaseClient
                        .from('creator_applications')
                        .select('*')
                        .eq('discord_id', currentUser.id)
                        .in('status', ['pending', 'reviewing', 'waitlist'])
                        .order('created_at', { ascending: false });

                    if (applications && applications.length > 0) {
                        userStatus = 'pending';
                        currentProfile = applications[0];
                        showApp();
                        setupPendingUI();
                    } else {
                        // No match found - show claim flow
                        userStatus = 'not_found';
                        showApp();
                        setupNotFoundUI();
                    }
                }

            } catch (err) {
                console.error('Error loading creator data:', err);
                showLogin();
            }
        }
        
        // Show notice for creators with pending applications for other brands
        function showPendingBrandsNotice(pendingProfiles) {
            const brandNames = pendingProfiles.map(p => BRAND_DISPLAY[p.brand] || p.brand).join(', ');
            const noticeHtml = `
                <div id="pendingBrandsNotice" style="background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.25rem;"></span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--accent);">Application${pendingProfiles.length > 1 ? 's' : ''} Pending</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Your application for ${brandNames} is under review</div>
                    </div>
                </div>
            `;
            const homeView = document.getElementById('view-home');
            if (homeView) {
                homeView.insertAdjacentHTML('afterbegin', noticeHtml);
            }
        }
        
        // UI for creators who only have pending/applied applications
        function setupApplicationStatusUI(pendingProfiles) {
            // Update header avatar
            const avatar = document.getElementById('headerAvatar');
            if (currentUser.avatar) {
                avatar.innerHTML = `<img src="${currentUser.avatar}" alt="">`;
            } else {
                avatar.textContent = currentUser.username?.charAt(0).toUpperCase() || '?';
            }

            document.getElementById('homeName').textContent = currentUser.global_name || currentUser.username;
            document.getElementById('homeSubtitle').textContent = 'Application Status';
            document.getElementById('homeTierBadge').style.display = 'none';

            // Build application status cards
            let cardsHtml = '<div class="application-status-list">';
            pendingProfiles.forEach(p => {
                const brandName = BRAND_DISPLAY[p.brand] || p.brand;
                const statusLabel = p.status === 'Applied' ? 'Submitted' : 'In Review';
                const statusIcon = p.status === 'Applied' ? '' : '';
                const appliedDate = p.applied_at ? new Date(p.applied_at).toLocaleDateString() : 'Recently';
                
                cardsHtml += `
                    <div class="application-status-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 1.5rem;">${statusIcon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1.1rem;">${brandName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Applied ${appliedDate}</div>
                            </div>
                            <span class="status-badge" style="background: var(--accent-dim); color: var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${statusLabel}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${p.status === 'Applied' 
                                ? "We've received your application and will review it shortly." 
                                : "Your application is currently being reviewed by our team."}
                        </div>
                    </div>
                `;
            });
            cardsHtml += '</div>';

            // Show in pending status card
            document.getElementById('pendingStatusCard').classList.remove('hidden');
            document.getElementById('pendingStatusCard').innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 3rem; margin-bottom: 8px;"></div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 8px;">Your Applications</h2>
                    <p style="color: var(--text-secondary);">Track the status of your creator applications</p>
                </div>
                ${cardsHtml}
                <div style="text-align: center; margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px;">Want to apply for another brand?</div>
                    <a href="/apply.html" style="color: var(--accent); text-decoration: none; font-weight: 600;">Browse Open Positions </a>
                </div>
            `;

            // Hide stats
            document.getElementById('homeStats').classList.add('hidden');
            document.getElementById('homePeriodSelector').classList.add('hidden');
            document.getElementById('homeStreakCard').classList.add('hidden');
            document.getElementById('homeJournalCard').classList.add('hidden');
            document.getElementById('homeWinningCard').classList.add('hidden');
            document.getElementById('homeRecentCard').classList.add('hidden');
            document.getElementById('homeMilestoneCard').classList.add('hidden');
            document.getElementById('proTipCard').classList.add('hidden');

            // Disable stats/rank tabs (but allow learn/profile)
            document.querySelector('.tab-item[data-view="stats"]')?.classList.add('disabled');
            document.querySelector('.tab-item[data-view="rank"]')?.classList.add('disabled');
        }
        
        // ==================== ADMIN MODE ====================
        async function setupAdminMode() {
            // Load all managed creators for the dropdown
            const { data: creators } = await supabaseClient
                .from('managed_creators')
                .select('id, account_1, account_2, account_3, account_4, account_5, account_6, account_7, account_8, account_9, account_10, real_name, brand, status, discord_id')
                .eq('status', 'Active')
                .order('account_1', { ascending: true });
            
            allManagedCreators = creators || [];
            
            // Also load pending applications
            const { data: pendingApps } = await supabaseClient
                .from('creator_applications')
                .select('id, full_name, tiktok_handle, brand, status, discord_id, discord_username')
                .in('status', ['pending', 'reviewing'])
                .order('created_at', { ascending: false });
            
            pendingApplications = pendingApps || [];
            
            // Group creators by identity (discord_id or account_1)
            const creatorGroups = {};
            const accountColumns = ['account_1', 'account_2', 'account_3', 'account_4', 'account_5',
                                    'account_6', 'account_7', 'account_8', 'account_9', 'account_10'];
            allManagedCreators.forEach(c => {
                // Group key: discord_id if available, otherwise first account
                const key = (c.discord_id && c.discord_id.trim()) 
                    ? `d_${c.discord_id}` 
                    : `a_${(c.account_1 || '').toLowerCase()}`;
                
                if (!creatorGroups[key]) {
                    creatorGroups[key] = {
                        key,
                        displayName: c.real_name || c.account_1,
                        primaryAccount: c.account_1,
                        brands: [],
                        accounts: new Set(),
                        records: [],
                        firstRecordId: c.id
                    };
                }
                
                creatorGroups[key].brands.push(c.brand);
                creatorGroups[key].records.push(c);
                
                // Collect all accounts (1-10)
                accountColumns.forEach(col => {
                    const a = c[col];
                    if (a && a.trim()) creatorGroups[key].accounts.add(a.toLowerCase());
                });
                
                // Use first record as the selection value
                if (!creatorGroups[key].firstRecordId) {
                    creatorGroups[key].firstRecordId = c.id;
                }
            });
            
            // Convert to array and sort by name
            const groupedCreators = Object.values(creatorGroups).sort((a, b) => 
                a.displayName.localeCompare(b.displayName)
            );
            
            // Store for filtering
            adminGroupedCreators = groupedCreators;
            
            // Populate creator dropdown
            populateAdminDropdown(groupedCreators);
            
            // Clear search
            document.getElementById('adminCreatorSearch').value = '';
            
            // Show admin banner
            document.getElementById('adminBanner').classList.add('show');
            
            // Update header avatar
            const avatar = document.getElementById('headerAvatar');
            if (currentUser.avatar) {
                avatar.innerHTML = `<img src="${currentUser.avatar}" alt="">`;
            } else {
                avatar.textContent = currentUser.username?.charAt(0).toUpperCase() || 'A';
            }
            
            // Show app in "select creator" state
            showApp();
            userStatus = 'accepted'; // Admin always has full access
            
            // Show empty state until creator selected
            document.getElementById('homeName').textContent = 'Admin';
            document.getElementById('homeSubtitle').textContent = 'Select a creator to view their portal';
            document.getElementById('homeTierBadge').style.display = 'none';
            document.getElementById('homeStats').classList.add('hidden');
            document.getElementById('homePeriodSelector').classList.add('hidden');
            document.getElementById('homeStreakCard').classList.add('hidden');
            document.getElementById('homeJournalCard').classList.add('hidden');
            document.getElementById('homeWinningCard').classList.add('hidden');
            document.getElementById('homeRecentCard').classList.add('hidden');
            document.getElementById('homeMilestoneCard').classList.add('hidden');
            document.getElementById('proTipCard').classList.add('hidden');
            
            // Enable all tabs
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('disabled'));
            
            // Check for URL parameter to auto-select creator
            const urlParams = new URLSearchParams(window.location.search);
            const creatorIdParam = urlParams.get('creator');
            if (creatorIdParam) {
                const select = document.getElementById('adminCreatorSelect');
                select.value = creatorIdParam;
                if (select.value === creatorIdParam) {
                    // Valid creator ID, trigger the switch
                    switchViewingCreator();
                }
            }
        }
        
        function populateAdminDropdown(creators) {
            const select = document.getElementById('adminCreatorSelect');
            select.innerHTML = '<option value="">Select creator...</option>';
            
            // Add pending applications first if any
            if (pendingApplications && pendingApplications.length > 0) {
                const optGroup = document.createElement('optgroup');
                optGroup.label = ` Pending Applications (${pendingApplications.length})`;
                
                pendingApplications.forEach(app => {
                    const opt = document.createElement('option');
                    opt.value = `app_${app.id}`;
                    opt.textContent = `${app.full_name || app.discord_username || 'Unknown'} - @${app.tiktok_handle} (${BRAND_DISPLAY[app.brand] || app.brand})`;
                    opt.dataset.search = `${app.full_name} ${app.tiktok_handle} ${app.brand}`.toLowerCase();
                    opt.style.color = 'var(--accent)';
                    optGroup.appendChild(opt);
                });
                
                select.appendChild(optGroup);
            }
            
            // Add active creators
            if (creators.length > 0) {
                const optGroup = document.createElement('optgroup');
                optGroup.label = ` Active Creators (${creators.length})`;
                
                creators.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.firstRecordId;
                    
                    // Show name, primary account, and brand count
                    const accountsArray = Array.from(g.accounts);
                    const accountDisplay = accountsArray.length > 1 
                        ? `@${g.primaryAccount} +${accountsArray.length - 1}` 
                        : `@${g.primaryAccount}`;
                    const brandDisplay = g.brands.length > 1 
                        ? `(${g.brands.length} brands)` 
                        : `(${BRAND_DISPLAY[g.brands[0]] || g.brands[0]})`;
                    
                    opt.textContent = `${g.displayName} - ${accountDisplay} ${brandDisplay}`;
                    
                    // Store searchable text as data attribute
                    opt.dataset.search = `${g.displayName} ${g.primaryAccount} ${Array.from(g.accounts).join(' ')} ${g.brands.join(' ')}`.toLowerCase();
                    
                    optGroup.appendChild(opt);
                });
                
                select.appendChild(optGroup);
            }
        }
        
        function filterAdminCreatorDropdown() {
            const searchTerm = document.getElementById('adminCreatorSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // No search, show all
                populateAdminDropdown(adminGroupedCreators);
                return;
            }
            
            // Filter grouped creators
            const filtered = adminGroupedCreators.filter(g => {
                const searchText = `${g.displayName} ${g.primaryAccount} ${Array.from(g.accounts).join(' ')} ${g.brands.join(' ')}`.toLowerCase();
                return searchText.includes(searchTerm);
            });
            
            populateAdminDropdown(filtered);
        }
        
        async function switchViewingCreator() {
            const creatorId = document.getElementById('adminCreatorSelect').value;
            if (!creatorId) return;
            
            // Check if this is a pending application
            if (creatorId.startsWith('app_')) {
                const appId = creatorId.replace('app_', '');
                const app = pendingApplications.find(a => a.id == appId);
                if (app) {
                    // Show what the creator would see
                    viewingAsCreator = {
                        isApplication: true,
                        ...app,
                        real_name: app.full_name,
                        account_1: app.tiktok_handle
                    };
                    
                    // Update UI to show pending state
                    document.getElementById('homeName').textContent = app.full_name || app.discord_username || 'Applicant';
                    document.getElementById('homeSubtitle').textContent = 'Application Status';
                    document.getElementById('homeTierBadge').style.display = 'none';
                    
                    // Build the pending UI that creator would see
                    const brandName = BRAND_DISPLAY[app.brand] || app.brand;
                    const appliedDate = app.created_at ? new Date(app.created_at).toLocaleDateString() : 'Recently';
                    const statusLabel = app.status === 'pending' ? 'Under Review' 
                        : app.status === 'reviewing' ? 'In Review' 
                        : app.status === 'waitlist' ? 'Waitlisted'
                        : 'Submitted';
                    
                    document.getElementById('pendingStatusCard').classList.remove('hidden');
                    document.getElementById('pendingStatusCard').innerHTML = `
                        <div style="background: var(--accent-dim); border: 1px solid var(--accent); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem;">
                             <strong>Admin Preview</strong> - This is what the creator sees
                            <button onclick="window.open('/admin.html#applications', '_blank')" style="float: right; background: var(--accent); color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Approve in Admin </button>
                        </div>
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 3rem; margin-bottom: 8px;"></div>
                            <h2 style="font-size: 1.5rem; margin-bottom: 8px;">Application ${statusLabel}</h2>
                            <p style="color: var(--text-secondary);">We're reviewing your application</p>
                        </div>
                        <div class="application-status-card" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 1.5rem;"></span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 1.1rem;">${brandName}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">Applied ${appliedDate}</div>
                                </div>
                                <span style="background: var(--accent-dim); color: var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${statusLabel}</span>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                Our team typically reviews applications within 48 hours. You'll get full dashboard access once approved!
                            </div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Application Details</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem;">
                                <div><span style="color: var(--text-muted);">TikTok:</span> @${app.tiktok_handle || 'N/A'}</div>
                                <div><span style="color: var(--text-muted);">Email:</span> ${app.email || 'N/A'}</div>
                                <div><span style="color: var(--text-muted);">Followers:</span> ${app.follower_count || 'N/A'}</div>
                                <div><span style="color: var(--text-muted);">Discord:</span> ${app.discord_username || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                    
                    // Hide stats sections
                    document.getElementById('homeStats').classList.add('hidden');
                    document.getElementById('homePeriodSelector').classList.add('hidden');
                    document.getElementById('homeStreakCard').classList.add('hidden');
                    document.getElementById('homeJournalCard').classList.add('hidden');
                    document.getElementById('homeWinningCard').classList.add('hidden');
                    document.getElementById('homeRecentCard').classList.add('hidden');
                    document.getElementById('homeMilestoneCard')?.classList.add('hidden');
                    document.getElementById('proTipCard')?.classList.add('hidden');
                    
                    // Switch to home view
                    switchView('home');
                }
                return;
            }
            
            // Find selected creator
            const creator = allManagedCreators.find(c => c.id == creatorId);
            if (!creator) return;
            
            viewingAsCreator = creator;
            
            // Load this creator's full profile by ID first
            const { data: fullProfile } = await supabaseClient
                .from('managed_creators')
                .select('*')
                .eq('id', creatorId)
                .single();
            
            if (!fullProfile) {
                console.error('Could not load creator profile');
                return;
            }
            
            // Find all related profiles for this creator
            let multiBrandProfiles = [];
            
            if (fullProfile.discord_id && fullProfile.discord_id.trim()) {
                // If has discord_id, find all profiles with same discord_id
                const { data } = await supabaseClient
                    .from('managed_creators')
                    .select('*')
                    .eq('discord_id', fullProfile.discord_id)
                    .eq('status', 'Active');
                multiBrandProfiles = data || [];
            }
            
            // If no discord_id match or no results, try matching by accounts
            if (multiBrandProfiles.length === 0) {
                // Collect all accounts from this profile (1-10)
                const accountCols = ['account_1', 'account_2', 'account_3', 'account_4', 'account_5',
                                     'account_6', 'account_7', 'account_8', 'account_9', 'account_10'];
                const accounts = accountCols
                    .map(col => fullProfile[col])
                    .filter(a => a && a.trim())
                    .map(a => a.toLowerCase());
                
                if (accounts.length > 0) {
                    // Build OR query to find any matching accounts (check all 10 columns)
                    const orConditions = accounts.map(a => 
                        `account_1.ilike.${a},account_2.ilike.${a},account_3.ilike.${a},account_4.ilike.${a},account_5.ilike.${a},account_6.ilike.${a},account_7.ilike.${a},account_8.ilike.${a},account_9.ilike.${a},account_10.ilike.${a}`
                    ).join(',');
                    
                    const { data } = await supabaseClient
                        .from('managed_creators')
                        .select('*')
                        .or(orConditions)
                        .eq('status', 'Active');
                    multiBrandProfiles = data || [];
                }
            }
            
            creatorProfiles = multiBrandProfiles.length > 0 ? multiBrandProfiles : [fullProfile];
            currentProfile = creatorProfiles.find(p => p.id == creatorId) || creatorProfiles[0];
            currentBrand = creatorProfiles.length === 1 ? creatorProfiles[0].brand : 'all';
            
            // Setup UI
            setupBrandSwitcher();
            setupAcceptedUI();
            
            // Make sure admin banner stays visible
            document.getElementById('adminBanner').classList.add('show');
            
            // Load home data
            loadHomeData();
            
            // If on another tab, reload that tab's data
            if (currentView === 'stats') loadStatsData();
            if (currentView === 'rank') loadAllLeaderboards();
            if (currentView === 'profile') loadProfileData();
        }
        
        function exitAdminMode() {
            // Clear admin state
            viewingAsCreator = null;
            creatorProfiles = [];
            currentProfile = null;
            
            // Hide banner
            document.getElementById('adminBanner').classList.remove('show');
            
            // Reset to admin select state
            setupAdminMode();
        }

        function setupBrandSwitcher() {
            const switcher = document.getElementById('brandSwitcher');
            switcher.innerHTML = '';
            
            // Filter to only active profiles for the switcher (pending ones shown in notice)
            const activeProfiles = creatorProfiles.filter(p => p.status === 'Active');
            
            if (activeProfiles.length > 1) {
                switcher.innerHTML += '<option value="all">All Brands</option>';
            }
            
            activeProfiles.forEach(p => {
                switcher.innerHTML += `<option value="${p.brand}">${BRAND_DISPLAY[p.brand] || p.brand}</option>`;
            });
            
            switcher.value = currentBrand;
            switcher.style.display = activeProfiles.length > 1 ? 'block' : 'none';
            
            // If single brand, show brand name as header text
            if (activeProfiles.length === 1) {
                const headerLeft = document.querySelector('.header-left');
                // Remove existing brand text if any
                const existingBrandText = headerLeft.querySelector('.header-brand');
                if (existingBrandText) existingBrandText.remove();
                
                const brandText = document.createElement('span');
                brandText.className = 'header-brand';
                brandText.textContent = BRAND_DISPLAY[activeProfiles[0].brand] || activeProfiles[0].brand;
                headerLeft.appendChild(brandText);
            }
        }

        function setupAcceptedUI() {
            // Update header avatar
            const avatar = document.getElementById('headerAvatar');
            if (currentUser.avatar) {
                avatar.innerHTML = `<img src="${currentUser.avatar}" alt="">`;
            } else {
                avatar.textContent = currentUser.username?.charAt(0).toUpperCase() || '?';
            }

            // Show all sections
            document.getElementById('homeStats').classList.remove('hidden');
            document.getElementById('homePeriodSelector').classList.remove('hidden');
            document.getElementById('homeStreakCard').classList.remove('hidden');
            document.getElementById('homeJournalCard').classList.remove('hidden');
            document.getElementById('homeWinningCard').classList.remove('hidden');
            document.getElementById('homeRecentCard').classList.remove('hidden');
            document.getElementById('pendingStatusCard').classList.add('hidden');

            // Enable all tabs
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('disabled'));
            
            // Initialize date range displays
            updateDateRangeDisplay('homeDateRangeText', homePeriod);
            updateDateRangeDisplay('statsDateRangeText', statsPeriod, statsPeriod === 'all');
            
            // Initialize rank date range (uses different format)
            document.getElementById('rankDateRangeText').textContent = formatRankDateRange(rankPeriod);
            
            // Initialize section period labels
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const startDate = new Date(yesterday);
            startDate.setDate(yesterday.getDate() - (homePeriod - 1));
            const dateRangeText = formatDateRange(startDate, yesterday);
            
            const winningLabel = document.getElementById('winningPeriodLabel');
            const recentLabel = document.getElementById('recentPeriodLabel');
            if (winningLabel) winningLabel.textContent = dateRangeText;
            if (recentLabel) recentLabel.textContent = dateRangeText;
        }

        function setupPendingUI() {
            // Update header avatar
            const avatar = document.getElementById('headerAvatar');
            if (currentUser.avatar) {
                avatar.innerHTML = `<img src="${currentUser.avatar}" alt="">`;
            } else {
                avatar.textContent = currentUser.username?.charAt(0).toUpperCase() || '?';
            }

            // Update home
            document.getElementById('homeName').textContent = currentUser.global_name || currentUser.username;
            document.getElementById('homeSubtitle').textContent = 'Application Status';
            document.getElementById('homeTierBadge').style.display = 'none';

            // Get application details
            const brandName = BRAND_DISPLAY[currentProfile?.brand] || currentProfile?.brand || 'Unknown';
            const appliedDate = currentProfile?.created_at ? new Date(currentProfile.created_at).toLocaleDateString() : 'Recently';
            const statusLabel = currentProfile?.status === 'pending' ? 'Under Review' 
                : currentProfile?.status === 'reviewing' ? 'In Review' 
                : currentProfile?.status === 'waitlist' ? 'Waitlisted'
                : 'Submitted';

            // Show detailed pending card
            document.getElementById('pendingStatusCard').classList.remove('hidden');
            document.getElementById('pendingStatusCard').innerHTML = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 3rem; margin-bottom: 8px;"></div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 8px;">Application ${statusLabel}</h2>
                    <p style="color: var(--text-secondary);">We're reviewing your application</p>
                </div>
                <div class="application-status-card" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 1.5rem;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1.1rem;">${brandName}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Applied ${appliedDate}</div>
                        </div>
                        <span style="background: var(--accent-dim); color: var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${statusLabel}</span>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        Our team typically reviews applications within 48 hours. You'll get full dashboard access once approved!
                    </div>
                </div>
                <div class="pending-steps" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 16px;">
                    <div class="pending-step complete" style="width: 40px; height: 4px; background: var(--success); border-radius: 2px;"></div>
                    <div class="pending-step current" style="width: 40px; height: 4px; background: var(--accent); border-radius: 2px;"></div>
                    <div class="pending-step" style="width: 40px; height: 4px; background: var(--border); border-radius: 2px;"></div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--bg-card); border-radius: 12px;">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px;">Want to apply for another brand?</div>
                    <a href="/apply.html" style="color: var(--accent); text-decoration: none; font-weight: 600;">Browse Open Positions </a>
                </div>
            `;

            // Hide stats
            document.getElementById('homeStats').classList.add('hidden');
            document.getElementById('homePeriodSelector').classList.add('hidden');
            document.getElementById('homeStreakCard').classList.add('hidden');
            document.getElementById('homeJournalCard').classList.add('hidden');
            document.getElementById('homeWinningCard').classList.add('hidden');
            document.getElementById('homeRecentCard').classList.add('hidden');
            document.getElementById('homeMilestoneCard').classList.add('hidden');
            document.getElementById('proTipCard').classList.add('hidden');

            // Disable stats/rank tabs (but allow learn/profile)
            document.querySelector('.tab-item[data-view="stats"]')?.classList.add('disabled');
            document.querySelector('.tab-item[data-view="rank"]')?.classList.add('disabled');
        }

        async function setupNotFoundUI() {
            const avatar = document.getElementById('headerAvatar');
            if (currentUser.avatar) {
                avatar.innerHTML = `<img src="${currentUser.avatar}" alt="">`;
            } else {
                avatar.textContent = currentUser.username?.charAt(0).toUpperCase() || '?';
            }
            
            document.getElementById('homeName').textContent = currentUser.global_name || currentUser.username;
            document.getElementById('homeSubtitle').textContent = 'Link your account';
            document.getElementById('homeTierBadge').style.display = 'none';

            // Check for existing pending claim request
            const discordId = currentUser.user_metadata?.provider_id || currentUser.id;
            const { data: existingClaim } = await supabaseClient
                .from('creator_claim_requests')
                .select('*')
                .eq('discord_id', discordId)
                .eq('status', 'pending')
                .single();

            if (existingClaim) {
                // Show pending verification message
                showClaimPending(existingClaim);
            } else {
                // Show claim flow
                showClaimStep1();
            }

            document.getElementById('homeStats').classList.add('hidden');
            document.getElementById('homePeriodSelector').classList.add('hidden');
            document.getElementById('homeStreakCard').classList.add('hidden');
            document.getElementById('homeJournalCard').classList.add('hidden');
            document.getElementById('homeWinningCard').classList.add('hidden');
            document.getElementById('homeRecentCard').classList.add('hidden');
            document.getElementById('homeMilestoneCard').classList.add('hidden');

            // Disable all tabs except learn
            document.querySelector('.tab-item[data-view="stats"]')?.classList.add('disabled');
            document.querySelector('.tab-item[data-view="rank"]')?.classList.add('disabled');
            document.querySelector('.tab-item[data-view="profile"]')?.classList.add('disabled');
        }

        // ==================== CLAIM FLOW ====================
        let claimFoundRecords = [];
        let claimManagedCreatorIds = [];

        function showClaimStep1() {
            document.getElementById('pendingStatusCard').classList.remove('hidden');
            document.getElementById('pendingStatusCard').innerHTML = `
                <div class="claim-flow">
                    <div class="claim-step-indicator">
                        <div class="claim-step active">1</div>
                        <div class="claim-step-line"></div>
                        <div class="claim-step">2</div>
                        <div class="claim-step-line"></div>
                        <div class="claim-step">3</div>
                    </div>
                    <div class="pending-icon"></div>
                    <h2 class="pending-title">Claim Your Account</h2>
                    <p class="pending-message">Already a creator? Enter any ONE of your TikTok handles to link your account.</p>
                    <div class="claim-input-wrapper">
                        <span class="claim-at">@</span>
                        <input type="text" id="claimHandleInput" class="claim-input" placeholder="yourtiktokhandle" autocomplete="off">
                    </div>
                    <button class="claim-btn primary" onclick="searchClaimHandle()">
                        <span>Find My Account</span>
                        <span class="claim-btn-icon"></span>
                    </button>
                    <div class="claim-divider">
                        <span>or</span>
                    </div>
                    <a href="apply.html" class="claim-btn secondary">I'm a new creator - Apply here</a>
                </div>
            `;

            // Auto-focus input
            setTimeout(() => {
                document.getElementById('claimHandleInput')?.focus();
            }, 100);

            // Enter key handler
            document.getElementById('claimHandleInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchClaimHandle();
            });
        }

        async function searchClaimHandle() {
            const input = document.getElementById('claimHandleInput');
            let handle = input?.value?.trim().toLowerCase() || '';
            
            // Remove @ if present
            if (handle.startsWith('@')) handle = handle.substring(1);
            
            if (!handle) {
                showToast('Please enter a TikTok handle', 'error');
                return;
            }

            // Show loading
            const btn = document.querySelector('.claim-btn.primary');
            btn.innerHTML = '<span class="loading-spinner"></span> Searching...';
            btn.disabled = true;

            try {
                // Search managed_creators for this handle in any account column (1-10)
                const { data: found, error } = await supabaseClient
                    .from('managed_creators')
                    .select('*')
                    .or(`account_1.ilike.${handle},account_2.ilike.${handle},account_3.ilike.${handle},account_4.ilike.${handle},account_5.ilike.${handle},account_6.ilike.${handle},account_7.ilike.${handle},account_8.ilike.${handle},account_9.ilike.${handle},account_10.ilike.${handle}`)
                    .eq('status', 'Active');

                if (error) throw error;

                if (!found || found.length === 0) {
                    showClaimNotFound(handle);
                    return;
                }

                // Check if any of these are already linked to a Discord
                const alreadyLinked = found.filter(r => r.discord_id && r.discord_id.trim());
                if (alreadyLinked.length > 0) {
                    showClaimAlreadyLinked(handle, alreadyLinked);
                    return;
                }

                // Get GMV for each record
                const accountColumns = ['account_1', 'account_2', 'account_3', 'account_4', 'account_5',
                                        'account_6', 'account_7', 'account_8', 'account_9', 'account_10'];
                const recordsWithGmv = await Promise.all(found.map(async (record) => {
                    const handles = accountColumns
                        .map(col => record[col])
                        .filter(h => h && h.trim());
                    
                    let perfQuery = supabaseClient
                        .from('creator_performance')
                        .select('gmv')
                        .eq('period_type', 'daily');
                    
                    perfQuery = applyHandleFilter(perfQuery, handles);
                    
                    const { data: perfData } = await perfQuery;
                    
                    const totalGmv = (perfData || []).reduce((sum, r) => sum + (parseFloat(r.gmv) || 0), 0);
                    
                    return {
                        id: record.id,
                        brand: record.brand,
                        accounts: handles,
                        status: record.status,
                        gmv: totalGmv,
                        real_name: record.real_name
                    };
                }));

                claimFoundRecords = recordsWithGmv;
                claimManagedCreatorIds = found.map(r => r.id);
                
                showClaimStep2(handle, recordsWithGmv);

            } catch (err) {
                console.error('Error searching for handle:', err);
                showToast('Error searching. Please try again.', 'error');
                btn.innerHTML = '<span>Find My Account</span><span class="claim-btn-icon"></span>';
                btn.disabled = false;
            }
        }

        function showClaimStep2(handle, records) {
            const totalAccounts = records.reduce((sum, r) => sum + r.accounts.length, 0);
            const totalGmv = records.reduce((sum, r) => sum + r.gmv, 0);

            document.getElementById('pendingStatusCard').innerHTML = `
                <div class="claim-flow">
                    <div class="claim-step-indicator">
                        <div class="claim-step completed"></div>
                        <div class="claim-step-line active"></div>
                        <div class="claim-step active">2</div>
                        <div class="claim-step-line"></div>
                        <div class="claim-step">3</div>
                    </div>
                    <div class="pending-icon"></div>
                    <h2 class="pending-title">We Found You!</h2>
                    <p class="pending-message">
                        We found <strong>${records.length} brand${records.length > 1 ? ' partnerships' : ''}</strong> with <strong>${totalAccounts} account${totalAccounts > 1 ? 's' : ''}</strong>
                    </p>
                    
                    <div class="claim-records">
                        ${records.map(r => `
                            <div class="claim-record-card">
                                <div class="claim-record-header">
                                    <span class="claim-brand-name">${BRAND_DISPLAY[r.brand] || r.brand}</span>
                                    <span class="claim-status-badge"> Active</span>
                                </div>
                                <div class="claim-accounts">
                                    ${r.accounts.map(a => `<span class="claim-account-tag">@${a}</span>`).join('')}
                                </div>
                                ${r.gmv > 0 ? `<div class="claim-gmv">$${r.gmv.toLocaleString()} GMV</div>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div class="claim-verify-notice">
                        <div class="claim-verify-icon"></div>
                        <div class="claim-verify-text">
                            <strong>Verification Required</strong>
                            <span>An admin will verify this is you before granting access. Usually takes less than 24 hours.</span>
                        </div>
                    </div>

                    <button class="claim-btn primary" onclick="submitClaimRequest('${handle}')">
                        <span>Submit for Verification</span>
                        <span class="claim-btn-icon"></span>
                    </button>
                    <button class="claim-btn secondary" onclick="showClaimStep1()"> This isn't me</button>
                </div>
            `;
        }

        function showClaimNotFound(handle) {
            document.getElementById('pendingStatusCard').innerHTML = `
                <div class="claim-flow">
                    <div class="pending-icon"></div>
                    <h2 class="pending-title">Handle Not Found</h2>
                    <p class="pending-message">
                        We couldn't find <strong>@${handle}</strong> in our creator roster. 
                        This might mean you're a new creator, or the handle is spelled differently in our system.
                    </p>
                    <button class="claim-btn primary" onclick="showClaimStep1()">
                        <span>Try Another Handle</span>
                    </button>
                    <div class="claim-divider">
                        <span>or</span>
                    </div>
                    <a href="apply.html" class="claim-btn secondary">Apply as New Creator</a>
                </div>
            `;
        }

        function showClaimAlreadyLinked(handle, linkedRecords) {
            document.getElementById('pendingStatusCard').innerHTML = `
                <div class="claim-flow">
                    <div class="pending-icon"></div>
                    <h2 class="pending-title">Already Linked</h2>
                    <p class="pending-message">
                        <strong>@${handle}</strong> is already linked to another Discord account. 
                        If this is your account, please contact support in Discord.
                    </p>
                    <button class="claim-btn primary" onclick="showClaimStep1()">
                        <span>Try Another Handle</span>
                    </button>
                    <a href="https://discord.gg/creatorscorner" target="_blank" class="claim-btn secondary">Contact Support</a>
                </div>
            `;
        }

        async function submitClaimRequest(searchedHandle) {
            const btn = document.querySelector('.claim-btn.primary');
            btn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
            btn.disabled = true;

            try {
                const discordId = currentUser.user_metadata?.provider_id || currentUser.id;
                
                // Convert IDs to strings for storage
                const creatorIds = claimManagedCreatorIds.map(id => String(id));
                
                const { error } = await supabaseClient.from('creator_claim_requests').insert({
                    discord_id: discordId,
                    discord_username: currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || currentUser.email,
                    discord_email: currentUser.email,
                    discord_avatar: currentUser.user_metadata?.avatar_url,
                    searched_handle: searchedHandle,
                    found_records: claimFoundRecords,
                    managed_creator_ids: creatorIds,
                    status: 'pending'
                });

                if (error) throw error;

                showClaimStep3();

            } catch (err) {
                console.error('Error submitting claim:', err);
                if (err.message?.includes('duplicate')) {
                    alert('You already have a pending request');
                } else {
                    alert('Error submitting request. Please try again.');
                }
                btn.innerHTML = '<span>Submit for Verification</span><span class="claim-btn-icon"></span>';
                btn.disabled = false;
            }
        }

        function showClaimStep3() {
            document.getElementById('pendingStatusCard').innerHTML = `
                <div class="claim-flow">
                    <div class="claim-step-indicator">
                        <div class="claim-step completed"></div>
                        <div class="claim-step-line active"></div>
                        <div class="claim-step completed"></div>
                        <div class="claim-step-line active"></div>
                        <div class="claim-step completed"></div>
                    </div>
                    <div class="pending-icon"></div>
                    <h2 class="pending-title">Verification Pending</h2>
                    <p class="pending-message">
                        Your request has been submitted! An admin will review and approve your account shortly.
                    </p>
                    <div class="claim-success-notice">
                        <div class="claim-success-icon"></div>
                        <div class="claim-success-text">We'll DM you on Discord when you're approved!</div>
                    </div>
                    <button class="claim-btn secondary" onclick="window.location.reload()">Check Status</button>
                </div>
            `;
        }

        function showClaimPending(existingClaim) {
            const records = existingClaim.found_records || [];
            const totalBrands = records.length;
            const totalAccounts = records.reduce((sum, r) => sum + (r.accounts?.length || 0), 0);

            document.getElementById('pendingStatusCard').classList.remove('hidden');
            document.getElementById('pendingStatusCard').innerHTML = `
                <div class="claim-flow">
                    <div class="pending-icon"></div>
                    <h2 class="pending-title">Verification Pending</h2>
                    <p class="pending-message">
                        Your request to link <strong>${totalBrands} brand${totalBrands > 1 ? 's' : ''}</strong> with <strong>${totalAccounts} account${totalAccounts > 1 ? 's' : ''}</strong> is being reviewed.
                    </p>
                    <div class="claim-pending-time">
                        Submitted ${formatTimeAgo(new Date(existingClaim.created_at))}
                    </div>
                    <div class="claim-success-notice">
                        <div class="claim-success-icon"></div>
                        <div class="claim-success-text">We'll DM you on Discord when you're approved!</div>
                    </div>
                    <button class="claim-btn secondary" onclick="window.location.reload()">Refresh Status</button>
                </div>
            `;
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        // ==================== HOME DATA ====================
        async function loadHomeData() {
            if (userStatus !== 'accepted') return;

            // Get creator handles
            const handles = getCreatorHandles();
            if (handles.length === 0) return;

            // Update name
            document.getElementById('homeName').textContent = currentProfile.real_name || currentUser.global_name || currentUser.username;

            // Fetch performance data (selected period + prior period for comparison)
            // Use yesterday as end date since today's data is incomplete
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const periodStart = new Date(yesterday);
            periodStart.setDate(yesterday.getDate() - (homePeriod - 1));
            const priorEnd = new Date(periodStart);
            priorEnd.setDate(priorEnd.getDate() - 1);
            const priorStart = new Date(priorEnd);
            priorStart.setDate(priorEnd.getDate() - (homePeriod - 1));
            
            // Get date strings for comparison (avoids timezone/time issues)
            const periodStartStr = localDateStr(periodStart);

            let query = supabaseClient
                .from('creator_performance')
                .select('creator_name, brand, gmv, orders, videos, report_date')
                .gte('report_date', localDateStr(priorStart))
                .lte('report_date', localDateStr(yesterday))
                .eq('period_type', 'daily');
            
            // Filter by brand (we'll filter by handle client-side for case-insensitive matching)
            if (currentBrand !== 'all') {
                query = query.eq('brand', currentBrand);
            }

            const { data: perfData } = await query;
            
            // Create lowercase handle set for matching
            const handleSet = new Set(handles.map(h => h.toLowerCase()));

            // Calculate current and prior period GMV/Orders/Videos
            // Videos come from the 'videos' column in creator_performance (source of truth from Creator_Data)
            let currentGmv = 0, currentOrders = 0, currentVideos = 0;
            let priorGmv = 0, priorOrders = 0;

            (perfData || []).forEach(r => {
                // Case-insensitive handle matching
                if (!handleSet.has(r.creator_name.toLowerCase())) return;
                
                // Compare date strings directly (avoids timezone issues)
                if (r.report_date >= periodStartStr) {
                    currentGmv += pFloat(r.gmv);
                    currentOrders += pInt(r.orders);
                    currentVideos += pInt(r.videos);
                } else {
                    priorGmv += pFloat(r.gmv);
                    priorOrders += pInt(r.orders);
                }
            });

            // Update UI with animation
            animateStatValue('homeGmv', fmtMoney(currentGmv));
            animateStatValue('homeOrders', fmtNum(currentOrders));
            animateStatValue('homeVideos', fmtNum(currentVideos));

            // Change indicators
            const periodLabel = homePeriod === 7 ? 'vs last week' : `vs prior ${homePeriod}d`;
            updateChangeIndicator('homeGmvChange', currentGmv, priorGmv, periodLabel);
            updateChangeIndicator('homeOrdersChange', currentOrders, priorOrders);

            // Dynamic subtitle based on performance
            updateDynamicSubtitle(currentGmv, priorGmv);

            // Calculate 30-day GMV for tier (yesterday back 30 days)
            const thirtyDaysAgo = new Date(yesterday);
            thirtyDaysAgo.setDate(yesterday.getDate() - 29);
            
            let thirtyDayQuery = supabaseClient
                .from('creator_performance')
                .select('creator_name, gmv')
                .gte('report_date', localDateStr(thirtyDaysAgo))
                .lte('report_date', localDateStr(yesterday))
                .eq('period_type', 'daily');
            
            if (currentBrand !== 'all') {
                thirtyDayQuery = thirtyDayQuery.eq('brand', currentBrand);
            }

            const { data: thirtyDayData } = await thirtyDayQuery;
            const gmv30d = (thirtyDayData || [])
                .filter(r => handleSet.has(r.creator_name.toLowerCase()))
                .reduce((s, r) => s + pFloat(r.gmv), 0);
            const tier = getTier(gmv30d);

            const tierBadge = document.getElementById('homeTierBadge');
            tierBadge.textContent = tier.emoji ? `${tier.emoji} ${tier.name}` : tier.name;
            tierBadge.className = `tier-badge ${tier.class}`;

            // Update milestone progress
            updateMilestoneProgress(gmv30d, tier);

            // Load all-time GMV
            loadAllTimeGmv(handles);

            // Load other sections
            loadStreak(handles);
            loadJournalEntries();
            loadWhatsWinning();
            loadRecentVideos(handles);
            loadRankPosition(handles);

            // Contextual pro tip
            setContextualProTip(currentGmv, currentVideos);
        }

        // Animate stat values with subtle entrance
        function animateStatValue(elId, value) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.textContent = value;
            el.classList.remove('animate');
            void el.offsetWidth; // Trigger reflow
            el.classList.add('animate');
        }

        // Dynamic subtitle based on performance
        function updateDynamicSubtitle(currentGmv, priorGmv) {
            const subtitle = document.getElementById('homeSubtitle');
            if (priorGmv > 0 && currentGmv > 0) {
                const change = ((currentGmv - priorGmv) / priorGmv * 100).toFixed(0);
                if (change >= 20) {
                    subtitle.textContent = `You're up ${change}% this period! `;
                } else if (change >= 0) {
                    subtitle.textContent = `Steady growth - up ${change}%! `;
                } else if (change >= -20) {
                    subtitle.textContent = "Let's get back on track this week ";
                } else {
                    subtitle.textContent = "Time to turn it around! You got this ";
                }
            } else if (currentGmv > 0) {
                subtitle.textContent = "Great progress! Keep the momentum going ";
            } else {
                subtitle.textContent = "Let's crush it today";
            }
        }

        // Update milestone progress card
        function updateMilestoneProgress(gmv30d, currentTier) {
            const card = document.getElementById('homeMilestoneCard');
            const title = document.getElementById('milestoneTitle');
            const subtitle = document.getElementById('milestoneSubtitle');
            const progress = document.getElementById('milestoneProgress');
            const bar = document.getElementById('milestoneBar');

            // Define tier thresholds - matches admin dashboard
            const tiers = [
                { name: 'Unranked', threshold: 0 },
                { name: 'Bronze', threshold: 2000 },
                { name: 'Silver', threshold: 5000 },
                { name: 'Gold', threshold: 20000 },
                { name: 'Platinum', threshold: 50000 }
            ];

            // Find next tier
            let nextTier = null;
            for (const tier of tiers) {
                if (gmv30d < tier.threshold) {
                    nextTier = tier;
                    break;
                }
            }

            if (!nextTier) {
                // Already at max tier
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            
            // Find current tier threshold for progress calculation
            const currentThreshold = tiers.find(t => t.name === currentTier.name)?.threshold || 0;
            const range = nextTier.threshold - currentThreshold;
            const progressInRange = gmv30d - currentThreshold;
            const progressPct = Math.min(100, Math.max(0, (progressInRange / range) * 100));
            const remaining = nextTier.threshold - gmv30d;

            title.textContent = `Next: ${nextTier.name} Tier`;
            subtitle.textContent = `${fmtMoney(remaining)} away from unlocking`;
            progress.textContent = `${Math.round(progressPct)}%`;
            bar.style.width = `${progressPct}%`;
        }

        // Load all-time GMV
        async function loadAllTimeGmv(handles) {
            const handleSet = new Set(handles.map(h => h.toLowerCase()));
            
            let query = supabaseClient
                .from('creator_performance')
                .select('creator_name, gmv')
                .eq('period_type', 'daily');

            if (currentBrand !== 'all') {
                query = query.eq('brand', currentBrand);
            }

            const { data } = await query;
            const allTimeGmv = (data || [])
                .filter(r => handleSet.has(r.creator_name.toLowerCase()))
                .reduce((s, r) => s + pFloat(r.gmv), 0);
            
            animateStatValue('homeAllTimeGmv', fmtMoney(allTimeGmv));
        }

        // Load recent videos for the creator
        async function loadRecentVideos(handles) {
            const container = document.getElementById('recentVideos');
            
            // Guard against empty handles
            if (!handles || handles.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 16px;"><div class="empty-icon"></div><div>No videos yet</div></div>';
                return;
            }
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const startDate = new Date(yesterday);
            startDate.setDate(yesterday.getDate() - (homePeriod - 1));

            const filterBrand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            const handleSet = new Set(handles.map(h => h.toLowerCase()));

            let query = supabaseClient
                .from('video_performance')
                .select('video_id, video_title, product_name, creator_name, gmv, orders, report_date')
                .gte('report_date', localDateStr(startDate))
                .lte('report_date', localDateStr(yesterday))
                .order('report_date', { ascending: false })
                .limit(500);

            if (filterBrand) {
                query = query.eq('brand', filterBrand);
            }

            const { data: rawData } = await query;
            
            // Filter by handles client-side
            const data = (rawData || []).filter(r => handleSet.has(r.creator_name.toLowerCase()));

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 16px;"><div class="empty-icon"></div><div>No videos this period</div><div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">Post a video to see it here!</div></div>';
                return;
            }

            // Aggregate by video_id
            const videoMap = {};
            data.forEach(v => {
                const key = v.video_id || `${v.creator_name}_${v.video_title}`;
                if (!videoMap[key]) {
                    videoMap[key] = { ...v, gmv: 0, orders: 0 };
                }
                videoMap[key].gmv += pFloat(v.gmv);
                videoMap[key].orders += pInt(v.orders);
            });

            const recentVideos = Object.values(videoMap)
                .sort((a, b) => b.gmv - a.gmv)
                .slice(0, 3);

            container.innerHTML = recentVideos.map(v => {
                const hasVideoId = v.video_id && v.video_id.length > 5;
                const productEscaped = (v.product_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const clickAction = hasVideoId 
                    ? `openVideoPlayer('${v.video_id}', '${v.creator_name}', '${productEscaped}', ${v.gmv}, ${v.orders})`
                    : `window.open('https://www.tiktok.com/@${v.creator_name}', '_blank')`;

                return `
                    <div class="video-list-item" onclick="${clickAction}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; cursor: pointer;">
                        <div style="width: 50px; height: 50px; background: var(--bg-hover); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@${v.creator_name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${v.product_name || 'Video'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: var(--success);">${fmtMoney(v.gmv)}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${fmtNum(v.orders)} orders</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Contextual pro tips based on performance
        const PRO_TIPS_CONTEXTUAL = {
            noStreak: [
                "Consistency is key! Try posting at least one video per day to build momentum ",
                "Start small - even one video today can spark a streak! ",
                "The algorithm rewards consistent creators. Post today to start building! "
            ],
            lowGmv: [
                "Focus on trending sounds and hooks that grab attention in the first 2 seconds ",
                "Product demos that solve a problem perform 3x better than generic reviews ",
                "Try the 'before and after' format - viewers love seeing transformations! "
            ],
            growing: [
                "You're on a roll! Double down on the content style that's working ",
                "Consider posting during peak hours: 6-9 PM EST for maximum reach ",
                "Reply to comments within the first hour to boost engagement! "
            ],
            crushing: [
                "Elite move: Create series content to keep viewers coming back for more ",
                "You're in the top tier! Consider mentoring newer creators in Discord ",
                "At your level, product bundles and exclusive drops can 10x your GMV "
            ]
        };

        function setContextualProTip(gmv, videos) {
            const proTipCard = document.getElementById('proTipCard');
            
            // Check if dismissed today
            const dismissedDate = localStorage.getItem('proTipDismissed');
            const today = new Date().toDateString();
            if (dismissedDate === today) {
                proTipCard.style.display = 'none';
                return;
            }
            proTipCard.style.display = 'block';

            let tips;
            const streakCount = parseInt(document.getElementById('streakCount')?.textContent || '0');
            
            if (streakCount === 0) {
                tips = PRO_TIPS_CONTEXTUAL.noStreak;
            } else if (gmv < 100) {
                tips = PRO_TIPS_CONTEXTUAL.lowGmv;
            } else if (gmv < 1000) {
                tips = PRO_TIPS_CONTEXTUAL.growing;
            } else {
                tips = PRO_TIPS_CONTEXTUAL.crushing;
            }

            document.getElementById('proTipText').textContent = tips[Math.floor(Math.random() * tips.length)];
        }

        function dismissProTip() {
            localStorage.setItem('proTipDismissed', new Date().toDateString());
            document.getElementById('proTipCard').style.display = 'none';
        }

        function getCreatorHandles() {
            const handles = new Set(); // Use Set to avoid duplicates
            const profiles = currentBrand === 'all' ? creatorProfiles : creatorProfiles.filter(p => p.brand === currentBrand);
            const accountColumns = ['account_1', 'account_2', 'account_3', 'account_4', 'account_5',
                                    'account_6', 'account_7', 'account_8', 'account_9', 'account_10'];
            profiles.forEach(p => {
                accountColumns.forEach(col => {
                    const a = p[col];
                    if (a && a.trim()) {
                        // Store original handle (we'll do case-insensitive matching in queries)
                        handles.add(a.trim());
                    }
                });
            });
            return Array.from(handles);
        }
        
        // Build case-insensitive OR filter for handles
        // Supabase .in() is case-sensitive, so we use .or() with ilike for each handle
        function buildHandleFilter(handles) {
            if (!handles || handles.length === 0) return null;
            // Create OR conditions with ilike for case-insensitive matching
            return handles.map(h => `creator_name.ilike.${h}`).join(',');
        }
        
        // Apply handle filter to query (case-insensitive)
        function applyHandleFilter(query, handles) {
            const filter = buildHandleFilter(handles);
            if (filter) {
                return query.or(filter);
            }
            return query;
        }

        function updateChangeIndicator(elId, current, prior, suffix = '') {
            const el = document.getElementById(elId);
            if (!el) return;
            
            if (prior > 0) {
                const change = ((current - prior) / prior * 100).toFixed(0);
                el.textContent = `${change >= 0 ? '+' : ''}${change}%${suffix ? ' ' + suffix : ''}`;
                el.className = `stat-change ${change >= 0 ? 'up' : 'down'}`;
            } else {
                el.textContent = '';
            }
        }

        async function loadStreak(handles) {
            // Get video posting dates
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 29);

            let streakQuery = supabaseClient
                .from('creator_performance')
                .select('report_date, videos')
                .gte('report_date', localDateStr(thirtyDaysAgo))
                .eq('period_type', 'daily')
                .gt('videos', 0)
                .order('report_date', { ascending: false });
            
            streakQuery = applyHandleFilter(streakQuery, handles);
            
            const { data: videoData } = await streakQuery;

            // Build set of dates with videos
            const videoDates = new Set((videoData || []).map(v => v.report_date));
            
            // Calculate streak (consecutive days from today/yesterday going back)
            let streak = 0;
            const checkDate = new Date(today);
            
            for (let i = 0; i < 30; i++) {
                const dateStr = localDateStr(checkDate);
                if (videoDates.has(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (i === 0) {
                    // Today has no video yet - check yesterday
                    checkDate.setDate(checkDate.getDate() - 1);
                    if (videoDates.has(localDateStr(checkDate))) {
                        streak = 1;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }
                } else {
                    break;
                }
            }

            const streakCard = document.getElementById('homeStreakCard');
            const streakEmoji = document.getElementById('streakEmoji');
            const streakCount = document.getElementById('streakCount');
            const streakMessage = document.getElementById('streakMessage');

            if (streak === 0) {
                streakCard.classList.add('inactive');
                streakEmoji.textContent = '';
                streakCount.textContent = '0';
                streakMessage.textContent = 'Post today to start a streak!';
            } else {
                streakCard.classList.remove('inactive');
                streakEmoji.textContent = streak >= 7 ? '' : '';
                streakCount.textContent = streak;
                streakMessage.textContent = streak >= 7 ? "You're on fire! Keep it going!" : `${7 - streak} more days to !`;
            }
        }

        let journalEntries = [];
        
        // Helper to get the correct discord_id (viewed creator in admin mode, or current user)
        function getJournalDiscordId() {
            // In admin mode viewing a creator, ONLY use their discord_id (don't fall back to admin's)
            if (isAdmin && viewingAsCreator) {
                return currentProfile?.discord_id || null;
            }
            // Regular user viewing their own portal
            return currentUser?.id;
        }
        
        async function loadJournalEntries() {
            const container = document.getElementById('journalEntries');
            const showMoreBtn = document.getElementById('journalShowMore');
            
            const discordId = getJournalDiscordId();
            
            // If admin viewing a creator without discord_id linked
            if (isAdmin && viewingAsCreator && !discordId) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-icon"></div>
                        <div>Discord not linked</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">This creator hasn't logged into the portal yet</div>
                    </div>
                `;
                showMoreBtn.style.display = 'none';
                return;
            }
            
            if (!discordId) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="empty-icon"></div><div>Log in to see your entries</div></div>';
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('creator_journal')
                    .select('*')
                    .eq('discord_id', discordId)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                journalEntries = data || [];
                
                if (journalEntries.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <div class="empty-icon"></div>
                            <div>No entries yet</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">${isAdmin ? 'This creator has no journal entries' : 'Call your first shot!'}</div>
                        </div>
                    `;
                    showMoreBtn.style.display = 'none';
                    return;
                }
                
                // Show only first 3 on home
                const displayEntries = journalEntries.slice(0, 3);
                
                container.innerHTML = displayEntries.map(entry => renderJournalEntry(entry)).join('');
                
                // Show "view all" if more than 3
                showMoreBtn.style.display = journalEntries.length > 3 ? 'block' : 'none';
                
            } catch (err) {
                console.error('Error loading journal:', err);
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="empty-icon"></div><div>Failed to load entries</div></div>';
            }
            
            // Hide add button and update subtitle for admin viewing others
            const addBtn = document.getElementById('journalAddBtn');
            const subtitle = document.getElementById('journalSubtitle');
            if (isAdmin && viewingAsCreator) {
                addBtn.style.display = 'none';
                subtitle.textContent = `${currentProfile?.real_name || 'Creator'}'s personal goals and reflections`;
            } else {
                addBtn.style.display = '';
                subtitle.textContent = 'Set goals, track your journey, reflect on how far you\'ve come.';
            }
        }
        
        function renderJournalEntry(entry, showFull = false) {
            const date = new Date(entry.created_at);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const timeAgo = getTimeAgo(date);
            
            // Determine entry type icon
            const typeIcons = {
                'goal': '',
                'reflection': '',
                'milestone': '',
                'gratitude': '',
                'lesson': ''
            };
            const icon = typeIcons[entry.entry_type] || '';
            
            // Truncate content if not showing full
            const content = entry.content;
            const truncated = content.length > 120 && !showFull ? content.substring(0, 120) + '...' : content;
            
            // Action buttons only in full view AND only for own entries (not admin viewing others)
            const canEdit = !(isAdmin && viewingAsCreator);
            const actions = showFull && canEdit && !entry.achieved_at && entry.entry_type === 'goal' ? `
                <div class="journal-entry-actions" style="margin-top: 10px; display: flex; gap: 8px;">
                    <button onclick="markEntryAchieved(${entry.id})" style="padding: 6px 12px; background: var(--success-dim); border: 1px solid var(--success); border-radius: 6px; color: var(--success); font-size: 0.75rem; cursor: pointer;"> Mark Achieved</button>
                    <button onclick="deleteJournalEntry(${entry.id})" style="padding: 6px 12px; background: var(--danger-dim); border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); font-size: 0.75rem; cursor: pointer;"> Delete</button>
                </div>
            ` : showFull && canEdit ? `
                <div class="journal-entry-actions" style="margin-top: 10px;">
                    <button onclick="deleteJournalEntry(${entry.id})" style="padding: 6px 12px; background: var(--danger-dim); border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); font-size: 0.75rem; cursor: pointer;"> Delete</button>
                </div>
            ` : '';
            
            return `
                <div class="journal-entry" data-id="${entry.id}">
                    <div class="journal-entry-header">
                        <span class="journal-entry-icon">${icon}</span>
                        <span class="journal-entry-date" title="${dateStr}">${timeAgo}</span>
                    </div>
                    <div class="journal-entry-content">${truncated}</div>
                    ${entry.achieved_at ? `
                        <div class="journal-entry-achieved">
                             Achieved ${new Date(entry.achieved_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </div>
                    ` : ''}
                    ${actions}
                </div>
            `;
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffWeeks === 1) return '1 week ago';
            if (diffWeeks < 4) return `${diffWeeks} weeks ago`;
            if (diffMonths === 1) return '1 month ago';
            if (diffMonths < 12) return `${diffMonths} months ago`;
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }
        
        function showAddJournalModal() {
            document.getElementById('journalModal').style.display = 'block';
            document.getElementById('journalEntryText').value = '';
            document.getElementById('journalEntryType').value = 'goal';
            document.getElementById('journalEntryText').focus();
        }
        
        function hideJournalModal() {
            document.getElementById('journalModal').style.display = 'none';
        }
        
        async function saveJournalEntry() {
            // Admins viewing other creators can't add entries for them
            if (isAdmin && viewingAsCreator) {
                alert('You cannot add journal entries for other creators.');
                return;
            }
            
            const content = document.getElementById('journalEntryText').value.trim();
            const entryType = document.getElementById('journalEntryType').value;
            
            if (!content) {
                alert('Please write something!');
                return;
            }
            
            const discordId = getJournalDiscordId();
            
            try {
                const { error } = await supabaseClient
                    .from('creator_journal')
                    .insert({
                        discord_id: discordId,
                        discord_username: currentUser.username,
                        entry_type: entryType,
                        content: content
                    });
                
                if (error) throw error;
                
                hideJournalModal();
                loadJournalEntries();
                
            } catch (err) {
                console.error('Error saving journal entry:', err);
                alert('Failed to save entry. Please try again.');
            }
        }
        
        function showAllJournalEntries() {
            document.getElementById('journalAllModal').style.display = 'block';
            
            // Update title and hide add button for admin viewing others
            const titleEl = document.getElementById('journalAllModalTitle');
            const addBtn = document.getElementById('journalAllAddBtn');
            
            if (isAdmin && viewingAsCreator) {
                titleEl.textContent = ` ${currentProfile?.real_name || 'Creator'}'s Journey`;
                addBtn.style.display = 'none';
            } else {
                titleEl.textContent = ' Your Journey';
                addBtn.style.display = '';
            }
            
            renderAllJournalEntries();
        }
        
        function hideAllJournalModal() {
            document.getElementById('journalAllModal').style.display = 'none';
        }
        
        function renderAllJournalEntries() {
            const container = document.getElementById('allJournalEntries');
            
            if (journalEntries.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No entries yet</div></div>';
                return;
            }
            
            // Group by month/year
            const grouped = {};
            journalEntries.forEach(entry => {
                const date = new Date(entry.created_at);
                const monthYear = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (!grouped[monthYear]) grouped[monthYear] = [];
                grouped[monthYear].push(entry);
            });
            
            container.innerHTML = Object.entries(grouped).map(([monthYear, entries]) => `
                <div class="journal-month-group">
                    <div class="journal-month-header">${monthYear}</div>
                    ${entries.map(e => renderJournalEntry(e, true)).join('')}
                </div>
            `).join('');
        }
        
        async function markEntryAchieved(entryId) {
            // Admins can't modify other creators' entries
            if (isAdmin && viewingAsCreator) {
                alert('You cannot modify entries for other creators.');
                return;
            }
            
            try {
                const discordId = getJournalDiscordId();
                const { error } = await supabaseClient
                    .from('creator_journal')
                    .update({ achieved_at: new Date().toISOString() })
                    .eq('id', entryId)
                    .eq('discord_id', discordId);
                
                if (error) throw error;
                
                loadJournalEntries();
                renderAllJournalEntries();
                
            } catch (err) {
                console.error('Error marking achieved:', err);
            }
        }
        
        async function deleteJournalEntry(entryId) {
            // Admins can't modify other creators' entries
            if (isAdmin && viewingAsCreator) {
                alert('You cannot delete entries for other creators.');
                return;
            }
            
            if (!confirm('Delete this entry?')) return;
            
            try {
                const discordId = getJournalDiscordId();
                const { error } = await supabaseClient
                    .from('creator_journal')
                    .delete()
                    .eq('id', entryId)
                    .eq('discord_id', discordId);
                
                if (error) throw error;
                
                loadJournalEntries();
                renderAllJournalEntries();
                
            } catch (err) {
                console.error('Error deleting entry:', err);
            }
        }

        // ==================== VIDEO PLAYER ====================
        // Cache for thumbnail URLs to avoid repeated API calls
        const thumbnailCache = {};
        
        function openVideoPlayer(videoId, creator, product, gmv, orders) {
            const modal = document.getElementById('videoPlayerModal');
            const embedContainer = document.getElementById('videoPlayerEmbed');
            
            // Update info
            document.getElementById('videoPlayerCreator').textContent = `@${creator}`;
            document.getElementById('videoPlayerProduct').textContent = product || '';
            document.getElementById('videoPlayerGmv').textContent = fmtMoney(gmv);
            document.getElementById('videoPlayerOrders').textContent = fmtNum(orders);
            
            // Show loading state
            embedContainer.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <div class="spinner"></div>
                </div>
            `;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Load standard TikTok embed
            setTimeout(() => {
                embedContainer.innerHTML = `
                    <iframe 
                        src="https://www.tiktok.com/embed/v2/${videoId}"
                        style="width: 100%; height: 100%; border: none;"
                        allow="encrypted-media; fullscreen"
                        allowfullscreen
                    ></iframe>
                `;
            }, 100);
        }
        
        function hideVideoPlayer() {
            const modal = document.getElementById('videoPlayerModal');
            const embedContainer = document.getElementById('videoPlayerEmbed');
            modal.style.display = 'none';
            embedContainer.innerHTML = '';
            document.body.style.overflow = '';
        }
        
        async function loadVideoThumbnails() {
            const thumbContainers = document.querySelectorAll('.video-card-thumb[data-video-id]');
            
            for (const container of thumbContainers) {
                const videoId = container.dataset.videoId;
                const creator = container.dataset.creator;
                
                if (!videoId || videoId.length < 5) continue;
                
                const img = container.querySelector('.video-card-thumbnail');
                if (!img) continue;
                
                // Check cache first
                const cacheKey = `${creator}_${videoId}`;
                if (thumbnailCache[cacheKey]) {
                    img.src = thumbnailCache[cacheKey];
                    img.classList.add('loaded');
                    continue;
                }
                
                // Fetch from TikTok oEmbed API
                try {
                    const videoUrl = `https://www.tiktok.com/@${creator}/video/${videoId}`;
                    const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(videoUrl)}`;
                    
                    const response = await fetch(oembedUrl);
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    if (data.thumbnail_url) {
                        thumbnailCache[cacheKey] = data.thumbnail_url;
                        img.src = data.thumbnail_url;
                        img.onload = () => img.classList.add('loaded');
                    }
                } catch (err) {
                    // Silently fail - will show gradient fallback
                    console.log('Could not load thumbnail for', videoId);
                }
            }
        }
        
        // Close video player on escape key or click outside
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('videoPlayerModal').style.display === 'block') {
                hideVideoPlayer();
            }
        });
        
        // Close on click on the dark overlay background
        document.getElementById('videoPlayerOverlay').addEventListener('click', hideVideoPlayer);

        // Format date range for display
        function formatDateRange(startDate, endDate) {
            const options = { month: 'short', day: 'numeric' };
            const start = startDate.toLocaleDateString('en-US', options);
            const end = endDate.toLocaleDateString('en-US', options);
            
            // If same month, simplify: "Dec 12  18"
            if (startDate.getMonth() === endDate.getMonth()) {
                return `${start}  ${endDate.getDate()}`;
            }
            return `${start}  ${end}`;
        }
        
        // Update date range display for a period
        function updateDateRangeDisplay(elementId, period, isAllTime = false) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            if (isAllTime || period === 'all') {
                el.textContent = 'Since Oct 2024';
                return;
            }
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const startDate = new Date(yesterday);
            startDate.setDate(yesterday.getDate() - (period - 1));
            
            el.textContent = formatDateRange(startDate, yesterday);
        }

        function setHomePeriod(period) {
            homePeriod = period;
            
            // Update buttons
            document.querySelectorAll('#homePeriodSelector .period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period == period);
            });
            
            // Update date range display
            updateDateRangeDisplay('homeDateRangeText', period);
            
            // Calculate date range text for section labels
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const startDate = new Date(yesterday);
            startDate.setDate(yesterday.getDate() - (period - 1));
            const dateRangeText = formatDateRange(startDate, yesterday);
            
            // Update section period labels with date range
            const winningLabel = document.getElementById('winningPeriodLabel');
            const recentLabel = document.getElementById('recentPeriodLabel');
            if (winningLabel) winningLabel.textContent = dateRangeText;
            if (recentLabel) recentLabel.textContent = dateRangeText;
            
            // Reload data
            loadHomeData();
        }

        async function loadWhatsWinning() {
            const container = document.getElementById('winningVideos');
            
            // Get brand to filter (same as logged-in user)
            const filterBrand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            
            if (!filterBrand) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No data yet</div></div>';
                return;
            }

            // Fetch top performing videos for the selected period
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const startDate = new Date(yesterday);
            startDate.setDate(yesterday.getDate() - (homePeriod - 1));

            const { data } = await supabaseClient
                .from('video_performance')
                .select('video_id, video_title, product_name, creator_name, gmv, orders')
                .eq('brand', filterBrand)
                .gte('report_date', localDateStr(startDate))
                .lte('report_date', localDateStr(yesterday))
                .gt('gmv', 0)
                .order('gmv', { ascending: false })
                .limit(50);

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No videos yet</div></div>';
                return;
            }

            // Aggregate by video_id to get total GMV per video
            const videoMap = {};
            data.forEach(v => {
                const key = v.video_id || `${v.creator_name}_${v.video_title}`;
                if (!videoMap[key]) {
                    videoMap[key] = {
                        video_id: v.video_id,
                        video_title: v.video_title,
                        product_name: v.product_name,
                        creator_name: v.creator_name,
                        gmv: 0,
                        orders: 0
                    };
                }
                videoMap[key].gmv += pFloat(v.gmv);
                videoMap[key].orders += pInt(v.orders);
            });

            const topVideos = Object.values(videoMap)
                .sort((a, b) => b.gmv - a.gmv)
                .slice(0, 6);

            container.innerHTML = topVideos.map((v, i) => {
                const hasVideoId = v.video_id && v.video_id.length > 5;
                const rank = i + 1;
                const medal = rank <= 3 ? ['', '', ''][rank - 1] : `#${rank}`;
                const productDisplay = v.product_name ? (v.product_name.length > 25 ? v.product_name.substring(0, 25) + '...' : v.product_name) : '';
                const productEscaped = (v.product_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                // If has video ID, open embedded player; otherwise link to profile
                const clickAction = hasVideoId 
                    ? `openVideoPlayer('${v.video_id}', '${v.creator_name}', '${productEscaped}', ${v.gmv}, ${v.orders})`
                    : `window.open('https://www.tiktok.com/@${v.creator_name}', '_blank')`;
                
                return `
                <div class="video-card" onclick="${clickAction}">
                    <div class="video-card-thumb" data-video-id="${hasVideoId ? v.video_id : ''}" data-creator="${v.creator_name}">
                        <img class="video-card-thumbnail" src="" alt="" style="display: none;">
                        <div class="video-card-play"></div>
                        <div class="video-card-rank">${medal}</div>
                        <div class="video-card-gmv">${fmtMoney(v.gmv)}</div>
                    </div>
                    <div class="video-card-info">
                        <div class="video-card-creator">@${v.creator_name}</div>
                        ${productDisplay ? `<div class="video-card-product">${productDisplay}</div>` : ''}
                        <div class="video-card-stats">
                            <span> ${fmtNum(v.orders)}</span>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // Load thumbnails
            loadVideoThumbnails();
        }

        async function loadRankPosition(handles) {
            const filterBrand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            if (!filterBrand) return;
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const weekAgo = new Date(yesterday);
            weekAgo.setDate(yesterday.getDate() - 6);

            const { data } = await supabaseClient
                .from('creator_performance')
                .select('creator_name, gmv')
                .eq('brand', filterBrand)
                .eq('period_type', 'daily')
                .gte('report_date', localDateStr(weekAgo))
                .lte('report_date', localDateStr(yesterday));

            // Aggregate
            const creatorGmv = {};
            (data || []).forEach(r => {
                const name = r.creator_name.toLowerCase();
                creatorGmv[name] = (creatorGmv[name] || 0) + pFloat(r.gmv);
            });

            // Sort and find rank
            const sorted = Object.entries(creatorGmv).sort((a, b) => b[1] - a[1]);
            let rank = 0;
            for (let i = 0; i < sorted.length; i++) {
                if (handles.includes(sorted[i][0])) {
                    rank = i + 1;
                    break;
                }
            }

            document.getElementById('homeRank').textContent = rank > 0 ? `#${rank}` : '#-';
        }

        // ==================== LEARN TAB FUNCTIONS ====================
        let currentTipIndex = 0;
        const totalTips = 4;

        function nextTip() {
            currentTipIndex = (currentTipIndex + 1) % totalTips;
            showTip(currentTipIndex);
        }

        function prevTip() {
            currentTipIndex = (currentTipIndex - 1 + totalTips) % totalTips;
            showTip(currentTipIndex);
        }

        function showTip(index) {
            const tips = document.querySelectorAll('.tip-card');
            tips.forEach((tip, i) => {
                tip.classList.toggle('active', i === index);
            });
            document.getElementById('tipCurrent').textContent = index + 1;
        }

        function toggleFaq(item) {
            // Close other open FAQs
            document.querySelectorAll('.faq-item.open').forEach(faq => {
                if (faq !== item) faq.classList.remove('open');
            });
            // Toggle this one
            item.classList.toggle('open');
        }

        async function updateBrandDiscordLink() {
            const discordLink = document.getElementById('discordLink');
            if (!discordLink) return;

            // Use current brand or first brand they're on
            const brand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            
            if (brand) {
                // Try to get from database first
                const { data } = await supabaseClient
                    .from('brand_campaigns')
                    .select('discord_url')
                    .eq('brand', brand)
                    .single();
                
                if (data?.discord_url) {
                    discordLink.href = data.discord_url;
                    return;
                }
            }

            // Fallback to hardcoded links
            const discordLinks = {
                'catakor': 'https://discord.gg/catakor',
                'jiyu': 'https://discord.gg/jiyu',
                'physicians_choice': 'https://discord.gg/physicianschoice',
                'peach_slices': 'https://discord.gg/peachslices',
                'yerba_magic': 'https://discord.gg/yerbamagic',
                'toplux': 'https://discord.gg/toplux'
            };

            discordLink.href = discordLinks[brand] || 'https://discord.gg/creatorscorner';
        }

        async function loadCreatorSpotlight() {
            // For now, use featured creator data - can be made dynamic later
            const spotlights = [
                { name: '@topCreator1', stat: '$50K+ GMV this month', quote: 'Consistency is everything. I post 2-3 videos daily and focus on solving real problems with the products.', link: 'https://tiktok.com/@topcreator1' },
                { name: '@viralMaker', stat: '$30K GMV in 2 weeks', quote: 'Hook them in 2 seconds. I always start with the transformation or the problem - never the product.', link: 'https://tiktok.com/@viralmaker' },
                { name: '@contentQueen', stat: 'Gold tier in 30 days', quote: 'Study what works, then make it your own. I watch top videos daily and adapt the hooks to my style.', link: 'https://tiktok.com/@contentqueen' }
            ];

            // Rotate based on day of week
            const spotlight = spotlights[new Date().getDay() % spotlights.length];
            
            document.getElementById('spotlightName').textContent = spotlight.name;
            document.getElementById('spotlightStat').textContent = spotlight.stat;
            document.getElementById('spotlightQuote').textContent = `"${spotlight.quote}"`;
            document.getElementById('spotlightLink').href = spotlight.link;
        }

        async function loadPortalFaq() {
            const container = document.getElementById('portalFaq');
            
            const { data, error } = await supabaseClient
                .from('portal_faq')
                .select('*')
                .eq('active', true)
                .order('display_order', { ascending: true });
            
            // Fallback if table doesn't exist or no data
            if (error || !data || data.length === 0) {
                container.innerHTML = `
                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            <span> How do I get paid?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            <div class="coming-soon-inline">Coming soon</div>
                        </div>
                    </div>
                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            <span> How is my tier determined?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            <div class="coming-soon-inline">Coming soon</div>
                        </div>
                    </div>
                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            <span> What content should I create?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            <div class="coming-soon-inline">Coming soon</div>
                        </div>
                    </div>
                    <div class="faq-item mb-0" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            <span> When does my data update?</span>
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            <div class="coming-soon-inline">Coming soon</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.map((faq, i) => `
                <div class="faq-item ${i === data.length - 1 ? 'mb-0' : ''}" onclick="toggleFaq(this)">
                    <div class="faq-question">
                        <span>${faq.icon || ''} ${faq.question}</span>
                        <span class="faq-toggle">+</span>
                    </div>
                    <div class="faq-answer">${faq.answer}</div>
                </div>
            `).join('');
        }

        async function loadPortalResources() {
            const container = document.getElementById('portalResources');
            
            // Get resources - filter by brand if applicable
            const brand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            
            let query = supabaseClient
                .from('portal_resources')
                .select('*')
                .eq('active', true)
                .order('display_order', { ascending: true });
            
            // Get resources for this brand OR all brands (null)
            if (brand) {
                query = query.or(`brand.eq.${brand},brand.is.null`);
            }
            
            const { data, error } = await query;
            
            // Show "Coming Soon" if no resources
            if (error || !data || data.length === 0) {
                container.innerHTML = `
                    <div class="coming-soon-section">
                        <div class="coming-soon-icon"></div>
                        <div class="coming-soon-text">Coming Soon</div>
                        <div class="coming-soon-desc">Brand guidelines, product sheets & sample scripts</div>
                    </div>
                `;
                return;
            }
            
            const fileTypeIcons = { pdf: '', doc: '', image: '', video: '', other: '' };
            
            container.innerHTML = data.map(r => `
                <a href="${r.file_url}" target="_blank" class="resource-item" style="display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; text-decoration: none; color: inherit; transition: all 0.2s;">
                    <div style="font-size: 1.5rem;">${r.icon || fileTypeIcons[r.file_type] || ''}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${r.title}</div>
                        ${r.description ? `<div style="font-size: 0.8rem; color: var(--text-muted);">${r.description}</div>` : ''}
                    </div>
                    <div style="align-self: center; color: var(--accent);"></div>
                </a>
            `).join('');
        }

        async function loadAvailableCampaigns() {
            const container = document.getElementById('availableCampaigns');
            
            // Fetch campaigns from database
            const { data: campaignsData, error } = await supabaseClient
                .from('brand_campaigns')
                .select('*')
                .eq('active', true)
                .order('display_order', { ascending: true });

            // Fallback to default if table doesn't exist or is empty
            let allCampaigns;
            if (error || !campaignsData || campaignsData.length === 0) {
                // Default campaigns (will be moved to database)
                allCampaigns = [
                    {
                        brand: 'catakor',
                        name: 'Cata-Kor',
                        description: 'Health supplements & wellness products',
                        commission_text: '10-15% commission',
                        color: '#ef4444',
                        icon: '',
                        apply_url: 'apply.html?brand=catakor'
                    },
                    {
                        brand: 'jiyu',
                        name: 'JiYu',
                        description: 'Skincare & beauty products',
                        commission_text: '10-15% commission',
                        color: '#8b5cf6',
                        icon: '',
                        apply_url: 'apply.html?brand=jiyu'
                    },
                    {
                        brand: 'physicians_choice',
                        name: 'Physicians Choice',
                        description: 'Probiotics & digestive health',
                        commission_text: '10-15% commission',
                        color: '#3b82f6',
                        icon: '',
                        apply_url: 'apply.html?brand=physicians_choice'
                    },
                    {
                        brand: 'peach_slices',
                        name: 'Peach Slices',
                        description: 'K-beauty skincare essentials',
                        commission_text: '10-15% commission',
                        color: '#f97316',
                        icon: '',
                        apply_url: 'apply.html?brand=peach_slices'
                    },
                    {
                        brand: 'yerba_magic',
                        name: 'Yerba Magic',
                        description: 'Natural energy & wellness drinks',
                        commission_text: '10-15% commission',
                        color: '#22c55e',
                        icon: '',
                        apply_url: 'apply.html?brand=yerba_magic'
                    },
                    {
                        brand: 'toplux',
                        name: 'Toplux Nutrition',
                        description: 'Keto & wellness supplements',
                        commission_text: '10-15% commission',
                        color: '#00b894',
                        icon: '',
                        apply_url: 'apply.html?brand=toplux'
                    }
                ];
            } else {
                allCampaigns = campaignsData;
            }
            
            // Get brands the creator is already on
            const myBrands = new Set();
            creatorProfiles.forEach(p => {
                if (p.brand) myBrands.add(p.brand);
            });
            
            // Also check for pending applications
            const { data: pendingApps } = await supabaseClient
                .from('creator_applications')
                .select('brand, status')
                .eq('discord_id', currentUser.id)
                .in('status', ['pending', 'reviewing', 'waitlist']);
            
            const pendingBrands = new Set();
            (pendingApps || []).forEach(a => pendingBrands.add(a.brand));
            
            // Filter to campaigns they're NOT already on
            const availableCampaigns = allCampaigns.filter(c => !myBrands.has(c.brand));
            
            if (availableCampaigns.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>You're already on all available campaigns!</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = availableCampaigns.map(c => {
                const isPending = pendingBrands.has(c.brand);
                const applyUrl = c.apply_url || `apply.html?brand=${c.brand}`;
                const desc = c.description || c.desc || '';
                const commission = c.commission_text || c.commission || '';
                
                return `
                <div class="campaign-card">
                    <div class="campaign-logo" style="background: ${c.color}20; color: ${c.color};">${c.icon}</div>
                    <div class="campaign-info">
                        <div class="campaign-name">${c.name}</div>
                        <div class="campaign-desc">${desc}</div>
                        <div class="campaign-commission"> ${commission}</div>
                    </div>
                    ${isPending 
                        ? '<span style="padding: 8px 12px; background: var(--warning-dim); color: var(--warning); border-radius: 8px; font-size: 0.8rem; font-weight: 600; align-self: center;"> Pending</span>'
                        : `<button class="campaign-apply-btn" onclick="window.open('${applyUrl}', '_blank')">Apply </button>`
                    }
                </div>
            `}).join('');
        }

        // ==================== STATS DATA ====================
        let statsChartData = { daily: {}, dailyOrders: {} };
        let currentChartMetric = 'gmv';

        async function loadStatsData() {
            if (userStatus !== 'accepted') return;

            const handles = getCreatorHandles();
            if (handles.length === 0) return;

            // Date range - use yesterday as end date since today's data is incomplete
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            let startDate, priorStartDate, priorEndDate;
            
            if (statsPeriod === 'all') {
                startDate = new Date('2024-01-01');
                priorStartDate = null;
                priorEndDate = null;
            } else {
                startDate = new Date(yesterday);
                startDate.setDate(yesterday.getDate() - (statsPeriod - 1));
                
                // Prior period for comparison
                priorEndDate = new Date(startDate);
                priorEndDate.setDate(priorEndDate.getDate() - 1);
                priorStartDate = new Date(priorEndDate);
                priorStartDate.setDate(priorStartDate.getDate() - (statsPeriod - 1));
            }

            // Fetch current period data from creator_performance (for GMV, orders, and videos)
            let query = supabaseClient
                .from('creator_performance')
                .select('creator_name, brand, gmv, orders, videos, report_date')
                .gte('report_date', localDateStr(startDate))
                .lte('report_date', localDateStr(statsPeriod === 'all' ? yesterday : yesterday))
                .eq('period_type', 'daily')
                .order('report_date', { ascending: true });
            
            query = applyHandleFilter(query, handles);

            if (currentBrand !== 'all') {
                query = query.eq('brand', currentBrand);
            }

            const { data: perfData } = await query;

            // Fetch prior period data for comparison (if not "all time")
            let priorGmv = 0, priorOrders = 0;
            if (priorStartDate) {
                let priorQuery = supabaseClient
                    .from('creator_performance')
                    .select('gmv, orders')
                    .gte('report_date', localDateStr(priorStartDate))
                    .lte('report_date', localDateStr(priorEndDate))
                    .eq('period_type', 'daily');
                
                priorQuery = applyHandleFilter(priorQuery, handles);

                if (currentBrand !== 'all') {
                    priorQuery = priorQuery.eq('brand', currentBrand);
                }

                const { data: priorData } = await priorQuery;
                (priorData || []).forEach(r => {
                    priorGmv += pFloat(r.gmv);
                    priorOrders += pInt(r.orders);
                });
            }

            // Calculate totals and find best day
            // Videos come from the 'videos' column in creator_performance (source of truth from Creator_Data)
            let totalGmv = 0, totalOrders = 0, totalVideos = 0;
            const dailyGmv = {};
            const dailyOrders = {};
            let bestDay = { date: null, gmv: 0 };

            (perfData || []).forEach(r => {
                totalGmv += pFloat(r.gmv);
                totalOrders += pInt(r.orders);
                totalVideos += pInt(r.videos);
                
                const gmv = pFloat(r.gmv);
                dailyGmv[r.report_date] = (dailyGmv[r.report_date] || 0) + gmv;
                dailyOrders[r.report_date] = (dailyOrders[r.report_date] || 0) + pInt(r.orders);
                
                if (dailyGmv[r.report_date] > bestDay.gmv) {
                    bestDay = { date: r.report_date, gmv: dailyGmv[r.report_date] };
                }
            });

            // Store chart data for toggle
            statsChartData = { daily: dailyGmv, dailyOrders: dailyOrders };

            // Update UI with animations
            animateStatValue('statsGmv', fmtMoney(totalGmv));
            animateStatValue('statsOrders', fmtNum(totalOrders));
            animateStatValue('statsVideos', fmtNum(totalVideos));
            animateStatValue('statsAvgGmv', fmtMoney(totalVideos > 0 ? totalGmv / totalVideos : 0));
            
            // Conversion rate
            const conversionRate = totalVideos > 0 ? (totalOrders / totalVideos).toFixed(1) : 0;
            animateStatValue('statsConversion', conversionRate);

            // Change indicators
            if (priorGmv > 0) {
                const gmvChange = ((totalGmv - priorGmv) / priorGmv * 100).toFixed(0);
                const gmvChangeEl = document.getElementById('statsGmvChange');
                gmvChangeEl.textContent = `${gmvChange >= 0 ? '+' : ''}${gmvChange}% vs prior`;
                gmvChangeEl.className = `stat-change ${gmvChange >= 0 ? 'up' : 'down'}`;

                const ordersChange = ((totalOrders - priorOrders) / priorOrders * 100).toFixed(0);
                const ordersChangeEl = document.getElementById('statsOrdersChange');
                ordersChangeEl.textContent = `${ordersChange >= 0 ? '+' : ''}${ordersChange}%`;
                ordersChangeEl.className = `stat-change ${ordersChange >= 0 ? 'up' : 'down'}`;
            } else {
                document.getElementById('statsGmvChange').textContent = '';
                document.getElementById('statsOrdersChange').textContent = '';
            }

            // Best day insight
            if (bestDay.date) {
                const bestDate = new Date(bestDay.date + 'T12:00:00');
                document.getElementById('statsBestDayGmv').textContent = fmtMoney(bestDay.gmv);
                document.getElementById('statsBestDayDate').textContent = bestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else {
                document.getElementById('statsBestDayGmv').textContent = '-';
                document.getElementById('statsBestDayDate').textContent = 'No data yet';
            }

            // Prior period comparison insight
            if (priorGmv > 0 && statsPeriod !== 'all') {
                const change = ((totalGmv - priorGmv) / priorGmv * 100).toFixed(0);
                const changeEl = document.getElementById('statsPriorChange');
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change}%`;
                changeEl.style.color = change >= 0 ? 'var(--success)' : 'var(--danger)';
                document.getElementById('statsPriorLabel').textContent = `vs prior ${statsPeriod} days`;
            } else {
                document.getElementById('statsPriorChange').textContent = '-';
                document.getElementById('statsPriorChange').style.color = 'var(--text-muted)';
                document.getElementById('statsPriorLabel').textContent = statsPeriod === 'all' ? 'All time view' : 'No prior data';
            }

            // Render chart
            renderStatsChart(dailyGmv, 'gmv');

            // Load product breakdown
            loadProductBreakdown(handles, startDate, today);

            // Load top videos
            loadTopVideos(handles, startDate, today);
        }

        function switchChartMetric(metric) {
            currentChartMetric = metric;
            
            // Update toggle buttons
            document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.metric === metric);
            });

            // Re-render chart
            if (metric === 'gmv') {
                renderStatsChart(statsChartData.daily, 'gmv');
            } else {
                renderStatsChart(statsChartData.dailyOrders, 'orders');
            }
        }

        function renderStatsChart(dailyData, metric = 'gmv') {
            const ctx = document.getElementById('statsChart');
            if (!ctx) return;

            if (statsChartInstance) {
                statsChartInstance.destroy();
            }

            const labels = Object.keys(dailyData).sort();
            const data = labels.map(d => dailyData[d]);

            // Format labels for display
            const displayLabels = labels.map(d => {
                const date = new Date(d + 'T12:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const isGmv = metric === 'gmv';
            const color = isGmv ? '#f5c518' : '#3b82f6';

            statsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayLabels,
                    datasets: [{
                        data: data,
                        borderColor: color,
                        backgroundColor: isGmv ? 'rgba(245, 197, 24, 0.1)' : 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: labels.length > 14 ? 0 : 3,
                        pointBackgroundColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => isGmv ? fmtMoney(ctx.raw) : fmtNum(ctx.raw) + ' orders'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#6a6a7a',
                                maxRotation: 0,
                                maxTicksLimit: 7
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#6a6a7a',
                                callback: (v) => isGmv 
                                    ? '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'K' : v)
                                    : v
                            }
                        }
                    }
                }
            });
        }

        async function loadProductBreakdown(handles, startDate, endDate) {
            const container = document.getElementById('statsProductBreakdown');

            // Guard against empty handles
            if (!handles || handles.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 16px;">No product data yet</div>';
                return;
            }

            let query = supabaseClient
                .from('video_performance')
                .select('product_name, gmv')
                .gte('report_date', localDateStr(startDate))
                .lte('report_date', localDateStr(endDate));
            
            query = applyHandleFilter(query, handles);

            if (currentBrand !== 'all') {
                query = query.eq('brand', currentBrand);
            }

            const { data } = await query;

            if (!data || data.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 16px;">No product data yet</div>';
                return;
            }

            // Aggregate by product
            const productGmv = {};
            data.forEach(r => {
                const product = r.product_name || 'Unknown Product';
                productGmv[product] = (productGmv[product] || 0) + pFloat(r.gmv);
            });

            // Sort by GMV and take top 5
            const topProducts = Object.entries(productGmv)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (topProducts.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 16px;">No product data yet</div>';
                return;
            }

            const maxGmv = topProducts[0][1];
            const colors = ['#f5c518', '#3b82f6', '#22c55e', '#f97316', '#8b5cf6'];

            container.innerHTML = topProducts.map(([product, gmv], i) => {
                const pct = maxGmv > 0 ? (gmv / maxGmv * 100) : 0;
                const displayName = product.length > 30 ? product.substring(0, 30) + '...' : product;
                return `
                    <div class="product-bar">
                        <div class="product-bar-header">
                            <span class="product-bar-name">${displayName}</span>
                            <span class="product-bar-value">${fmtMoney(gmv)}</span>
                        </div>
                        <div class="product-bar-track">
                            <div class="product-bar-fill" style="width: ${pct}%; background: ${colors[i % colors.length]};"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadTopVideos(handles, startDate, endDate) {
            const container = document.getElementById('statsVideoList');

            // Guard against empty handles
            if (!handles || handles.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No videos yet</div></div>';
                return;
            }

            // Fetch actual videos from video_performance table
            let query = supabaseClient
                .from('video_performance')
                .select('video_id, video_title, product_name, creator_name, gmv, orders, report_date')
                .gte('report_date', localDateStr(startDate))
                .lte('report_date', localDateStr(endDate))
                .gt('gmv', 0)
                .order('gmv', { ascending: false })
                .limit(50);
            
            query = applyHandleFilter(query, handles);

            if (currentBrand !== 'all') {
                query = query.eq('brand', currentBrand);
            }

            const { data } = await query;

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No videos yet</div></div>';
                return;
            }

            // Aggregate by video_id to get total GMV per video
            const videoMap = {};
            data.forEach(v => {
                const key = v.video_id || `${v.creator_name}_${v.video_title || v.product_name}`;
                if (!videoMap[key]) {
                    videoMap[key] = {
                        video_id: v.video_id,
                        video_title: v.video_title,
                        product_name: v.product_name,
                        creator_name: v.creator_name,
                        gmv: 0,
                        orders: 0,
                        first_date: v.report_date
                    };
                }
                videoMap[key].gmv += pFloat(v.gmv);
                videoMap[key].orders += pInt(v.orders);
                // Track earliest date
                if (v.report_date < videoMap[key].first_date) {
                    videoMap[key].first_date = v.report_date;
                }
            });

            const topVideos = Object.values(videoMap)
                .sort((a, b) => b.gmv - a.gmv)
                .slice(0, 8);

            container.innerHTML = topVideos.map((v, i) => {
                const hasVideoId = v.video_id && v.video_id.length > 5;
                const rank = i + 1;
                const medal = rank <= 3 ? ['', '', ''][rank - 1] : `#${rank}`;
                const productDisplay = v.product_name ? (v.product_name.length > 35 ? v.product_name.substring(0, 35) + '...' : v.product_name) : (v.video_title || 'Video');
                const productEscaped = (v.product_name || v.video_title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                // Format date
                const dateObj = new Date(v.first_date + 'T12:00:00');
                const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                // Conversion rate (orders per video, but since we don't have views, just show orders)
                const ordersPerDay = v.orders;
                
                // If has video ID, open embedded player; otherwise link to profile
                const clickAction = hasVideoId 
                    ? `openVideoPlayer('${v.video_id}', '${v.creator_name}', '${productEscaped}', ${v.gmv}, ${v.orders})`
                    : `window.open('https://www.tiktok.com/@${v.creator_name}', '_blank')`;
                
                return `
                <div class="video-list-item" onclick="${clickAction}">
                    <div class="video-list-thumb">${medal}</div>
                    <div class="video-list-info">
                        <div class="video-list-title">${productDisplay}</div>
                        <div class="video-list-meta">@${v.creator_name}  ${dateStr}</div>
                    </div>
                    <div class="video-list-stats">
                        <div class="video-list-gmv">${fmtMoney(v.gmv)}</div>
                        <div class="video-list-orders">${fmtNum(v.orders)} orders</div>
                    </div>
                </div>
            `}).join('');
        }

        function setStatsPeriod(period) {
            statsPeriod = period;
            
            // Update buttons (only in stats section)
            document.querySelectorAll('#view-stats .period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period == period);
            });
            
            // Update date range display
            updateDateRangeDisplay('statsDateRangeText', period, period === 'all');

            loadStatsData();
        }

        // ==================== LEADERBOARD ====================
        let rankPeriod = '7';
        let currentLeaderboardTab = 'creators';

        // Calculate date range based on period
        function getRankDateRange(period) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            let startDate, endDate;
            endDate = yesterday;
            
            switch(period) {
                case '7':
                    startDate = new Date(yesterday);
                    startDate.setDate(yesterday.getDate() - 6);
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0); // Last day of prev month
                    break;
                case 'quarter':
                    const quarterStart = Math.floor(today.getMonth() / 3) * 3;
                    startDate = new Date(today.getFullYear(), quarterStart, 1);
                    break;
                default:
                    startDate = new Date(yesterday);
                    startDate.setDate(yesterday.getDate() - 6);
            }
            
            return { startDate, endDate };
        }
        
        // Format date range for display
        function formatRankDateRange(period) {
            const { startDate, endDate } = getRankDateRange(period);
            const options = { month: 'short', day: 'numeric' };
            const start = startDate.toLocaleDateString('en-US', options);
            const end = endDate.toLocaleDateString('en-US', options);
            
            if (startDate.getMonth() === endDate.getMonth()) {
                return `${start}  ${endDate.getDate()}`;
            }
            return `${start}  ${end}`;
        }

        function setRankPeriod(period) {
            rankPeriod = period;
            
            // Update buttons
            document.querySelectorAll('#view-rank .period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            
            // Update date range display
            document.getElementById('rankDateRangeText').textContent = formatRankDateRange(period);

            // Reload all leaderboards
            loadAllLeaderboards();
        }
        
        function switchLeaderboardTab(tab) {
            currentLeaderboardTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.leaderboard-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            // Show/hide sections
            document.querySelectorAll('.leaderboard-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`leaderboard-${tab}`).style.display = 'block';
        }
        
        async function loadAllLeaderboards() {
            loadLeaderboard();
            loadTopVideos();
            loadNewVideos();
        }

        async function loadLeaderboard() {
            if (userStatus !== 'accepted') return;

            const container = document.getElementById('leaderboardList');
            container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

            const filterBrand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            const { startDate, endDate } = getRankDateRange(rankPeriod);
            
            // Calculate prior period dates for movement comparison
            const periodDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const priorEndDate = new Date(startDate);
            priorEndDate.setDate(priorEndDate.getDate() - 1);
            const priorStartDate = new Date(priorEndDate);
            priorStartDate.setDate(priorStartDate.getDate() - (periodDays - 1));

            // Fetch current period data
            let query = supabaseClient
                .from('creator_performance')
                .select('creator_name, gmv')
                .eq('period_type', 'daily')
                .gte('report_date', localDateStr(startDate))
                .lte('report_date', localDateStr(endDate));

            if (filterBrand) {
                query = query.eq('brand', filterBrand);
            }

            const { data } = await query;
            
            // Fetch prior period data for movement tracking
            let priorRanks = {};
            let priorQuery = supabaseClient
                .from('creator_performance')
                .select('creator_name, gmv')
                .eq('period_type', 'daily')
                .gte('report_date', localDateStr(priorStartDate))
                .lte('report_date', localDateStr(priorEndDate));

            if (filterBrand) {
                priorQuery = priorQuery.eq('brand', filterBrand);
            }

            const { data: priorData } = await priorQuery;
            
            // Aggregate prior period
            const priorGmv = {};
            (priorData || []).forEach(r => {
                const name = r.creator_name.toLowerCase();
                priorGmv[name] = (priorGmv[name] || 0) + pFloat(r.gmv);
            });
            
            // Calculate prior ranks
            const priorSorted = Object.entries(priorGmv).sort((a, b) => b[1] - a[1]);
            priorSorted.forEach(([name], i) => {
                priorRanks[name] = i + 1;
            });

            // Get my handles
            const myHandles = getCreatorHandles().map(h => h.toLowerCase());

            // Aggregate current period
            const creatorGmv = {};
            (data || []).forEach(r => {
                const name = r.creator_name.toLowerCase();
                creatorGmv[name] = (creatorGmv[name] || 0) + pFloat(r.gmv);
            });

            const fullSorted = Object.entries(creatorGmv).sort((a, b) => b[1] - a[1]);
            const totalCreators = fullSorted.length;

            // Find my position
            let myRank = 0;
            let myGmv = 0;
            let myPriorRank = 0;
            for (let i = 0; i < fullSorted.length; i++) {
                if (myHandles.includes(fullSorted[i][0])) {
                    myRank = i + 1;
                    myGmv = fullSorted[i][1];
                    myPriorRank = priorRanks[fullSorted[i][0]] || 0;
                    break;
                }
            }

            // Update "Your Position" card
            document.getElementById('rankYourRank').textContent = myRank > 0 ? `#${myRank}` : '#-';
            document.getElementById('rankYourGmv').textContent = fmtMoney(myGmv);
            document.getElementById('rankTotalCreators').textContent = `of ${totalCreators.toLocaleString()} creators`;

            // Movement indicator
            const movementEl = document.getElementById('rankMovement');
            if (myPriorRank > 0 && myRank > 0) {
                const movement = myPriorRank - myRank;
                if (movement > 0) {
                    movementEl.textContent = ` ${movement}`;
                    movementEl.className = 'rank-position-movement up';
                } else if (movement < 0) {
                    movementEl.textContent = ` ${Math.abs(movement)}`;
                    movementEl.className = 'rank-position-movement down';
                } else {
                    movementEl.textContent = ' Same';
                    movementEl.className = 'rank-position-movement same';
                }
            } else {
                movementEl.textContent = '';
                movementEl.className = 'rank-position-movement';
            }

            // Progress to next rank
            const progressSection = document.getElementById('rankProgressSection');
            if (myRank > 1 && fullSorted[myRank - 2]) {
                progressSection.style.display = 'block';
                const nextUp = fullSorted[myRank - 2];
                const diff = nextUp[1] - myGmv;
                const total = nextUp[1];
                const progressPct = total > 0 ? Math.min(100, (myGmv / total) * 100) : 0;
                
                document.getElementById('rankProgressText').textContent = `Progress to #${myRank - 1}`;
                document.getElementById('rankBeatNext').textContent = `${fmtMoney(diff)} to go`;
                document.getElementById('rankProgressFill').style.width = `${progressPct}%`;
            } else {
                progressSection.style.display = myRank === 1 ? 'none' : 'block';
                if (myRank !== 1) {
                    document.getElementById('rankProgressText').textContent = 'Keep posting to climb!';
                    document.getElementById('rankBeatNext').textContent = '';
                    document.getElementById('rankProgressFill').style.width = '0%';
                }
            }

            // Motivation message
            const motivationEl = document.getElementById('rankMotivation');
            if (myRank === 1) {
                motivationEl.textContent = ' You\'re #1! Defend your crown!';
            } else if (myRank <= 3) {
                motivationEl.textContent = ' Podium finish! You\'re in the top 3!';
            } else if (myRank <= 10) {
                motivationEl.textContent = ' Top 10! You\'re crushing it!';
            } else if (myRank > 0 && fullSorted[myRank - 2]) {
                const diff = fullSorted[myRank - 2][1] - myGmv;
                if (diff < 500) {
                    motivationEl.textContent = ` So close! Just ${fmtMoney(diff)} more to climb!`;
                } else {
                    motivationEl.textContent = '';
                }
            } else {
                motivationEl.textContent = '';
            }

            // Render podium (top 3)
            renderPodium(fullSorted.slice(0, 3), myHandles);

            // Render leaderboard (skip top 3, show 4-25)
            const listItems = fullSorted.slice(3, 25);
            
            if (listItems.length === 0 && fullSorted.length <= 3) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Only top 3 creators this period</div>';
            } else {
                container.innerHTML = listItems.map(([name, gmv], i) => {
                    const isMe = myHandles.includes(name);
                    const rank = i + 4;
                    const tier = getTierByGmv(gmv);
                    const tiktokUrl = `https://www.tiktok.com/@${name}`;
                    const priorRank = priorRanks[name];
                    const movement = priorRank ? priorRank - rank : 0;
                    
                    let changeHtml = '';
                    if (movement > 0) {
                        changeHtml = `<span class="leaderboard-change up">${movement}</span>`;
                    } else if (movement < 0) {
                        changeHtml = `<span class="leaderboard-change down">${Math.abs(movement)}</span>`;
                    }
                    
                    return `
                        <a href="${tiktokUrl}" target="_blank" class="leaderboard-item ${isMe ? 'highlight' : ''}" style="text-decoration: none; color: inherit;">
                            <div class="leaderboard-rank">#${rank}</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${isMe ? ' ' : ''}@${name}</div>
                                <span class="leaderboard-tier" style="background: ${tier.color}20; color: ${tier.color};">${tier.emoji} ${tier.name}</span>
                            </div>
                            <div class="leaderboard-stats">
                                <div class="leaderboard-gmv">${fmtMoney(gmv)}</div>
                                ${changeHtml}
                            </div>
                        </a>
                    `;
                }).join('');
            }
        }
        
        async function loadTopVideos() {
            if (userStatus !== 'accepted') return;
            
            const container = document.getElementById('topVideosList');
            container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            
            const filterBrand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            const { startDate, endDate } = getRankDateRange(rankPeriod);
            const myHandles = getCreatorHandles().map(h => h.toLowerCase());
            
            let query = supabaseClient
                .from('video_performance')
                .select('video_id, video_title, product_name, creator_name, gmv, orders, video_cover')
                .gte('report_date', localDateStr(startDate))
                .lte('report_date', localDateStr(endDate))
                .gt('gmv', 0);
            
            if (filterBrand) {
                query = query.eq('brand', filterBrand);
            }
            
            const { data } = await query;
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No videos this period</div>';
                return;
            }
            
            // Aggregate by video_id
            const videoMap = {};
            data.forEach(v => {
                const key = v.video_id || `${v.creator_name}_${v.product_name}`;
                if (!videoMap[key]) {
                    videoMap[key] = { ...v, gmv: 0, orders: 0 };
                }
                videoMap[key].gmv += pFloat(v.gmv);
                videoMap[key].orders += pInt(v.orders);
                if (v.video_cover) videoMap[key].video_cover = v.video_cover;
            });
            
            const sorted = Object.values(videoMap).sort((a, b) => b.gmv - a.gmv).slice(0, 20);
            
            container.innerHTML = sorted.map((v, i) => {
                const isMe = myHandles.includes(v.creator_name.toLowerCase());
                const hasVideoId = v.video_id && v.video_id.length > 5;
                const productEscaped = (v.product_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const clickAction = hasVideoId 
                    ? `openVideoPlayer('${v.video_id}', '${v.creator_name}', '${productEscaped}', ${v.gmv}, ${v.orders})`
                    : `window.open('https://www.tiktok.com/@${v.creator_name}', '_blank')`;
                
                return `
                    <div class="video-leaderboard-item ${isMe ? 'video-leaderboard-is-me' : ''}" onclick="${clickAction}">
                        <div class="video-leaderboard-rank ${i < 3 ? 'top3' : ''}">${i + 1}</div>
                        <div class="video-leaderboard-thumb">
                            ${v.video_cover ? `<img src="${v.video_cover}" alt="">` : ''}
                        </div>
                        <div class="video-leaderboard-info">
                            <div class="video-leaderboard-product">${v.product_name || 'Video'}</div>
                            <div class="video-leaderboard-creator">${isMe ? ' ' : ''}@${v.creator_name}</div>
                        </div>
                        <div class="video-leaderboard-stats">
                            <div class="video-leaderboard-gmv">${fmtMoney(v.gmv)}</div>
                            <div class="video-leaderboard-orders">${v.orders.toLocaleString()} orders</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadNewVideos() {
            if (userStatus !== 'accepted') return;
            
            const container = document.getElementById('newVideosList');
            container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            
            const filterBrand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            const myHandles = getCreatorHandles().map(h => h.toLowerCase());
            
            // New videos = first_date within last 7 days
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const sevenDaysAgo = new Date(yesterday);
            sevenDaysAgo.setDate(yesterday.getDate() - 6);
            
            let query = supabaseClient
                .from('video_performance')
                .select('video_id, video_title, product_name, creator_name, gmv, orders, video_cover, first_date')
                .gte('first_date', localDateStr(sevenDaysAgo))
                .lte('first_date', localDateStr(yesterday))
                .gt('gmv', 0);
            
            if (filterBrand) {
                query = query.eq('brand', filterBrand);
            }
            
            const { data } = await query;
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No new videos in the last 7 days</div>';
                return;
            }
            
            // Aggregate by video_id
            const videoMap = {};
            data.forEach(v => {
                const key = v.video_id || `${v.creator_name}_${v.product_name}`;
                if (!videoMap[key]) {
                    videoMap[key] = { ...v, gmv: 0, orders: 0 };
                }
                videoMap[key].gmv += pFloat(v.gmv);
                videoMap[key].orders += pInt(v.orders);
                if (v.video_cover) videoMap[key].video_cover = v.video_cover;
            });
            
            const sorted = Object.values(videoMap).sort((a, b) => b.gmv - a.gmv).slice(0, 20);
            
            // Calculate days ago for each video
            const getDaysAgo = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const diff = Math.floor((yesterday - date) / (1000 * 60 * 60 * 24));
                if (diff === 0) return 'Yesterday';
                if (diff === 1) return '2 days ago';
                return `${diff + 1} days ago`;
            };
            
            container.innerHTML = sorted.map((v, i) => {
                const isMe = myHandles.includes(v.creator_name.toLowerCase());
                const hasVideoId = v.video_id && v.video_id.length > 5;
                const productEscaped = (v.product_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const clickAction = hasVideoId 
                    ? `openVideoPlayer('${v.video_id}', '${v.creator_name}', '${productEscaped}', ${v.gmv}, ${v.orders})`
                    : `window.open('https://www.tiktok.com/@${v.creator_name}', '_blank')`;
                const daysAgo = getDaysAgo(v.first_date);
                
                return `
                    <div class="video-leaderboard-item ${isMe ? 'video-leaderboard-is-me' : ''}" onclick="${clickAction}">
                        <div class="video-leaderboard-rank ${i < 3 ? 'top3' : ''}">${i + 1}</div>
                        <div class="video-leaderboard-thumb">
                            ${v.video_cover ? `<img src="${v.video_cover}" alt="">` : ''}
                        </div>
                        <div class="video-leaderboard-info">
                            <div class="video-leaderboard-product">
                                ${v.product_name || 'Video'}
                                <span class="video-leaderboard-new-badge">NEW</span>
                            </div>
                            <div class="video-leaderboard-creator">${isMe ? ' ' : ''}@${v.creator_name}  ${daysAgo}</div>
                        </div>
                        <div class="video-leaderboard-stats">
                            <div class="video-leaderboard-gmv">${fmtMoney(v.gmv)}</div>
                            <div class="video-leaderboard-orders">${v.orders.toLocaleString()} orders</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPodium(top3, myHandles) {
            const positions = [
                { el: 'podium2', index: 1 }, // 2nd place (left)
                { el: 'podium1', index: 0 }, // 1st place (center)
                { el: 'podium3', index: 2 }  // 3rd place (right)
            ];

            positions.forEach(({ el, index }) => {
                const podiumEl = document.getElementById(el);
                const creator = top3[index];
                
                if (creator) {
                    const [name, gmv] = creator;
                    const isMe = myHandles.includes(name);
                    const tiktokUrl = `https://www.tiktok.com/@${name}`;
                    
                    const nameEl = podiumEl.querySelector('.podium-name');
                    nameEl.textContent = `@${name}`;
                    // Add size class based on name length
                    nameEl.classList.remove('long-name', 'very-long-name');
                    if (name.length > 18) {
                        nameEl.classList.add('very-long-name');
                    } else if (name.length > 12) {
                        nameEl.classList.add('long-name');
                    }
                    
                    podiumEl.querySelector('.podium-gmv').textContent = fmtMoney(gmv);
                    podiumEl.classList.toggle('highlight', isMe);
                    podiumEl.onclick = () => window.open(tiktokUrl, '_blank');
                } else {
                    podiumEl.querySelector('.podium-name').textContent = '-';
                    podiumEl.querySelector('.podium-gmv').textContent = '$0';
                    podiumEl.classList.remove('highlight');
                    podiumEl.onclick = null;
                }
            });
        }

        function getTierByGmv(gmv) {
            // Estimate 30-day GMV from period
            let periodDays;
            switch(rankPeriod) {
                case '7': periodDays = 7; break;
                case 'thisMonth': 
                    const now = new Date();
                    periodDays = now.getDate(); // Days so far this month
                    break;
                case 'lastMonth':
                    const lastMonth = new Date();
                    lastMonth.setMonth(lastMonth.getMonth() - 1);
                    periodDays = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0).getDate();
                    break;
                case 'quarter':
                    const today = new Date();
                    const quarterStart = Math.floor(today.getMonth() / 3) * 3;
                    const quarterStartDate = new Date(today.getFullYear(), quarterStart, 1);
                    periodDays = Math.ceil((today - quarterStartDate) / (1000 * 60 * 60 * 24));
                    break;
                default: periodDays = 7;
            }
            
            const estimated = gmv * (30 / Math.max(periodDays, 1));
            
            if (estimated >= 50000) return { name: 'Platinum', emoji: '', color: '#e5e4e2' };
            if (estimated >= 20000) return { name: 'Gold', emoji: '', color: '#ffd700' };
            if (estimated >= 5000) return { name: 'Silver', emoji: '', color: '#c0c0c0' };
            if (estimated >= 2000) return { name: 'Bronze', emoji: '', color: '#cd7f32' };
            return { name: 'Unranked', emoji: '', color: '#6b7280' };
        }

        // ==================== PROFILE ====================
        async function loadProfileData() {
            // Avatar (large version)
            const avatar = document.getElementById('profileAvatar');
            if (currentUser.avatar) {
                avatar.innerHTML = `<img src="${currentUser.avatar}" alt="">`;
            } else {
                avatar.textContent = currentUser.username?.charAt(0).toUpperCase() || '?';
            }

            // Name & handle
            document.getElementById('profileName').textContent = currentProfile?.real_name || currentUser.global_name || currentUser.username;
            const accountCount = [currentProfile?.account_1, currentProfile?.account_2, currentProfile?.account_3, currentProfile?.account_4, currentProfile?.account_5]
                .filter(a => a && a.trim()).length;
            const handleText = accountCount > 1 
                ? `@${currentProfile?.account_1} +${accountCount - 1} more`
                : `@${currentProfile?.account_1 || currentUser.username}`;
            document.getElementById('profileHandle').textContent = handleText;

            // Member since date
            const memberSince = currentProfile?.created_at || currentProfile?.joined_date;
            if (memberSince) {
                const date = new Date(memberSince);
                document.getElementById('profileMemberSince').textContent = `Member since ${date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;
            }

            // Tier and all-time stats
            if (userStatus === 'accepted') {
                const handles = getCreatorHandles();
                
                // Guard against empty handles
                if (handles.length === 0) {
                    document.getElementById('profileTier').textContent = 'New Creator';
                    document.getElementById('profileTier').className = 'tier-badge tier-unranked';
                } else {
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const thirtyDaysAgo = new Date(yesterday);
                    thirtyDaysAgo.setDate(yesterday.getDate() - 29);

                    // Get 30-day GMV for tier
                    let recentQuery = supabaseClient
                        .from('creator_performance')
                        .select('gmv')
                        .eq('period_type', 'daily')
                        .gte('report_date', localDateStr(thirtyDaysAgo))
                        .lte('report_date', localDateStr(yesterday));
                    
                    recentQuery = applyHandleFilter(recentQuery, handles);
                    
                    const { data: recentData } = await recentQuery;

                    const gmv30d = (recentData || []).reduce((s, r) => s + pFloat(r.gmv), 0);
                    const tier = getTier(gmv30d);

                    const tierBadge = document.getElementById('profileTier');
                    tierBadge.textContent = tier.emoji ? `${tier.emoji} ${tier.name}` : tier.name;
                    tierBadge.className = `tier-badge ${tier.class}`;

                    // Update tier progress
                    updateTierProgress(gmv30d, tier);

                    // Get all-time stats for achievements
                    // Videos come from the 'videos' column (source of truth from Creator_Data)
                    let allTimeQuery = supabaseClient
                        .from('creator_performance')
                        .select('gmv, orders, videos')
                        .eq('period_type', 'daily')
                        .limit(50000);
                    
                    allTimeQuery = applyHandleFilter(allTimeQuery, handles);
                    
                    const { data: allTimeData } = await allTimeQuery;

                    const allTimeGmv = (allTimeData || []).reduce((s, r) => s + pFloat(r.gmv), 0);
                    const allTimeOrders = (allTimeData || []).reduce((s, r) => s + pInt(r.orders), 0);
                    const totalVideos = (allTimeData || []).reduce((s, r) => s + pInt(r.videos), 0);

                    // Store for achievements
                    window.profileStats = { 
                        totalGmv: allTimeGmv, 
                        totalOrders: allTimeOrders, 
                        totalVideos: totalVideos,
                        tier: tier
                    };

                    // Load best video
                    loadBestVideo(handles);
                }
            }

            // Account info
            document.getElementById('profileDiscord').textContent = currentUser.username;
            document.getElementById('profileEmail').textContent = currentProfile?.email || '-';
            document.getElementById('profileStatus').innerHTML = userStatus === 'accepted' 
                ? '<span style="color: var(--success);"> Active</span>' 
                : '<span style="color: var(--warning);"> Pending</span>';

            // Load brands list
            loadProfileBrands();

            // Load TikTok accounts list
            await loadTikTokAccounts();

            // Achievements
            loadAchievements();

            // Payment history
            loadPaymentHistory();

            // Discord link
            updateProfileDiscordLink();

            // Notification preferences
            loadNotificationPrefs();
        }

        function updateTierProgress(gmv30d, currentTier) {
            const tierThresholds = [
                { name: 'Unranked', emoji: '', min: 0, max: 2000 },
                { name: 'Bronze', emoji: '', min: 2000, max: 5000 },
                { name: 'Silver', emoji: '', min: 5000, max: 20000 },
                { name: 'Gold', emoji: '', min: 20000, max: 50000 },
                { name: 'Platinum', emoji: '', min: 50000, max: null }
            ];

            const currentIndex = tierThresholds.findIndex(t => t.name === currentTier.name);
            const current = tierThresholds[currentIndex] || tierThresholds[0];
            const next = tierThresholds[currentIndex + 1];

            document.getElementById('tierProgressEmoji').textContent = current.emoji || '';
            document.getElementById('tierProgressName').textContent = current.name;

            if (!next) {
                // Max tier reached
                document.getElementById('tierProgressCard').classList.add('maxed');
                document.getElementById('tierProgressNext').innerHTML = ' <span style="color: var(--success);">Max Tier!</span>';
                document.getElementById('tierProgressFill').style.width = '100%';
                document.getElementById('tierProgressCurrent').textContent = fmtMoney(gmv30d);
                document.getElementById('tierProgressTarget').textContent = '';
                document.getElementById('tierProgressRemaining').innerHTML = ' You\'ve reached Platinum status!';
            } else {
                document.getElementById('tierProgressCard').classList.remove('maxed');
                document.getElementById('tierProgressNext').innerHTML = `Next: <span class="tier-progress-next-name">${next.name}</span> ${next.emoji}`;
                
                const progress = ((gmv30d - current.min) / (next.min - current.min)) * 100;
                document.getElementById('tierProgressFill').style.width = `${Math.min(100, Math.max(0, progress))}%`;
                document.getElementById('tierProgressCurrent').textContent = fmtMoney(gmv30d);
                document.getElementById('tierProgressTarget').textContent = fmtMoney(next.min);
                
                const remaining = next.min - gmv30d;
                document.getElementById('tierProgressRemaining').innerHTML = `<span class="tier-progress-amount">${fmtMoney(remaining)}</span> to go`;
            }
        }

        async function loadBestVideo(handles) {
            const card = document.getElementById('bestVideoCard');
            const container = document.getElementById('bestVideoContent');

            // Guard against empty handles
            if (!handles || handles.length === 0) {
                card.style.display = 'none';
                return;
            }

            // Get best video by GMV
            let bestQuery = supabaseClient
                .from('video_performance')
                .select('video_id, product_name, gmv, orders, first_date, video_cover')
                .order('gmv', { ascending: false })
                .limit(1);
            
            bestQuery = applyHandleFilter(bestQuery, handles);
            
            const { data } = await bestQuery;

            if (!data || data.length === 0) {
                card.style.display = 'none';
                return;
            }

            const video = data[0];
            card.style.display = 'block';

            const dateStr = video.first_date 
                ? new Date(video.first_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : '';

            container.innerHTML = `
                <div class="best-video-thumb">
                    ${video.video_cover 
                        ? `<img src="${video.video_cover}" alt="">` 
                        : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem;"></div>'}
                </div>
                <div class="best-video-info">
                    <div class="best-video-product">${video.product_name || 'Video'}</div>
                    <div class="best-video-stats">
                        <div class="best-video-stat">
                            <span></span>
                            <span class="best-video-stat-value">${fmtMoney(video.gmv)}</span>
                        </div>
                        <div class="best-video-stat">
                            <span></span>
                            <span class="best-video-stat-value">${fmtNum(video.orders)}</span> orders
                        </div>
                    </div>
                    ${dateStr ? `<div class="best-video-date">Posted ${dateStr}</div>` : ''}
                </div>
            `;
        }

        function loadNotificationPrefs() {
            // Load from localStorage for now - can be moved to database later
            const prefs = JSON.parse(localStorage.getItem('notificationPrefs') || '{}');
            
            document.getElementById('prefWeeklySummary').checked = prefs.weekly_summary ?? false;
            document.getElementById('prefMilestones').checked = prefs.milestones ?? true;
            document.getElementById('prefPayments').checked = prefs.payments ?? true;
            document.getElementById('prefCampaigns').checked = prefs.campaigns ?? true;
        }

        function saveNotificationPref(key, value) {
            const prefs = JSON.parse(localStorage.getItem('notificationPrefs') || '{}');
            prefs[key] = value;
            localStorage.setItem('notificationPrefs', JSON.stringify(prefs));
            
            // Could save to database here for server-side notifications
            // await supabaseClient.from('creator_preferences').upsert({ discord_id: currentUser.id, [key]: value });
        }

        function loadProfileBrands() {
            const container = document.getElementById('profileBrandsList');
            const brandInfo = {
                'catakor': { icon: '', name: 'Cata-Kor', color: '#ef4444' },
                'jiyu': { icon: '', name: 'JiYu', color: '#8b5cf6' },
                'physicians_choice': { icon: '', name: 'Physicians Choice', color: '#3b82f6' },
                'peach_slices': { icon: '', name: 'Peach Slices', color: '#f97316' },
                'yerba_magic': { icon: '', name: 'Yerba Magic', color: '#22c55e' },
                'toplux': { icon: '', name: 'Toplux Nutrition', color: '#00b894' }
            };

            const myBrands = new Set();
            creatorProfiles.forEach(p => {
                if (p.brand) myBrands.add(p.brand);
            });

            if (myBrands.size === 0) {
                container.innerHTML = '<div class="text-muted">No brands yet</div>';
                return;
            }

            container.innerHTML = Array.from(myBrands).map(brand => {
                const info = brandInfo[brand] || { icon: '', name: brand, color: '#888' };
                return `
                    <div class="profile-brand-tag" style="border: 1px solid ${info.color}40;">
                        <span class="profile-brand-tag-icon">${info.icon}</span>
                        <span>${info.name}</span>
                    </div>
                `;
            }).join('');
        }

        function updateProfileDiscordLink() {
            const link = document.getElementById('profileDiscordLink');
            if (!link) return;
            
            const discordLinks = {
                'catakor': 'https://discord.gg/catakor',
                'jiyu': 'https://discord.gg/jiyu',
                'physicians_choice': 'https://discord.gg/physicianschoice',
                'peach_slices': 'https://discord.gg/peachslices',
                'yerba_magic': 'https://discord.gg/yerbamagic'
            };

            const brand = currentBrand !== 'all' ? currentBrand : (currentProfile?.brand || null);
            link.href = discordLinks[brand] || 'https://discord.gg/creatorscorner';
        }

        let accountRequests = [];
        
        async function loadTikTokAccounts() {
            const container = document.getElementById('tiktokAccountsList');
            
            // Get current linked accounts from all profiles with their source info
            const linkedAccounts = [];
            creatorProfiles.forEach(p => {
                const accountColumns = ['account_1', 'account_2', 'account_3', 'account_4', 'account_5', 
                                        'account_6', 'account_7', 'account_8', 'account_9', 'account_10'];
                accountColumns.forEach(col => {
                    const handle = p[col];
                    if (handle && handle.trim()) {
                        linkedAccounts.push({
                            handle: handle.toLowerCase(),
                            displayHandle: handle,
                            profileId: p.id,
                            column: col,
                            brand: p.brand,
                            isPrimary: col === 'account_1'
                        });
                    }
                });
            });
            
            // Get pending/denied requests for this user
            const { data: requests } = await supabaseClient
                .from('creator_account_requests')
                .select('*')
                .eq('discord_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            accountRequests = requests || [];
            const totalAccounts = linkedAccounts.length;
            const maxAccounts = 10;
            
            let html = `<div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">${totalAccounts} of ${maxAccounts} accounts used</div>`;
            
            // Show linked accounts (active) with remove option
            linkedAccounts.forEach(acc => {
                const brandLabel = BRAND_DISPLAY[acc.brand] || acc.brand || '';
                html += `
                    <div class="account-item">
                        <div class="account-info">
                            <div class="account-icon" style="background: var(--success-dim); color: var(--success);"></div>
                            <div>
                                <div class="account-handle">@${acc.displayHandle}</div>
                                ${brandLabel ? `<div style="font-size: 0.75rem; color: var(--text-muted);">${brandLabel}${acc.isPrimary ? '  Primary' : ''}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="account-status status-active">Active</span>
                            ${!acc.isPrimary ? `<button class="account-remove" onclick="removeAccount('${acc.profileId}', '${acc.column}', '${acc.displayHandle}')" title="Remove account"></button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            // Show pending requests
            const pendingRequests = accountRequests.filter(r => r.status === 'pending');
            const linkedHandles = linkedAccounts.map(a => a.handle);
            pendingRequests.forEach(req => {
                if (!linkedHandles.includes(req.tiktok_handle.toLowerCase())) {
                    html += `
                        <div class="account-item">
                            <div class="account-info">
                                <div class="account-icon" style="background: var(--warning-dim); color: var(--warning);"></div>
                                <div>
                                    <div class="account-handle">@${req.tiktok_handle}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Pending verification</div>
                                </div>
                            </div>
                            <button class="account-remove" onclick="cancelAccountRequest(${req.id})" title="Cancel request"></button>
                        </div>
                    `;
                }
            });
            
            // Show denied requests
            const deniedRequests = accountRequests.filter(r => r.status === 'denied');
            deniedRequests.forEach(req => {
                if (!linkedHandles.includes(req.tiktok_handle.toLowerCase())) {
                    html += `
                        <div class="account-item">
                            <div class="account-info">
                                <div class="account-icon" style="background: var(--danger-dim); color: var(--danger);"></div>
                                <div>
                                    <div class="account-handle">@${req.tiktok_handle}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${req.denial_reason || 'Request denied'}</div>
                                </div>
                            </div>
                            <span class="account-status status-denied">Denied</span>
                        </div>
                    `;
                }
            });
            
            if (linkedAccounts.length === 0 && pendingRequests.length === 0) {
                html = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No TikTok accounts linked yet</div>';
            }
            
            container.innerHTML = html;
            
            // Disable add button if at max
            const addBtn = document.querySelector('.card-header .btn-small');
            if (addBtn) {
                if (totalAccounts >= maxAccounts) {
                    addBtn.disabled = true;
                    addBtn.style.opacity = '0.5';
                    addBtn.style.cursor = 'not-allowed';
                    addBtn.title = 'Maximum 10 accounts reached';
                } else {
                    addBtn.disabled = false;
                    addBtn.style.opacity = '1';
                    addBtn.style.cursor = 'pointer';
                    addBtn.title = '';
                }
            }
        }
        
        async function removeAccount(profileId, column, handle) {
            if (!confirm(`Remove @${handle} from your account?\n\nYou can add it back later if needed.`)) {
                return;
            }
            
            try {
                // Clear the account column
                const { error } = await supabaseClient
                    .from('managed_creators')
                    .update({ [column]: null })
                    .eq('id', profileId);
                
                if (error) throw error;
                
                // Refresh the local profile data
                const profile = creatorProfiles.find(p => p.id == profileId);
                if (profile) {
                    profile[column] = null;
                }
                
                // Reload the accounts list
                loadTikTokAccounts();
                
            } catch (err) {
                console.error('Error removing account:', err);
                alert('Failed to remove account. Please try again.');
            }
        }
        
        function showAddAccountModal() {
            document.getElementById('addAccountModal').style.display = 'block';
            document.getElementById('newAccountHandle').value = '';
            document.getElementById('addAccountMessage').style.display = 'none';
            document.getElementById('newAccountHandle').focus();
        }
        
        function hideAddAccountModal() {
            document.getElementById('addAccountModal').style.display = 'none';
        }
        
        async function submitAccountRequest() {
            const handleInput = document.getElementById('newAccountHandle');
            const messageDiv = document.getElementById('addAccountMessage');
            let handle = handleInput.value.trim().toLowerCase();
            
            // Remove @ if included
            if (handle.startsWith('@')) handle = handle.substring(1);
            
            if (!handle) {
                showAccountMessage('Please enter a TikTok handle', 'warning');
                return;
            }
            
            // Check if already linked to this user
            const linkedAccounts = new Set();
            creatorProfiles.forEach(p => {
                [p.account_1, p.account_2, p.account_3, p.account_4, p.account_5].forEach(a => {
                    if (a && a.trim()) linkedAccounts.add(a.toLowerCase());
                });
            });
            
            if (linkedAccounts.has(handle)) {
                showAccountMessage('This account is already linked to your profile', 'warning');
                return;
            }
            
            // Check if already has pending request
            const pendingForHandle = accountRequests.find(r => r.tiktok_handle.toLowerCase() === handle && r.status === 'pending');
            if (pendingForHandle) {
                showAccountMessage('You already have a pending request for this account', 'warning');
                return;
            }
            
            try {
                // Check if account is linked to a different Discord user
                const { data: existingCreator } = await supabaseClient
                    .from('managed_creators')
                    .select('discord_id, account_1')
                    .or(`account_1.ilike.${handle},account_2.ilike.${handle},account_3.ilike.${handle},account_4.ilike.${handle},account_5.ilike.${handle}`)
                    .not('discord_id', 'is', null)
                    .neq('discord_id', currentUser.id)
                    .limit(1);
                
                if (existingCreator && existingCreator.length > 0) {
                    showAccountMessage('This account is already linked to another creator. If you believe this is an error, please contact support.', 'error');
                    return;
                }
                
                // Check if account exists in our data (high-risk claim)
                const { data: hasData } = await supabaseClient
                    .from('daily_creator_data')
                    .select('creator_name')
                    .ilike('creator_name', handle)
                    .limit(1);
                
                const requiresReview = hasData && hasData.length > 0;
                
                // Check if account is already in managed_creators for this user (no discord linked yet)
                const { data: ownedUnlinked } = await supabaseClient
                    .from('managed_creators')
                    .select('id')
                    .or(`account_1.ilike.${handle},account_2.ilike.${handle},account_3.ilike.${handle},account_4.ilike.${handle},account_5.ilike.${handle}`)
                    .is('discord_id', null)
                    .limit(1);
                
                // Submit request
                const { error } = await supabaseClient
                    .from('creator_account_requests')
                    .insert({
                        discord_id: currentUser.id,
                        discord_username: currentUser.username,
                        tiktok_handle: handle,
                        status: requiresReview ? 'pending' : 'approved',
                        auto_approved: !requiresReview,
                        has_existing_data: requiresReview,
                        notes: requiresReview ? 'Account has existing data - requires verification' : 'No existing data - auto-approved'
                    });
                
                if (error) throw error;
                
                if (requiresReview) {
                    showAccountMessage('Request submitted! Your account will be verified by an admin (usually within 24 hours).', 'success');
                } else {
                    // Auto-approved - add to managed_creators if needed
                    showAccountMessage('Account added successfully!', 'success');
                }
                
                // Refresh the accounts list
                setTimeout(() => {
                    hideAddAccountModal();
                    loadTikTokAccounts();
                }, 1500);
                
            } catch (err) {
                console.error('Error submitting account request:', err);
                showAccountMessage('Failed to submit request. Please try again.', 'error');
            }
        }
        
        function showAccountMessage(message, type) {
            const div = document.getElementById('addAccountMessage');
            const colors = {
                success: { bg: 'var(--success-dim)', color: 'var(--success)' },
                warning: { bg: 'var(--warning-dim)', color: 'var(--warning)' },
                error: { bg: 'var(--danger-dim)', color: 'var(--danger)' }
            };
            div.style.display = 'block';
            div.style.background = colors[type]?.bg || colors.warning.bg;
            div.style.color = colors[type]?.color || colors.warning.color;
            div.textContent = message;
        }
        
        async function cancelAccountRequest(requestId) {
            if (!confirm('Cancel this account request?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('creator_account_requests')
                    .delete()
                    .eq('id', requestId)
                    .eq('discord_id', currentUser.id);
                
                if (error) throw error;
                loadTikTokAccounts();
            } catch (err) {
                console.error('Error canceling request:', err);
                alert('Failed to cancel request');
            }
        }

        async function loadAchievements() {
            const container = document.getElementById('achievementsGrid');
            
            if (userStatus !== 'accepted') {
                container.innerHTML = ACHIEVEMENTS.map(a => `
                    <div class="achievement-item locked">
                        <div class="achievement-icon">${a.icon}</div>
                        <div class="achievement-name">${a.name}</div>
                    </div>
                `).join('');
                document.getElementById('achievementCount').textContent = '0';
                return;
            }

            const handles = getCreatorHandles();

            // Guard against empty handles
            if (handles.length === 0) {
                container.innerHTML = ACHIEVEMENTS.map(a => `
                    <div class="achievement-item locked">
                        <div class="achievement-icon">${a.icon}</div>
                        <div class="achievement-name">${a.name}</div>
                    </div>
                `).join('');
                document.getElementById('achievementCount').textContent = '0';
                return;
            }

            // Get GMV, orders, and videos from creator_performance
            // Videos come from the 'videos' column (source of truth from Creator_Data)
            let achieveQuery = supabaseClient
                .from('creator_performance')
                .select('gmv, orders, videos')
                .eq('period_type', 'daily')
                .limit(50000);
            
            achieveQuery = applyHandleFilter(achieveQuery, handles);
            
            const { data: allTimeData } = await achieveQuery;

            const stats = {
                totalGmv: (allTimeData || []).reduce((s, r) => s + pFloat(r.gmv), 0),
                totalOrders: (allTimeData || []).reduce((s, r) => s + pInt(r.orders), 0),
                totalVideos: (allTimeData || []).reduce((s, r) => s + pInt(r.videos), 0),
                tier: getTier((allTimeData || []).reduce((s, r) => s + pFloat(r.gmv), 0)),
                streak: pInt(document.getElementById('streakCount')?.textContent) || 0
            };

            // Store for other uses
            window.profileStats = stats;

            let unlockedCount = 0;
            container.innerHTML = ACHIEVEMENTS.map(a => {
                const unlocked = a.check(stats);
                if (unlocked) unlockedCount++;
                
                // Calculate progress for locked achievements
                let progressHtml = '';
                if (!unlocked) {
                    const progress = getAchievementProgress(a.id, stats);
                    if (progress !== null) {
                        progressHtml = `<div class="achievement-progress">${progress}%</div>`;
                    }
                }
                
                return `
                    <div class="achievement-item ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${a.icon}</div>
                        <div class="achievement-name">${a.name}</div>
                        ${progressHtml}
                    </div>
                `;
            }).join('');

            document.getElementById('achievementCount').textContent = unlockedCount;
        }

        function getAchievementProgress(id, stats) {
            const progressMap = {
                'first_sale': stats.totalOrders > 0 ? 100 : 0,
                'ten_sales': Math.min(100, Math.round((stats.totalOrders / 10) * 100)),
                'hundred_sales': Math.min(100, Math.round((stats.totalOrders / 100) * 100)),
                'first_video': stats.totalVideos > 0 ? 100 : 0,
                'ten_videos': Math.min(100, Math.round((stats.totalVideos / 10) * 100)),
                'fifty_videos': Math.min(100, Math.round((stats.totalVideos / 50) * 100)),
                'hundred_gmv': Math.min(100, Math.round((stats.totalGmv / 100) * 100)),
                'thousand_gmv': Math.min(100, Math.round((stats.totalGmv / 1000) * 100)),
                'five_k_gmv': Math.min(100, Math.round((stats.totalGmv / 5000) * 100)),
                'week_streak': Math.min(100, Math.round((stats.streak / 7) * 100))
            };
            return progressMap[id] ?? null;
        }

        async function loadPaymentHistory() {
            const container = document.getElementById('paymentHistory');
            const totalEl = document.getElementById('totalEarnings');
            const summaryEl = document.getElementById('paymentSummary');

            if (userStatus !== 'accepted' || !currentProfile) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No payments yet</div></div>';
                if (totalEl) totalEl.textContent = '$0 earned';
                if (summaryEl) summaryEl.style.display = 'none';
                return;
            }

            // Get all handles for this creator
            const handles = getCreatorHandles();
            if (handles.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No payments yet</div></div>';
                if (totalEl) totalEl.textContent = '$0 earned';
                if (summaryEl) summaryEl.style.display = 'none';
                return;
            }

            // Get payments for all creator handles
            let payQuery = supabaseClient
                .from('creator_payments')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            
            payQuery = applyHandleFilter(payQuery, handles);
            
            const { data: payments } = await payQuery;

            if (!payments || payments.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"></div><div>No payments yet</div></div>';
                if (totalEl) totalEl.textContent = '$0 earned';
                if (summaryEl) summaryEl.style.display = 'none';
                return;
            }

            // Calculate totals
            const totalPaid = payments
                .filter(p => p.status === 'paid')
                .reduce((sum, p) => sum + pFloat(p.amount), 0);
            
            const totalPending = payments
                .filter(p => ['pending', 'approved', 'processing'].includes(p.status))
                .reduce((sum, p) => sum + pFloat(p.amount), 0);
            
            if (totalEl) totalEl.textContent = `${fmtMoney(totalPaid)} earned`;

            // Show summary if we have payments
            if (summaryEl) {
                summaryEl.style.display = 'grid';
                document.getElementById('paymentTotalPaid').textContent = fmtMoney(totalPaid);
                document.getElementById('paymentTotalPending').textContent = fmtMoney(totalPending);
            }

            const statusConfig = {
                'paid': { icon: '', label: 'Paid', class: 'paid' },
                'pending': { icon: '', label: 'Pending', class: 'pending' },
                'approved': { icon: '', label: 'Approved', class: 'approved' },
                'processing': { icon: '', label: 'Processing', class: 'pending' }
            };

            container.innerHTML = payments.map(p => {
                const status = statusConfig[p.status] || { icon: '?', label: p.status, class: '' };
                return `
                    <div class="payment-item">
                        <div class="payment-info">
                            <div class="payment-period">${p.period_month || 'Payment'}</div>
                            <div class="payment-date">${new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="payment-amount">${fmtMoney(p.amount)}</span>
                            <span class="payment-status ${status.class}">${status.icon} ${status.label}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== VIDEO MODAL ====================
        function openVideo(loomId, title) {
            document.getElementById('videoModalTitle').textContent = title;
            document.getElementById('videoFrame').src = `https://www.loom.com/embed/${loomId}`;
            document.getElementById('videoModal').classList.add('show');
        }

        function closeVideo() {
            document.getElementById('videoModal').classList.remove('show');
            document.getElementById('videoFrame').src = '';
        }

        // Close on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeVideo();
        });

        // ==================== INIT ====================
        
        // Detect in-app browsers (Discord, Instagram, Facebook, etc.)
        function isInAppBrowser() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            // Discord, Facebook, Instagram, Twitter, LinkedIn, Snapchat in-app browsers
            return /Discord|FBAN|FBAV|Instagram|Twitter|LinkedInApp|Snapchat|Line\//i.test(ua) ||
                   // Generic WebView detection
                   /wv\)/.test(ua) ||
                   // iOS WebView
                   (/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(ua));
        }
        
        async function init() {
            // Check for in-app browser and show warning
            if (isInAppBrowser()) {
                const warning = document.getElementById('inAppWarning');
                if (warning) {
                    warning.style.display = 'block';
                }
                
                // Set up copy link button
                const copyBtn = document.getElementById('copyLinkBtn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', async function() {
                        try {
                            await navigator.clipboard.writeText(window.location.href);
                            document.getElementById('copyConfirm').style.display = 'block';
                            copyBtn.textContent = ' Copied!';
                        } catch (err) {
                            // Fallback for older browsers
                            const textArea = document.createElement('textarea');
                            textArea.value = window.location.href;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            document.getElementById('copyConfirm').style.display = 'block';
                            copyBtn.textContent = ' Copied!';
                        }
                    });
                }
            }
            
            // Set up Discord login button with mobile-friendly event handling
            const loginBtn = document.getElementById('discordLoginBtn');
            if (loginBtn) {
                let loginTriggered = false;
                
                const triggerLogin = function(e) {
                    if (loginTriggered) return; // Prevent double-trigger
                    loginTriggered = true;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Discord login triggered'); // Debug log
                    loginWithDiscord();
                    
                    // Reset after short delay
                    setTimeout(() => { loginTriggered = false; }, 1000);
                };
                
                // Use touchstart for immediate response on mobile
                loginBtn.addEventListener('touchstart', triggerLogin, { passive: false });
                
                // Use click for desktop
                loginBtn.addEventListener('click', triggerLogin, { passive: false });
            }
            
            // Check current auth state
            await handleAuthStateChange();
        }

        // Start app
        init();
    </script>
</body>
</html>
