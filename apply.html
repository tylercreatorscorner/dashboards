<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply to Join - Creators Corner</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12141a;
            --bg-card: #1a1d24;
            --border: #2e3440;
            --border-light: #3b4252;
            --text-primary: #eceff4;
            --text-secondary: #9aa5b8;
            --text-muted: #6b7280;
            --accent: #f5c518;
            --accent-hover: #ffd43b;
            --accent-dim: rgba(245, 197, 24, 0.12);
            --success: #34d399;
            --success-dim: rgba(52, 211, 153, 0.12);
            --danger: #f87171;
            --purple: #a78bfa;
            --brand-color: #f5c518;
            --brand-color-dim: rgba(245, 197, 24, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Animated Gradient Background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: -2;
        }
        
        .bg-gradient::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 30% 20%, var(--brand-color-dim) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 80%, rgba(167, 139, 250, 0.08) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, rgba(99, 102, 241, 0.05) 0%, transparent 50%);
            animation: gradientShift 20s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2%, 2%) rotate(1deg); }
            50% { transform: translate(-1%, 3%) rotate(-1deg); }
            75% { transform: translate(3%, -1%) rotate(0.5deg); }
        }
        
        /* Floating Product Assets */
        .floating-assets {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .floating-asset {
            position: absolute;
            opacity: 0.15;
            filter: blur(1px);
            animation: float 20s ease-in-out infinite;
        }
        
        .floating-asset:nth-child(1) { top: 10%; left: 5%; animation-delay: 0s; }
        .floating-asset:nth-child(2) { top: 60%; left: 8%; animation-delay: -5s; }
        .floating-asset:nth-child(3) { top: 30%; right: 5%; animation-delay: -10s; }
        .floating-asset:nth-child(4) { top: 70%; right: 8%; animation-delay: -15s; }
        .floating-asset:nth-child(5) { top: 85%; left: 15%; animation-delay: -7s; }
        .floating-asset:nth-child(6) { top: 15%; right: 12%; animation-delay: -12s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-20px) rotate(5deg) scale(1.02); }
            50% { transform: translateY(10px) rotate(-3deg) scale(0.98); }
            75% { transform: translateY(-15px) rotate(2deg) scale(1.01); }
        }
        
        /* Floating Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--brand-color);
            border-radius: 50%;
            opacity: 0.3;
            animation: particleFloat 15s ease-in-out infinite;
        }
        
        @keyframes particleFloat {
            0%, 100% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.3; transform: scale(1); }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) scale(0); opacity: 0; }
        }

        .container {
            max-width: 560px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Social Proof Bar */
        .social-proof-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .proof-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .proof-item .number {
            font-weight: 700;
            color: var(--brand-color);
        }
        
        /* Top Videos Carousel */
        .videos-carousel {
            margin: 24px -20px;
            padding: 0 20px;
            overflow: hidden;
            position: relative;
        }
        
        .videos-carousel::before,
        .videos-carousel::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 60px;
            z-index: 2;
            pointer-events: none;
        }
        
        .videos-carousel::before {
            left: 0;
            background: linear-gradient(to right, var(--bg-primary), transparent);
        }
        
        .videos-carousel::after {
            right: 0;
            background: linear-gradient(to left, var(--bg-primary), transparent);
        }
        
        .videos-track {
            display: flex;
            gap: 12px;
            animation: scrollVideos 30s linear infinite;
            width: max-content;
        }
        
        .videos-track:hover {
            animation-play-state: paused;
        }
        
        @keyframes scrollVideos {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .video-thumb {
            width: 100px;
            height: 140px;
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            background: linear-gradient(180deg, rgba(var(--brand-color-rgb, 245, 197, 24), 0.3) 0%, rgba(0,0,0,0.8) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .video-thumb:hover {
            transform: scale(1.08) translateY(-4px);
            border-color: var(--brand-color);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        .video-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            box-sizing: border-box;
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.6) 100%);
        }
        
        .video-play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .video-thumb:hover .video-play-btn {
            background: var(--brand-color);
            transform: scale(1.1);
        }
        
        .video-creator {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.9);
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            font-weight: 500;
        }
        
        .video-gmv {
            position: absolute;
            bottom: 6px;
            left: 6px;
            right: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #2ecc71;
            background: rgba(0,0,0,0.85);
            padding: 4px 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .videos-label {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Trust Badges */
        .trust-badges {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .trust-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .trust-badge svg {
            width: 14px;
            height: 14px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            width: 200px;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        }
        
        .brand-logo {
            height: 48px;
            margin-bottom: 16px;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary), var(--brand-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.05rem;
        }

        .brand-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--brand-color-dim);
            border: 1px solid var(--brand-color);
            color: var(--brand-color);
            padding: 10px 20px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 0.95rem;
            margin-top: 16px;
            box-shadow: 0 0 20px var(--brand-color-dim);
        }
        
        /* Video Section */
        .video-section {
            margin-bottom: 32px;
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-secondary);
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
        }
        .video-container iframe,
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Steps indicator */
        .steps-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }
        .step-dot {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: all 0.3s;
        }
        .step-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
            font-weight: 600;
        }
        .step-dot.completed {
            background: var(--success-dim);
            border-color: var(--success);
            color: var(--success);
        }

        .form-card {
            background: rgba(20, 22, 30, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 32px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.4),
                0 0 80px var(--brand-color-dim);
        }
        
        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--brand-color), transparent);
        }
        
        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 28px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .progress-step.active .progress-dot {
            background: var(--brand-color);
            color: var(--bg-primary);
            border-color: var(--brand-color);
            box-shadow: 0 0 20px var(--brand-color-dim);
        }
        
        .progress-step.completed .progress-dot {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .progress-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: none;
        }
        
        @media (min-width: 480px) {
            .progress-label { display: block; }
        }
        
        .progress-step.active .progress-label {
            color: var(--brand-color);
            font-weight: 600;
        }
        
        .progress-line {
            width: 40px;
            height: 2px;
            background: rgba(255,255,255,0.1);
            border-radius: 1px;
        }
        
        .progress-line.completed {
            background: var(--success);
        }
        
        /* Recently Approved Feed */
        .recently-approved {
            margin: 24px 0;
            padding: 16px;
            background: rgba(20, 22, 30, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .recently-approved-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .recently-approved-feed {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 120px;
            overflow: hidden;
        }
        
        .approved-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .approved-avatar {
            width: 28px;
            height: 28px;
            background: var(--brand-color-dim);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--brand-color);
            font-weight: 600;
        }
        
        .approved-info {
            flex: 1;
            min-width: 0;
        }
        
        .approved-name {
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .approved-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .approved-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            background: var(--success-dim);
            color: var(--success);
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s ease-out forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Success Card Enhancement */
        .success-message {
            text-align: center;
            background: rgba(20, 22, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--brand-color);
            box-shadow: 
                0 0 60px var(--brand-color-dim),
                0 8px 32px rgba(0,0,0,0.4);
        }
        
        .success-message::before {
            height: 3px;
            background: linear-gradient(90deg, var(--brand-color), var(--success), var(--brand-color));
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--brand-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .required { color: var(--danger); }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(10, 10, 15, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus {
            border-color: var(--brand-color);
            box-shadow: 0 0 0 3px var(--brand-color-dim), 0 0 20px var(--brand-color-dim);
            outline: none;
            background: rgba(10, 10, 15, 0.8);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .form-input::placeholder { color: var(--text-muted); }

        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .error-message {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .error-message.show { display: block; }

        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .btn:hover {
            background: var(--bg-card);
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--brand-color), var(--accent-hover));
            color: var(--bg-primary);
            border: none;
            padding: 18px 24px;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--brand-color-dim);
        }
        
        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--brand-color-dim), 0 0 40px var(--brand-color-dim);
        }
        
        .submit-btn:hover::before {
            left: 100%;
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .submit-btn:disabled::before {
            display: none;
        }

        /* Success Screen */
        .success-message {
            display: none;
            text-align: center;
            padding: 48px 40px;
        }
        .success-message.show { display: block; }
        .form-card.hide { display: none; }

        .success-icon {
            font-size: 5rem;
            margin-bottom: 24px;
            animation: bounce 0.6s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .success-message h2 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: var(--success);
        }

        .success-message p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .footer a {
            color: var(--accent);
            text-decoration: none;
        }

        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .steps-indicator { flex-wrap: wrap; }
        }

        /* Discord OAuth Styles */
        .discord-connect-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }
        .discord-connect-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #5865F2;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .discord-connect-btn:hover {
            background: #4752C4;
            transform: translateY(-2px);
        }
        .discord-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 12px;
        }
        .discord-connected {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--success-dim);
            border: 1px solid var(--success);
            border-radius: 10px;
        }
        .discord-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            overflow: hidden;
        }
        .discord-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Discord Gate - Full screen blocker until connected */
        .discord-gate {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 48px 32px;
            text-align: center;
            max-width: 480px;
            margin: 0 auto;
        }

        .discord-gate-icon {
            width: 80px;
            height: 80px;
            background: #5865F2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .discord-gate-icon svg {
            width: 44px;
            height: 44px;
            fill: white;
        }

        .discord-gate h2 {
            font-size: 1.5rem;
            margin-bottom: 12px;
        }

        .discord-gate p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .discord-gate .discord-connect-btn {
            width: 100%;
            padding: 16px 32px;
            font-size: 1.1rem;
        }

        .discord-gate-features {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
            text-align: left;
        }

        .discord-gate-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .discord-gate-feature span:first-child {
            font-size: 1.25rem;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-gradient"></div>
    
    <!-- Floating Product Assets -->
    <div class="floating-assets" id="floatingAssets">
        <!-- Populated by JS based on brand -->
    </div>
    
    <!-- Floating Particles -->
    <div class="particles" id="particles">
        <!-- Generated by JS -->
    </div>
    
    <div class="container">
        <!-- Social Proof Bar -->
        <div class="social-proof-bar" id="socialProofBar">
            <div class="proof-item">
                <span class="number" id="proofCreators">500+</span>
                <span>Creators</span>
            </div>
            <div class="proof-item">
                <span class="number" id="proofEarned">$2M+</span>
                <span>Earned</span>
            </div>
            <div class="proof-item">
                <span class="number" id="proofViews">50M+</span>
                <span>Views</span>
            </div>
        </div>
        
        <div class="header">
            <img src="logo.png" alt="Creators Corner" class="logo" id="logoImg">
            <img src="" alt="" class="brand-logo" id="brandLogoImg" style="display: none;">
            <h1 id="headerTitle">Apply to Join Our Creator Network</h1>
            <p id="headerSubtitle">Partner with top brands and earn commissions on TikTok Shop</p>
            <div class="brand-badge" id="brandBadge" style="display: none;">
                <span>üè∑Ô∏è</span>
                <span id="brandName">Brand Name</span>
            </div>
        </div>
        
        <!-- Top Videos Carousel -->
        <div class="videos-carousel" id="videosCarousel" style="display: none;">
            <div class="videos-label">üî• Top Performing Videos</div>
            <div class="videos-track" id="videosTrack">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Trust Badges -->
        <div class="trust-badges" id="trustBadges">
            <div class="trust-badge">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
                <span>Verified Partner</span>
            </div>
            <div class="trust-badge">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                <span>Fast Payouts</span>
            </div>
            <div class="trust-badge">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                <span>500+ Creators</span>
            </div>
        </div>
        
        <!-- Recently Approved Feed -->
        <div class="recently-approved" id="recentlyApproved">
            <div class="recently-approved-header">
                <span class="pulse-dot"></span>
                <span>Recently Approved</span>
            </div>
            <div class="recently-approved-feed" id="approvedFeed">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- DISCORD GATE - First thing they see -->
        <div class="discord-gate" id="discordGate">
            <div class="discord-gate-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
            </div>
            <h2>Connect with Discord</h2>
            <p>We use Discord to communicate with our creators. Connect your account to continue with your application.</p>
            <button type="button" class="discord-connect-btn" onclick="connectDiscord()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
                Continue with Discord
            </button>
            <div class="discord-gate-features">
                <div class="discord-gate-feature">
                    <span>üí¨</span>
                    <span>Get instant updates on your application</span>
                </div>
                <div class="discord-gate-feature">
                    <span>üéì</span>
                    <span>Access exclusive creator training</span>
                </div>
                <div class="discord-gate-feature">
                    <span>üèÜ</span>
                    <span>Join our community of top creators</span>
                </div>
            </div>
        </div>

        <!-- APPLICATION CONTENT - Hidden until Discord connected -->
        <div id="applicationContent" style="display: none;">
            <!-- Welcome Video -->
            <div class="video-section" id="welcomeVideoSection" style="display: none;">
                <div class="video-container" id="welcomeVideoContainer"></div>
            </div>

            <!-- Discord Connected Badge -->
            <div class="discord-connect-section" id="discordConnectSection">
                <div id="discordConnected" class="discord-connected">
                    <span class="discord-avatar" id="discordAvatar">üë§</span>
                    <div>
                        <div style="font-weight: 600;" id="discordDisplayName">Username</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Discord Connected ‚úì</div>
                    </div>
                    <button type="button" onclick="disconnectDiscord()" style="margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.25rem;">‚úï</button>
                </div>
            </div>

            <!-- Steps Indicator (for multi-step forms) -->
            <div class="steps-indicator" id="stepsIndicator" style="display: none;"></div>

            <!-- Dynamic Form -->
            <div class="form-card" id="formCard">
                <form id="applicationForm" novalidate>
                    <div class="error-message" id="errorMessage"></div>
                    <!-- Hidden Discord fields -->
                    <input type="hidden" id="discord_id" name="discord_id">
                    <input type="hidden" id="discord_username" name="discord_username">
                    <input type="hidden" id="discord_avatar_url" name="discord_avatar_url">
                    <div id="formFields"></div>
                    <div class="btn-row" id="stepButtons" style="display: none;">
                        <button type="button" class="btn" id="prevBtn" onclick="prevStep()">‚Üê Back</button>
                        <button type="button" class="btn submit-btn" id="nextBtn" onclick="nextStep()" style="flex: 2;">Next Step ‚Üí</button>
                    </div>
                    <button type="submit" class="submit-btn" id="submitBtn">Submit Application</button>
                </form>
                <div style="text-align: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <span style="color: var(--text-muted); font-size: 0.9rem;">Already applied?</span>
                    <a href="/creator-portal.html" style="color: var(--accent); text-decoration: none; font-weight: 500; margin-left: 8px;">Check your status ‚Üí</a>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div class="form-card success-message" id="successMessage">
            <div class="success-icon">üéâ</div>
            <h2 id="successTitle">Application Received!</h2>
            <p id="successText">We'll review your application and get back to you within 48 hours.</p>
            <div class="video-section" id="thankYouVideoSection" style="display: none;">
                <div class="video-container" id="thankYouVideoContainer"></div>
            </div>
            <div id="portalAccessSection" style="margin-top: 24px; padding: 20px; background: var(--success-dim); border: 1px solid var(--success); border-radius: 12px;">
                <div style="font-weight: 600; color: var(--success); margin-bottom: 8px;">‚úì Your Creator Portal is Ready</div>
                <p style="color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 16px;">Track your application status and access your dashboard anytime.</p>
                <a href="/creator-portal.html" class="submit-btn" style="display: inline-block; text-decoration: none; text-align: center;">Open Creator Portal ‚Üí</a>
            </div>
            <div style="margin-top: 16px;">
                <a href="/" style="color: var(--text-muted); text-decoration: none; font-size: 0.9rem;">‚Üê Back to Home</a>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient"></div>

    <footer class="footer">
        <p>¬© 2025 Creators Corner ¬∑ <a href="/">Home</a></p>
    </footer>

    <script>
        const SUPABASE_URL = 'https://elrsgxlyejlkzjcnhmak.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscnNneGx5ZWpsa3pqY25obWFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQ5OTUsImV4cCI6MjA3OTU5MDk5NX0.8XScMdGkFRqRIDMPY3gWS5tk0Z8NbGzDXuH1dsnBdZ0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Discord OAuth - Global default (same as creator-portal and other pages)
        const DEFAULT_DISCORD_CLIENT_ID = '1444456806264078426'; // Creators Corner Discord App
        let DISCORD_CLIENT_ID = DEFAULT_DISCORD_CLIENT_ID;
        const DISCORD_REDIRECT_URI = window.location.origin + '/apply.html';

        const BRAND_DISPLAY = {
            'catakor': 'Cata-Kor',
            'jiyu': 'JiYu',
            'physicians_choice': 'Physicians Choice',
            'peach_slices': 'Peach Slices',
            'yerba_magic': 'Yerba Magic',
            'toplux': 'Toplux Nutrition'
        };
        
        // Reverse mapping for database queries (video_catalog, creator_performance use display names)
        const BRAND_DB_NAME = {
            'catakor': 'Cata-Kor',
            'jiyu': 'JiYu',
            'physicians_choice': 'Physicians Choice',
            'peach_slices': 'Peach Slices',
            'yerba_magic': 'Yerba Magic',
            'toplux': 'Toplux'
        };
        
        function getBrandDbName(brandKey) {
            return BRAND_DB_NAME[brandKey] || brandKey;
        }
        
        // Brand-specific theming config - ELITE version
        const BRAND_CONFIG = {
            'catakor': {
                color: '#e74c3c',
                colorDim: 'rgba(231, 76, 60, 0.15)',
                gradient: 'linear-gradient(135deg, #e74c3c, #c0392b)',
                icon: 'üíä',
                tagline: 'Partner with Cata-Kor and earn commissions on TikTok Shop',
                description: 'Premium supplements brand',
                stats: { creators: '200+', earned: '$500K+', views: '15M+' },
                productImages: [], // Upload to Supabase Storage later
                topVideos: []
            },
            'jiyu': {
                color: '#9b59b6',
                colorDim: 'rgba(155, 89, 182, 0.15)',
                gradient: 'linear-gradient(135deg, #9b59b6, #8e44ad)',
                icon: '‚ú®',
                tagline: 'Join the JiYu creator team on TikTok Shop',
                description: 'Innovative skincare & wellness',
                stats: { creators: '150+', earned: '$400K+', views: '12M+' },
                productImages: [],
                topVideos: []
            },
            'physicians_choice': {
                color: '#3498db',
                colorDim: 'rgba(52, 152, 219, 0.15)',
                gradient: 'linear-gradient(135deg, #3498db, #2980b9)',
                icon: 'ü©∫',
                tagline: 'Become a Physicians Choice creator',
                description: 'Trusted health supplements',
                stats: { creators: '500+', earned: '$2M+', views: '50M+' },
                productImages: [], // Upload to Supabase Storage later
                topVideos: []
            },
            'peach_slices': {
                color: '#ff6b9d',
                colorDim: 'rgba(255, 107, 157, 0.15)',
                gradient: 'linear-gradient(135deg, #ff6b9d, #ff4777)',
                icon: 'üçë',
                tagline: 'Join the Peach Slices glow team',
                description: 'K-beauty skincare essentials',
                stats: { creators: '300+', earned: '$800K+', views: '25M+' },
                productImages: [], // Upload to Supabase Storage later
                topVideos: []
            },
            'yerba_magic': {
                color: '#2ecc71',
                colorDim: 'rgba(46, 204, 113, 0.15)',
                gradient: 'linear-gradient(135deg, #2ecc71, #27ae60)',
                icon: 'üßâ',
                tagline: 'Partner with Yerba Magic creators',
                description: 'Natural energy & wellness',
                stats: { creators: '100+', earned: '$200K+', views: '8M+' },
                productImages: [],
                topVideos: []
            },
            'toplux': {
                color: '#00b894',
                colorDim: 'rgba(0, 184, 148, 0.15)',
                gradient: 'linear-gradient(135deg, #00b894, #00a381)',
                icon: '‚ö°',
                tagline: 'Join the Toplux Nutrition creator team',
                description: 'Keto & wellness supplements',
                stats: { creators: '50+', earned: '$100K+', views: '5M+' },
                productImages: [],
                topVideos: []
            }
        };

        let currentFunnel = null;
        let currentStep = 0;
        let formData = {};
        let discordUser = null;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const funnelSlug = urlParams.get('funnel') || 'apply';
        const preselectedBrand = urlParams.get('brand');

        // Check for Discord OAuth callback
        checkDiscordCallback();

        // Initialize
        init();

        async function init() {
            try {
                // Load funnel configuration
                const { data: funnel, error } = await supabaseClient
                    .from('application_funnels')
                    .select('*')
                    .eq('slug', funnelSlug)
                    .eq('status', 'active')
                    .single();

                if (error || !funnel) {
                    // Try loading default
                    const { data: defaultFunnel } = await supabaseClient
                        .from('application_funnels')
                        .select('*')
                        .eq('slug', 'apply')
                        .single();
                    
                    if (defaultFunnel) {
                        currentFunnel = defaultFunnel;
                    } else {
                        // Use hardcoded default
                        currentFunnel = getDefaultFunnel();
                    }
                } else {
                    currentFunnel = funnel;
                }

                // Apply settings (colors, header, etc)
                applyFunnelSettings();
                
                // Render form (but don't show yet)
                renderForm();

                // Check if user already has an application for this brand
                const alreadyApplied = await checkExistingApplication();
                
                // Check Discord connection status and show appropriate view
                if (!alreadyApplied) {
                    updateDiscordGate();
                }

            } catch (err) {
                console.error('Error loading funnel:', err);
                currentFunnel = getDefaultFunnel();
                applyFunnelSettings();
                renderForm();
                
                const alreadyApplied = await checkExistingApplication();
                if (!alreadyApplied) {
                    updateDiscordGate();
                }
            }
        }
        
        function updateDiscordGate() {
            const gate = document.getElementById('discordGate');
            const content = document.getElementById('applicationContent');
            
            if (discordUser) {
                // Discord connected - hide gate, show form
                gate.style.display = 'none';
                content.style.display = 'block';
                
                // Update the connected badge
                document.getElementById('discordDisplayName').textContent = discordUser.global_name || discordUser.username;
                const avatarEl = document.getElementById('discordAvatar');
                if (discordUser.avatar) {
                    avatarEl.innerHTML = `<img src="${discordUser.avatar}" alt="Avatar">`;
                } else {
                    avatarEl.innerHTML = 'üë§';
                }
                
                // Fill hidden fields
                document.getElementById('discord_id').value = discordUser.id;
                document.getElementById('discord_username').value = discordUser.username;
                document.getElementById('discord_avatar_url').value = discordUser.avatar || '';
            } else {
                // Not connected - show gate, hide form
                gate.style.display = 'block';
                content.style.display = 'none';
            }
        }

        function getDefaultFunnel() {
            return {
                steps: [{ id: 'step1', title: 'Application', icon: 'üìù' }],
                fields: [
                    { id: 'full_name', type: 'text', label: 'Full Name', required: true, step: 'step1', placeholder: 'Your full name', width: 'full' },
                    { id: 'email', type: 'email', label: 'Email', required: true, step: 'step1', placeholder: 'you@email.com', width: 'half' },
                    { id: 'phone', type: 'tel', label: 'Phone', required: false, step: 'step1', placeholder: '(555) 123-4567', width: 'half' },
                    { id: 'tiktok_handle', type: 'text', label: 'TikTok Handle', required: true, step: 'step1', placeholder: '@yourusername', width: 'full' },
                    { id: 'follower_count', type: 'select', label: 'Follower Count', required: true, step: 'step1', width: 'half', options: [
                        { value: '0-1k', label: '0 - 1,000' },
                        { value: '1k-5k', label: '1,000 - 5,000' },
                        { value: '5k-10k', label: '5,000 - 10,000' },
                        { value: '10k-50k', label: '10,000 - 50,000' },
                        { value: '50k+', label: '50,000+' }
                    ]},
                    { id: 'brand', type: 'select', label: 'Which brand?', required: true, step: 'step1', width: 'half', options: [
                        { value: 'catakor', label: 'Cata-Kor' },
                        { value: 'jiyu', label: 'JiYu' },
                        { value: 'physicians_choice', label: 'Physicians Choice' },
                        { value: 'peach_slices', label: 'Peach Slices' },
                        { value: 'yerba_magic', label: 'Yerba Magic' }
                    ]}
                ],
                settings: {
                    header_title: 'Apply to Join Our Creator Network',
                    header_subtitle: 'Partner with top brands and earn commissions on TikTok Shop',
                    primary_color: '#f5c518',
                    success_title: 'Application Received! üéâ',
                    success_message: 'We\'ll review your application and get back to you within 48 hours.'
                }
            };
        }

        function applyFunnelSettings() {
            const settings = currentFunnel.settings || {};
            
            // Apply colors
            if (settings.primary_color) {
                document.documentElement.style.setProperty('--accent', settings.primary_color);
                document.documentElement.style.setProperty('--brand-color', settings.primary_color);
                document.documentElement.style.setProperty('--brand-color-dim', settings.primary_color + '20');
            }

            // Apply header text
            if (settings.header_title) {
                document.getElementById('headerTitle').textContent = settings.header_title;
            }
            if (settings.header_subtitle) {
                document.getElementById('headerSubtitle').textContent = settings.header_subtitle;
            }

            // Apply logo
            if (settings.logo_url) {
                document.getElementById('logoImg').src = settings.logo_url;
            }

            // Apply success messages
            if (settings.success_title) {
                document.getElementById('successTitle').textContent = settings.success_title;
            }
            if (settings.success_message) {
                document.getElementById('successText').textContent = settings.success_message;
            }

            // Welcome video - only show if URL is actually provided
            if (settings.welcome_video_url && settings.welcome_video_url.trim()) {
                const container = document.getElementById('welcomeVideoContainer');
                const embedHtml = getVideoEmbed(settings.welcome_video_url);
                if (embedHtml) {
                    container.innerHTML = embedHtml;
                    document.getElementById('welcomeVideoSection').style.display = 'block';
                }
            }

            // Thank you video - only show if URL is actually provided
            if (settings.thank_you_video_url && settings.thank_you_video_url.trim()) {
                const container = document.getElementById('thankYouVideoContainer');
                const embedHtml = getVideoEmbed(settings.thank_you_video_url);
                if (embedHtml) {
                    container.innerHTML = embedHtml;
                    document.getElementById('thankYouVideoSection').style.display = 'block';
                }
            }

            // Initialize particles with default color
            updateParticles(settings.primary_color || '#f5c518');

            // Brand badge
            if (currentFunnel.brand && BRAND_DISPLAY[currentFunnel.brand]) {
                document.getElementById('brandBadge').style.display = 'inline-flex';
                document.getElementById('brandName').textContent = BRAND_DISPLAY[currentFunnel.brand];
                applyBrandTheme(currentFunnel.brand);
                loadRecentlyApproved(currentFunnel.brand);
            } else if (preselectedBrand && BRAND_DISPLAY[preselectedBrand]) {
                document.getElementById('brandBadge').style.display = 'inline-flex';
                document.getElementById('brandName').textContent = BRAND_DISPLAY[preselectedBrand];
                applyBrandTheme(preselectedBrand);
                loadRecentlyApproved(preselectedBrand);
            } else {
                // Load all recently approved
                loadRecentlyApproved(null);
            }

            // Discord OAuth - load client ID from settings
            if (settings.discord_client_id) {
                DISCORD_CLIENT_ID = settings.discord_client_id;
            }
        }
        
        // Apply brand-specific theming and settings
        function applyBrandTheme(brand) {
            const config = BRAND_CONFIG[brand];
            if (!config) return;
            
            // Load brand-specific settings from localStorage (saved from admin)
            const allBrandSettings = JSON.parse(localStorage.getItem('brandAppSettings') || '{}');
            const brandSettings = allBrandSettings[brand] || allBrandSettings['default'] || {};
            
            // Apply custom color or fallback to config
            const brandColor = brandSettings.color || config.color;
            const brandColorDim = config.colorDim || (brandColor + '15');
            
            // Set CSS variables
            document.documentElement.style.setProperty('--accent', brandColor);
            document.documentElement.style.setProperty('--accent-hover', brandColor);
            document.documentElement.style.setProperty('--accent-dim', brandColorDim);
            document.documentElement.style.setProperty('--brand-color', brandColor);
            document.documentElement.style.setProperty('--brand-color-dim', brandColorDim);
            
            // Apply custom title
            if (brandSettings.title) {
                document.getElementById('headerTitle').textContent = brandSettings.title;
            }
            
            // Update header subtitle
            const subtitle = document.getElementById('headerSubtitle');
            if (subtitle) {
                if (brandSettings.subtitle) {
                    subtitle.textContent = brandSettings.subtitle;
                } else if (config?.tagline && !currentFunnel?.settings?.header_subtitle) {
                    subtitle.textContent = config.tagline;
                }
            }
            
            // Apply custom logo
            if (brandSettings.logo) {
                document.getElementById('logoImg').src = brandSettings.logo;
            }
            
            // Apply welcome video - only if valid
            if (brandSettings.welcome_video && !currentFunnel?.settings?.welcome_video_url) {
                const embedHtml = getVideoEmbed(brandSettings.welcome_video);
                if (embedHtml) {
                    const container = document.getElementById('welcomeVideoContainer');
                    container.innerHTML = embedHtml;
                    document.getElementById('welcomeVideoSection').style.display = 'block';
                }
            }
            
            // Apply thank you video - only if valid
            if (brandSettings.thank_you_video && !currentFunnel?.settings?.thank_you_video_url) {
                const embedHtml = getVideoEmbed(brandSettings.thank_you_video);
                if (embedHtml) {
                    const container = document.getElementById('thankYouVideoContainer');
                    container.innerHTML = embedHtml;
                    document.getElementById('thankYouVideoSection').style.display = 'block';
                }
            }
            
            // Apply success messages
            if (brandSettings.success_title) {
                document.getElementById('successTitle').textContent = brandSettings.success_title;
            }
            if (brandSettings.success_message) {
                document.getElementById('successText').textContent = brandSettings.success_message;
            }
            
            // Apply Discord client ID
            if (brandSettings.discord_client_id) {
                DISCORD_CLIENT_ID = brandSettings.discord_client_id;
            }
            
            // Update page title
            document.title = `Apply to Join ${BRAND_DISPLAY[brand]} - Creators Corner`;
            
            // Update brand badge color
            const badge = document.getElementById('brandBadge');
            if (badge) {
                badge.style.borderColor = brandColor;
                badge.style.background = brandColorDim;
                badge.style.color = brandColor;
                badge.style.boxShadow = `0 0 20px ${brandColorDim}`;
            }
            
            // === NEW ELITE FEATURES ===
            
            // Update Social Proof Stats
            if (config.stats) {
                document.getElementById('proofCreators').textContent = config.stats.creators || '500+';
                document.getElementById('proofEarned').textContent = config.stats.earned || '$2M+';
                document.getElementById('proofViews').textContent = config.stats.views || '50M+';
            }
            
            // Update floating particles color
            updateParticles(brandColor);
            
            // Add floating product assets
            if (config.productImages && config.productImages.length > 0) {
                addFloatingAssets(config.productImages);
            }
            
            // Add top videos carousel
            if (config.topVideos && config.topVideos.length > 0) {
                addVideosCarousel(config.topVideos);
            } else {
                // Try to load from database
                loadBrandTopVideos(brand);
            }
            
            // Add custom fields if any
            if (brandSettings.custom_fields && brandSettings.custom_fields.length > 0) {
                addCustomFieldsToForm(brandSettings.custom_fields);
            }
        }
        
        // Generate floating particles
        function updateParticles(color) {
            const container = document.getElementById('particles');
            container.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 15}s`;
                particle.style.animationDuration = `${15 + Math.random() * 10}s`;
                particle.style.background = color;
                particle.style.width = `${2 + Math.random() * 4}px`;
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }
        
        // Add floating product images
        function addFloatingAssets(images) {
            const container = document.getElementById('floatingAssets');
            container.innerHTML = '';
            
            if (!images || images.length === 0) return;
            
            const positions = [
                { top: '10%', left: '3%', size: '80px' },
                { top: '55%', left: '2%', size: '100px' },
                { top: '25%', right: '3%', size: '90px' },
                { top: '65%', right: '2%', size: '85px' },
                { top: '80%', left: '10%', size: '70px' },
                { top: '15%', right: '10%', size: '75px' }
            ];
            
            images.slice(0, 6).forEach((url, i) => {
                const pos = positions[i % positions.length];
                const asset = document.createElement('img');
                asset.className = 'floating-asset';
                asset.src = url;
                asset.style.width = pos.size;
                asset.style.height = pos.size;
                asset.style.objectFit = 'contain';
                asset.style.top = pos.top;
                if (pos.left) asset.style.left = pos.left;
                if (pos.right) asset.style.right = pos.right;
                asset.style.animationDelay = `${i * -3}s`;
                // Hide image if it fails to load
                asset.onerror = () => { asset.style.display = 'none'; };
                container.appendChild(asset);
            });
        }
        
        // Add videos carousel
        function addVideosCarousel(videos) {
            const carousel = document.getElementById('videosCarousel');
            const track = document.getElementById('videosTrack');
            
            if (!videos || videos.length === 0) {
                carousel.style.display = 'none';
                return;
            }
            
            carousel.style.display = 'block';
            
            // Double the videos for seamless loop
            const allVideos = [...videos, ...videos];
            
            track.innerHTML = allVideos.map(v => `
                <div class="video-thumb" onclick="window.open('${v.url || '#'}', '_blank')">
                    <div class="video-placeholder">
                        <div class="video-play-btn">‚ñ∂</div>
                        <div class="video-creator">@${v.creator || 'creator'}</div>
                    </div>
                    <div class="video-gmv">üí∞ ${formatGMV(v.gmv || 0)}</div>
                </div>
            `).join('');
        }
        
        function formatGMV(amount) {
            if (amount >= 1000) return '$' + (amount / 1000).toFixed(1) + 'K';
            return '$' + amount.toFixed(0);
        }
        
        // Load top videos from database
        async function loadBrandTopVideos(brand) {
            console.log('Loading top videos for brand:', brand);
            try {
                // Query video_performance for GMV data
                const { data: videos, error } = await supabaseClient
                    .from('video_performance')
                    .select('video_id, creator_name, gmv, product_name')
                    .eq('brand', brand)
                    .gt('gmv', 0)
                    .order('gmv', { ascending: false })
                    .limit(15);
                
                if (error) {
                    console.log('Video performance not available:', error.message);
                    return;
                }
                
                console.log('Video query result:', videos?.length, 'videos');
                
                if (videos && videos.length > 0) {
                    // Deduplicate by video_id and take top 10
                    const seen = new Set();
                    const uniqueVideos = videos.filter(v => {
                        if (seen.has(v.video_id)) return false;
                        seen.add(v.video_id);
                        return true;
                    }).slice(0, 10);
                    
                    const formattedVideos = uniqueVideos.map(v => ({
                        // Construct TikTok URL from creator_name and video_id
                        url: `https://www.tiktok.com/@${v.creator_name}/video/${v.video_id}`,
                        // Use TikTok's dynamic thumbnail (first frame)
                        thumbnail: `https://www.tiktok.com/oembed?url=https://www.tiktok.com/@${v.creator_name}/video/${v.video_id}`,
                        gmv: v.gmv || 0,
                        creator: v.creator_name
                    }));
                    addVideosCarousel(formattedVideos);
                } else {
                    console.log('No videos found for brand:', brand);
                }
            } catch (e) {
                console.log('Video loading error:', e);
            }
        }
        
        function formatViews(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        // Load recently approved creators
        async function loadRecentlyApproved(brand) {
            try {
                let query = supabaseClient
                    .from('creator_applications')
                    .select('full_name, reviewed_at, brand')
                    .eq('status', 'accepted')
                    .order('reviewed_at', { ascending: false })
                    .limit(5);
                
                if (brand) {
                    query = query.eq('brand', brand);
                }
                
                const { data: approved } = await query;
                
                if (approved && approved.length > 0) {
                    renderRecentlyApproved(approved);
                } else {
                    // Hide if no data
                    document.getElementById('recentlyApproved').style.display = 'none';
                }
            } catch (e) {
                console.log('Could not load recently approved:', e);
                document.getElementById('recentlyApproved').style.display = 'none';
            }
        }
        
        function renderRecentlyApproved(approved) {
            const feed = document.getElementById('approvedFeed');
            
            feed.innerHTML = approved.map(a => {
                const name = a.full_name || 'Creator';
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const timeAgo = getTimeAgo(a.reviewed_at);
                
                return `
                    <div class="approved-item">
                        <div class="approved-avatar">${initials}</div>
                        <div class="approved-info">
                            <div class="approved-name">${maskName(name)}</div>
                            <div class="approved-time">${timeAgo}</div>
                        </div>
                        <div class="approved-badge">‚úì Approved</div>
                    </div>
                `;
            }).join('');
        }
        
        function maskName(name) {
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return parts[0] + ' ' + parts[1][0] + '.';
            }
            return name.substring(0, 3) + '***';
        }
        
        function getTimeAgo(dateStr) {
            if (!dateStr) return 'Recently';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        // Progress Indicator
        function renderProgressIndicator(steps, currentStepIndex) {
            const formCard = document.getElementById('formCard');
            let progressHtml = '<div class="progress-indicator">';
            
            steps.forEach((step, i) => {
                const isActive = i === currentStepIndex;
                const isCompleted = i < currentStepIndex;
                const statusClass = isCompleted ? 'completed' : (isActive ? 'active' : '');
                
                if (i > 0) {
                    progressHtml += `<div class="progress-line ${isCompleted ? 'completed' : ''}"></div>`;
                }
                
                progressHtml += `
                    <div class="progress-step ${statusClass}">
                        <div class="progress-dot">${isCompleted ? '‚úì' : i + 1}</div>
                        <span class="progress-label">${step.title || 'Step ' + (i + 1)}</span>
                    </div>
                `;
            });
            
            progressHtml += '</div>';
            
            // Insert at top of form card
            const existingProgress = formCard.querySelector('.progress-indicator');
            if (existingProgress) {
                existingProgress.outerHTML = progressHtml;
            } else {
                formCard.insertAdjacentHTML('afterbegin', progressHtml);
            }
        }
        
        function updateProgressIndicator(stepIndex) {
            if (currentFunnel && currentFunnel.steps && currentFunnel.steps.length > 1) {
                renderProgressIndicator(currentFunnel.steps, stepIndex);
            }
        }
        
        // Add custom fields from brand settings to the form
        function addCustomFieldsToForm(customFields) {
            const formFields = document.getElementById('formFields');
            if (!formFields) return;
            
            customFields.forEach(field => {
                if (!field.label) return;
                
                const fieldId = field.id || 'custom_' + Date.now();
                let inputHtml = '';
                
                switch (field.type) {
                    case 'textarea':
                        inputHtml = `<textarea id="field_${fieldId}" class="form-input" rows="3" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}></textarea>`;
                        break;
                    case 'number':
                        inputHtml = `<input type="number" id="field_${fieldId}" class="form-input" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
                        break;
                    default:
                        inputHtml = `<input type="text" id="field_${fieldId}" class="form-input" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
                }
                
                const fieldHtml = `
                    <div class="form-group">
                        <label class="form-label">${field.label}${field.required ? ' *' : ''}</label>
                        ${inputHtml}
                    </div>
                `;
                
                formFields.insertAdjacentHTML('beforeend', fieldHtml);
                
                // Add to funnel fields for form submission
                if (!currentFunnel.fields) currentFunnel.fields = [];
                currentFunnel.fields.push({
                    id: fieldId,
                    label: field.label,
                    type: field.type || 'text',
                    required: field.required
                });
            });
        }

        function getVideoEmbed(url, autoplay = true) {
            if (!url || !url.trim()) return '';
            url = url.trim();
            
            // Must start with http to be valid
            if (!url.startsWith('http')) return '';
            
            // YouTube
            const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?#]+)/);
            if (ytMatch) {
                const autoplayParam = autoplay ? '?autoplay=1&mute=1' : '';
                return `<iframe src="https://www.youtube.com/embed/${ytMatch[1]}${autoplayParam}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            }
            
            // Loom - handle various URL formats
            const loomMatch = url.match(/loom\.com\/share\/([a-zA-Z0-9]+)/);
            if (loomMatch) {
                const autoplayParam = autoplay ? '?autoplay=1' : '';
                return `<iframe src="https://www.loom.com/embed/${loomMatch[1]}${autoplayParam}" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>`;
            }
            
            // Direct video URL (MP4, WebM, or Supabase storage)
            const autoplayAttr = autoplay ? 'autoplay muted' : '';
            if (url.match(/\.(mp4|webm|mov)(\?|$)/i) || url.includes('supabase.co/storage')) {
                return `<video src="${url}" controls playsinline ${autoplayAttr}></video>`;
            }
            
            // Unknown format - don't render anything
            console.log('Unknown video format, skipping:', url);
            return '';
        }

        function renderForm() {
            const steps = currentFunnel.steps || [];
            const fields = currentFunnel.fields || [];
            
            // Render progress indicator if multiple steps
            if (steps.length > 1) {
                renderProgressIndicator(steps, 0);
            }
            
            // Render steps indicator if multiple steps (legacy - hidden now)
            if (steps.length > 1) {
                const stepsEl = document.getElementById('stepsIndicator');
                stepsEl.innerHTML = steps.map((step, i) => `
                    <div class="step-dot ${i === 0 ? 'active' : ''}" data-step="${i}">
                        <span>${step.icon || 'üìù'}</span>
                        <span>${step.title}</span>
                    </div>
                `).join('');
                stepsEl.style.display = 'none'; // Hide legacy, using new progress indicator
                
                // Show step buttons
                document.getElementById('stepButtons').style.display = 'flex';
                document.getElementById('submitBtn').style.display = 'none';
                document.getElementById('prevBtn').style.display = 'none';
            }

            // Render form fields
            const formFieldsEl = document.getElementById('formFields');
            let html = '';
            
            steps.forEach((step, stepIdx) => {
                const stepFields = fields.filter(f => f.step === step.id);
                html += `<div class="form-step" data-step="${stepIdx}" style="${stepIdx === 0 ? '' : 'display: none;'}">`;
                
                if (steps.length > 1) {
                    html += `<div class="form-section-title">${step.icon || ''} ${step.title}</div>`;
                }
                
                // Group fields by row (half-width fields pair together)
                let i = 0;
                while (i < stepFields.length) {
                    const field = stepFields[i];
                    const nextField = stepFields[i + 1];
                    
                    if (field.width === 'half' && nextField?.width === 'half') {
                        html += `<div class="form-row">`;
                        html += renderField(field);
                        html += renderField(nextField);
                        html += `</div>`;
                        i += 2;
                    } else {
                        html += renderField(field);
                        i++;
                    }
                }
                
                html += `</div>`;
            });
            
            formFieldsEl.innerHTML = html;

            // Apply preselected brand if present
            if (preselectedBrand) {
                const brandField = document.getElementById('field_brand');
                if (brandField) {
                    brandField.value = preselectedBrand;
                    brandField.removeAttribute('required'); // Remove required since it's preselected
                    brandField.closest('.form-group')?.style.setProperty('display', 'none');
                }
            }
        }

        function renderField(field) {
            const required = field.required ? '<span class="required">*</span>' : '';
            const requiredAttr = field.required ? 'required' : '';
            
            let input = '';
            switch (field.type) {
                case 'select':
                    const options = (field.options || []).map(o => 
                        `<option value="${o.value}">${o.label}</option>`
                    ).join('');
                    input = `<select class="form-input" id="field_${field.id}" name="${field.id}" ${requiredAttr}>
                        <option value="">Select...</option>
                        ${options}
                    </select>`;
                    break;
                case 'textarea':
                    input = `<textarea class="form-input" id="field_${field.id}" name="${field.id}" 
                        placeholder="${field.placeholder || ''}" ${requiredAttr}></textarea>`;
                    break;
                case 'checkbox':
                    input = `<label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="field_${field.id}" name="${field.id}" style="width: 20px; height: 20px;" ${requiredAttr}>
                        <span>${field.label}</span>
                    </label>`;
                    return `<div class="form-group">${input}</div>`;
                default:
                    input = `<input type="${field.type || 'text'}" class="form-input" id="field_${field.id}" name="${field.id}" 
                        placeholder="${field.placeholder || ''}" ${requiredAttr}>`;
            }
            
            return `
                <div class="form-group">
                    <label class="form-label">${field.label} ${required}</label>
                    ${input}
                    ${field.hint ? `<div class="form-hint">${field.hint}</div>` : ''}
                </div>
            `;
        }

        function nextStep() {
            const steps = currentFunnel.steps || [];
            const currentStepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
            
            // Validate current step
            const inputs = currentStepEl.querySelectorAll('input[required], select[required], textarea[required]');
            let valid = true;
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.style.borderColor = 'var(--danger)';
                    valid = false;
                } else {
                    input.style.borderColor = '';
                }
            });
            
            if (!valid) {
                showError('Please fill in all required fields');
                return;
            }
            
            hideError();
            
            if (currentStep < steps.length - 1) {
                currentStepEl.style.display = 'none';
                currentStep++;
                document.querySelector(`.form-step[data-step="${currentStep}"]`).style.display = 'block';
                
                // Update step indicators
                document.querySelectorAll('.step-dot').forEach((dot, i) => {
                    dot.classList.remove('active', 'completed');
                    if (i < currentStep) dot.classList.add('completed');
                    if (i === currentStep) dot.classList.add('active');
                });
                
                // Update progress indicator
                updateProgressIndicator(currentStep);
                
                // Show/hide buttons - always keep stepButtons visible for Back button
                document.getElementById('prevBtn').style.display = 'block';
                document.getElementById('stepButtons').style.display = 'flex';
                
                if (currentStep === steps.length - 1) {
                    // Last step - hide Next, show Submit
                    document.getElementById('nextBtn').style.display = 'none';
                    document.getElementById('submitBtn').style.display = 'block';
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                document.querySelector(`.form-step[data-step="${currentStep}"]`).style.display = 'none';
                currentStep--;
                document.querySelector(`.form-step[data-step="${currentStep}"]`).style.display = 'block';
                
                // Update step indicators
                document.querySelectorAll('.step-dot').forEach((dot, i) => {
                    dot.classList.remove('active', 'completed');
                    if (i < currentStep) dot.classList.add('completed');
                    if (i === currentStep) dot.classList.add('active');
                });
                
                // Update progress indicator
                updateProgressIndicator(currentStep);
                
                // Show/hide buttons
                if (currentStep === 0) {
                    document.getElementById('prevBtn').style.display = 'none';
                }
                document.getElementById('nextBtn').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'none';
                document.getElementById('stepButtons').style.display = 'flex';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        // ==================== DISCORD OAUTH ====================
        
        function checkDiscordCallback() {
            // Check for OAuth callback in URL fragment
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                // Restore funnel/brand from localStorage if not in URL
                const savedFunnel = localStorage.getItem('oauth_return_funnel');
                const savedBrand = localStorage.getItem('oauth_return_brand');
                const currentFunnelParam = urlParams.get('funnel');
                const currentBrand = urlParams.get('brand');
                
                console.log('OAuth callback - savedFunnel:', savedFunnel, 'savedBrand:', savedBrand, 'currentFunnel:', currentFunnelParam, 'currentBrand:', currentBrand);
                
                // If we had a funnel saved and we're not on that funnel, redirect
                if (savedFunnel && savedFunnel !== 'null' && savedFunnel !== 'apply' && !currentFunnelParam) {
                    // Store the token temporarily, redirect with funnel, then process
                    console.log('Redirecting to saved funnel:', savedFunnel);
                    sessionStorage.setItem('pending_discord_token', accessToken);
                    localStorage.removeItem('oauth_return_brand');
                    localStorage.removeItem('oauth_return_funnel');
                    window.location.href = window.location.pathname + '?funnel=' + savedFunnel;
                    return;
                }
                
                // Fallback: If no funnel but brand was saved
                if (savedBrand && !currentBrand && !currentFunnelParam) {
                    console.log('Redirecting to saved brand:', savedBrand);
                    sessionStorage.setItem('pending_discord_token', accessToken);
                    localStorage.removeItem('oauth_return_brand');
                    localStorage.removeItem('oauth_return_funnel');
                    window.location.href = window.location.pathname + '?brand=' + savedBrand;
                    return;
                }
                
                // Clear the hash from URL (keep search params)
                history.replaceState(null, '', window.location.pathname + window.location.search);
                
                // Fetch Discord user info
                fetchDiscordUser(accessToken);
                
                // Clean up localStorage
                localStorage.removeItem('oauth_return_brand');
                localStorage.removeItem('oauth_return_funnel');
            }
            
            // Check for pending token from redirect
            const pendingToken = sessionStorage.getItem('pending_discord_token');
            if (pendingToken) {
                sessionStorage.removeItem('pending_discord_token');
                fetchDiscordUser(pendingToken);
            }
            
            // Also check localStorage for existing session
            const savedUser = localStorage.getItem('discord_user');
            if (savedUser) {
                try {
                    discordUser = JSON.parse(savedUser);
                    updateDiscordUI();
                } catch (e) {
                    localStorage.removeItem('discord_user');
                }
            }
        }
        
        async function fetchDiscordUser(accessToken) {
            try {
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch Discord user');
                
                const user = await response.json();
                discordUser = {
                    id: user.id,
                    username: user.username,
                    global_name: user.global_name || user.username,
                    avatar: user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : null
                };
                
                // Save to localStorage
                localStorage.setItem('discord_user', JSON.stringify(discordUser));
                
                updateDiscordUI();
            } catch (err) {
                console.error('Discord fetch error:', err);
            }
        }
        
        function connectDiscord() {
            if (!DISCORD_CLIENT_ID) {
                console.error('Discord Client ID not configured');
                showError('Discord OAuth is not properly configured. Please contact the administrator.');
                return;
            }
            
            // Store current funnel slug and brand to return to after OAuth
            console.log('Saving OAuth return state - funnel:', funnelSlug, 'brand:', preselectedBrand);
            localStorage.setItem('oauth_return_funnel', funnelSlug || '');
            if (preselectedBrand) {
                localStorage.setItem('oauth_return_brand', preselectedBrand);
            }
            
            // Build OAuth URL - use simple redirect URI (Discord requires exact match)
            const params = new URLSearchParams({
                client_id: DISCORD_CLIENT_ID,
                redirect_uri: DISCORD_REDIRECT_URI,
                response_type: 'token',
                scope: 'identify'
            });
            
            window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
        }
        
        function disconnectDiscord() {
            discordUser = null;
            localStorage.removeItem('discord_user');
            updateDiscordGate();
        }
        
        function updateDiscordUI() {
            // Just update the gate UI - existing check happens in init after funnel loads
            updateDiscordGate();
        }
        
        async function checkExistingApplication() {
            if (!discordUser?.id) {
                return false;
            }
            
            const brand = preselectedBrand || currentFunnel?.brand;
            console.log('Checking existing application for Discord:', discordUser.id, 'Brand:', brand);
            
            if (!brand) {
                return false;
            }
            
            try {
                // Check for existing pending/accepted application
                // Use .maybeSingle() to avoid 406 error when no rows match
                const { data: existingApp, error } = await supabaseClient
                    .from('creator_applications')
                    .select('id, status, brand, created_at')
                    .eq('discord_id', discordUser.id)
                    .eq('brand', brand)
                    .in('status', ['pending', 'reviewing', 'accepted', 'waitlist'])
                    .maybeSingle();
                
                console.log('Existing app check result:', existingApp, error);
                
                if (error) {
                    console.log('Error checking existing app:', error.message);
                    return false;
                }
                
                if (existingApp) {
                    // Already applied - show different UI
                    showAlreadyAppliedUI(existingApp);
                    return true;
                }
            } catch (e) {
                // No existing application found - continue normally
                console.log('No existing application found:', e);
            }
            
            return false;
        }
        
        function showAlreadyAppliedUI(app) {
            const brandName = BRAND_DISPLAY[app.brand] || app.brand;
            const appliedDate = app.created_at ? new Date(app.created_at).toLocaleDateString() : 'Recently';
            const statusLabel = app.status === 'accepted' ? 'Approved! üéâ' 
                : app.status === 'reviewing' ? 'In Review üëÄ'
                : app.status === 'waitlist' ? 'Waitlisted üìù'
                : 'Under Review ‚è≥';
            
            // Hide the form
            document.getElementById('formCard').innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">üìã</div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 8px;">You've Already Applied!</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">
                        You submitted an application for <strong>${brandName}</strong> on ${appliedDate}.
                    </p>
                    
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: left;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${brandName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Applied ${appliedDate}</div>
                            </div>
                            <span style="background: var(--accent-dim); color: var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${statusLabel}</span>
                        </div>
                    </div>
                    
                    <a href="/creator-portal.html" class="submit-btn" style="display: inline-block; text-decoration: none; text-align: center; margin-bottom: 16px;">
                        Check Status in Creator Portal ‚Üí
                    </a>
                    
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        Want to apply for a different brand? <a href="/apply.html" style="color: var(--accent);">Browse all brands</a>
                    </p>
                </div>
            `;
            
            // Hide steps indicator
            document.getElementById('stepsIndicator').style.display = 'none';
        }

        // Form submission
        document.getElementById('applicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            hideError();

            try {
                // Collect form data from ALL steps (not just current)
                const formEl = document.getElementById('applicationForm');
                const data = {};
                
                console.log('Collecting form data...');
                
                currentFunnel.fields.forEach(field => {
                    const input = document.getElementById(`field_${field.id}`);
                    if (input) {
                        if (field.type === 'checkbox') {
                            data[field.id] = input.checked;
                        } else {
                            data[field.id] = input.value.trim();
                        }
                    }
                });
                
                console.log('Collected data:', data);

                // Get TikTok handle and brand
                const tiktokHandle = (data.tiktok_handle || '').replace('@', '').toLowerCase().trim();
                const brand = data.brand || currentFunnel.brand || preselectedBrand;

                // Validate required fields - only check fields that exist in DOM
                const missingFields = [];
                currentFunnel.fields.forEach(field => {
                    const input = document.getElementById(`field_${field.id}`);
                    // Only validate if the field element exists
                    if (field.required && input && !data[field.id]) {
                        console.log(`Missing required field: ${field.id} (${field.label})`);
                        missingFields.push(field.label);
                    }
                });
                
                if (missingFields.length > 0) {
                    throw new Error(`Please fill in: ${missingFields.join(', ')}`);
                }

                if (!discordUser?.id) {
                    throw new Error('Discord connection required. Please refresh and try again.');
                }

                if (!tiktokHandle) {
                    throw new Error('TikTok handle is required.');
                }

                if (!brand) {
                    throw new Error('Brand selection is required.');
                }

                // Check for existing application (creator_applications is accessible via anon key)
                const { data: existingApp } = await supabaseClient
                    .from('creator_applications')
                    .select('id, status')
                    .eq('discord_id', discordUser.id)
                    .eq('brand', brand)
                    .in('status', ['pending', 'reviewing', 'accepted', 'waitlist'])
                    .maybeSingle();

                if (existingApp) {
                    if (existingApp.status === 'accepted') {
                        throw new Error('You are already an active creator for this brand!');
                    } else {
                        throw new Error('You already have a pending application for this brand. Check your Creator Portal for status updates.');
                    }
                }

                // Also check by TikTok handle (different Discord, same TikTok)
                const { data: existingByTikTok } = await supabaseClient
                    .from('creator_applications')
                    .select('id, status, discord_id')
                    .eq('tiktok_handle', tiktokHandle)
                    .eq('brand', brand)
                    .in('status', ['pending', 'reviewing', 'accepted', 'waitlist'])
                    .maybeSingle();

                if (existingByTikTok && existingByTikTok.discord_id !== discordUser.id) {
                    throw new Error('This TikTok account already has an application for this brand.');
                }

                // Create the application audit record first
                // Build extra_data with both values and field metadata
                const extraDataWithLabels = {
                    _fieldLabels: {}, // Store field ID -> label mapping
                };
                
                currentFunnel.fields.forEach(field => {
                    if (data[field.id] !== undefined) {
                        extraDataWithLabels[field.id] = data[field.id];
                        extraDataWithLabels._fieldLabels[field.id] = field.label;
                    }
                });
                
                // Add discord info
                extraDataWithLabels.discord_oauth = true;
                extraDataWithLabels.discord_global_name = discordUser?.global_name || null;
                
                const applicationData = {
                    full_name: data.full_name || null,
                    email: data.email || null,
                    phone: data.phone || null,
                    tiktok_handle: tiktokHandle || null,
                    follower_count: data.follower_count || null,
                    avg_views: data.avg_views || null,
                    brand: brand || null,
                    content_niche: data.content_niche || null,
                    sample_video_url: data.sample_video || data.sample_video_url || null,
                    why_join: data.why_join || null,
                    heard_about_us: data.heard_about || data.heard_about_us || null,
                    discord_username: discordUser?.username || null,
                    discord_id: discordUser?.id || null,
                    discord_avatar: discordUser?.avatar || null,
                    status: 'pending',
                    funnel_slug: currentFunnel.slug || null,
                    extra_data: extraDataWithLabels
                };

                const { data: appRecord, error: appError } = await supabaseClient
                    .from('creator_applications')
                    .insert(applicationData)
                    .select('id')
                    .single();

                if (appError) throw appError;

                // Note: managed_creators record will be created when admin approves
                // Creator portal will show application status from creator_applications until then

                // Show success
                document.getElementById('formCard').style.display = 'none';
                document.getElementById('stepsIndicator').style.display = 'none';
                document.getElementById('welcomeVideoSection').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('successMessage').classList.add('show');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Trigger confetti celebration!
                launchConfetti();

            } catch (err) {
                console.error('Submit error:', err);
                showError(err.message || 'Something went wrong. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Application';
            }
        });
        
        // Confetti celebration function
        function launchConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);
            
            const colors = [
                getComputedStyle(document.documentElement).getPropertyValue('--brand-color').trim() || '#f5c518',
                '#34d399', '#a78bfa', '#f87171', '#fbbf24', '#60a5fa'
            ];
            
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    
                    // Random shapes
                    const shapes = ['circle', 'square', 'rectangle'];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    if (shape === 'circle') {
                        confetti.style.borderRadius = '50%';
                    } else if (shape === 'rectangle') {
                        confetti.style.width = '6px';
                        confetti.style.height = '14px';
                    }
                    
                    container.appendChild(confetti);
                }, i * 20);
            }
            
            // Clean up after animation
            setTimeout(() => container.remove(), 5000);
        }
    </script>
</body>
</html>
